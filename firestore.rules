rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Admins collection - read own profile only
    match /admins/{adminId} {
      allow read: if request.auth != null && request.auth.uid == adminId;
      allow write: if false;
    }
    
    // Artists collection
    match /artists/{artistId} {
      allow read, write: if isAdmin();
      allow read, create, update: if request.auth != null && request.auth.uid == artistId;
    }
    
    // Customers collection
    match /customers/{customerId} {
      allow read, write: if isAdmin();
      allow read, create, update: if request.auth != null && request.auth.uid == customerId;
      // Allow server-side avatar updates (API uses REST without user auth)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['avatarUrl', 'avatarUpdatedAt']);
      // Allow creating new customer with avatar
      allow create: if request.resource.data.keys().hasOnly(['avatarUrl', 'avatarUpdatedAt']);
    }
    
    // Orders collection
    match /orders/{orderId} {
      allow read, write: if isAdmin();
      allow read: if request.auth != null && resource.data.customerId == request.auth.uid;
      allow read: if request.auth != null && resource.data.artistId == request.auth.uid;
    }
    
    // Products collection - public read
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Merch products collection - public read
    match /merch_products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Merch collection - public read
    match /merch/{productId} {
      allow read: if true;
      allow write: if isAdmin();
      // Allow server-side merch operations (API uses REST without user auth)
      allow create, update: if true;
    }

    // Merch stock movements - server-side tracking
    match /merch-stock-movements/{movementId} {
      allow read: if isAdmin();
      allow create, update: if true;
    }

    // Merch suppliers
    match /merch-suppliers/{supplierId} {
      allow read: if true;
      allow write: if isAdmin();
      // Allow server-side supplier stats updates
      allow update: if true;
    }

    // Releases collection - public read, server can write
    match /releases/{releaseId} {
      allow read: if true;
      // Allow writes from admin or server (API key without auth)
      // Server writes have uploadSource field in metadata
      allow create: if isAdmin() ||
                       (request.resource.data.metadata != null &&
                        request.resource.data.metadata.uploadSource == 'direct-r2-upload');
      // Allow updates for status changes and admin operations
      allow update: if isAdmin() ||
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'approved', 'published', 'updatedAt', 'processedAt',
                                   'approvedAt', 'rejectedAt', 'metadata']);
      allow delete: if isAdmin();
    }
    
    // DJ Mixes collection (hyphenated) - public read
    match /dj-mixes/{mixId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
      // Allow server-side tracking updates (plays, likes, downloads)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['plays', 'likes', 'downloads', 'playCount', 'likeCount', 'downloadCount',
                                 'last_played_date', 'last_liked_date', 'last_unliked_date',
                                 'last_download_date', 'last_downloaded_date', 'commentCount', 'ratings']);
    }

    // DJ Mixes collection (underscore) - public read
    match /dj_mixes/{mixId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
      // Allow server-side tracking updates (plays, likes, downloads)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['plays', 'likes', 'downloads', 'playCount', 'likeCount', 'downloadCount',
                                 'last_played_date', 'last_liked_date', 'last_unliked_date',
                                 'last_download_date', 'last_downloaded_date', 'commentCount', 'ratings']);
    }

    // DJ Mixes Pending
    match /dj_mixes_pending/{mixId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // Sales collection
    match /sales/{saleId} {
      allow read, write: if isAdmin();
      allow read: if request.auth != null && resource.data.artistId == request.auth.uid;
    }
    
    // Carts collection
    match /carts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // Analytics collection
    match /analytics/{docId} {
      allow read, write: if isAdmin();
    }
    
    // Reviews collection - public read
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow read, write: if isAdmin();
    }
    
    // Activity collection
    match /activity/{activityId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
      allow create: if request.auth != null;
    }
    
    // Settings collection - public read
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Reports collection
    match /reports/{reportId} {
      allow read, write: if isAdmin();
      allow create: if request.auth != null;
      allow read: if request.auth != null && resource.data.reportedBy == request.auth.uid;
    }
    
    // Playlists collection - public read
    match /playlists/{playlistId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }
    
    // Newsletter subscriptions (legacy)
    match /newsletter/{emailId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // Newsletter subscribers
    match /subscribers/{subscriberId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
    
    // Contact forms
    match /contact_submissions/{submissionId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
    
    // ============================================
    // LIVESTREAM RULES
    // ============================================
    
    // Livestream chat - public read, authenticated write
    match /livestream-chat/{messageId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }
    
    // Livestream slots (schedule) - public read, authenticated write
    match /livestreamSlots/{slotId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Active streams - public read, authenticated write
    match /activeStreams/{streamId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Livestreams collection (stream data) - public read
    match /livestreams/{streamId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Livestream reactions (likes, ratings) - authenticated create
    match /livestream-reactions/{reactionId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }
    
    // Livestream viewers - authenticated write
    match /livestream-viewers/{viewerId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // DJ Takeover Requests - authenticated only
    match /djTakeoverRequests/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // DJ Lobby presence - authenticated only
    match /djLobby/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // DJ Lobby chat - authenticated only
    match /djLobbyChat/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
