---
// src/components/Header.astro
// OPTIMIZED: Minimal API calls with aggressive caching + debounced search
---

<header class="bg-white border-b-2 border-black sticky top-0 z-50 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    
    <!-- Mobile Layout -->
    <div class="flex flex-col gap-3 sm:hidden">
      <div class="flex items-center justify-between">
        <a href="/" class="flex items-center">
          <img src="/logo.webp" alt="Fresh Wax" style="height: 50px;" />
        </a>
        
        <div class="flex items-center gap-2">
          <!-- Mobile LIVE Button -->
          <a href="/live" id="liveButtonMobile" class="live-button bg-gray-800 px-2 py-2 rounded-lg hover:bg-gray-700 transition-all flex items-center gap-1 font-medium text-xs border border-gray-600">
            <span class="live-dot"></span>
            <span class="live-text text-red-500">LIVE</span>
          </a>
          
          <!-- Account Dropdown Mobile -->
          <div class="relative account-dropdown">
            <button class="account-button bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1 text-sm border border-gray-300">
              <div class="account-avatar w-5 h-5 rounded-full bg-gray-600 flex items-center justify-center text-white text-xs font-bold overflow-hidden">
                <svg class="account-avatar-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="account-avatar-initial hidden"></span>
                <img class="account-avatar-img hidden w-full h-full object-cover" src="" alt="" />
              </div>
              <span class="account-name">Login</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="account-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border-2 border-black py-2 z-50">
              <div class="logged-out">
                <a href="/login" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Login</a>
                <a href="/register" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Register</a>
              </div>
              <div class="logged-in hidden">
                <a href="/account/dashboard" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">My Account</a>
                <button class="logout-btn block w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors font-semibold border-t border-gray-200">Logout</button>
              </div>
            </div>
          </div>

          <a href="/cart" class="relative bg-black text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <span class="text-sm">Bag</span>
            <span id="cart-count-mobile" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden border border-white">0</span>
          </a>
        </div>
      </div>
      
      <div class="relative w-full">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input
          type="text"
          id="search-input-mobile"
          placeholder="Search releases, artists, tracks..."
          class="block w-full pl-9 pr-3 py-2 text-sm border-2 border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-black focus:border-black"
          autocomplete="off"
        />
        <!-- Mobile Search Results Dropdown -->
        <div id="search-results-mobile" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border-2 border-black rounded-lg shadow-xl max-h-96 overflow-y-auto z-50">
          <div id="search-results-content-mobile" class="py-2"></div>
        </div>
      </div>
    </div>

    <!-- Desktop Layout -->
    <div class="hidden sm:flex items-center justify-between gap-8">
      <a href="/" class="flex items-center flex-shrink-0">
        <img src="/logo.webp" alt="Fresh Wax" style="height: 70px;" />
      </a>
      
      <div class="flex-1 max-w-2xl relative">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input
            type="text"
            id="search-input"
            placeholder="Search releases, artists, tracks..."
            class="block w-full pl-10 pr-3 py-2 border-2 border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-black focus:border-black"
            autocomplete="off"
          />
          <!-- Search Results Dropdown -->
          <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border-2 border-black rounded-lg shadow-xl max-h-96 overflow-y-auto z-50">
            <div id="search-results-content" class="py-2"></div>
          </div>
        </div>
      </div>
      
      <div class="flex items-center gap-3 flex-shrink-0">
        <a href="/releases" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
          </svg>
          All Releases
        </a>

        <a href="/dj-mixes" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          </svg>
          DJ Mixes
        </a>

        <a href="/merch" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
          </svg>
          Merch
        </a>

        <a href="/giftcards" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
          </svg>
          Gift Cards
        </a>

        <!-- LIVE Button -->
        <a href="/live" id="liveButton" class="live-button bg-gray-800 px-3 py-2 rounded-lg hover:bg-gray-700 transition-all flex items-center gap-2 font-medium text-sm border border-gray-600">
          <span class="live-dot"></span>
          <span class="live-text text-red-500">LIVE</span>
        </a>

        <!-- Spacer for bigger gap -->
        <div class="w-4"></div>

        <!-- Account Dropdown -->
        <div class="relative account-dropdown">
          <button class="account-button bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
            <div class="account-avatar w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-white text-xs font-bold overflow-hidden">
              <svg class="account-avatar-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span class="account-avatar-initial hidden"></span>
              <img class="account-avatar-img hidden w-full h-full object-cover" src="" alt="" />
            </div>
            <span class="account-name">Login</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="account-menu hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border-2 border-black py-2 z-50">
            <div class="logged-out">
              <a href="/login" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Login</a>
              <a href="/register" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Register</a>
            </div>
            <div class="logged-in hidden">
              <a href="/account/dashboard" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">My Account</a>
              <button class="logout-btn block w-full text-left px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors font-semibold border-t border-gray-200">Logout</button>
            </div>
          </div>
        </div>

        <a href="/cart" class="relative bg-black text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          Bag
          <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden border border-white">0</span>
        </a>
      </div>
    </div>
  </div>
</header>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  // Firebase config - matches working admin login
  const firebaseConfig = {
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  // Initialize Firebase only once
  let app;
  let auth;
  
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    window.firebaseAuth = auth;
  } catch (e) {
    // App already initialized, get existing instance
    const { getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
    app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    auth = getAuth(app);
    window.firebaseAuth = auth;
  }

  // Cache helpers (unchanged)
  const USER_CACHE_KEY = 'freshwax_user_type_cache';
  const CACHE_DURATION = 30 * 60 * 1000;

  function getCachedUserType() {
    try {
      const cached = sessionStorage.getItem(USER_CACHE_KEY);
      if (!cached) return null;
      const data = JSON.parse(cached);
      if (Date.now() - data.timestamp > CACHE_DURATION) {
        sessionStorage.removeItem(USER_CACHE_KEY);
        return null;
      }
      return data;
    } catch (error) {
      return null;
    }
  }

  function setCachedUserType(isArtist, isCustomer, name, partnerDisplayName, avatarUrl, isPro) {
    try {
      sessionStorage.setItem(USER_CACHE_KEY, JSON.stringify({
        isArtist, isCustomer, name, partnerDisplayName, avatarUrl, isPro, timestamp: Date.now()
      }));
    } catch (error) {
      console.error('[Cache] Error:', error);
    }
  }

  async function checkUserType(uid) {
    const cached = getCachedUserType();
    if (cached) return cached;
    
    try {
      const response = await fetch(`/api/get-user-type?uid=${uid}`);
      const data = await response.json();
      if (data.success) {
        setCachedUserType(data.isArtist, data.isCustomer, data.name, data.partnerDisplayName, data.avatarUrl, data.isPro);
        return data;
      }
    } catch (error) {
      console.error('[Auth] Error fetching user type:', error);
    }
    return { isArtist: false, isCustomer: false, name: '', partnerDisplayName: '' };
  }

  // Main initialization function - called on every page load/navigation
  function initHeader() {
    
    // Update cart count
    updateCartCount();
    
    // Set up dropdown functionality
    setupDropdowns();
    
    // Set up search
    setupSearch();
    
    // Set up logout buttons
    setupLogoutButtons();
  }

  function updateCartCount() {
    // Use FreshWaxCart if available
    if (window.FreshWaxCart) {
      window.FreshWaxCart.updateBadge();
      return;
    }
    
    // Fallback: try to read from customer-specific cart
    let totalItems = 0;
    
    // Get customerId from cookie
    const cookies = document.cookie.split(';');
    let customerId = null;
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'customerId' && value) {
        customerId = value;
        break;
      }
    }
    
    if (customerId) {
      try {
        const stored = localStorage.getItem('freshwax_cart_' + customerId);
        if (stored) {
          const data = JSON.parse(stored);
          const items = data.items || data || [];
          totalItems = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
        }
      } catch (e) {}
    }
    
    const desktopCount = document.getElementById('cart-count');
    const mobileCount = document.getElementById('cart-count-mobile');
    
    [desktopCount, mobileCount].forEach(el => {
      if (el) {
        if (totalItems > 0) {
          el.textContent = totalItems.toString();
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      }
    });
    
    // Also update data-cart-count elements
    document.querySelectorAll('[data-cart-count]').forEach(el => {
      el.textContent = totalItems;
      el.style.display = totalItems > 0 ? '' : 'none';
    });
  }

  function setupDropdowns() {
    document.querySelectorAll('.account-dropdown').forEach(dropdown => {
      const button = dropdown.querySelector('.account-button');
      const menu = dropdown.querySelector('.account-menu');
      
      if (button && menu) {
        // Remove existing listeners by cloning
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        newButton.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.account-menu').forEach(m => {
            if (m !== menu) m.classList.add('hidden');
          });
          menu.classList.toggle('hidden');
        });
      }
    });

    // Close dropdowns on document click - use a named function to avoid duplicates
    document.removeEventListener('click', closeAllDropdowns);
    document.addEventListener('click', closeAllDropdowns);
  }

  function closeAllDropdowns() {
    document.querySelectorAll('.account-menu').forEach(menu => menu.classList.add('hidden'));
  }

  function setupLogoutButtons() {
    document.querySelectorAll('.logout-btn').forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener('click', async () => {
        try {
          sessionStorage.removeItem(USER_CACHE_KEY);
          
          // Clear customerId cookie BEFORE signOut and reload
          document.cookie = 'customerId=; path=/; max-age=0; SameSite=Lax';
          
          await signOut(auth);
          window.location.reload();
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
    });
  }

  // Search setup
  const SEARCH_CACHE_KEY = 'freshwax_search_cache';
  const SEARCH_CACHE_DURATION = 5 * 60 * 1000;
  let searchTimeout = null;

  function getCachedSearch(query) {
    try {
      const cached = sessionStorage.getItem(`${SEARCH_CACHE_KEY}_${query}`);
      if (!cached) return null;
      const data = JSON.parse(cached);
      if (Date.now() - data.timestamp > SEARCH_CACHE_DURATION) {
        sessionStorage.removeItem(`${SEARCH_CACHE_KEY}_${query}`);
        return null;
      }
      return data.results;
    } catch (error) {
      return null;
    }
  }

  function setCachedSearch(query, results) {
    try {
      sessionStorage.setItem(`${SEARCH_CACHE_KEY}_${query}`, JSON.stringify({
        results, timestamp: Date.now()
      }));
    } catch (error) {
      console.error('[Search Cache] Error:', error);
    }
  }

  async function performSearch(query, resultsDiv, contentDiv) {
    if (!query || query.length < 2) {
      resultsDiv.classList.add('hidden');
      return;
    }

    const cached = getCachedSearch(query);
    if (cached) {
      displaySearchResults(cached, resultsDiv, contentDiv, query);
      return;
    }

    try {
      const response = await fetch(`/api/search-releases?q=${encodeURIComponent(query)}&limit=8`);
      const data = await response.json();
      if (data.success && data.results) {
        setCachedSearch(query, data.results);
        displaySearchResults(data.results, resultsDiv, contentDiv, query);
      }
    } catch (error) {
      console.error('[Search] Error:', error);
      contentDiv.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500">Error loading results</div>';
      resultsDiv.classList.remove('hidden');
    }
  }

  function displaySearchResults(results, resultsDiv, contentDiv, query) {
    if (results.length === 0) {
      contentDiv.innerHTML = `<div class="px-4 py-3 text-sm text-gray-500">No results found for "${query}"</div>`;
      resultsDiv.classList.remove('hidden');
      return;
    }

    const html = results.map(result => {
      let link = result.type === 'release' ? `/item/${result.id}` : `/dj-mix/${result.id}`;
      
      // Type badge colors
      const badgeColor = result.type === 'release' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
      const badgeText = result.type === 'release' ? 'Release' : 'DJ Mix';

      return `
        <a href="${link}" class="block px-4 py-3 hover:bg-gray-100 transition-colors border-b border-gray-100 last:border-b-0">
          <div class="flex items-center gap-3">
            <img src="${result.artwork_url || '/logo.webp'}" alt="${result.title}" class="w-12 h-12 object-cover rounded" onerror="this.src='/logo.webp'">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-semibold text-sm text-gray-900 truncate">${result.title}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded ${badgeColor} font-medium uppercase">${badgeText}</span>
              </div>
              <div class="text-xs text-gray-600 truncate">${result.artist_name}</div>
            </div>
          </div>
        </a>
      `;
    }).join('');

    contentDiv.innerHTML = html + `
      <a href="/releases?search=${encodeURIComponent(query)}" class="block px-4 py-3 text-center text-sm font-semibold text-black hover:bg-gray-100 transition-colors border-t-2 border-gray-200">
        View all results â†’
      </a>
    `;
    resultsDiv.classList.remove('hidden');
  }

  function setupSearch() {
    // Desktop search
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchResultsContent = document.getElementById('search-results-content');
    
    if (searchInput) {
      // Clone to remove old listeners
      const newInput = searchInput.cloneNode(true);
      searchInput.parentNode.replaceChild(newInput, searchInput);
      
      newInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(query, searchResults, searchResultsContent);
        }, 400);
      });

      newInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          if (query) window.location.href = `/releases?search=${encodeURIComponent(query)}`;
        }
      });
    }

    // Mobile search
    const searchInputMobile = document.getElementById('search-input-mobile');
    const searchResultsMobile = document.getElementById('search-results-mobile');
    const searchResultsContentMobile = document.getElementById('search-results-content-mobile');
    
    if (searchInputMobile) {
      const newInputMobile = searchInputMobile.cloneNode(true);
      searchInputMobile.parentNode.replaceChild(newInputMobile, searchInputMobile);
      
      newInputMobile.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(query, searchResultsMobile, searchResultsContentMobile);
        }, 400);
      });

      newInputMobile.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          if (query) window.location.href = `/releases?search=${encodeURIComponent(query)}`;
        }
      });
    }

    // Close search on outside click
    document.addEventListener('click', (e) => {
      const desktopInput = document.getElementById('search-input');
      const mobileInput = document.getElementById('search-input-mobile');
      
      if (searchResults && desktopInput && !desktopInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
      if (searchResultsMobile && mobileInput && !mobileInput.contains(e.target) && !searchResultsMobile.contains(e.target)) {
        searchResultsMobile.classList.add('hidden');
      }
    });
  }

  // Update UI based on auth state
  function updateUIForUser(userData, user) {
    // Prioritize partnerDisplayName (for artists), then name (which includes displayName from customers), then email
    let displayName = (userData.partnerDisplayName || userData.name || user.email?.split('@')[0] || 'Account').split(' ')[0];
    
    // Truncate to 30 characters max
    if (displayName.length > 30) {
      displayName = displayName.substring(0, 27) + '...';
    }
    
    const initial = displayName.charAt(0).toUpperCase();
    const avatarUrl = userData.avatarUrl || '';
    const isPro = userData.isPro || false;
    
    // Update account name display
    document.querySelectorAll('.account-name').forEach(el => el.textContent = displayName);
    
    // Update avatar displays
    document.querySelectorAll('.account-avatar').forEach(avatar => {
      const icon = avatar.querySelector('.account-avatar-icon');
      const initialEl = avatar.querySelector('.account-avatar-initial');
      const imgEl = avatar.querySelector('.account-avatar-img');
      
      if (avatarUrl) {
        // Show image
        if (icon) icon.classList.add('hidden');
        if (initialEl) initialEl.classList.add('hidden');
        if (imgEl) {
          imgEl.src = avatarUrl;
          imgEl.classList.remove('hidden');
        }
        avatar.classList.remove('bg-gray-600', 'bg-red-600');
        avatar.classList.add('bg-transparent');
      } else {
        // Show initial
        if (icon) icon.classList.add('hidden');
        if (imgEl) imgEl.classList.add('hidden');
        if (initialEl) {
          initialEl.textContent = initial;
          initialEl.classList.remove('hidden');
        }
        avatar.classList.remove('bg-transparent');
        if (isPro) {
          avatar.classList.remove('bg-gray-600');
          avatar.classList.add('bg-red-600');
        } else {
          avatar.classList.remove('bg-red-600');
          avatar.classList.add('bg-gray-600');
        }
      }
    });
    
    // Style the button as logged in - medium gray background
    document.querySelectorAll('.account-button').forEach(btn => {
      btn.classList.remove('bg-gray-100', 'text-black', 'border-gray-300');
      btn.classList.add('bg-gray-500', 'text-white', 'border-2', 'border-gray-600');
    });
    
    // Show logged-in menu, hide logged-out menu
    document.querySelectorAll('.logged-in').forEach(el => el.classList.remove('hidden'));
    document.querySelectorAll('.logged-out').forEach(el => el.classList.add('hidden'));
    
    // Show artist section if user is an artist
    if (userData.isArtist) {
      document.querySelectorAll('.artist-section').forEach(el => el.classList.remove('hidden'));
    }
  }

  // Auth state listener - set up fresh on each page
  function setupAuthListener() {
    
    // Check if we already have a cached user
    const cached = getCachedUserType();
    if (cached && (cached.isArtist || cached.isCustomer)) {
      updateUIForUser(cached, { email: '' });
    }
    
    // Also set up the real-time listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userData = await checkUserType(user.uid);
        updateUIForUser(userData, user);
      } else {
        // User logged out - reset UI
        sessionStorage.removeItem(USER_CACHE_KEY);
        
        // Clear customerId cookie to prevent cart access without login
        document.cookie = 'customerId=; path=/; max-age=0; SameSite=Lax';
        
        document.querySelectorAll('.account-name').forEach(el => el.textContent = 'Login');
        document.querySelectorAll('.account-button').forEach(btn => {
          btn.classList.add('bg-gray-100', 'text-black', 'border-gray-300');
          btn.classList.remove('bg-gray-500', 'text-white', 'border-2', 'border-gray-600');
        });
        
        // Reset avatars to default icon
        document.querySelectorAll('.account-avatar').forEach(avatar => {
          const icon = avatar.querySelector('.account-avatar-icon');
          const initialEl = avatar.querySelector('.account-avatar-initial');
          const imgEl = avatar.querySelector('.account-avatar-img');
          
          if (icon) icon.classList.remove('hidden');
          if (initialEl) initialEl.classList.add('hidden');
          if (imgEl) {
            imgEl.src = '';
            imgEl.classList.add('hidden');
          }
          avatar.classList.remove('bg-red-600', 'bg-transparent');
          avatar.classList.add('bg-gray-600');
        });
        
        document.querySelectorAll('.logged-in').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.logged-out').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.artist-section').forEach(el => el.classList.add('hidden'));
      }
    });
  }

  // Storage and cart events
  window.addEventListener('storage', updateCartCount);
  window.addEventListener('cartUpdated', updateCartCount);
  window.addEventListener('cart-updated', updateCartCount);

  // Check if any stream is live and update LIVE button
  async function checkLiveStatus() {
    try {
      const response = await fetch('/api/livestream/status');
      const result = await response.json();
      
      const liveButton = document.getElementById('liveButton');
      const liveButtonMobile = document.getElementById('liveButtonMobile');
      
      const updateButton = (btn) => {
        if (!btn) return;
        const liveText = btn.querySelector('.live-text');
        
        if (result.success && result.isLive) {
          // Stream is LIVE - red button with pulsing white LED
          btn.classList.add('is-live');
          btn.classList.remove('bg-gray-800', 'border-gray-600', 'hover:bg-gray-700');
          btn.classList.add('bg-red-600', 'border-red-500', 'hover:bg-red-700');
          
          // Update text (white on red bg)
          if (liveText) {
            liveText.classList.remove('text-red-500');
            liveText.classList.add('text-white');
            liveText.textContent = result.primaryStream?.djName 
              ? `${result.primaryStream.djName}` 
              : 'LIVE NOW';
          }
        } else {
          // No live stream - grey button with red text
          btn.classList.remove('is-live');
          btn.classList.add('bg-gray-800', 'border-gray-600', 'hover:bg-gray-700');
          btn.classList.remove('bg-red-600', 'border-red-500', 'hover:bg-red-700');
          
          // Reset text to red "LIVE"
          if (liveText) {
            liveText.classList.add('text-red-500');
            liveText.classList.remove('text-white');
            liveText.textContent = 'LIVE';
          }
        }
      };
      
      updateButton(liveButton);
      updateButton(liveButtonMobile);
      
    } catch (error) {
      console.log('Could not check live status');
    }
  }

  // Check live status on load and periodically
  checkLiveStatus();
  setInterval(checkLiveStatus, 30000); // Check every 30 seconds

  // Initialize on first load
  initHeader();
  setupAuthListener();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', () => {
    initHeader();
    checkLiveStatus();
    // Re-apply cached user state immediately on page load
    const cached = getCachedUserType();
    if (cached && (cached.isArtist || cached.isCustomer)) {
      updateUIForUser(cached, { email: '' });
    }
  });
  document.addEventListener('astro:after-swap', initHeader);
</script>

<style>
  /* LIVE Button Styles */
  .live-button {
    position: relative;
    transition: all 0.3s ease;
  }
  
  .live-button .live-dot {
    width: 8px;
    height: 8px;
    background: #666;
    border-radius: 50%;
    transition: all 0.3s ease;
  }
  
  /* Red pulsing LED when live (on red button background, use white) */
  .live-button.is-live .live-dot {
    background: #fff;
    animation: led-pulse-live 1s ease-in-out infinite;
  }
  
  @keyframes led-pulse-live {
    0%, 100% {
      opacity: 1;
      box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
    }
    50% {
      opacity: 0.5;
      box-shadow: 0 0 10px rgba(255, 255, 255, 1);
    }
  }
  
  .live-button.is-live {
    animation: glow 2s ease-in-out infinite alternate;
  }
  
  @keyframes glow {
    from {
      box-shadow: 0 0 5px rgba(220, 38, 38, 0.5);
    }
    to {
      box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
    }
  }
  
  .live-text {
    font-weight: 700;
    letter-spacing: 0.05em;
  }
</style>