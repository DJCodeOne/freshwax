---
// src/components/Header.astro
// OPTIMIZED: Minimal API calls with aggressive caching + debounced search
---

<header class="bg-white border-b-2 border-black sticky top-0 z-50 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    
    <!-- Mobile Layout -->
    <div class="flex flex-col gap-3 sm:hidden">
      <div class="flex items-center justify-between">
        <a href="/" class="flex items-center">
          <img src="/logo.webp" alt="Fresh Wax" style="height: 50px;" />
        </a>
        
        <div class="flex items-center gap-2">
          <!-- Customer Dropdown Mobile -->
          <div class="relative account-dropdown">
            <button class="account-button customer-button bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1 text-sm border border-gray-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span class="customer-name">Customer</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="account-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border-2 border-black py-2 z-50">
              <div class="customer-logged-out">
                <a href="/customer/login" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Login</a>
                <a href="/customer/register" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Register</a>
              </div>
              <div class="customer-logged-in hidden">
                <a href="/account/dashboard" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Dashboard</a>
                <a href="/account/orders" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Orders</a>
                <button class="customer-logout-btn block w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors font-semibold">Logout</button>
              </div>
            </div>
          </div>

          <!-- Artist Dropdown Mobile -->
          <div class="relative account-dropdown">
            <button class="account-button artist-button bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1 text-sm border border-gray-300">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              <span class="artist-name">Artist</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="account-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border-2 border-black py-2 z-50">
              <div class="artist-logged-out">
                <a href="/login" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Login</a>
                <a href="/register" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Register</a>
              </div>
              <div class="artist-logged-in hidden">
                <a href="/artist/dashboard" class="block px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">Dashboard</a>
                <button class="artist-logout-btn block w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors font-semibold">Logout</button>
              </div>
            </div>
          </div>

          <a href="/cart" class="relative bg-black text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <span class="text-sm">Bag</span>
            <span id="cart-count-mobile" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden border border-white">0</span>
          </a>
        </div>
      </div>
      
      <div class="relative w-full">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input
          type="text"
          id="search-input-mobile"
          placeholder="Search releases, artists, tracks..."
          class="block w-full pl-9 pr-3 py-2 text-sm border-2 border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-black focus:border-black"
          autocomplete="off"
        />
        <!-- Mobile Search Results Dropdown -->
        <div id="search-results-mobile" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border-2 border-black rounded-lg shadow-xl max-h-96 overflow-y-auto z-50">
          <div id="search-results-content-mobile" class="py-2"></div>
        </div>
      </div>
    </div>

    <!-- Desktop Layout -->
    <div class="hidden sm:flex items-center justify-between gap-8">
      <a href="/" class="flex items-center flex-shrink-0">
        <img src="/logo.webp" alt="Fresh Wax" style="height: 70px;" />
      </a>
      
      <div class="flex-1 max-w-2xl relative">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input
            type="text"
            id="search-input"
            placeholder="Search releases, artists, tracks..."
            class="block w-full pl-10 pr-3 py-2 border-2 border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-black focus:border-black"
            autocomplete="off"
          />
          <!-- Search Results Dropdown -->
          <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border-2 border-black rounded-lg shadow-xl max-h-96 overflow-y-auto z-50">
            <div id="search-results-content" class="py-2"></div>
          </div>
        </div>
      </div>
      
      <div class="flex items-center gap-3 flex-shrink-0">
        <a href="/releases" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
          </svg>
          All Releases
        </a>

        <a href="/dj-mixes" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          </svg>
          DJ Mixes
        </a>

        <a href="/merch" class="bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
          </svg>
          Merch
        </a>

        <!-- Customer Dropdown -->
        <div class="relative account-dropdown">
          <button class="account-button customer-button bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span class="customer-name">Customer</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="account-menu hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border-2 border-black py-2 z-50">
            <div class="customer-logged-out">
              <a href="/customer/login" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Login</a>
              <a href="/customer/register" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Register</a>
            </div>
            <div class="customer-logged-in hidden">
              <a href="/account/dashboard" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Dashboard</a>
              <a href="/account/orders" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Orders</a>
              <button class="customer-logout-btn block w-full text-left px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors font-semibold">Logout</button>
            </div>
          </div>
        </div>

        <!-- Artist Dropdown -->
        <div class="relative account-dropdown">
          <button class="account-button artist-button bg-gray-100 text-black px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2 font-medium text-sm border border-gray-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span class="artist-name">Artist</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="account-menu hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border-2 border-black py-2 z-50">
            <div class="artist-logged-out">
              <a href="/login" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Login</a>
              <a href="/register" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Register</a>
            </div>
            <div class="artist-logged-in hidden">
              <a href="/artist/dashboard" class="block px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors">Dashboard</a>
              <button class="artist-logout-btn block w-full text-left px-4 py-3 text-sm text-black hover:bg-gray-100 transition-colors font-semibold">Logout</button>
            </div>
          </div>
        </div>

        <a href="/cart" class="relative bg-black text-white px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          Bag
          <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden border border-white">0</span>
        </a>
      </div>
    </div>
  </div>
</header>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  // Initialize Firebase only once
  let app;
  let auth;
  
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    window.firebaseAuth = auth;
  } catch (e) {
    // App already initialized, get existing instance
    const { getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
    app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    auth = getAuth(app);
    window.firebaseAuth = auth;
  }

  // Cache helpers (unchanged)
  const USER_CACHE_KEY = 'freshwax_user_type_cache';
  const CACHE_DURATION = 30 * 60 * 1000;

  function getCachedUserType() {
    try {
      const cached = sessionStorage.getItem(USER_CACHE_KEY);
      if (!cached) return null;
      const data = JSON.parse(cached);
      if (Date.now() - data.timestamp > CACHE_DURATION) {
        sessionStorage.removeItem(USER_CACHE_KEY);
        return null;
      }
      return data;
    } catch (error) {
      return null;
    }
  }

  function setCachedUserType(isArtist, isCustomer, name) {
    try {
      sessionStorage.setItem(USER_CACHE_KEY, JSON.stringify({
        isArtist, isCustomer, name, timestamp: Date.now()
      }));
    } catch (error) {
      console.error('[Cache] Error:', error);
    }
  }

  async function checkUserType(uid) {
    const cached = getCachedUserType();
    if (cached) return cached;
    
    try {
      const response = await fetch(`/api/get-user-type?uid=${uid}`);
      const data = await response.json();
      if (data.success) {
        setCachedUserType(data.isArtist, data.isCustomer, data.name);
        return data;
      }
    } catch (error) {
      console.error('[Auth] Error fetching user type:', error);
    }
    return { isArtist: false, isCustomer: false, name: '' };
  }

  // Main initialization function - called on every page load/navigation
  function initHeader() {
    console.log('[Header] Initializing...');
    
    // Update cart count
    updateCartCount();
    
    // Set up dropdown functionality
    setupDropdowns();
    
    // Set up search
    setupSearch();
    
    // Set up logout buttons
    setupLogoutButtons();
  }

  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    
    const desktopCount = document.getElementById('cart-count');
    const mobileCount = document.getElementById('cart-count-mobile');
    
    [desktopCount, mobileCount].forEach(el => {
      if (el) {
        if (totalItems > 0) {
          el.textContent = totalItems.toString();
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      }
    });
  }

  function setupDropdowns() {
    document.querySelectorAll('.account-dropdown').forEach(dropdown => {
      const button = dropdown.querySelector('.account-button');
      const menu = dropdown.querySelector('.account-menu');
      
      if (button && menu) {
        // Remove existing listeners by cloning
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        newButton.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.account-menu').forEach(m => {
            if (m !== menu) m.classList.add('hidden');
          });
          menu.classList.toggle('hidden');
        });
      }
    });

    // Close dropdowns on document click - use a named function to avoid duplicates
    document.removeEventListener('click', closeAllDropdowns);
    document.addEventListener('click', closeAllDropdowns);
  }

  function closeAllDropdowns() {
    document.querySelectorAll('.account-menu').forEach(menu => menu.classList.add('hidden'));
  }

  function setupLogoutButtons() {
    document.querySelectorAll('.customer-logout-btn, .artist-logout-btn').forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener('click', async () => {
        try {
          sessionStorage.removeItem(USER_CACHE_KEY);
          await signOut(auth);
          window.location.reload();
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
    });
  }

  // Search setup
  const SEARCH_CACHE_KEY = 'freshwax_search_cache';
  const SEARCH_CACHE_DURATION = 5 * 60 * 1000;
  let searchTimeout = null;

  function getCachedSearch(query) {
    try {
      const cached = sessionStorage.getItem(`${SEARCH_CACHE_KEY}_${query}`);
      if (!cached) return null;
      const data = JSON.parse(cached);
      if (Date.now() - data.timestamp > SEARCH_CACHE_DURATION) {
        sessionStorage.removeItem(`${SEARCH_CACHE_KEY}_${query}`);
        return null;
      }
      return data.results;
    } catch (error) {
      return null;
    }
  }

  function setCachedSearch(query, results) {
    try {
      sessionStorage.setItem(`${SEARCH_CACHE_KEY}_${query}`, JSON.stringify({
        results, timestamp: Date.now()
      }));
    } catch (error) {
      console.error('[Search Cache] Error:', error);
    }
  }

  async function performSearch(query, resultsDiv, contentDiv) {
    if (!query || query.length < 2) {
      resultsDiv.classList.add('hidden');
      return;
    }

    const cached = getCachedSearch(query);
    if (cached) {
      displaySearchResults(cached, resultsDiv, contentDiv, query);
      return;
    }

    try {
      const response = await fetch(`/api/search-releases?q=${encodeURIComponent(query)}&limit=8`);
      const data = await response.json();
      if (data.success && data.results) {
        setCachedSearch(query, data.results);
        displaySearchResults(data.results, resultsDiv, contentDiv, query);
      }
    } catch (error) {
      console.error('[Search] Error:', error);
      contentDiv.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500">Error loading results</div>';
      resultsDiv.classList.remove('hidden');
    }
  }

  function displaySearchResults(results, resultsDiv, contentDiv, query) {
    if (results.length === 0) {
      contentDiv.innerHTML = `<div class="px-4 py-3 text-sm text-gray-500">No results found for "${query}"</div>`;
      resultsDiv.classList.remove('hidden');
      return;
    }

    const html = results.map(result => {
      let link = result.type === 'release' ? `/item/${result.id}` 
               : result.type === 'merch' ? `/merch/${result.id}` 
               : `/dj-mix/${result.id}`;

      return `
        <a href="${link}" class="block px-4 py-3 hover:bg-gray-100 transition-colors border-b border-gray-100 last:border-b-0">
          <div class="flex items-center gap-3">
            <img src="${result.artwork_url || '/logo.webp'}" alt="${result.title}" class="w-12 h-12 object-cover rounded" onerror="this.src='/logo.webp'">
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-sm text-gray-900 truncate">${result.title}</div>
              <div class="text-xs text-gray-600 truncate">${result.artist_name}</div>
            </div>
          </div>
        </a>
      `;
    }).join('');

    contentDiv.innerHTML = html + `
      <a href="/releases?search=${encodeURIComponent(query)}" class="block px-4 py-3 text-center text-sm font-semibold text-black hover:bg-gray-100 transition-colors border-t-2 border-gray-200">
        View all results â†’
      </a>
    `;
    resultsDiv.classList.remove('hidden');
  }

  function setupSearch() {
    // Desktop search
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchResultsContent = document.getElementById('search-results-content');
    
    if (searchInput) {
      // Clone to remove old listeners
      const newInput = searchInput.cloneNode(true);
      searchInput.parentNode.replaceChild(newInput, searchInput);
      
      newInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(query, searchResults, searchResultsContent);
        }, 400);
      });

      newInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          if (query) window.location.href = `/releases?search=${encodeURIComponent(query)}`;
        }
      });
    }

    // Mobile search
    const searchInputMobile = document.getElementById('search-input-mobile');
    const searchResultsMobile = document.getElementById('search-results-mobile');
    const searchResultsContentMobile = document.getElementById('search-results-content-mobile');
    
    if (searchInputMobile) {
      const newInputMobile = searchInputMobile.cloneNode(true);
      searchInputMobile.parentNode.replaceChild(newInputMobile, searchInputMobile);
      
      newInputMobile.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(query, searchResultsMobile, searchResultsContentMobile);
        }, 400);
      });

      newInputMobile.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          if (query) window.location.href = `/releases?search=${encodeURIComponent(query)}`;
        }
      });
    }

    // Close search on outside click
    document.addEventListener('click', (e) => {
      const desktopInput = document.getElementById('search-input');
      const mobileInput = document.getElementById('search-input-mobile');
      
      if (searchResults && desktopInput && !desktopInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
      if (searchResultsMobile && mobileInput && !mobileInput.contains(e.target) && !searchResultsMobile.contains(e.target)) {
        searchResultsMobile.classList.add('hidden');
      }
    });
  }

  // Update UI based on auth state
  function updateUIForUser(userData, user) {
    if (userData.isArtist) {
      const artistName = (userData.name || user.email?.split('@')[0] || 'Artist').split(' ')[0];
      document.querySelectorAll('.artist-name').forEach(el => el.textContent = artistName);
      document.querySelectorAll('.artist-button').forEach(btn => {
        btn.classList.remove('bg-gray-100', 'text-black', 'border-gray-300');
        btn.classList.add('bg-gray-800', 'text-white', 'border-2', 'border-black');
      });
      document.querySelectorAll('.artist-logged-in').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.artist-logged-out').forEach(el => el.classList.add('hidden'));
    }
    
    if (userData.isCustomer) {
      const customerName = (userData.name || user.email?.split('@')[0] || 'Customer').split(' ')[0];
      document.querySelectorAll('.customer-name').forEach(el => el.textContent = customerName);
      document.querySelectorAll('.customer-button').forEach(btn => {
        btn.classList.remove('bg-gray-100', 'text-black', 'border-gray-300');
        btn.classList.add('bg-gray-800', 'text-white', 'border-2', 'border-black');
      });
      document.querySelectorAll('.customer-logged-in').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.customer-logged-out').forEach(el => el.classList.add('hidden'));
    }
  }

  // Auth state listener - only set up once
  let authListenerSet = false;
  
  if (!authListenerSet) {
    authListenerSet = true;
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userData = await checkUserType(user.uid);
        updateUIForUser(userData, user);
      } else {
        sessionStorage.removeItem(USER_CACHE_KEY);
      }
    });
  }

  // Storage and cart events
  window.addEventListener('storage', updateCartCount);
  window.addEventListener('cartUpdated', updateCartCount);

  // Initialize on first load
  initHeader();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initHeader);
  document.addEventListener('astro:after-swap', initHeader);
</script>