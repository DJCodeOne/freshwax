<!-- src/components/AudioCoordinator.astro -->
<!-- Central Audio Coordination - Ensures only one audio source plays at a time -->
<!-- Modes: DJ Mix, Shuffle, Tracklist Preview -->

<script is:inline>
  // ===========================================
  // AUDIO MANAGER - Central Audio Coordination
  // ===========================================
  
  (function() {
    // Prevent duplicate initialization
    if (window.AudioManager && window.AudioManager._initialized) {
      return;
    }
    
    window.AudioManager = {
      _initialized: true,
      
      // Current mode: 'idle' | 'dj-mix' | 'shuffle' | 'tracklist-preview'
      mode: 'idle',
      
      // For resuming after tracklist preview
      shouldResumeAfterPreview: false,
      previousMode: 'idle',
      resumeTime: 0,
      
      // Get the global audio element
      getGlobalAudio: function() {
        return document.getElementById('global-audio');
      },
      
      // Get all tracklist preview audio elements
      getTracklistAudios: function() {
        return Array.from(document.querySelectorAll('.track-audio'));
      },
      
      // DJ Mix started playing
      onDjMixPlay: function() {
        console.log('[AudioManager] DJ Mix started');
        this.mode = 'dj-mix';
        this.shouldResumeAfterPreview = false;
        this.stopAllTracklistPreviews();
        this.updateShuffleButtonUI(false);
        if (window.FreshWaxPlayer) {
          window.FreshWaxPlayer.isShuffleMode = false;
        }
      },
      
      // Shuffle mode started
      onShufflePlay: function() {
        console.log('[AudioManager] Shuffle started');
        this.mode = 'shuffle';
        this.shouldResumeAfterPreview = false;
        this.stopAllTracklistPreviews();
        this.updateShuffleButtonUI(true);
      },
      
      // Shuffle mode stopped
      onShuffleStop: function() {
        console.log('[AudioManager] Shuffle stopped');
        if (this.mode === 'shuffle') {
          this.mode = 'idle';
        }
        this.updateShuffleButtonUI(false);
      },
      
      // Tracklist preview started - pauses mini player
      onTracklistPreviewPlay: function() {
        console.log('[AudioManager] Preview starting, mode:', this.mode);
        var audio = this.getGlobalAudio();
        
        if (audio && !audio.paused) {
          this.shouldResumeAfterPreview = true;
          this.previousMode = this.mode;
          this.resumeTime = audio.currentTime;
          audio.pause();
          console.log('[AudioManager] Paused mini player at', this.resumeTime.toFixed(1) + 's');
        } else {
          this.shouldResumeAfterPreview = false;
          this.previousMode = this.mode;
        }
        
        this.mode = 'tracklist-preview';
      },
      
      // Tracklist preview stopped - resume mini player if needed
      onTracklistPreviewStop: function() {
        console.log('[AudioManager] Preview stopped, shouldResume:', this.shouldResumeAfterPreview);
        var self = this;
        
        setTimeout(function() {
          if (self.shouldResumeAfterPreview) {
            var audio = self.getGlobalAudio();
            
            if (audio && audio.paused && audio.src) {
              if (self.resumeTime > 0) {
                audio.currentTime = self.resumeTime;
              }
              
              audio.play().then(function() {
                self.mode = self.previousMode;
                self.shouldResumeAfterPreview = false;
                self.resumeTime = 0;
                console.log('[AudioManager] Resumed mini player');
              }).catch(function(err) {
                console.warn('[AudioManager] Resume failed:', err.message);
                self.mode = 'idle';
                self.shouldResumeAfterPreview = false;
              });
            } else {
              self.mode = 'idle';
              self.shouldResumeAfterPreview = false;
            }
          } else {
            self.mode = 'idle';
          }
        }, 150);
      },
      
      // Stop all tracklist previews
      stopAllTracklistPreviews: function() {
        this.getTracklistAudios().forEach(function(audio) {
          if (!audio.paused) {
            audio.pause();
            audio.currentTime = 0;
          }
        });
        
        document.querySelectorAll('.play-button').forEach(function(btn) {
          var playIcon = btn.querySelector('.play-icon');
          var pauseIcon = btn.querySelector('.pause-icon');
          if (playIcon) playIcon.classList.remove('hidden');
          if (pauseIcon) pauseIcon.classList.add('hidden');
        });
        
        document.querySelectorAll('[data-now-playing-text]').forEach(function(el) {
          el.textContent = 'No track selected';
        });
      },
      
      // Stop everything
      stopAll: function() {
        var audio = this.getGlobalAudio();
        if (audio && !audio.paused) {
          audio.pause();
        }
        this.stopAllTracklistPreviews();
        this.mode = 'idle';
        this.shouldResumeAfterPreview = false;
        this.previousMode = 'idle';
        this.resumeTime = 0;
        this.updateShuffleButtonUI(false);
        if (window.FreshWaxPlayer) {
          window.FreshWaxPlayer.isShuffleMode = false;
        }
      },
      
      // UI Helpers
      updateShuffleButtonUI: function(isShuffling) {
        var btn = document.getElementById('mini-shuffle-btn');
        if (btn) {
          if (isShuffling) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        }
      },
      
      isPlaying: function() {
        var audio = this.getGlobalAudio();
        return audio ? !audio.paused : false;
      },
      
      getMode: function() {
        return this.mode;
      }
    };
    
    console.log('[AudioManager] Ready');
  })();
</script>