---
// src/components/Analytics.astro
// Google Analytics 4 + additional tracking for Fresh Wax
// Place this in your Layout.astro <head> section

interface Props {
  // Your Google Analytics 4 Measurement ID (format: G-XXXXXXXXXX)
  ga4Id?: string;
  // Optional Google Tag Manager ID (format: GTM-XXXXXXX)
  gtmId?: string;
  // Enable enhanced e-commerce tracking
  ecommerce?: boolean;
  // Enable debug mode (for development)
  debug?: boolean;
}

const {
  ga4Id = '', // Add your GA4 ID here: 'G-XXXXXXXXXX'
  gtmId = '', // Add your GTM ID here if using Tag Manager
  ecommerce = true,
  debug = import.meta.env.DEV
} = Astro.props;

// Only render analytics in production (or if debug is enabled)
const shouldRender = ga4Id && (import.meta.env.PROD || debug);
---

{shouldRender && (
  <>
    <!-- Google Analytics 4 -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga4Id}`}></script>
    <script define:vars={{ ga4Id, ecommerce, debug }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      // Base configuration with privacy settings
      gtag('config', ga4Id, {
        'anonymize_ip': true,
        'cookie_flags': 'SameSite=None;Secure',
        'send_page_view': true,
        // Enhanced measurement (scrolling, outbound clicks, etc.)
        'enhanced_measurement': true,
        // Debug mode
        'debug_mode': debug,
        // Custom dimensions for music site
        'custom_map': {
          'dimension1': 'user_type',
          'dimension2': 'genre',
          'dimension3': 'artist',
          'dimension4': 'release_format'
        }
      });

      // Enhanced E-commerce setup
      if (ecommerce) {
        gtag('set', 'linker', {
          'domains': ['freshwax.co.uk']
        });
      }

      // ============================================
      // FRESH WAX CUSTOM EVENT TRACKING
      // ============================================
      
      // Helper function for tracking events
      window.trackEvent = function(eventName, parameters = {}) {
        if (typeof gtag === 'function') {
          gtag('event', eventName, parameters);
        }
      };

      // Track audio play events (for DJ mixes)
      window.trackAudioPlay = function(mixId, mixTitle, djName, duration) {
        trackEvent('audio_play', {
          'event_category': 'DJ Mix',
          'event_label': mixTitle,
          'mix_id': mixId,
          'dj_name': djName,
          'duration': duration,
          'content_type': 'dj_mix'
        });
      };

      // Track audio complete events
      window.trackAudioComplete = function(mixId, mixTitle, djName) {
        trackEvent('audio_complete', {
          'event_category': 'DJ Mix',
          'event_label': mixTitle,
          'mix_id': mixId,
          'dj_name': djName
        });
      };

      // Track release preview plays
      window.trackPreviewPlay = function(releaseId, releaseTitle, artist, trackName) {
        trackEvent('preview_play', {
          'event_category': 'Release Preview',
          'event_label': releaseTitle,
          'release_id': releaseId,
          'artist': artist,
          'track_name': trackName
        });
      };

      // Track add to cart
      window.trackAddToCart = function(itemId, itemName, price, itemType, quantity = 1) {
        trackEvent('add_to_cart', {
          'currency': 'GBP',
          'value': price * quantity,
          'items': [{
            'item_id': itemId,
            'item_name': itemName,
            'price': price,
            'quantity': quantity,
            'item_category': itemType // 'vinyl', 'digital', 'merch'
          }]
        });
      };

      // Track remove from cart
      window.trackRemoveFromCart = function(itemId, itemName, price, quantity = 1) {
        trackEvent('remove_from_cart', {
          'currency': 'GBP',
          'value': price * quantity,
          'items': [{
            'item_id': itemId,
            'item_name': itemName,
            'price': price,
            'quantity': quantity
          }]
        });
      };

      // Track view item (product page)
      window.trackViewItem = function(itemId, itemName, price, itemType, artist = null) {
        trackEvent('view_item', {
          'currency': 'GBP',
          'value': price,
          'items': [{
            'item_id': itemId,
            'item_name': itemName,
            'price': price,
            'item_category': itemType,
            'item_brand': artist || 'Fresh Wax'
          }]
        });
      };

      // Track begin checkout
      window.trackBeginCheckout = function(cartItems, totalValue) {
        trackEvent('begin_checkout', {
          'currency': 'GBP',
          'value': totalValue,
          'items': cartItems.map(item => ({
            'item_id': item.id,
            'item_name': item.name,
            'price': item.price,
            'quantity': item.quantity
          }))
        });
      };

      // Track purchase
      window.trackPurchase = function(orderId, totalValue, items, shipping = 0) {
        trackEvent('purchase', {
          'transaction_id': orderId,
          'currency': 'GBP',
          'value': totalValue,
          'shipping': shipping,
          'items': items.map(item => ({
            'item_id': item.id,
            'item_name': item.name,
            'price': item.price,
            'quantity': item.quantity
          }))
        });
      };

      // Track live stream engagement
      window.trackLiveStreamJoin = function(streamId, djName) {
        trackEvent('live_stream_join', {
          'event_category': 'Live Stream',
          'event_label': djName,
          'stream_id': streamId
        });
      };

      // Track live stream chat messages
      window.trackLiveStreamChat = function(streamId) {
        trackEvent('live_stream_chat', {
          'event_category': 'Live Stream',
          'stream_id': streamId
        });
      };

      // Track newsletter signup
      window.trackNewsletterSignup = function(location) {
        trackEvent('newsletter_signup', {
          'event_category': 'Engagement',
          'event_label': location
        });
      };

      // Track search
      window.trackSearch = function(searchTerm, resultsCount) {
        trackEvent('search', {
          'search_term': searchTerm,
          'results_count': resultsCount
        });
      };

      // Track filter usage
      window.trackFilter = function(filterType, filterValue) {
        trackEvent('filter_use', {
          'event_category': 'Navigation',
          'filter_type': filterType,
          'filter_value': filterValue
        });
      };

      // Track downloads (for digital purchases)
      window.trackDownload = function(releaseId, releaseTitle, format) {
        trackEvent('download', {
          'event_category': 'Downloads',
          'event_label': releaseTitle,
          'release_id': releaseId,
          'format': format
        });
      };

      // Track external link clicks
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && link.href && !link.href.includes('freshwax.co.uk')) {
          trackEvent('outbound_click', {
            'event_category': 'Outbound Links',
            'event_label': link.href
          });
        }
      });

      // Track scroll depth
      let scrollDepthTracked = {};
      window.addEventListener('scroll', function() {
        const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
        const milestones = [25, 50, 75, 90, 100];
        
        milestones.forEach(milestone => {
          if (scrollPercent >= milestone && !scrollDepthTracked[milestone]) {
            scrollDepthTracked[milestone] = true;
            trackEvent('scroll_depth', {
              'event_category': 'Engagement',
              'event_label': milestone + '%',
              'value': milestone
            });
          }
        });
      });

      // Track time on page
      let timeOnPage = 0;
      setInterval(function() {
        timeOnPage += 30;
        if (timeOnPage === 30 || timeOnPage === 60 || timeOnPage === 180 || timeOnPage === 300) {
          trackEvent('time_on_page', {
            'event_category': 'Engagement',
            'event_label': timeOnPage + ' seconds',
            'value': timeOnPage
          });
        }
      }, 30000);

      // Console log for debugging
      if (debug) {
        console.log('[Analytics] GA4 initialized:', ga4Id);
      }
    </script>

    <!-- Google Tag Manager (if ID provided) -->
    {gtmId && (
      <>
        <script define:vars={{ gtmId }}>
          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
          })(window,document,'script','dataLayer',gtmId);
        </script>
      </>
    )}

    <!-- Web Vitals Tracking -->
    <script>
      // Track Core Web Vitals
      if ('web-vital' in window || typeof PerformanceObserver !== 'undefined') {
        try {
          // LCP - Largest Contentful Paint
          new PerformanceObserver((entryList) => {
            for (const entry of entryList.getEntries()) {
              if (typeof gtag === 'function') {
                gtag('event', 'web_vitals', {
                  'event_category': 'Web Vitals',
                  'event_label': 'LCP',
                  'value': Math.round(entry.startTime),
                  'non_interaction': true
                });
              }
            }
          }).observe({ type: 'largest-contentful-paint', buffered: true });

          // FID - First Input Delay
          new PerformanceObserver((entryList) => {
            for (const entry of entryList.getEntries()) {
              if (typeof gtag === 'function') {
                gtag('event', 'web_vitals', {
                  'event_category': 'Web Vitals',
                  'event_label': 'FID',
                  'value': Math.round(entry.processingStart - entry.startTime),
                  'non_interaction': true
                });
              }
            }
          }).observe({ type: 'first-input', buffered: true });

          // CLS - Cumulative Layout Shift
          let clsValue = 0;
          new PerformanceObserver((entryList) => {
            for (const entry of entryList.getEntries()) {
              if (!entry.hadRecentInput) {
                clsValue += entry.value;
              }
            }
          }).observe({ type: 'layout-shift', buffered: true });

          // Report CLS on page hide
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && typeof gtag === 'function') {
              gtag('event', 'web_vitals', {
                'event_category': 'Web Vitals',
                'event_label': 'CLS',
                'value': Math.round(clsValue * 1000),
                'non_interaction': true
              });
            }
          });
        } catch (e) {
          console.warn('[Analytics] Web Vitals tracking failed:', e);
        }
      }
    </script>
  </>
)}

<!-- GTM noscript fallback (place after opening <body> tag) -->
{gtmId && shouldRender && (
  <noscript>
    <iframe 
      src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
      height="0" 
      width="0" 
      style="display:none;visibility:hidden">
    </iframe>
  </noscript>
)}
