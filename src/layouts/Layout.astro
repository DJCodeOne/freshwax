---
// src/layouts/Layout.astro
// Enhanced Layout with comprehensive SEO and analytics
import '../styles/global.css';
import '../styles/mobile-enhancements.css';
import { ViewTransitions } from 'astro:transitions';
import GlobalAudioPlayer from '../components/GlobalAudioPlayer.astro';
import AudioCoordinator from '../components/AudioCoordinator.astro';
import FloatingShuffleButton from '../components/FloatingShuffleButton.astro';
import SEO from '../components/SEO.astro';
import Analytics from '../components/Analytics.astro';

// Pusher config for client-side (PUBLIC_ prefixed vars are safe to expose)
const pusherConfig = {
  key: import.meta.env.PUBLIC_PUSHER_KEY || '',
  cluster: import.meta.env.PUBLIC_PUSHER_CLUSTER || 'eu'
};

interface Props {
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  type?: 'website' | 'article' | 'product' | 'music.album' | 'video.other';
  noindex?: boolean;
  canonical?: string;
  keywords?: string[];
  
  // Product data (for releases, merch)
  product?: {
    price: number;
    currency?: string;
    availability?: 'InStock' | 'OutOfStock' | 'PreOrder' | 'LimitedAvailability';
    sku?: string;
    gtin?: string;
    brand?: string;
    condition?: 'NewCondition' | 'UsedCondition';
    category?: string;
    reviews?: { rating: number; count: number };
    priceValidUntil?: string;
  };
  
  // Music release data
  music?: {
    artist: string;
    releaseDate?: string;
    genre?: string[];
    label?: string;
    format?: string[];
    tracks?: { name: string; duration?: string; isrc?: string }[];
    catalogNumber?: string;
    bpm?: number;
  };
  
  // Audio content (DJ mixes)
  audio?: {
    duration: string;
    artist: string;
    uploadDate: string;
    thumbnailUrl?: string;
    contentUrl?: string;
    embedUrl?: string;
    genre?: string[];
  };
  
  // Video content
  video?: {
    duration: string;
    uploadDate: string;
    thumbnailUrl: string;
    contentUrl?: string;
    embedUrl?: string;
    description?: string;
  };
  
  // Event (live streams)
  event?: {
    startDate: string;
    endDate?: string;
    performer?: string;
    eventStatus?: 'EventScheduled' | 'EventRescheduled' | 'EventCancelled' | 'EventPostponed';
    eventAttendanceMode?: 'OnlineEventAttendanceMode' | 'OfflineEventAttendanceMode';
  };
  
  // Article/blog data
  article?: {
    publishedTime: string;
    modifiedTime?: string;
    author?: string;
    tags?: string[];
    section?: string;
  };
  
  // FAQ data
  faqs?: { question: string; answer: string }[];
  
  // ItemList for category pages
  itemList?: {
    name: string;
    items: { name: string; url: string; image?: string; position: number }[];
  };
  
  // Breadcrumbs
  breadcrumbs?: { name: string; url: string }[];

  // Hide shuffle button (for live pages)
  hideShuffle?: boolean;
}

const {
  title,
  description = 'Independent UK jungle and drum & bass record label and music store. Digital downloads, limited edition vinyl pressings, DJ mixes, and official merchandise.',
  image,
  imageAlt,
  type,
  noindex,
  canonical,
  keywords,
  product,
  music,
  audio,
  video,
  event,
  article,
  faqs,
  itemList,
  breadcrumbs,
  hideShuffle
} = Astro.props;

// =============================================
// GOOGLE ANALYTICS CONFIGURATION
// =============================================
const GA4_ID = 'G-MHKVCNPYBQ';
const GTM_ID = ''; // Optional: Google Tag Manager ID
---

<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1280" />

    <!-- Bing Webmaster Verification -->
    <meta name="msvalidate.01" content="C8E438BABBBCC1E7056C65D9DB7F4DD3" />

    <!-- Mobile optimization & PWA -->
    <meta name="theme-color" content="#8b5cf6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    
    <!-- Favicon - Google prefers 48x48+ multiples -->
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://firestore.googleapis.com" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    
    <!-- GIF API preconnects for faster loading -->
    <link rel="dns-prefetch" href="https://api.giphy.com" />
    <link rel="dns-prefetch" href="https://tenor.googleapis.com" />
    <link rel="dns-prefetch" href="https://api.gfycat.com" />
    <link rel="dns-prefetch" href="https://www.reddit.com" />
    
    <!-- Critical fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet" />
    
    <!-- SEO Component - comprehensive meta tags and structured data -->
    <SEO 
      title={title}
      description={description}
      image={image}
      imageAlt={imageAlt}
      type={type}
      noindex={noindex}
      canonical={canonical}
      keywords={keywords}
      product={product}
      music={music}
      audio={audio}
      video={video}
      event={event}
      article={article}
      faqs={faqs}
      itemList={itemList}
      breadcrumbs={breadcrumbs}
    />
    
    <!-- Analytics - Google Analytics 4 + enhanced tracking -->
    <Analytics 
      ga4Id={GA4_ID}
      gtmId={GTM_ID}
      ecommerce={true}
    />
    
    <ViewTransitions />
    
    <style is:global>
      /* Critical CSS inlined */
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background: #000000;
        color: #ffffff;
        min-width: 1280px;
      }
      
      h1, h2, h3, h4, h5, h6 {
        font-family: 'Inter', sans-serif; font-weight: 700;
        letter-spacing: 0.02em;
      }
      
      /* Mini player spacer */
      body:has(#mini-player.visible) #mini-player-spacer {
        height: 70px;
      }
      
      @media (min-width: 640px) {
        body:has(#mini-player.visible) #mini-player-spacer {
          height: 80px;
        }
      }
      
      /* Reduce CLS from images */
      img {
        max-width: 100%;
        height: auto;
      }
      
      /* Skip to content link for accessibility */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #dc2626;
        color: white;
        padding: 8px 16px;
        z-index: 100;
        transition: top 0.3s;
      }
      
      .skip-link:focus {
        top: 0;
      }
    </style>
  </head>
  <body>
    <!-- Accessibility: Skip to main content -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Fallback for users with JavaScript disabled -->
    <noscript>
      <div style="background: #1a1a1a; color: #fff; padding: 2rem; text-align: center; font-family: system-ui, sans-serif;">
        <h1 style="color: #dc2626; margin-bottom: 1rem;">JavaScript Required</h1>
        <p style="margin-bottom: 1rem;">Fresh Wax requires JavaScript to browse releases, play audio, and make purchases.</p>
        <p style="color: #888;">Please enable JavaScript in your browser settings to continue.</p>
      </div>
    </noscript>

    <!-- Cart functionality -->
    <script is:inline src="/freshwax-cart.js"></script>
    
    <!-- Pusher config for real-time features -->
    <script define:vars={{ pusherConfig }}>
      window.PUSHER_CONFIG = pusherConfig;
    </script>
    
    <!-- Audio Coordinator -->
    <AudioCoordinator />
    
    <!-- Main content -->
    <main id="main-content">
      <slot />
    </main>
    
    <!-- Global Audio Player -->
    <GlobalAudioPlayer />

    <!-- Floating Shuffle Button (hidden on live pages) -->
    {!hideShuffle && <FloatingShuffleButton />}

    <!-- Spacer for mini player -->
    <div id="mini-player-spacer" class="h-0 transition-all duration-300"></div>
    
    <!-- Cookie consent banner (optional - uncomment if needed) -->
    <!--
    <div id="cookie-consent" class="fixed bottom-0 left-0 right-0 bg-gray-900 p-4 z-50 hidden">
      <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
        <p class="text-sm text-gray-300">
          We use cookies to improve your experience. By using our site, you agree to our 
          <a href="/cookies" class="text-red-500 underline">cookie policy</a>.
        </p>
        <button 
          onclick="acceptCookies()" 
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
        >
          Accept
        </button>
      </div>
    </div>
    <script is:inline>
      if (!localStorage.getItem('cookies-accepted')) {
        document.getElementById('cookie-consent')?.classList.remove('hidden');
      }
      function acceptCookies() {
        localStorage.setItem('cookies-accepted', 'true');
        document.getElementById('cookie-consent')?.classList.add('hidden');
      }
    </script>
    -->

    <!-- Service Worker Registration for PWA -->
    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((reg) => console.log('[PWA] Service worker registered'))
            .catch((err) => console.log('[PWA] Service worker failed:', err));
        });
      }
    </script>
  </body>
</html>
