---
// src/pages/item/[id].astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const { id } = Astro.params;


let release = null;
let error = null;

try {
  // Add nocache timestamp to ensure fresh data (ratings/comments update frequently)
  const apiUrl = `${Astro.url.origin}/api/get-release?id=${id}&admin=true&nocache=${Date.now()}`;
  
  const response = await fetch(apiUrl);
  const data = await response.json();
  
  if (data.success && data.release) {
    release = data.release;
  } else {
    error = data.error || 'Release not found';
  }
} catch (err) {
  console.error('[ITEM PAGE] ‚úó Fetch error:', err);
  error = 'Failed to load release';
}

const {
  artistName = 'Unknown Artist',
  artistId = '',
  artistBio = '',
  releaseName = 'Untitled Release',
  labelName = '',
  labelCode = '',
  catalogNumber = '',
  genre = '',
  coverArtUrl = '/place-holder.webp',
  additionalArtwork = [],
  tracks = [],
  releaseDate = new Date().toISOString(),
  pricePerSale,
  trackPrice,
  saleDiscount = 0,
  vinylRelease = false,
  vinylRecordCount = '',
  vinylPrice = 0,
  vinylShippingUK = null,
  vinylShippingEU = null,
  vinylShippingIntl = null,
  overallRating = { average: 0, count: 0, total: 0 },
  comments = [],
  notes = '',
  description = '',
  releaseDescription = '',
  masteredBy = '',
  copyrightHolder = '',
  copyrightYear = new Date().getFullYear(),
  recordingLocation = '',
  recordingYear = '',
  hasLimitedEdition = false,
  limitedEditionDetails = '',
  vinyl = {},
  // NYOP fields
  nyopEnabled = false,
  nyopMinPrice = 0,
  nyopSuggestedPrice = 0
} = release || {};

// Handle pricing - use explicit checks to avoid 0 being treated as falsy
const actualTrackPrice = trackPrice !== undefined && trackPrice !== null ? trackPrice : 1.00;
const actualPricePerSale = pricePerSale !== undefined && pricePerSale !== null ? pricePerSale : 0;

// Sort comments by date (most recent first)
const sortedComments = comments.sort((a, b) => {
  const dateA = new Date(a.timestamp || a.createdAt || 0);
  const dateB = new Date(b.timestamp || b.createdAt || 0);
  return dateB.getTime() - dateA.getTime();
});

// Check if artist has a bio
const hasBio = !!(artistBio && artistBio.trim());

// Parse social links from notes
let socialLinks = [];
let otherInfo = '';

// Check notes, description, or releaseDescription for social links
const notesText = notes || description || '';
if (notesText) {
  const socialLinksTemp = [];
  const otherLinesTemp = [];
  const lines = notesText.split('\n');
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;
    
    if (trimmed.includes('soundcloud.com/') || trimmed.includes('SoundCloud:')) {
      const url = trimmed.replace('SoundCloud:', '').trim();
      socialLinksTemp.push({ platform: 'SoundCloud', url: url, icon: 'üéß' });
    } else if (trimmed.includes('instagram.com/') || trimmed.includes('Instagram:')) {
      const url = trimmed.replace('Instagram:', '').trim();
      socialLinksTemp.push({ platform: 'Instagram', url: url, icon: 'üì∑' });
    } else if (trimmed.includes('facebook.com/') || trimmed.includes('Facebook:')) {
      const url = trimmed.replace('Facebook:', '').trim();
      socialLinksTemp.push({ platform: 'Facebook', url: url, icon: 'üë•' });
    } else if (trimmed.includes('spotify.com/') || trimmed.includes('Spotify:')) {
      const url = trimmed.replace('Spotify:', '').trim();
      socialLinksTemp.push({ platform: 'Spotify', url: url, icon: 'üéµ' });
    } else if (trimmed.includes('bandcamp.com') || trimmed.includes('Bandcamp:')) {
      const url = trimmed.replace('Bandcamp:', '').trim();
      socialLinksTemp.push({ platform: 'Bandcamp', url: url, icon: 'üé∏' });
    } else if (trimmed.includes('youtube.com/') || trimmed.includes('YouTube:')) {
      const url = trimmed.replace('YouTube:', '').trim();
      socialLinksTemp.push({ platform: 'YouTube', url: url, icon: 'üì∫' });
    } else if (trimmed.includes('twitter.com/') || trimmed.includes('x.com/') || trimmed.includes('Twitter:')) {
      const url = trimmed.replace('Twitter:', '').trim();
      socialLinksTemp.push({ platform: 'Twitter/X', url: url, icon: 'üê¶' });
    } else if (trimmed.match(/^https?:\/\//i)) {
      // Generic URL - extract domain for display
      try {
        const urlObj = new URL(trimmed);
        const domain = urlObj.hostname.replace('www.', '');
        socialLinksTemp.push({ platform: domain, url: trimmed, icon: 'üåê' });
      } catch {
        otherLinesTemp.push(trimmed);
      }
    } else {
      otherLinesTemp.push(trimmed);
    }
  }
  
  socialLinks = socialLinksTemp;
  otherInfo = otherLinesTemp.join('\n');
}

// Helper to linkify URLs in text
function linkifyText(text: string): string {
  if (!text) return '';
  // Escape HTML first
  const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  // Convert URLs to clickable links
  const urlRegex = /(https?:\/\/[^\s<]+)/gi;
  return escaped.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-red-400 hover:text-red-300 underline">$1</a>');
}

const descriptionHtml = linkifyText(releaseDescription || otherInfo);

// Parse artist from wavUrl filename (format: ArtistName_-_AlbumName_-_...)
function parseArtistFromWavUrl(wavUrl: string): string {
  if (!wavUrl) return '';
  const filename = wavUrl.split('/').pop() || '';
  const match = filename.match(/^(.+?)_-_[^_]/);
  if (match) {
    return match[1].replace(/_/g, ' ').replace(/  +/g, ' & ').trim();
  }
  return '';
}

// Check if this is a release with "Artist - Title" format that needs swapping
const needsSwap = releaseName.toLowerCase().includes('vol.2') || releaseName.toLowerCase().includes('vol 2');

const tracksWithIds = tracks.map((track, index) => {
  const displayNum = track.displayTrackNumber || track.trackNumber + 1 || (index + 1);
  const rawTitle = track.trackName || `Track ${displayNum}`;

  // Check if trackName already contains " - " (embedded artist info)
  const hasEmbeddedArtist = rawTitle.includes(' - ');
  let title = rawTitle;
  let trackArtist = '';

  if (hasEmbeddedArtist) {
    if (needsSwap) {
      // Vol 2 format: "Artist - Title" ‚Üí swap to show Title - Artist
      const parts = rawTitle.split(' - ');
      trackArtist = parts[0].trim();
      title = parts.slice(1).join(' - ').trim();
    } else {
      // Vol 1 format: "Title - Artist" ‚Üí keep as-is in white
      title = rawTitle;
      trackArtist = '';
    }
  } else {
    // Try explicit artist field, then parse from wavUrl
    trackArtist = track.artist || track.trackArtist || parseArtistFromWavUrl(track.wavUrl);
  }

  return {
    id: `${id}-track-${displayNum}`,
    title: title,
    artist: trackArtist,
    preview_url: track.previewUrl || null,
    track_number: displayNum,
    mp3Url: track.mp3Url,
    wavUrl: track.wavUrl,
    duration: track.duration || track.trackDuration || '',
    key: track.key || '--',
    bpm: track.bpm || '',
    featured: track.featured || track.featuredArtist || '',
    remixer: track.remixer || ''
  };
});

tracksWithIds.sort((a, b) => a.track_number - b.track_number);

const formattedDate = release ? new Date(releaseDate).toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
}) : '';

const vinylAvailable = vinylRelease && parseInt(vinylRecordCount || '0') > 0;
const originalDigitalPrice = actualPricePerSale || actualTrackPrice * tracksWithIds.length;
const hasSale = saleDiscount > 0;
const digitalPrice = hasSale ? originalDigitalPrice * (1 - saleDiscount / 100) : originalDigitalPrice;
const saleTrackPrice = hasSale ? actualTrackPrice * (1 - saleDiscount / 100) : actualTrackPrice;
const displayGenre = genre.toLowerCase() === 'dnb' ? 'Drum and Bass' : genre;

// Pre-order logic - if release date is in the future
const releaseDateTime = new Date(releaseDate);
const now = new Date();
const isPreOrder = releaseDateTime > now;
const daysUntilRelease = isPreOrder ? Math.ceil((releaseDateTime.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)) : 0;
---

<Layout
  title={release ? `${releaseName} - ${artistName}` : 'Release Not Found'}
  description={release ? `${releaseName} by ${artistName}${genre ? ` - ${genre}` : ''}${labelName ? ` on ${labelName}` : ''}. Stream, buy and download on Fresh Wax.` : 'Release not found'}
  image={coverArtUrl && coverArtUrl !== '/place-holder.webp' ? coverArtUrl : undefined}
  imageAlt={release ? `${releaseName} by ${artistName} - Album Artwork` : undefined}
  type="music.album"
  music={release ? {
    artist: artistName,
    releaseDate: releaseDate,
    genre: genre ? [genre] : undefined,
    label: labelName || undefined,
    format: vinylRelease ? ['Vinyl', 'Digital'] : ['Digital'],
    tracks: tracks?.map((t: any) => ({ name: t.trackName || 'Untitled', duration: t.duration }))
  } : undefined}
  product={release && actualPricePerSale > 0 ? {
    price: actualPricePerSale,
    currency: 'GBP',
    availability: 'InStock',
    brand: artistName,
    category: 'Music > Digital Downloads'
  } : undefined}
>
  <Header />
  
  {!release ? (
    <main style="min-height: 100vh; background: #000000; padding: 2rem 0;">
      <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white border-2 border-black p-8 text-center">
          <h1 class="text-3xl font-black text-black mb-4 uppercase">Release Not Found</h1>
          <p class="text-lg font-bold text-black mb-2">ID: {id}</p>
          <p class="text-gray-700 mb-6 font-semibold">{error || 'This release could not be loaded.'}</p>
          <a href="/" class="inline-block bg-black text-white px-6 py-3 font-black hover:bg-gray-800 transition-colors uppercase border-2 border-black">
            ‚Üê Back to Homepage
          </a>
        </div>
      </div>
    </main>
  ) : (
    <main style="min-height: 100vh; background: #000000; padding: 1rem 0;">
      <!-- Data attributes for recommendations -->
      <div 
        id="release-meta" 
        data-release-id={id}
        data-artist-name={artistName}
        data-label-name={labelName || copyrightHolder || ''}
        data-genre={genre || ''}
        style="display: none;"
      ></div>
      
      <div class="max-w-7xl mx-auto px-3 md:px-4">
        
        <a href="/" class="inline-flex items-center gap-2 text-white hover:text-gray-300 font-black mb-4 md:mb-6 transition-colors uppercase text-sm md:text-base border-2 border-white px-3 md:px-4 py-2">
          <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Back to Releases
        </a>

        <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white p-4 md:p-8 mb-4 md:mb-6 shadow-xl">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            
            <div class="lg:col-span-1">
              <div class="relative">
                <img
                  src={coverArtUrl}
                  alt={`${releaseName} by ${artistName}`}
                  class="w-full border-2 md:border-4 border-white shadow-2xl mb-4 md:mb-6"
                  onerror="this.src='/place-holder.webp'"
                />
                {hasSale && (
                  <div class="sale-badge-item">{saleDiscount}% OFF</div>
                )}
              </div>
              
              <!-- Digital and Vinyl Buttons -->
              <div class="flex flex-col gap-2 mb-4 md:mb-6">
                {isPreOrder && (
                  <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white text-center py-2 px-4 font-bold text-sm uppercase rounded-t border-2 border-white border-b-0">
                    üöÄ Pre-order ‚Ä¢ Releases in {daysUntilRelease} {daysUntilRelease === 1 ? 'day' : 'days'}
                  </div>
                )}

                {/* NYOP Purchase UI - Simplified with Modal */}
                {nyopEnabled ? (
                  <div class="nyop-container-item" data-release-id={id}>
                    <div class="text-sm text-white uppercase tracking-wide font-black mb-3 text-center">Name Your Price</div>
                    <button
                      type="button"
                      data-release-id={id}
                      data-title={releaseName}
                      data-artist={artistName}
                      data-artist-id={artistId}
                      data-label-name={labelName}
                      data-artwork={coverArtUrl}
                      data-nyop-min={nyopMinPrice}
                      data-nyop-suggested={nyopSuggestedPrice}
                      data-is-preorder={isPreOrder ? 'true' : 'false'}
                      class="nyop-open-modal w-full px-4 py-3.5 border-2 border-white shadow-lg flex items-center justify-center gap-2 transition-all font-black text-base uppercase bg-gradient-to-r from-gray-900 to-black hover:from-green-700 hover:to-green-800 text-white"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                      </svg>
                      <span>Buy Digital Download</span>
                    </button>
                  </div>
                ) : (
                  <button
                    data-release-id={id}
                    data-product-type="digital"
                    data-price={digitalPrice}
                    data-title={releaseName}
                    data-artist={artistName}
                    data-artist-id={artistId}
                    data-label-name={labelName}
                    data-artwork={coverArtUrl}
                    data-is-preorder={isPreOrder ? 'true' : 'false'}
                    class={`add-to-cart px-4 py-3.5 border-2 border-white shadow-lg flex items-center justify-center gap-2 transition-all font-black text-base uppercase w-full ${
                      isPreOrder
                        ? 'bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white'
                        : 'bg-gradient-to-r from-black-600 to-black-700 hover:from-green-700 hover:to-green-800 text-white'
                    }`}
                  >
                    {isPreOrder ? (
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    ) : (
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                      </svg>
                    )}
                    {isPreOrder ? `Pre-order Digital - ¬£${digitalPrice.toFixed(2)}` : (
                      hasSale ? (
                        <span>Digital Download - <span class="line-through text-gray-400">¬£{originalDigitalPrice.toFixed(2)}</span> <span class="text-green-400 font-black">¬£{digitalPrice.toFixed(2)}</span></span>
                      ) : `Digital Download - ¬£${digitalPrice.toFixed(2)}`
                    )}
                  </button>
                )}

                <button
                  data-release-id={id}
                  data-product-type="vinyl"
                  data-price={vinylPrice || 0}
                  data-digital-price={digitalPrice}
                  data-title={releaseName}
                  data-artist={artistName}
                  data-artist-id={artistId}
                  data-label-name={labelName}
                  data-artwork={coverArtUrl}
                  data-includes-digital="true"
                  data-is-preorder={isPreOrder ? 'true' : 'false'}
                  disabled={!vinylRelease || !vinylAvailable}
                  class={`add-to-cart px-4 py-3.5 border-2 border-white shadow-lg flex items-center justify-center gap-2 transition-all font-black uppercase text-base w-full ${
                    vinylRelease && vinylAvailable
                      ? (isPreOrder
                          ? 'bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white cursor-pointer'
                          : 'bg-gradient-to-r from-red-600 to-red-700 hover:from-green-700 hover:to-green-800 text-white cursor-pointer')
                      : 'bg-gray-500 text-gray-300 cursor-not-allowed'
                  }`}
                >
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                  </svg>
                  {vinylRelease && vinylAvailable
                    ? (isPreOrder ? `Pre-order Vinyl + Digital - ¬£${vinylPrice?.toFixed(2)}` : `Vinyl + Digital - ¬£${vinylPrice?.toFixed(2)}`)
                    : 'Vinyl Unavailable'}
                </button>
              </div>

              {/* Vinyl Shipping Info */}
              {vinylRelease && vinylAvailable && (
                <div class="mt-3 p-3 bg-gray-800/50 border border-gray-700 rounded text-xs text-gray-300">
                  <div class="flex items-center gap-1.5 mb-1.5">
                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    <span class="font-semibold text-white uppercase tracking-wide">Vinyl Shipping</span>
                  </div>
                  <div class="flex flex-wrap gap-x-4 gap-y-1">
                    <span>UK: ¬£{(vinylShippingUK ?? 4.99).toFixed(2)}</span>
                    <span>EU: ¬£{(vinylShippingEU ?? 9.99).toFixed(2)}</span>
                    <span>Intl: ¬£{(vinylShippingIntl ?? 14.99).toFixed(2)}</span>
                  </div>
                </div>
              )}

              {additionalArtwork && additionalArtwork.length > 0 && (
                <div class="mt-4 md:mt-6">
                  <div class="text-white font-black text-sm md:text-base uppercase tracking-wide mb-2 md:mb-3 border-b-2 border-red-600 pb-2">Additional Artwork</div>
                  <div class="grid grid-cols-2 gap-2">
                    {additionalArtwork.slice(0, 4).map((img) => (
                      <img 
                        src={img} 
                        alt={`${releaseName} additional artwork`}
                        class="w-full aspect-square object-cover border-2 border-white shadow-lg cursor-pointer hover:border-red-600 transition-colors"
                        onerror="this.src='/place-holder.webp'"
                      />
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div class="lg:col-span-2 space-y-4 md:space-y-6">
              <div>
                <h1 class="text-3xl md:text-5xl font-black text-red-500 mb-2 md:mb-3 leading-tight uppercase drop-shadow-lg truncate" title={releaseName}>{releaseName.length > 40 ? releaseName.substring(0, 37) + '...' : releaseName}</h1>
                <div class="flex items-center gap-3 mb-1 md:mb-2">
                  <p class="text-2xl md:text-3xl font-black text-white uppercase drop-shadow-md truncate" title={artistName}>{artistName.length > 40 ? artistName.substring(0, 37) + '...' : artistName}</p>
                  <button 
                    id="followArtistBtn"
                    class="follow-artist-btn flex items-center gap-1.5 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white rounded-full transition-all text-sm font-semibold border border-gray-500"
                    data-artist-name={artistName}
                    data-artist-id={artistId}
                    title="Follow this artist"
                  >
                    <svg class="w-4 h-4 follow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span class="follow-text">Follow</span>
                  </button>
                  <button 
                    id="wishlistBtn"
                    class="wishlist-btn flex items-center justify-center w-9 h-9 bg-gray-700 hover:bg-gray-600 text-white rounded-full transition-all border border-gray-500"
                    data-release-id={id}
                    data-release-name={releaseName}
                    data-artist-name={artistName}
                    data-artwork-url={coverArtUrl}
                    data-price={digitalPrice}
                    data-genre={genre}
                    data-label={copyrightHolder}
                    title="Add to wishlist"
                  >
                    <svg class="w-5 h-5 wishlist-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                    </svg>
                  </button>
                </div>
                {(labelName || copyrightHolder) && <p class="text-lg md:text-xl font-bold text-gray-300 truncate" title={labelName || copyrightHolder}>{(labelName || copyrightHolder).length > 40 ? (labelName || copyrightHolder).substring(0, 37) + '...' : (labelName || copyrightHolder)}</p>}
              </div>

              <div class="grid grid-cols-2 gap-2 md:gap-3">
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs md:text-sm text-gray-300 uppercase font-black mb-1">Release Date</p>
                  <p class="text-sm md:text-base text-white font-bold">{formattedDate}</p>
                </div>
                {genre && (
                  <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                    <p class="text-xs md:text-sm text-gray-300 uppercase font-black mb-1">Genre</p>
                    <p class="text-sm md:text-base text-white font-bold">{displayGenre}</p>
                  </div>
                )}
                {(catalogNumber || labelCode) && (
                  <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                    <p class="text-xs md:text-sm text-gray-300 uppercase font-black mb-1">Catalogue</p>
                    <p class="text-sm md:text-base text-white font-bold">{catalogNumber || labelCode}</p>
                  </div>
                )}
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs md:text-sm text-gray-300 uppercase font-black mb-1">Track Count</p>
                  <p class="text-sm md:text-base text-white font-bold">{tracksWithIds.length} {tracksWithIds.length === 1 ? 'Track' : 'Tracks'}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs md:text-sm text-gray-300 uppercase font-black mb-1">Mastered By</p>
                  <p class="text-sm md:text-base text-white font-bold">{masteredBy || '‚Äî'}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs md:text-sm text-gray-300 uppercase font-black mb-1">Recorded</p>
                  <p class="text-sm md:text-base text-white font-bold">{recordingLocation && recordingYear ? `${recordingLocation}, ${recordingYear}` : '‚Äî'}</p>
                </div>
              </div>

              <div class="flex items-center justify-center gap-2 md:gap-3 pt-3 md:pt-4 border-t-2 border-red-600 flex-wrap">
                <div class="flex items-center gap-1 md:gap-2 bg-gradient-to-r from-gray-700 to-gray-600 px-3 md:px-4 py-2 border-2 border-gray-500 h-[40px] md:h-[46px] rounded-lg shadow-lg">
                  <div class="star-rating-group flex items-center gap-0.5" data-release-id={id}>
                    {[1, 2, 3, 4, 5].map((star) => (
                      <button
                        class="rating-star transition-colors cursor-pointer"
                        data-release-id={id}
                        data-star={star}
                        title={`Rate ${star} out of 5`}
                      >
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                      </button>
                    ))}
                  </div>
                  <span class="text-sm md:text-base font-black text-white">
                    <span class="rating-value" data-release-id={id}>{(overallRating?.average || 0).toFixed(1)}</span>
                    <span class="text-gray-400"> ({overallRating?.count || 0})</span>
                  </span>
                </div>

                <button 
                  id="scroll-to-comments"
                  class="flex items-center gap-1 md:gap-2 px-3 md:px-4 py-2 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-red-600 hover:to-red-700 text-white border-2 border-gray-500 hover:border-red-400 transition-all font-black uppercase text-sm md:text-base cursor-pointer rounded-lg shadow-lg"
                  title="Jump to comments"
                >
                  <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                  <span class="hidden sm:inline">Comments</span>
                  <span class="bg-red-600 text-white px-2 py-0.5 rounded-full text-xs md:text-sm font-black">{comments?.length || 0}</span>
                </button>

                <button
                  class="share-button flex items-center gap-1 md:gap-2 px-3 md:px-4 py-2 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-red-600 hover:to-red-700 text-white border-2 border-gray-500 hover:border-red-400 transition-all font-black uppercase text-sm md:text-base rounded-lg shadow-lg"
                  data-release-id={id}
                  data-title={releaseName}
                  data-artist={artistName}
                  data-artwork={coverArtUrl}
                >
                  <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                  </svg>
                  <span class="hidden sm:inline">Share</span>
                </button>

                <button 
                  class={`bio-button flex items-center gap-1 md:gap-2 px-3 md:px-4 py-2 border-2 transition-all font-black uppercase text-sm md:text-base rounded-lg shadow-lg ${hasBio ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-red-600 hover:to-red-700 text-white border-gray-500 hover:border-red-400 cursor-pointer' : 'bg-gray-800 text-gray-500 border-gray-700 cursor-not-allowed opacity-50'}`}
                  data-artist={artistName}
                  data-bio={artistBio || ''}
                  disabled={!hasBio}
                  title={hasBio ? `About ${artistName}` : 'No bio available'}
                >
                  <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  <span class="hidden sm:inline">Bio</span>
                </button>

              </div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-3 md:p-6 mb-4 md:mb-6">
          <div class="flex items-center justify-between mb-3 md:mb-4 pb-3 md:pb-4 border-b-2 border-red-600">
            <h2 class="text-xl md:text-3xl font-black text-white uppercase tracking-wider drop-shadow-lg">Tracklist</h2>
            {actualTrackPrice > 0 && !nyopEnabled && (
              <span class="text-xs md:text-sm font-black text-white">
                {hasSale ? (
                  <><span class="line-through text-gray-400">¬£{actualTrackPrice.toFixed(2)}</span> <span class="text-green-400">¬£{saleTrackPrice.toFixed(2)}</span> per track</>
                ) : (
                  <>¬£{actualTrackPrice.toFixed(2)} per track</>
                )}
              </span>
            )}
          </div>

          <div class="space-y-2" id="full-track-list">
            {tracksWithIds.map((track) => (
              <div class="track-row px-2 md:px-4 py-3 md:py-4 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 border-2 border-gray-600 hover:border-red-600 transition-all shadow-md">
                <div class="flex items-center gap-2 md:gap-6">
                  <span class="text-base md:text-lg font-black text-red-500 w-6 md:w-8 text-center flex-shrink-0">
                    {track.track_number}
                  </span>
                  
                  <button 
  class="play-button flex-shrink-0 w-8 h-8 md:w-10 md:h-10 flex items-center justify-center bg-gradient-to-br from-red-600 to-red-800 text-white hover:from-red-700 hover:to-red-900 transition-all border-2 border-white shadow-lg rounded-full"
  data-track-id={track.id}
  data-release-id={id}
  data-preview-url={track.preview_url || ''}
  data-track-title={track.title}
  title="Play"
>
  <svg class="w-3 h-3 md:w-4 md:h-4 play-icon ml-0.5" fill="currentColor" viewBox="0 0 24 24">
    <path d="M8 5v14l11-7z"/>
  </svg>
  <svg class="w-3 h-3 md:w-4 md:h-4 pause-icon hidden" fill="currentColor" viewBox="0 0 24 24">
    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
  </svg>
</button>
                  
                  <div class="flex-1 min-w-0">
                    <p class="text-base md:text-xl font-black text-white truncate uppercase drop-shadow-md">
                      {track.title}
                      {track.remixer && (
                        <span class="text-sm md:text-lg font-bold text-gray-400"> ({track.remixer} Remix)</span>
                      )}
                      {track.artist && <span class="text-gray-400 font-bold"> - {track.artist}</span>}
                      {track.featured && (
                        <span class="text-xs md:text-base font-bold text-gray-300"> ft. {track.featured.replace(/^(ft\.?|feat\.?)\s*/i, '')}</span>
                      )}
                    </p>
                  </div>

                  <div class="hidden lg:block">
                    <canvas 
                      class="track-waveform cursor-pointer bg-gray-900 border-2 border-gray-600 rounded shadow-inner"
                      width="150"
                      height="40"
                      data-track-id={track.id}
                      data-release-id={id}
                    ></canvas>
                  </div>

                  <div class="hidden lg:flex items-center gap-8 text-sm text-gray-400 font-bold ml-8">
                    <div class="text-center">
                      <p class="text-gray-500 uppercase mb-1">Duration</p>
                      <span class="text-white font-black">{track.duration && track.duration !== '0' && track.duration !== '0:00' ? track.duration : '--'}</span>
                    </div>
                    <div class="text-center">
                      <p class="text-gray-500 uppercase mb-1">Key</p>
                      <span class="text-white font-black">{track.key}</span>
                    </div>
                    <div class="text-center">
                      <p class="text-gray-500 uppercase mb-1">BPM</p>
                      <span class="text-white font-black">{track.bpm && track.bpm !== '' && track.bpm !== '0' ? track.bpm : '--'}</span>
                    </div>
                  </div>
                  
                  {actualTrackPrice > 0 && !nyopEnabled && (
                    <button
                      class="buy-track flex-shrink-0 font-black text-white bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 active:from-green-800 active:to-green-900 transition-all px-4 md:px-8 py-2.5 border-2 border-white shadow-lg uppercase text-sm md:text-base"
                      data-track-id={track.id}
                      data-track-title={track.title}
                      data-track-price={actualTrackPrice}
                      data-release-id={id}
                      data-artist={artistName}
                      data-artist-id={artistId}
                      data-artwork={coverArtUrl}
                      title="Buy this track"
                    >
                      Buy
                    </button>
                  )}
                </div>

                
              </div>
            ))}
          </div>
        </div>

        <!-- Release Info Box -->
        {socialLinks.length > 0 && (
          <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-4 md:p-6 mb-4 md:mb-6">
            <h2 class="text-xl md:text-2xl font-black text-white uppercase tracking-wider mb-3 md:mb-4 pb-3 md:pb-4 border-b-2 border-red-600 flex items-center gap-2 drop-shadow-lg">
              <span>üîó</span> Connect
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              {socialLinks.map((link) => (
                <a 
                  href={link.url} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="flex items-center gap-2 md:gap-3 p-3 md:p-4 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-red-600 hover:to-red-700 border-2 border-gray-600 hover:border-white transition-all group shadow-md"
                >
                  <span class="text-2xl md:text-3xl">{link.icon}</span>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm md:text-base font-black text-gray-400 group-hover:text-white uppercase transition-colors">{link.platform}</p>
                    <p class="text-sm md:text-base text-white font-semibold truncate transition-colors">{link.url}</p>
                  </div>
                  <svg class="w-5 h-5 md:w-6 md:h-6 text-gray-400 group-hover:text-white transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                  </svg>
                </a>
              ))}
            </div>
          </div>
        )}

        {descriptionHtml && (
          <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-4 md:p-6 mb-4 md:mb-6">
            <h2 class="text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-3 md:mb-4 pb-3 md:pb-4 border-b-2 border-red-600 drop-shadow-lg">
              About This Release
            </h2>
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-4 md:p-5 rounded shadow-inner">
              <p class="text-white text-sm md:text-base font-semibold leading-relaxed whitespace-pre-wrap" set:html={descriptionHtml} />
            </div>
          </div>
        )}

       <div id="comments-section" class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-2 sm:p-3 md:p-6 mb-3 sm:mb-4 md:mb-6">
          <h2 class="text-base sm:text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-2 sm:mb-3 md:mb-4 pb-2 sm:pb-3 md:pb-4 border-b-2 border-red-600 flex items-center gap-2 drop-shadow-lg">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Comments (<span id="comments-total-count">{comments?.length || 0}</span>)
          </h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 md:gap-6">
            <!-- Comment Input -->
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded flex flex-col shadow-lg order-2 lg:order-1" style="height: 440px;">
              <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase mb-3 flex-shrink-0 drop-shadow-md">Leave a Comment</h3>
              <div class="flex flex-col flex-1 pb-2">
                <input 
                  type="text" 
                  id="comment-username" 
                  placeholder="Login to comment" 
                  maxlength="30"
                  readonly
                  class="w-full px-3 py-2 border-2 border-gray-600 bg-gray-800 text-white placeholder-gray-400 focus:outline-none rounded cursor-not-allowed text-sm md:text-base shadow-inner mb-3 flex-shrink-0"
                />
                
                <!-- Emoji Grid -->
                <div class="mb-3 flex-shrink-0">
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-xs font-black text-gray-300 uppercase tracking-wide">Quick Emojis:</p>
                    <button type="button" id="gif-picker-btn" class="flex items-center gap-1 px-3 py-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-xs font-bold uppercase rounded transition-all">
                      <span>GIF</span>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                    </button>
                  </div>
                  <div class="grid grid-cols-8 gap-1">
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üî•" title="Fire">üî•</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="‚ù§Ô∏è" title="Heart">‚ù§Ô∏è</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üòç" title="Love">üòç</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéµ" title="Music">üéµ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéß" title="Headphones">üéß</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üíØ" title="100">üíØ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üëç" title="Thumbs up">üëç</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üôå" title="Hands up">üôå</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üí•" title="Boom">üí•</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="‚ö°" title="Lightning">‚ö°</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéâ" title="Party">üéâ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üöÄ" title="Rocket">üöÄ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üîä" title="Speaker">üîä</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üíø" title="CD">üíø</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üé∏" title="Guitar">üé∏</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéπ" title="Piano">üéπ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="ü•Å" title="Drums">ü•Å</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üé§" title="Mic">üé§</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üëè" title="Clap">üëè</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üí™" title="Strong">üí™</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="‚ú®" title="Sparkles">‚ú®</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üåü" title="Star">üåü</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üòé" title="Cool">üòé</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="ü§©" title="Star eyes">ü§©</button>
                  </div>
                </div>
                
                <!-- GIF Preview -->
                <div id="gif-preview-container" class="hidden mb-3 relative">
                  <img id="gif-preview" src="" alt="Selected GIF" class="max-h-24 rounded border-2 border-blue-500">
                  <button type="button" id="remove-gif-btn" class="absolute -top-2 -right-2 w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-sm font-bold hover:bg-red-700">√ó</button>
                </div>
                
                <textarea 
                  id="comment-text" 
                  placeholder="Write your comment... (login required, max 150 characters)" 
                  maxlength="150"
                  rows="3"
                  class="w-full px-3 py-2 border-2 border-gray-600 bg-gray-900 text-white text-sm md:text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-600 resize-none rounded flex-1 shadow-inner"
                ></textarea>
                
                <div class="flex items-center justify-between mt-3 flex-shrink-0">
                  <span class="text-xs md:text-sm text-gray-400 font-medium">
                    <span id="char-count">0</span>/150
                  </span>
                  <button 
                    id="submit-comment-btn" 
                    class="px-4 md:px-6 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 border-2 border-white shadow-lg transition-all font-black uppercase rounded transform hover:scale-105 active:scale-95 text-xs md:text-sm"
                  >
                    Post Comment
                  </button>
                </div>
              </div>
            </div>

            <!-- Comments Output -->
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded flex flex-col shadow-lg order-1 lg:order-2" style="height: 440px;">
              <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase mb-3 flex-shrink-0 drop-shadow-md">Recent Comments</h3>
              <div id="comments-list" class="space-y-2 pr-2 flex-1 overflow-y-auto">
                {sortedComments && sortedComments.length > 0 ? (
                  sortedComments.map((comment) => (
                    <div class="comment-item p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md relative">
                      <span class="absolute top-2 right-3 text-xs text-gray-400">{new Date(comment.timestamp || comment.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                      <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg overflow-hidden">
                          {comment.avatarUrl ? (
                            <img src={comment.avatarUrl} alt="" class="w-full h-full object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='block';" />
                            <span class="text-white font-bold text-base" style="display:none;">
                              {(comment.userName || comment.username || 'A').charAt(0).toUpperCase()}
                            </span>
                          ) : (
                            <span class="text-white font-bold text-base">
                              {(comment.userName || comment.username || 'A').charAt(0).toUpperCase()}
                            </span>
                          )}
                        </div>
                        <div class="flex-1 min-w-0 pt-1">
                          <span class="text-white text-sm uppercase block mb-1">{comment.userName || comment.username || 'Anonymous'}</span>
                          {(comment.comment || comment.text) && <p class="text-gray-100 text-base md:text-lg leading-relaxed break-words">{comment.comment || comment.text}</p>}
                          {comment.gifUrl && <img src={comment.gifUrl} alt="GIF" class="mt-2 max-h-48 rounded border border-gray-500" loading="lazy" />}
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <p class="text-center text-gray-400 py-8 text-sm md:text-base">No comments yet. Be the first!</p>
                )}
              </div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-4 md:p-6">
          <h2 class="text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-4 md:mb-6 pb-3 md:pb-4 border-b-2 border-red-600 drop-shadow-lg">You Might Also Like</h2>
          <div class="relative">
            <div id="suggestions-carousel" class="flex gap-3 md:gap-4 overflow-x-auto pb-4 snap-x snap-mandatory scroll-smooth" style="scrollbar-width: thin;"></div>
            <button id="carousel-prev" class="hidden md:block absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-gradient-to-br from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white p-3 border-2 border-white shadow-xl transition-all z-10 rounded-full">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <button id="carousel-next" class="hidden md:block absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-gradient-to-br from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white p-3 border-2 border-white shadow-xl transition-all z-10 rounded-full">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
        </div>

      </div>
    </main>
  )}

  <!-- Giphy Picker Modal -->
  <div id="giphy-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-80 transition-opacity" id="giphy-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-3 sm:p-4">
      <div class="bg-gray-900 max-w-lg w-full transform transition-all border-2 border-blue-500 rounded-lg mx-2 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between p-3 sm:p-4 border-b-2 border-blue-500 bg-gradient-to-r from-blue-600 to-indigo-600">
          <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Search GIFs
          </h3>
          <button id="giphy-modal-close" class="text-white hover:text-gray-200 transition-colors p-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-4">
          <input 
            type="text" 
            id="giphy-search-input" 
            placeholder="Search for GIFs..." 
            class="w-full px-4 py-3 border-2 border-gray-600 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div id="giphy-results" class="flex-1 overflow-y-auto p-4 pt-0 grid grid-cols-2 sm:grid-cols-3 gap-2" style="min-height: 200px; max-height: 400px;">
          <p class="col-span-full text-center text-gray-400 py-8">Search for GIFs above</p>
        </div>
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<div id="share-modal" class="fixed inset-0 z-[100] hidden">
  <div class="fixed inset-0 bg-black/90 backdrop-blur-sm transition-opacity" id="share-modal-backdrop"></div>
  <div class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 overflow-y-auto">
    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 max-w-lg w-full transform transition-all border-2 border-red-600/50 rounded-2xl mx-2 my-4 shadow-2xl shadow-red-600/20">
      <!-- Header with close button -->
      <div class="flex items-center justify-between p-4 border-b border-white/10">
        <h3 class="text-lg font-black text-white uppercase tracking-wider flex items-center gap-2">
          <span class="text-red-500">Share</span> This Release
        </h3>
        <button id="share-modal-close" class="text-gray-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Release Preview Card -->
      <div class="p-4">
        <div class="flex gap-4 p-3 bg-white/5 rounded-xl border border-white/10 mb-5">
          <img id="share-modal-artwork" src="/place-holder.webp" alt="Release artwork" class="w-20 h-20 sm:w-24 sm:h-24 rounded-lg object-cover border-2 border-white/20 shadow-lg" />
          <div class="flex-1 min-w-0">
            <div class="text-base sm:text-lg font-bold text-white break-words line-clamp-2" id="share-modal-title"></div>
            <div class="text-sm text-gray-400 mt-1">by <span class="font-semibold text-red-500" id="share-modal-artist"></span></div>
            <div class="flex items-center gap-2 mt-2">
              <span class="px-2 py-0.5 bg-red-600/20 text-red-500 text-xs font-bold rounded-full border border-red-600/30">RELEASE</span>
              <span class="text-xs text-gray-500">freshwax.co.uk</span>
            </div>
          </div>
        </div>

        <!-- Social Share Buttons -->
        <div class="mb-5">
          <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 font-bold">Share on Social</p>
          <div class="grid grid-cols-5 gap-2">
            <!-- X/Twitter -->
            <button id="share-twitter" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#000000] rounded-xl border border-white/10 hover:border-white/30 transition-all">
              <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">X</span>
            </button>
            <!-- Facebook -->
            <button id="share-facebook" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#1877F2] rounded-xl border border-white/10 hover:border-[#1877F2] transition-all">
              <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">Facebook</span>
            </button>
            <!-- WhatsApp -->
            <button id="share-whatsapp" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#25D366] rounded-xl border border-white/10 hover:border-[#25D366] transition-all">
              <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">WhatsApp</span>
            </button>
            <!-- Instagram -->
            <button id="share-instagram" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-gradient-to-br hover:from-[#833AB4] hover:via-[#E1306C] hover:to-[#F77737] rounded-xl border border-white/10 hover:border-[#E1306C] transition-all">
              <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
              <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">Instagram</span>
            </button>
            <!-- Reddit -->
            <button id="share-reddit" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#FF4500] rounded-xl border border-white/10 hover:border-[#FF4500] transition-all">
              <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
              </svg>
              <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">Reddit</span>
            </button>
          </div>
        </div>

        <!-- Copy Link Section -->
        <div class="mb-5">
          <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 font-bold">Copy Link</p>
          <div class="flex gap-2">
            <input
              type="text"
              id="share-url-input"
              readonly
              class="flex-1 px-4 py-3 bg-white/5 border border-white/20 text-sm font-mono text-white rounded-xl focus:outline-none focus:border-red-500 min-w-0"
            />
            <button
              id="copy-url-button"
              class="px-4 py-3 bg-red-600 hover:bg-red-500 text-white transition-all font-bold text-sm flex items-center gap-2 uppercase rounded-xl flex-shrink-0"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <span id="copy-btn-text">Copy</span>
            </button>
          </div>
          <p class="text-xs text-green-400 font-bold mt-2 hidden" id="copy-feedback">Link copied to clipboard!</p>
        </div>

        <!-- Native Share (Mobile) -->
        <button
          id="native-share-btn"
          class="hidden w-full py-3 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white transition-all font-black text-sm uppercase rounded-xl items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          Share via Device
        </button>
      </div>

      <!-- Footer -->
      <div class="px-4 py-3 border-t border-white/10 bg-white/5 rounded-b-2xl">
        <p class="text-center text-xs text-gray-500">
          Share the <span class="text-red-500 font-bold">music</span> - Support independent artists
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Bio Modal -->
<div id="bio-modal" class="fixed inset-0 z-50 hidden">
  <div class="fixed inset-0 bg-black bg-opacity-80 transition-opacity" id="bio-modal-backdrop"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white max-w-md w-full transform transition-all border-4 border-black rounded-lg">
      <div class="flex items-center justify-between p-4 border-b-4 border-black">
        <h3 class="text-base md:text-lg font-black text-black uppercase">About <span id="bio-modal-artist"></span></h3>
        <button id="bio-modal-close" class="text-black hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="p-4">
        <p class="text-sm text-gray-700 leading-relaxed" id="bio-modal-content"></p>
      </div>
    </div>
  </div>
</div>

<style>
  /* NYOP (Name Your Own Price) Styles */
  .nyop-container-item {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .nyop-price-input-item {
    -moz-appearance: textfield;
  }

  .nyop-price-input-item::-webkit-outer-spin-button,
  .nyop-price-input-item::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .nyop-price-input-item:focus {
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
  }

  .nyop-buy-btn-item:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Sale Badge */
  .sale-badge-item {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: #fff;
    font-size: 0.875rem;
    font-weight: 900;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);
    border: 2px solid #fff;
    animation: pulse-sale 2s ease-in-out infinite;
    z-index: 10;
  }

  @keyframes pulse-sale {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .rating-star {
    color: #6b7280;
    transition: all 0.2s;
    cursor: pointer;
  }

  .rating-star:hover {
    color: #fbbf24;
    transform: scale(1.15);
  }

  /* Fill stars on hover - all stars up to and including hovered one */
  .star-rating-group:hover .rating-star {
    color: #fbbf24;
  }
  .star-rating-group:hover .rating-star:hover ~ .rating-star {
    color: #6b7280;
  }

  .rating-star svg[fill="currentColor"] {
    color: #fbbf24;
  }

  .rating-star:active {
    transform: scale(0.95);
  }

  /* When user has rated (filled stars), keep them gold */
  .rating-star.user-rated svg {
    fill: currentColor;
    color: #fbbf24;
  }
  
  /* Follow Artist Button */
  .follow-artist-btn {
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .follow-artist-btn:hover {
    transform: scale(1.05);
  }
  
  .follow-artist-btn.following {
    background: #dc2626 !important;
    border-color: #dc2626 !important;
  }
  
  .follow-artist-btn.following .follow-icon {
    display: none;
  }
  
  .follow-artist-btn.following .follow-text::before {
    content: '‚úì ';
  }

  /* Wishlist Button */
  .wishlist-btn {
    transition: all 0.2s;
  }
  
  .wishlist-btn:hover {
    transform: scale(1.1);
  }
  
  .wishlist-btn.active {
    background: #dc2626 !important;
    border-color: #dc2626 !important;
  }
  
  .wishlist-btn.active .wishlist-icon {
    fill: currentColor;
  }

  .emoji-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .emoji-btn:hover {
    background: rgba(220, 38, 38, 0.8);
    transform: scale(1.1);
  }

  .emoji-btn:active {
    transform: scale(0.9);
  }

  .track-waveform {
    transition: all 0.2s;
  }

  .track-waveform:hover {
    transform: scale(1.05);
  }

  #suggestions-carousel::-webkit-scrollbar {
    height: 8px;
  }

  #suggestions-carousel::-webkit-scrollbar-track {
    background: #f3f4f6;
    border: 1px solid #000;
    border-radius: 4px;
  }

  #suggestions-carousel::-webkit-scrollbar-thumb {
    background: #000;
    border: 1px solid #000;
    border-radius: 4px;
  }

  #suggestions-carousel::-webkit-scrollbar-thumb:hover {
    background: #374151;
  }

  .suggestion-card {
    flex-shrink: 0;
    scroll-snap-align: start;
  }

  #comments-list::-webkit-scrollbar {
    width: 6px;
  }

  #comments-list::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 3px;
  }

  #comments-list::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 3px;
  }

  #comments-list::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }

  /* Mobile touch optimization */
  @media (max-width: 1023px) {
    .track-waveform {
      display: none;
    }
  }

  /* Ensure buttons are touch-friendly on mobile */
  @media (max-width: 767px) {
    button, a {
      min-height: 44px;
      min-width: 44px;
    }
  }
</style>

<script is:inline>
  // Ensure global mini player AND shuffle widget are paused when playing local track previews on item page
  (function() {
    function stopAllOtherAudio() {
      // 1. Pause global mini player if it's playing
      try {
        var globalAudio = document.getElementById('global-audio');
        if (globalAudio && !globalAudio.paused) {
          globalAudio.pause();
          
          // Update mini player UI
          var miniPlayIcon = document.getElementById('mini-play-icon');
          var miniPauseIcon = document.getElementById('mini-pause-icon');
          if (miniPlayIcon) miniPlayIcon.classList.remove('hidden');
          if (miniPauseIcon) miniPauseIcon.classList.add('hidden');
        }
      } catch (err) {
      }
      
      // 2. Pause shuffle widget if it's playing
      try {
        if (window.shuffleWidgetAudio && !window.shuffleWidgetAudio.paused) {
          window.shuffleWidgetAudio.pause();
          
          // Update shuffle widget UI
          var shuffleWidget = document.getElementById('shuffle-widget');
          if (shuffleWidget) {
            shuffleWidget.classList.remove('playing');
          }
          
          var shuffleIconPlay = document.getElementById('shuffle-icon-play');
          var shuffleIconPause = document.getElementById('shuffle-icon-pause');
          var shuffleCtrlPlay = document.getElementById('shuffle-ctrl-play-icon');
          var shuffleCtrlPause = document.getElementById('shuffle-ctrl-pause-icon');
          
          if (shuffleIconPlay) shuffleIconPlay.classList.remove('hidden');
          if (shuffleIconPause) shuffleIconPause.classList.add('hidden');
          if (shuffleCtrlPlay) shuffleCtrlPlay.classList.remove('hidden');
          if (shuffleCtrlPause) shuffleCtrlPause.classList.add('hidden');
        }
      } catch (err) {
      }
    }
    
    function initItemPageAudioControl() {
      
      // Get all play buttons on the item page
      var playButtons = document.querySelectorAll('#full-track-list .play-button');
      
      playButtons.forEach(function(button) {
        // Add click handler that runs BEFORE the main handler (capture phase)
        button.addEventListener('click', function(e) {
          stopAllOtherAudio();
        }, true); // Use capture phase to run before other handlers
      });
      
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initItemPageAudioControl);
    } else {
      initItemPageAudioControl();
    }
    
    // Re-initialize after Astro page transitions
    document.addEventListener('astro:page-load', initItemPageAudioControl);
  })();
</script>

<script is:inline define:vars={{ releaseId: id }}>
  // Comments functionality - matching working dj-mix implementation
  // Get fresh DOM references (needed for View Transitions)
  function getCommentElements() {
    return {
      commentUsername: document.getElementById('comment-username'),
      commentText: document.getElementById('comment-text'),
      charCount: document.getElementById('char-count'),
      submitCommentBtn: document.getElementById('submit-comment-btn'),
      commentsList: document.getElementById('comments-list')
    };
  }

  // Check for logged-in user
  let currentUser = null;
  let currentUserName = null;
  let currentUserAvatar = null;
  let cachedUserId = null; // Store cached user ID for use before Firebase Auth initializes

  // Try to restore from localStorage cache first (for instant auth on page reload)
  // This matches the pattern used on live.astro for consistent auth across pages
  function checkAuthCache() {
    try {
      const cached = localStorage.getItem('fw_auth_cache');
      if (cached) {
        const cachedAuth = JSON.parse(cached);
        // Only use cache if less than 24 hours old
        if (cachedAuth.cachedAt && Date.now() - cachedAuth.cachedAt < 86400000 && cachedAuth.loggedIn) {
          console.log('[Comments] Restored auth from cache:', cachedAuth.id);
          // Store cached values for immediate use
          currentUserName = cachedAuth.displayName || cachedAuth.name;
          currentUserAvatar = cachedAuth.avatar || null;
          cachedUserId = cachedAuth.id;
          // Immediately update the username field
          const { commentUsername } = getCommentElements();
          if (commentUsername && currentUserName) {
            commentUsername.value = currentUserName;
            commentUsername.classList.remove('cursor-not-allowed');
            commentUsername.classList.add('cursor-default', 'bg-gray-700');
          }
          return true;
        } else if (cachedAuth.cachedAt && Date.now() - cachedAuth.cachedAt >= 86400000) {
          localStorage.removeItem('fw_auth_cache');
        }
      }
    } catch (e) { /* Ignore cache errors */ }
    return false;
  }

  // Run cache check immediately
  checkAuthCache();

  // Function to update UI based on auth state
  function updateCommentUI(user, userName, avatarUrl) {
    const { commentUsername } = getCommentElements();
    if (user && userName) {
      currentUser = user;
      currentUserName = userName;
      currentUserAvatar = avatarUrl || null;
      cachedUserId = user.uid; // Update cached ID when Firebase Auth confirms
      if (commentUsername) {
        commentUsername.value = userName;
        commentUsername.classList.remove('cursor-not-allowed');
        commentUsername.classList.add('cursor-default', 'bg-gray-700');
      }
    } else {
      currentUser = null;
      currentUserName = null;
      currentUserAvatar = null;
      if (commentUsername) {
        commentUsername.value = '';
        commentUsername.placeholder = 'Login to comment';
        commentUsername.classList.add('cursor-not-allowed');
        commentUsername.classList.remove('cursor-default', 'bg-gray-700');
      }
    }
  }

  // Initialize Firebase Auth listener
  async function initFirebaseAuth() {
    try {
      const firebaseApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
      const firebaseFirestore = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      
      const { initializeApp, getApps } = firebaseApp;
      const { getAuth, onAuthStateChanged } = firebaseAuth;
      const { getFirestore, doc, getDoc } = firebaseFirestore;
      
      // Firebase config
      const firebaseConfig = {
        apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };
      
      // Check if app already initialized
      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // Store auth globally for other scripts
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      
      // Helper to fetch user profile using cached API (reduces 3 reads to 1)
      async function fetchUserProfile(user) {
        try {
          // Check sessionStorage cache first
          const cacheKey = `fw_user_profile_${user.uid}`;
          const cached = sessionStorage.getItem(cacheKey);
          if (cached) {
            try {
              const profile = JSON.parse(cached);
              // Cache valid for 5 minutes
              if (profile.cachedAt && Date.now() - profile.cachedAt < 300000) {
                // Firebase Auth displayName is the public name (same as Header.astro)
                const displayName = user.displayName || profile.partnerDisplayName || user.email?.split('@')[0] || 'User';
                return {
                  name: displayName,
                  avatarUrl: profile.avatarUrl || user.photoURL || null
                };
              }
            } catch (e) { /* ignore parse errors */ }
          }
          
          // Fetch from consolidated API endpoint
          const response = await fetch(`/api/get-user-type?uid=${encodeURIComponent(user.uid)}`);
          if (response.ok) {
            const profile = await response.json();
            if (profile.success) {
              // Cache the result
              profile.cachedAt = Date.now();
              try { sessionStorage.setItem(cacheKey, JSON.stringify(profile)); } catch (e) {}
              // Firebase Auth displayName is the public name (same as Header.astro)
              const displayName = user.displayName || profile.partnerDisplayName || user.email?.split('@')[0] || 'User';
              return {
                name: displayName,
                avatarUrl: profile.avatarUrl || user.photoURL || null
              };
            }
          }
          return { name: user.displayName || user.email?.split('@')[0] || 'User', avatarUrl: user.photoURL || null };
        } catch (err) {
          return { name: user.displayName || user.email?.split('@')[0] || 'User', avatarUrl: user.photoURL || null };
        }
      }
      
      // Listen for auth state changes - this is the reliable method
      onAuthStateChanged(auth, async function(user) {
        if (user) {
          const profile = await fetchUserProfile(user);
          updateCommentUI(user, profile.name, profile.avatarUrl);
        } else {
          updateCommentUI(null, null, null);
        }
      });
      
      // Also check immediately using authReady from Header
      if (window.authReady) {
        const user = await window.authReady;
        if (user && !currentUser) {
          const profile = await fetchUserProfile(user);
          updateCommentUI(user, profile.name, profile.avatarUrl);
        }
      }
      
    } catch (err) {
      console.error('[Comments] Firebase init error:', err);
    }
  }
  
  // Initialize on page load
  initFirebaseAuth();
  setupCommentForm();

  // Re-check auth on Astro page transitions
  document.addEventListener('astro:page-load', function() {
    // Check cache first for instant UI update, then verify with Firebase
    checkAuthCache();
    setupCommentForm();
    initFirebaseAuth();
  });

  // Re-check auth on back/forward navigation (bfcache)
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      checkAuthCache();
      setupCommentForm();
      initFirebaseAuth();
    }
  });

  // Setup comment form event listeners
  let selectedGifUrl = null;

  function setupCommentForm() {
    const { commentUsername, commentText, charCount, submitCommentBtn, commentsList } = getCommentElements();

    // Prevent duplicate listeners
    if (commentText && !commentText._listenersAttached) {
      commentText._listenersAttached = true;

      // Character count
      commentText.addEventListener('input', function() {
        const { charCount } = getCommentElements();
        if (charCount) {
          charCount.textContent = commentText.value.length;
        }
      });
    }

    // Emoji buttons (use event delegation to avoid duplicates)
    document.querySelectorAll('.emoji-btn').forEach(function(btn) {
      if (btn._listenerAttached) return;
      btn._listenerAttached = true;
      btn.addEventListener('click', function() {
        const { commentText, charCount } = getCommentElements();
        const emoji = btn.getAttribute('data-emoji');
        if (commentText && emoji) {
          const start = commentText.selectionStart;
          const end = commentText.selectionEnd;
          const text = commentText.value;
          commentText.value = text.substring(0, start) + emoji + text.substring(end);
          commentText.focus();
          commentText.selectionStart = commentText.selectionEnd = start + emoji.length;
          if (charCount) {
            charCount.textContent = commentText.value.length;
          }
        }
      });
    });

    // Submit comment
    if (submitCommentBtn && !submitCommentBtn._listenerAttached) {
      submitCommentBtn._listenerAttached = true;
      submitCommentBtn.addEventListener('click', handleSubmitComment);
    }
  }

  async function handleSubmitComment() {
    const { commentUsername, commentText, submitCommentBtn } = getCommentElements();

    // Use cachedUserId if currentUser isn't set yet (during View Transition)
    if (!currentUser && !cachedUserId) {
      alert('Please login to post a comment');
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    // Check email verification for new users
    if (window.FreshWax?.checkEmailVerified) {
      const verified = await window.FreshWax.checkEmailVerified('post comments');
      if (!verified) return;
    }

    const userName = currentUserName || commentUsername?.value?.trim();
    const comment = commentText?.value?.trim();
    
    if (!userName) {
      alert('Please login to comment');
      return;
    }
    
    // Allow GIF-only or text-only or both
    if (!comment && !selectedGifUrl) {
      alert('Please enter a comment or select a GIF');
      commentText?.focus();
      return;
    }

    if (submitCommentBtn) {
      submitCommentBtn.disabled = true;
      submitCommentBtn.textContent = 'Posting...';
    }

    // Use currentUser.uid if available, fallback to cachedUserId for View Transitions
    const userId = currentUser ? currentUser.uid : cachedUserId;

    // Get auth token for API
    const token = currentUser ? await currentUser.getIdToken() : null;

    fetch('/api/add-comment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      body: JSON.stringify({
        releaseId: releaseId,
        userName: userName,
        comment: comment || '',
        gifUrl: selectedGifUrl,
        userId: userId,
        avatarUrl: currentUserAvatar || null
      })
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      if (data.success) {
        // Build new comment HTML - escape any special characters
        const safeUserName = userName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const safeComment = comment ? comment.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
        const initial = safeUserName.charAt(0).toUpperCase();
        
        let commentContent = '';
        if (safeComment) {
          commentContent += '<p class="text-gray-100 text-base md:text-lg leading-relaxed break-words">' + safeComment + '</p>';
        }
        if (selectedGifUrl) {
          commentContent += '<img src="' + selectedGifUrl + '" alt="GIF" class="mt-2 max-h-48 rounded border border-gray-500" loading="lazy" />';
        }
        
        // Avatar HTML - use image if available, fallback to initial
        let avatarHtml;
        if (currentUserAvatar) {
          avatarHtml = '<img src="' + currentUserAvatar + '" alt="" class="w-full h-full object-cover" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';" /><span class="text-white font-bold text-base hidden items-center justify-center w-full h-full">' + initial + '</span>';
        } else {
          avatarHtml = '<span class="text-white font-bold text-base">' + initial + '</span>';
        }
        
        const newCommentHtml = '<div class="comment-item p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md relative"><span class="absolute top-2 right-3 text-xs text-gray-400">Just now</span><div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg overflow-hidden">' + avatarHtml + '</div><div class="flex-1 min-w-0 pt-1"><span class="text-white text-sm uppercase block mb-1">' + safeUserName + '</span>' + commentContent + '</div></div></div>';
        
        // Get fresh reference to comments container
        const commentsContainer = document.getElementById('comments-list');
        
        if (commentsContainer) {
          // Remove "no comments" message if present
          const noCommentsMsg = commentsContainer.querySelector('.text-center');
          if (noCommentsMsg) {
            noCommentsMsg.remove();
          }
          
          // Insert new comment at the top
          commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
        } else {
          console.error('[Comments] Comments container not found!');
        }
        
        // Clear input and GIF - get fresh references
        const { commentText: ct, charCount: cc } = getCommentElements();
        if (ct) {
          ct.value = '';
          if (cc) cc.textContent = '0';
        }

        // Clear selected GIF
        selectedGifUrl = null;
        const gifPreviewContainer = document.getElementById('gif-preview-container');
        if (gifPreviewContainer) gifPreviewContainer.classList.add('hidden');

      } else {
        console.error('[Comments] API error:', data.error);
        alert(data.error || 'Failed to post comment');
      }
    }).catch(function(error) {
      console.error('[Comments] Fetch error:', error);
      alert('Failed to post comment. Please try again.');
    }).finally(function() {
      const { submitCommentBtn: btn } = getCommentElements();
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Post Comment';
      }
    });
  }

  // ============================================
  // GIPHY PICKER FUNCTIONALITY
  // ============================================
  const GIPHY_API_KEY = 'p0USqLUVxus8d82HAcPhQ2GqG6SfraYr';
  const giphyModal = document.getElementById('giphy-modal');
  const giphyModalClose = document.getElementById('giphy-modal-close');
  const giphyModalBackdrop = document.getElementById('giphy-modal-backdrop');
  const giphySearchInput = document.getElementById('giphy-search-input');
  const giphyResults = document.getElementById('giphy-results');
  const gifPickerBtn = document.getElementById('gif-picker-btn');
  const gifPreviewContainer = document.getElementById('gif-preview-container');
  const gifPreview = document.getElementById('gif-preview');
  const removeGifBtn = document.getElementById('remove-gif-btn');
  
  let giphySearchTimeout;
  
  // Open Giphy modal
  gifPickerBtn?.addEventListener('click', function() {
    if (!currentUser && !cachedUserId) {
      alert('Please login to add GIFs');
      return;
    }
    giphyModal?.classList.remove('hidden');
    giphySearchInput?.focus();
    // Load trending GIFs initially
    loadTrendingGifs();
  });
  
  // Close Giphy modal
  function closeGiphyModal() {
    giphyModal?.classList.add('hidden');
    if (giphySearchInput) giphySearchInput.value = '';
  }
  
  giphyModalClose?.addEventListener('click', closeGiphyModal);
  giphyModalBackdrop?.addEventListener('click', closeGiphyModal);
  
  // Load trending GIFs
  async function loadTrendingGifs() {
    if (!giphyResults) return;
    giphyResults.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">Loading...</p>';
    
    try {
      const response = await fetch('https://api.giphy.com/v1/gifs/trending?api_key=' + GIPHY_API_KEY + '&limit=18&rating=pg-13');
      const data = await response.json();
      renderGiphyResults(data.data);
    } catch (err) {
      giphyResults.innerHTML = '<p class="col-span-full text-center text-red-400 py-4">Failed to load GIFs</p>';
    }
  }
  
  // Search GIFs
  giphySearchInput?.addEventListener('input', function() {
    clearTimeout(giphySearchTimeout);
    const query = giphySearchInput.value.trim();
    
    if (!query) {
      loadTrendingGifs();
      return;
    }
    
    giphySearchTimeout = setTimeout(async function() {
      if (!giphyResults) return;
      giphyResults.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">Searching...</p>';
      
      try {
        const response = await fetch('https://api.giphy.com/v1/gifs/search?api_key=' + GIPHY_API_KEY + '&q=' + encodeURIComponent(query) + '&limit=18&rating=pg-13');
        const data = await response.json();
        
        if (data.data.length === 0) {
          giphyResults.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">No GIFs found for "' + query + '"</p>';
        } else {
          renderGiphyResults(data.data);
        }
      } catch (err) {
        giphyResults.innerHTML = '<p class="col-span-full text-center text-red-400 py-4">Search failed</p>';
      }
    }, 300);
  });
  
  // Render GIF results
  function renderGiphyResults(gifs) {
    if (!giphyResults) return;
    
    giphyResults.innerHTML = gifs.map(function(gif) {
      const previewUrl = gif.images.fixed_height_small.url;
      const fullUrl = gif.images.fixed_height.url;
      return '<div class="gif-item cursor-pointer rounded overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all" data-gif-url="' + fullUrl + '">' +
        '<img src="' + previewUrl + '" alt="' + (gif.title || 'GIF') + '" class="w-full h-24 object-cover" loading="lazy" />' +
        '</div>';
    }).join('');
    
    // Add click handlers
    giphyResults.querySelectorAll('.gif-item').forEach(function(item) {
      item.addEventListener('click', function() {
        const gifUrl = item.getAttribute('data-gif-url');
        selectGif(gifUrl);
      });
    });
  }
  
  // Select a GIF - immediately post it
  async function selectGif(url) {
    if (!currentUser) {
      alert('Please login to post GIFs');
      closeGiphyModal();
      return;
    }

    const { commentUsername, submitCommentBtn } = getCommentElements();
    const userName = currentUserName || commentUsername?.value?.trim();
    if (!userName) {
      alert('Please login to post GIFs');
      closeGiphyModal();
      return;
    }

    closeGiphyModal();

    // Show posting indicator
    if (submitCommentBtn) {
      submitCommentBtn.disabled = true;
      submitCommentBtn.textContent = 'Posting GIF...';
    }
    
    // Immediately post the GIF
    const token = await currentUser.getIdToken();

    fetch('/api/add-comment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        releaseId: releaseId,
        userName: userName,
        comment: '',
        gifUrl: url,
        userId: currentUser.uid,
        avatarUrl: currentUserAvatar || null
      })
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      if (data.success) {
        const safeUserName = userName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const initial = safeUserName.charAt(0).toUpperCase();
        
        // Avatar HTML - use image if available, fallback to initial
        let avatarHtml;
        if (currentUserAvatar) {
          avatarHtml = '<img src="' + currentUserAvatar + '" alt="" class="w-full h-full object-cover" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';" /><span class="text-white font-bold text-base hidden items-center justify-center w-full h-full">' + initial + '</span>';
        } else {
          avatarHtml = '<span class="text-white font-bold text-base">' + initial + '</span>';
        }
        
        const newCommentHtml = '<div class="comment-item p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md relative"><span class="absolute top-2 right-3 text-xs text-gray-400">Just now</span><div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg overflow-hidden">' + avatarHtml + '</div><div class="flex-1 min-w-0 pt-1"><span class="text-white text-sm uppercase block mb-1">' + safeUserName + '</span><img src="' + url + '" alt="GIF" class="mt-2 max-h-48 rounded border border-gray-500" loading="lazy" /></div></div></div>';
        
        const commentsContainer = document.getElementById('comments-list');
        if (commentsContainer) {
          const noCommentsMsg = commentsContainer.querySelector('.text-center');
          if (noCommentsMsg) noCommentsMsg.remove();
          commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
        }
      } else {
        alert(data.error || 'Failed to post GIF');
      }
    }).catch(function(error) {
      console.error('[Comments] GIF post error:', error);
      alert('Failed to post GIF. Please try again.');
    }).finally(function() {
      const { submitCommentBtn: btn } = getCommentElements();
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Post Comment';
      }
    });
  }
  
  // Remove selected GIF (no longer needed but keep for safety)
  removeGifBtn?.addEventListener('click', function() {
    selectedGifUrl = null;
    gifPreviewContainer?.classList.add('hidden');
    if (gifPreview) gifPreview.src = '';
  });
</script>

<script is:inline>
  // Follow Artist Button Functionality
  function initFollowButton() {
    const followBtn = document.getElementById('followArtistBtn');
    if (!followBtn) return;
    
    // Prevent double initialization
    if (followBtn.dataset.initialized === 'true') return;
    followBtn.dataset.initialized = 'true';
    
    const artistName = followBtn.dataset.artistName;
    const artistId = followBtn.dataset.artistId;
    const followText = followBtn.querySelector('.follow-text');
    
    // Get current user
    function getCurrentUserId() {
      if (window.firebaseAuth && window.firebaseAuth.currentUser) {
        return window.firebaseAuth.currentUser.uid;
      }
      return null;
    }
    
    // Check initial follow status
    async function checkFollowStatus() {
      const user = window.firebaseAuth?.currentUser;
      if (!user) return;

      try {
        const token = await user.getIdToken();
        const response = await fetch('/api/follow-artist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            userId: user.uid,
            artistName: artistName,
            artistId: artistId,
            action: 'check'
          })
        });

        const data = await response.json();
        if (data.success && data.isFollowing) {
          followBtn.classList.add('following');
          followText.textContent = 'Following';
        }
      } catch (err) {
        // Silent fail
      }
    }
    
    // Handle click
    followBtn.addEventListener('click', async function(e) {
      e.preventDefault();

      const user = window.firebaseAuth?.currentUser;
      if (!user) {
        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        return;
      }

      const isFollowing = followBtn.classList.contains('following');

      // Optimistic UI
      if (isFollowing) {
        followBtn.classList.remove('following');
        followText.textContent = 'Follow';
      } else {
        followBtn.classList.add('following');
        followText.textContent = 'Following';
      }

      try {
        const token = await user.getIdToken();
        const response = await fetch('/api/follow-artist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            userId: user.uid,
            artistName: artistName,
            artistId: artistId,
            action: 'toggle'
          })
        });

        const data = await response.json();

        if (data.success) {
          if (data.isFollowing) {
            followBtn.classList.add('following');
            followText.textContent = 'Following';
          } else {
            followBtn.classList.remove('following');
            followText.textContent = 'Follow';
          }
        } else {
          // Revert on failure
          if (isFollowing) {
            followBtn.classList.add('following');
            followText.textContent = 'Following';
          } else {
            followBtn.classList.remove('following');
            followText.textContent = 'Follow';
          }
        }
      } catch (err) {
        // Revert on error
        if (isFollowing) {
          followBtn.classList.add('following');
          followText.textContent = 'Following';
        } else {
          followBtn.classList.remove('following');
          followText.textContent = 'Follow';
        }
      }
    });
    
    // Check status when auth is ready
    function initFollowCheck() {
      if (window.firebaseAuth) {
        checkFollowStatus();
      } else {
        const interval = setInterval(function() {
          if (window.firebaseAuth) {
            clearInterval(interval);
            checkFollowStatus();
          }
        }, 500);
        setTimeout(function() { clearInterval(interval); }, 10000);
      }
    }
    
    // Run on load
    initFollowCheck();
  }
  
  // Initialize on DOM ready and Astro page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFollowButton);
  } else {
    initFollowButton();
  }
  document.addEventListener('astro:page-load', initFollowButton);

  // Wishlist Button Functionality
  function initWishlistButton() {
    const wishlistBtn = document.getElementById('wishlistBtn');
    if (!wishlistBtn) return;
    
    // Prevent double initialization
    if (wishlistBtn.dataset.initialized === 'true') return;
    wishlistBtn.dataset.initialized = 'true';
    
    const releaseId = wishlistBtn.dataset.releaseId;
    const releaseName = wishlistBtn.dataset.releaseName;
    const artistName = wishlistBtn.dataset.artistName;
    const artworkUrl = wishlistBtn.dataset.artworkUrl;
    const price = wishlistBtn.dataset.price;
    const genre = wishlistBtn.dataset.genre;
    const label = wishlistBtn.dataset.label;
    
    // Get current user
    function getCurrentUserId() {
      if (window.firebaseAuth && window.firebaseAuth.currentUser) {
        return window.firebaseAuth.currentUser.uid;
      }
      return null;
    }
    
    // Show toast notification
    function showToast(message, type) {
      const existing = document.querySelector('.wishlist-toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'wishlist-toast';
      toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: ' + (type === 'success' ? '#22c55e' : '#dc2626') + '; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 3000);
    }
    
    // Check initial wishlist status
    async function checkWishlistStatus() {
      const user = window.firebaseAuth?.currentUser;
      if (!user) return;

      try {
        const token = await user.getIdToken();
        const response = await fetch('/api/wishlist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            userId: user.uid,
            releaseId: releaseId,
            action: 'check'
          })
        });

        const data = await response.json();
        if (data.success && data.inWishlist) {
          wishlistBtn.classList.add('active');
          wishlistBtn.title = 'Remove from wishlist';
        }
      } catch (err) {
        // Silent fail
      }
    }
    
    // Handle click
    wishlistBtn.addEventListener('click', async function(e) {
      e.preventDefault();

      const user = window.firebaseAuth?.currentUser;
      if (!user) {
        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        return;
      }

      const isInWishlist = wishlistBtn.classList.contains('active');

      // Optimistic UI
      if (isInWishlist) {
        wishlistBtn.classList.remove('active');
        wishlistBtn.title = 'Add to wishlist';
      } else {
        wishlistBtn.classList.add('active');
        wishlistBtn.title = 'Remove from wishlist';
      }

      try {
        const token = await user.getIdToken();
        const response = await fetch('/api/wishlist', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            userId: user.uid,
            releaseId: releaseId,
            releaseName: releaseName,
            artistName: artistName,
            artworkUrl: artworkUrl,
            price: price,
            genre: genre,
            label: label,
            action: 'toggle'
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.inWishlist) {
            wishlistBtn.classList.add('active');
            wishlistBtn.title = 'Remove from wishlist';
            showToast('Added to wishlist', 'success');
          } else {
            wishlistBtn.classList.remove('active');
            wishlistBtn.title = 'Add to wishlist';
            showToast('Removed from wishlist', 'success');
          }
        } else {
          // Revert on failure
          if (isInWishlist) {
            wishlistBtn.classList.add('active');
            wishlistBtn.title = 'Remove from wishlist';
          } else {
            wishlistBtn.classList.remove('active');
            wishlistBtn.title = 'Add to wishlist';
          }
          showToast('Failed to update wishlist', 'error');
        }
      } catch (err) {
        // Revert on error
        if (isInWishlist) {
          wishlistBtn.classList.add('active');
          wishlistBtn.title = 'Remove from wishlist';
        } else {
          wishlistBtn.classList.remove('active');
          wishlistBtn.title = 'Add to wishlist';
        }
        showToast('Failed to update wishlist', 'error');
      }
    });
    
    // Check status when auth is ready
    function initWishlistCheck() {
      // Wait for both firebaseAuth and currentUser to be ready
      if (window.firebaseAuth?.currentUser) {
        checkWishlistStatus();
      } else if (window.firebaseAuth) {
        // Auth exists but user not loaded yet - use onAuthStateChanged
        window.firebaseAuth.onAuthStateChanged(function(user) {
          if (user) {
            checkWishlistStatus();
          }
        });
      } else {
        // Wait for firebaseAuth to be available
        const interval = setInterval(function() {
          if (window.firebaseAuth?.currentUser) {
            clearInterval(interval);
            checkWishlistStatus();
          } else if (window.firebaseAuth) {
            clearInterval(interval);
            window.firebaseAuth.onAuthStateChanged(function(user) {
              if (user) {
                checkWishlistStatus();
              }
            });
          }
        }, 500);
        setTimeout(function() { clearInterval(interval); }, 10000);
      }
    }

    // Run on load
    initWishlistCheck();
  }
  
  // Initialize wishlist button on DOM ready and Astro page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWishlistButton);
  } else {
    initWishlistButton();
  }
  document.addEventListener('astro:page-load', initWishlistButton);
</script>

<!-- NYOP Price Selection Modal -->
<div id="nyop-modal-item" class="nyop-modal-item hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="nyop-modal-backdrop-item absolute inset-0 bg-black/80" data-close-modal></div>
  <div class="nyop-modal-content-item relative bg-gray-900 rounded-xl p-6 max-w-sm w-full border border-gray-700 shadow-2xl">
    <button type="button" class="nyop-modal-close-item absolute top-3 right-3 text-gray-400 hover:text-white transition-colors" data-close-modal>
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <div class="text-center mb-6">
      <img id="nyop-modal-artwork-item" src="/place-holder.webp" alt="" class="w-24 h-24 mx-auto rounded-lg mb-3 object-cover" />
      <h3 id="nyop-modal-title-item" class="text-lg font-bold text-white"></h3>
      <p id="nyop-modal-artist-item" class="text-sm text-gray-400"></p>
    </div>

    <div class="mb-6">
      <label class="block text-sm text-gray-300 uppercase tracking-wide font-bold mb-3 text-center">Name Your Price</label>

      <!-- Quick price buttons -->
      <div class="grid grid-cols-4 gap-2 mb-4">
        <button type="button" class="nyop-quick-price-item py-2 px-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold text-sm transition-colors" data-price="0">Free</button>
        <button type="button" class="nyop-quick-price-item py-2 px-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold text-sm transition-colors" data-price="3">¬£3</button>
        <button type="button" class="nyop-quick-price-item py-2 px-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold text-sm transition-colors" data-price="5">¬£5</button>
        <button type="button" class="nyop-quick-price-item py-2 px-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold text-sm transition-colors" data-price="10">¬£10</button>
      </div>

      <!-- Custom price input -->
      <div class="flex items-center gap-3 justify-center">
        <span class="text-white font-bold text-xl">¬£</span>
        <input
          type="text"
          inputmode="decimal"
          id="nyop-modal-price-item"
          class="w-28 bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white text-2xl font-bold text-center focus:outline-none focus:border-red-500 transition-colors"
          value="5.00"
          placeholder="0.00"
        />
      </div>

      <p id="nyop-modal-min-text-item" class="text-xs text-gray-400 text-center mt-2">Pay what you want (including ¬£0)</p>
      <p id="nyop-modal-error-item" class="text-sm text-red-400 text-center mt-2 hidden"></p>
    </div>

    <button
      type="button"
      id="nyop-modal-add-cart-item"
      class="w-full py-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold text-lg transition-colors flex items-center justify-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <span>Add to Cart</span>
    </button>
  </div>
</div>

<style>
  .nyop-modal-item.hidden { display: none; }
  .nyop-modal-content-item { animation: nyop-modal-appear-item 0.2s ease-out; }
  @keyframes nyop-modal-appear-item {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  .nyop-quick-price-item.active { background-color: #dc2626; }
  #nyop-modal-price-item { -moz-appearance: textfield; }
  #nyop-modal-price-item::-webkit-outer-spin-button,
  #nyop-modal-price-item::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  #nyop-modal-price-item:focus { box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3); }
</style>

<!-- NYOP (Name Your Own Price) Script -->
<script is:inline>
  function initNYOPItem() {
    const modal = document.getElementById('nyop-modal-item');
    if (!modal) return;

    const modalArtwork = document.getElementById('nyop-modal-artwork-item');
    const modalTitle = document.getElementById('nyop-modal-title-item');
    const modalArtist = document.getElementById('nyop-modal-artist-item');
    const modalPrice = document.getElementById('nyop-modal-price-item');
    const modalMinText = document.getElementById('nyop-modal-min-text-item');
    const modalError = document.getElementById('nyop-modal-error-item');
    const modalAddCart = document.getElementById('nyop-modal-add-cart-item');
    const quickPrices = modal.querySelectorAll('.nyop-quick-price-item');

    let currentReleaseData = null;

    // Open modal when Buy Digital button clicked
    document.querySelectorAll('.nyop-open-modal').forEach(function(btn) {
      if (btn.dataset.nyopModalInit === 'true') return;
      btn.dataset.nyopModalInit = 'true';

      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const minPrice = parseFloat(btn.dataset.nyopMin) || 0;
        const suggestedPrice = parseFloat(btn.dataset.nyopSuggested) || minPrice || 5;

        currentReleaseData = {
          releaseId: btn.dataset.releaseId,
          title: btn.dataset.title,
          artist: btn.dataset.artist,
          artistId: btn.dataset.artistId,
          labelName: btn.dataset.labelName,
          artwork: btn.dataset.artwork,
          minPrice: minPrice,
          suggestedPrice: suggestedPrice,
          isPreorder: btn.dataset.isPreorder === 'true'
        };

        // Populate modal
        modalArtwork.src = currentReleaseData.artwork || '/place-holder.webp';
        modalTitle.textContent = currentReleaseData.title;
        modalArtist.textContent = currentReleaseData.artist;
        modalPrice.value = suggestedPrice.toFixed(2);
        modalMinText.textContent = minPrice > 0
          ? '¬£' + minPrice.toFixed(2) + ' minimum'
          : 'Pay what you want (including ¬£0)';
        modalError.classList.add('hidden');

        updateQuickPriceButtons(suggestedPrice);
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });
    });

    // Close modal
    modal.querySelectorAll('[data-close-modal]').forEach(function(el) {
      el.addEventListener('click', closeModal);
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      currentReleaseData = null;
    }

    // Quick price buttons
    quickPrices.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const price = parseFloat(btn.dataset.price) || 0;
        modalPrice.value = price.toFixed(2);
        updateQuickPriceButtons(price);
        validatePrice();
      });
    });

    function updateQuickPriceButtons(selectedPrice) {
      quickPrices.forEach(function(btn) {
        const btnPrice = parseFloat(btn.dataset.price) || 0;
        btn.classList.toggle('active', btnPrice === selectedPrice);
      });
    }

    modalPrice.addEventListener('input', function() {
      validatePrice();
      quickPrices.forEach(function(btn) { btn.classList.remove('active'); });
    });

    modalPrice.addEventListener('blur', function() {
      const value = parseFloat(modalPrice.value) || 0;
      const minPrice = currentReleaseData?.minPrice || 0;
      modalPrice.value = Math.max(minPrice, value).toFixed(2);
      validatePrice();
    });

    function validatePrice() {
      if (!currentReleaseData) return true;
      const value = parseFloat(modalPrice.value) || 0;
      const minPrice = currentReleaseData.minPrice || 0;

      if (value < minPrice) {
        modalError.textContent = 'Minimum price is ¬£' + minPrice.toFixed(2);
        modalError.classList.remove('hidden');
        modalAddCart.disabled = true;
        modalAddCart.classList.add('opacity-50', 'cursor-not-allowed');
        return false;
      } else {
        modalError.classList.add('hidden');
        modalAddCart.disabled = false;
        modalAddCart.classList.remove('opacity-50', 'cursor-not-allowed');
        return true;
      }
    }

    // Add to cart
    modalAddCart.addEventListener('click', function() {
      if (!currentReleaseData || !validatePrice()) return;

      const price = parseFloat(modalPrice.value) || 0;

      // Trigger cart system via temporary button
      const tempBtn = document.createElement('button');
      tempBtn.className = 'add-to-cart hidden';
      tempBtn.dataset.releaseId = currentReleaseData.releaseId;
      tempBtn.dataset.productType = 'digital';
      tempBtn.dataset.price = price.toFixed(2);
      tempBtn.dataset.title = currentReleaseData.title;
      tempBtn.dataset.artist = currentReleaseData.artist;
      tempBtn.dataset.artistId = currentReleaseData.artistId || '';
      tempBtn.dataset.labelName = currentReleaseData.labelName || '';
      tempBtn.dataset.artwork = currentReleaseData.artwork;
      tempBtn.dataset.isPreorder = currentReleaseData.isPreorder ? 'true' : 'false';
      document.body.appendChild(tempBtn);
      tempBtn.click();
      setTimeout(function() { tempBtn.remove(); }, 100);

      closeModal();
    });
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNYOPItem);
  } else {
    initNYOPItem();
  }
  document.addEventListener('astro:page-load', initNYOPItem);
</script>

<!-- OPTIMIZED: Pass SSR data to client to avoid duplicate API calls -->
<script define:vars={{ 
  ssrRatings: { 
    average: overallRating?.average || 0, 
    count: overallRating?.count || 0 
  },
  ssrComments: sortedComments || [],
  ssrReleaseId: id
}}>
  // Make SSR data available to item-page.js
  window.__SSR_RELEASE_DATA__ = {
    releaseId: ssrReleaseId,
    ratings: ssrRatings,
    comments: ssrComments,
    dataLoadedAt: Date.now()
  };
</script>

<script is:inline src="/email-verify-check.js"></script>
<script type="module" src="/item-page.js?v=20260123d"></script>