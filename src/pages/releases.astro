---
// src/pages/releases.astro
// OPTIMIZED: Uses D1 first with Firebase REST API fallback
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ReleasePlate from '../components/ReleasePlate.astro';
import FloatingShuffleButton from '../components/FloatingShuffleButton.astro';
import { getLiveReleases } from '../lib/firebase-rest';

// Get D1 binding from Cloudflare runtime
const db = (Astro.locals as any).runtime?.env?.DB;

// Fetch all live releases - D1 first, Firebase fallback
const allReleases = await getLiveReleases(undefined, db);

// Group releases by label locally
const releasesByLabel: Record<string, any[]> = {};
for (const release of allReleases) {
  const label = release.labelName || release.recordLabel || release.copyrightHolder || 'Unknown Label';
  if (!releasesByLabel[label]) {
    releasesByLabel[label] = [];
  }
  releasesByLabel[label].push(release);
}

// Sort each label's releases by date
for (const label of Object.keys(releasesByLabel)) {
  releasesByLabel[label].sort((a, b) => {
    const dateA = new Date(a.releaseDate || 0).getTime();
    const dateB = new Date(b.releaseDate || 0).getTime();
    return dateB - dateA;
  });
}

// Sort labels alphabetically
const sortedLabels = Object.keys(releasesByLabel).sort((a, b) => {
  if (a === 'Unknown Label') return 1;
  if (b === 'Unknown Label') return -1;
  return a.localeCompare(b);
});

const totalReleases = Object.values(releasesByLabel).reduce((sum, releases) => sum + releases.length, 0);
---

<Layout title="All Releases">
  <Header />
  
  <div class="flex min-h-screen" style="background: #000000;">
    
    <!-- Left Sidebar Navigation -->
    <aside class="w-80 bg-gradient-to-b from-gray-800 to-gray-900 border-r-2 border-white sticky top-[73px] h-[calc(100vh-73px)] overflow-y-auto flex-shrink-0 hidden lg:block shadow-2xl">
      <div class="p-6">
        <!-- Header -->
        <div class="mb-6 pt-6 pb-6 border-t-2 border-b-2 border-red-600">
          <div class="text-2xl font-black text-white mb-2 tracking-tight uppercase drop-shadow-lg font-heading">
            Labels
          </div>
          <p class="text-sm text-gray-300">
            {sortedLabels.length} label{sortedLabels.length !== 1 ? 's' : ''} â€¢ {totalReleases} release{totalReleases !== 1 ? 's' : ''}
          </p>
        </div>
        
        <!-- Labels Navigation -->
        <nav class="space-y-1">
          {sortedLabels.map((label) => (
            <a 
              href={`#label-${label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
              class="label-nav-link flex items-center justify-between p-3 rounded-lg hover:bg-white/10 transition-all group border-2 border-transparent hover:border-white"
              data-label-id={`label-${label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
            >
              <div class="flex-1 min-w-0">
                <div class="text-sm font-bold text-white truncate group-hover:text-white transition-colors">
                  {label}
                </div>
                <div class="text-xs text-gray-300 mt-0.5">
                  {releasesByLabel[label].length} release{releasesByLabel[label].length !== 1 ? 's' : ''}
                </div>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-white transition-colors flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          ))}
        </nav>
      </div>
    </aside>

    <!-- Main Content Area - FIXED WIDTH -->
    <main class="flex-1 min-w-0 px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
      <div class="max-w-6xl mx-auto w-full">
        <!-- Page Header -->
        <header class="mb-12">
          <div class="section-header-card">
            <div class="section-header-pattern"></div>
            <div class="section-header-content">
              <h1 class="section-title">
                All Releases
              </h1>
              <p class="section-subtitle">
                Explore the library organised by label â€¢ {totalReleases} total releases
              </p>
            </div>
          </div>
        </header>

        {totalReleases === 0 ? (
          <div class="text-center py-20 bg-gradient-to-b from-gray-800 to-gray-900 rounded-2xl shadow-lg border-2 border-white">
            <div class="text-6xl mb-4">ðŸŽµ</div>
            <h3 class="text-2xl font-bold text-white mb-2">No Releases Yet</h3>
            <p class="text-gray-300 mb-6">New releases coming soon!</p>
          </div>
        ) : (
          <div class="space-y-16">
            {sortedLabels.map((label) => (
              <section 
                id={`label-${label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
                class="label-section scroll-mt-24"
              >
                <!-- Label Header -->
                <div class="mb-6">
                  <div class="flex flex-wrap items-center gap-4">
                    <div class="inline-flex items-center bg-black border-l-4 border-red-600 pl-4 pr-6 py-3 shadow-lg">
                      <div>
                        <h2 class="text-2xl sm:text-3xl font-black text-white tracking-tight uppercase drop-shadow-md font-heading">
                          {label}
                        </h2>
                        <p class="text-sm text-gray-400 mt-0.5">
                          {releasesByLabel[label].length} release{releasesByLabel[label].length !== 1 ? 's' : ''}
                        </p>
                      </div>
                    </div>

                    {/* Buy All Discography Button */}
                    {releasesByLabel[label].length > 1 && (
                      <button
                        class="buy-discography-btn flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white font-bold rounded-lg shadow-lg transition-all text-sm"
                        data-label={label}
                        data-releases={JSON.stringify(releasesByLabel[label].map(r => ({
                          id: r.id,
                          title: r.releaseName || 'Untitled',
                          artist: r.artistName || 'Unknown Artist',
                          price: r.pricing?.digital || r.pricePerSale || 0,
                          artwork: r.coverArtUrl || '/place-holder.webp'
                        })))}
                        data-total-price={releasesByLabel[label].reduce((sum, r) => sum + (r.pricing?.digital || r.pricePerSale || 0), 0).toFixed(2)}
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span>Buy All ({releasesByLabel[label].length}) - Â£{releasesByLabel[label].reduce((sum, r) => sum + (r.pricing?.digital || r.pricePerSale || 0), 0).toFixed(2)}</span>
                      </button>
                    )}
                  </div>
                </div>

                <!-- Releases Grid -->
                <div class="space-y-6 w-full">
                  {releasesByLabel[label].map((release) => (
                    <div 
                      id={release.id} 
                      class="release-item scroll-mt-24 w-full"
                    >
                      <ReleasePlate {...release} />
                    </div>
                  ))}
                </div>
              </section>
            ))}
          </div>
        )}
      </div>
    </main>
  </div>

  <FloatingShuffleButton />
  <Footer />

  <script>
    // Smooth scroll behavior for label links
    document.querySelectorAll('.label-nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          // Immediately highlight clicked link
          document.querySelectorAll('.label-nav-link').forEach(l => {
            l.classList.remove('bg-gradient-to-r', 'from-orange-700', 'to-orange-800', 'border-white', 'shadow-lg');
          });
          link.classList.add('bg-gradient-to-r', 'from-orange-700', 'to-orange-800', 'border-white', 'shadow-lg');

          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Highlight active label in sidebar as user scrolls
    const observerOptions = {
      root: null,
      rootMargin: '-10% 0px -85% 0px',
      threshold: 0.1
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.label-nav-link').forEach(link => {
            link.classList.remove('bg-gradient-to-r', 'from-orange-700', 'to-orange-800', 'border-white', 'shadow-lg');
          });
          
          const activeLink = document.querySelector(`[data-label-id="${entry.target.id}"]`);
          if (activeLink) {
            activeLink.classList.add('bg-gradient-to-r', 'from-orange-700', 'to-orange-800', 'border-white', 'shadow-lg');
            
            activeLink.scrollIntoView({ 
              behavior: 'smooth',
              block: 'nearest'
            });
          }
        }
      });
    }, observerOptions);

    document.querySelectorAll('.label-section').forEach(section => {
      observer.observe(section);
    });

    // Buy All Discography functionality
    function getCustomerId() {
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'customerId' && value) {
          return value;
        }
      }
      return null;
    }

    function getCart() {
      const customerId = getCustomerId();
      if (!customerId) return { items: [] };

      try {
        const stored = localStorage.getItem('freshwax_cart_' + customerId);
        if (stored) {
          const data = JSON.parse(stored);
          return data.items ? data : { items: data };
        }
      } catch (e) {}

      return { items: [] };
    }

    function saveCart(items) {
      const customerId = getCustomerId();
      if (!customerId) return;

      const cartData = {
        items: items,
        updatedAt: new Date().toISOString()
      };
      localStorage.setItem('freshwax_cart_' + customerId, JSON.stringify(cartData));
      window.dispatchEvent(new CustomEvent('cart-updated', { detail: cartData }));
      window.dispatchEvent(new CustomEvent('cartUpdated', { detail: cartData }));

      if (window.FreshWaxCart) {
        window.FreshWaxCart.updateBadge();
      }
    }

    function showToast(message) {
      const existing = document.getElementById('discography-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'discography-toast';
      toast.textContent = message;
      toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:16px 28px;border-radius:12px;font-size:15px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.4);';
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    document.querySelectorAll('.buy-discography-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();

        const customerId = getCustomerId();
        if (!customerId) {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }

        const label = btn.getAttribute('data-label');
        const releasesData = JSON.parse(btn.getAttribute('data-releases') || '[]');
        const totalPrice = parseFloat(btn.getAttribute('data-total-price') || '0');

        if (releasesData.length === 0) {
          alert('No releases found for this label');
          return;
        }

        // Confirm purchase
        const confirmed = confirm(`Add all ${releasesData.length} releases from "${label}" to your cart?\n\nTotal: Â£${totalPrice.toFixed(2)}\n\nThis includes:\n${releasesData.slice(0, 5).map(r => 'â€¢ ' + r.artist + ' - ' + r.title).join('\n')}${releasesData.length > 5 ? '\n... and ' + (releasesData.length - 5) + ' more' : ''}`);

        if (!confirmed) return;

        // Disable button during operation
        btn.disabled = true;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Adding...</span>';

        const cart = getCart();
        let items = cart.items || [];
        let addedCount = 0;
        let skippedCount = 0;

        for (const release of releasesData) {
          // Check if already in cart
          const existingIndex = items.findIndex(item =>
            item.id === release.id && (item.type === 'digital' || item.type === 'vinyl')
          );

          if (existingIndex !== -1) {
            skippedCount++;
            continue;
          }

          // Remove any single tracks from this release
          items = items.filter(item => !(item.id === release.id && item.type === 'track'));

          // Add the digital release
          items.push({
            id: release.id,
            releaseId: release.id,
            type: 'digital',
            format: 'digital',
            name: release.artist + ' - ' + release.title,
            title: release.title,
            artist: release.artist,
            price: release.price,
            image: release.artwork,
            artwork: release.artwork,
            quantity: 1,
            fromDiscography: true,
            label: label
          });

          addedCount++;
        }

        saveCart(items);

        // Show success state
        btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>Added!</span>';
        btn.classList.remove('from-green-600', 'to-green-700');
        btn.classList.add('from-green-500', 'to-green-600');

        let message = `Added ${addedCount} release${addedCount !== 1 ? 's' : ''} from ${label} to cart!`;
        if (skippedCount > 0) {
          message += ` (${skippedCount} already in cart)`;
        }
        showToast(message);

        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          btn.classList.remove('from-green-500', 'to-green-600');
          btn.classList.add('from-green-600', 'to-green-700');
        }, 2000);
      });
    });
  </script>

  <style>
    /* Fonts loaded in Layout.astro */

    aside::-webkit-scrollbar {
      width: 6px;
    }
    
    aside::-webkit-scrollbar-track {
      background: rgba(31, 41, 55, 0.5);
    }
    
    aside::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #dc2626, #991b1b);
      border-radius: 3px;
    }
    
    aside::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, #991b1b, #7f1d1d);
    }

    html {
      scroll-behavior: smooth;
    }

    .scroll-mt-24 {
      scroll-margin-top: 6rem;
    }

    .release-item {
      animation: fadeInUp 0.6s ease-out backwards;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #dc2626;
    }

    .release-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .release-item:nth-child(1) { animation-delay: 0.05s; }
    .release-item:nth-child(2) { animation-delay: 0.1s; }
    .release-item:nth-child(3) { animation-delay: 0.15s; }
    .release-item:nth-child(4) { animation-delay: 0.2s; }
    .release-item:nth-child(5) { animation-delay: 0.25s; }

    .label-nav-link {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .label-nav-link:active {
      transform: scale(0.98);
    }

    @media (max-width: 640px) {
      .label-nav-link {
        padding: 0.5rem;
      }
    }

    @media (max-width: 1024px) {
      aside {
        display: none;
      }
    }

    /* Buy All Discography Button */
    .buy-discography-btn {
      transition: all 0.3s ease;
    }

    .buy-discography-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4);
    }

    .buy-discography-btn:active {
      transform: translateY(0);
    }

    .buy-discography-btn:disabled {
      opacity: 0.7;
      cursor: wait;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    @media (max-width: 640px) {
      .buy-discography-btn {
        width: 100%;
        justify-content: center;
        padding: 0.875rem 1rem;
      }
    }
  </style>
</Layout>