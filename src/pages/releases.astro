---
// src/pages/releases.astro
// OPTIMIZED: Uses server-side grouping to minimize API calls
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ReleasePlate from '../components/ReleasePlate.astro';
import FloatingShuffleButton from '../components/FloatingShuffleButton.astro';
import { getReleasesGroupedByLabel } from '../lib/releases';

// OPTIMIZED: Get releases already grouped by label from Firebase
const releasesByLabel = await getReleasesGroupedByLabel();

// Sort labels alphabetically
const sortedLabels = Object.keys(releasesByLabel).sort((a, b) => {
  if (a === 'Unknown Label') return 1;
  if (b === 'Unknown Label') return -1;
  return a.localeCompare(b);
});

const totalReleases = Object.values(releasesByLabel).reduce((sum, releases) => sum + releases.length, 0);
---

<Layout title="Fresh Wax - All Releases">
  <Header />
  
  <div class="flex min-h-screen" style="background: #000000;">
    
    <!-- Left Sidebar Navigation -->
    <aside class="w-80 bg-gradient-to-b from-gray-800 to-gray-900 border-r-2 border-white sticky top-[73px] h-[calc(100vh-73px)] overflow-y-auto flex-shrink-0 hidden lg:block shadow-2xl">
      <div class="p-6">
        <!-- Header -->
        <div class="mb-6 pt-6 pb-6 border-t-2 border-b-2 border-red-600">
          <div class="text-2xl font-black text-white mb-2 tracking-tight uppercase drop-shadow-lg font-heading">
            Labels
          </div>
          <p class="text-sm text-gray-300">
            {sortedLabels.length} label{sortedLabels.length !== 1 ? 's' : ''} â€¢ {totalReleases} release{totalReleases !== 1 ? 's' : ''}
          </p>
        </div>
        
        <!-- Labels Navigation -->
        <nav class="space-y-1">
          {sortedLabels.map((label) => (
            <a 
              href={`#label-${label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
              class="label-nav-link flex items-center justify-between p-3 rounded-lg hover:bg-white/10 transition-all group border-2 border-transparent hover:border-white"
              data-label-id={`label-${label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
            >
              <div class="flex-1 min-w-0">
                <div class="text-sm font-bold text-white truncate group-hover:text-white transition-colors">
                  {label}
                </div>
                <div class="text-xs text-gray-400 mt-0.5">
                  {releasesByLabel[label].length} release{releasesByLabel[label].length !== 1 ? 's' : ''}
                </div>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-white transition-colors flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          ))}
        </nav>
      </div>
    </aside>

    <!-- Main Content Area - FIXED WIDTH -->
    <main class="flex-1 min-w-0 px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
      <div class="max-w-6xl mx-auto w-full">
        <!-- Page Header -->
        <header class="mb-12">
          <div class="section-header-card">
            <div class="section-header-pattern"></div>
            <div class="section-header-content">
              <h1 class="section-title">
                All Releases
              </h1>
              <p class="section-subtitle">
                Explore the library organised by label â€¢ {totalReleases} total releases
              </p>
            </div>
          </div>
        </header>

        {totalReleases === 0 ? (
          <div class="text-center py-20 bg-gradient-to-b from-gray-800 to-gray-900 rounded-2xl shadow-lg border-2 border-white">
            <div class="text-6xl mb-4">ðŸŽµ</div>
            <h3 class="text-2xl font-bold text-white mb-2">No Releases Yet</h3>
            <p class="text-gray-300 mb-6">New releases coming soon!</p>
          </div>
        ) : (
          <div class="space-y-16">
            {sortedLabels.map((label) => (
              <section 
                id={`label-${label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
                class="label-section scroll-mt-24"
              >
                <!-- Label Header -->
                <div class="mb-6">
                  <div class="inline-flex items-center bg-black border-l-4 border-red-600 pl-4 pr-6 py-3 shadow-lg">
                    <div>
                      <h2 class="text-2xl sm:text-3xl font-black text-white tracking-tight uppercase drop-shadow-md font-heading">
                        {label}
                      </h2>
                      <p class="text-sm text-gray-400 mt-0.5">
                        {releasesByLabel[label].length} release{releasesByLabel[label].length !== 1 ? 's' : ''}
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Releases Grid -->
                <div class="space-y-6 w-full">
                  {releasesByLabel[label].map((release) => (
                    <div 
                      id={release.id} 
                      class="release-item scroll-mt-24 w-full"
                    >
                      <ReleasePlate {...release} />
                    </div>
                  ))}
                </div>
              </section>
            ))}
          </div>
        )}
      </div>
    </main>
  </div>

  <FloatingShuffleButton />
  <Footer />

  <script>
    // Smooth scroll behavior for label links
    document.querySelectorAll('.label-nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          targetElement.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Highlight active label in sidebar as user scrolls
    const observerOptions = {
      root: null,
      rootMargin: '-10% 0px -85% 0px',
      threshold: 0.1
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.label-nav-link').forEach(link => {
            link.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-red-700', 'border-white', 'shadow-lg');
          });
          
          const activeLink = document.querySelector(`[data-label-id="${entry.target.id}"]`);
          if (activeLink) {
            activeLink.classList.add('bg-gradient-to-r', 'from-red-600', 'to-red-700', 'border-white', 'shadow-lg');
            
            activeLink.scrollIntoView({ 
              behavior: 'smooth',
              block: 'nearest'
            });
          }
        }
      });
    }, observerOptions);

    document.querySelectorAll('.label-section').forEach(section => {
      observer.observe(section);
    });
  </script>

  <style>
    /* Fonts loaded in Layout.astro */

    aside::-webkit-scrollbar {
      width: 6px;
    }
    
    aside::-webkit-scrollbar-track {
      background: rgba(31, 41, 55, 0.5);
    }
    
    aside::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #dc2626, #991b1b);
      border-radius: 3px;
    }
    
    aside::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, #991b1b, #7f1d1d);
    }

    html {
      scroll-behavior: smooth;
    }

    .scroll-mt-24 {
      scroll-margin-top: 6rem;
    }

    .release-item {
      animation: fadeInUp 0.6s ease-out backwards;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .release-item:nth-child(1) { animation-delay: 0.05s; }
    .release-item:nth-child(2) { animation-delay: 0.1s; }
    .release-item:nth-child(3) { animation-delay: 0.15s; }
    .release-item:nth-child(4) { animation-delay: 0.2s; }
    .release-item:nth-child(5) { animation-delay: 0.25s; }

    .label-nav-link {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .label-nav-link:active {
      transform: scale(0.98);
    }

    @media (max-width: 640px) {
      .label-nav-link {
        padding: 0.5rem;
      }
    }

    @media (max-width: 1024px) {
      aside {
        display: none;
      }
    }
  </style>
</Layout>