---
// src/pages/dj-mix/[id].astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const { id } = Astro.params;


let mix = null;
let error = null;
let comments = [];

try {
  // Add nocache timestamp to ensure fresh data (plays/likes/comments update frequently)
  const apiUrl = `${Astro.url.origin}/api/get-dj-mix?id=${id}&nocache=${Date.now()}`;
  
  const response = await fetch(apiUrl);
  const data = await response.json();
  
  if (data.success && data.mix) {
    mix = data.mix;
  } else {
    error = data.error || 'Mix not found';
  }
} catch (err) {
  console.error('[DJ MIX PAGE] ‚úó Fetch error:', err);
  error = 'Failed to load mix';
}

// Comments are already in the mix document - sort by date (most recent first)
if (mix && mix.comments) {
  comments = mix.comments.sort((a, b) => {
    const dateA = new Date(a.timestamp || a.createdAt || 0);
    const dateB = new Date(b.timestamp || b.createdAt || 0);
    return dateB.getTime() - dateA.getTime();
  });
}

const {
  title = 'Untitled Mix',
  dj_name = 'Unknown DJ',
  genre = 'Jungle & Drum and Bass',
  artwork_url = '/place-holder.webp',
  audio_url = '',
  upload_date = new Date().toISOString(),
  description = '',
  plays = 0,
  downloads = 0,
  likes = 0,
  commentCount = 0,
  tracklistArray = [],
  tracklist: tracklistRaw = '',
  userId: mixUserId = '',
  djName: mixDjName = ''
} = mix || {};

// Get duration from various possible field names (in order of preference)
function getDurationSeconds(mix: any): number | null {
  // Check durationSeconds first (should be a number)
  if (mix?.durationSeconds && typeof mix.durationSeconds === 'number') {
    return mix.durationSeconds;
  }
  // Check if it's stored as a string number
  if (mix?.durationSeconds && !isNaN(parseFloat(mix.durationSeconds))) {
    return parseFloat(mix.durationSeconds);
  }
  // Check duration_seconds
  if (mix?.duration_seconds && typeof mix.duration_seconds === 'number') {
    return mix.duration_seconds;
  }
  // Check mixDuration
  if (mix?.mixDuration && typeof mix.mixDuration === 'number') {
    return mix.mixDuration;
  }
  // Check duration if it's a number
  if (mix?.duration && typeof mix.duration === 'number') {
    return mix.duration;
  }
  // Check duration if it's a time string format like "1:23:45" or "23:45"
  if (mix?.duration && typeof mix.duration === 'string' && mix.duration.includes(':')) {
    const parts = mix.duration.split(':').map(Number);
    if (parts.length === 3) {
      return parts[0] * 3600 + parts[1] * 60 + parts[2];
    } else if (parts.length === 2) {
      return parts[0] * 60 + parts[1];
    }
  }
  return null;
}

const durationSeconds = getDurationSeconds(mix);

// Format duration helper
function formatDurationDisplay(seconds: number | null) {
  if (!seconds || !isFinite(seconds)) return null;
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);

  if (hrs > 0) {
    const hourWord = hrs === 1 ? 'hour' : 'hours';
    const minWord = mins === 1 ? 'minute' : 'minutes';
    if (mins > 0) {
      return `${hrs} ${hourWord} ${mins} ${minWord}`;
    }
    return `${hrs} ${hourWord}`;
  }
  if (mins > 0) {
    const minWord = mins === 1 ? 'minute' : 'minutes';
    if (secs > 0 && mins < 5) {
      // Show seconds only for short durations under 5 minutes
      const secWord = secs === 1 ? 'second' : 'seconds';
      return `${mins} ${minWord} ${secs} ${secWord}`;
    }
    return `${mins} ${minWord}`;
  }
  // Under 1 minute - show seconds
  const secWord = secs === 1 ? 'second' : 'seconds';
  return `${secs} ${secWord}`;
}

const formattedDuration = formatDurationDisplay(durationSeconds);

// Helper to clean track - removes leading numbers like "1." or "01." or "1)" etc
function cleanTrackLine(line: string): string {
  // Remove leading track numbers in formats like: "1.", "01.", "1)", "1:", "1 -", etc.
  return line.replace(/^\d+[\.\)\:\-]?\s*[-‚Äì‚Äî]?\s*/, '').trim();
}

// Use tracklistArray if available, otherwise parse the raw string
const tracklist = Array.isArray(tracklistArray) && tracklistArray.length > 0 
  ? tracklistArray.map(t => cleanTrackLine(t))
  : (typeof tracklistRaw === 'string' && tracklistRaw.trim() 
      ? tracklistRaw.split('\n').map(line => cleanTrackLine(line.trim())).filter(line => line.length > 0)
      : []);

const formattedDate = mix ? new Date(upload_date).toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
}) : '';
---

<Layout
  title={mix ? `${title} - ${dj_name}` : 'Mix Not Found'}
  description={mix ? `${title} by ${dj_name}${genre ? ` - ${genre}` : ''}${formattedDuration ? ` (${formattedDuration})` : ''}. Listen now on Fresh Wax.` : 'Mix not found'}
  image={artwork_url !== '/place-holder.webp' ? artwork_url : undefined}
  type="music.album"
  audio={mix ? {
    duration: durationSeconds ? `PT${Math.floor(durationSeconds / 3600)}H${Math.floor((durationSeconds % 3600) / 60)}M${Math.floor(durationSeconds % 60)}S` : 'PT1H',
    artist: dj_name,
    uploadDate: upload_date,
    thumbnailUrl: artwork_url !== '/place-holder.webp' ? artwork_url : undefined,
    genre: genre ? [genre] : undefined
  } : undefined}
>
  <Header />
  
  {!mix ? (
    <main style="min-height: 100vh; background: #000000; padding: 2rem 0;">
      <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white border-2 border-black p-8 text-center">
          <h1 class="text-3xl font-black text-black mb-4 uppercase">Mix Not Found</h1>
          <p class="text-lg font-bold text-black mb-2">ID: {id}</p>
          <p class="text-gray-700 mb-6 font-semibold">{error || 'This mix could not be loaded.'}</p>
          <a href="/dj-mixes" class="inline-block bg-black text-white px-6 py-3 font-black hover:bg-gray-800 transition-colors uppercase border-2 border-black">
            ‚Üê Back to DJ Mixes
          </a>
        </div>
      </div>
    </main>
  ) : (
    <main style="min-height: 100vh; background: #000000; padding: 1rem 0;">
      <div class="max-w-7xl mx-auto px-2 sm:px-3 md:px-4">
        
        <a href="/dj-mixes" class="inline-flex items-center gap-1 sm:gap-2 text-white hover:text-gray-300 font-black mb-3 sm:mb-4 md:mb-6 transition-colors uppercase text-xs border-2 border-white px-2 sm:px-3 md:px-4 py-1.5 sm:py-2">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          <span class="hidden sm:inline">Back to DJ Mixes</span>
          <span class="sm:hidden">Back</span>
        </a>

        <!-- Main Info Section -->
        <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white p-3 sm:p-4 md:p-8 mb-3 sm:mb-4 md:mb-6 shadow-xl overflow-hidden">
          <div class="flex flex-col lg:flex-row gap-4 sm:gap-6 md:gap-8">
            
            <!-- Info Column - Now First on Desktop -->
            <div class="lg:flex-1 space-y-3 sm:space-y-4 md:space-y-6 order-1 lg:order-1 min-w-0">
              <div class="text-center lg:text-left overflow-hidden">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-black text-red-500 mb-2 md:mb-3 leading-tight uppercase drop-shadow-lg" title={title}>{title}</h1>
                <p class="text-xl md:text-2xl font-black text-white mb-1 md:mb-2 uppercase drop-shadow-md truncate" title={dj_name}>{dj_name}</p>
              </div>

              <!-- Info Grid -->
              <div class="grid grid-cols-2 gap-1.5 sm:gap-2 md:gap-3">
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs sm:text-sm text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Upload Date</p>
                  <p class="text-xs sm:text-sm md:text-base text-white font-bold truncate">{formattedDate}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs sm:text-sm text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Genre</p>
                  <p class="text-xs sm:text-sm md:text-base text-white font-bold truncate">{genre}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs sm:text-sm text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Duration</p>
                  <p id="mix-duration-display" data-duration-seconds={durationSeconds} class="text-xs sm:text-sm md:text-base text-white font-bold">{formattedDuration || '--:--'}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-xs sm:text-sm text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Format</p>
                  <p class="text-xs sm:text-sm md:text-base text-white font-bold">DJ Mix</p>
                </div>
              </div>

              <!-- Stats & Actions -->
              <div class="grid grid-cols-3 gap-1.5 sm:gap-2 pt-2 sm:pt-3 md:pt-4 border-t-2 border-red-600">
                <!-- Plays - Icon, Text, Number -->
                <div class="flex items-center justify-center gap-1 bg-gradient-to-r from-gray-700 to-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 border-2 border-gray-500 rounded-lg shadow-lg">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <span class="text-xs sm:text-sm md:text-base font-black text-white truncate">
                    <span class="hidden sm:inline">Plays</span><span class="hidden sm:inline mx-1.5"></span><span class="text-white">[</span><span class="mx-0.5"></span><span id="plays-count" class="text-green-500">{plays}</span><span class="mx-0.5"></span><span class="text-white">]</span>
                  </span>
                </div>

                <!-- Likes - Icon, Text, Number -->
                <button 
                  id="like-btn"
                  data-mix-id={id}
                  data-liked="false"
                  class="like-btn-wrapper flex items-center justify-center gap-1 px-2 py-1.5 sm:px-3 sm:py-2 bg-gradient-to-r from-gray-700 to-gray-600 text-white border-2 border-gray-500 transition-all font-black uppercase text-xs sm:text-sm md:text-base rounded-lg shadow-lg cursor-pointer"
                >
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 like-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  <span class="like-text hidden sm:inline">Like</span>
                  <span class="liked-text hidden">Liked</span>
                  <span class="hidden sm:inline mx-1.5"></span><span class="text-white">[</span><span class="mx-0.5"></span><span id="likes-count" class="text-green-500">{likes}</span><span class="mx-0.5"></span><span class="text-white">]</span>
                </button>

                <!-- Downloads - Icon, Text, Number -->
                <div class="flex items-center justify-center gap-1 bg-gradient-to-r from-gray-700 to-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 border-2 border-gray-500 rounded-lg shadow-lg">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                  </svg>
                  <span class="text-xs sm:text-sm md:text-base font-black text-white truncate">
                    <span class="hidden sm:inline">Downloads</span><span class="hidden sm:inline mx-1.5"></span><span class="text-white">[</span><span class="mx-0.5"></span><span id="downloads-count" class="text-green-500">{downloads}</span><span class="mx-0.5"></span><span class="text-white">]</span>
                  </span>
                </div>
              </div>

              <!-- Action Buttons Row -->
              <div class="grid grid-cols-3 gap-1.5 sm:gap-2">
                <!-- Play Button -->
                <button 
                  id="play-btn"
                  data-mix-id={id}
                  class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-2 sm:px-3 sm:py-2.5 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white border-2 border-white hover:border-green-400 transition-all font-black uppercase text-xs sm:text-sm md:text-base rounded-lg shadow-lg"
                >
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 play-icon flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 pause-icon hidden flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                  </svg>
                  <span class="play-text">Play</span>
                </button>

                <!-- Share Button -->
                <button
                  id="share-btn"
                  data-mix-id={id}
                  data-title={title}
                  data-dj={dj_name}
                  data-artwork={artwork_url}
                  class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-2 sm:px-3 sm:py-2.5 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-red-600 hover:to-red-700 text-white border-2 border-gray-500 hover:border-red-400 transition-all font-black uppercase text-xs sm:text-sm md:text-base rounded-lg shadow-lg"
                >
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                  </svg>
                  <span>Share</span>
                </button>

                <!-- Download Button -->
                <button 
                  id="download-mix-btn"
                  data-mix-id={id}
                  data-audio-url={audio_url}
                  data-title={title}
                  data-dj={dj_name}
                  class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-2 sm:px-3 sm:py-2.5 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white border-2 border-white hover:border-red-400 transition-all font-black uppercase text-xs sm:text-sm md:text-base rounded-lg shadow-lg"
                >
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 download-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                  </svg>
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 check-icon hidden flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span class="download-text">Download</span>
                </button>
              </div>
            </div>

            <!-- Artwork Column - Bottom Right -->
            <div class="order-2 lg:order-2 flex flex-col items-center lg:items-end lg:justify-end lg:self-end flex-shrink-0">
              <!-- Artwork -->
              <img 
                src={artwork_url} 
                alt={`${title} by ${dj_name}`}
                class="w-full max-w-[280px] sm:max-w-[320px] lg:w-72 xl:w-80 mx-auto lg:mx-0 border-2 sm:border-4 border-white shadow-2xl"
                onerror="this.src='/place-holder.webp'"
              />
            </div>
          </div>
        </div>

        <!-- Hidden audio element for duration detection -->
        <audio id="mix-audio" src={audio_url} preload="metadata" class="hidden"></audio>

        <!-- Description Section -->
        {description && (
          <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-3 sm:p-4 md:p-5 mb-3 sm:mb-4 md:mb-6">
            <h2 class="text-sm sm:text-base md:text-lg font-black text-white uppercase tracking-wider mb-2 pb-2 border-b-2 border-red-600 drop-shadow-lg">
              About This Mix
            </h2>
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-2 sm:p-3 rounded shadow-inner overflow-hidden">
              <p class="text-white text-sm sm:text-base md:text-lg font-medium leading-normal whitespace-pre-wrap break-words overflow-wrap-anywhere">
                {description}
              </p>
            </div>
          </div>
        )}

        <!-- Comments Section -->
        <div id="comments-section" class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-2 sm:p-3 md:p-6 mb-3 sm:mb-4 md:mb-6">
          <h2 class="text-base sm:text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-2 sm:mb-3 md:mb-4 pb-2 sm:pb-3 md:pb-4 border-b-2 border-red-600 flex items-center gap-2 drop-shadow-lg">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Comments (<span id="comments-total-count">{comments.length || 0}</span>)
          </h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 md:gap-6">
            <!-- Comment Input -->
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded flex flex-col shadow-lg order-2 lg:order-1" style="height: 440px;">
              <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase mb-3 flex-shrink-0 drop-shadow-md">Leave a Comment</h3>
              <div class="flex flex-col flex-1 pb-2">
                <input 
                  type="text" 
                  id="comment-username" 
                  placeholder="Login to comment" 
                  maxlength="30"
                  readonly
                  class="w-full px-3 py-2 border-2 border-gray-600 bg-gray-800 text-white placeholder-gray-400 focus:outline-none rounded cursor-not-allowed text-sm md:text-base shadow-inner mb-3 flex-shrink-0"
                />
                
                <!-- Emoji Grid -->
                <div class="mb-3 flex-shrink-0">
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-xs font-black text-gray-300 uppercase tracking-wide">Quick Emojis:</p>
                    <button type="button" id="gif-picker-btn" class="flex items-center gap-1 px-3 py-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-xs font-bold uppercase rounded transition-all">
                      <span>GIF</span>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                    </button>
                  </div>
                  <div class="grid grid-cols-8 gap-1">
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üî•" title="Fire">üî•</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="‚ù§Ô∏è" title="Heart">‚ù§Ô∏è</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üòç" title="Love">üòç</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéµ" title="Music">üéµ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéß" title="Headphones">üéß</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üíØ" title="100">üíØ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üëç" title="Thumbs up">üëç</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üôå" title="Hands up">üôå</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üí•" title="Boom">üí•</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="‚ö°" title="Lightning">‚ö°</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéâ" title="Party">üéâ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üöÄ" title="Rocket">üöÄ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üîä" title="Speaker">üîä</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üíø" title="CD">üíø</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üé∏" title="Guitar">üé∏</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üéπ" title="Piano">üéπ</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="ü•Å" title="Drums">ü•Å</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üé§" title="Mic">üé§</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üëè" title="Clap">üëè</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üí™" title="Strong">üí™</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="‚ú®" title="Sparkles">‚ú®</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üåü" title="Star">üåü</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="üòé" title="Cool">üòé</button>
                    <button type="button" class="emoji-btn text-base md:text-lg bg-gray-800 rounded p-1" data-emoji="ü§©" title="Star eyes">ü§©</button>
                  </div>
                </div>
                
                <!-- GIF Preview -->
                <div id="gif-preview-container" class="hidden mb-3 relative">
                  <img id="gif-preview" src="" alt="Selected GIF" class="max-h-24 rounded border-2 border-blue-500">
                  <button type="button" id="remove-gif-btn" class="absolute -top-2 -right-2 w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-sm font-bold hover:bg-red-700">√ó</button>
                </div>
                
                <textarea 
                  id="comment-text" 
                  placeholder="Write your comment... (login required, max 150 characters)" 
                  maxlength="150"
                  rows="3"
                  class="w-full px-3 py-2 border-2 border-gray-600 bg-gray-900 text-white text-sm md:text-base placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-600 resize-none rounded flex-1 shadow-inner"
                ></textarea>
                
                <div class="flex items-center justify-between mt-3 flex-shrink-0">
                  <span class="text-xs md:text-sm text-gray-400 font-medium">
                    <span id="char-count">0</span>/150
                  </span>
                  <button 
                    id="submit-comment-btn" 
                    data-mix-id={id}
                    class="px-4 md:px-6 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 border-2 border-white shadow-lg transition-all font-black uppercase rounded transform hover:scale-105 active:scale-95 text-xs md:text-sm"
                  >
                    Post Comment
                  </button>
                </div>
              </div>
            </div>

            <!-- Comments Output -->
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded flex flex-col shadow-lg order-1 lg:order-2" style="height: 440px;">
              <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase mb-3 flex-shrink-0 drop-shadow-md">Recent Comments</h3>
              <div id="comments-list" class="space-y-2 pr-2 flex-1 overflow-y-auto">
                {comments && comments.length > 0 ? (
                  comments.map((comment) => (
                    <div class="comment-item p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md relative">
                      <span class="absolute top-2 right-3 text-xs text-gray-400">{new Date(comment.timestamp || comment.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                      <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg overflow-hidden">
                          {comment.avatarUrl ? (
                            <img src={comment.avatarUrl} alt="" class="w-full h-full object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='block';" />
                            <span class="text-white font-bold text-base" style="display:none;">
                              {(comment.userName || 'A').charAt(0).toUpperCase()}
                            </span>
                          ) : (
                            <span class="text-white font-bold text-base">
                              {(comment.userName || 'A').charAt(0).toUpperCase()}
                            </span>
                          )}
                        </div>
                        <div class="flex-1 min-w-0 pt-1">
                          <span class="text-white text-sm uppercase block mb-1">{comment.userName || 'Anonymous'}</span>
                          {comment.comment && <p class="text-gray-100 text-base md:text-lg leading-relaxed break-words">{comment.comment}</p>}
                          {comment.gifUrl && <img src={comment.gifUrl} alt="GIF" class="mt-2 max-h-48 rounded border border-gray-500" loading="lazy" />}
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <p class="text-center text-gray-400 py-8 text-sm md:text-base">No comments yet. Be the first!</p>
                )}
              </div>
            </div>
          </div>
        </div>

        <!-- Tracklist Section - Now After Comments -->
        <div id="tracklist" class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-2 sm:p-3 md:p-6 mb-3 sm:mb-4 md:mb-6">
          <div class="flex items-center justify-between mb-2 sm:mb-3 md:mb-4 pb-2 sm:pb-3 md:pb-4 border-b-2 border-red-600">
            <h2 class="text-base sm:text-lg md:text-2xl font-black text-white uppercase tracking-wider drop-shadow-lg flex items-center gap-2">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
              </svg>
              Tracklist ({tracklist.length} tracks)
            </h2>
            <button 
              id="edit-tracklist-btn" 
              class="hidden px-3 py-1.5 sm:px-4 sm:py-2 bg-white text-black font-bold text-xs sm:text-sm uppercase rounded hover:bg-red-600 hover:text-white transition-all"
              data-mix-id={id}
              data-mix-user-id={mixUserId}
              data-mix-dj-name={mixDjName || dj_name}
            >
              Edit Tracklist
            </button>
          </div>
          {tracklist && tracklist.length > 0 ? (
            <div id="tracklist-display" class="space-y-1.5 sm:space-y-2 max-h-96 overflow-y-auto pr-2">
              {tracklist.map((track, idx) => (
                <div class="bg-gradient-to-r from-gray-700 to-gray-800 p-2 sm:p-3 rounded border-2 border-gray-600 hover:border-red-600 transition-all">
                  <p class="text-white font-bold text-xs sm:text-sm md:text-base">
                    <span class="text-red-500 mr-1 sm:mr-2 font-black">{idx + 1}.</span>
                    {track}
                  </p>
                </div>
              ))}
            </div>
          ) : (
            <div id="tracklist-display" class="text-center py-8">
              <p class="text-gray-400 text-sm sm:text-base">No tracklist available</p>
              <p class="text-gray-500 text-xs mt-2">If you're the owner, click Edit Tracklist to add one</p>
            </div>
          )}
        </div>

      </div>
    </main>
  )}

  <!-- Enhanced Share Modal -->
  <div id="share-modal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm transition-opacity" id="share-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 overflow-y-auto">
      <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 max-w-lg w-full transform transition-all border-2 border-red-500/50 rounded-2xl mx-2 my-4 shadow-2xl shadow-red-500/20">
        <!-- Header with close button -->
        <div class="flex items-center justify-between p-4 border-b border-white/10">
          <h3 class="text-lg font-black text-white uppercase tracking-wider flex items-center gap-2">
            <span class="text-red-500">Share</span> This Mix
          </h3>
          <button id="share-modal-close" class="text-gray-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Mix Preview Card -->
        <div class="p-4">
          <div class="flex gap-4 p-3 bg-white/5 rounded-xl border border-white/10 mb-5">
            <img id="share-modal-artwork" src="/place-holder.webp" alt="Mix artwork" class="w-20 h-20 sm:w-24 sm:h-24 rounded-lg object-cover border-2 border-white/20 shadow-lg" />
            <div class="flex-1 min-w-0">
              <div class="text-base sm:text-lg font-bold text-white break-words line-clamp-2" id="share-modal-title"></div>
              <div class="text-sm text-gray-400 mt-1">by <span class="font-semibold text-red-400" id="share-modal-dj"></span></div>
              <div class="flex items-center gap-2 mt-2">
                <span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs font-bold rounded-full border border-red-500/30">DJ MIX</span>
                <span class="text-xs text-gray-500">freshwax.co.uk</span>
              </div>
            </div>
          </div>

          <!-- Social Share Buttons -->
          <div class="mb-5">
            <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 font-bold">Share on Social</p>
            <div class="grid grid-cols-5 gap-2">
              <!-- X/Twitter -->
              <button id="share-twitter" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#000000] rounded-xl border border-white/10 hover:border-white/30 transition-all">
                <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
                <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">X</span>
              </button>
              <!-- Facebook -->
              <button id="share-facebook" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#1877F2] rounded-xl border border-white/10 hover:border-[#1877F2] transition-all">
                <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">Facebook</span>
              </button>
              <!-- WhatsApp -->
              <button id="share-whatsapp" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#25D366] rounded-xl border border-white/10 hover:border-[#25D366] transition-all">
                <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">WhatsApp</span>
              </button>
              <!-- Telegram -->
              <button id="share-telegram" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#0088cc] rounded-xl border border-white/10 hover:border-[#0088cc] transition-all">
                <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                </svg>
                <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">Telegram</span>
              </button>
              <!-- Reddit -->
              <button id="share-reddit" class="group flex flex-col items-center justify-center p-3 bg-white/5 hover:bg-[#FF4500] rounded-xl border border-white/10 hover:border-[#FF4500] transition-all">
                <svg class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                </svg>
                <span class="text-[10px] text-gray-500 group-hover:text-white mt-1 font-medium">Reddit</span>
              </button>
            </div>
          </div>

          <!-- Copy Link Section -->
          <div class="mb-5">
            <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 font-bold">Copy Link</p>
            <div class="flex gap-2">
              <input
                type="text"
                id="share-url-input"
                readonly
                class="flex-1 px-4 py-3 bg-white/5 border border-white/20 text-sm font-mono text-white rounded-xl focus:outline-none focus:border-red-500 min-w-0"
              />
              <button
                id="copy-url-button"
                class="px-4 py-3 bg-red-600 hover:bg-red-500 text-white transition-all font-bold text-sm flex items-center gap-2 uppercase rounded-xl flex-shrink-0"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                <span id="copy-btn-text">Copy</span>
              </button>
            </div>
            <p class="text-xs text-green-400 font-bold mt-2 hidden" id="copy-feedback">Link copied to clipboard!</p>
          </div>

          <!-- Embed Code Section -->
          <div class="mb-4">
            <button id="toggle-embed" class="text-xs text-gray-400 hover:text-white uppercase tracking-wider font-bold flex items-center gap-2 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
              </svg>
              Embed Code
              <svg id="embed-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>
            <div id="embed-section" class="hidden mt-3">
              <textarea
                id="embed-code"
                readonly
                rows="3"
                class="w-full px-4 py-3 bg-white/5 border border-white/20 text-xs font-mono text-gray-300 rounded-xl focus:outline-none focus:border-red-500 resize-none"
              ></textarea>
              <button
                id="copy-embed-button"
                class="mt-2 px-3 py-2 bg-white/10 hover:bg-white/20 text-white transition-all font-bold text-xs flex items-center gap-2 uppercase rounded-lg"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Copy Embed Code
              </button>
            </div>
          </div>

          <!-- Native Share (Mobile) -->
          <button
            id="native-share-btn"
            class="hidden w-full py-3 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white transition-all font-black text-sm uppercase rounded-xl items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Share via Device
          </button>
        </div>

        <!-- Footer -->
        <div class="px-4 py-3 border-t border-white/10 bg-white/5 rounded-b-2xl">
          <p class="text-center text-xs text-gray-500">
            Spread the <span class="text-red-400 font-bold">vibes</span> - Share this mix with your crew
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Tracklist Modal -->
  <div id="edit-tracklist-modal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-black bg-opacity-80 transition-opacity" id="edit-tracklist-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-3 sm:p-4">
      <div class="bg-white max-w-2xl w-full transform transition-all border-4 border-black rounded-lg mx-2 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between p-3 sm:p-4 border-b-4 border-black">
          <h3 class="text-sm sm:text-base md:text-lg font-black text-black uppercase">Edit Tracklist</h3>
          <button id="edit-tracklist-close" class="text-black hover:text-gray-600 transition-colors p-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-4 sm:p-6 flex-1 overflow-y-auto">
          <p class="text-sm text-gray-600 mb-4">Enter one track per line. Track numbers are added automatically.</p>
          <textarea
            id="edit-tracklist-textarea"
            rows="12"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all resize-none font-mono text-sm"
            placeholder="Artist - Track Title
Artist - Track Title
Artist - Track Title
..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-2">Format: Artist - Track Title (one per line)</p>
        </div>
        <div class="p-4 sm:p-6 border-t-2 border-gray-200 flex gap-3 justify-end">
          <button id="edit-tracklist-cancel" class="px-4 py-2 bg-gray-200 text-black font-bold text-sm uppercase rounded hover:bg-gray-300 transition-all">
            Cancel
          </button>
          <button id="edit-tracklist-save" class="px-6 py-2 bg-black text-white font-bold text-sm uppercase rounded hover:bg-red-600 transition-all">
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Giphy Picker Modal -->
  <div id="giphy-modal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-black bg-opacity-80 transition-opacity" id="giphy-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-3 sm:p-4">
      <div class="bg-gray-900 max-w-lg w-full transform transition-all border-2 border-blue-500 rounded-lg mx-2 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between p-3 sm:p-4 border-b-2 border-blue-500 bg-gradient-to-r from-blue-600 to-indigo-600">
          <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Search GIFs
          </h3>
          <button id="giphy-modal-close" class="text-white hover:text-gray-200 transition-colors p-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-4">
          <input 
            type="text" 
            id="giphy-search-input" 
            placeholder="Search for GIFs..." 
            class="w-full px-4 py-3 border-2 border-gray-600 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div id="giphy-results" class="flex-1 overflow-y-auto p-4 pt-0 grid grid-cols-2 sm:grid-cols-3 gap-2" style="min-height: 200px; max-height: 400px;">
          <p class="col-span-full text-center text-gray-400 py-8">Search for GIFs above</p>
        </div>
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<script is:inline src="/email-verify-check.js"></script>

<style>
  /* Like button - no hover effects, stays gray */
  #like-btn[data-liked="true"] {
    cursor: default;
  }

  #like-btn[data-liked="true"] .like-icon {
    fill: #dc2626;
    stroke: #dc2626;
  }

  #like-btn[data-liked="true"] .like-text {
    display: none !important;
  }

  #like-btn[data-liked="true"] .liked-text {
    display: inline !important;
  }

  /* Download button states */
  #download-mix-btn.downloading {
    opacity: 0.7;
    cursor: wait;
  }

  #download-mix-btn.downloaded {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important;
    border-color: #16a34a !important;
  }

  .emoji-btn {
    background: none;
    border: none;
    cursor: pointer;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .emoji-btn:hover {
    background: rgba(220, 38, 38, 0.8);
  }

  .emoji-btn:active {
    transform: scale(0.9);
  }

  #comments-list::-webkit-scrollbar {
    width: 4px;
  }

  #comments-list::-webkit-scrollbar-track {
    background: #374151;
    border-radius: 2px;
  }

  #comments-list::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 2px;
  }

  #comments-list::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }

  /* Mobile touch improvements */
  @media (max-width: 640px) {
    .emoji-btn {
      min-width: 28px;
      min-height: 28px;
    }
    
    button, a {
      -webkit-tap-highlight-color: transparent;
    }
  }
</style>

<script is:inline define:vars={{ mixId: id, mixTitle: title, mixDj: dj_name, mixArtwork: artwork_url, mixAudioUrl: audio_url }}>
  // Mix data for global player
  const mixData = {
    id: mixId,
    title: mixTitle,
    dj_name: mixDj,
    artwork_url: mixArtwork,
    audio_url: mixAudioUrl
  };

  const audio = document.getElementById('mix-audio');
  const playBtn = document.getElementById('play-btn');
  const playIcon = playBtn?.querySelector('.play-icon');
  const pauseIcon = playBtn?.querySelector('.pause-icon');
  const playText = playBtn?.querySelector('.play-text');
  const likeBtn = document.getElementById('like-btn');
  const downloadBtn = document.getElementById('download-mix-btn');

  // Check URL hash for comments anchor
  if (window.location.hash === '#comments-section') {
    setTimeout(function() {
      const commentsSection = document.getElementById('comments-section');
      if (commentsSection) {
        commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 500);
  }

  // Check if this mix is currently playing in global player
  function isThisMixPlaying() {
    return window.FreshWaxPlayer?.currentMix?.id === mixId;
  }

  // Listen to global audio events for play button state
  if (window.globalAudio) {
    window.globalAudio.addEventListener('play', function() {
      if (isThisMixPlaying()) {
        updatePlayButton(true);
      }
    });
    window.globalAudio.addEventListener('pause', function() {
      if (isThisMixPlaying()) {
        updatePlayButton(false);
      }
    });
    window.globalAudio.addEventListener('ended', function() {
      if (isThisMixPlaying()) {
        updatePlayButton(false);
      }
    });
  }

  // Check if this mix is already playing when page loads
  if (isThisMixPlaying() && window.globalAudio) {
    updatePlayButton(!window.globalAudio.paused);
  }

  // Update duration display in info grid when metadata loads (only if not already set from Firebase)
  function updateDurationDisplay() {
    const durationDisplay = document.getElementById('mix-duration-display');
    const storedDuration = durationDisplay?.getAttribute('data-duration-seconds');
    // Only update if no valid stored duration (0 or missing)
    if (durationDisplay && (!storedDuration || storedDuration === '0' || storedDuration === 'null') && audio && audio.duration && isFinite(audio.duration) && audio.duration > 0) {
      const totalSecs = Math.floor(audio.duration);
      const hours = Math.floor(totalSecs / 3600);
      const mins = Math.floor((totalSecs % 3600) / 60);
      const secs = totalSecs % 60;

      if (hours > 0) {
        const hourWord = hours === 1 ? 'hour' : 'hours';
        const minWord = mins === 1 ? 'minute' : 'minutes';
        durationDisplay.textContent = hours + ' ' + hourWord + (mins > 0 ? ' ' + mins + ' ' + minWord : '');
      } else if (mins > 0) {
        const minWord = mins === 1 ? 'minute' : 'minutes';
        if (secs > 0 && mins < 5) {
          const secWord = secs === 1 ? 'second' : 'seconds';
          durationDisplay.textContent = mins + ' ' + minWord + ' ' + secs + ' ' + secWord;
        } else {
          durationDisplay.textContent = mins + ' ' + minWord;
        }
      } else {
        const secWord = secs === 1 ? 'second' : 'seconds';
        durationDisplay.textContent = secs + ' ' + secWord;
      }
    }
  }

  // Listen for metadata load
  audio?.addEventListener('loadedmetadata', updateDurationDisplay);

  // Also check immediately in case metadata already loaded (race condition)
  if (audio && audio.readyState >= 1) {
    updateDurationDisplay();
  }

  // Play/Pause - using global player
  function updatePlayButton(isPlaying) {
    if (isPlaying) {
      playIcon?.classList.add('hidden');
      pauseIcon?.classList.remove('hidden');
      if (playText) playText.textContent = 'Pause';
    } else {
      playIcon?.classList.remove('hidden');
      pauseIcon?.classList.add('hidden');
      if (playText) playText.textContent = 'Play';
    }
  }

  playBtn?.addEventListener('click', function() {
  // *** PAUSE SHUFFLE WIDGET IF PLAYING ***
  if (window.shuffleWidgetAudio && !window.shuffleWidgetAudio.paused) {
    window.shuffleWidgetAudio.pause();
    
    var shuffleWidget = document.getElementById('shuffle-widget');
    if (shuffleWidget) shuffleWidget.classList.remove('playing');
    
    var shuffleIconPlay = document.getElementById('shuffle-icon-play');
    var shuffleIconPause = document.getElementById('shuffle-icon-pause');
    var shuffleCtrlPlay = document.getElementById('shuffle-ctrl-play-icon');
    var shuffleCtrlPause = document.getElementById('shuffle-ctrl-pause-icon');
    
    if (shuffleIconPlay) shuffleIconPlay.classList.remove('hidden');
    if (shuffleIconPause) shuffleIconPause.classList.add('hidden');
    if (shuffleCtrlPlay) shuffleCtrlPlay.classList.remove('hidden');
    if (shuffleCtrlPause) shuffleCtrlPause.classList.add('hidden');
  }

  if (window.playMix && window.globalAudio) {
    const isThisMix = window.FreshWaxPlayer?.currentMix?.id === mixId;
    
    if (isThisMix) {
      if (window.globalAudio.paused) {
        window.globalAudio.play().then(function() {
          updatePlayButton(true);
        });
      } else {
        window.globalAudio.pause();
        updatePlayButton(false);
      }
    } else {
      window.playMix(mixData).then(function() {
        updatePlayButton(true);
        
        if (!window.FreshWaxPlayer.hasTrackedPlay) {
          window.FreshWaxPlayer.hasTrackedPlay = true;
          fetch('/api/track-mix-play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mixId: mixId })
          }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.plays !== undefined) {
              var playsCount = document.getElementById('plays-count');
              if (playsCount) playsCount.textContent = data.plays;
            }
          });
        }
      });
    }
  }
});
  // Like button
  if (likeBtn && mixId) {
    const likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
    const likeText = likeBtn.querySelector('.like-text');
    const likedText = likeBtn.querySelector('.liked-text');
    
    if (likedMixes.includes(mixId)) {
      likeBtn.setAttribute('data-liked', 'true');
      if (likeText) likeText.style.display = 'none';
      if (likedText) likedText.style.display = 'inline';
    }
    
    likeBtn.addEventListener('click', function() {
      const isLiked = likeBtn.getAttribute('data-liked') === 'true';
      const likesCount = document.getElementById('likes-count');
      
      if (isLiked) {
        likeBtn.setAttribute('data-liked', 'false');
        if (likeText) likeText.style.display = 'inline';
        if (likedText) likedText.style.display = 'none';
        const likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
        const index = likedMixes.indexOf(mixId);
        if (index > -1) {
          likedMixes.splice(index, 1);
          localStorage.setItem('liked-mixes', JSON.stringify(likedMixes));
        }
        fetch('/api/track-mix-unlike', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mixId: mixId })
        }).then(function(response) {
          return response.json();
        }).then(function(data) {
          if (data.likes !== undefined && likesCount) {
            likesCount.textContent = data.likes;
          }
        }).catch(function(error) {
          console.error('Error tracking unlike:', error);
        });
      } else {
        likeBtn.setAttribute('data-liked', 'true');
        if (likeText) likeText.style.display = 'none';
        if (likedText) likedText.style.display = 'inline';
        const likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
        if (!likedMixes.includes(mixId)) {
          likedMixes.push(mixId);
          localStorage.setItem('liked-mixes', JSON.stringify(likedMixes));
        }
        fetch('/api/track-mix-like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mixId: mixId })
        }).then(function(response) {
          return response.json();
        }).then(function(data) {
          if (data.likes !== undefined && likesCount) {
            likesCount.textContent = data.likes;
          }
        }).catch(function(error) {
          console.error('Error tracking like:', error);
        });
      }
    });
  }

  // Download button - async with proper feedback like dashboard
  downloadBtn?.addEventListener('click', async function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const audioUrl = downloadBtn.getAttribute('data-audio-url');
    const title = downloadBtn.getAttribute('data-title');
    const dj = downloadBtn.getAttribute('data-dj');
    const filename = (dj + ' - ' + title + '.mp3').replace(/[^a-z0-9\s\-\.]/gi, '_');
    
    const downloadIcon = downloadBtn.querySelector('.download-icon');
    const checkIcon = downloadBtn.querySelector('.check-icon');
    const downloadText = downloadBtn.querySelector('.download-text');
    
    downloadBtn.disabled = true;
    downloadBtn.classList.add('downloading');
    if (downloadText) downloadText.textContent = 'Downloading...';
    
    // Track download
    if (mixId) {
      fetch('/api/track-mix-download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(response) {
        return response.json();
      }).then(function(data) {
        if (data.downloads !== undefined) {
          const downloadsCount = document.getElementById('downloads-count');
          if (downloadsCount) downloadsCount.textContent = data.downloads;
        }
      }).catch(function(error) {
        console.error('Error tracking download:', error);
      });
    }
    
    try {
      // Use server-side proxy to fetch the file
      const proxyUrl = '/api/download?url=' + encodeURIComponent(audioUrl) + '&filename=' + encodeURIComponent(filename);
      
      const response = await fetch(proxyUrl);
      if (!response.ok) {
        throw new Error('Download failed: ' + response.status);
      }
      
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = blobUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      window.URL.revokeObjectURL(blobUrl);
      
      // Show success state
      if (downloadIcon) downloadIcon.classList.add('hidden');
      if (checkIcon) checkIcon.classList.remove('hidden');
      if (downloadText) downloadText.textContent = 'Downloaded!';
      downloadBtn.classList.remove('downloading');
      downloadBtn.classList.add('downloaded');
      
      // Reset after 3 seconds
      setTimeout(function() {
        if (downloadIcon) downloadIcon.classList.remove('hidden');
        if (checkIcon) checkIcon.classList.add('hidden');
        if (downloadText) downloadText.textContent = 'Download';
        downloadBtn.disabled = false;
        downloadBtn.classList.remove('downloaded');
      }, 3000);
      
    } catch (error) {
      console.error('Download error:', error);
      if (downloadText) downloadText.textContent = 'Error - Retry';
      downloadBtn.classList.remove('downloading');
      
      setTimeout(function() {
        if (downloadIcon) downloadIcon.classList.remove('hidden');
        if (checkIcon) checkIcon.classList.add('hidden');
        if (downloadText) downloadText.textContent = 'Download';
        downloadBtn.disabled = false;
      }, 2000);
    }
  });

  // Enhanced Share functionality
  const shareBtn = document.getElementById('share-btn');
  const shareModal = document.getElementById('share-modal');
  const shareModalClose = document.getElementById('share-modal-close');
  const shareModalBackdrop = document.getElementById('share-modal-backdrop');
  const shareUrlInput = document.getElementById('share-url-input');
  const copyUrlButton = document.getElementById('copy-url-button');
  const copyFeedback = document.getElementById('copy-feedback');
  const copyBtnText = document.getElementById('copy-btn-text');

  // Share data
  let currentShareData = { title: '', dj: '', url: '', artwork: '' };

  shareBtn?.addEventListener('click', function() {
    const title = shareBtn.getAttribute('data-title') || 'DJ Mix';
    const dj = shareBtn.getAttribute('data-dj') || 'Unknown DJ';
    const artwork = shareBtn.getAttribute('data-artwork') || '/place-holder.webp';
    const shareUrl = window.location.href;

    currentShareData = { title, dj, url: shareUrl, artwork };

    // Update modal content
    const shareModalTitle = document.getElementById('share-modal-title');
    const shareModalDj = document.getElementById('share-modal-dj');
    const shareModalArtwork = document.getElementById('share-modal-artwork');
    const embedCode = document.getElementById('embed-code');

    if (shareModalTitle) shareModalTitle.textContent = title;
    if (shareModalDj) shareModalDj.textContent = dj;
    if (shareModalArtwork) shareModalArtwork.src = artwork;
    if (shareUrlInput) shareUrlInput.value = shareUrl;
    if (embedCode) {
      embedCode.value = `<iframe src="${shareUrl}?embed=1" width="100%" height="180" frameborder="0" allow="autoplay; encrypted-media" style="border-radius: 12px;"></iframe>`;
    }

    // Show native share button on supported devices
    const nativeShareBtn = document.getElementById('native-share-btn');
    if (navigator.share && nativeShareBtn) {
      nativeShareBtn.classList.remove('hidden');
      nativeShareBtn.classList.add('flex');
    }

    shareModal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });

  // Close modal handlers
  function closeShareModal() {
    shareModal?.classList.add('hidden');
    document.body.style.overflow = '';
  }

  shareModalClose?.addEventListener('click', closeShareModal);
  shareModalBackdrop?.addEventListener('click', closeShareModal);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !shareModal?.classList.contains('hidden')) {
      closeShareModal();
    }
  });

  // Copy URL button
  copyUrlButton?.addEventListener('click', function() {
    navigator.clipboard.writeText(shareUrlInput?.value || '').then(function() {
      if (copyFeedback) {
        copyFeedback.classList.remove('hidden');
      }
      if (copyBtnText) {
        copyBtnText.textContent = 'Copied!';
      }
      setTimeout(function() {
        if (copyFeedback) copyFeedback.classList.add('hidden');
        if (copyBtnText) copyBtnText.textContent = 'Copy';
      }, 2000);
    });
  });

  // Social share buttons
  document.getElementById('share-twitter')?.addEventListener('click', function() {
    const text = `Check out "${currentShareData.title}" by ${currentShareData.dj} on Fresh Wax`;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(currentShareData.url)}`, '_blank', 'width=550,height=420');
  });

  document.getElementById('share-facebook')?.addEventListener('click', function() {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentShareData.url)}`, '_blank', 'width=550,height=420');
  });

  document.getElementById('share-whatsapp')?.addEventListener('click', function() {
    const text = `Check out "${currentShareData.title}" by ${currentShareData.dj} on Fresh Wax ${currentShareData.url}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
  });

  document.getElementById('share-telegram')?.addEventListener('click', function() {
    const text = `Check out "${currentShareData.title}" by ${currentShareData.dj} on Fresh Wax`;
    window.open(`https://t.me/share/url?url=${encodeURIComponent(currentShareData.url)}&text=${encodeURIComponent(text)}`, '_blank');
  });

  document.getElementById('share-reddit')?.addEventListener('click', function() {
    const title = `${currentShareData.title} by ${currentShareData.dj} - Fresh Wax`;
    window.open(`https://www.reddit.com/submit?url=${encodeURIComponent(currentShareData.url)}&title=${encodeURIComponent(title)}`, '_blank', 'width=550,height=420');
  });

  // Embed code toggle
  const toggleEmbed = document.getElementById('toggle-embed');
  const embedSection = document.getElementById('embed-section');
  const embedChevron = document.getElementById('embed-chevron');

  toggleEmbed?.addEventListener('click', function() {
    embedSection?.classList.toggle('hidden');
    embedChevron?.classList.toggle('rotate-180');
  });

  // Copy embed code
  document.getElementById('copy-embed-button')?.addEventListener('click', function() {
    const embedCode = document.getElementById('embed-code');
    if (embedCode) {
      navigator.clipboard.writeText(embedCode.value).then(function() {
        const btn = document.getElementById('copy-embed-button');
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
          setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }
      });
    }
  });

  // Native share (mobile)
  document.getElementById('native-share-btn')?.addEventListener('click', async function() {
    try {
      await navigator.share({
        title: `${currentShareData.title} by ${currentShareData.dj}`,
        text: `Check out this DJ mix on Fresh Wax`,
        url: currentShareData.url
      });
    } catch (err) {
      console.log('Share cancelled or failed');
    }
  });

  // Comments functionality
  const commentUsername = document.getElementById('comment-username');
  const commentText = document.getElementById('comment-text');
  const charCount = document.getElementById('char-count');
  const submitCommentBtn = document.getElementById('submit-comment-btn');
  const commentsList = document.getElementById('comments-list');
  const commentsTotalCount = document.getElementById('comments-total-count');

  // Check for logged-in user
  let currentUser = null;
  let currentUserName = null;
  let currentUserAvatar = null;
  let cachedUserId = null; // Store cached user ID for use before Firebase Auth initializes

  // Try to restore from localStorage cache first (for instant auth on page reload)
  // This matches the pattern used on live.astro for consistent auth across pages
  try {
    const cached = localStorage.getItem('fw_auth_cache');
    if (cached) {
      const cachedAuth = JSON.parse(cached);
      // Only use cache if less than 24 hours old
      if (cachedAuth.cachedAt && Date.now() - cachedAuth.cachedAt < 86400000 && cachedAuth.loggedIn) {
        console.log('[Comments] Restored auth from cache:', cachedAuth.id);
        // Store cached values for immediate use
        currentUserName = cachedAuth.displayName || cachedAuth.name;
        currentUserAvatar = cachedAuth.avatar || null;
        cachedUserId = cachedAuth.id;
        // Immediately update the username field
        const commentUsername = document.getElementById('comment-username');
        if (commentUsername && currentUserName) {
          commentUsername.value = currentUserName;
          commentUsername.classList.remove('cursor-not-allowed');
          commentUsername.classList.add('cursor-default', 'bg-gray-700');
        }
      } else if (cachedAuth.cachedAt && Date.now() - cachedAuth.cachedAt >= 86400000) {
        localStorage.removeItem('fw_auth_cache');
      }
    }
  } catch (e) { /* Ignore cache errors */ }

  // Function to update UI based on auth state
  function updateCommentUI(user, userName, avatarUrl) {
    if (user && userName) {
      currentUser = user;
      currentUserName = userName;
      currentUserAvatar = avatarUrl || null;
      cachedUserId = user.uid; // Update cached ID when Firebase Auth confirms
      if (commentUsername) {
        commentUsername.value = userName;
        commentUsername.classList.remove('cursor-not-allowed');
        commentUsername.classList.add('cursor-default', 'bg-gray-700');
      }
    } else {
      currentUser = null;
      currentUserName = null;
      currentUserAvatar = null;
      cachedUserId = null; // Clear cached ID on logout
      if (commentUsername) {
        commentUsername.value = '';
        commentUsername.placeholder = 'Login to comment';
        commentUsername.classList.add('cursor-not-allowed');
        commentUsername.classList.remove('cursor-default', 'bg-gray-700');
      }
    }
  }

  // Initialize Firebase Auth listener
  async function initFirebaseAuth() {
    try {
      const firebaseApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
      const firebaseFirestore = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      
      const { initializeApp, getApps } = firebaseApp;
      const { getAuth, onAuthStateChanged } = firebaseAuth;
      const { getFirestore, doc, getDoc } = firebaseFirestore;
      
      // Firebase config
      const firebaseConfig = {
        apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };
      
      // Check if app already initialized
      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // Store auth globally for other scripts
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      
      // Helper to fetch user profile using cached API (reduces 3 reads to 1)
      async function fetchUserProfile(user) {
        try {
          // Check sessionStorage cache first
          const cacheKey = `fw_user_profile_${user.uid}`;
          const cached = sessionStorage.getItem(cacheKey);
          if (cached) {
            try {
              const profile = JSON.parse(cached);
              // Cache valid for 5 minutes
              if (profile.cachedAt && Date.now() - profile.cachedAt < 300000) {
                // Firebase Auth displayName is the public name (same as Header.astro)
                const displayName = user.displayName || profile.partnerDisplayName || user.email?.split('@')[0] || 'User';
                return {
                  name: displayName,
                  avatarUrl: profile.avatarUrl || user.photoURL || null
                };
              }
            } catch (e) { /* ignore parse errors */ }
          }
          
          // Fetch from consolidated API endpoint
          const response = await fetch(`/api/get-user-type?uid=${encodeURIComponent(user.uid)}`);
          if (response.ok) {
            const profile = await response.json();
            if (profile.success) {
              // Cache the result
              profile.cachedAt = Date.now();
              try { sessionStorage.setItem(cacheKey, JSON.stringify(profile)); } catch (e) {}
              // Firebase Auth displayName is the public name (same as Header.astro)
              const displayName = user.displayName || profile.partnerDisplayName || user.email?.split('@')[0] || 'User';
              return {
                name: displayName,
                avatarUrl: profile.avatarUrl || user.photoURL || null
              };
            }
          }
          return { name: user.displayName || user.email?.split('@')[0] || 'User', avatarUrl: user.photoURL || null };
        } catch (err) {
          return { name: user.displayName || user.email?.split('@')[0] || 'User', avatarUrl: user.photoURL || null };
        }
      }
      
      // Listen for auth state changes - this is the reliable method
      onAuthStateChanged(auth, async function(user) {
        if (user) {
          const profile = await fetchUserProfile(user);
          updateCommentUI(user, profile.name, profile.avatarUrl);
        } else {
          updateCommentUI(null, null, null);
        }
      });
      
      // Also check immediately using authReady from Header
      if (window.authReady) {
        const user = await window.authReady;
        if (user && !currentUser) {
          const profile = await fetchUserProfile(user);
          updateCommentUI(user, profile.name, profile.avatarUrl);
        }
      }
      
    } catch (err) {
      console.error('[Comments] Firebase init error:', err);
    }
  }
  
  // Initialize on page load
  initFirebaseAuth();
  
  // Re-check auth on Astro page transitions
  document.addEventListener('astro:page-load', function() {
    initFirebaseAuth();
  });
  
  // Re-check auth on back/forward navigation (bfcache)
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      initFirebaseAuth();
    }
  });

  // Character count
  commentText?.addEventListener('input', function() {
    if (charCount) {
      charCount.textContent = commentText.value.length;
    }
  });

  // Emoji buttons
  document.querySelectorAll('.emoji-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const emoji = btn.getAttribute('data-emoji');
      if (commentText && emoji) {
        const start = commentText.selectionStart;
        const end = commentText.selectionEnd;
        const text = commentText.value;
        commentText.value = text.substring(0, start) + emoji + text.substring(end);
        commentText.focus();
        commentText.selectionStart = commentText.selectionEnd = start + emoji.length;
        if (charCount) {
          charCount.textContent = commentText.value.length;
        }
      }
    });
  });

  // Submit comment
  let selectedGifUrl = null;
  
  submitCommentBtn?.addEventListener('click', async function() {
    // Check for either Firebase user or cached auth
    const userId = currentUser?.uid || cachedUserId;
    if (!userId) {
      alert('Please login to post a comment');
      return;
    }

    // Check email verification for new users
    if (window.FreshWax?.checkEmailVerified) {
      const verified = await window.FreshWax.checkEmailVerified('post comments');
      if (!verified) return;
    }

    const userName = currentUserName || commentUsername?.value?.trim();
    const comment = commentText?.value?.trim();

    if (!userName) {
      alert('Please login to comment');
      return;
    }

    // Allow GIF-only or text-only or both
    if (!comment && !selectedGifUrl) {
      alert('Please enter a comment or select a GIF');
      commentText?.focus();
      return;
    }

    submitCommentBtn.disabled = true;
    submitCommentBtn.textContent = 'Posting...';


    fetch('/api/add-mix-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        mixId: mixId,
        userName: userName,
        comment: comment || '',
        gifUrl: selectedGifUrl,
        userId: userId,
        avatarUrl: currentUserAvatar || null
      })
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      if (data.success) {
        // Build new comment HTML - escape any special characters
        const safeUserName = userName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const safeComment = comment ? comment.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
        const initial = safeUserName.charAt(0).toUpperCase();
        
        let commentContent = '';
        if (safeComment) {
          commentContent += '<p class="text-gray-100 text-base md:text-lg leading-relaxed break-words">' + safeComment + '</p>';
        }
        if (selectedGifUrl) {
          commentContent += '<img src="' + selectedGifUrl + '" alt="GIF" class="mt-2 max-h-48 rounded border border-gray-500" loading="lazy" />';
        }
        
        // Avatar HTML - use image if available, fallback to initial
        let avatarHtml;
        if (currentUserAvatar) {
          avatarHtml = '<img src="' + currentUserAvatar + '" alt="" class="w-full h-full object-cover" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';" /><span class="text-white font-bold text-base hidden items-center justify-center w-full h-full">' + initial + '</span>';
        } else {
          avatarHtml = '<span class="text-white font-bold text-base">' + initial + '</span>';
        }
        
        const newCommentHtml = '<div class="comment-item p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md relative"><span class="absolute top-2 right-3 text-xs text-gray-400">Just now</span><div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg overflow-hidden">' + avatarHtml + '</div><div class="flex-1 min-w-0 pt-1"><span class="text-white text-sm uppercase block mb-1">' + safeUserName + '</span>' + commentContent + '</div></div></div>';
        
        // Get fresh reference to comments container
        const commentsContainer = document.getElementById('comments-list');
        
        if (commentsContainer) {
          // Remove "no comments" message if present
          const noCommentsMsg = commentsContainer.querySelector('.text-center');
          if (noCommentsMsg) {
            noCommentsMsg.remove();
          }
          
          // Insert new comment at the top
          commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
        } else {
          console.error('[Comments] Comments container not found!');
        }
        
        // Update comment count
        if (commentsTotalCount) {
          const newCount = data.commentCount || (parseInt(commentsTotalCount.textContent) + 1);
          commentsTotalCount.textContent = newCount;
        }
        
        // Clear input and GIF
        if (commentText) {
          commentText.value = '';
          if (charCount) charCount.textContent = '0';
        }
        
        // Clear selected GIF
        selectedGifUrl = null;
        const gifPreviewContainer = document.getElementById('gif-preview-container');
        if (gifPreviewContainer) gifPreviewContainer.classList.add('hidden');
        
      } else {
        console.error('[Comments] API error:', data.error);
        alert(data.error || 'Failed to post comment');
      }
    }).catch(function(error) {
      console.error('[Comments] Fetch error:', error);
      alert('Failed to post comment. Please try again.');
    }).finally(function() {
      submitCommentBtn.disabled = false;
      submitCommentBtn.textContent = 'Post Comment';
    });
  });

  // ============================================
  // TRACKLIST EDIT FUNCTIONALITY
  // ============================================
  const editTracklistBtn = document.getElementById('edit-tracklist-btn');
  const editTracklistModal = document.getElementById('edit-tracklist-modal');
  const editTracklistBackdrop = document.getElementById('edit-tracklist-backdrop');
  const editTracklistClose = document.getElementById('edit-tracklist-close');
  const editTracklistCancel = document.getElementById('edit-tracklist-cancel');
  const editTracklistSave = document.getElementById('edit-tracklist-save');
  const editTracklistTextarea = document.getElementById('edit-tracklist-textarea');
  const tracklistDisplay = document.getElementById('tracklist-display');

  // Check ownership and show edit button
  async function checkTracklistOwnership() {
    if (!editTracklistBtn) return;
    
    const mixUserId = editTracklistBtn.getAttribute('data-mix-user-id');
    const mixDjName = (editTracklistBtn.getAttribute('data-mix-dj-name') || '').toLowerCase().trim();
    
    try {
      const firebaseApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
      const firebaseFirestore = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      
      const { getApps, initializeApp } = firebaseApp;
      const { getAuth } = firebaseAuth;
      const { getFirestore, doc, getDoc } = firebaseFirestore;
      
      const firebaseConfig = {
        apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };
      
      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // Wait for auth to be ready
      let user = auth.currentUser;
      if (!user && window.authReady) {
        user = await window.authReady;
      }
      if (!user) return;
      
      // Check if user owns this mix
      let isOwner = false;
      
      // Check by userId
      if (mixUserId && mixUserId === user.uid) {
        isOwner = true;
      }
      
      // Check by DJ name match (for artists) using cached profile
      if (!isOwner && mixDjName) {
        try {
          // Check sessionStorage cache first
          const cacheKey = `fw_user_profile_${user.uid}`;
          let artistName = '';
          
          const cached = sessionStorage.getItem(cacheKey);
          if (cached) {
            try {
              const profile = JSON.parse(cached);
              if (profile.cachedAt && Date.now() - profile.cachedAt < 300000) {
                artistName = (profile.partnerDisplayName || '').toLowerCase().trim();
              }
            } catch (e) {}
          }
          
          // If not cached, fetch from API
          if (!artistName) {
            const response = await fetch(`/api/get-user-type?uid=${encodeURIComponent(user.uid)}`);
            if (response.ok) {
              const profile = await response.json();
              if (profile.success) {
                profile.cachedAt = Date.now();
                try { sessionStorage.setItem(cacheKey, JSON.stringify(profile)); } catch (e) {}
                artistName = (profile.partnerDisplayName || '').toLowerCase().trim();
              }
            }
          }
          
          if (artistName && artistName === mixDjName) {
            isOwner = true;
          }
        } catch (e) {
          // Ignore error
        }
      }
      
      if (isOwner) {
        editTracklistBtn.classList.remove('hidden');
      }
    } catch (err) {
      console.error('[Tracklist] Ownership check error:', err);
    }
  }

  // Initialize ownership check after a short delay to let auth initialize
  setTimeout(checkTracklistOwnership, 1000);

  // Open edit modal
  editTracklistBtn?.addEventListener('click', function() {
    // Get current tracklist from display
    // Only get actual track items, not placeholder text
    // Placeholder container has 'text-center' class, real tracks don't
    let currentTracklist = [];

    if (tracklistDisplay && !tracklistDisplay.classList.contains('text-center')) {
      const trackItems = tracklistDisplay.querySelectorAll('p');
      if (trackItems && trackItems.length > 0) {
        trackItems.forEach(function(p) {
          // Remove the track number prefix that's added by display
          let text = p.textContent || '';
          text = text.replace(/^\d+\.\s*/, '').trim();
          // Skip placeholder text
          if (text && !text.includes('No tracklist available') && !text.includes('click Edit Tracklist')) {
            currentTracklist.push(text);
          }
        });
      }
    }

    if (editTracklistTextarea) {
      editTracklistTextarea.value = currentTracklist.join('\n');
    }

    editTracklistModal?.classList.remove('hidden');
  });

  // Close modal
  function closeEditModal() {
    editTracklistModal?.classList.add('hidden');
  }
  
  editTracklistClose?.addEventListener('click', closeEditModal);
  editTracklistCancel?.addEventListener('click', closeEditModal);
  editTracklistBackdrop?.addEventListener('click', closeEditModal);

  // Save tracklist
  editTracklistSave?.addEventListener('click', async function() {
    const mixId = editTracklistBtn?.getAttribute('data-mix-id');
    const newTracklist = editTracklistTextarea?.value || '';

    if (!mixId) {
      alert('Error: Mix ID not found');
      return;
    }

    editTracklistSave.disabled = true;
    editTracklistSave.textContent = 'Saving...';

    try {
      // Get current user ID for authentication
      let userId = '';
      try {
        const firebaseApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { getApps, initializeApp } = firebaseApp;
        const { getAuth } = firebaseAuth;

        const firebaseConfig = {
          apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
          authDomain: "freshwax-store.firebaseapp.com",
          projectId: "freshwax-store",
          storageBucket: "freshwax-store.firebasestorage.app",
          messagingSenderId: "675435782973",
          appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
        };

        const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let user = auth.currentUser;
        if (!user && window.authReady) {
          user = await window.authReady;
        }
        if (user) {
          userId = user.uid;
        }
      } catch (authErr) {
        console.error('[Tracklist] Auth error:', authErr);
      }

      const response = await fetch('/api/update-mix', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mixId: mixId,
          tracklist: newTracklist,
          userId: userId
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Update display with new tracklist
        const lines = newTracklist.split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(line => line.replace(/^\d+[\.\)\:\-]?\s*[-‚Äì‚Äî]?\s*/, '').trim())
          .filter(line => line.length > 0);
        
        if (tracklistDisplay && lines.length > 0) {
          tracklistDisplay.innerHTML = lines.map((track, idx) => 
            '<div class="bg-gradient-to-r from-gray-700 to-gray-800 p-2 sm:p-3 rounded border-2 border-gray-600 hover:border-red-600 transition-all">' +
              '<p class="text-white font-bold text-xs sm:text-sm md:text-base">' +
                '<span class="text-red-500 mr-1 sm:mr-2 font-black">' + (idx + 1) + '.</span>' +
                track +
              '</p>' +
            '</div>'
          ).join('');
        } else if (tracklistDisplay) {
          tracklistDisplay.innerHTML = '<div class="text-center py-8"><p class="text-gray-400 text-sm sm:text-base">No tracklist available</p></div>';
        }
        
        // Update track count in header if present
        const tracklistHeader = document.querySelector('#tracklist h2');
        if (tracklistHeader && lines.length > 0) {
          tracklistHeader.innerHTML = tracklistHeader.innerHTML.replace(/\(\d+ tracks?\)/, '(' + lines.length + ' tracks)');
        }
        
        closeEditModal();
        alert('Tracklist updated successfully!');
      } else {
        alert(data.error || 'Failed to update tracklist');
      }
    } catch (error) {
      console.error('[Tracklist] Save error:', error);
      alert('Failed to save tracklist. Please try again.');
    } finally {
      editTracklistSave.disabled = false;
      editTracklistSave.textContent = 'Save Changes';
    }
  });

  // ============================================
  // GIPHY PICKER FUNCTIONALITY
  // ============================================
  const GIPHY_API_KEY = 'p0USqLUVxus8d82HAcPhQ2GqG6SfraYr';
  const giphyModal = document.getElementById('giphy-modal');
  const giphyModalClose = document.getElementById('giphy-modal-close');
  const giphyModalBackdrop = document.getElementById('giphy-modal-backdrop');
  const giphySearchInput = document.getElementById('giphy-search-input');
  const giphyResults = document.getElementById('giphy-results');
  const gifPickerBtn = document.getElementById('gif-picker-btn');
  const gifPreviewContainer = document.getElementById('gif-preview-container');
  const gifPreview = document.getElementById('gif-preview');
  const removeGifBtn = document.getElementById('remove-gif-btn');
  
  let giphySearchTimeout;
  
  // Open Giphy modal
  gifPickerBtn?.addEventListener('click', function() {
    if (!currentUser) {
      alert('Please login to add GIFs');
      return;
    }
    giphyModal?.classList.remove('hidden');
    giphySearchInput?.focus();
    // Load trending GIFs initially
    loadTrendingGifs();
  });
  
  // Close Giphy modal
  function closeGiphyModal() {
    giphyModal?.classList.add('hidden');
    if (giphySearchInput) giphySearchInput.value = '';
  }
  
  giphyModalClose?.addEventListener('click', closeGiphyModal);
  giphyModalBackdrop?.addEventListener('click', closeGiphyModal);
  
  // Load trending GIFs
  async function loadTrendingGifs() {
    if (!giphyResults) return;
    giphyResults.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">Loading...</p>';
    
    try {
      const response = await fetch('https://api.giphy.com/v1/gifs/trending?api_key=' + GIPHY_API_KEY + '&limit=18&rating=pg-13');
      const data = await response.json();
      renderGiphyResults(data.data);
    } catch (err) {
      giphyResults.innerHTML = '<p class="col-span-full text-center text-red-400 py-4">Failed to load GIFs</p>';
    }
  }
  
  // Search GIFs
  giphySearchInput?.addEventListener('input', function() {
    clearTimeout(giphySearchTimeout);
    const query = giphySearchInput.value.trim();
    
    if (!query) {
      loadTrendingGifs();
      return;
    }
    
    giphySearchTimeout = setTimeout(async function() {
      if (!giphyResults) return;
      giphyResults.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">Searching...</p>';
      
      try {
        const response = await fetch('https://api.giphy.com/v1/gifs/search?api_key=' + GIPHY_API_KEY + '&q=' + encodeURIComponent(query) + '&limit=18&rating=pg-13');
        const data = await response.json();
        
        if (data.data.length === 0) {
          giphyResults.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">No GIFs found for "' + query + '"</p>';
        } else {
          renderGiphyResults(data.data);
        }
      } catch (err) {
        giphyResults.innerHTML = '<p class="col-span-full text-center text-red-400 py-4">Search failed</p>';
      }
    }, 300);
  });
  
  // Render GIF results
  function renderGiphyResults(gifs) {
    if (!giphyResults) return;
    
    giphyResults.innerHTML = gifs.map(function(gif) {
      const previewUrl = gif.images.fixed_height_small.url;
      const fullUrl = gif.images.fixed_height.url;
      return '<div class="gif-item cursor-pointer rounded overflow-hidden border-2 border-transparent hover:border-blue-500 transition-all" data-gif-url="' + fullUrl + '">' +
        '<img src="' + previewUrl + '" alt="' + (gif.title || 'GIF') + '" class="w-full h-24 object-cover" loading="lazy" />' +
        '</div>';
    }).join('');
    
    // Add click handlers
    giphyResults.querySelectorAll('.gif-item').forEach(function(item) {
      item.addEventListener('click', function() {
        const gifUrl = item.getAttribute('data-gif-url');
        selectGif(gifUrl);
      });
    });
  }
  
  // Select a GIF - immediately post it
  function selectGif(url) {
    if (!currentUser) {
      alert('Please login to post GIFs');
      closeGiphyModal();
      return;
    }
    
    const userName = currentUserName || commentUsername?.value?.trim();
    if (!userName) {
      alert('Please login to post GIFs');
      closeGiphyModal();
      return;
    }
    
    closeGiphyModal();
    
    // Show posting indicator
    if (submitCommentBtn) {
      submitCommentBtn.disabled = true;
      submitCommentBtn.textContent = 'Posting GIF...';
    }
    
    // Immediately post the GIF
    fetch('/api/add-mix-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        mixId: mixId,
        userName: userName,
        comment: '',
        gifUrl: url,
        userId: currentUser.uid,
        avatarUrl: currentUserAvatar || null
      })
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      if (data.success) {
        const safeUserName = userName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const initial = safeUserName.charAt(0).toUpperCase();
        
        // Avatar HTML - use image if available, fallback to initial
        let avatarHtml;
        if (currentUserAvatar) {
          avatarHtml = '<img src="' + currentUserAvatar + '" alt="" class="w-full h-full object-cover" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';" /><span class="text-white font-bold text-base hidden items-center justify-center w-full h-full">' + initial + '</span>';
        } else {
          avatarHtml = '<span class="text-white font-bold text-base">' + initial + '</span>';
        }
        
        const newCommentHtml = '<div class="comment-item p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md relative"><span class="absolute top-2 right-3 text-xs text-gray-400">Just now</span><div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg overflow-hidden">' + avatarHtml + '</div><div class="flex-1 min-w-0 pt-1"><span class="text-white text-sm uppercase block mb-1">' + safeUserName + '</span><img src="' + url + '" alt="GIF" class="mt-2 max-h-48 rounded border border-gray-500" loading="lazy" /></div></div></div>';
        
        const commentsContainer = document.getElementById('comments-list');
        if (commentsContainer) {
          const noCommentsMsg = commentsContainer.querySelector('.text-center');
          if (noCommentsMsg) noCommentsMsg.remove();
          commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
        }
        
        // Update comment count
        if (commentsTotalCount) {
          const newCount = data.commentCount || (parseInt(commentsTotalCount.textContent) + 1);
          commentsTotalCount.textContent = newCount;
        }
      } else {
        alert(data.error || 'Failed to post GIF');
      }
    }).catch(function(error) {
      console.error('[Comments] GIF post error:', error);
      alert('Failed to post GIF. Please try again.');
    }).finally(function() {
      if (submitCommentBtn) {
        submitCommentBtn.disabled = false;
        submitCommentBtn.textContent = 'Post Comment';
      }
    });
  }
  
  // Remove selected GIF (no longer needed but keep for safety)
  removeGifBtn?.addEventListener('click', function() {
    selectedGifUrl = null;
    gifPreviewContainer?.classList.add('hidden');
    if (gifPreview) gifPreview.src = '';
  });
</script>