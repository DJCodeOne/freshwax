---
// src/pages/dj-mix/[id].astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const { id } = Astro.params;

console.log('[DJ MIX PAGE] Loading mix:', id);

let mix = null;
let error = null;
let comments = [];

try {
  const apiUrl = `${Astro.url.origin}/api/get-dj-mix?id=${id}`;
  console.log('[DJ MIX PAGE] Fetching from:', apiUrl);
  
  const response = await fetch(apiUrl);
  const data = await response.json();
  
  if (data.success && data.mix) {
    mix = data.mix;
    console.log('[DJ MIX PAGE] ‚úì Mix loaded:', mix.title);
  } else {
    error = data.error || 'Mix not found';
  }
} catch (err) {
  console.error('[DJ MIX PAGE] ‚úó Fetch error:', err);
  error = 'Failed to load mix';
}

// Comments are already in the mix document
if (mix && mix.comments) {
  comments = mix.comments;
  console.log('[DJ MIX PAGE] ‚úì Comments loaded:', comments.length);
}

const {
  title = 'Untitled Mix',
  dj_name = 'Unknown DJ',
  genre = 'Jungle & Drum and Bass',
  artwork_url = '/logo.webp',
  audio_url = '',
  upload_date = new Date().toISOString(),
  description = '',
  plays = 0,
  downloads = 0,
  likes = 0,
  commentCount = 0,
  tracklistArray = [],
  tracklist: tracklistRaw = ''
} = mix || {};

// Get duration from various possible field names
const durationSeconds = mix?.durationSeconds || mix?.duration || mix?.duration_seconds || mix?.mixDuration || null;

// Format duration helper
function formatDurationDisplay(seconds) {
  if (!seconds || !isFinite(seconds)) return null;
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  
  if (hrs > 0) {
    const hourWord = hrs === 1 ? 'hour' : 'hours';
    const minWord = mins === 1 ? 'minute' : 'minutes';
    if (mins > 0) {
      return `${hrs} ${hourWord} ${mins} ${minWord}`;
    }
    return `${hrs} ${hourWord}`;
  }
  const minWord = mins === 1 ? 'minute' : 'minutes';
  return `${mins} ${minWord}`;
}

const formattedDuration = formatDurationDisplay(durationSeconds);

// Use tracklistArray if available, otherwise parse the raw string
const tracklist = Array.isArray(tracklistArray) && tracklistArray.length > 0 
  ? tracklistArray 
  : (typeof tracklistRaw === 'string' && tracklistRaw.trim() 
      ? tracklistRaw.split('\n').map(line => line.trim()).filter(line => line.length > 0)
      : []);

const formattedDate = mix ? new Date(upload_date).toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
}) : '';
---

<Layout title={mix ? `${title} - ${dj_name} | Fresh Wax` : 'Mix Not Found | Fresh Wax'}>
  <Header />
  
  {!mix ? (
    <main style="min-height: 100vh; background: #000000; padding: 2rem 0;">
      <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white border-2 border-black p-8 text-center">
          <h1 class="text-3xl font-black text-black mb-4 uppercase">Mix Not Found</h1>
          <p class="text-lg font-bold text-black mb-2">ID: {id}</p>
          <p class="text-gray-700 mb-6 font-semibold">{error || 'This mix could not be loaded.'}</p>
          <a href="/dj-mixes" class="inline-block bg-black text-white px-6 py-3 font-black hover:bg-gray-800 transition-colors uppercase border-2 border-black">
            ‚Üê Back to DJ Mixes
          </a>
        </div>
      </div>
    </main>
  ) : (
    <main style="min-height: 100vh; background: #000000 url('/logo.webp') center/cover no-repeat fixed; padding: 1rem 0;">
      <div class="max-w-7xl mx-auto px-2 sm:px-3 md:px-4">
        
        <a href="/dj-mixes" class="inline-flex items-center gap-1 sm:gap-2 text-white hover:text-gray-300 font-black mb-3 sm:mb-4 md:mb-6 transition-colors uppercase text-xs border-2 border-white px-2 sm:px-3 md:px-4 py-1.5 sm:py-2">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          <span class="hidden sm:inline">Back to DJ Mixes</span>
          <span class="sm:hidden">Back</span>
        </a>

        <!-- Main Info Section -->
        <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white p-3 sm:p-4 md:p-8 mb-3 sm:mb-4 md:mb-6 shadow-xl">
          <div class="flex flex-col lg:flex-row gap-4 sm:gap-6 md:gap-8">
            
            <!-- Info Column - Now First on Desktop -->
            <div class="lg:flex-1 space-y-3 sm:space-y-4 md:space-y-6 order-1 lg:order-1">
              <div class="text-center lg:text-left">
                <h1 class="text-xl sm:text-2xl md:text-4xl lg:text-5xl font-black text-red-500 mb-1 sm:mb-2 md:mb-3 leading-tight uppercase drop-shadow-lg">{title}</h1>
                <p class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-black text-white mb-1 md:mb-2 uppercase drop-shadow-md">{dj_name}</p>
              </div>

              <!-- Info Grid -->
              <div class="grid grid-cols-2 gap-1.5 sm:gap-2 md:gap-3">
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-[10px] sm:text-xs text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Upload Date</p>
                  <p class="text-[10px] sm:text-xs md:text-sm text-white font-bold truncate">{formattedDate}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-[10px] sm:text-xs text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Genre</p>
                  <p class="text-[10px] sm:text-xs md:text-sm text-white font-bold truncate">{genre}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-[10px] sm:text-xs text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Duration</p>
                  <p id="mix-duration-display" data-duration-seconds={durationSeconds} class="text-[10px] sm:text-xs md:text-sm text-white font-bold">{formattedDuration || '--:--'}</p>
                </div>
                <div class="bg-gradient-to-r from-gray-700 to-gray-600 p-1.5 sm:p-2 md:p-3 border-2 border-gray-500 shadow-lg rounded-lg">
                  <p class="text-[10px] sm:text-xs text-gray-300 uppercase font-black mb-0.5 sm:mb-1">Format</p>
                  <p class="text-[10px] sm:text-xs md:text-sm text-white font-bold">DJ Mix</p>
                </div>
              </div>

              <!-- Stats & Actions -->
              <div class="grid grid-cols-3 gap-1.5 sm:gap-2 pt-2 sm:pt-3 md:pt-4 border-t-2 border-red-600">
                <!-- Plays - Icon, Text, Number -->
                <div class="flex items-center justify-center gap-1 bg-gradient-to-r from-gray-700 to-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 border-2 border-gray-500 rounded-lg shadow-lg">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <span class="text-[10px] sm:text-xs md:text-sm font-black text-white truncate">
                    <span class="hidden sm:inline">Plays</span><span class="hidden sm:inline mx-1.5"></span><span class="text-white">[</span><span class="mx-0.5"></span><span id="plays-count" class="text-green-500">{plays}</span><span class="mx-0.5"></span><span class="text-white">]</span>
                  </span>
                </div>

                <!-- Likes - Icon, Text, Number -->
                <button 
                  id="like-btn"
                  data-mix-id={id}
                  data-liked="false"
                  class="flex items-center justify-center gap-1 px-2 py-1.5 sm:px-3 sm:py-2 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-red-600 hover:to-red-700 text-white border-2 border-gray-500 hover:border-red-400 transition-all font-black uppercase text-[10px] sm:text-xs md:text-sm rounded-lg shadow-lg cursor-pointer"
                >
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 like-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  <span class="like-text hidden sm:inline">Like</span><span class="liked-text hidden">Liked</span><span class="hidden sm:inline mx-1.5"></span><span class="text-white">[</span><span class="mx-0.5"></span><span id="likes-count" class="text-green-500">{likes}</span><span class="mx-0.5"></span><span class="text-white">]</span>
                </button>

                <!-- Downloads - Icon, Text, Number -->
                <div class="flex items-center justify-center gap-1 bg-gradient-to-r from-gray-700 to-gray-600 px-2 py-1.5 sm:px-3 sm:py-2 border-2 border-gray-500 rounded-lg shadow-lg">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                  </svg>
                  <span class="text-[10px] sm:text-xs md:text-sm font-black text-white truncate">
                    <span class="hidden sm:inline">Downloads</span><span class="hidden sm:inline mx-1.5"></span><span class="text-white">[</span><span class="mx-0.5"></span><span id="downloads-count" class="text-green-500">{downloads}</span><span class="mx-0.5"></span><span class="text-white">]</span>
                  </span>
                </div>
              </div>

              <!-- Action Buttons Row -->
              <div class="grid grid-cols-3 gap-1.5 sm:gap-2">
                <!-- Play Button -->
                <button 
                  id="play-btn"
                  data-mix-id={id}
                  class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-2 sm:px-3 sm:py-2.5 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white border-2 border-white hover:border-green-400 transition-all font-black uppercase text-[10px] sm:text-xs md:text-sm rounded-lg shadow-lg"
                >
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 play-icon flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 pause-icon hidden flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                  </svg>
                  <span class="play-text">Play</span>
                </button>

                <!-- Share Button -->
                <button 
                  id="share-btn"
                  data-mix-id={id}
                  data-title={title}
                  data-dj={dj_name}
                  class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-2 sm:px-3 sm:py-2.5 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-red-600 hover:to-red-700 text-white border-2 border-gray-500 hover:border-red-400 transition-all font-black uppercase text-[10px] sm:text-xs md:text-sm rounded-lg shadow-lg"
                >
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                  </svg>
                  <span>Share</span>
                </button>

                <!-- Download Button -->
                <button 
                  id="download-mix-btn"
                  data-mix-id={id}
                  data-audio-url={audio_url}
                  data-title={title}
                  data-dj={dj_name}
                  class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-2 sm:px-3 sm:py-2.5 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white border-2 border-white hover:border-red-400 transition-all font-black uppercase text-[10px] sm:text-xs md:text-sm rounded-lg shadow-lg"
                >
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 download-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                  </svg>
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 check-icon hidden flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span class="download-text">Download</span>
                </button>
              </div>
            </div>

            <!-- Artwork Column - Bottom Right -->
            <div class="order-2 lg:order-2 flex flex-col items-center lg:items-end lg:justify-end lg:self-end">
              <!-- Artwork -->
              <img 
                src={artwork_url} 
                alt={`${title} by ${dj_name}`}
                class="w-full max-w-[280px] sm:max-w-[320px] lg:w-72 xl:w-80 mx-auto lg:mx-0 border-2 sm:border-4 border-white shadow-2xl"
                onerror="this.src='/logo.webp'"
              />
            </div>
          </div>
        </div>

        <!-- Hidden audio element for duration detection -->
        <audio id="mix-audio" src={audio_url} preload="metadata" class="hidden"></audio>

        <!-- Description Section -->
        {description && (
          <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-2 sm:p-3 md:p-6 mb-3 sm:mb-4 md:mb-6">
            <h2 class="text-base sm:text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-2 sm:mb-3 md:mb-4 pb-2 sm:pb-3 md:pb-4 border-b-2 border-red-600 drop-shadow-lg">
              About This Mix
            </h2>
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded shadow-inner">
              <p class="text-white text-xs sm:text-sm md:text-base font-semibold leading-relaxed whitespace-pre-wrap">
                {description}
              </p>
            </div>
          </div>
        )}

        <!-- Comments Section -->
        <div id="comments-section" class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-2 sm:p-3 md:p-6 mb-3 sm:mb-4 md:mb-6">
          <h2 class="text-base sm:text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-2 sm:mb-3 md:mb-4 pb-2 sm:pb-3 md:pb-4 border-b-2 border-red-600 flex items-center gap-2 drop-shadow-lg">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Comments (<span id="comments-total-count">{comments.length || 0}</span>)
          </h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 md:gap-6">
            <!-- Comment Input -->
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded flex flex-col shadow-lg order-2 lg:order-1" style="min-height: 300px; max-height: 500px;">
              <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase mb-2 sm:mb-3 md:mb-4 flex-shrink-0 drop-shadow-md">Leave a Comment</h3>
              <div class="space-y-2 sm:space-y-3 md:space-y-4 flex-1 flex flex-col">
                <input 
                  type="text" 
                  id="comment-username" 
                  placeholder="Login to comment" 
                  maxlength="30"
                  readonly
                  class="w-full px-2 sm:px-3 md:px-4 py-2 md:py-3 border-2 border-gray-600 bg-gray-800 text-white placeholder-gray-400 focus:outline-none font-semibold rounded flex-shrink-0 cursor-not-allowed text-xs sm:text-sm md:text-base shadow-inner"
                />
                
                <!-- Emoji Grid -->
                <div class="pb-2 md:pb-3 border-b-2 border-gray-600 flex-shrink-0">
                  <p class="text-[10px] sm:text-xs font-black text-gray-300 uppercase tracking-wide mb-1.5 sm:mb-2">Quick Emojis:</p>
                  <div class="grid grid-cols-8 gap-0.5 sm:gap-1 md:gap-2">
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üî•" title="Fire">üî•</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="‚ù§Ô∏è" title="Heart">‚ù§Ô∏è</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üòç" title="Love">üòç</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üéµ" title="Music">üéµ</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üéß" title="Headphones">üéß</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üíØ" title="100">üíØ</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üëç" title="Thumbs up">üëç</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üôå" title="Hands up">üôå</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üí•" title="Boom">üí•</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="‚ö°" title="Lightning">‚ö°</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üéâ" title="Party">üéâ</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üöÄ" title="Rocket">üöÄ</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üîä" title="Speaker">üîä</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üíø" title="CD">üíø</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üé∏" title="Guitar">üé∏</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üéπ" title="Piano">üéπ</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="ü•Å" title="Drums">ü•Å</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üé§" title="Mic">üé§</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üëè" title="Clap">üëè</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üí™" title="Strong">üí™</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="‚ú®" title="Sparkles">‚ú®</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üåü" title="Star">üåü</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="üòé" title="Cool">üòé</button>
                    <button type="button" class="emoji-btn text-base sm:text-lg md:text-2xl hover:scale-110 transition-transform bg-gray-800 hover:bg-red-600 rounded p-0.5 sm:p-1" data-emoji="ü§©" title="Star eyes">ü§©</button>
                  </div>
                </div>
                
                <textarea 
                  id="comment-text" 
                  placeholder="Write your comment... (login required, max 150 characters)" 
                  maxlength="150"
                  rows="3"
                  class="w-full px-2 sm:px-3 md:px-4 py-2 md:py-3 border-2 border-gray-600 bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-600 resize-none font-semibold rounded flex-1 text-xs sm:text-sm md:text-base shadow-inner"
                ></textarea>
                
                <div class="flex items-center justify-between flex-shrink-0">
                  <span class="text-[10px] sm:text-xs md:text-sm text-gray-400 font-bold">
                    <span id="char-count">0</span>/150
                  </span>
                  <button 
                    id="submit-comment-btn" 
                    data-mix-id={id}
                    class="px-3 sm:px-4 md:px-6 py-2 md:py-3 bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 border-2 border-white shadow-lg transition-all font-black uppercase rounded transform hover:scale-105 active:scale-95 text-[10px] sm:text-xs md:text-sm"
                  >
                    Post
                  </button>
                </div>
              </div>
            </div>

            <!-- Comments Output -->
            <div class="bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 p-3 sm:p-4 md:p-5 rounded flex flex-col shadow-lg order-1 lg:order-2" style="min-height: 250px; max-height: 400px;">
              <h3 class="text-sm sm:text-base md:text-lg font-black text-white uppercase mb-2 sm:mb-3 md:mb-4 flex-shrink-0 drop-shadow-md">Recent Comments</h3>
              <div id="comments-list" class="space-y-1.5 sm:space-y-2 md:space-y-3 pr-1 sm:pr-2 flex-1 overflow-y-auto">
                {comments && comments.length > 0 ? (
                  comments.slice(0, 20).map((comment) => (
                    <div class="comment-item p-1.5 sm:p-2 md:p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md">
                      <div class="flex items-start gap-1.5 sm:gap-2 md:gap-3">
                        <div class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg">
                          <span class="text-white font-black text-[10px] sm:text-xs md:text-sm">
                            {(comment.userName || 'A').charAt(0).toUpperCase()}
                          </span>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-start gap-1 sm:gap-2 flex-wrap">
                            <span class="font-black text-white text-[10px] sm:text-xs md:text-sm uppercase drop-shadow-sm">{comment.userName || 'Anonymous'}</span>
                            <span class="text-[10px] sm:text-xs text-gray-400 font-semibold">{new Date(comment.timestamp || comment.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</span>
                          </div>
                          <p class="text-gray-200 font-semibold leading-relaxed text-[10px] sm:text-xs md:text-sm mt-0.5 sm:mt-1 break-words">{comment.comment}</p>
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <p class="text-center text-gray-400 py-6 sm:py-8 font-bold text-xs sm:text-sm md:text-base">No comments yet. Be the first!</p>
                )}
              </div>
            </div>
          </div>
        </div>

        <!-- Tracklist Section - Now After Comments -->
        {tracklist && tracklist.length > 0 && (
          <div class="bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-white shadow-xl p-2 sm:p-3 md:p-6 mb-3 sm:mb-4 md:mb-6">
            <h2 class="text-base sm:text-lg md:text-2xl font-black text-white uppercase tracking-wider mb-2 sm:mb-3 md:mb-4 pb-2 sm:pb-3 md:pb-4 border-b-2 border-red-600 drop-shadow-lg flex items-center gap-2">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
              </svg>
              Tracklist ({tracklist.length} tracks)
            </h2>
            <div class="space-y-1.5 sm:space-y-2 max-h-96 overflow-y-auto pr-2">
              {tracklist.map((track, idx) => (
                <div class="bg-gradient-to-r from-gray-700 to-gray-800 p-2 sm:p-3 rounded border-2 border-gray-600 hover:border-red-600 transition-all">
                  <p class="text-white font-bold text-xs sm:text-sm md:text-base">
                    <span class="text-red-500 mr-1 sm:mr-2 font-black">{idx + 1}.</span>
                    {track}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}

      </div>
    </main>
  )}

  <!-- Share Modal -->
  <div id="share-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-80 transition-opacity" id="share-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-3 sm:p-4">
      <div class="bg-white max-w-md w-full transform transition-all border-4 border-black rounded-lg mx-2">
        <div class="flex items-center justify-between p-3 sm:p-4 border-b-4 border-black">
          <h3 class="text-sm sm:text-base md:text-lg font-black text-black uppercase">Share Mix</h3>
          <button id="share-modal-close" class="text-black hover:text-gray-600 transition-colors p-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-3 sm:p-4">
          <p class="text-xs sm:text-sm text-black font-bold mb-2 sm:mb-3 truncate">
            <span id="share-modal-title"></span> by <span id="share-modal-dj"></span>
          </p>
          <div class="flex gap-1.5 sm:gap-2">
            <input 
              type="text" 
              id="share-url-input" 
              readonly 
              class="flex-1 px-2 sm:px-3 py-2 border-2 border-black text-[10px] sm:text-xs md:text-sm font-mono bg-gray-100 text-black focus:outline-none focus:ring-2 focus:ring-black rounded min-w-0"
            />
            <button 
              id="copy-url-button" 
              class="px-2 sm:px-3 md:px-4 py-2 bg-black hover:bg-gray-800 text-white border-2 border-black transition-all font-black text-[10px] sm:text-xs md:text-sm flex items-center gap-1 sm:gap-2 uppercase rounded flex-shrink-0"
            >
              <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <span class="hidden sm:inline">Copy</span>
            </button>
          </div>
          <p class="text-[10px] sm:text-xs text-gray-600 font-bold mt-1.5 sm:mt-2" id="copy-feedback"></p>
        </div>
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<style>
  #like-btn[data-liked="true"] .like-icon {
    fill: #dc2626;
    stroke: #dc2626;
  }

  #like-btn[data-liked="true"] .like-text {
    display: none !important;
  }

  #like-btn[data-liked="true"] .liked-text {
    display: inline !important;
  }

  .emoji-btn {
    background: none;
    border: none;
    cursor: pointer;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .emoji-btn:hover {
    background: rgba(220, 38, 38, 0.8);
  }

  .emoji-btn:active {
    transform: scale(0.9);
  }

  #comments-list::-webkit-scrollbar {
    width: 4px;
  }

  #comments-list::-webkit-scrollbar-track {
    background: #374151;
    border-radius: 2px;
  }

  #comments-list::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 2px;
  }

  #comments-list::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }

  /* Mobile touch improvements */
  @media (max-width: 640px) {
    .emoji-btn {
      min-width: 28px;
      min-height: 28px;
    }
    
    button, a {
      -webkit-tap-highlight-color: transparent;
    }
  }
</style>

<script is:inline define:vars={{ mixId: id, mixTitle: title, mixDj: dj_name, mixArtwork: artwork_url, mixAudioUrl: audio_url }}>
  // Mix data for global player
  const mixData = {
    id: mixId,
    title: mixTitle,
    dj_name: mixDj,
    artwork_url: mixArtwork,
    audio_url: mixAudioUrl
  };

  const audio = document.getElementById('mix-audio');
  const playBtn = document.getElementById('play-btn');
  const playIcon = playBtn?.querySelector('.play-icon');
  const pauseIcon = playBtn?.querySelector('.pause-icon');
  const playText = playBtn?.querySelector('.play-text');
  const likeBtn = document.getElementById('like-btn');
  const downloadBtn = document.getElementById('download-mix-btn');

  // Check URL hash for comments anchor
  if (window.location.hash === '#comments-section') {
    setTimeout(function() {
      const commentsSection = document.getElementById('comments-section');
      if (commentsSection) {
        commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 500);
  }

  // Check if this mix is currently playing in global player
  function isThisMixPlaying() {
    return window.FreshWaxPlayer?.currentMix?.id === mixId;
  }

  // Listen to global audio events for play button state
  if (window.globalAudio) {
    window.globalAudio.addEventListener('play', function() {
      if (isThisMixPlaying()) {
        updatePlayButton(true);
      }
    });
    window.globalAudio.addEventListener('pause', function() {
      if (isThisMixPlaying()) {
        updatePlayButton(false);
      }
    });
    window.globalAudio.addEventListener('ended', function() {
      if (isThisMixPlaying()) {
        updatePlayButton(false);
      }
    });
  }

  // Check if this mix is already playing when page loads
  if (isThisMixPlaying() && window.globalAudio) {
    updatePlayButton(!window.globalAudio.paused);
  }

  // Update duration display in info grid when metadata loads (only if not already set from Firebase)
  audio?.addEventListener('loadedmetadata', function() {
    const durationDisplay = document.getElementById('mix-duration-display');
    // Only update if currently showing placeholder
    if (durationDisplay && durationDisplay.textContent === '--:--' && audio.duration && isFinite(audio.duration)) {
      const totalMins = Math.floor(audio.duration / 60);
      const hours = Math.floor(totalMins / 60);
      const mins = totalMins % 60;
      
      if (hours > 0) {
        const hourWord = hours === 1 ? 'hour' : 'hours';
        const minWord = mins === 1 ? 'minute' : 'minutes';
        durationDisplay.textContent = hours + ' ' + hourWord + ' ' + mins + ' ' + minWord;
      } else {
        const minWord = mins === 1 ? 'minute' : 'minutes';
        durationDisplay.textContent = mins + ' ' + minWord;
      }
    }
  });

  // Play/Pause - using global player
  function updatePlayButton(isPlaying) {
    if (isPlaying) {
      playIcon?.classList.add('hidden');
      pauseIcon?.classList.remove('hidden');
      if (playText) playText.textContent = 'Pause';
    } else {
      playIcon?.classList.remove('hidden');
      pauseIcon?.classList.add('hidden');
      if (playText) playText.textContent = 'Play';
    }
  }

  playBtn?.addEventListener('click', function() {
  // *** PAUSE SHUFFLE WIDGET IF PLAYING ***
  if (window.shuffleWidgetAudio && !window.shuffleWidgetAudio.paused) {
    window.shuffleWidgetAudio.pause();
    console.log('[DJ-MIX] Paused shuffle widget');
    
    var shuffleWidget = document.getElementById('shuffle-widget');
    if (shuffleWidget) shuffleWidget.classList.remove('playing');
    
    var shuffleIconPlay = document.getElementById('shuffle-icon-play');
    var shuffleIconPause = document.getElementById('shuffle-icon-pause');
    var shuffleCtrlPlay = document.getElementById('shuffle-ctrl-play-icon');
    var shuffleCtrlPause = document.getElementById('shuffle-ctrl-pause-icon');
    
    if (shuffleIconPlay) shuffleIconPlay.classList.remove('hidden');
    if (shuffleIconPause) shuffleIconPause.classList.add('hidden');
    if (shuffleCtrlPlay) shuffleCtrlPlay.classList.remove('hidden');
    if (shuffleCtrlPause) shuffleCtrlPause.classList.add('hidden');
  }

  if (window.playMix && window.globalAudio) {
    const isThisMix = window.FreshWaxPlayer?.currentMix?.id === mixId;
    
    if (isThisMix) {
      if (window.globalAudio.paused) {
        window.globalAudio.play().then(function() {
          updatePlayButton(true);
        });
      } else {
        window.globalAudio.pause();
        updatePlayButton(false);
      }
    } else {
      window.playMix(mixData).then(function() {
        updatePlayButton(true);
        
        if (!window.FreshWaxPlayer.hasTrackedPlay) {
          window.FreshWaxPlayer.hasTrackedPlay = true;
          fetch('/api/track-mix-play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mixId: mixId })
          }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.plays !== undefined) {
              var playsCount = document.getElementById('plays-count');
              if (playsCount) playsCount.textContent = data.plays;
            }
          });
        }
      });
    }
  }
});
  // Like button
  if (likeBtn && mixId) {
    const likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
    const likeText = likeBtn.querySelector('.like-text');
    const likedText = likeBtn.querySelector('.liked-text');
    
    if (likedMixes.includes(mixId)) {
      likeBtn.setAttribute('data-liked', 'true');
      if (likeText) likeText.style.display = 'none';
      if (likedText) likedText.style.display = 'inline';
    }
    
    likeBtn.addEventListener('click', function() {
      const isLiked = likeBtn.getAttribute('data-liked') === 'true';
      const likesCount = document.getElementById('likes-count');
      
      if (isLiked) {
        likeBtn.setAttribute('data-liked', 'false');
        if (likeText) likeText.style.display = 'inline';
        if (likedText) likedText.style.display = 'none';
        const likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
        const index = likedMixes.indexOf(mixId);
        if (index > -1) {
          likedMixes.splice(index, 1);
          localStorage.setItem('liked-mixes', JSON.stringify(likedMixes));
        }
        fetch('/api/track-mix-unlike', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mixId: mixId })
        }).then(function(response) {
          return response.json();
        }).then(function(data) {
          if (data.likes !== undefined && likesCount) {
            likesCount.textContent = data.likes;
          }
        }).catch(function(error) {
          console.error('Error tracking unlike:', error);
        });
      } else {
        likeBtn.setAttribute('data-liked', 'true');
        if (likeText) likeText.style.display = 'none';
        if (likedText) likedText.style.display = 'inline';
        const likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
        if (!likedMixes.includes(mixId)) {
          likedMixes.push(mixId);
          localStorage.setItem('liked-mixes', JSON.stringify(likedMixes));
        }
        fetch('/api/track-mix-like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mixId: mixId })
        }).then(function(response) {
          return response.json();
        }).then(function(data) {
          if (data.likes !== undefined && likesCount) {
            likesCount.textContent = data.likes;
          }
        }).catch(function(error) {
          console.error('Error tracking like:', error);
        });
      }
    });
  }

  // Download button - simplified without progress bar
  downloadBtn?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const audioUrl = downloadBtn.getAttribute('data-audio-url');
    const title = downloadBtn.getAttribute('data-title');
    const dj = downloadBtn.getAttribute('data-dj');
    const filename = (dj + ' - ' + title + '.mp3').replace(/[^a-z0-9\s\-\.]/gi, '_');
    
    const downloadIcon = downloadBtn.querySelector('.download-icon');
    const checkIcon = downloadBtn.querySelector('.check-icon');
    const downloadText = downloadBtn.querySelector('.download-text');
    
    downloadBtn.disabled = true;
    downloadBtn.classList.add('opacity-75', 'cursor-not-allowed');
    if (downloadText) downloadText.textContent = 'Downloading...';
    
    // Track download
    if (mixId) {
      fetch('/api/track-mix-download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(response) {
        return response.json();
      }).then(function(data) {
        if (data.downloads !== undefined) {
          const downloadsCount = document.getElementById('downloads-count');
          if (downloadsCount) downloadsCount.textContent = data.downloads;
        }
      }).catch(function(error) {
        console.error('Error tracking download:', error);
      });
    }
    
    var proxyUrl = '/api/download-mix?url=' + encodeURIComponent(audioUrl) + '&filename=' + encodeURIComponent(filename);
    
    var a = document.createElement('a');
    a.href = proxyUrl;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    
    setTimeout(function() {
      document.body.removeChild(a);
    }, 100);
    
    // Wait 10 seconds then show "Please wait..."
    setTimeout(function() {
      if (downloadText) downloadText.textContent = 'Please wait...';
    }, 10000);
    
    // Wait 10 more seconds then show "Cleaning up..."
    setTimeout(function() {
      if (downloadText) downloadText.textContent = 'Cleaning up...';
    }, 20000);
    
    // Return to normal state after 30 seconds total
    setTimeout(function() {
      downloadIcon?.classList.remove('hidden');
      checkIcon?.classList.add('hidden');
      if (downloadText) downloadText.textContent = 'Download';
      downloadBtn.disabled = false;
      downloadBtn.classList.remove('opacity-75', 'cursor-not-allowed');
    }, 30000);
  });

  // Share button
  const shareBtn = document.getElementById('share-btn');
  const shareModal = document.getElementById('share-modal');
  const shareModalClose = document.getElementById('share-modal-close');
  const shareModalBackdrop = document.getElementById('share-modal-backdrop');
  const shareUrlInput = document.getElementById('share-url-input');
  const copyUrlButton = document.getElementById('copy-url-button');
  const copyFeedback = document.getElementById('copy-feedback');

  shareBtn?.addEventListener('click', function() {
    const title = shareBtn.getAttribute('data-title');
    const dj = shareBtn.getAttribute('data-dj');
    const shareUrl = window.location.href;
    
    const shareModalTitle = document.getElementById('share-modal-title');
    const shareModalDj = document.getElementById('share-modal-dj');
    
    if (shareModalTitle) shareModalTitle.textContent = title;
    if (shareModalDj) shareModalDj.textContent = dj;
    if (shareUrlInput) shareUrlInput.value = shareUrl;
    
    shareModal?.classList.remove('hidden');
  });

  shareModalClose?.addEventListener('click', function() {
    shareModal?.classList.add('hidden');
  });

  shareModalBackdrop?.addEventListener('click', function() {
    shareModal?.classList.add('hidden');
  });

  copyUrlButton?.addEventListener('click', function() {
    navigator.clipboard.writeText(shareUrlInput.value).then(function() {
      if (copyFeedback) {
        copyFeedback.textContent = '‚úì Copied!';
        copyFeedback.style.color = '#16a34a';
      }
      setTimeout(function() {
        if (copyFeedback) copyFeedback.textContent = '';
      }, 2000);
    }).catch(function(err) {
      if (copyFeedback) {
        copyFeedback.textContent = '‚úó Failed';
        copyFeedback.style.color = '#dc2626';
      }
    });
  });

  // Comments functionality
  const commentUsername = document.getElementById('comment-username');
  const commentText = document.getElementById('comment-text');
  const charCount = document.getElementById('char-count');
  const submitCommentBtn = document.getElementById('submit-comment-btn');
  const commentsList = document.getElementById('comments-list');
  const commentsTotalCount = document.getElementById('comments-total-count');

  // Check for logged-in user
  let currentUser = null;
  let currentUserName = null;

  // Initialize Firebase Auth listener
  import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js').then(async function(firebaseApp) {
    const initializeApp = firebaseApp.initializeApp;
    const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const getAuth = firebaseAuth.getAuth;
    const onAuthStateChanged = firebaseAuth.onAuthStateChanged;
    const firebaseFirestore = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    const getFirestore = firebaseFirestore.getFirestore;
    const doc = firebaseFirestore.doc;
    const getDoc = firebaseFirestore.getDoc;
    
    const firebaseConfig = {
      apiKey: "AIzaSyD_EavofrRMa2Evmk9yB1RCsoVPEfYKm08",
      authDomain: "fresh-wax.firebaseapp.com",
      projectId: "fresh-wax",
      storageBucket: "fresh-wax.firebasestorage.app",
      messagingSenderId: "1096034072554",
      appId: "1:1096034072554:web:60aaee1d44093689867a12"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    onAuthStateChanged(auth, async function(user) {
      if (user) {
        currentUser = user;
        try {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            currentUserName = userData.displayName || userData.username || user.displayName || user.email?.split('@')[0] || 'User';
          } else {
            currentUserName = user.displayName || user.email?.split('@')[0] || 'User';
          }
        } catch (err) {
          currentUserName = user.displayName || user.email?.split('@')[0] || 'User';
        }
        
        if (commentUsername) {
          commentUsername.value = currentUserName;
          commentUsername.classList.remove('cursor-not-allowed');
          commentUsername.classList.add('cursor-default');
        }
        console.log('[Comments] User logged in:', currentUserName);
      } else {
        currentUser = null;
        currentUserName = null;
        if (commentUsername) {
          commentUsername.value = '';
          commentUsername.placeholder = 'Login to comment';
          commentUsername.classList.add('cursor-not-allowed');
          commentUsername.classList.remove('cursor-default');
        }
        console.log('[Comments] User not logged in');
      }
    });
  }).catch(function(err) {
    console.error('[Comments] Firebase init error:', err);
  });

  // Character count
  commentText?.addEventListener('input', function() {
    if (charCount) {
      charCount.textContent = commentText.value.length;
    }
  });

  // Emoji buttons
  document.querySelectorAll('.emoji-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const emoji = btn.getAttribute('data-emoji');
      if (commentText && emoji) {
        const start = commentText.selectionStart;
        const end = commentText.selectionEnd;
        const text = commentText.value;
        commentText.value = text.substring(0, start) + emoji + text.substring(end);
        commentText.focus();
        commentText.selectionStart = commentText.selectionEnd = start + emoji.length;
        if (charCount) {
          charCount.textContent = commentText.value.length;
        }
      }
    });
  });

  // Submit comment
  submitCommentBtn?.addEventListener('click', function() {
    if (!currentUser) {
      alert('Please login to post a comment');
      return;
    }
    
    const userName = currentUserName || commentUsername?.value?.trim();
    const comment = commentText?.value?.trim();
    
    if (!userName) {
      alert('Please login to comment');
      return;
    }
    
    if (!comment) {
      alert('Please enter a comment');
      commentText?.focus();
      return;
    }
    
    submitCommentBtn.disabled = true;
    submitCommentBtn.textContent = 'Posting...';
    
    fetch('/api/add-mix-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        mixId: mixId,
        userName: userName,
        comment: comment,
        userId: currentUser.uid
      })
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      if (data.success) {
        const newCommentHtml = '<div class="comment-item p-1.5 sm:p-2 md:p-3 bg-gradient-to-r from-gray-600 to-gray-700 border-2 border-gray-500 hover:border-red-600 transition-all rounded shadow-md"><div class="flex items-start gap-1.5 sm:gap-2 md:gap-3"><div class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-red-600 to-red-800 flex items-center justify-center flex-shrink-0 border-2 border-white shadow-lg"><span class="text-white font-black text-[10px] sm:text-xs md:text-sm">' + userName.charAt(0).toUpperCase() + '</span></div><div class="flex-1 min-w-0"><div class="flex items-start gap-1 sm:gap-2 flex-wrap"><span class="font-black text-white text-[10px] sm:text-xs md:text-sm uppercase drop-shadow-sm">' + userName + '</span><span class="text-[10px] sm:text-xs text-gray-400 font-semibold">Just now</span></div><p class="text-gray-200 font-semibold leading-relaxed text-[10px] sm:text-xs md:text-sm mt-0.5 sm:mt-1 break-words">' + comment + '</p></div></div></div>';
        
        const noCommentsMsg = commentsList?.querySelector('.text-center');
        if (noCommentsMsg) {
          noCommentsMsg.remove();
        }
        
        if (commentsList) {
          commentsList.insertAdjacentHTML('afterbegin', newCommentHtml);
        }
        
        if (commentsTotalCount) {
          commentsTotalCount.textContent = data.commentCount || (parseInt(commentsTotalCount.textContent) + 1);
        }
        
        if (commentText) {
          commentText.value = '';
          if (charCount) charCount.textContent = '0';
        }
        
      } else {
        alert(data.error || 'Failed to post comment');
      }
    }).catch(function(error) {
      console.error('Error posting comment:', error);
      alert('Failed to post comment. Please try again.');
    }).finally(function() {
      submitCommentBtn.disabled = false;
      submitCommentBtn.textContent = 'Post';
    });
  });
</script>