---
// src/pages/crates.astro
// Vinyl marketplace - public browsing page
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PageLoader from '../components/PageLoader.astro';

export const prerender = false;

const faqs = [
  {
    question: "What is Fresh Wax Crates?",
    answer: "Crates is our vinyl marketplace where record shops, collectors, and stockists can list their vinyl for sale. Browse records with detailed info on condition, price, and audio samples."
  },
  {
    question: "How does buying from Crates work?",
    answer: "Just like buying a new release - add to bag, checkout, and the stockist ships directly to you. Each listing shows the seller, condition grading, and any notes about the record."
  },
  {
    question: "What condition grading system do you use?",
    answer: "We use the standard Goldmine grading system: Mint (M), Near Mint (NM), Very Good Plus (VG+), Very Good (VG), Good (G), and Fair (F). Each listing includes detailed condition notes."
  }
];
---

<Layout
  title="Crates - Vinyl Marketplace"
  description="Buy vinyl on Fresh Wax Crates. Browse records from stockists and collectors with detailed condition grades, audio samples, and direct checkout."
  faqs={faqs}
>
  <PageLoader />
  <Header />

  <main class="crates-main">
    <!-- Background -->
    <div class="bg-overlay"></div>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-grid"></div>
      <div class="hero-container">
        <div class="hero-content">
          <h1 class="hero-title">DIG THE <span class="red">CRATES</span></h1>
          <p class="hero-subtitle">Vinyl marketplace for stockists, shops & collectors</p>
        </div>
      </div>
    </section>

    <!-- Main Content with Sidebar -->
    <div class="crates-layout">
      <!-- Collections Sidebar - Desktop -->
      <aside class="collections-sidebar">
        <div class="sidebar-inner">
          <div class="sidebar-header">
            <div class="sidebar-title">Collections</div>
            <p class="sidebar-subtitle" id="collectionCount">Loading...</p>
          </div>
          <div class="sidebar-red-border"></div>

          <nav class="collection-nav" id="collectionNav">
            <button class="collection-nav-btn active" data-collection="all">
              <div class="collection-nav-content">
                <span class="collection-name">All Vinyl</span>
                <span class="collection-count" id="allCount">0</span>
              </div>
              <svg class="collection-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>

            <button class="collection-nav-btn deals-btn" data-collection="deals">
              <div class="collection-nav-content">
                <span class="collection-name">ðŸ”¥ Special Deals</span>
                <span class="collection-count deals-badge" id="dealsCount">0</span>
              </div>
              <svg class="collection-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>

            <div class="sidebar-divider"></div>

            <div id="sellerCollections">
              <div class="loading-text">Loading collections...</div>
            </div>
          </nav>
        </div>
      </aside>

      <!-- Main Listings Content -->
      <section class="listings-section">
        <!-- Header -->
        <div class="section-header-card">
          <div class="section-header-pattern"></div>
          <div class="section-header-content">
            <h2 class="section-title" id="sectionTitle">All Vinyl Collections</h2>
            <p class="section-subtitle">
              <span id="listingCount">0</span> records available
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="condition-guide-btn" id="conditionKeyToggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Condition Guide
          </button>
          <a href="/artist/vinyl" class="sell-btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Sell Your Vinyl
          </a>
        </div>

        <!-- Condition Guide Modal -->
        <div class="condition-modal" id="conditionModal">
          <div class="condition-modal-content">
            <div class="condition-modal-header">
              <h3>Condition Guide</h3>
              <button class="condition-modal-close" id="conditionModalClose">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="condition-grades">
              <div class="grade"><span class="grade-abbr">M</span><span class="grade-name">Mint</span><span class="grade-desc">Perfect, unplayed condition</span></div>
              <div class="grade"><span class="grade-abbr">NM</span><span class="grade-name">Near Mint</span><span class="grade-desc">Nearly perfect, minimal signs of handling</span></div>
              <div class="grade"><span class="grade-abbr">VG+</span><span class="grade-name">Very Good Plus</span><span class="grade-desc">Shows some wear but plays great</span></div>
              <div class="grade"><span class="grade-abbr">VG</span><span class="grade-name">Very Good</span><span class="grade-desc">Surface noise evident, still enjoyable</span></div>
              <div class="grade"><span class="grade-abbr">G+</span><span class="grade-name">Good Plus</span><span class="grade-desc">Significant wear, plays through</span></div>
              <div class="grade"><span class="grade-abbr">G</span><span class="grade-name">Good</span><span class="grade-desc">Heavy wear, surface noise throughout</span></div>
              <div class="grade"><span class="grade-abbr">F</span><span class="grade-name">Fair</span><span class="grade-desc">Plays but with issues, for collectors only</span></div>
            </div>
            <p class="condition-note">Conditions shown as: Media / Sleeve</p>
          </div>
        </div>

        <!-- Mobile Collection Filter -->
        <div class="collection-filter-mobile">
          <div class="filter-scroll" id="mobileFilters">
            <button class="filter-btn active" data-collection="all">All</button>
            <button class="filter-btn deals-filter" data-collection="deals">ðŸ”¥ Deals</button>
          </div>
        </div>

        <!-- Listings Grid -->
        <div class="listings-grid" id="listingsGrid">
          <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading vinyl...</p>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
          <div class="empty-icon">ðŸ“¦</div>
          <h3>No Vinyl Found</h3>
          <p>Check back soon for new listings!</p>
        </div>
      </section>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  /* Page Entrance Animations */
  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeSlideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Main Container */
  .crates-main {
    min-height: 100vh;
    position: relative;
  }

  .bg-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
    z-index: -1;
  }

  /* Hero Section */
  .hero-section {
    background: linear-gradient(to bottom, #000000 0%, #1a1a1a 50%, #2d2d2d 100%);
    color: white;
    padding: 3rem 0;
    position: relative;
    overflow: hidden;
    z-index: 10;
    border-bottom: 4px solid #dc2626;
    animation: fadeSlideUp 0.6s ease-out 0.1s both;
  }

  .hero-grid {
    position: absolute;
    inset: 0;
    background-image: linear-gradient(rgba(220, 38, 38, 0.03) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(220, 38, 38, 0.03) 1px, transparent 1px);
    background-size: 50px 50px;
  }

  .hero-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    text-align: center;
    position: relative;
    z-index: 10;
  }

  .hero-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3rem;
    font-weight: 400;
    margin: 0;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    animation: fadeSlideUp 0.6s ease-out 0.2s both;
  }

  .hero-title .red {
    color: #dc2626;
  }

  .hero-subtitle {
    font-size: 0.9rem;
    color: #9ca3af;
    font-weight: 400;
    letter-spacing: 0.15em;
    margin: 0.75rem 0 0 0;
    text-transform: uppercase;
    animation: fadeSlideUp 0.5s ease-out 0.3s both;
  }

  @media (min-width: 640px) {
    .hero-section { padding: 4rem 0; }
    .hero-title { font-size: 4.5rem; }
    .hero-subtitle { font-size: 1rem; letter-spacing: 0.2em; }
  }

  @media (min-width: 1024px) {
    .hero-section { padding: 5rem 0; }
    .hero-title { font-size: 5.5rem; }
    .hero-subtitle { font-size: 1.1rem; letter-spacing: 0.25em; }
  }

  /* Layout - matches releases.astro */
  .crates-layout {
    display: flex;
    min-height: 100vh;
    background: #000;
  }

  /* Sidebar - matches releases.astro */
  .collections-sidebar {
    width: 320px;
    flex-shrink: 0;
    background: linear-gradient(to bottom, #1f2937, #111827);
    border-right: 2px solid #fff;
    position: sticky;
    top: 73px;
    height: calc(100vh - 73px);
    overflow-y: auto;
    display: none;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  @media (min-width: 1024px) {
    .collections-sidebar { display: block; }
  }

  .sidebar-inner {
    padding: 1.5rem;
  }

  .sidebar-header {
    margin-bottom: 1.5rem;
    padding-top: 1.5rem;
    padding-bottom: 1.5rem;
    border-top: 2px solid #dc2626;
    border-bottom: 2px solid #dc2626;
  }

  .sidebar-red-border {
    display: none;
  }

  .sidebar-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    font-weight: 900;
    color: #fff;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .sidebar-subtitle {
    font-size: 0.875rem;
    color: #9ca3af;
    margin: 0;
  }

  .sidebar-divider {
    height: 1px;
    background: #374151;
    margin: 0.5rem 0;
  }

  .collection-nav {
    padding: 0.75rem;
    max-height: calc(100vh - 280px);
    overflow-y: auto;
  }

  .collection-nav-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1rem;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 0.25rem;
  }

  .collection-nav-btn:hover {
    background: rgba(220, 38, 38, 0.1);
  }

  .collection-nav-btn.active {
    background: rgba(220, 38, 38, 0.15);
    border-left: 3px solid #dc2626;
  }

  .collection-nav-btn.deals-btn {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
  }

  .collection-nav-btn.deals-btn:hover {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
  }

  .collection-nav-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .collection-name {
    color: #fff;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: left;
  }

  .collection-count {
    background: rgba(255, 255, 255, 0.1);
    color: #9ca3af;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 10px;
  }

  .collection-count.deals-badge {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
  }

  .collection-arrow {
    width: 16px;
    height: 16px;
    color: #6b7280;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .collection-nav-btn:hover .collection-arrow,
  .collection-nav-btn.active .collection-arrow {
    opacity: 1;
    color: #dc2626;
  }

  .loading-text {
    text-align: center;
    padding: 1rem;
    color: #6b7280;
    font-size: 0.85rem;
  }

  /* Main Content - matches releases.astro */
  .listings-section {
    flex: 1;
    min-width: 0;
    padding: 2rem 1rem 2rem 2rem;
  }

  @media (min-width: 640px) {
    .listings-section {
      padding: 2rem 1.5rem 2rem 2rem;
    }
  }

  @media (min-width: 1024px) {
    .listings-section {
      padding: 3rem 2rem;
    }
  }

  @media (max-width: 1023px) {
    .listings-section {
      padding: 1.5rem 1rem;
    }
  }

  .listings-inner {
    max-width: 1100px;
    margin: 0 auto;
  }

  .action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .condition-guide-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #374151;
    color: #9ca3af;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .condition-guide-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #dc2626;
    color: #fff;
  }

  .sell-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #dc2626, #991b1b);
    color: #fff;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .sell-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
  }

  /* Mobile Filters */
  .collection-filter-mobile {
    display: block;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  @media (min-width: 1024px) {
    .collection-filter-mobile { display: none; }
  }

  /* Condition Modal */
  .condition-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .condition-modal.open {
    display: flex;
  }

  .condition-modal-content {
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .condition-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #374151;
  }

  .condition-modal-header h3 {
    color: #fff;
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
  }

  .condition-modal-close {
    background: transparent;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 0.25rem;
    transition: color 0.2s;
  }

  .condition-modal-close:hover {
    color: #fff;
  }

  .condition-grades {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
  }

  .grade {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 1rem 0.75rem;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #374151;
    border-radius: 8px;
    transition: border-color 0.2s;
  }

  .grade:hover {
    border-color: #dc2626;
  }

  .grade-abbr {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    margin-bottom: 0.5rem;
    background: #dc2626;
    color: #000;
    font-weight: 800;
    font-size: 0.9rem;
    border-radius: 8px;
  }

  .grade-name {
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
  }

  .grade-desc {
    color: #6b7280;
    font-size: 0.7rem;
    line-height: 1.3;
  }

  .condition-note {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid #374151;
    color: #6b7280;
    font-size: 0.75rem;
    font-style: italic;
    text-align: center;
  }

  @media (max-width: 1024px) {
    .condition-grades {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 768px) {
    .condition-grades {
      grid-template-columns: repeat(3, 1fr);
    }

    .grade {
      padding: 0.75rem 0.5rem;
    }

    .grade-abbr {
      width: 36px;
      height: 36px;
      font-size: 0.8rem;
    }

    .grade-desc {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .condition-grades {
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }

    .grade {
      padding: 0.5rem 0.25rem;
    }

    .grade-abbr {
      width: 32px;
      height: 32px;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .grade-name {
      font-size: 0.7rem;
    }
  }

  .filter-scroll {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    -webkit-overflow-scrolling: touch;
  }

  .filter-btn {
    flex-shrink: 0;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #374151;
    border-radius: 20px;
    color: #9ca3af;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .filter-btn:hover, .filter-btn.active {
    background: rgba(220, 38, 38, 0.15);
    border-color: #dc2626;
    color: #fff;
  }

  .filter-btn.deals-filter {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.3);
    color: #22c55e;
  }


  /* Listings Grid */
  .listings-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
  }

  .loading-state {
    text-align: center;
    padding: 3rem;
    color: #9ca3af;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #374151;
    border-top-color: #dc2626;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    color: #fff;
    font-size: 1.5rem;
    margin: 0 0 0.5rem 0;
  }

  .empty-state p {
    color: #9ca3af;
    margin: 0;
  }
</style>

<style is:global>
  /* Collection Box Styles - Global for JS-generated content */
  .collection-box {
    width: 100%;
    display: block;
    background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
    border: 1px solid #374151;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .collection-box:hover {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(220, 38, 38, 0.08));
    border-color: #dc2626;
    transform: translateX(4px);
  }

  .collection-box.active {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(220, 38, 38, 0.1));
    border-color: #dc2626;
    border-left: 3px solid #dc2626;
  }

  .collection-box-inner {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    text-align: left;
    width: 100%;
  }

  .collection-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    font-weight: 400;
    color: #dc2626;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .collection-store {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
  }

  .collection-box:hover .collection-store {
    color: #fff;
  }

  .collection-box:hover .collection-number {
    color: #ef4444;
  }

  /* Vinyl Card Styles - Global for JS-generated content */
  /* ReleasePlate-style 3-column layout */
  .vinyl-card {
    background: linear-gradient(to bottom, #1f2937 0%, #111827 100%);
    border-radius: 0.5rem;
    overflow: hidden;
    border: 2px solid #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    padding: 1.5rem;
    margin-bottom: 0;
    width: 100%;
  }

  .vinyl-card:hover {
    border-color: #dc2626;
    box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.5), 0 0 25px rgba(220, 38, 38, 0.2);
  }

  /* Red divider line between releases */
  .release-divider {
    height: 3px;
    background: #dc2626;
    margin: 1.5rem 0;
    width: 100%;
  }

  /* Seller Section Headers */
  .seller-section {
    margin-bottom: 4rem;
    scroll-margin-top: 6rem;
  }

  .seller-header {
    margin-bottom: 1.5rem;
  }

  .seller-header-inner {
    display: inline-flex;
    flex-direction: column;
    background: #000;
    border-left: 4px solid #dc2626;
    padding: 0.75rem 1.5rem 0.75rem 1rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
  }

  .seller-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    font-weight: 900;
    color: #fff;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin: 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    line-height: 1.2;
  }

  .seller-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    font-weight: 400;
    color: #dc2626;
    letter-spacing: 0.05em;
    margin: 0.25rem 0 0 0;
  }

  .seller-listings {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .show-more-container {
    display: flex;
    justify-content: center;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .show-more-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid #dc2626;
    color: #dc2626;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .show-more-btn:hover {
    background: #dc2626;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
  }

  .show-more-btn svg {
    transition: transform 0.2s;
  }

  .show-more-btn:hover svg {
    transform: translateY(2px);
  }

  @media (min-width: 640px) {
    .seller-name {
      font-size: 2rem;
    }
    .seller-count {
      font-size: 1.1rem;
    }
  }

  @media (min-width: 768px) {
    .seller-name {
      font-size: 2.25rem;
    }
    .seller-count {
      font-size: 1.15rem;
    }
  }

  /* Main 3-column layout */
  .vinyl-card-inner {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .vinyl-card-inner {
      flex-direction: row;
      gap: 1.5rem;
    }
  }

  /* LEFT COLUMN: Artwork + Buttons */
  .vinyl-left-col {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .vinyl-left-col {
      width: 256px;
    }
  }

  .vinyl-artwork {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  }

  @media (min-width: 768px) {
    .vinyl-artwork {
      width: 256px;
      height: 256px;
      aspect-ratio: auto;
    }
  }

  .vinyl-artwork img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .vinyl-artwork-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    background: linear-gradient(135deg, #1f2937, #111827);
    color: #4b5563;
  }

  .sale-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: #fff;
    font-size: 0.85rem;
    font-weight: 700;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    z-index: 5;
  }

  /* Buy buttons row - matches ReleasePlate */
  .vinyl-buttons {
    display: flex;
    gap: 0.5rem;
    width: 256px;
  }

  .vinyl-buy-btn {
    flex: 1;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #16a34a;
    border: 2px solid #16a34a;
    border-radius: 0.5rem;
    color: #fff;
    font-size: 0.875rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .vinyl-buy-btn:hover {
    background: #166534;
    border-color: #166534;
  }

  .vinyl-buy-btn svg {
    width: 20px;
    height: 20px;
    color: #fff;
  }

  .vinyl-buy-btn .btn-price {
    color: #fff;
    font-weight: 700;
  }

  .vinyl-view-btn {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    background: #dc2626;
    border: none;
    border-radius: 0.5rem;
    color: #fff;
    font-size: 0.875rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .vinyl-view-btn:hover {
    background: #b91c1c;
  }

  .vinyl-view-btn svg {
    width: 16px;
    height: 16px;
  }


  /* MIDDLE COLUMN: Details */
  .vinyl-middle-col {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 0.6rem;
    overflow: hidden;
  }

  .vinyl-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    font-weight: 400;
    color: #dc2626;
    margin: 0;
    text-transform: uppercase;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media (min-width: 900px) {
    .vinyl-title { font-size: 2.5rem; }
  }

  .vinyl-artist {
    font-size: 1.35rem;
    font-weight: 600;
    color: #fff;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .vinyl-seller-line {
    font-size: 1rem;
    color: #9ca3af;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .vinyl-seller-line span {
    color: #fff;
  }

  /* Tags row */
  .vinyl-tags-row {
    display: flex;
    gap: 0.6rem;
    flex-wrap: nowrap;
    align-items: center;
    margin: 0.75rem 0 0.5rem 0;
    overflow: hidden;
  }

  .vinyl-tag {
    font-size: 0.9rem;
    padding: 0.4rem 0.75rem;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 6px;
    color: #d1d5db;
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* Conditions row */
  .vinyl-conditions-row {
    display: flex;
    gap: 0.6rem;
    flex-wrap: nowrap;
    align-items: center;
    margin-bottom: 0.5rem;
    overflow: hidden;
  }

  /* Meta footer (wishlist + track count) */
  .vinyl-meta-footer {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-top: 0.75rem;
    font-size: 0.95rem;
    color: #9ca3af;
  }

  .wishlist-link {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    transition: color 0.15s;
  }

  .wishlist-link:hover {
    color: #dc2626;
  }

  .wishlist-link svg {
    width: 18px;
    height: 18px;
    color: #dc2626;
  }

  .track-count-label {
    color: #6b7280;
  }

  /* Inline Condition Badges */
  .condition-badge-inline {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .condition-badge-inline .cond-label {
    color: #6b7280;
    text-transform: uppercase;
    font-size: 0.7rem;
  }

  .condition-badge-inline .cond-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 22px;
    padding: 0 0.3rem;
    color: #000;
    font-weight: 700;
    font-size: 0.75rem;
    border-radius: 4px;
  }

  .condition-badge-inline .cond-name {
    color: #d1d5db;
    font-weight: 500;
  }

  /* RIGHT COLUMN: Tracklist + Waveform */
  .vinyl-right-col {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: rgba(31, 41, 55, 0.6);
    border: 1px solid #374151;
    border-radius: 0.5rem;
    padding: 1rem;
    min-width: 0;
  }

  @media (min-width: 768px) {
    .vinyl-right-col {
      width: 300px;
      flex-shrink: 0;
    }
  }

  .tracklist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid #374151;
  }

  .tracklist-title {
    font-size: 1rem;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .tracklist-price {
    font-size: 0.85rem;
    color: #9ca3af;
  }

  /* Track items - show 2 tracks */
  .track-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    max-height: 125px;
    overflow-y: auto;
    padding-right: 0.4rem;
  }

  .track-list::-webkit-scrollbar {
    width: 5px;
  }

  .track-list::-webkit-scrollbar-track {
    background: #1f2937;
    border-radius: 3px;
  }

  .track-list::-webkit-scrollbar-thumb {
    background: #4b5563;
    border-radius: 3px;
  }

  .track-item {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.4rem 0;
  }

  .track-play-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #374151;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: background 0.15s;
  }

  .track-play-btn:hover {
    background: #4b5563;
  }

  .track-play-btn svg {
    width: 14px;
    height: 14px;
    color: #fff;
  }

  .track-name {
    flex: 1;
    font-size: 0.95rem;
    color: #d1d5db;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .track-num {
    color: #6b7280;
    margin-right: 0.35rem;
  }

  /* Waveform */
  .vinyl-waveform {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: auto;
  }

  .waveform-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.6rem;
  }

  .waveform-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .waveform-label span {
    color: #dc2626;
    font-size: 0.65rem;
  }

  .waveform-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .waveform-controls svg {
    width: 18px;
    height: 18px;
    color: #6b7280;
  }

  .waveform-canvas {
    width: 100%;
    height: 50px;
    display: block;
    border-radius: 4px;
    background: linear-gradient(to bottom, #0f172a, #1e293b);
  }
</style>

<script is:inline>
  let allListings = [];
  let allCollections = [];
  let currentCollection = 'all';

  // Vinyl API - use local endpoint (fetches from D1/Firebase)
  const VINYL_API_URL = '/api/vinyl/public';

  async function loadCollections() {
    const container = document.getElementById('sellerCollections');
    if (!container) return;

    try {
      const res = await fetch(`${VINYL_API_URL}?type=collections`);
      const data = await res.json();

      if (data.success && data.collections) {
        allCollections = data.collections;
        renderCollections();
      }
    } catch (err) {
      console.error('Error loading collections:', err);
      container.innerHTML = '<div class="loading-text">No collections yet</div>';
    }
  }

  function renderCollections() {
    const container = document.getElementById('sellerCollections');
    const mobileFilters = document.getElementById('mobileFilters');
    if (!container || !mobileFilters) return;

    if (allCollections.length === 0) {
      container.innerHTML = '<div class="loading-text">No collections yet</div>';
      return;
    }

    // Desktop sidebar
    container.innerHTML = allCollections.map(c => `
      <button class="collection-box" data-collection="${c.id}">
        <div class="collection-box-inner">
          <span class="collection-number">Collection ${c.collectionNumber || '1'}</span>
          <span class="collection-store">${c.storeName || 'Unknown Store'}</span>
        </div>
      </button>
    `).join('');

    // Mobile filters
    const existingMobile = mobileFilters.querySelectorAll('.filter-btn:not([data-collection="all"]):not([data-collection="deals"])');
    existingMobile.forEach(b => b.remove());

    allCollections.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'filter-btn';
      btn.dataset.collection = c.id;
      btn.textContent = c.storeName || `Collection ${c.collectionNumber}`;
      mobileFilters.appendChild(btn);
    });

    // Update count
    document.getElementById('collectionCount').textContent = `${allCollections.length} seller${allCollections.length !== 1 ? 's' : ''}`;

    // Add click handlers
    document.querySelectorAll('[data-collection]').forEach(btn => {
      btn.addEventListener('click', () => selectCollection(btn.dataset.collection));
    });
  }

  async function loadListings(collection = 'all') {
    const grid = document.getElementById('listingsGrid');
    const empty = document.getElementById('emptyState');
    if (!grid || !empty) return;

    grid.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading vinyl...</p></div>';
    empty.style.display = 'none';

    try {
      let url = `${VINYL_API_URL}?type=listings`;
      if (collection === 'deals') {
        url = `${VINYL_API_URL}?type=deals`;
      } else if (collection !== 'all') {
        url = `${VINYL_API_URL}?type=listings&collection=${collection}`;
      }

      const res = await fetch(url);
      const data = await res.json();

      if (data.success) {
        allListings = data.listings || [];
        renderListings();

        // Update counts
        document.getElementById('listingCount').textContent = allListings.length;
        document.getElementById('allCount').textContent = allListings.length;

        // Get deals count
        const dealsCount = allListings.filter(l => l.discountPercent > 0).length;
        document.getElementById('dealsCount').textContent = dealsCount;
      } else {
        grid.innerHTML = '';
        empty.style.display = 'block';
      }
    } catch (err) {
      console.error('Error loading listings:', err);
      grid.innerHTML = '';
      empty.style.display = 'block';
    }
  }

  // Condition data with full names and colors
  const conditionData = {
    'M': { name: 'Mint', color: '#10b981' },           // Green
    'NM': { name: 'Near Mint', color: '#14b8a6' },     // Teal
    'VG+': { name: 'Very Good+', color: '#3b82f6' },   // Blue
    'VG': { name: 'Very Good', color: '#eab308' },     // Yellow
    'G+': { name: 'Good+', color: '#f97316' },         // Orange
    'G': { name: 'Good', color: '#ef4444' },           // Red
    'F': { name: 'Fair', color: '#dc2626' },           // Dark Red
    'P': { name: 'Poor', color: '#6b7280' }            // Gray
  };

  function getConditionName(abbr) {
    return conditionData[abbr]?.name || abbr;
  }

  function getConditionColor(abbr) {
    return conditionData[abbr]?.color || '#6b7280';
  }

  function renderConditionBadge(abbr, label) {
    const data = conditionData[abbr] || { name: abbr, color: '#6b7280' };
    return `
      <div class="condition-badge" title="${label}: ${data.name}">
        <span class="condition-type">${label}</span>
        <div class="condition-row">
          <span class="condition-icon" style="background: ${data.color}">${abbr}</span>
          <span class="condition-label">${data.name}</span>
        </div>
      </div>
    `;
  }

  function renderConditionBadgeInline(abbr, label) {
    const data = conditionData[abbr] || { name: abbr, color: '#6b7280' };
    return `
      <span class="condition-badge-inline" title="${label}: ${data.name}">
        <span class="cond-label">${label}</span>
        <span class="cond-icon" style="background: ${data.color}">${abbr}</span>
        <span class="cond-name">${data.name}</span>
      </span>
    `;
  }

  function renderListings() {
    const grid = document.getElementById('listingsGrid');
    const empty = document.getElementById('emptyState');

    if (allListings.length === 0) {
      grid.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';

    // Group listings by seller
    const listingsBySeller = {};
    allListings.forEach(listing => {
      const sellerKey = listing.sellerId || listing.collectionId || 'unknown';
      const sellerName = listing.sellerName || listing.storeName || 'Unknown Seller';
      if (!listingsBySeller[sellerKey]) {
        listingsBySeller[sellerKey] = {
          name: sellerName,
          listings: []
        };
      }
      listingsBySeller[sellerKey].listings.push(listing);
    });

    // Sort sellers alphabetically
    const sortedSellers = Object.keys(listingsBySeller).sort((a, b) => {
      const nameA = listingsBySeller[a].name.toLowerCase();
      const nameB = listingsBySeller[b].name.toLowerCase();
      if (nameA === 'unknown seller') return 1;
      if (nameB === 'unknown seller') return -1;
      return nameA.localeCompare(nameB);
    });

    // Check if showing a specific collection (not 'all')
    const isSpecificCollection = currentCollection && currentCollection !== 'all' && currentCollection !== 'deals';
    const maxVisible = isSpecificCollection ? Infinity : 3;

    // Render grouped listings
    grid.innerHTML = sortedSellers.map(sellerKey => {
      const seller = listingsBySeller[sellerKey];
      const sellerListings = seller.listings;
      const hasMore = sellerListings.length > maxVisible;
      const visibleListings = hasMore ? sellerListings.slice(0, maxVisible) : sellerListings;
      const hiddenCount = sellerListings.length - maxVisible;

      const sellerHeader = `
        <div class="seller-section" id="seller-${sellerKey}" data-seller-key="${sellerKey}">
          <div class="seller-header">
            <div class="seller-header-inner">
              <h3 class="seller-name">${seller.name}</h3>
              <p class="seller-count">${sellerListings.length} release${sellerListings.length !== 1 ? 's' : ''}</p>
            </div>
          </div>
          <div class="seller-listings" data-expanded="false">
            ${visibleListings.map((listing, index, arr) => {
              const card = renderVinylCard(listing, index);
              const divider = index < arr.length - 1 ? '<div class="release-divider"></div>' : '';
              return card + divider;
            }).join('')}
          </div>
          ${hasMore ? `
            <div class="show-more-container">
              <button class="show-more-btn" data-seller="${sellerKey}" data-total="${sellerListings.length}">
                <span>Show ${hiddenCount} More</span>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
            </div>
          ` : ''}
        </div>
      `;
      return sellerHeader;
    }).join('');

    // Attach show more button listeners
    attachShowMoreListeners(listingsBySeller);

    // Initialize waveforms after rendering
    initWaveforms();
  }

  function attachShowMoreListeners(listingsBySeller) {
    document.querySelectorAll('.show-more-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const sellerKey = btn.dataset.seller;
        const seller = listingsBySeller[sellerKey];
        if (!seller) return;

        const section = document.getElementById(`seller-${sellerKey}`);
        if (!section) return;

        const listingsContainer = section.querySelector('.seller-listings');
        const showMoreContainer = section.querySelector('.show-more-container');

        // Render all listings
        listingsContainer.innerHTML = seller.listings.map((listing, index, arr) => {
          const card = renderVinylCard(listing, index);
          const divider = index < arr.length - 1 ? '<div class="release-divider"></div>' : '';
          return card + divider;
        }).join('');

        listingsContainer.dataset.expanded = 'true';

        // Remove the show more button
        if (showMoreContainer) {
          showMoreContainer.remove();
        }

        // Re-initialize waveforms for new cards
        initWaveforms();
      });
    });
  }

  function renderVinylCard(listing, index) {
    const hasDiscount = listing.discountPercent && listing.discountPercent > 0;
    const imageUrl = listing.images && listing.images.length > 0 ? listing.images[0] : null;
    const mediaCond = listing.mediaCondition || 'VG+';
    const sleeveCond = listing.sleeveCondition || 'VG+';
    const tracks = listing.tracks || [];
    const trackCount = tracks.length;
    const displayPrice = (listing.price || 0).toFixed(2);

    return `
        <article class="vinyl-card">
          <div class="vinyl-card-inner">
            <!-- LEFT COLUMN: Artwork + Buttons -->
            <div class="vinyl-left-col">
              <div class="vinyl-artwork">
                ${imageUrl
                  ? `<img src="${imageUrl}" alt="${listing.title}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                     <div class="vinyl-artwork-placeholder" style="display:none;">ðŸ“€</div>`
                  : '<div class="vinyl-artwork-placeholder">ðŸ“€</div>'}
                ${hasDiscount ? `<div class="sale-badge">${listing.discountPercent}% OFF</div>` : ''}
              </div>
              <div class="vinyl-buttons">
                <button class="vinyl-buy-btn" onclick="event.stopPropagation(); addVinylToCart('${listing.id}')">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                  </svg>
                  <span class="btn-price">Â£${displayPrice}</span>
                </button>
                <button class="vinyl-view-btn" onclick="event.stopPropagation(); viewListing('${listing.id}')">
                  VIEW
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- MIDDLE COLUMN: Details (centered) -->
            <div class="vinyl-middle-col">
              <h3 class="vinyl-title">${listing.title || 'Untitled'}</h3>
              <p class="vinyl-artist">${listing.artist || 'Unknown Artist'}</p>
              <p class="vinyl-seller-line">Â© <span>${listing.sellerName || 'Unknown Seller'}</span></p>

              <div class="vinyl-tags-row">
                ${listing.catalogNumber ? `<span class="vinyl-tag">${listing.catalogNumber}</span>` : ''}
                <span class="vinyl-tag">${listing.genre || 'Vinyl'} / ${listing.format || 'LP'}</span>
              </div>
              <div class="vinyl-conditions-row">
                ${renderConditionBadgeInline(mediaCond, 'Record')}
                ${renderConditionBadgeInline(sleeveCond, 'Sleeve')}
              </div>

              <div class="vinyl-meta-footer">
                <span class="wishlist-link">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  Wishlist
                </span>
                ${trackCount > 0 ? `<span class="track-count-label">${trackCount} track${trackCount > 1 ? 's' : ''}</span>` : ''}
              </div>
            </div>

            <!-- RIGHT COLUMN: Tracklist + Waveform -->
            <div class="vinyl-right-col">
              <div class="tracklist-header">
                <span class="tracklist-title">TRACKS (${trackCount})</span>
              </div>

              <div class="track-list">
                ${trackCount > 0 ? tracks.map((track, i) => `
                  <div class="track-item">
                    <button class="track-play-btn">
                      <svg fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <span class="track-name"><span class="track-num">${i + 1}</span> ${track.name || track.title || 'Untitled'}</span>
                  </div>
                `).join('') : `
                  <div class="track-item">
                    <span class="track-name" style="color: #6b7280; font-style: italic;">No track listing</span>
                  </div>
                `}
              </div>

              <div class="vinyl-waveform">
                <div class="waveform-header">
                  <span class="waveform-label">NOW PLAYING <span>No track selected</span></span>
                  <div class="waveform-controls">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
                <canvas class="waveform-canvas" data-listing-id="${listing.id}" width="400" height="35"></canvas>
              </div>
            </div>
          </div>
        </article>
      `;
  }

  // Generate and draw static waveforms
  function initWaveforms() {
    const canvases = document.querySelectorAll('.waveform-canvas');
    canvases.forEach(canvas => {
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      // Set canvas size
      const container = canvas.parentElement;
      canvas.width = container.offsetWidth - 24 || 300;
      canvas.height = 50;

      // Generate static waveform pattern
      const bars = 50;
      const barWidth = (canvas.width / bars) - 1;

      for (let i = 0; i < bars; i++) {
        // Create natural-looking waveform shape
        const centerBoost = 1 - Math.abs((i - bars/2) / (bars/2)) * 0.25;
        const height = (Math.random() * 0.5 + 0.3) * centerBoost * canvas.height;
        const x = i * (barWidth + 1);
        const y = (canvas.height - height) / 2;

        ctx.fillStyle = '#6b7280';
        ctx.fillRect(x, y, barWidth, height);
      }
    });
  }

  function selectCollection(collection) {
    currentCollection = collection;

    // Update active states
    document.querySelectorAll('[data-collection]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.collection === collection);
    });

    // Update title
    const title = document.getElementById('sectionTitle');
    if (collection === 'all') {
      title.textContent = 'All Vinyl Collections';
    } else if (collection === 'deals') {
      title.textContent = 'ðŸ”¥ Special Deals';
    } else {
      const col = allCollections.find(c => c.id === collection);
      title.textContent = col ? (col.storeName || `Collection ${col.collectionNumber}`) : 'Collection';
    }

    loadListings(collection);
  }

  function viewListing(id) {
    window.location.href = `/crates/${id}`;
  }

  // Cart functionality
  function getCustomerId() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'customerId' && value) {
        return value;
      }
    }
    return null;
  }

  function getCart() {
    const customerId = getCustomerId();
    if (!customerId) return { items: [] };

    try {
      const stored = localStorage.getItem('freshwax_cart_' + customerId);
      if (stored) {
        const data = JSON.parse(stored);
        return data.items ? data : { items: data };
      }
    } catch (e) {}

    return { items: [] };
  }

  function saveCart(items) {
    const customerId = getCustomerId();
    if (!customerId) return;

    const cartData = {
      items: items,
      updatedAt: new Date().toISOString()
    };
    localStorage.setItem('freshwax_cart_' + customerId, JSON.stringify(cartData));
    window.dispatchEvent(new CustomEvent('cart-updated', { detail: cartData }));
    window.dispatchEvent(new CustomEvent('cartUpdated', { detail: cartData }));

    if (window.FreshWaxCart) {
      window.FreshWaxCart.updateBadge();
    }
  }

  function showToast(message) {
    const existing = document.getElementById('vinyl-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.id = 'vinyl-toast';
    toast.textContent = message;
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:16px 28px;border-radius:12px;font-size:15px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.4);';
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function addVinylToCart(listingId) {
    const customerId = getCustomerId();
    if (!customerId) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    // Find the listing in allListings
    const listing = allListings.find(l => l.id === listingId);
    if (!listing) {
      showToast('Error: Listing not found');
      return;
    }

    const cart = getCart();
    let items = cart.items || [];

    // Check if already in cart
    const existingIndex = items.findIndex(item => item.id === listingId && item.type === 'vinyl');
    if (existingIndex !== -1) {
      showToast('Already in cart!');
      return;
    }

    // Add vinyl to cart
    items.push({
      id: listing.id,
      type: 'vinyl',
      format: 'vinyl',
      name: (listing.artist || 'Unknown Artist') + ' - ' + (listing.title || 'Untitled'),
      title: listing.title || 'Untitled',
      artist: listing.artist || 'Unknown Artist',
      price: listing.price || 0,
      image: listing.images && listing.images.length > 0 ? listing.images[0] : '/place-holder.webp',
      artwork: listing.images && listing.images.length > 0 ? listing.images[0] : '/place-holder.webp',
      quantity: 1,
      sellerId: listing.sellerId,
      sellerName: listing.sellerName
    });

    saveCart(items);
    showToast('Added to cart!');
  }

  // Make functions available globally
  window.viewListing = viewListing;
  window.addVinylToCart = addVinylToCart;

  // Condition guide modal
  const conditionKeyToggle = document.getElementById('conditionKeyToggle');
  const conditionModal = document.getElementById('conditionModal');
  const conditionModalClose = document.getElementById('conditionModalClose');

  if (conditionKeyToggle && conditionModal) {
    conditionKeyToggle.addEventListener('click', () => {
      conditionModal.classList.add('open');
    });
  }

  if (conditionModalClose && conditionModal) {
    conditionModalClose.addEventListener('click', () => {
      conditionModal.classList.remove('open');
    });
  }

  // Close modal on backdrop click
  if (conditionModal) {
    conditionModal.addEventListener('click', (e) => {
      if (e.target === conditionModal) {
        conditionModal.classList.remove('open');
      }
    });
  }

  // Initialize function
  function initCrates() {
    // Only run on crates page - check if key element exists
    const listingsGrid = document.getElementById('listingsGrid');
    if (!listingsGrid) return;

    loadCollections();
    loadListings();
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCrates);
  } else {
    initCrates();
  }

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', initCrates);
</script>
