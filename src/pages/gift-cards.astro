---
// src/pages/gift-cards.astro
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Gift Cards - Fresh Wax">
  <Header />

  <main style="min-height:calc(100vh - 200px);padding:2rem 1.5rem;max-width:900px;margin:0 auto;background:#000;">
    
    <header style="margin-bottom:2rem;padding-bottom:1.25rem;border-bottom:4px solid #dc2626;text-align:center;">
      <h1 style="margin:0;font-size:2.5rem;font-weight:900;font-family:'Space Grotesk',sans-serif;text-transform:uppercase;color:#fff;">
        üéÅ Gift Cards
      </h1>
      <p style="margin:1rem 0 0 0;color:#aaa;font-size:1.1rem;">Give the gift of fresh wax to someone special</p>
    </header>

    <div style="display:grid;gap:2rem;grid-template-columns:1fr;">
      
      <!-- Gift Card Preview -->
      <div style="background:linear-gradient(180deg,#000 0%,#333 100%);border:3px solid #fff;border-radius:16px;padding:2.5rem;position:relative;overflow:hidden;">
        <div style="position:absolute;top:0;right:0;width:150px;height:150px;background:rgba(220,38,38,0.1);border-radius:0 0 0 100%;"></div>
        <div style="position:absolute;bottom:0;left:0;width:100px;height:100px;background:rgba(255,255,255,0.05);border-radius:0 100% 0 0;"></div>
        
        <div style="position:relative;z-index:1;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2.5rem;">
            <div style="background:#fff;padding:0.75rem 1rem;border-radius:8px;">
              <img src="/logo.webp" alt="Fresh Wax" style="height:50px;display:block;" />
            </div>
            <div style="text-align:right;">
              <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:0.15em;color:#888;font-weight:700;">Gift Card</div>
              <div id="preview-amount" style="font-size:3.5rem;font-weight:900;color:#dc2626;min-height:3.5rem;"></div>
            </div>
          </div>
          
          <div style="margin-top:2rem;">
            <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:0.15em;color:#888;margin-bottom:0.5rem;font-weight:700;">To</div>
            <div id="preview-recipient" style="font-size:1.75rem;font-weight:800;color:#fff;">Your recipient</div>
          </div>
          
          <div style="margin-top:1.5rem;">
            <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:0.15em;color:#888;margin-bottom:0.5rem;font-weight:700;">Message</div>
            <div id="preview-message" style="font-size:1.25rem;color:#ccc;font-style:italic;">"Enjoy some fresh tunes!"</div>
          </div>
        </div>
      </div>

      <!-- Gift Card Form -->
      <div style="background:#111;border:3px solid #fff;border-radius:16px;padding:2rem;">
        
        <!-- Amount Selection -->
        <div style="margin-bottom:2rem;">
          <label style="display:block;font-size:1rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem;">Choose Amount</label>
          
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-bottom:1rem;">
            <button class="amount-btn" data-amount="5" style="padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;transition:all 0.2s;">¬£5</button>
            <button class="amount-btn" data-amount="10" style="padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;transition:all 0.2s;">¬£10</button>
            <button class="amount-btn" data-amount="20" style="padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;transition:all 0.2s;">¬£20</button>
            <button class="amount-btn" data-amount="50" style="padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;transition:all 0.2s;">¬£50</button>
          </div>
          
          <div style="display:flex;align-items:center;gap:1rem;">
            <span style="color:#888;font-weight:600;">or</span>
            <div style="flex:1;position:relative;">
              <span style="position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:#fff;font-weight:700;font-size:1.1rem;">¬£</span>
              <input type="number" id="custom-amount" min="5" max="500" placeholder="Custom (5-500)" style="width:100%;padding:1rem 1rem 1rem 2.5rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1rem;font-weight:600;" />
            </div>
          </div>
        </div>

        <!-- Recipient Details -->
        <div style="margin-bottom:2rem;">
          <label style="display:block;font-size:1rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem;">Recipient Details</label>
          
          <div style="display:grid;gap:1rem;">
            <input type="text" id="recipient-name" placeholder="Recipient's name" style="width:100%;padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1rem;box-sizing:border-box;" />
            <input type="email" id="recipient-email" placeholder="Recipient's email (optional - we'll send it to them)" style="width:100%;padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1rem;box-sizing:border-box;" />
          </div>
        </div>

        <!-- Personal Message -->
        <div style="margin-bottom:2rem;">
          <label style="display:block;font-size:1rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem;">Personal Message <span style="font-weight:400;color:#888;">(optional)</span></label>
          <textarea id="gift-message" rows="3" placeholder="Add a personal message..." style="width:100%;padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1rem;resize:vertical;font-family:inherit;box-sizing:border-box;"></textarea>
        </div>

        <!-- Your Email -->
        <div style="margin-bottom:2rem;">
          <label style="display:block;font-size:1rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:1rem;">Your Email</label>
          <input type="email" id="purchaser-email" placeholder="Your email (for receipt)" style="width:100%;padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1rem;box-sizing:border-box;" />
        </div>

        <!-- Add to Cart Button -->
        <button id="add-to-cart-btn" style="width:100%;padding:1.25rem;background:#dc2626;border:3px solid #dc2626;border-radius:10px;color:#fff;font-size:1.2rem;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:0.03em;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.75rem;">
          <span>üõí</span>
          <span>Add Gift Card to Bag</span>
          <span id="btn-amount"></span>
        </button>

        <p style="text-align:center;margin-top:1rem;color:#888;font-size:0.9rem;">
          Gift cards are valid for 1 year from purchase
        </p>
      </div>

      <!-- How It Works -->
      <div style="background:#111;border:2px solid #333;border-radius:12px;padding:1.5rem;">
        <h3 style="margin:0 0 1rem 0;font-size:1rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:0.05em;">How It Works</h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;">
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">üí≥</div>
            <div style="font-weight:700;color:#fff;margin-bottom:0.25rem;">1. Purchase</div>
            <div style="font-size:0.875rem;color:#888;">Choose an amount and complete checkout</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">üìß</div>
            <div style="font-weight:700;color:#fff;margin-bottom:0.25rem;">2. Receive</div>
            <div style="font-size:0.875rem;color:#888;">Gift card code sent instantly via email</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">üéµ</div>
            <div style="font-weight:700;color:#fff;margin-bottom:0.25rem;">3. Redeem</div>
            <div style="font-size:0.875rem;color:#888;">Use at checkout for releases, vinyl & merch</div>
          </div>
        </div>
      </div>

      <!-- Check Balance -->
      <div style="background:#111;border:2px solid #333;border-radius:12px;padding:1.5rem;">
        <h3 style="margin:0 0 1rem 0;font-size:1rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:0.05em;">Check Gift Card Balance</h3>
        <div style="display:flex;gap:1rem;">
          <input type="text" id="check-code" placeholder="Enter gift card code (e.g. FW-XXXX-XXXX-XXXX)" style="flex:1;padding:1rem;background:#222;border:2px solid #444;border-radius:8px;color:#fff;font-size:1rem;text-transform:uppercase;" />
          <button id="check-balance-btn" style="padding:1rem 1.5rem;background:#fff;border:2px solid #fff;border-radius:8px;color:#000;font-weight:800;cursor:pointer;white-space:nowrap;">Check Balance</button>
        </div>
        <div id="balance-result" style="margin-top:1rem;display:none;"></div>
      </div>

    </div>
    
  </main>

  <Footer />
</Layout>

<style is:global>
  body {
    background: #000 !important;
  }
  
  .amount-btn:hover {
    border-color: #fff !important;
  }
  
  .amount-btn.selected {
    background: #dc2626 !important;
    border-color: #dc2626 !important;
  }
  
  #add-to-cart-btn:hover {
    background: #b91c1c;
    border-color: #b91c1c;
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(220, 38, 38, 0.4);
  }
  
  #check-balance-btn:hover {
    background: #dc2626;
    border-color: #dc2626;
    color: #fff;
  }
  
  input:focus, textarea:focus {
    outline: none;
    border-color: #dc2626 !important;
  }
  
  input::placeholder, textarea::placeholder {
    color: #666;
  }
</style>

<script>
  let selectedAmount = 0;
  
  function init() {
    var amountBtns = document.querySelectorAll('.amount-btn');
    var customAmountInput = document.getElementById('custom-amount') as HTMLInputElement;
    var recipientNameInput = document.getElementById('recipient-name') as HTMLInputElement;
    var recipientEmailInput = document.getElementById('recipient-email') as HTMLInputElement;
    var giftMessageInput = document.getElementById('gift-message') as HTMLTextAreaElement;
    var purchaserEmailInput = document.getElementById('purchaser-email') as HTMLInputElement;
    var addToCartBtn = document.getElementById('add-to-cart-btn');
    var checkBalanceBtn = document.getElementById('check-balance-btn');
    var checkCodeInput = document.getElementById('check-code') as HTMLInputElement;
    
    // Update preview
    function updatePreview() {
      var previewAmount = document.getElementById('preview-amount');
      var previewRecipient = document.getElementById('preview-recipient');
      var previewMessage = document.getElementById('preview-message');
      var btnAmount = document.getElementById('btn-amount');
      
      if (previewAmount) previewAmount.textContent = selectedAmount > 0 ? '¬£' + selectedAmount : '';
      if (btnAmount) btnAmount.textContent = selectedAmount > 0 ? '- ¬£' + selectedAmount : '';
      
      var recipientName = recipientNameInput?.value || 'Your recipient';
      if (previewRecipient) previewRecipient.textContent = recipientName;
      
      var message = giftMessageInput?.value || 'Enjoy some fresh tunes!';
      if (previewMessage) previewMessage.textContent = '"' + message + '"';
    }
    
    // Amount button clicks
    amountBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        amountBtns.forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        selectedAmount = parseInt(btn.getAttribute('data-amount') || '25', 10);
        if (customAmountInput) customAmountInput.value = '';
        updatePreview();
      });
    });
    
    // Custom amount input
    if (customAmountInput) {
      customAmountInput.addEventListener('input', function() {
        var value = parseInt(customAmountInput.value, 10);
        if (value >= 5 && value <= 500) {
          amountBtns.forEach(function(b) { b.classList.remove('selected'); });
          selectedAmount = value;
          updatePreview();
        }
      });
    }
    
    // Live preview updates
    if (recipientNameInput) {
      recipientNameInput.addEventListener('input', updatePreview);
    }
    if (giftMessageInput) {
      giftMessageInput.addEventListener('input', updatePreview);
    }
    
    // Add to cart
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', function() {
        if (selectedAmount < 5) {
          alert('Please select an amount');
          return;
        }
        if (selectedAmount > 500) {
          alert('Maximum amount is ¬£500');
          return;
        }
        
        var recipientName = recipientNameInput?.value?.trim() || '';
        var recipientEmail = recipientEmailInput?.value?.trim() || '';
        var message = giftMessageInput?.value?.trim() || '';
        var purchaserEmail = purchaserEmailInput?.value?.trim() || '';
        
        var giftCard = {
          id: 'giftcard-' + Date.now(),
          name: '¬£' + selectedAmount + ' Gift Card' + (recipientName ? ' for ' + recipientName : ''),
          price: selectedAmount,
          quantity: 1,
          type: 'giftcard',
          productType: 'giftcard',
          image: '/logo.webp',
          recipientName: recipientName,
          recipientEmail: recipientEmail,
          message: message,
          purchaserEmail: purchaserEmail
        };
        
        // Add to cart
        var stored = localStorage.getItem('cart');
        var cart = stored ? JSON.parse(stored) : [];
        cart.push(giftCard);
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Update cart count
        window.dispatchEvent(new CustomEvent('cartUpdated'));
        
        // Feedback
        var originalText = addToCartBtn.innerHTML;
        addToCartBtn.innerHTML = '<span>‚úì</span> <span>Added to Bag!</span>';
        addToCartBtn.style.background = '#16a34a';
        addToCartBtn.style.borderColor = '#16a34a';
        
        setTimeout(function() {
          addToCartBtn.innerHTML = originalText;
          addToCartBtn.style.background = '#dc2626';
          addToCartBtn.style.borderColor = '#dc2626';
        }, 2000);
      });
    }
    
    // Check balance
    if (checkBalanceBtn) {
      checkBalanceBtn.addEventListener('click', async function() {
        var code = checkCodeInput?.value?.trim().toUpperCase();
        var resultDiv = document.getElementById('balance-result');
        
        if (!code) {
          if (resultDiv) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding:1rem;background:rgba(220,38,38,0.15);border:2px solid #dc2626;border-radius:8px;color:#f87171;">Please enter a gift card code</div>';
          }
          return;
        }
        
        checkBalanceBtn.textContent = 'Checking...';
        checkBalanceBtn.disabled = true;
        
        try {
          var response = await fetch('/api/gift-cards?action=validate&code=' + encodeURIComponent(code));
          var data = await response.json();
          
          if (resultDiv) {
            resultDiv.style.display = 'block';
            
            if (data.success) {
              var gc = data.giftCard;
              resultDiv.innerHTML = '<div style="padding:1rem;background:rgba(34,197,94,0.15);border:2px solid #22c55e;border-radius:8px;">' +
                '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                  '<div>' +
                    '<div style="font-weight:700;color:#4ade80;font-size:1.1rem;">Gift Card Valid ‚úì</div>' +
                    '<div style="color:#888;font-size:0.9rem;margin-top:0.25rem;">Code: ' + gc.code + '</div>' +
                  '</div>' +
                  '<div style="text-align:right;">' +
                    '<div style="font-size:1.5rem;font-weight:900;color:#fff;">¬£' + gc.balance.toFixed(2) + '</div>' +
                    '<div style="color:#888;font-size:0.8rem;">Balance remaining</div>' +
                  '</div>' +
                '</div>' +
              '</div>';
            } else {
              resultDiv.innerHTML = '<div style="padding:1rem;background:rgba(220,38,38,0.15);border:2px solid #dc2626;border-radius:8px;color:#f87171;">' + data.error + '</div>';
            }
          }
        } catch (err) {
          if (resultDiv) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding:1rem;background:rgba(220,38,38,0.15);border:2px solid #dc2626;border-radius:8px;color:#f87171;">Error checking balance. Please try again.</div>';
          }
        }
        
        checkBalanceBtn.textContent = 'Check Balance';
        checkBalanceBtn.disabled = false;
      });
    }
    
    // Format code input
    if (checkCodeInput) {
      checkCodeInput.addEventListener('input', function() {
        checkCodeInput.value = checkCodeInput.value.toUpperCase();
      });
    }
  }
  
  document.addEventListener('DOMContentLoaded', init);
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  }
  document.addEventListener('astro:page-load', init);
</script>