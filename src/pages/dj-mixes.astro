---
// src/pages/dj-mixes.astro
// OPTIMIZED: Direct Firebase import - no internal HTTP calls
// - Extended cache TTLs (30 min for stats)
// - Debounced interactions prevent duplicate API calls
// - Lazy audio metadata loading
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FloatingShuffleButton from '../components/FloatingShuffleButton.astro';
import { getDJMixesForPage } from '../lib/dj-mixes';
import { initializeApp, cert, getApps } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin for settings
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

// Direct Firebase call - no HTTP overhead
let mixes: any[] = [];
let showMixCharts = false;

try {
  mixes = await getDJMixesForPage(50);
  
  // Get settings for mix chart visibility
  const settingsDoc = await db.collection('settings').doc('admin').get();
  if (settingsDoc.exists) {
    showMixCharts = settingsDoc.data()?.showMixCharts || false;
  }
} catch (error) {
  console.error('[DJ-MIXES PAGE] Error loading mixes:', error);
  // Silent fail - mixes will be empty array
}

// Calculate chart rankings if enabled
let chartMixes: any[] = [];
if (showMixCharts && mixes.length > 0) {
  chartMixes = mixes.map(mix => {
    const plays = mix.plays || mix.playCount || 0;
    const likes = mix.likes || mix.likeCount || 0;
    const downloads = mix.downloads || mix.downloadCount || 0;
    const comments = mix.comments || mix.commentCount || 0;
    const rating = Math.round((plays * 0.3 + likes * 2 + downloads * 1.5 + comments * 3) / 10);
    return { ...mix, rating };
  }).sort((a, b) => b.rating - a.rating).slice(0, 10);
}

// Helper function to format duration in human readable format
function formatDuration(seconds: number | string | null | undefined): string {
  if (!seconds) return '--:--';
  const numSeconds = typeof seconds === 'string' ? parseFloat(seconds) : seconds;
  if (!numSeconds || isNaN(numSeconds)) return '--:--';
  
  const hrs = Math.floor(numSeconds / 3600);
  const mins = Math.floor((numSeconds % 3600) / 60);
  
  if (hrs > 0) {
    const hourWord = hrs === 1 ? 'hour' : 'hours';
    const minWord = mins === 1 ? 'minute' : 'minutes';
    if (mins > 0) {
      return `${hrs} ${hourWord} ${mins} ${minWord}`;
    }
    return `${hrs} ${hourWord}`;
  }
  const minWord = mins === 1 ? 'minute' : 'minutes';
  return `${mins} ${minWord}`;
}

// Helper to get duration from mix object
function getMixDuration(mix: any): number | null {
  if (mix.durationSeconds && typeof mix.durationSeconds === 'number') {
    return mix.durationSeconds;
  }
  if (mix.duration && typeof mix.duration === 'string' && mix.duration.includes(':')) {
    const parts = mix.duration.split(':').map(Number);
    if (parts.length === 3) {
      return parts[0] * 3600 + parts[1] * 60 + parts[2];
    } else if (parts.length === 2) {
      return parts[0] * 60 + parts[1];
    }
  }
  return mix.duration_seconds || mix.mixDuration || null;
}

// Extract unique genres from mixes for filter
const genreCounts = new Map<string, number>();
mixes.forEach(mix => {
  const genre = mix.genre || 'Jungle & D&B';
  genreCounts.set(genre, (genreCounts.get(genre) || 0) + 1);
});

// Sort genres by count (most common first), then alphabetically
const sortedGenres = Array.from(genreCounts.entries())
  .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
  .map(([genre, count]) => ({ genre, count }));

// Core genres to always show (if they exist)
const coreGenres = ['Jungle', 'Drum and Bass', 'Ragga Jungle', 'Hardcore', 'Old Skool'];
const otherGenres = sortedGenres.filter(g => !coreGenres.includes(g.genre));
---

<Layout title="DJ Mixes - Fresh Wax">
  <Header />
  
  <main class="dj-mixes-main">
    <!-- Background Image -->
    <div class="bg-image-overlay"></div>
    
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-grid-overlay"></div>
      
      <div class="hero-container">
        <div class="hero-content">
          <h1 class="hero-title">FRESH SESSIONS</h1>
          <p class="hero-subtitle">Jungle & Drum and Bass DJ Sets</p>
          <div class="hero-divider">
            <div class="divider-line left"></div>
            <div class="divider-scanner">
              <div class="scanner-bar"></div>
            </div>
            <div class="divider-line right"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content with Sidebar -->
    <div class="mixes-layout">
      
      <!-- Genre Sidebar - Desktop -->
      <aside class="genre-sidebar">
        <div class="sidebar-inner">
          <!-- Sidebar Header -->
          <div class="sidebar-header">
            <div class="sidebar-title">Genres</div>
            <p class="sidebar-subtitle">
              {sortedGenres.length} genre{sortedGenres.length !== 1 ? 's' : ''} ‚Ä¢ {mixes.length} mix{mixes.length !== 1 ? 'es' : ''}
            </p>
          </div>
          
          <!-- Genre Navigation -->
          <nav class="genre-nav">
            <button class="genre-nav-btn active" data-genre="all">
              <div class="genre-nav-content">
                <span class="genre-name">All Mixes</span>
                <span class="genre-count">{mixes.length}</span>
              </div>
              <svg class="genre-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
            
            {coreGenres.map(genre => {
              const genreData = sortedGenres.find(g => g.genre === genre);
              return genreData ? (
                <button class="genre-nav-btn" data-genre={genre}>
                  <div class="genre-nav-content">
                    <span class="genre-name">{genre}</span>
                    <span class="genre-count">{genreData.count}</span>
                  </div>
                  <svg class="genre-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              ) : null;
            })}
            
            {otherGenres.length > 0 && (
              <div class="sidebar-divider"></div>
            )}
            
            {otherGenres.map(({ genre, count }) => (
              <button class="genre-nav-btn" data-genre={genre}>
                <div class="genre-nav-content">
                  <span class="genre-name">{genre}</span>
                  <span class="genre-count">{count}</span>
                </div>
                <svg class="genre-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            ))}
          </nav>
        </div>
      </aside>

      <!-- Main Mixes Content -->
      <section class="mixes-section">
        <!-- Header Container -->
        <div class="section-header">
          <div class="header-pattern"></div>
          
          <div class="header-content">
            <div class="header-text">
              <h2 class="section-title">Latest Mixes</h2>
              <p class="section-subtitle">Stream or download full DJ sets ‚Ä¢ <span id="mix-count">{mixes.length}</span> available</p>
            </div>
            <a href="/upload-mix" class="upload-mix-btn">
              üì§ Upload Mix
            </a>
          </div>
        </div>

        <!-- Mobile Genre Filter (horizontal scroll) -->
        <div class="genre-filter-mobile">
          <div class="genre-filter-scroll">
            <button class="genre-filter-btn active" data-genre="all">All ({mixes.length})</button>
            {coreGenres.map(genre => {
              const genreData = sortedGenres.find(g => g.genre === genre);
              return genreData ? (
                <button class="genre-filter-btn" data-genre={genre}>{genre} ({genreData.count})</button>
              ) : null;
            })}
            {otherGenres.map(({ genre, count }) => (
              <button class="genre-filter-btn" data-genre={genre}>{genre} ({count})</button>
            ))}
          </div>
        </div>

      {mixes.length === 0 ? (
        <div class="empty-state">
          <div class="empty-icon">üéß</div>
          <h3 class="empty-title">No Mixes Yet</h3>
          <p class="empty-text">New mixes coming soon!</p>
        </div>
      ) : (
        <div class="mixes-list" id="mixes-list">
          {mixes.map((mix, index) => (
            <article 
              class="mix-card"
              data-mix-id={mix.id}
              data-genre={mix.genre || 'Jungle & D&B'}
              data-upload-date={mix.upload_date}
              data-audio-url={mix.audio_url}
              data-title={mix.title}
              data-dj={mix.dj_name}
              data-artwork={mix.artwork_url}
              data-duration={getMixDuration(mix)}
            >
              <!-- Artwork -->
              <div class="mix-artwork-container">
                <img 
                  src={mix.artwork_url} 
                  alt={mix.title}
                  class="mix-artwork"
                  loading="lazy"
                  onerror="this.src='/logo.webp'"
                />
              </div>

              <!-- Mix Info -->
              <div class="mix-info">
                <div class="mix-header">
                  <h3 class="mix-title">{mix.title}</h3>
                  <p class="mix-dj">{mix.dj_name}</p>
                </div>
                
                <!-- Meta Row -->
                <div class="mix-meta-row">
                  <span class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="duration-display" data-duration={getMixDuration(mix)} data-audio-url={mix.audio_url}>{formatDuration(getMixDuration(mix))}</span>
                  </span>
                  <span class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {new Date(mix.upload_date).toLocaleDateString('en-GB', {
                      day: 'numeric',
                      month: 'short',
                      year: 'numeric'
                    })}
                  </span>
                  <span class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                    </svg>
                    {mix.genre || 'Jungle & D&B'}
                  </span>
                </div>

                <!-- Stats Row -->
                <div class="mix-stats">
                  <span class="stat">
                    <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <span class="plays-count" data-mix-id={mix.id}>{mix.plays || 0}</span> plays
                  </span>
                  <span class="stat">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    <span class="downloads-count" data-mix-id={mix.id}>{mix.downloads || 0}</span> downloads
                  </span>
                  <span class="stat">
                    <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span class="likes-count" data-mix-id={mix.id}>{mix.likes || 0}</span> likes
                  </span>
                  <span class="stat">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <span class="comments-count" data-mix-id={mix.id}>{mix.commentCount || 0}</span> comments
                  </span>
                </div>

                <!-- Action Buttons -->
                <div class="mix-actions">
                  <!-- Play Button -->
                  <button 
                    class="action-btn play-btn-action"
                    data-mix-id={mix.id}
                    title="Play"
                  >
                    <svg class="btn-icon play-icon-btn" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="btn-icon pause-icon-btn hidden" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                    <span class="btn-text play-text-btn">Play</span>
                  </button>

                  <!-- Info Button -->
                  <a 
                    href={`/dj-mix/${mix.id}`}
                    class="action-btn"
                    title="View Details"
                  >
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="btn-text">Info</span>
                  </a>

                  <!-- Like Button -->
                  <button 
                    class="action-btn like-btn"
                    data-mix-id={mix.id}
                    data-liked="false"
                    title="Like"
                  >
                    <svg class="btn-icon like-icon-btn" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <span class="btn-text like-text-btn">Like</span>
                    <span class="btn-text liked-text-btn hidden">Liked</span>
                  </button>

                  <!-- Share Button -->
                  <button 
                    class="action-btn share-btn"
                    data-mix-id={mix.id}
                    data-title={mix.title}
                    data-dj={mix.dj_name}
                    title="Share"
                  >
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    <span class="btn-text">Share</span>
                  </button>

                  <!-- Download Button -->
                  <button 
                    class="action-btn primary download-btn"
                    data-mix-id={mix.id}
                    data-audio-url={mix.audio_url}
                    data-title={mix.title}
                    data-dj={mix.dj_name}
                  >
                    <svg class="btn-icon download-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    <svg class="btn-icon check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="btn-text">Download</span>
                  </button>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}
    </section>
    </div><!-- End mixes-layout -->
    
    <!-- Floating All-Time Mix Chart -->
    {showMixCharts && chartMixes.length > 0 && (
      <div id="floating-chart" class="floating-chart">
        <button id="toggle-chart" class="chart-toggle" title="Toggle Chart">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>TOP 10</span>
        </button>
        <div class="chart-panel">
          <div class="chart-header">
            <div class="chart-title-row">
              <span class="chart-icon">üèÜ</span>
              <h3>ALL-TIME MIX CHART</h3>
            </div>
            <p class="chart-subtitle">Based on plays, likes & downloads</p>
          </div>
          <div class="chart-list">
            {chartMixes.map((mix, index) => (
              <a href={`/dj-mix/${mix.id}`} class="chart-item">
                <span class={`chart-position ${index < 3 ? 'top-3' : ''}`}>
                  {index === 0 && 'ü•á'}
                  {index === 1 && 'ü•à'}
                  {index === 2 && 'ü•â'}
                  {index > 2 && `#${index + 1}`}
                </span>
                <img 
                  src={mix.imageUrl || mix.artworkUrl || mix.artwork_url || '/logo.webp'} 
                  alt={mix.title}
                  class="chart-artwork"
                />
                <div class="chart-info">
                  <span class="chart-mix-title">{mix.title?.substring(0, 25)}{mix.title?.length > 25 ? '...' : ''}</span>
                  <span class="chart-mix-dj">{mix.djName || mix.dj_name}</span>
                </div>
                <div class="chart-stats">
                  <span class="chart-rating">‚≠ê {mix.rating}</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    )}
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Share Mix</h3>
        <button class="modal-close" id="closeShareModal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="modal-subtitle">
          <span id="shareModalTitle"></span> by <span id="shareModalDJ"></span>
        </p>
        <div class="share-input-group">
          <input type="text" id="shareLink" readonly />
          <button id="copyShareButton">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <span id="copyShareButtonText">Copy</span>
          </button>
        </div>
        <p class="copy-feedback" id="copyFeedback"></p>
      </div>
    </div>
  </div>

  <FloatingShuffleButton />
  <Footer />

  <!-- Floating All-Time Chart Panel (Hidden by default) -->
  <div id="floatingChart" class="floating-chart hidden">
    <div class="chart-header">
      <h3>üèÜ All-Time Mix Chart</h3>
      <button id="closeChart" class="chart-close">√ó</button>
    </div>
    <div class="chart-content">
      <div id="chartList" class="chart-list">
        <div class="chart-loading">Loading chart...</div>
      </div>
    </div>
  </div>

  <!-- Chart Toggle Button (Hidden by default) -->
  <button id="chartToggleBtn" class="chart-toggle-btn hidden" title="View All-Time Chart">
    üèÜ
  </button>
</Layout>

<script>
  // Floating chart functionality
  document.addEventListener('DOMContentLoaded', async function() {
    const floatingChart = document.getElementById('floatingChart');
    const chartToggleBtn = document.getElementById('chartToggleBtn');
    const closeChart = document.getElementById('closeChart');
    const chartList = document.getElementById('chartList');

    // Check if charts feature is enabled
    try {
      const response = await fetch('/api/admin/get-settings');
      const data = await response.json();
      
      if (data.success && data.settings?.showMixCharts) {
        // Show the toggle button
        chartToggleBtn?.classList.remove('hidden');
        
        // Load chart data
        loadChartData();
      }
    } catch (error) {
    }

    // Toggle chart visibility
    chartToggleBtn?.addEventListener('click', function() {
      floatingChart?.classList.toggle('hidden');
      floatingChart?.classList.toggle('visible');
    });

    // Close chart
    closeChart?.addEventListener('click', function() {
      floatingChart?.classList.add('hidden');
      floatingChart?.classList.remove('visible');
    });

    // Load chart data
    async function loadChartData() {
      try {
        const response = await fetch('/api/get-mix-chart');
        const data = await response.json();
        
        if (data.success && data.chart && data.chart.length > 0) {
          chartList.innerHTML = data.chart.slice(0, 10).map((mix, index) => `
            <a href="/dj-mix/${mix.id}" class="chart-item">
              <span class="chart-position">${index + 1}</span>
              <img src="${mix.artwork_url || '/logo.webp'}" alt="${mix.title}" class="chart-artwork" />
              <div class="chart-info">
                <span class="chart-title">${mix.title || 'Untitled'}</span>
                <span class="chart-dj">${mix.dj_name || 'Unknown DJ'}</span>
              </div>
              <span class="chart-score">${mix.score || 0}</span>
            </a>
          `).join('');
        } else {
          chartList.innerHTML = '<div class="chart-empty">No chart data yet</div>';
        }
      } catch (error) {
        console.error('[DJ-MIXES] Chart load error:', error);
        chartList.innerHTML = '<div class="chart-empty">Failed to load chart</div>';
      }
    }
  });
</script>

<style>
  /* Main Container with Background Image */
  .dj-mixes-main {
    min-height: 100vh;
    position: relative;
  }

  .bg-image-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    background-image: url('/shop.webp');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.7;
    z-index: 0;
    pointer-events: none;
  }

  /* Ensure content sits above background */
  .hero-section,
  .mixes-section {
    position: relative;
    z-index: 1;
  }

  /* Fonts loaded in Layout.astro - using CSS custom properties */

  /* Custom Font Classes */
  .mix-title {
    font-family: var(--font-heading);
    font-weight: 700;
  }

  .mix-dj {
    font-family: var(--font-body);
    font-weight: 700;
  }

  .section-title {
    font-family: var(--font-heading);
    font-weight: 700;
  }

  .section-subtitle,
  .meta-item,
  .stat {
    font-family: var(--font-body);
  }

  /* Animations */
  @keyframes kittScanner {
    0% { left: -100%; opacity: 0; }
    5% { opacity: 1; }
    45% { opacity: 1; }
    50% { left: 100%; opacity: 0; }
    55% { opacity: 1; }
    95% { opacity: 1; }
    100% { left: -100%; opacity: 0; }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(33px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Hero Section */
  .hero-section {
    background: linear-gradient(to bottom, #000000 0%, #1a1a1a 50%, #2d2d2d 100%);
    color: white;
    padding: 5.5rem 0;
    position: relative;
    overflow: hidden;
    z-index: 10;
    box-shadow: inset 0 -2px 40px rgba(220, 38, 38, 0.1);
  }

  .hero-grid-overlay {
    position: absolute;
    inset: 0;
    background-image: linear-gradient(rgba(255, 255, 255, 0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
    background-size: 55px 55px;
  }

  .hero-container {
    max-width: 88rem;
    margin: 0 auto;
    padding: 0 1.65rem;
    text-align: center;
    position: relative;
    z-index: 10;
  }

  .hero-content {
    animation: fadeInUp 1.2s ease-out;
  }

  .hero-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 6.05rem;
    font-weight: 400;
    margin-bottom: 0.55rem;
    letter-spacing: 0.02em;
    text-shadow: 0 4px 30px rgba(0, 0, 0, 0.7), 0 0 80px rgba(220, 38, 38, 0.2);
    line-height: 0.95;
    text-transform: uppercase;
  }

  .hero-subtitle {
    font-size: 1.375rem;
    color: #f9fafb;
    font-weight: 300;
    letter-spacing: 0.3em;
    margin-bottom: 2.75rem;
    text-transform: uppercase;
    opacity: 0.9;
  }

  .hero-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.1rem;
  }

  .divider-line {
    height: 2px;
    width: 3.3rem;
    border-radius: 1px;
  }

  .divider-line.left {
    background: linear-gradient(to right, transparent, rgba(220, 38, 38, 0.8));
  }

  .divider-line.right {
    background: linear-gradient(to left, transparent, rgba(220, 38, 38, 0.8));
  }

  .divider-scanner {
    position: relative;
    height: 3px;
    width: 4.4rem;
    background: rgba(220, 38, 38, 0.2);
    border-radius: 2px;
    overflow: hidden;
  }

  .scanner-bar {
    position: absolute;
    top: 0;
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.4) 20%, #dc2626 50%, rgba(220, 38, 38, 0.4) 80%, transparent);
    border-radius: 2px;
    animation: kittScanner 2.6s ease-in-out infinite;
    box-shadow: 0 0 20px rgba(220, 38, 38, 0.8), 0 0 40px rgba(220, 38, 38, 0.6);
  }

  /* Mixes Section */
  .mixes-section {
    flex: 1;
    min-width: 0;
    max-width: 100%;
    padding: 2rem 1.5rem;
  }

  @media (min-width: 1024px) {
    .mixes-section {
      max-width: 900px;
      margin: 0 auto;
      padding: 2.5rem 2rem;
    }
  }

  .section-header {
    background: linear-gradient(to bottom, #1f2937 0%, #374151 100%);
    backdrop-filter: blur(20px);
    border-radius: 1.1rem;
    padding: 2.75rem 2.2rem;
    margin-bottom: 2.2rem;
    box-shadow: 0 22px 27.5px -5.5px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }

  .header-pattern {
    position: absolute;
    inset: 0;
    opacity: 0.15;
    pointer-events: none;
    background-image: linear-gradient(rgba(255, 255, 255, 0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.3) 1px, transparent 1px);
    background-size: 44px 44px;
  }

  .header-content {
    text-align: center;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1.1rem;
  }

  .header-text {
    flex: 1;
    min-width: 220px;
  }

  .section-title {
    font-size: 2.475rem;
    color: #ffffff;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
    margin: 0 0 0.825rem 0;
    text-align: left;
  }

  .section-subtitle {
    color: #cbd5e1;
    font-size: 1.1rem;
    margin: 0;
    font-weight: 500;
    letter-spacing: 0.02em;
    text-align: left;
  }

  .upload-mix-btn {
    display: inline-block;
    background: linear-gradient(to right, #dc2626, #991b1b);
    color: white;
    padding: 0.9625rem 2.2rem;
    border-radius: 0.55rem;
    font-weight: 700;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    box-shadow: 0 11px 16.5px -3.3px rgba(0, 0, 0, 0.3);
    transition: all 0.3s;
    border: 2px solid rgba(255, 255, 255, 0.2);
    white-space: nowrap;
  }

  .upload-mix-btn:hover {
    background: linear-gradient(to right, #991b1b, #7f1d1d);
    transform: translateY(-2px);
    box-shadow: 0 22px 27.5px -5.5px rgba(0, 0, 0, 0.4);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 5.5rem 0;
    background: linear-gradient(to bottom, #374151, #1f2937);
    border-radius: 0.825rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.1);
  }

  .empty-icon {
    font-size: 4.4rem;
    margin-bottom: 1.65rem;
  }

  .empty-title {
    font-size: 1.65rem;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 0.825rem;
  }

  .empty-text {
    color: #cbd5e1;
    margin-bottom: 1.65rem;
    font-size: 1.2375rem;
  }

  /* Layout with Sidebar */
  .mixes-layout {
    display: flex;
    min-height: calc(100vh - 200px);
    position: relative;
    z-index: 1;
  }

  /* Genre Sidebar */
  .genre-sidebar {
    width: 280px;
    background: linear-gradient(to bottom, #1f2937 0%, #111827 100%);
    border-right: 2px solid rgba(255, 255, 255, 0.15);
    position: sticky;
    top: 73px;
    height: calc(100vh - 73px);
    overflow-y: auto;
    flex-shrink: 0;
    display: none;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
  }

  @media (min-width: 1024px) {
    .genre-sidebar {
      display: block;
    }
  }

  .sidebar-inner {
    padding: 1.5rem;
  }

  .sidebar-header {
    margin-bottom: 1.5rem;
    padding-top: 1.5rem;
    padding-bottom: 1.5rem;
    border-top: 2px solid #dc2626;
    border-bottom: 2px solid #dc2626;
  }

  .sidebar-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    color: #fff;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .sidebar-subtitle {
    font-size: 0.875rem;
    color: #9ca3af;
    margin: 0;
  }

  .sidebar-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 0.75rem 0;
  }

  .genre-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .genre-nav-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.75rem 1rem;
    background: transparent;
    border: 2px solid transparent;
    border-radius: 0.5rem;
    color: #fff;
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
  }

  .genre-nav-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .genre-nav-btn.active {
    background: linear-gradient(to right, rgba(220, 38, 38, 0.3), rgba(220, 38, 38, 0.1));
    border-color: #dc2626;
    color: #fff;
  }

  .genre-nav-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .genre-name {
    font-weight: 600;
  }

  .genre-count {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .genre-nav-btn.active .genre-count {
    color: #fca5a5;
  }

  .genre-arrow {
    width: 1rem;
    height: 1rem;
    color: #6b7280;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
  }

  .genre-nav-btn:hover .genre-arrow,
  .genre-nav-btn.active .genre-arrow {
    opacity: 1;
    color: #dc2626;
  }

  .genre-nav-btn.active .genre-arrow {
    transform: translateX(3px);
  }

  /* Mobile Genre Filter (horizontal) */
  .genre-filter-mobile {
    display: block;
    padding: 1rem 0;
    margin-bottom: 1rem;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  @media (min-width: 1024px) {
    .genre-filter-mobile {
      display: none;
    }
  }

  .genre-filter-scroll {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding: 0 1rem 0.5rem;
    scrollbar-width: thin;
    scrollbar-color: #dc2626 transparent;
  }

  .genre-filter-scroll::-webkit-scrollbar {
    height: 6px;
  }

  .genre-filter-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  .genre-filter-scroll::-webkit-scrollbar-thumb {
    background: #dc2626;
    border-radius: 3px;
  }

  .genre-filter-btn {
    flex-shrink: 0;
    padding: 0.5rem 1rem;
    background: rgba(55, 65, 81, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 9999px;
    color: #fff;
    font-size: 0.875rem;
    font-weight: 600;
    font-family: var(--font-body);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .genre-filter-btn:hover {
    background: rgba(75, 85, 99, 0.9);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .genre-filter-btn.active {
    background: linear-gradient(to right, #dc2626, #b91c1c);
    border-color: #dc2626;
    color: #fff;
    box-shadow: 0 0 12px rgba(220, 38, 38, 0.4);
  }

  /* Hide filtered mixes */
  .mix-card.filtered-out {
    display: none !important;
  }

  /* No results message */
  .no-results-message {
    text-align: center;
    padding: 3rem 1rem;
    color: #9ca3af;
    font-size: 1.125rem;
  }

  .no-results-message p {
    margin-bottom: 1rem;
  }

  .no-results-message button {
    background: #dc2626;
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
  }

  .no-results-message button:hover {
    background: #b91c1c;
  }

  /* Mixes List */
  .mixes-list {
    display: flex;
    flex-direction: column;
    gap: 1.375rem;
  }

  /* Mix Card */
  .mix-card {
    background: linear-gradient(to bottom, #000000 0%, #111827 40%, #374151 80%, #4b5563 100%);
    border-radius: 1.1rem;
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.15);
    transition: all 0.3s ease;
    animation: fadeInUp 0.6s ease-out backwards;
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: stretch;
    padding: 1.1rem;
    gap: 1.65rem;
  }

  .mix-card:hover {
    transform: translateY(-2px);
    border-color: rgba(220, 38, 38, 0.5);
    box-shadow: 0 22px 44px -11px rgba(0, 0, 0, 0.5), 0 0 33px rgba(220, 38, 38, 0.1);
  }

  .mix-card:nth-child(1) { animation-delay: 0.05s; }
  .mix-card:nth-child(2) { animation-delay: 0.1s; }
  .mix-card:nth-child(3) { animation-delay: 0.15s; }
  .mix-card:nth-child(4) { animation-delay: 0.2s; }
  .mix-card:nth-child(5) { animation-delay: 0.25s; }
  .mix-card:nth-child(6) { animation-delay: 0.3s; }

  /* Artwork Container */
  .mix-artwork-container {
    position: relative;
    width: 242px;
    min-width: 242px;
    height: 242px;
    overflow: hidden;
    flex-shrink: 0;
    border-radius: 0.55rem;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }

  .mix-artwork {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .mix-card:hover .mix-artwork {
    transform: scale(1.05);
  }

  /* Mix Info */
  .mix-info {
    flex: 1;
    padding: 0.275rem 0;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 0.66rem;
    min-width: 0;
  }

  .mix-header {
    margin-bottom: 0.375rem;
  }

  .mix-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    font-weight: 400;
    color: #dc2626;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.02em;
  }

  .mix-dj {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    font-weight: 400;
    color: #ffffff;
    margin: 0;
    text-transform: uppercase;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.02em;
  }

  /* Meta Row */
  .mix-meta-row {
    display: flex;
    align-items: center;
    gap: 1.65rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.44rem;
    font-size: 1.1rem;
    color: #d1d5db;
    font-weight: 600;
  }

  .meta-icon {
    width: 20px;
    height: 20px;
    color: #d1d5db;
  }

  /* Stats */
  .mix-stats {
    display: flex;
    gap: 1.65rem;
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 0.44rem;
    font-size: 0.99rem;
    color: #9ca3af;
    font-weight: 600;
  }

  .stat-icon {
    width: 17.6px;
    height: 17.6px;
    color: #9ca3af;
  }

  /* Action Buttons */
  .mix-actions {
    display: flex;
    gap: 0.35rem;
    flex-wrap: nowrap;
    width: 100%;
  }

  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.5rem 0.5rem;
    border-radius: 0.35rem;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    transition: all 0.2s ease;
    border: 1px solid #4b5563;
    cursor: pointer;
    text-decoration: none;
    background: #374151;
    color: #ffffff;
    flex: 1;
    white-space: nowrap;
  }

  .action-btn:hover {
    background: #4b5563;
    border-color: #6b7280;
  }

  .action-btn.play-btn-action {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    border-color: #16a34a;
  }

  .action-btn.play-btn-action:hover {
    background: linear-gradient(135deg, #15803d 0%, #166534 100%);
    border-color: #15803d;
  }

  .action-btn.like-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    border-color: #dc2626;
  }

  .like-btn[data-liked="true"] .like-icon-btn {
    fill: #dc2626;
    stroke: #dc2626;
  }

  .like-btn[data-liked="true"] .like-text-btn {
    display: none !important;
  }

  .like-btn[data-liked="true"] .liked-text-btn {
    display: inline !important;
  }

  .action-btn.primary {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    border-color: #dc2626;
  }

  .action-btn.primary:hover {
    background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
    border-color: #b91c1c;
  }

  .action-btn .btn-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
  }

  .action-btn .btn-text {
    display: none;
  }

  /* Show text labels on larger screens */
  @media (min-width: 768px) {
    .action-btn {
      padding: 0.45rem 0.6rem;
      font-size: 0.7rem;
    }
    
    .action-btn .btn-text {
      display: inline;
    }
    
    .action-btn .btn-icon {
      width: 14px;
      height: 14px;
    }
  }
  
  @media (min-width: 1024px) {
    .action-btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }
    
    .action-btn .btn-icon {
      width: 15px;
      height: 15px;
    }
  }

  .hidden {
    display: none !important;
  }

  /* Download button states */
  .action-btn.downloading {
    opacity: 0.7;
    cursor: wait;
  }

  .action-btn.downloaded {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important;
    border-color: #16a34a !important;
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.1rem;
  }

  .modal.hidden {
    display: none;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
  }

  .modal-content {
    position: relative;
    background: white;
    border-radius: 0.825rem;
    max-width: 30.8rem;
    width: 100%;
    border: 3px solid #000;
    box-shadow: 0 27.5px 55px rgba(0, 0, 0, 0.5);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.1rem 1.375rem;
    border-bottom: 3px solid #000;
  }

  .modal-header h3 {
    font-family: var(--font-heading);
    font-size: 1.2375rem;
    font-weight: 700;
    color: #000;
    text-transform: uppercase;
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    cursor: pointer;
    color: #6b7280;
    transition: color 0.2s;
  }

  .modal-close:hover {
    color: #000;
  }

  .modal-body {
    padding: 1.375rem;
  }

  .modal-subtitle {
    font-family: var(--font-body);
    font-size: 0.9625rem;
    color: #374151;
    margin: 0 0 1.1rem 0;
  }

  .modal-subtitle span {
    font-weight: 700;
  }

  .share-input-group {
    display: flex;
    gap: 0.55rem;
  }

  .share-input-group input {
    flex: 1;
    padding: 0.6875rem 0.9625rem;
    border: 2px solid #000;
    border-radius: 0.55rem;
    font-family: monospace;
    font-size: 0.88rem;
    background: #f3f4f6;
  }

  .share-input-group button {
    display: flex;
    align-items: center;
    gap: 0.4125rem;
    padding: 0.6875rem 1.1rem;
    background: #000;
    color: white;
    border: 2px solid #000;
    border-radius: 0.55rem;
    font-weight: 700;
    font-size: 0.88rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .share-input-group button:hover {
    background: #374151;
  }

  .copy-feedback {
    font-size: 0.825rem;
    margin-top: 0.55rem;
    min-height: 1.1rem;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-title {
      font-size: 3.3rem !important;
    }

    .mix-card {
      flex-direction: column;
      padding: 0.825rem;
      gap: 1.1rem;
    }

    .mix-artwork-container {
      width: 100%;
      min-width: 100%;
      height: auto;
      aspect-ratio: 1;
    }

    .mix-info {
      padding: 0.55rem 0.275rem;
    }

    .mix-title {
      font-size: 2rem;
      white-space: normal;
    }

    .mix-dj {
      font-size: 1.5rem;
    }

    .mix-meta-row {
      gap: 1.375rem;
    }

    .meta-item {
      font-size: 0.99rem;
    }

    .mix-stats {
      gap: 1.1rem;
    }

    .stat {
      font-size: 0.935rem;
    }

    .action-btn .btn-text {
      display: none;
    }

    .action-btn {
      padding: 0.4rem 0.5rem;
    }
    
    .action-btn .btn-icon {
      width: 14px;
      height: 14px;
    }
  }

  @media (max-width: 640px) {
    .upload-mix-btn {
      width: 100%;
      text-align: center;
    }

    .mix-card {
      padding: 0.66rem;
    }

    .mix-info {
      padding: 0.275rem 0;
      gap: 0.55rem;
    }

    .mix-title {
      font-size: 1.75rem;
    }

    .mix-dj {
      font-size: 1.25rem;
    }

    .mix-meta-row {
      gap: 0.825rem;
    }

    .meta-item {
      font-size: 0.935rem;
    }

    .mix-actions {
      gap: 0.25rem;
    }

    .action-btn {
      padding: 0.35rem 0.4rem;
      flex: 1;
      min-width: 0;
    }

    .action-btn .btn-text {
      display: none !important;
    }

    .action-btn .btn-icon {
      width: 14px;
      height: 14px;
    }
  }

  /* Floating Chart Panel */
  .floating-chart {
    position: fixed;
    top: 100px;
    right: 20px;
    width: 320px;
    max-height: calc(100vh - 200px);
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 2px solid #f59e0b;
    border-radius: 16px;
    z-index: 1000;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(245, 158, 11, 0.2);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .floating-chart.hidden {
    opacity: 0;
    transform: translateX(100%);
    pointer-events: none;
  }

  .floating-chart.visible {
    opacity: 1;
    transform: translateX(0);
  }

  .chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }

  .chart-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 700;
  }

  .chart-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
  }

  .chart-close:hover {
    opacity: 1;
  }

  .chart-content {
    max-height: calc(100vh - 280px);
    overflow-y: auto;
  }

  .chart-list {
    display: flex;
    flex-direction: column;
  }

  .chart-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    text-decoration: none;
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background 0.2s;
  }

  .chart-item:hover {
    background: rgba(245, 158, 11, 0.1);
  }

  .chart-position {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: #f59e0b;
    min-width: 30px;
    text-align: center;
  }

  .chart-artwork {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .chart-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .chart-title {
    font-size: 0.85rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chart-dj {
    font-size: 0.7rem;
    color: #9ca3af;
  }

  .chart-score {
    font-size: 0.75rem;
    font-weight: 700;
    color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .chart-loading,
  .chart-empty {
    padding: 2rem;
    text-align: center;
    color: #9ca3af;
    font-size: 0.9rem;
  }

  /* Chart Toggle Button */
  .chart-toggle-btn {
    position: fixed;
    top: 100px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border: 2px solid white;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 999;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .chart-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(245, 158, 11, 0.4);
  }

  .chart-toggle-btn.hidden {
    display: none;
  }

  @media (max-width: 640px) {
    .floating-chart {
      width: calc(100% - 40px);
      right: 20px;
      left: 20px;
    }
    
    .chart-toggle-btn {
      top: auto;
      bottom: 100px;
      right: 16px;
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
    }
  }
  
  /* Floating Mix Chart */
  .floating-chart {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 0;
  }
  
  .chart-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: 3px solid white;
    border-radius: 2rem 0 0 2rem;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
  }
  
  .chart-toggle:hover {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    transform: rotate(180deg) scale(1.05);
  }
  
  .chart-toggle svg {
    transform: rotate(90deg);
  }
  
  .chart-panel {
    background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
    border: 3px solid white;
    border-left: none;
    border-radius: 0 1rem 1rem 0;
    padding: 1rem;
    width: 280px;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }
  
  .floating-chart.open .chart-panel {
    transform: translateX(0);
    opacity: 1;
    pointer-events: auto;
  }
  
  .floating-chart.open .chart-toggle {
    border-radius: 2rem;
    transform: rotate(180deg) translateX(-10px);
  }
  
  .chart-header {
    text-align: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(220, 38, 38, 0.5);
  }
  
  .chart-title-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .chart-icon {
    font-size: 1.5rem;
  }
  
  .chart-header h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.25rem;
    color: white;
    letter-spacing: 0.1em;
    margin: 0;
  }
  
  .chart-subtitle {
    font-size: 0.65rem;
    color: #9ca3af;
    margin: 0.25rem 0 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .chart-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .chart-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .chart-item:hover {
    background: rgba(220, 38, 38, 0.2);
    transform: translateX(-4px);
  }
  
  .chart-position {
    font-weight: 700;
    font-size: 0.875rem;
    color: #9ca3af;
    min-width: 28px;
    text-align: center;
  }
  
  .chart-position.top-3 {
    font-size: 1.25rem;
  }
  
  .chart-artwork {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    object-fit: cover;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .chart-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }
  
  .chart-mix-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .chart-mix-dj {
    font-size: 0.65rem;
    color: #9ca3af;
  }
  
  .chart-stats {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }
  
  .chart-rating {
    font-size: 0.7rem;
    font-weight: 600;
    color: #fbbf24;
  }
  
  @media (max-width: 768px) {
    .floating-chart {
      top: auto;
      bottom: 180px;
      right: 0;
    }
    
    .chart-panel {
      width: 260px;
      max-height: 50vh;
    }
    
    .chart-toggle {
      padding: 0.5rem 0.75rem;
      font-size: 0.65rem;
    }
  }
</style>

<script>
  // ============================================
  // GENRE FILTER SYSTEM
  // ============================================
  (function() {
    // Get both mobile and sidebar filter buttons
    var mobileFilterBtns = document.querySelectorAll('.genre-filter-btn');
    var sidebarFilterBtns = document.querySelectorAll('.genre-nav-btn');
    var allFilterBtns = document.querySelectorAll('.genre-filter-btn, .genre-nav-btn');
    var mixesList = document.getElementById('mixes-list');
    var mixCountEl = document.getElementById('mix-count');
    var allMixCards = mixesList ? mixesList.querySelectorAll('.mix-card') : [];
    var totalMixes = allMixCards.length;
    
    if (!allFilterBtns.length || !mixesList) return;
    
    // Remove any existing no-results message
    function removeNoResultsMessage() {
      var existing = mixesList.querySelector('.no-results-message');
      if (existing) existing.remove();
    }
    
    // Show no results message
    function showNoResultsMessage(genre) {
      removeNoResultsMessage();
      var msg = document.createElement('div');
      msg.className = 'no-results-message';
      msg.innerHTML = '<p>No mixes found in "' + genre + '"</p><button onclick="document.querySelector(\'.genre-nav-btn[data-genre=all], .genre-filter-btn[data-genre=all]\').click()">Show All Mixes</button>';
      mixesList.appendChild(msg);
    }
    
    // Filter mixes by genre
    function filterMixes(genre) {
      removeNoResultsMessage();
      var visibleCount = 0;
      
      allMixCards.forEach(function(card) {
        var cardGenre = card.getAttribute('data-genre') || '';
        
        if (genre === 'all') {
          card.classList.remove('filtered-out');
          visibleCount++;
        } else {
          // Check if card genre matches (case-insensitive, partial match)
          var matches = cardGenre.toLowerCase().indexOf(genre.toLowerCase()) !== -1;
          
          // Also match "Drum and Bass" with "D&B" and variations
          if (!matches && genre === 'Drum and Bass') {
            matches = cardGenre.toLowerCase().indexOf('d&b') !== -1 || 
                      cardGenre.toLowerCase().indexOf('dnb') !== -1 ||
                      cardGenre.toLowerCase().indexOf('drum') !== -1;
          }
          
          if (matches) {
            card.classList.remove('filtered-out');
            visibleCount++;
          } else {
            card.classList.add('filtered-out');
          }
        }
      });
      
      // Update count display
      if (mixCountEl) {
        mixCountEl.textContent = visibleCount;
      }
      
      // Show no results if nothing visible
      if (visibleCount === 0 && genre !== 'all') {
        showNoResultsMessage(genre);
      }
    }
    
    // Sync active state across both mobile and sidebar buttons
    function syncActiveState(genre) {
      // Update mobile buttons
      mobileFilterBtns.forEach(function(b) { 
        if (b.getAttribute('data-genre') === genre) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
      
      // Update sidebar buttons
      sidebarFilterBtns.forEach(function(b) { 
        if (b.getAttribute('data-genre') === genre) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
    }
    
    // Attach click handlers to all filter buttons
    allFilterBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var genre = this.getAttribute('data-genre');
        
        // Sync active state across all buttons
        syncActiveState(genre);
        
        // Filter mixes
        filterMixes(genre);
      });
    });
  })();
  
  // ============================================
  // FLOATING CHART TOGGLE
  // ============================================
  (function() {
    var toggleBtn = document.getElementById('toggle-chart');
    var floatingChart = document.getElementById('floating-chart');
    
    if (toggleBtn && floatingChart) {
      toggleBtn.addEventListener('click', function() {
        floatingChart.classList.toggle('open');
      });
      
      // Close when clicking outside
      document.addEventListener('click', function(e) {
        if (!floatingChart.contains(e.target) && floatingChart.classList.contains('open')) {
          floatingChart.classList.remove('open');
        }
      });
    }
  })();
  
  // ============================================
  // CACHE SYSTEM - API FRIENDLY
  // Extended TTLs to reduce API calls
  // ============================================
  var MixCache = {
    PREFIX: 'fwx_mix_',
    TTL: {
      STATS: 30 * 60 * 1000,      // 30 minutes
      LIKES: 60 * 60 * 1000       // 1 hour for like state
    },
    
    get: function(key) {
      try {
        var cached = localStorage.getItem(this.PREFIX + key);
        if (!cached) return null;
        var data = JSON.parse(cached);
        if (Date.now() - data.ts > (data.ttl || this.TTL.STATS)) {
          localStorage.removeItem(this.PREFIX + key);
          return null;
        }
        return data.v;
      } catch (e) { return null; }
    },
    
    set: function(key, value, ttl) {
      try {
        localStorage.setItem(this.PREFIX + key, JSON.stringify({
          v: value,
          ts: Date.now(),
          ttl: ttl || this.TTL.STATS
        }));
      } catch (e) {}
    },
    
    update: function(key, updateFn) {
      var current = this.get(key) || {};
      var updated = updateFn(current);
      this.set(key, updated);
      return updated;
    }
  };

  // Debounce tracking to prevent duplicate API calls
  var actionDebounce = {};

  function debounceAction(key, fn, delay) {
    if (actionDebounce[key]) return Promise.resolve(null);
    actionDebounce[key] = true;
    setTimeout(function() { delete actionDebounce[key]; }, delay || 2000);
    return fn();
  }

  // Handle URL parameter to scroll to specific mix
  var urlParams = new URLSearchParams(window.location.search);
  var mixTimestamp = urlParams.get('mix');
  if (mixTimestamp) {
    setTimeout(function() {
      var mixCard = document.querySelector('.mix-card[data-upload-date="' + mixTimestamp + '"]');
      if (mixCard) {
        mixCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        mixCard.style.border = '3px solid #dc2626';
        setTimeout(function() {
          mixCard.style.border = '';
        }, 3000);
      }
    }, 500);
  }

  // UI Update functions with cache
  function updatePlayCount(mixId, newCount) {
    document.querySelectorAll('.plays-count[data-mix-id="' + mixId + '"]').forEach(function(el) {
      el.textContent = newCount;
    });
    MixCache.update('stats_' + mixId, function(current) {
      current.plays = newCount;
      return current;
    });
  }

  function updateDownloadCount(mixId, newCount) {
    document.querySelectorAll('.downloads-count[data-mix-id="' + mixId + '"]').forEach(function(el) {
      el.textContent = newCount;
    });
    MixCache.update('stats_' + mixId, function(current) {
      current.downloads = newCount;
      return current;
    });
  }

  function updateLikeCount(mixId, newCount) {
    document.querySelectorAll('.likes-count[data-mix-id="' + mixId + '"]').forEach(function(el) {
      el.textContent = newCount;
    });
    MixCache.update('stats_' + mixId, function(current) {
      current.likes = newCount;
      return current;
    });
  }

  // API tracking functions with debounce
  function trackPlay(mixId) {
    return debounceAction('play_' + mixId, function() {
      return fetch('/api/track-mix-play', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    });
  }

  function trackDownload(mixId) {
    return debounceAction('download_' + mixId, function() {
      return fetch('/api/track-mix-download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    }, 5000); // 5 second debounce for downloads
  }

  function trackLike(mixId) {
    return debounceAction('like_' + mixId, function() {
      return fetch('/api/track-mix-like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    });
  }

  function trackUnlike(mixId) {
    return debounceAction('unlike_' + mixId, function() {
      return fetch('/api/track-mix-unlike', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    });
  }

  // Format duration helper
  function formatDurationClient(seconds) {
    if (!seconds || !isFinite(seconds)) return '--:--';
    var hrs = Math.floor(seconds / 3600);
    var mins = Math.floor((seconds % 3600) / 60);
    
    if (hrs > 0) {
      var hourWord = hrs === 1 ? 'hour' : 'hours';
      var minWord = mins === 1 ? 'minute' : 'minutes';
      if (mins > 0) return hrs + ' ' + hourWord + ' ' + mins + ' ' + minWord;
      return hrs + ' ' + hourWord;
    }
    var minWord = mins === 1 ? 'minute' : 'minutes';
    return mins + ' ' + minWord;
  }

  function initMixCards() {
    // Format durations
    document.querySelectorAll('.duration-display').forEach(function(el) {
      if (el.hasAttribute('data-duration-init')) return;
      el.setAttribute('data-duration-init', 'true');
      
      var duration = el.getAttribute('data-duration');
      var audioUrl = el.getAttribute('data-audio-url');
      var currentText = el.textContent;
      
      if (duration && duration !== '' && duration !== 'undefined' && duration !== 'null' && duration !== '0') {
        var seconds = parseFloat(duration);
        if (!isNaN(seconds) && seconds > 0) {
          el.textContent = formatDurationClient(seconds);
          return;
        }
      }
      
      if (currentText && currentText !== '--:--' && !currentText.includes('--')) return;
      
      // Lazy load duration from audio metadata only if needed
      if (audioUrl) {
        var tempAudio = new Audio();
        tempAudio.preload = 'metadata';
        
        tempAudio.onloadedmetadata = function() {
          if (tempAudio.duration && isFinite(tempAudio.duration)) {
            el.textContent = formatDurationClient(tempAudio.duration);
          }
        };
        
        tempAudio.src = audioUrl;
      }
    });

    // Play buttons
    document.querySelectorAll('.play-btn-action').forEach(function(btn) {
      if (btn.hasAttribute('data-play-init')) return;
      btn.setAttribute('data-play-init', 'true');
      
      var card = btn.closest('.mix-card');
      var mixId = card.getAttribute('data-mix-id');
      var playIcon = btn.querySelector('.play-icon-btn');
      var pauseIcon = btn.querySelector('.pause-icon-btn');
      var playText = btn.querySelector('.play-text-btn');

      // Sync with current player state
      if (window.FreshWaxPlayer && window.FreshWaxPlayer.currentMix && window.FreshWaxPlayer.currentMix.id === mixId && window.globalAudio && !window.globalAudio.paused) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        if (playText) playText.textContent = 'Pause';
      }

      btn.onclick = function() {
        var mixData = {
          id: mixId,
          title: card.getAttribute('data-title'),
          dj_name: card.getAttribute('data-dj'),
          artwork_url: card.getAttribute('data-artwork'),
          audio_url: card.getAttribute('data-audio-url')
        };

        // Reset all other buttons
        document.querySelectorAll('.play-btn-action').forEach(function(other) {
          if (other !== btn) {
            other.querySelector('.play-icon-btn').classList.remove('hidden');
            other.querySelector('.pause-icon-btn').classList.add('hidden');
            var otherText = other.querySelector('.play-text-btn');
            if (otherText) otherText.textContent = 'Play';
          }
        });

        // Pause shuffle widget if playing
        if (window.shuffleWidgetAudio && !window.shuffleWidgetAudio.paused) {
          window.shuffleWidgetAudio.pause();
          
          var shuffleWidget = document.getElementById('shuffle-widget');
          if (shuffleWidget) shuffleWidget.classList.remove('playing');
          
          var shuffleIconPlay = document.getElementById('shuffle-icon-play');
          var shuffleIconPause = document.getElementById('shuffle-icon-pause');
          var shuffleCtrlPlay = document.getElementById('shuffle-ctrl-play-icon');
          var shuffleCtrlPause = document.getElementById('shuffle-ctrl-pause-icon');
          
          if (shuffleIconPlay) shuffleIconPlay.classList.remove('hidden');
          if (shuffleIconPause) shuffleIconPause.classList.add('hidden');
          if (shuffleCtrlPlay) shuffleCtrlPlay.classList.remove('hidden');
          if (shuffleCtrlPause) shuffleCtrlPause.classList.add('hidden');
        }

        if (window.playMix && window.globalAudio) {
          var isThisMix = window.FreshWaxPlayer && window.FreshWaxPlayer.currentMix && window.FreshWaxPlayer.currentMix.id === mixId;
          
          if (isThisMix) {
            if (window.globalAudio.paused) {
              window.globalAudio.play().then(function() {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                if (playText) playText.textContent = 'Pause';
              });
            } else {
              window.globalAudio.pause();
              playIcon.classList.remove('hidden');
              pauseIcon.classList.add('hidden');
              if (playText) playText.textContent = 'Play';
            }
          } else {
            window.playMix(mixData).then(function() {
              playIcon.classList.add('hidden');
              pauseIcon.classList.remove('hidden');
              if (playText) playText.textContent = 'Pause';
              
              // Track play (once per session per mix)
              var trackKey = 'tracked_' + mixId;
              if (!window.FreshWaxPlayer[trackKey]) {
                window.FreshWaxPlayer[trackKey] = true;
                trackPlay(mixId).then(function(result) {
                  if (result && result.plays !== undefined) {
                    updatePlayCount(mixId, result.plays);
                  }
                });
              }
            });
          }
        }
      };
    });

    // Sync buttons with global audio state
    if (window.globalAudio) {
      var syncButtons = function() {
        var currentMixId = window.FreshWaxPlayer && window.FreshWaxPlayer.currentMix ? window.FreshWaxPlayer.currentMix.id : null;
        var isPlaying = window.globalAudio && !window.globalAudio.paused;
        
        document.querySelectorAll('.play-btn-action').forEach(function(btn) {
          var card = btn.closest('.mix-card');
          var mixId = card.getAttribute('data-mix-id');
          var playIcon = btn.querySelector('.play-icon-btn');
          var pauseIcon = btn.querySelector('.pause-icon-btn');
          var playText = btn.querySelector('.play-text-btn');
          
          if (mixId === currentMixId && isPlaying) {
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            if (playText) playText.textContent = 'Pause';
          } else {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            if (playText) playText.textContent = 'Play';
          }
        });
      };
      
      window.globalAudio.addEventListener('play', syncButtons);
      window.globalAudio.addEventListener('pause', syncButtons);
      window.globalAudio.addEventListener('ended', syncButtons);
    }

    // Download buttons - async with proper feedback
    document.querySelectorAll('.download-btn').forEach(function(btn) {
      if (btn.hasAttribute('data-download-init')) return;
      btn.setAttribute('data-download-init', 'true');
      
      btn.onclick = async function(e) {
        e.preventDefault();
        
        var mixId = btn.getAttribute('data-mix-id');
        var audioUrl = btn.getAttribute('data-audio-url');
        var title = btn.getAttribute('data-title');
        var dj = btn.getAttribute('data-dj');
        var filename = (dj + ' - ' + title + '.mp3').replace(/[^a-z0-9\s\-\.]/gi, '_');
        
        var downloadIcon = btn.querySelector('.download-icon');
        var checkIcon = btn.querySelector('.check-icon');
        var btnText = btn.querySelector('.btn-text');
        
        btn.disabled = true;
        btn.classList.add('downloading');
        if (btnText) btnText.textContent = 'Downloading...';
        
        // Track download
        trackDownload(mixId).then(function(result) {
          if (result && result.downloads !== undefined) {
            updateDownloadCount(mixId, result.downloads);
          }
        });
        
        try {
          // Use server-side proxy to fetch the file
          var proxyUrl = '/api/download?url=' + encodeURIComponent(audioUrl) + '&filename=' + encodeURIComponent(filename);
          
          var response = await fetch(proxyUrl);
          if (!response.ok) {
            throw new Error('Download failed: ' + response.status);
          }
          
          var blob = await response.blob();
          var blobUrl = window.URL.createObjectURL(blob);
          
          var link = document.createElement('a');
          link.href = blobUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          window.URL.revokeObjectURL(blobUrl);
          
          // Show success state
          if (downloadIcon) downloadIcon.classList.add('hidden');
          if (checkIcon) checkIcon.classList.remove('hidden');
          if (btnText) btnText.textContent = 'Downloaded!';
          btn.classList.remove('downloading');
          btn.classList.add('downloaded');
          
          // Reset after 3 seconds
          setTimeout(function() {
            if (downloadIcon) downloadIcon.classList.remove('hidden');
            if (checkIcon) checkIcon.classList.add('hidden');
            if (btnText) btnText.textContent = 'Download';
            btn.disabled = false;
            btn.classList.remove('downloaded');
          }, 3000);
          
        } catch (error) {
          console.error('Download error:', error);
          if (btnText) btnText.textContent = 'Error - Retry';
          btn.classList.remove('downloading');
          
          setTimeout(function() {
            if (downloadIcon) downloadIcon.classList.remove('hidden');
            if (checkIcon) checkIcon.classList.add('hidden');
            if (btnText) btnText.textContent = 'Download';
            btn.disabled = false;
          }, 2000);
        }
      };
    });

    // Like buttons
    document.querySelectorAll('.like-btn').forEach(function(btn) {
      if (btn.hasAttribute('data-like-init')) return;
      btn.setAttribute('data-like-init', 'true');
      
      var mixId = btn.getAttribute('data-mix-id');
      var likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
      var likeText = btn.querySelector('.like-text-btn');
      var likedText = btn.querySelector('.liked-text-btn');
      
      if (likedMixes.includes(mixId)) {
        btn.setAttribute('data-liked', 'true');
        if (likeText) likeText.style.display = 'none';
        if (likedText) likedText.style.display = 'inline';
      }
      
      btn.onclick = function() {
        var isLiked = btn.getAttribute('data-liked') === 'true';
        
        if (isLiked) {
          // Optimistic UI update
          btn.setAttribute('data-liked', 'false');
          if (likeText) likeText.style.display = 'inline';
          if (likedText) likedText.style.display = 'none';
          
          var liked = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
          var idx = liked.indexOf(mixId);
          if (idx > -1) {
            liked.splice(idx, 1);
            localStorage.setItem('liked-mixes', JSON.stringify(liked));
          }
          
          trackUnlike(mixId).then(function(result) {
            if (result && result.likes !== undefined) updateLikeCount(mixId, result.likes);
          });
        } else {
          // Optimistic UI update
          btn.setAttribute('data-liked', 'true');
          if (likeText) likeText.style.display = 'none';
          if (likedText) likedText.style.display = 'inline';
          
          var liked = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
          if (!liked.includes(mixId)) {
            liked.push(mixId);
            localStorage.setItem('liked-mixes', JSON.stringify(liked));
          }
          
          trackLike(mixId).then(function(result) {
            if (result && result.likes !== undefined) updateLikeCount(mixId, result.likes);
          });
        }
      };
    });

    // Share buttons
    document.querySelectorAll('.share-btn').forEach(function(btn) {
      if (btn.hasAttribute('data-share-init')) return;
      btn.setAttribute('data-share-init', 'true');
      
      btn.onclick = function() {
        var title = btn.getAttribute('data-title');
        var dj = btn.getAttribute('data-dj');
        var card = btn.closest('.mix-card');
        var uploadDate = card.getAttribute('data-upload-date');
        var shareUrl = window.location.origin + '/dj-mixes?mix=' + uploadDate;
        
        document.getElementById('shareModalTitle').textContent = title;
        document.getElementById('shareModalDJ').textContent = dj;
        document.getElementById('shareLink').value = shareUrl;
        document.getElementById('shareModal').classList.remove('hidden');
      };
    });
  }

  // Share modal handlers (single initialization)
  if (!window.shareModalInitialized) {
    window.shareModalInitialized = true;
    
    var closeShareModal = document.getElementById('closeShareModal');
    if (closeShareModal) {
      closeShareModal.onclick = function() {
        document.getElementById('shareModal').classList.add('hidden');
      };
    }

    var shareModalBackdrop = document.querySelector('#shareModal .modal-backdrop');
    if (shareModalBackdrop) {
      shareModalBackdrop.onclick = function() {
        document.getElementById('shareModal').classList.add('hidden');
      };
    }

    var copyShareButton = document.getElementById('copyShareButton');
    if (copyShareButton) {
      copyShareButton.onclick = function() {
        var link = document.getElementById('shareLink').value;
        var btnText = document.getElementById('copyShareButtonText');
        var feedback = document.getElementById('copyFeedback');
        
        navigator.clipboard.writeText(link).then(function() {
          btnText.textContent = 'Copied!';
          feedback.textContent = '‚úì Link copied!';
          feedback.style.color = '#16a34a';
          
          setTimeout(function() {
            btnText.textContent = 'Copy';
            feedback.textContent = '';
          }, 2000);
        }).catch(function() {
          feedback.textContent = '‚úó Failed';
          feedback.style.color = '#dc2626';
        });
      };
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        var modal = document.getElementById('shareModal');
        if (modal) modal.classList.add('hidden');
      }
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMixCards);
  } else {
    initMixCards();
  }

  document.addEventListener('astro:page-load', function() {
    setTimeout(initMixCards, 50);
  });
</script>