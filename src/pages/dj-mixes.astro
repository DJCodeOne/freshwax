---
// src/pages/dj-mixes.astro
// OPTIMIZED: Direct Firebase import - no internal HTTP calls
// - Extended cache TTLs (30 min for stats)
// - Debounced interactions prevent duplicate API calls
// - Lazy audio metadata loading
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FloatingShuffleButton from '../components/FloatingShuffleButton.astro';
import { getDJMixesForPage } from '../lib/dj-mixes';
import { initializeApp, cert, getApps } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';
import '../styles/dj-mixes.css';

// Initialize Firebase Admin for settings
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

// Direct Firebase call - no HTTP overhead
let mixes: any[] = [];
let showMixCharts = false;

try {
  mixes = await getDJMixesForPage(50);
  
  // Get settings for mix chart visibility
  const settingsDoc = await db.collection('settings').doc('admin').get();
  if (settingsDoc.exists) {
    showMixCharts = settingsDoc.data()?.showMixCharts || false;
  }
} catch (error) {
  console.error('[DJ-MIXES PAGE] Error loading mixes:', error);
  // Silent fail - mixes will be empty array
}

// Calculate chart rankings if enabled
let chartMixes: any[] = [];
if (showMixCharts && mixes.length > 0) {
  chartMixes = mixes.map(mix => {
    const plays = mix.plays || mix.playCount || 0;
    const likes = mix.likes || mix.likeCount || 0;
    const downloads = mix.downloads || mix.downloadCount || 0;
    const comments = mix.comments || mix.commentCount || 0;
    const rating = Math.round((plays * 0.3 + likes * 2 + downloads * 1.5 + comments * 3) / 10);
    return { ...mix, rating };
  }).sort((a, b) => b.rating - a.rating).slice(0, 10);
}

// Helper function to format duration in human readable format
function formatDuration(seconds: number | string | null | undefined): string {
  if (!seconds) return '--:--';
  const numSeconds = typeof seconds === 'string' ? parseFloat(seconds) : seconds;
  if (!numSeconds || isNaN(numSeconds)) return '--:--';
  
  const hrs = Math.floor(numSeconds / 3600);
  const mins = Math.floor((numSeconds % 3600) / 60);
  
  if (hrs > 0) {
    const hourWord = hrs === 1 ? 'hour' : 'hours';
    const minWord = mins === 1 ? 'minute' : 'minutes';
    if (mins > 0) {
      return `${hrs} ${hourWord} ${mins} ${minWord}`;
    }
    return `${hrs} ${hourWord}`;
  }
  const minWord = mins === 1 ? 'minute' : 'minutes';
  return `${mins} ${minWord}`;
}

// Helper to get duration from mix object
function getMixDuration(mix: any): number | null {
  if (mix.durationSeconds && typeof mix.durationSeconds === 'number') {
    return mix.durationSeconds;
  }
  if (mix.duration && typeof mix.duration === 'string' && mix.duration.includes(':')) {
    const parts = mix.duration.split(':').map(Number);
    if (parts.length === 3) {
      return parts[0] * 3600 + parts[1] * 60 + parts[2];
    } else if (parts.length === 2) {
      return parts[0] * 60 + parts[1];
    }
  }
  return mix.duration_seconds || mix.mixDuration || null;
}

// Extract unique genres from mixes for filter
const genreCounts = new Map<string, number>();
mixes.forEach(mix => {
  const genre = mix.genre || 'Jungle & D&B';
  genreCounts.set(genre, (genreCounts.get(genre) || 0) + 1);
});

// Sort genres by count (most common first), then alphabetically
const sortedGenres = Array.from(genreCounts.entries())
  .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
  .map(([genre, count]) => ({ genre, count }));

// Core genres to always show (if they exist)
const coreGenres = ['Jungle', 'Drum and Bass', 'Ragga Jungle', 'Hardcore', 'Old Skool'];
const otherGenres = sortedGenres.filter(g => !coreGenres.includes(g.genre));
---

<Layout title="DJ Mixes - Fresh Wax">
  <Header />
  
  <main class="dj-mixes-main">
    <!-- Background Image -->
    <div class="bg-image-overlay"></div>
    
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-grid-overlay"></div>
      
      <div class="hero-container">
        <div class="hero-content">
          <h1 class="hero-title">FRESH <span class="red">SESSIONS</span></h1>
          <p class="hero-subtitle">Jungle & Drum and Bass DJ Sets</p>
        </div>
      </div>
    </section>

    <!-- Main Content with Sidebar -->
    <div class="mixes-layout">
      
      <!-- Genre Sidebar - Desktop -->
      <aside class="genre-sidebar">
        <div class="sidebar-inner">
          <!-- Sidebar Header -->
          <div class="sidebar-header">
            <div class="sidebar-title">Genres</div>
            <p class="sidebar-subtitle">
              {sortedGenres.length} genre{sortedGenres.length !== 1 ? 's' : ''} ‚Ä¢ {mixes.length} mix{mixes.length !== 1 ? 'es' : ''}
            </p>
          </div>
          
          <!-- Genre Navigation -->
          <nav class="genre-nav">
            <button class="genre-nav-btn active" data-genre="all">
              <div class="genre-nav-content">
                <span class="genre-name">All Mixes</span>
                <span class="genre-count">{mixes.length}</span>
              </div>
              <svg class="genre-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
            
            {coreGenres.map(genre => {
              const genreData = sortedGenres.find(g => g.genre === genre);
              return genreData ? (
                <button class="genre-nav-btn" data-genre={genre}>
                  <div class="genre-nav-content">
                    <span class="genre-name">{genre}</span>
                    <span class="genre-count">{genreData.count}</span>
                  </div>
                  <svg class="genre-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              ) : null;
            })}
            
            {otherGenres.length > 0 && (
              <div class="sidebar-divider"></div>
            )}
            
            {otherGenres.map(({ genre, count }) => (
              <button class="genre-nav-btn" data-genre={genre}>
                <div class="genre-nav-content">
                  <span class="genre-name">{genre}</span>
                  <span class="genre-count">{count}</span>
                </div>
                <svg class="genre-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            ))}
          </nav>
        </div>
      </aside>

      <!-- Main Mixes Content -->
      <section class="mixes-section">
        <!-- Header Container -->
        <div class="section-header">
          <div class="header-pattern"></div>
          
          <div class="header-content">
            <div class="header-text">
              <h2 class="section-title">Latest Mixes</h2>
              <p class="section-subtitle">Stream or download full DJ sets ‚Ä¢ <span id="mix-count">{mixes.length}</span> available</p>
            </div>
            <a href="/upload-mix" class="upload-mix-btn">
              üì§ Upload Mix
            </a>
          </div>
        </div>

        <!-- Mobile Genre Filter (horizontal scroll) -->
        <div class="genre-filter-mobile">
          <div class="genre-filter-scroll">
            <button class="genre-filter-btn active" data-genre="all">All ({mixes.length})</button>
            {coreGenres.map(genre => {
              const genreData = sortedGenres.find(g => g.genre === genre);
              return genreData ? (
                <button class="genre-filter-btn" data-genre={genre}>{genre} ({genreData.count})</button>
              ) : null;
            })}
            {otherGenres.map(({ genre, count }) => (
              <button class="genre-filter-btn" data-genre={genre}>{genre} ({count})</button>
            ))}
          </div>
        </div>

      {mixes.length === 0 ? (
        <div class="empty-state">
          <div class="empty-icon">üéß</div>
          <h3 class="empty-title">No Mixes Yet</h3>
          <p class="empty-text">New mixes coming soon!</p>
        </div>
      ) : (
        <div class="mixes-list" id="mixes-list">
          {mixes.map((mix, index) => (
            <article 
              class="mix-card"
              data-mix-id={mix.id}
              data-genre={mix.genre || 'Jungle & D&B'}
              data-upload-date={mix.upload_date}
              data-audio-url={mix.audio_url}
              data-title={mix.title}
              data-dj={mix.dj_name}
              data-artwork={mix.artwork_url}
              data-duration={getMixDuration(mix)}
            >
              <!-- Artwork -->
              <div class="mix-artwork-container">
                <img 
                  src={mix.artwork_url} 
                  alt={mix.title}
                  class="mix-artwork"
                  loading="lazy"
                  onerror="this.src='/place-holder.webp'"
                />
              </div>

              <!-- Mix Info -->
              <div class="mix-info">
                <div class="mix-header">
                  <h3 class="mix-title">{mix.title}</h3>
                  <p class="mix-dj">{mix.dj_name}</p>
                </div>
                
                <!-- Meta Row -->
                <div class="mix-meta-row">
                  <span class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="duration-display" data-duration={getMixDuration(mix)} data-audio-url={mix.audio_url}>{formatDuration(getMixDuration(mix))}</span>
                  </span>
                  <span class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {new Date(mix.upload_date).toLocaleDateString('en-GB', {
                      day: 'numeric',
                      month: 'short',
                      year: 'numeric'
                    })}
                  </span>
                  <span class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                    </svg>
                    {mix.genre || 'Jungle & D&B'}
                  </span>
                </div>

                <!-- Stats Row -->
                <div class="mix-stats">
                  <span class="stat">
                    <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <span class="plays-count" data-mix-id={mix.id}>{mix.plays || 0}</span> plays
                  </span>
                  <span class="stat">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    <span class="downloads-count" data-mix-id={mix.id}>{mix.downloads || 0}</span> downloads
                  </span>
                  <span class="stat">
                    <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span class="likes-count" data-mix-id={mix.id}>{mix.likes || 0}</span> likes
                  </span>
                  <span class="stat">
                    <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <span class="comments-count" data-mix-id={mix.id}>{mix.commentCount || 0}</span> comments
                  </span>
                </div>

                <!-- Action Buttons -->
                <div class="mix-actions">
                  <!-- Play Button -->
                  <button 
                    class="action-btn play-btn-action"
                    data-mix-id={mix.id}
                    title="Play"
                  >
                    <svg class="btn-icon play-icon-btn" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="btn-icon pause-icon-btn hidden" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                    <span class="btn-text play-text-btn">Play</span>
                  </button>

                  <!-- Info Button -->
                  <a 
                    href={`/dj-mix/${mix.id}`}
                    class="action-btn"
                    title="View Details"
                  >
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="btn-text">Info</span>
                  </a>

                  <!-- Like Button -->
                  <button 
                    class="action-btn like-btn"
                    data-mix-id={mix.id}
                    data-liked="false"
                    title="Like"
                  >
                    <svg class="btn-icon like-icon-btn" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <span class="btn-text like-text-btn">Like</span>
                    <span class="btn-text liked-text-btn hidden">Liked</span>
                  </button>

                  <!-- Share Button -->
                  <button 
                    class="action-btn share-btn"
                    data-mix-id={mix.id}
                    data-title={mix.title}
                    data-dj={mix.dj_name}
                    title="Share"
                  >
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    <span class="btn-text">Share</span>
                  </button>

                  <!-- Download Button -->
                  <button 
                    class="action-btn primary download-btn"
                    data-mix-id={mix.id}
                    data-audio-url={mix.audio_url}
                    data-title={mix.title}
                    data-dj={mix.dj_name}
                  >
                    <svg class="btn-icon download-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    <svg class="btn-icon check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="btn-text">Download</span>
                  </button>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}
    </section>
    </div><!-- End mixes-layout -->
    
    <!-- Floating All-Time Mix Chart -->
    {showMixCharts && chartMixes.length > 0 && (
      <div id="floating-chart" class="floating-chart">
        <button id="toggle-chart" class="chart-toggle" title="Toggle Chart">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>TOP 10</span>
        </button>
        <div class="chart-panel">
          <div class="chart-header">
            <div class="chart-title-row">
              <span class="chart-icon">üèÜ</span>
              <h3>ALL-TIME MIX CHART</h3>
            </div>
            <p class="chart-subtitle">Based on plays, likes & downloads</p>
          </div>
          <div class="chart-list">
            {chartMixes.map((mix, index) => (
              <a href={`/dj-mix/${mix.id}`} class="chart-item">
                <span class={`chart-position ${index < 3 ? 'top-3' : ''}`}>
                  {index === 0 && 'ü•á'}
                  {index === 1 && 'ü•à'}
                  {index === 2 && 'ü•â'}
                  {index > 2 && `#${index + 1}`}
                </span>
                <img 
                  src={mix.imageUrl || mix.artworkUrl || mix.artwork_url || '/place-holder.webp'} 
                  alt={mix.title}
                  class="chart-artwork"
                />
                <div class="chart-info">
                  <span class="chart-mix-title">{mix.title?.substring(0, 25)}{mix.title?.length > 25 ? '...' : ''}</span>
                  <span class="chart-mix-dj">{mix.djName || mix.dj_name}</span>
                </div>
                <div class="chart-stats">
                  <span class="chart-rating">‚≠ê {mix.rating}</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    )}
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Share Mix</h3>
        <button class="modal-close" id="closeShareModal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="modal-subtitle">
          <span id="shareModalTitle"></span> by <span id="shareModalDJ"></span>
        </p>
        <div class="share-input-group">
          <input type="text" id="shareLink" readonly />
          <button id="copyShareButton">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <span id="copyShareButtonText">Copy</span>
          </button>
        </div>
        <p class="copy-feedback" id="copyFeedback"></p>
      </div>
    </div>
  </div>

  <FloatingShuffleButton />
  <Footer />

  <!-- Floating All-Time Chart Panel (Hidden by default) -->
  <div id="floatingChart" class="floating-chart hidden">
    <div class="chart-header">
      <h3>üèÜ All-Time Mix Chart</h3>
      <button id="closeChart" class="chart-close">√ó</button>
    </div>
    <div class="chart-content">
      <div id="chartList" class="chart-list">
        <div class="chart-loading">Loading chart...</div>
      </div>
    </div>
  </div>

  <!-- Chart Toggle Button (Hidden by default) -->
  <button id="chartToggleBtn" class="chart-toggle-btn hidden" title="View All-Time Chart">
    üèÜ
  </button>
</Layout>

<script>
  // Floating chart functionality
  document.addEventListener('DOMContentLoaded', async function() {
    const floatingChart = document.getElementById('floatingChart');
    const chartToggleBtn = document.getElementById('chartToggleBtn');
    const closeChart = document.getElementById('closeChart');
    const chartList = document.getElementById('chartList');

    // Check if charts feature is enabled
    try {
      const response = await fetch('/api/admin/get-settings');
      const data = await response.json();
      
      if (data.success && data.settings?.showMixCharts) {
        // Show the toggle button
        chartToggleBtn?.classList.remove('hidden');
        
        // Load chart data
        loadChartData();
      }
    } catch (error) {
    }

    // Toggle chart visibility
    chartToggleBtn?.addEventListener('click', function() {
      floatingChart?.classList.toggle('hidden');
      floatingChart?.classList.toggle('visible');
    });

    // Close chart
    closeChart?.addEventListener('click', function() {
      floatingChart?.classList.add('hidden');
      floatingChart?.classList.remove('visible');
    });

    // Load chart data
    async function loadChartData() {
      try {
        const response = await fetch('/api/get-mix-chart');
        const data = await response.json();
        
        if (data.success && data.chart && data.chart.length > 0) {
          chartList.innerHTML = data.chart.slice(0, 10).map((mix, index) => `
            <a href="/dj-mix/${mix.id}" class="chart-item">
              <span class="chart-position">${index + 1}</span>
              <img src="${mix.artwork_url || '/place-holder.webp'}" alt="${mix.title}" class="chart-artwork" />
              <div class="chart-info">
                <span class="chart-title">${mix.title || 'Untitled'}</span>
                <span class="chart-dj">${mix.dj_name || 'Unknown DJ'}</span>
              </div>
              <span class="chart-score">${mix.score || 0}</span>
            </a>
          `).join('');
        } else {
          chartList.innerHTML = '<div class="chart-empty">No chart data yet</div>';
        }
      } catch (error) {
        console.error('[DJ-MIXES] Chart load error:', error);
        chartList.innerHTML = '<div class="chart-empty">Failed to load chart</div>';
      }
    }
  });
</script>


<script>
  // ============================================
  // GENRE FILTER SYSTEM
  // ============================================
  (function() {
    // Get both mobile and sidebar filter buttons
    var mobileFilterBtns = document.querySelectorAll('.genre-filter-btn');
    var sidebarFilterBtns = document.querySelectorAll('.genre-nav-btn');
    var allFilterBtns = document.querySelectorAll('.genre-filter-btn, .genre-nav-btn');
    var mixesList = document.getElementById('mixes-list');
    var mixCountEl = document.getElementById('mix-count');
    var allMixCards = mixesList ? mixesList.querySelectorAll('.mix-card') : [];
    var totalMixes = allMixCards.length;
    
    if (!allFilterBtns.length || !mixesList) return;
    
    // Remove any existing no-results message
    function removeNoResultsMessage() {
      var existing = mixesList.querySelector('.no-results-message');
      if (existing) existing.remove();
    }
    
    // Show no results message
    function showNoResultsMessage(genre) {
      removeNoResultsMessage();
      var msg = document.createElement('div');
      msg.className = 'no-results-message';
      msg.innerHTML = '<p>No mixes found in "' + genre + '"</p><button onclick="document.querySelector(\'.genre-nav-btn[data-genre=all], .genre-filter-btn[data-genre=all]\').click()">Show All Mixes</button>';
      mixesList.appendChild(msg);
    }
    
    // Filter mixes by genre
    function filterMixes(genre) {
      removeNoResultsMessage();
      var visibleCount = 0;
      
      allMixCards.forEach(function(card) {
        var cardGenre = card.getAttribute('data-genre') || '';
        
        if (genre === 'all') {
          card.classList.remove('filtered-out');
          visibleCount++;
        } else {
          // Check if card genre matches (case-insensitive, partial match)
          var matches = cardGenre.toLowerCase().indexOf(genre.toLowerCase()) !== -1;
          
          // Also match "Drum and Bass" with "D&B" and variations
          if (!matches && genre === 'Drum and Bass') {
            matches = cardGenre.toLowerCase().indexOf('d&b') !== -1 || 
                      cardGenre.toLowerCase().indexOf('dnb') !== -1 ||
                      cardGenre.toLowerCase().indexOf('drum') !== -1;
          }
          
          if (matches) {
            card.classList.remove('filtered-out');
            visibleCount++;
          } else {
            card.classList.add('filtered-out');
          }
        }
      });
      
      // Update count display
      if (mixCountEl) {
        mixCountEl.textContent = visibleCount;
      }
      
      // Show no results if nothing visible
      if (visibleCount === 0 && genre !== 'all') {
        showNoResultsMessage(genre);
      }
    }
    
    // Sync active state across both mobile and sidebar buttons
    function syncActiveState(genre) {
      // Update mobile buttons
      mobileFilterBtns.forEach(function(b) { 
        if (b.getAttribute('data-genre') === genre) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
      
      // Update sidebar buttons
      sidebarFilterBtns.forEach(function(b) { 
        if (b.getAttribute('data-genre') === genre) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
    }
    
    // Attach click handlers to all filter buttons
    allFilterBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var genre = this.getAttribute('data-genre');
        
        // Sync active state across all buttons
        syncActiveState(genre);
        
        // Filter mixes
        filterMixes(genre);
      });
    });
  })();
  
  // ============================================
  // FLOATING CHART TOGGLE
  // ============================================
  (function() {
    var toggleBtn = document.getElementById('toggle-chart');
    var floatingChart = document.getElementById('floating-chart');
    
    if (toggleBtn && floatingChart) {
      toggleBtn.addEventListener('click', function() {
        floatingChart.classList.toggle('open');
      });
      
      // Close when clicking outside
      document.addEventListener('click', function(e) {
        if (!floatingChart.contains(e.target) && floatingChart.classList.contains('open')) {
          floatingChart.classList.remove('open');
        }
      });
    }
  })();
  
  // ============================================
  // CACHE SYSTEM - API FRIENDLY
  // Extended TTLs to reduce API calls
  // ============================================
  var MixCache = {
    PREFIX: 'fwx_mix_',
    TTL: {
      STATS: 30 * 60 * 1000,      // 30 minutes
      LIKES: 60 * 60 * 1000       // 1 hour for like state
    },
    
    get: function(key) {
      try {
        var cached = localStorage.getItem(this.PREFIX + key);
        if (!cached) return null;
        var data = JSON.parse(cached);
        if (Date.now() - data.ts > (data.ttl || this.TTL.STATS)) {
          localStorage.removeItem(this.PREFIX + key);
          return null;
        }
        return data.v;
      } catch (e) { return null; }
    },
    
    set: function(key, value, ttl) {
      try {
        localStorage.setItem(this.PREFIX + key, JSON.stringify({
          v: value,
          ts: Date.now(),
          ttl: ttl || this.TTL.STATS
        }));
      } catch (e) {}
    },
    
    update: function(key, updateFn) {
      var current = this.get(key) || {};
      var updated = updateFn(current);
      this.set(key, updated);
      return updated;
    }
  };

  // Debounce tracking to prevent duplicate API calls
  var actionDebounce = {};

  function debounceAction(key, fn, delay) {
    if (actionDebounce[key]) return Promise.resolve(null);
    actionDebounce[key] = true;
    setTimeout(function() { delete actionDebounce[key]; }, delay || 2000);
    return fn();
  }

  // Handle URL parameter to scroll to specific mix
  var urlParams = new URLSearchParams(window.location.search);
  var mixTimestamp = urlParams.get('mix');
  if (mixTimestamp) {
    setTimeout(function() {
      var mixCard = document.querySelector('.mix-card[data-upload-date="' + mixTimestamp + '"]');
      if (mixCard) {
        mixCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        mixCard.style.border = '3px solid #dc2626';
        setTimeout(function() {
          mixCard.style.border = '';
        }, 3000);
      }
    }, 500);
  }

  // UI Update functions with cache
  function updatePlayCount(mixId, newCount) {
    document.querySelectorAll('.plays-count[data-mix-id="' + mixId + '"]').forEach(function(el) {
      el.textContent = newCount;
    });
    MixCache.update('stats_' + mixId, function(current) {
      current.plays = newCount;
      return current;
    });
  }

  function updateDownloadCount(mixId, newCount) {
    document.querySelectorAll('.downloads-count[data-mix-id="' + mixId + '"]').forEach(function(el) {
      el.textContent = newCount;
    });
    MixCache.update('stats_' + mixId, function(current) {
      current.downloads = newCount;
      return current;
    });
  }

  function updateLikeCount(mixId, newCount) {
    document.querySelectorAll('.likes-count[data-mix-id="' + mixId + '"]').forEach(function(el) {
      el.textContent = newCount;
    });
    MixCache.update('stats_' + mixId, function(current) {
      current.likes = newCount;
      return current;
    });
  }

  // API tracking functions with debounce
  function trackPlay(mixId) {
    return debounceAction('play_' + mixId, function() {
      return fetch('/api/track-mix-play', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    });
  }

  function trackDownload(mixId) {
    return debounceAction('download_' + mixId, function() {
      return fetch('/api/track-mix-download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    }, 5000); // 5 second debounce for downloads
  }

  function trackLike(mixId) {
    return debounceAction('like_' + mixId, function() {
      return fetch('/api/track-mix-like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    });
  }

  function trackUnlike(mixId) {
    return debounceAction('unlike_' + mixId, function() {
      return fetch('/api/track-mix-unlike', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixId })
      }).then(function(r) { return r.json(); }).catch(function() { return null; });
    });
  }

  // Format duration helper
  function formatDurationClient(seconds) {
    if (!seconds || !isFinite(seconds)) return '--:--';
    var hrs = Math.floor(seconds / 3600);
    var mins = Math.floor((seconds % 3600) / 60);
    
    if (hrs > 0) {
      var hourWord = hrs === 1 ? 'hour' : 'hours';
      var minWord = mins === 1 ? 'minute' : 'minutes';
      if (mins > 0) return hrs + ' ' + hourWord + ' ' + mins + ' ' + minWord;
      return hrs + ' ' + hourWord;
    }
    var minWord = mins === 1 ? 'minute' : 'minutes';
    return mins + ' ' + minWord;
  }

  function initMixCards() {
    // Format durations
    document.querySelectorAll('.duration-display').forEach(function(el) {
      if (el.hasAttribute('data-duration-init')) return;
      el.setAttribute('data-duration-init', 'true');
      
      var duration = el.getAttribute('data-duration');
      var audioUrl = el.getAttribute('data-audio-url');
      var currentText = el.textContent;
      
      if (duration && duration !== '' && duration !== 'undefined' && duration !== 'null' && duration !== '0') {
        var seconds = parseFloat(duration);
        if (!isNaN(seconds) && seconds > 0) {
          el.textContent = formatDurationClient(seconds);
          return;
        }
      }
      
      if (currentText && currentText !== '--:--' && !currentText.includes('--')) return;
      
      // Lazy load duration from audio metadata only if needed
      if (audioUrl) {
        var tempAudio = new Audio();
        tempAudio.preload = 'metadata';
        
        tempAudio.onloadedmetadata = function() {
          if (tempAudio.duration && isFinite(tempAudio.duration)) {
            el.textContent = formatDurationClient(tempAudio.duration);
          }
        };
        
        tempAudio.src = audioUrl;
      }
    });

    // Play buttons
    document.querySelectorAll('.play-btn-action').forEach(function(btn) {
      if (btn.hasAttribute('data-play-init')) return;
      btn.setAttribute('data-play-init', 'true');
      
      var card = btn.closest('.mix-card');
      var mixId = card.getAttribute('data-mix-id');
      var playIcon = btn.querySelector('.play-icon-btn');
      var pauseIcon = btn.querySelector('.pause-icon-btn');
      var playText = btn.querySelector('.play-text-btn');

      // Sync with current player state
      if (window.FreshWaxPlayer && window.FreshWaxPlayer.currentMix && window.FreshWaxPlayer.currentMix.id === mixId && window.globalAudio && !window.globalAudio.paused) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        if (playText) playText.textContent = 'Pause';
      }

      btn.onclick = function() {
        var mixData = {
          id: mixId,
          title: card.getAttribute('data-title'),
          dj_name: card.getAttribute('data-dj'),
          artwork_url: card.getAttribute('data-artwork'),
          audio_url: card.getAttribute('data-audio-url')
        };

        // Reset all other buttons
        document.querySelectorAll('.play-btn-action').forEach(function(other) {
          if (other !== btn) {
            other.querySelector('.play-icon-btn').classList.remove('hidden');
            other.querySelector('.pause-icon-btn').classList.add('hidden');
            var otherText = other.querySelector('.play-text-btn');
            if (otherText) otherText.textContent = 'Play';
          }
        });

        // Pause shuffle widget if playing
        if (window.shuffleWidgetAudio && !window.shuffleWidgetAudio.paused) {
          window.shuffleWidgetAudio.pause();
          
          var shuffleWidget = document.getElementById('shuffle-widget');
          if (shuffleWidget) shuffleWidget.classList.remove('playing');
          
          var shuffleIconPlay = document.getElementById('shuffle-icon-play');
          var shuffleIconPause = document.getElementById('shuffle-icon-pause');
          var shuffleCtrlPlay = document.getElementById('shuffle-ctrl-play-icon');
          var shuffleCtrlPause = document.getElementById('shuffle-ctrl-pause-icon');
          
          if (shuffleIconPlay) shuffleIconPlay.classList.remove('hidden');
          if (shuffleIconPause) shuffleIconPause.classList.add('hidden');
          if (shuffleCtrlPlay) shuffleCtrlPlay.classList.remove('hidden');
          if (shuffleCtrlPause) shuffleCtrlPause.classList.add('hidden');
        }

        if (window.playMix && window.globalAudio) {
          var isThisMix = window.FreshWaxPlayer && window.FreshWaxPlayer.currentMix && window.FreshWaxPlayer.currentMix.id === mixId;
          
          if (isThisMix) {
            if (window.globalAudio.paused) {
              window.globalAudio.play().then(function() {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                if (playText) playText.textContent = 'Pause';
              });
            } else {
              window.globalAudio.pause();
              playIcon.classList.remove('hidden');
              pauseIcon.classList.add('hidden');
              if (playText) playText.textContent = 'Play';
            }
          } else {
            window.playMix(mixData).then(function() {
              playIcon.classList.add('hidden');
              pauseIcon.classList.remove('hidden');
              if (playText) playText.textContent = 'Pause';
              
              // Track play (once per session per mix)
              var trackKey = 'tracked_' + mixId;
              if (!window.FreshWaxPlayer[trackKey]) {
                window.FreshWaxPlayer[trackKey] = true;
                trackPlay(mixId).then(function(result) {
                  if (result && result.plays !== undefined) {
                    updatePlayCount(mixId, result.plays);
                  }
                });
              }
            });
          }
        }
      };
    });

    // Sync buttons with global audio state
    if (window.globalAudio) {
      var syncButtons = function() {
        var currentMixId = window.FreshWaxPlayer && window.FreshWaxPlayer.currentMix ? window.FreshWaxPlayer.currentMix.id : null;
        var isPlaying = window.globalAudio && !window.globalAudio.paused;
        
        document.querySelectorAll('.play-btn-action').forEach(function(btn) {
          var card = btn.closest('.mix-card');
          var mixId = card.getAttribute('data-mix-id');
          var playIcon = btn.querySelector('.play-icon-btn');
          var pauseIcon = btn.querySelector('.pause-icon-btn');
          var playText = btn.querySelector('.play-text-btn');
          
          if (mixId === currentMixId && isPlaying) {
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            if (playText) playText.textContent = 'Pause';
          } else {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            if (playText) playText.textContent = 'Play';
          }
        });
      };
      
      window.globalAudio.addEventListener('play', syncButtons);
      window.globalAudio.addEventListener('pause', syncButtons);
      window.globalAudio.addEventListener('ended', syncButtons);
    }

    // Download buttons - async with proper feedback
    document.querySelectorAll('.download-btn').forEach(function(btn) {
      if (btn.hasAttribute('data-download-init')) return;
      btn.setAttribute('data-download-init', 'true');
      
      btn.onclick = async function(e) {
        e.preventDefault();
        
        var mixId = btn.getAttribute('data-mix-id');
        var audioUrl = btn.getAttribute('data-audio-url');
        var title = btn.getAttribute('data-title');
        var dj = btn.getAttribute('data-dj');
        var filename = (dj + ' - ' + title + '.mp3').replace(/[^a-z0-9\s\-\.]/gi, '_');
        
        var downloadIcon = btn.querySelector('.download-icon');
        var checkIcon = btn.querySelector('.check-icon');
        var btnText = btn.querySelector('.btn-text');
        
        btn.disabled = true;
        btn.classList.add('downloading');
        if (btnText) btnText.textContent = 'Downloading...';
        
        // Track download
        trackDownload(mixId).then(function(result) {
          if (result && result.downloads !== undefined) {
            updateDownloadCount(mixId, result.downloads);
          }
        });
        
        try {
          // Use server-side proxy to fetch the file
          var proxyUrl = '/api/download?url=' + encodeURIComponent(audioUrl) + '&filename=' + encodeURIComponent(filename);
          
          var response = await fetch(proxyUrl);
          if (!response.ok) {
            throw new Error('Download failed: ' + response.status);
          }
          
          var blob = await response.blob();
          var blobUrl = window.URL.createObjectURL(blob);
          
          var link = document.createElement('a');
          link.href = blobUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          window.URL.revokeObjectURL(blobUrl);
          
          // Show success state
          if (downloadIcon) downloadIcon.classList.add('hidden');
          if (checkIcon) checkIcon.classList.remove('hidden');
          if (btnText) btnText.textContent = 'Downloaded!';
          btn.classList.remove('downloading');
          btn.classList.add('downloaded');
          
          // Reset after 3 seconds
          setTimeout(function() {
            if (downloadIcon) downloadIcon.classList.remove('hidden');
            if (checkIcon) checkIcon.classList.add('hidden');
            if (btnText) btnText.textContent = 'Download';
            btn.disabled = false;
            btn.classList.remove('downloaded');
          }, 3000);
          
        } catch (error) {
          console.error('Download error:', error);
          if (btnText) btnText.textContent = 'Error - Retry';
          btn.classList.remove('downloading');
          
          setTimeout(function() {
            if (downloadIcon) downloadIcon.classList.remove('hidden');
            if (checkIcon) checkIcon.classList.add('hidden');
            if (btnText) btnText.textContent = 'Download';
            btn.disabled = false;
          }, 2000);
        }
      };
    });

    // Like buttons
    document.querySelectorAll('.like-btn').forEach(function(btn) {
      if (btn.hasAttribute('data-like-init')) return;
      btn.setAttribute('data-like-init', 'true');
      
      var mixId = btn.getAttribute('data-mix-id');
      var likedMixes = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
      var likeText = btn.querySelector('.like-text-btn');
      var likedText = btn.querySelector('.liked-text-btn');
      
      if (likedMixes.includes(mixId)) {
        btn.setAttribute('data-liked', 'true');
        if (likeText) likeText.style.display = 'none';
        if (likedText) likedText.style.display = 'inline';
      }
      
      btn.onclick = function() {
        var isLiked = btn.getAttribute('data-liked') === 'true';
        
        if (isLiked) {
          // Optimistic UI update
          btn.setAttribute('data-liked', 'false');
          if (likeText) likeText.style.display = 'inline';
          if (likedText) likedText.style.display = 'none';
          
          var liked = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
          var idx = liked.indexOf(mixId);
          if (idx > -1) {
            liked.splice(idx, 1);
            localStorage.setItem('liked-mixes', JSON.stringify(liked));
          }
          
          trackUnlike(mixId).then(function(result) {
            if (result && result.likes !== undefined) updateLikeCount(mixId, result.likes);
          });
        } else {
          // Optimistic UI update
          btn.setAttribute('data-liked', 'true');
          if (likeText) likeText.style.display = 'none';
          if (likedText) likedText.style.display = 'inline';
          
          var liked = JSON.parse(localStorage.getItem('liked-mixes') || '[]');
          if (!liked.includes(mixId)) {
            liked.push(mixId);
            localStorage.setItem('liked-mixes', JSON.stringify(liked));
          }
          
          trackLike(mixId).then(function(result) {
            if (result && result.likes !== undefined) updateLikeCount(mixId, result.likes);
          });
        }
      };
    });

    // Share buttons
    document.querySelectorAll('.share-btn').forEach(function(btn) {
      if (btn.hasAttribute('data-share-init')) return;
      btn.setAttribute('data-share-init', 'true');
      
      btn.onclick = function() {
        var title = btn.getAttribute('data-title');
        var dj = btn.getAttribute('data-dj');
        var card = btn.closest('.mix-card');
        var uploadDate = card.getAttribute('data-upload-date');
        var shareUrl = window.location.origin + '/dj-mixes?mix=' + uploadDate;
        
        document.getElementById('shareModalTitle').textContent = title;
        document.getElementById('shareModalDJ').textContent = dj;
        document.getElementById('shareLink').value = shareUrl;
        document.getElementById('shareModal').classList.remove('hidden');
      };
    });
  }

  // Share modal handlers (single initialization)
  if (!window.shareModalInitialized) {
    window.shareModalInitialized = true;
    
    var closeShareModal = document.getElementById('closeShareModal');
    if (closeShareModal) {
      closeShareModal.onclick = function() {
        document.getElementById('shareModal').classList.add('hidden');
      };
    }

    var shareModalBackdrop = document.querySelector('#shareModal .modal-backdrop');
    if (shareModalBackdrop) {
      shareModalBackdrop.onclick = function() {
        document.getElementById('shareModal').classList.add('hidden');
      };
    }

    var copyShareButton = document.getElementById('copyShareButton');
    if (copyShareButton) {
      copyShareButton.onclick = function() {
        var link = document.getElementById('shareLink').value;
        var btnText = document.getElementById('copyShareButtonText');
        var feedback = document.getElementById('copyFeedback');
        
        navigator.clipboard.writeText(link).then(function() {
          btnText.textContent = 'Copied!';
          feedback.textContent = '‚úì Link copied!';
          feedback.style.color = '#16a34a';
          
          setTimeout(function() {
            btnText.textContent = 'Copy';
            feedback.textContent = '';
          }, 2000);
        }).catch(function() {
          feedback.textContent = '‚úó Failed';
          feedback.style.color = '#dc2626';
        });
      };
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        var modal = document.getElementById('shareModal');
        if (modal) modal.classList.add('hidden');
      }
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMixCards);
  } else {
    initMixCards();
  }

  document.addEventListener('astro:page-load', function() {
    setTimeout(initMixCards, 50);
  });
</script>