---
// DJ Lobby - Book a Slot
// Compact 24-hour booking grid with stream key generation
import '../../styles/global.css';
export const prerender = false;
---
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book a Slot | Fresh Wax</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script is:inline>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
      authDomain: "freshwax-store.firebaseapp.com",
      projectId: "freshwax-store",
      storageBucket: "freshwax-store.firebasestorage.app",
      messagingSenderId: "675435782973",
      appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
    };
  </script>
</head>
<body>
  <!-- Loading -->
  <div id="loadingGate" class="loading-gate">
    <div class="loader"></div>
    <p>Loading...</p>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="main-content hidden">
    <header class="header">
      <a href="/account/dj-lobby" class="back-btn">‚Üê DJ Lobby</a>
      <h1>BOOK A <span class="red">SLOT</span></h1>
      <span id="userName" class="user-info"></span>
    </header>

    <div class="layout">
      <!-- Schedule Grid -->
      <section class="schedule-section">
        <div class="schedule-nav">
          <button id="prevDay" class="nav-btn">‚Äπ</button>
          <div class="date-display">
            <span id="dateLabel" class="date-label">Today</span>
            <span id="dateFull" class="date-full"></span>
          </div>
          <button id="nextDay" class="nav-btn">‚Ä∫</button>
        </div>

        <div class="grid-container">
          <div id="hourGrid" class="hour-grid">
            <!-- 24 cells rendered by JS -->
          </div>
        </div>

        <div class="legend">
          <span><span class="dot open"></span>Open</span>
          <span><span class="dot booked"></span>Booked</span>
          <span><span class="dot yours"></span>Yours</span>
          <span><span class="dot selected"></span>Selected</span>
        </div>
      </section>

      <!-- Booking Form -->
      <section class="form-section">
        <form id="bookingForm">
          <div class="form-group">
            <label>DJ Name *</label>
            <input type="text" id="djName" required maxlength="25" placeholder="Your DJ name">
          </div>

          <div class="form-group">
            <label>Stream Title *</label>
            <input type="text" id="streamTitle" required maxlength="50" placeholder="e.g. Sunday Vibes">
          </div>

          <div class="form-group">
            <label>Genre/Style</label>
            <input type="text" id="genre" maxlength="30" placeholder="e.g. House, Techno, Garage">
          </div>

          <div class="duration-row">
            <span>Duration:</span>
            <button type="button" class="dur-btn" data-dur="1">1hr</button>
            <button type="button" class="dur-btn active" data-dur="2">2hr</button>
          </div>

          <div id="selectionBox" class="selection-box hidden">
            <span id="selectionText"></span>
            <button type="button" id="clearBtn" class="clear-btn">√ó</button>
          </div>

          <div class="form-footer">
            <span id="allowance" class="allowance">2hrs left today</span>
            <button type="submit" id="submitBtn" class="submit-btn" disabled>Book Slot</button>
          </div>
        </form>

        <div id="formMsg" class="form-msg hidden"></div>

        <!-- Your Bookings -->
        <div class="bookings-panel">
          <h3>Your Upcoming Slots</h3>
          <div id="myBookings" class="my-bookings">
            <p class="empty">No bookings yet</p>
          </div>
        </div>

        <!-- Stream Key Info -->
        <div id="streamKeyPanel" class="stream-key-panel hidden">
          <h3>Your Stream Key</h3>
          <p class="key-note">This key is only valid for your booked slot</p>
          <div class="key-display">
            <code id="streamKeyValue">-</code>
            <button id="copyKeyBtn" class="copy-btn">Copy</button>
          </div>
          <div class="key-info">
            <p><strong>RTMP URL:</strong> rtmp://rtmp.freshwax.co.uk/live</p>
            <p><strong>Valid:</strong> <span id="keyValidTime">-</span></p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
    }

    .loading-gate {
      position: fixed;
      inset: 0;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      z-index: 100;
    }

    .loader {
      width: 36px;
      height: 36px;
      border: 3px solid #333;
      border-top-color: #dc2626;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-gate p { color: #666; font-size: 0.85rem; }

    .hidden { display: none !important; }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #111;
      border-bottom: 1px solid #222;
    }

    .back-btn {
      color: #888;
      text-decoration: none;
      font-size: 0.8rem;
    }

    .back-btn:hover { color: #dc2626; }

    .header h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.02em;
    }

    .red { color: #dc2626; }

    .user-info { font-size: 0.75rem; color: #666; }

    .layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1rem;
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Schedule Section */
    .schedule-section {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .schedule-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .nav-btn {
      width: 28px;
      height: 28px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
    }

    .nav-btn:hover { border-color: #dc2626; }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .date-display { text-align: center; }

    .date-label {
      display: block;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.2rem;
    }

    .date-full {
      font-size: 0.7rem;
      color: #666;
    }

    .grid-container {
      background: #0a0a0a;
      border-radius: 6px;
      padding: 3px;
    }

    /* Compact 24-hour grid: 8 columns x 3 rows */
    .hour-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 2px;
    }

    .hour-cell {
      background: #1a1a1a;
      border: 1px solid transparent;
      border-radius: 3px;
      padding: 4px 2px;
      text-align: center;
      cursor: pointer;
      transition: all 0.1s;
      min-height: 44px;
    }

    .hour-cell:hover:not(.past):not(.booked):not(.yours) {
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.15);
    }

    .hour-cell.past { opacity: 0.25; cursor: default; }
    .hour-cell.open { background: #0d1f0d; border-color: rgba(34, 197, 94, 0.2); }
    .hour-cell.booked { background: #1f0d0d; border-color: rgba(220, 38, 38, 0.3); cursor: default; }
    .hour-cell.yours { background: #0d0d1f; border-color: rgba(59, 130, 246, 0.5); cursor: default; }
    .hour-cell.selected { background: #dc2626; border-color: #dc2626; }

    .hour-cell .time {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 0.75rem;
      color: #666;
      line-height: 1;
    }

    .hour-cell.open .time { color: #22c55e; }
    .hour-cell.booked .time { color: #f87171; }
    .hour-cell.yours .time { color: #60a5fa; }
    .hour-cell.selected .time { color: #fff; }

    .hour-cell .dj {
      font-size: 0.5rem;
      font-weight: 600;
      color: #fff;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.1;
    }

    .hour-cell.open .dj { color: #22c55e; font-weight: 400; font-size: 0.45rem; }

    .legend {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.65rem;
      color: #888;
    }

    .legend span { display: flex; align-items: center; gap: 3px; }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .dot.open { background: #22c55e; }
    .dot.booked { background: #dc2626; }
    .dot.yours { background: #3b82f6; }
    .dot.selected { background: #dc2626; border: 1px solid #fff; }

    /* Form Section */
    .form-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    form {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .form-group {
      margin-bottom: 0.6rem;
    }

    .form-group label {
      display: block;
      font-size: 0.7rem;
      color: #888;
      margin-bottom: 0.25rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.5rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-size: 0.85rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: #dc2626;
    }

    .duration-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
      font-size: 0.75rem;
      color: #888;
    }

    .dur-btn {
      padding: 0.35rem 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .dur-btn:hover { border-color: #dc2626; }
    .dur-btn.active { background: #dc2626; border-color: #dc2626; }

    .selection-box {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.3);
      border-radius: 4px;
      margin-bottom: 0.6rem;
      font-size: 0.8rem;
    }

    .clear-btn {
      background: none;
      border: none;
      color: #dc2626;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 0.25rem;
    }

    .form-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 0.5rem;
      border-top: 1px solid #222;
    }

    .allowance {
      font-size: 0.7rem;
      color: #22c55e;
    }

    .allowance.warning { color: #fbbf24; }
    .allowance.empty { color: #ef4444; }

    .submit-btn {
      padding: 0.5rem 1rem;
      background: #dc2626;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .submit-btn:hover:not(:disabled) { background: #b91c1c; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .form-msg {
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      text-align: center;
    }

    .form-msg.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .form-msg.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    /* Bookings Panel */
    .bookings-panel {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .bookings-panel h3 {
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid #222;
    }

    .my-bookings {
      max-height: 200px;
      overflow-y: auto;
    }

    .booking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #1a1a1a;
      border-radius: 4px;
      margin-bottom: 0.35rem;
    }

    .booking-info { font-size: 0.75rem; }
    .booking-title { font-weight: 600; }
    .booking-time { color: #dc2626; font-size: 0.7rem; }

    .cancel-btn {
      padding: 0.2rem 0.5rem;
      background: transparent;
      border: 1px solid #ef4444;
      border-radius: 3px;
      color: #ef4444;
      font-size: 0.65rem;
      cursor: pointer;
    }

    .empty { color: #666; font-size: 0.75rem; text-align: center; padding: 0.5rem; }

    /* Stream Key Panel */
    .stream-key-panel {
      background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .stream-key-panel h3 {
      font-size: 0.8rem;
      color: #22c55e;
      margin-bottom: 0.25rem;
    }

    .key-note {
      font-size: 0.65rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .key-display {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .key-display code {
      flex: 1;
      padding: 0.5rem;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.7rem;
      color: #22c55e;
      word-break: break-all;
    }

    .copy-btn {
      padding: 0.5rem 0.75rem;
      background: #22c55e;
      border: none;
      border-radius: 4px;
      color: #000;
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
    }

    .key-info {
      font-size: 0.65rem;
      color: #888;
    }

    .key-info p {
      margin: 0.2rem 0;
    }

    @media (max-width: 600px) {
      .hour-grid {
        grid-template-columns: repeat(6, 1fr);
      }

      .layout {
        padding: 0.5rem;
      }

      .header h1 {
        font-size: 1.1rem;
      }
    }
  </style>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    const app = initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // State
    let currentUser = null;
    let currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0);
    let selectedDuration = 2;
    let selectedHours = [];
    let dayBookings = [];
    let userDailyHours = 0;
    const MAX_HOURS = 2;

    const loadingGate = document.getElementById('loadingGate');
    const mainContent = document.getElementById('mainContent');

    // Check for cached auth first (faster UX on navigation)
    const cachedUid = localStorage.getItem('fw_uid');
    if (cachedUid) {
      // Show content immediately while we verify
      loadingGate.querySelector('p').textContent = 'Verifying...';
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Clear cache and redirect
        localStorage.removeItem('fw_uid');
        localStorage.removeItem('fw_displayName');
        window.location.href = '/login?redirect=/dj-lobby/book';
        return;
      }

      // Cache auth info for faster subsequent loads
      localStorage.setItem('fw_uid', user.uid);
      currentUser = user;

      // Get user data
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const userData = userDoc.data() || {};

      // Cache display name
      if (userData.displayName) {
        localStorage.setItem('fw_displayName', userData.displayName);
      }

      // All registered users are DJs by default
      const isDJ = userData.roles?.dj === true || userDoc.exists();

      if (!isDJ) {
        loadingGate.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üéß</div>
            <h2 style="margin-bottom: 0.5rem; font-size: 1.2rem;">DJ Access Required</h2>
            <p style="color: #888; font-size: 0.85rem;">You need DJ access to book slots.</p>
            <a href="/account/dj-lobby" style="color: #dc2626; margin-top: 1rem; display: inline-block;">‚Üê Back to DJ Lobby</a>
          </div>
        `;
        return;
      }

      // Show main content
      loadingGate.classList.add('hidden');
      mainContent.classList.remove('hidden');

      // Set user info
      const displayName = userData.displayName || localStorage.getItem('fw_displayName') || user.email;
      document.getElementById('userName').textContent = displayName;
      document.getElementById('djName').value = displayName;

      // Initialize
      initForm();
      updateDateDisplay();
      loadDayBookings();
      loadMyBookings();
    });

    function initForm() {
      // Duration buttons
      document.querySelectorAll('.dur-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedDuration = parseInt(btn.dataset.dur);
          selectedHours = [];
          renderGrid();
          updateSelection();
        });
      });

      // Date nav
      document.getElementById('prevDay').addEventListener('click', () => {
        currentDate = new Date(currentDate.getTime() - 86400000);
        selectedHours = [];
        updateDateDisplay();
        loadDayBookings();
      });

      document.getElementById('nextDay').addEventListener('click', () => {
        currentDate = new Date(currentDate.getTime() + 86400000);
        selectedHours = [];
        updateDateDisplay();
        loadDayBookings();
      });

      // Clear selection
      document.getElementById('clearBtn').addEventListener('click', () => {
        selectedHours = [];
        renderGrid();
        updateSelection();
      });

      // Copy stream key
      document.getElementById('copyKeyBtn').addEventListener('click', () => {
        const key = document.getElementById('streamKeyValue').textContent;
        navigator.clipboard.writeText(key);
        document.getElementById('copyKeyBtn').textContent = 'Copied!';
        setTimeout(() => {
          document.getElementById('copyKeyBtn').textContent = 'Copy';
        }, 2000);
      });

      // Form submit
      document.getElementById('bookingForm').addEventListener('submit', handleSubmit);

      // Input validation
      ['djName', 'streamTitle'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateSubmitButton);
      });
    }

    function updateDateDisplay() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today.getTime() + 86400000);

      let label = '';
      if (currentDate.getTime() === today.getTime()) label = 'Today';
      else if (currentDate.getTime() === tomorrow.getTime()) label = 'Tomorrow';
      else label = currentDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });

      document.getElementById('dateLabel').textContent = label;
      document.getElementById('dateFull').textContent = currentDate.toLocaleDateString('en-GB', {
        weekday: 'long', day: 'numeric', month: 'long'
      });

      document.getElementById('prevDay').disabled = currentDate.getTime() <= today.getTime();
      const maxDate = new Date(today.getTime() + 7 * 86400000);
      document.getElementById('nextDay').disabled = currentDate.getTime() >= maxDate.getTime();
    }

    async function loadDayBookings() {
      const startOfDay = new Date(currentDate);
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date(currentDate);
      endOfDay.setHours(23, 59, 59, 999);

      try {
        // Use the unified livestreamSlots collection via API
        const response = await fetch(`/api/livestream/slots?start=${startOfDay.toISOString()}&end=${endOfDay.toISOString()}&_t=${Date.now()}`);
        const result = await response.json();

        dayBookings = [];
        userDailyHours = 0;

        if (result.success && result.slots) {
          result.slots.forEach(slot => {
            if (slot.status !== 'cancelled') {
              // Convert API format to local format
              const booking = {
                id: slot.id,
                djId: slot.djId,
                djName: slot.djName,
                streamTitle: slot.title,
                genre: slot.genre,
                startTime: { toDate: () => new Date(slot.startTime) },
                endTime: { toDate: () => new Date(slot.endTime) },
                duration: Math.round(slot.duration / 60), // API returns minutes, we use hours
                streamKey: slot.streamKey,
                status: slot.status
              };
              dayBookings.push(booking);
              if (slot.djId === currentUser.uid) {
                userDailyHours += Math.round(slot.duration / 60);
              }
            }
          });
        }

        updateAllowance();
        renderGrid();
      } catch (err) {
        console.error('Load bookings error:', err);
      }
    }

    function updateAllowance() {
      const remaining = MAX_HOURS - userDailyHours;
      const el = document.getElementById('allowance');
      el.textContent = `${remaining}hr${remaining !== 1 ? 's' : ''} left today`;
      el.className = 'allowance' + (remaining === 0 ? ' empty' : remaining === 1 ? ' warning' : '');
    }

    function renderGrid() {
      const grid = document.getElementById('hourGrid');
      const now = new Date();
      const isToday = currentDate.toDateString() === now.toDateString();
      const currentHour = now.getHours();

      let html = '';

      for (let hour = 0; hour < 24; hour++) {
        const isPast = isToday && hour <= currentHour;
        const booking = getBookingForHour(hour);
        const isSelected = selectedHours.includes(hour);
        const isYours = booking && booking.djId === currentUser.uid;

        let cellClass = 'hour-cell';
        let djText = '';

        if (isPast) {
          cellClass += ' past';
        } else if (isSelected) {
          cellClass += ' selected';
        } else if (isYours) {
          cellClass += ' yours';
          djText = 'You';
        } else if (booking) {
          cellClass += ' booked';
          djText = booking.djName || 'Booked';
        } else {
          cellClass += ' open';
          djText = 'Open';
        }

        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        const ampm = hour >= 12 ? 'pm' : 'am';

        html += `
          <div class="${cellClass}" data-hour="${hour}">
            <div class="time">${displayHour}${ampm}</div>
            <div class="dj">${djText}</div>
          </div>
        `;
      }

      grid.innerHTML = html;

      // Click handlers
      grid.querySelectorAll('.hour-cell.open, .hour-cell.selected').forEach(cell => {
        cell.addEventListener('click', () => handleCellClick(parseInt(cell.dataset.hour)));
      });

      updateSelection();
    }

    function getBookingForHour(hour) {
      return dayBookings.find(b => {
        const startH = b.startTime.toDate().getHours();
        const dur = b.duration || 1;
        return hour >= startH && hour < startH + dur;
      });
    }

    function handleCellClick(hour) {
      const remaining = MAX_HOURS - userDailyHours;

      if (selectedDuration === 2) {
        const nextBooking = getBookingForHour(hour + 1);
        if (nextBooking && nextBooking.djId !== currentUser.uid) {
          showMsg('Next hour is booked', 'error');
          return;
        }
        if (hour >= 23) {
          showMsg('Cannot book 2hr block at 11PM', 'error');
          return;
        }
        if (remaining < 2) {
          showMsg('Not enough hours today', 'error');
          return;
        }
        selectedHours = selectedHours.includes(hour) ? [] : [hour, hour + 1];
      } else {
        if (selectedHours.includes(hour)) {
          selectedHours = selectedHours.filter(h => h !== hour);
        } else {
          if (selectedHours.length + 1 > remaining) {
            showMsg('Not enough hours today', 'error');
            return;
          }
          selectedHours.push(hour);
        }
      }

      renderGrid();
    }

    function updateSelection() {
      const box = document.getElementById('selectionBox');
      const text = document.getElementById('selectionText');

      if (selectedHours.length === 0) {
        box.classList.add('hidden');
      } else {
        box.classList.remove('hidden');
        const sorted = [...selectedHours].sort((a, b) => a - b);
        const fmt = h => `${h > 12 ? h - 12 : h === 0 ? 12 : h}${h >= 12 ? 'pm' : 'am'}`;

        if (selectedDuration === 2 && sorted.length === 2) {
          const endHour = sorted[1] + 1;
          text.textContent = `${fmt(sorted[0])} - ${fmt(endHour)} (2hr)`;
        } else {
          text.textContent = sorted.map(fmt).join(' & ') + ` (${sorted.length}hr)`;
        }
      }

      updateSubmitButton();
    }

    function updateSubmitButton() {
      const djName = document.getElementById('djName').value.trim();
      const streamTitle = document.getElementById('streamTitle').value.trim();
      const hasSelection = selectedHours.length > 0;
      document.getElementById('submitBtn').disabled = !djName || !streamTitle || !hasSelection;
    }

    async function handleSubmit(e) {
      e.preventDefault();

      const djName = document.getElementById('djName').value.trim();
      const streamTitle = document.getElementById('streamTitle').value.trim();
      const genre = document.getElementById('genre').value.trim();
      const submitBtn = document.getElementById('submitBtn');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Booking...';

      try {
        const sortedHours = [...selectedHours].sort((a, b) => a - b);
        const idToken = await currentUser.getIdToken();

        if (selectedDuration === 2) {
          // 2-hour block booking
          const startTime = new Date(currentDate);
          startTime.setHours(sortedHours[0], 0, 0, 0);

          const response = await fetch('/api/livestream/slots', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify({
              action: 'book',
              djId: currentUser.uid,
              djName,
              title: streamTitle,
              genre,
              startTime: startTime.toISOString(),
              duration: 120 // API expects minutes
            })
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || 'Booking failed');
          }
        } else {
          // Individual 1-hour slots
          for (const hour of sortedHours) {
            const startTime = new Date(currentDate);
            startTime.setHours(hour, 0, 0, 0);

            const response = await fetch('/api/livestream/slots', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}`
              },
              body: JSON.stringify({
                action: 'book',
                djId: currentUser.uid,
                djName,
                title: streamTitle,
                genre,
                startTime: startTime.toISOString(),
                duration: 60 // API expects minutes
              })
            });

            const result = await response.json();
            if (!result.success) {
              throw new Error(result.error || 'Booking failed');
            }
          }
        }

        showMsg('Slot booked! Your stream key is ready.', 'success');
        selectedHours = [];
        document.getElementById('streamTitle').value = '';
        document.getElementById('genre').value = '';

        await loadDayBookings();
        await loadMyBookings();

      } catch (error) {
        console.error('Booking error:', error);
        showMsg('Error: ' + error.message, 'error');
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'Book Slot';
    }

    async function loadMyBookings() {
      const container = document.getElementById('myBookings');
      const keyPanel = document.getElementById('streamKeyPanel');
      const now = new Date();

      try {
        // Fetch user's bookings via API
        const startDate = new Date(now.getTime() - 2 * 3600000);
        const endDate = new Date(now.getTime() + 30 * 24 * 3600000); // Next 30 days
        const response = await fetch(`/api/livestream/slots?djId=${currentUser.uid}&start=${startDate.toISOString()}&end=${endDate.toISOString()}&_t=${Date.now()}`);
        const result = await response.json();

        if (!result.success || !result.slots || result.slots.length === 0) {
          container.innerHTML = '<p class="empty">No bookings yet</p>';
          keyPanel.classList.add('hidden');
          return;
        }

        let html = '';
        let activeBooking = null;

        // Sort by start time
        const sortedSlots = result.slots
          .filter(s => s.status !== 'cancelled')
          .sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());

        sortedSlots.forEach(slot => {
          const startTime = new Date(slot.startTime);
          const endTime = new Date(slot.endTime);
          const dateStr = startTime.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
          const timeStr = startTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const durationHours = Math.round(slot.duration / 60);

          // Check if this is the active/upcoming slot
          if (!activeBooking && now < endTime) {
            activeBooking = { ...slot, startTime, endTime };
          }

          html += `
            <div class="booking-item">
              <div class="booking-info">
                <div class="booking-title">${slot.title}</div>
                <div class="booking-time">${dateStr} ‚Ä¢ ${timeStr} (${durationHours}hr)</div>
              </div>
              <button class="cancel-btn" data-id="${slot.id}">Cancel</button>
            </div>
          `;
        });

        container.innerHTML = html || '<p class="empty">No bookings yet</p>';

        // Show stream key for active/upcoming booking
        if (activeBooking && activeBooking.streamKey) {
          keyPanel.classList.remove('hidden');
          document.getElementById('streamKeyValue').textContent = activeBooking.streamKey;

          const validFrom = activeBooking.startTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const validTo = activeBooking.endTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          document.getElementById('keyValidTime').textContent = `${validFrom} - ${validTo}`;
        } else {
          keyPanel.classList.add('hidden');
        }

        // Cancel handlers - use API
        container.querySelectorAll('.cancel-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Cancel this booking? The stream key will be invalidated.')) {
              try {
                const idToken = await currentUser.getIdToken();
                const cancelResponse = await fetch('/api/livestream/slots', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                  },
                  body: JSON.stringify({
                    action: 'cancel',
                    slotId: btn.dataset.id,
                    djId: currentUser.uid
                  })
                });

                const cancelResult = await cancelResponse.json();
                if (cancelResult.success) {
                  showMsg('Booking cancelled', 'success');
                  loadMyBookings();
                  loadDayBookings();
                } else {
                  showMsg('Error: ' + cancelResult.error, 'error');
                }
              } catch (err) {
                console.error('Cancel error:', err);
                showMsg('Error cancelling booking', 'error');
              }
            }
          });
        });

      } catch (error) {
        console.error('Load bookings error:', error);
        container.innerHTML = '<p class="empty">Error loading bookings</p>';
      }
    }

    function showMsg(text, type) {
      const msg = document.getElementById('formMsg');
      msg.textContent = text;
      msg.className = `form-msg ${type}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 4000);
    }
  </script>
</body>
</html>
