---
// /src/pages/artist/merch-sales.astro
// Merch Supplier Sales View (Read Only)
// For partners with isMerchSupplier role to view their sales and earnings
// Source of truth: salesLedger collection

import { getDocument, queryCollection } from '../../lib/firebase-rest';
import { saQueryCollection } from '../../lib/firebase-service-account';

// Get partner from session
const partnerId = Astro.cookies.get('partnerId')?.value || '';
let partner = null;
let sales: any[] = [];
let products: any[] = [];
let ledgerEntries: any[] = [];

// Get service account credentials
const env = (Astro.locals as any)?.runtime?.env;
const projectId = env?.FIREBASE_PROJECT_ID || import.meta.env.FIREBASE_PROJECT_ID || 'freshwax-store';
const clientEmail = env?.FIREBASE_CLIENT_EMAIL || import.meta.env.FIREBASE_CLIENT_EMAIL;
const privateKey = env?.FIREBASE_PRIVATE_KEY || import.meta.env.FIREBASE_PRIVATE_KEY;

let serviceAccountKey: string | null = null;
if (clientEmail && privateKey) {
  serviceAccountKey = JSON.stringify({
    type: 'service_account',
    project_id: projectId,
    private_key_id: 'auto',
    private_key: privateKey.replace(/\\n/g, '\n'),
    client_email: clientEmail,
    client_id: '',
    auth_uri: 'https://accounts.google.com/o/oauth2/auth',
    token_uri: 'https://oauth2.googleapis.com/token'
  });
}

if (partnerId) {
  try {
    const partnerDoc = await getDocument('artists', partnerId);
    if (partnerDoc) {
      partner = { id: partnerId, ...partnerDoc };

      // Try multiple strategies to find products linked to this supplier
      let merchProducts: any[] = [];

      // Strategy 1: Query by supplierId
      merchProducts = await queryCollection('merch', {
        filters: [{ field: 'supplierId', op: 'EQUAL', value: partnerId }]
      });

      // Strategy 2: If no results, try by supplier name
      if (merchProducts.length === 0 && partner.artistName) {
        merchProducts = await queryCollection('merch', {
          filters: [{ field: 'supplierName', op: 'EQUAL', value: partner.artistName }]
        });
      }

      // Strategy 3: Check merch-suppliers collection for linked products
      if (merchProducts.length === 0) {
        try {
          const supplierData = await getDocument('merch-suppliers', partnerId);
          if (supplierData?.products && supplierData.products.length > 0) {
            const productPromises = supplierData.products.slice(0, 50).map((pid: string) =>
              getDocument('merch', pid)
            );
            const productDocs = await Promise.all(productPromises);
            merchProducts = productDocs.filter((d): d is NonNullable<typeof d> => d !== null);
          }
        } catch (e) {
          // Ignore errors from merch-suppliers lookup
        }
      }

      const productIds = merchProducts.map(p => p.id);
      products = merchProducts;

      // Query salesLedger for merch orders (source of truth)
      if (serviceAccountKey && productIds.length > 0) {
        try {
          const allLedgerEntries = await saQueryCollection(serviceAccountKey, projectId, 'salesLedger', {
            orderBy: { field: 'timestamp', direction: 'DESCENDING' },
            limit: 500
          });

          // Filter entries that contain merch items from this supplier
          allLedgerEntries.forEach((entry: any) => {
            const merchItems = (entry.items || []).filter((item: any) =>
              item.type === 'merch' && (productIds.includes(item.id) || item.supplierId === partnerId)
            );

            if (merchItems.length > 0) {
              ledgerEntries.push(entry);
              sales.push({
                id: entry.orderId || entry.id,
                orderDate: new Date(entry.timestamp),
                status: entry.orderStatus || 'completed',
                items: merchItems,
                total: merchItems.reduce((sum: number, item: any) => sum + (item.lineTotal || item.unitPrice * item.quantity || 0), 0),
                artistPayout: entry.artistPayout || 0,
                payoutStatus: entry.artistPayoutStatus || 'pending'
              });
            }
          });
        } catch (ledgerErr) {
          console.error('Error fetching ledger entries:', ledgerErr);
          // Fall back to orders collection
        }
      }

      // Fallback: If no ledger data, use orders collection
      if (sales.length === 0 && productIds.length > 0) {
        const allOrders = await queryCollection('orders', {
          orderBy: { field: 'createdAt', direction: 'DESCENDING' },
          limit: 100
        });

        allOrders.filter(order => order.status !== 'cancelled').forEach(order => {
          const supplierItems = (order.items || []).filter((item: any) =>
            productIds.includes(item.productId) || item.supplierId === partnerId
          );

          if (supplierItems.length > 0) {
            sales.push({
              id: order.id,
              orderDate: order.createdAt instanceof Date ? order.createdAt : new Date(order.createdAt),
              status: order.status,
              items: supplierItems,
              total: supplierItems.reduce((sum: number, item: any) => sum + (item.price || 0) * (item.quantity || 1), 0)
            });
          }
        });
      }
    }
  } catch (e) {
    console.error('Error fetching data:', e);
  }
}

const isLoggedIn = !!partner;
const isMerchSupplier = partner?.isMerchSupplier === true;

// Calculate stats
const totalOrders = sales.length;
const totalRevenue = sales.reduce((sum, s) => sum + s.total, 0);
const supplierCut = partner?.supplierCut || 70; // Default 70% to supplier
const totalEarnings = totalRevenue * (supplierCut / 100);
const pendingOrders = sales.filter(s => s.status === 'pending' || s.status === 'processing').length;

// Format currency
const formatCurrency = (amount) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);

// Preprocess sales for template
const processedSales = sales.map(sale => {
  const yourCut = sale.total * (supplierCut / 100);
  const statusClass = 'status-badge status-' + sale.status;
  const statusLabel = sale.status.charAt(0).toUpperCase() + sale.status.slice(1);
  const formattedDate = sale.orderDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  const orderId = '#' + sale.id.slice(-8).toUpperCase();
  return {
    ...sale,
    yourCut,
    yourCutFormatted: formatCurrency(yourCut),
    totalFormatted: formatCurrency(sale.total),
    statusClass,
    statusLabel,
    formattedDate,
    orderId
  };
});
---

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Sales | Fresh Wax</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: #e0e0e0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    h1 .page-icon {
      font-size: 1.5rem;
    }
    
    h1 .page-title {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .back-link {
      color: #a0a0a0;
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.2s;
    }
    
    .back-link:hover { color: #667eea; }
    
    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 1.25rem;
    }
    
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #fff;
    }
    
    .stat-value.green { color: #4ade80; }
    .stat-value.yellow { color: #fbbf24; }
    
    .stat-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    
    .stat-note {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    
    /* Sales Table */
    .sales-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .sales-table th {
      text-align: left;
      padding: 1rem;
      background: rgba(255,255,255,0.05);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
    }
    
    .sales-table td {
      padding: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .sales-table tr:last-child td {
      border-bottom: none;
    }
    
    .order-id {
      font-family: monospace;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    
    .order-items {
      font-size: 0.875rem;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
    }
    
    .item-name { color: #fff; }
    .item-qty { color: #9ca3af; font-size: 0.8rem; }
    
    .order-total {
      font-weight: 600;
      color: #4ade80;
    }
    
    .order-earnings {
      color: #a78bfa;
      font-size: 0.8rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .status-processing { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
    .status-shipped { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }
    .status-delivered, .status-completed { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    
    .order-date {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #9ca3af;
    }
    
    /* Unauthorized */
    .unauthorized {
      text-align: center;
      padding: 4rem 2rem;
    }
    
    .unauthorized h2 {
      color: #fff;
      margin-bottom: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .sales-table { display: block; overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    {!isLoggedIn ? (
      <div class="unauthorized">
        <h2>Please log in</h2>
        <p>You need to be logged in to view this page.</p>
        <a href="/login" class="back-link" style="display: inline-block; margin-top: 1rem;">Go to Login ‚Üí</a>
      </div>
    ) : !isMerchSupplier ? (
      <div class="unauthorized">
        <h2>Access Denied</h2>
        <p>This page is only available to Merch Suppliers.</p>
        <a href="/artist/dashboard" class="back-link" style="display: inline-block; margin-top: 1rem;">‚Üê Back to Dashboard</a>
      </div>
    ) : (
      <div class="content-wrapper">
        <header>
          <h1><span class="page-icon">üí∞</span><span class="page-title">My Sales</span></h1>
          <a href="/artist/dashboard" class="back-link">‚Üê Back to Dashboard</a>
        </header>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">{totalOrders}</div>
            <div class="stat-label">Total Orders</div>
          </div>
          <div class="stat-card">
            <div class="stat-value yellow">{pendingOrders}</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{formatCurrency(totalRevenue)}</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value green">{formatCurrency(totalEarnings)}</div>
            <div class="stat-label">Your Earnings</div>
          </div>
        </div>

        {sales.length === 0 ? (
          <div class="empty-state">
            <p>No sales yet. Once customers buy your products, sales will appear here.</p>
          </div>
        ) : (
          <table class="sales-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Items</th>
                <th>Total</th>
                <th>Your Cut</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {processedSales.map(sale => (
                <tr>
                  <td>
                    <span class="order-id">{sale.orderId}</span>
                  </td>
                  <td>
                    <div class="order-items">
                      {sale.items.map(item => (
                        <div class="order-item">
                          <span class="item-name">{item.name || item.title}</span>
                          <span class="item-qty">√ó{item.quantity || 1}</span>
                        </div>
                      ))}
                    </div>
                  </td>
                  <td>
                    <span class="order-total">{sale.totalFormatted}</span>
                  </td>
                  <td>
                    <span class="order-earnings">{sale.yourCutFormatted}</span>
                  </td>
                  <td>
                    <span class={sale.statusClass}>{sale.statusLabel}</span>
                  </td>
                  <td>
                    <span class="order-date">{sale.formattedDate}</span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    )}
  </div>
</body>
</html>