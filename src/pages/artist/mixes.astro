---
// /src/pages/artist/mixes.astro
// My Mixes - View, edit descriptions, delete, see ratings/comments/likes

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { initializeApp, cert, getApps } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

const partnerId = Astro.cookies.get('partnerId')?.value || '';
let partner = null;
let mixes: any[] = [];

if (partnerId) {
  try {
    const partnerDoc = await db.collection('artists').doc(partnerId).get();
    if (partnerDoc.exists) {
      partner = { id: partnerDoc.id, ...partnerDoc.data() };
      
      // Get all mixes and filter - avoids index issues
      const allMixesSnap = await db.collection('dj-mixes').get();
      
      const partnerName = partner.artistName?.toLowerCase().trim();
      
      // Filter mixes belonging to this user
      const userMixDocs = allMixesSnap.docs.filter(doc => {
        const data = doc.data();
        // Match by userId OR by djName (case-insensitive)
        const matchesUserId = data.userId === partnerId;
        const matchesDjName = partnerName && (
          data.djName?.toLowerCase().trim() === partnerName ||
          data.dj_name?.toLowerCase().trim() === partnerName
        );
        return matchesUserId || matchesDjName;
      });
      
      // Sort by createdAt descending
      userMixDocs.sort((a, b) => {
        const dateA = a.data().createdAt || a.data().uploadedAt || '';
        const dateB = b.data().createdAt || b.data().uploadedAt || '';
        return dateB.localeCompare(dateA);
      });
      
      // Get mixes with comments
      for (const mixDoc of userMixDocs) {
        const mixData = { id: mixDoc.id, ...mixDoc.data() };
        
        // Check for inline comments array first
        if (mixData.comments && Array.isArray(mixData.comments)) {
          // Sort by date descending and take all
          mixData.recentComments = [...mixData.comments].sort((a: any, b: any) => {
            const dateA = a.createdAt || a.timestamp || '';
            const dateB = b.createdAt || b.timestamp || '';
            return dateB.localeCompare(dateA);
          });
        } else {
          // Try subcollection - get all comments
          try {
            const commentsSnap = await db.collection('dj-mixes').doc(mixDoc.id)
              .collection('comments')
              .orderBy('createdAt', 'desc')
              .get();
            
            mixData.recentComments = commentsSnap.docs.map(c => ({
              id: c.id,
              ...c.data()
            }));
          } catch (e) {
            mixData.recentComments = [];
          }
        }
        
        mixes.push(mixData);
      }
    }
  } catch (e) {
    console.error('Error fetching mixes:', e);
  }
}

const isLoggedIn = !!partner;

// Rating calculation function
const calculateRating = (mix: any): number => {
  const downloads = mix.downloads || 0;
  const likes = mix.likes || 0;
  const comments = mix.commentCount || mix.comments?.length || 0;
  const plays = mix.plays || 0;
  return (downloads * 3) + (likes * 2) + (comments * 1) + (plays * 0.1);
};

// Add ratings to mixes
mixes = mixes.map(mix => ({
  ...mix,
  engagementScore: calculateRating(mix)
}));

const formatDate = (dateStr: string) => {
  if (!dateStr) return 'Unknown';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
};

const formatNumber = (num: number) => new Intl.NumberFormat('en-GB').format(num || 0);

export const prerender = false;
---

<Layout title="My Mixes | Fresh Wax">
  <Header />
  
  <main class="mixes-main">
    <div class="container">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-left">
          <a href="/artist/dashboard" class="back-link">‚Üê Dashboard</a>
          <h1>My Mixes</h1>
          <p>View, edit and manage your DJ mixes</p>
        </div>
        <div class="header-actions">
          <a href="/dj-mix-chart" class="chart-btn">
            üèÜ Chart
          </a>
          <a href="/artist/mix-stats" class="stats-btn">
            üìä Analytics
          </a>
          <a href="/upload-mix" class="upload-btn">
            <span>+</span> Upload New Mix
          </a>
        </div>
      </div>

      {!isLoggedIn ? (
        <div class="login-prompt">
          <p>Please log in to view your mixes.</p>
          <a href="/login" class="login-btn">Sign In</a>
        </div>
      ) : mixes.length === 0 ? (
        <div class="empty-state">
          <div class="empty-icon">üéß</div>
          <h2>No mixes yet</h2>
          <p>Upload your first DJ mix to get started!</p>
          <a href="/upload-mix" class="upload-btn">Upload Mix</a>
        </div>
      ) : (
        <div class="mixes-list">
          {mixes.map((mix) => (
            <div class="mix-card" data-mix-id={mix.id}>
              <!-- Mix Header -->
              <div class="mix-header">
                <img 
                  src={mix.artworkUrl || mix.artwork_url || '/logo.webp'} 
                  alt={mix.title || mix.mixTitle}
                  class="mix-artwork"
                />
                <div class="mix-info">
                  <h2>{mix.title || mix.mixTitle}</h2>
                  <p class="mix-dj">{mix.djName || mix.dj_name}</p>
                  <div class="mix-meta">
                    <span class="meta-item">
                      <span class="meta-icon">üìÖ</span>
                      {formatDate(mix.createdAt || mix.uploadedAt || mix.upload_date)}
                    </span>
                    <span class="meta-item">
                      <span class="meta-icon">üéµ</span>
                      {mix.genre || 'Jungle'}
                    </span>
                    <span class="meta-item">
                      <span class="meta-icon">‚è±Ô∏è</span>
                      {mix.duration || mix.durationFormatted || '0:00'}
                    </span>
                  </div>
                </div>
                <div class="mix-actions">
                  <a href={`/dj-mix/${mix.id}`} class="action-btn view" target="_blank">
                    View
                  </a>
                  <button class="action-btn delete" data-mix-id={mix.id} data-mix-title={mix.title || mix.mixTitle}>
                    Delete
                  </button>
                </div>
              </div>

              <!-- Stats Row -->
              <div class="stats-row">
                <div class="stat">
                  <span class="stat-value">{formatNumber(mix.plays || 0)}</span>
                  <span class="stat-label">Plays</span>
                </div>
                <div class="stat">
                  <span class="stat-value red">{formatNumber(mix.likes || 0)}</span>
                  <span class="stat-label">Likes</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{formatNumber(mix.downloads || 0)}</span>
                  <span class="stat-label">Downloads</span>
                </div>
                <div class="stat">
                  <span class="stat-value green">{Math.round(mix.engagementScore)}</span>
                  <span class="stat-label">Rating</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{formatNumber(mix.commentCount || mix.recentComments?.length || 0)}</span>
                  <span class="stat-label">Comments</span>
                </div>
              </div>

              <!-- Description Edit -->
              <div class="description-section">
                <div class="section-header">
                  <h3>Description</h3>
                  <button class="edit-btn" data-mix-id={mix.id}>
                    <span class="edit-icon">‚úèÔ∏è</span> Edit
                  </button>
                </div>
                <div class="description-view" data-mix-id={mix.id}>
                  <p>{mix.description || mix.shoutOuts || 'No description'}</p>
                </div>
                <div class="description-edit hidden" data-mix-id={mix.id}>
                  <textarea 
                    class="description-input" 
                    data-mix-id={mix.id}
                    maxlength="150"
                    placeholder="Enter mix description..."
                  >{mix.description || mix.shoutOuts || ''}</textarea>
                  <div class="edit-actions">
                    <span class="char-count"><span class="current">0</span>/150</span>
                    <button class="save-btn" data-mix-id={mix.id}>Save</button>
                    <button class="cancel-btn" data-mix-id={mix.id}>Cancel</button>
                  </div>
                </div>
              </div>

              <!-- Recent Comments -->
              <div class="comments-section">
                <h3>Comments ({mix.commentCount || mix.comments?.length || 0})</h3>
                {(mix.recentComments && mix.recentComments.length > 0) ? (
                  <div class={`comments-list ${mix.recentComments.length > 5 ? 'scrollable' : ''}`}>
                    {mix.recentComments.map((comment: any) => (
                      <div class="comment">
                        <div class="comment-header">
                          <span class="comment-author">{comment.userName || 'Anonymous'}</span>
                          <span class="comment-date">{formatDate(comment.createdAt || comment.timestamp)}</span>
                        </div>
                        <p class="comment-text">{comment.comment || comment.text || comment.content || ''}</p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p class="no-comments">No comments yet</p>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  </main>

  <Footer />

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h2>Delete Mix?</h2>
      <p>Are you sure you want to delete "<span id="delete-mix-title"></span>"?</p>
      <p class="warning">This action cannot be undone.</p>
      <div class="modal-actions">
        <button id="cancel-delete" class="modal-btn cancel">Cancel</button>
        <button id="confirm-delete" class="modal-btn confirm">Delete</button>
      </div>
    </div>
  </div>
</Layout>

<style>
  .mixes-main {
    min-height: calc(100vh - 200px);
    background: #f5f5f5;
    padding: 2rem 0;
  }
  
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }
  
  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .header-left h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    color: #000;
    margin: 0.5rem 0 0.25rem;
  }
  
  .header-left p {
    color: #666;
    font-size: 1rem;
  }
  
  .back-link {
    color: #666;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .back-link:hover {
    color: #000;
  }
  
  .header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }
  
  .stats-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #f0f0f0;
    color: #333;
    padding: 0.875rem 1.25rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
    border: 2px solid #e5e5e5;
  }
  
  .stats-btn:hover {
    background: #e5e5e5;
    border-color: #ccc;
  }
  
  .chart-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #000;
    padding: 0.875rem 1.25rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
    transition: all 0.2s;
    border: none;
  }
  
  .chart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
  }
  
  .upload-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #000;
    color: #fff;
    padding: 0.875rem 1.5rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .upload-btn:hover {
    background: #222;
    transform: translateY(-2px);
  }
  
  .upload-btn span {
    font-size: 1.25rem;
  }
  
  /* Login/Empty States */
  .login-prompt, .empty-state {
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 16px;
    padding: 4rem 2rem;
    text-align: center;
  }
  
  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }
  
  .empty-state h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }
  
  .empty-state p {
    color: #666;
    margin-bottom: 1.5rem;
  }
  
  .login-btn {
    display: inline-block;
    background: #000;
    color: #fff;
    padding: 0.875rem 2rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
  }
  
  /* Mix Cards */
  .mixes-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .mix-card {
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.2s;
  }
  
  .mix-card:hover {
    border-color: #ccc;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
  }
  
  /* Mix Header */
  .mix-header {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.5rem;
    background: #fafafa;
    border-bottom: 2px solid #e5e5e5;
  }
  
  .mix-artwork {
    width: 100px;
    height: 100px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #e5e5e5;
    flex-shrink: 0;
  }
  
  .mix-info {
    flex: 1;
    min-width: 0;
  }
  
  .mix-info h2 {
    font-size: 1.375rem;
    font-weight: 700;
    margin: 0 0 0.25rem;
    color: #000;
  }
  
  .mix-dj {
    font-size: 1rem;
    color: #666;
    margin: 0 0 0.75rem;
  }
  
  .mix-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: #888;
  }
  
  .meta-icon {
    font-size: 0.875rem;
  }
  
  .mix-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .action-btn {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid;
    text-decoration: none;
    text-align: center;
  }
  
  .action-btn.view {
    background: #f0fdf4;
    border-color: #86efac;
    color: #16a34a;
  }
  
  .action-btn.view:hover {
    background: #dcfce7;
  }
  
  .action-btn.delete {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #dc2626;
  }
  
  .action-btn.delete:hover {
    background: #fee2e2;
  }
  
  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1px;
    background: #e5e5e5;
    border-bottom: 2px solid #e5e5e5;
  }
  
  .stat {
    background: #fff;
    padding: 1rem;
    text-align: center;
  }
  
  .stat-value {
    display: block;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    color: #000;
    line-height: 1;
  }
  
  .stat-value.red { color: #dc2626; }
  .stat-value.green { color: #16a34a; }
  
  .stat-label {
    display: block;
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-top: 0.25rem;
  }
  
  /* Description Section */
  .description-section {
    padding: 1.5rem;
    border-bottom: 2px solid #e5e5e5;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .section-header h3 {
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #666;
    margin: 0;
  }
  
  .edit-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    background: none;
    border: none;
    color: #666;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    transition: all 0.2s;
  }
  
  .edit-btn:hover {
    background: #f0f0f0;
    color: #000;
  }
  
  .description-view p {
    color: #333;
    font-size: 1rem;
    line-height: 1.5;
    margin: 0;
  }
  
  .description-view.hidden {
    display: none;
  }
  
  .description-edit.hidden {
    display: none;
  }
  
  .description-input {
    width: 100%;
    min-height: 80px;
    padding: 0.875rem;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.2s;
  }
  
  .description-input:focus {
    outline: none;
    border-color: #000;
  }
  
  .edit-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.75rem;
  }
  
  .char-count {
    font-size: 0.8125rem;
    color: #888;
    margin-right: auto;
  }
  
  .save-btn, .cancel-btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  
  .save-btn {
    background: #000;
    color: #fff;
  }
  
  .save-btn:hover {
    background: #222;
  }
  
  .cancel-btn {
    background: #f0f0f0;
    color: #666;
  }
  
  .cancel-btn:hover {
    background: #e5e5e5;
  }
  
  /* Comments Section */
  .comments-section {
    padding: 1.5rem;
  }
  
  .comments-section h3 {
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #666;
    margin: 0 0 1rem;
  }
  
  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .comments-list.scrollable {
    max-height: 320px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }
  
  .comments-list.scrollable::-webkit-scrollbar {
    width: 6px;
  }
  
  .comments-list.scrollable::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
  }
  
  .comments-list.scrollable::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
  }
  
  .comments-list.scrollable::-webkit-scrollbar-thumb:hover {
    background: #aaa;
  }
  
  .comment {
    background: #f8f8f8;
    border-radius: 10px;
    padding: 1rem;
  }
  
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  
  .comment-author {
    font-weight: 600;
    color: #000;
    font-size: 0.9375rem;
  }
  
  .comment-date {
    font-size: 0.8125rem;
    color: #888;
  }
  
  .comment-text {
    color: #444;
    font-size: 0.9375rem;
    line-height: 1.4;
    margin: 0;
  }
  
  .no-comments {
    color: #888;
    font-style: italic;
    font-size: 0.9375rem;
    margin: 0;
  }
  
  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal.hidden {
    display: none;
  }
  
  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
  }
  
  .modal-content {
    position: relative;
    background: #fff;
    border-radius: 16px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
  }
  
  .modal-content h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    margin: 0 0 0.5rem;
  }
  
  .modal-content p {
    color: #666;
    margin: 0 0 0.5rem;
  }
  
  .modal-content .warning {
    color: #dc2626;
    font-weight: 500;
    font-size: 0.875rem;
  }
  
  .modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 1.5rem;
  }
  
  .modal-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  
  .modal-btn.cancel {
    background: #f0f0f0;
    color: #666;
  }
  
  .modal-btn.cancel:hover {
    background: #e5e5e5;
  }
  
  .modal-btn.confirm {
    background: #dc2626;
    color: #fff;
  }
  
  .modal-btn.confirm:hover {
    background: #b91c1c;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }
    
    .header-actions {
      flex-direction: column;
    }
    
    .chart-btn, .stats-btn, .upload-btn {
      text-align: center;
      justify-content: center;
    }
    
    .mix-header {
      flex-direction: column;
      text-align: center;
    }
    
    .mix-artwork {
      width: 120px;
      height: 120px;
    }
    
    .mix-meta {
      justify-content: center;
    }
    
    .mix-actions {
      flex-direction: row;
      width: 100%;
    }
    
    .action-btn {
      flex: 1;
    }
    
    .stats-row {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .stats-row .stat:nth-child(4),
    .stats-row .stat:nth-child(5) {
      grid-column: span 1;
    }
  }
  
  @media (max-width: 480px) {
    .stats-row {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-value {
      font-size: 1.5rem;
    }
  }
</style>

<script type="module">
  // Delete modal functionality
  const deleteModal = document.getElementById('delete-modal');
  const deleteMixTitle = document.getElementById('delete-mix-title');
  const cancelDelete = document.getElementById('cancel-delete');
  const confirmDelete = document.getElementById('confirm-delete');
  let mixToDelete = null;
  
  // Handle delete button clicks
  document.querySelectorAll('.action-btn.delete').forEach(btn => {
    btn.addEventListener('click', () => {
      mixToDelete = btn.dataset.mixId;
      deleteMixTitle.textContent = btn.dataset.mixTitle;
      deleteModal.classList.remove('hidden');
    });
  });
  
  // Cancel delete
  cancelDelete?.addEventListener('click', () => {
    deleteModal.classList.add('hidden');
    mixToDelete = null;
  });
  
  // Click backdrop to close
  document.querySelector('.modal-backdrop')?.addEventListener('click', () => {
    deleteModal.classList.add('hidden');
    mixToDelete = null;
  });
  
  // Confirm delete
  confirmDelete?.addEventListener('click', async () => {
    if (!mixToDelete) return;
    
    confirmDelete.textContent = 'Deleting...';
    confirmDelete.disabled = true;
    
    try {
      // Use server-side API for proper deletion
      const response = await fetch('/api/delete-mix', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mixId: mixToDelete })
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Remove card from UI
        const card = document.querySelector(`.mix-card[data-mix-id="${mixToDelete}"]`);
        if (card) {
          card.style.opacity = '0';
          card.style.transform = 'translateX(-20px)';
          setTimeout(() => card.remove(), 300);
        }
        
        deleteModal.classList.add('hidden');
        mixToDelete = null;
      } else {
        throw new Error(result.error || 'Failed to delete');
      }
    } catch (error) {
      console.error('Error deleting mix:', error);
      alert('Failed to delete mix. Please try again.');
    }
    
    confirmDelete.textContent = 'Delete';
    confirmDelete.disabled = false;
  });
  
  // Edit description functionality
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const mixId = btn.dataset.mixId;
      const viewEl = document.querySelector(`.description-view[data-mix-id="${mixId}"]`);
      const editEl = document.querySelector(`.description-edit[data-mix-id="${mixId}"]`);
      const textarea = editEl?.querySelector('textarea');
      const charCount = editEl?.querySelector('.char-count .current');
      
      viewEl?.classList.add('hidden');
      editEl?.classList.remove('hidden');
      
      if (textarea && charCount) {
        charCount.textContent = textarea.value.length;
        textarea.focus();
      }
    });
  });
  
  // Character count for textareas
  document.querySelectorAll('.description-input').forEach(textarea => {
    const mixId = textarea.dataset.mixId;
    const charCount = document.querySelector(`.description-edit[data-mix-id="${mixId}"] .char-count .current`);
    
    textarea.addEventListener('input', () => {
      if (charCount) {
        charCount.textContent = textarea.value.length;
      }
    });
  });
  
  // Cancel edit
  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const mixId = btn.dataset.mixId;
      const viewEl = document.querySelector(`.description-view[data-mix-id="${mixId}"]`);
      const editEl = document.querySelector(`.description-edit[data-mix-id="${mixId}"]`);
      
      editEl?.classList.add('hidden');
      viewEl?.classList.remove('hidden');
    });
  });
  
  // Save description - use server-side API
  document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const mixId = btn.dataset.mixId;
      const textarea = document.querySelector(`.description-input[data-mix-id="${mixId}"]`);
      const viewEl = document.querySelector(`.description-view[data-mix-id="${mixId}"]`);
      const editEl = document.querySelector(`.description-edit[data-mix-id="${mixId}"]`);
      
      if (!textarea) return;
      
      const newDescription = textarea.value.trim();
      
      btn.textContent = 'Saving...';
      btn.disabled = true;
      
      try {
        const response = await fetch('/api/update-mix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            mixId: mixId,
            description: newDescription 
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Update view
          const viewP = viewEl?.querySelector('p');
          if (viewP) {
            viewP.textContent = newDescription || 'No description';
          }
          
          editEl?.classList.add('hidden');
          viewEl?.classList.remove('hidden');
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (error) {
        console.error('Error updating description:', error);
        alert('Failed to save. Please try again.');
      }
      
      btn.textContent = 'Save';
      btn.disabled = false;
    });
  });
</script>
