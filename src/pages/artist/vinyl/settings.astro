---
// src/pages/artist/vinyl/settings.astro
// Vinyl seller settings - shipping costs, store info
import VinylDashboardLayout from '../../../layouts/VinylDashboardLayout.astro';
export const prerender = false;
---

<VinylDashboardLayout title="Seller Settings" activeSection="settings">
  <div class="settings-container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
      <div class="spinner"></div>
      <p>Loading settings...</p>
    </div>

    <!-- Settings Form -->
    <form id="settingsForm" class="settings-form" style="display:none;">

      <!-- Shipping Settings -->
      <section class="settings-section">
        <h2>Shipping Costs</h2>
        <p class="section-desc">Set your UK shipping costs. These apply to all your listings.</p>

        <div class="form-group">
          <label for="shippingSingle">Single Record</label>
          <div class="input-prefix">
            <span class="prefix">£</span>
            <input type="number" id="shippingSingle" name="shippingSingle" min="0" max="50" step="0.01" placeholder="0.00">
          </div>
          <p class="form-hint">Cost to ship one record</p>
        </div>

        <div class="form-group">
          <label for="shippingAdditional">Each Additional Record</label>
          <div class="input-prefix">
            <span class="prefix">£</span>
            <input type="number" id="shippingAdditional" name="shippingAdditional" min="0" max="50" step="0.01" placeholder="0.00">
          </div>
          <p class="form-hint">Extra cost for each additional record in the same order</p>
        </div>

        <div class="shipping-example" id="shippingExample">
          <h4>Example costs:</h4>
          <div class="example-row"><span>1 record:</span> <span id="example1">£0.00</span></div>
          <div class="example-row"><span>2 records:</span> <span id="example2">£0.00</span></div>
          <div class="example-row"><span>3 records:</span> <span id="example3">£0.00</span></div>
        </div>
      </section>

      <!-- International Shipping -->
      <section class="settings-section">
        <h2>International Shipping</h2>
        <p class="section-desc">Optional: Set international shipping costs.</p>

        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="shipsInternational" name="shipsInternational">
            <span class="checkmark"></span>
            <span>I ship internationally</span>
          </label>
        </div>

        <div id="internationalFields" class="international-fields" style="display:none;">
          <div class="form-row">
            <div class="form-group">
              <label for="shippingEurope">Europe (Single Record)</label>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input type="number" id="shippingEurope" name="shippingEurope" min="0" max="100" step="0.01" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label for="shippingEuropeAdditional">Europe (Additional)</label>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input type="number" id="shippingEuropeAdditional" name="shippingEuropeAdditional" min="0" max="100" step="0.01" placeholder="0.00">
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="shippingWorldwide">Worldwide (Single Record)</label>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input type="number" id="shippingWorldwide" name="shippingWorldwide" min="0" max="100" step="0.01" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label for="shippingWorldwideAdditional">Worldwide (Additional)</label>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input type="number" id="shippingWorldwideAdditional" name="shippingWorldwideAdditional" min="0" max="100" step="0.01" placeholder="0.00">
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Store Info -->
      <section class="settings-section">
        <h2>Store Information</h2>
        <p class="section-desc">This info appears on your seller profile.</p>

        <div class="form-group">
          <label for="storeName">Store Name</label>
          <input type="text" id="storeName" name="storeName" maxlength="50" placeholder="Your store name">
        </div>

        <div class="form-group">
          <label for="location">Location</label>
          <input type="text" id="location" name="location" maxlength="50" placeholder="e.g. London, UK">
        </div>

        <div class="form-group">
          <label for="storeDescription">Description</label>
          <textarea id="storeDescription" name="storeDescription" maxlength="500" rows="3" placeholder="Tell buyers about your collection..."></textarea>
          <div class="char-count"><span id="descCount">0</span>/500</div>
        </div>

        <div class="form-group">
          <label for="discogsUrl">Discogs Profile (Optional)</label>
          <input type="url" id="discogsUrl" name="discogsUrl" placeholder="https://www.discogs.com/user/...">
        </div>
      </section>

      <!-- Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="saveBtn">Save Settings</button>
      </div>
    </form>

    <!-- Success Message -->
    <div id="successMessage" class="success-message" style="display:none;">
      <span class="icon">✓</span>
      <span>Settings saved successfully!</span>
    </div>
  </div>
</VinylDashboardLayout>

<script type="module" is:inline>
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let currentUser = null;

  const loadingState = document.getElementById('loadingState');
  const settingsForm = document.getElementById('settingsForm');
  const successMessage = document.getElementById('successMessage');

  // Update shipping examples
  function updateExamples() {
    const single = parseFloat(document.getElementById('shippingSingle').value) || 0;
    const additional = parseFloat(document.getElementById('shippingAdditional').value) || 0;

    document.getElementById('example1').textContent = `£${single.toFixed(2)}`;
    document.getElementById('example2').textContent = `£${(single + additional).toFixed(2)}`;
    document.getElementById('example3').textContent = `£${(single + additional * 2).toFixed(2)}`;
  }

  document.getElementById('shippingSingle').addEventListener('input', updateExamples);
  document.getElementById('shippingAdditional').addEventListener('input', updateExamples);

  // Toggle international fields
  document.getElementById('shipsInternational').addEventListener('change', (e) => {
    document.getElementById('internationalFields').style.display = e.target.checked ? 'block' : 'none';
  });

  // Character count for description
  document.getElementById('storeDescription').addEventListener('input', (e) => {
    document.getElementById('descCount').textContent = e.target.value.length;
  });

  // Load settings via API (D1 primary, Firebase fallback)
  async function loadSettings(userId) {
    try {
      const response = await fetch(`/api/vinyl/settings?userId=${encodeURIComponent(userId)}`);
      const result = await response.json();

      if (result.success && result.settings) {
        const data = result.settings;

        // Shipping
        document.getElementById('shippingSingle').value = data.shippingSingle || '';
        document.getElementById('shippingAdditional').value = data.shippingAdditional || '';
        document.getElementById('shipsInternational').checked = data.shipsInternational || false;
        document.getElementById('shippingEurope').value = data.shippingEurope || '';
        document.getElementById('shippingEuropeAdditional').value = data.shippingEuropeAdditional || '';
        document.getElementById('shippingWorldwide').value = data.shippingWorldwide || '';
        document.getElementById('shippingWorldwideAdditional').value = data.shippingWorldwideAdditional || '';

        if (data.shipsInternational) {
          document.getElementById('internationalFields').style.display = 'block';
        }

        // Store info
        document.getElementById('storeName').value = data.storeName || '';
        document.getElementById('location').value = data.location || '';
        document.getElementById('storeDescription').value = data.description || '';
        document.getElementById('discogsUrl').value = data.discogsUrl || '';

        if (data.description) {
          document.getElementById('descCount').textContent = data.description.length;
        }

        updateExamples();
        console.log('[settings] Loaded from:', result.source);
      }
    } catch (error) {
      console.error('Error loading settings:', error);
    }
  }

  // Save settings via API (D1 primary, Firebase backup)
  async function saveSettings(e) {
    e.preventDefault();

    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
      // Get auth token for API authentication
      const idToken = await currentUser.getIdToken();

      const data = {
        userId: currentUser.uid,
        // Shipping
        shippingSingle: parseFloat(document.getElementById('shippingSingle').value) || 0,
        shippingAdditional: parseFloat(document.getElementById('shippingAdditional').value) || 0,
        shipsInternational: document.getElementById('shipsInternational').checked,
        shippingEurope: parseFloat(document.getElementById('shippingEurope').value) || 0,
        shippingEuropeAdditional: parseFloat(document.getElementById('shippingEuropeAdditional').value) || 0,
        shippingWorldwide: parseFloat(document.getElementById('shippingWorldwide').value) || 0,
        shippingWorldwideAdditional: parseFloat(document.getElementById('shippingWorldwideAdditional').value) || 0,
        // Store info
        storeName: document.getElementById('storeName').value.trim(),
        location: document.getElementById('location').value.trim(),
        description: document.getElementById('storeDescription').value.trim(),
        discogsUrl: document.getElementById('discogsUrl').value.trim()
      };

      const response = await fetch('/api/vinyl/settings', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}`
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'Failed to save settings');
      }

      console.log('[settings] Saved to:', result.storage);

      // Show success
      successMessage.style.display = 'flex';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);

    } catch (error) {
      console.error('Error saving settings:', error);
      alert('Error saving settings: ' + error.message);
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Settings';
    }
  }

  settingsForm.addEventListener('submit', saveSettings);

  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    currentUser = user;
    await loadSettings(user.uid);

    loadingState.style.display = 'none';
    settingsForm.style.display = 'block';
  });
</script>

<style>
  .settings-container {
    max-width: 700px;
    margin: 0 auto;
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: #999;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #333;
    border-top-color: #f97316;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .settings-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .settings-section {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 1.5rem;
  }

  .settings-section h2 {
    color: #fff;
    font-size: 1.1rem;
    margin: 0 0 0.25rem;
  }

  .section-desc {
    color: #888;
    font-size: 0.9rem;
    margin: 0 0 1.25rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    color: #ccc;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.35rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #444;
    border-radius: 8px;
    font-size: 1rem;
    background: #252525;
    color: #fff;
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: #666;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #f97316;
  }

  .form-hint {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.35rem;
  }

  .char-count {
    font-size: 0.8rem;
    color: #666;
    text-align: right;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .input-prefix {
    position: relative;
  }

  .input-prefix .prefix {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
  }

  .input-prefix input {
    padding-left: 1.75rem;
  }

  .shipping-example {
    background: #252525;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .shipping-example h4 {
    color: #999;
    font-size: 0.85rem;
    margin: 0 0 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .example-row {
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0;
    color: #ccc;
    font-size: 0.95rem;
  }

  .example-row span:last-child {
    color: #f97316;
    font-weight: 600;
  }

  .checkbox-group {
    margin-bottom: 1rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    color: #ccc;
  }

  .checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: #f97316;
  }

  .international-fields {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #333;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    padding: 0.5rem 0;
  }

  .btn {
    padding: 0.75rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #f97316;
    color: #fff;
  }

  .btn-primary:hover {
    background: #ea580c;
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .success-message {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: #166534;
    color: #fff;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .success-message .icon {
    font-size: 1.25rem;
  }

  @media (max-width: 600px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
</VinylDashboardLayout>
