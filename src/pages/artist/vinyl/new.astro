---
// src/pages/artist/vinyl/new.astro
// Create new vinyl listing page for sellers
import ProDashboardLayout from '../../../layouts/ProDashboardLayout.astro';
export const prerender = false;
---

<ProDashboardLayout title="List New Vinyl" activeNav="vinyl">
  <div class="page-header">
    <div class="header-content">
      <a href="/artist/vinyl" class="back-link">‚Üê Back to My Listings</a>
      <h1>List New Vinyl</h1>
      <p class="subtitle">Add a record to your crate for sale</p>
    </div>
  </div>

  <form id="listingForm" class="listing-form">
    <!-- Images Section -->
    <section class="form-section">
      <h2>Photos</h2>
      <p class="section-desc">Add up to 6 photos. First image is the cover. Show front, back, labels, and any flaws.</p>

      <div class="image-grid" id="imageGrid">
        <div class="image-slot empty" data-index="0">
          <input type="file" accept="image/*" class="image-input" id="imageInput0">
          <label for="imageInput0" class="image-label">
            <span class="plus">+</span>
            <span class="text">Cover Photo</span>
          </label>
          <div class="image-preview"></div>
          <button type="button" class="remove-btn" style="display:none;">√ó</button>
        </div>
        <div class="image-slot empty" data-index="1">
          <input type="file" accept="image/*" class="image-input" id="imageInput1">
          <label for="imageInput1" class="image-label">
            <span class="plus">+</span>
            <span class="text">Add Photo</span>
          </label>
          <div class="image-preview"></div>
          <button type="button" class="remove-btn" style="display:none;">√ó</button>
        </div>
        <div class="image-slot empty" data-index="2">
          <input type="file" accept="image/*" class="image-input" id="imageInput2">
          <label for="imageInput2" class="image-label">
            <span class="plus">+</span>
            <span class="text">Add Photo</span>
          </label>
          <div class="image-preview"></div>
          <button type="button" class="remove-btn" style="display:none;">√ó</button>
        </div>
        <div class="image-slot empty" data-index="3">
          <input type="file" accept="image/*" class="image-input" id="imageInput3">
          <label for="imageInput3" class="image-label">
            <span class="plus">+</span>
            <span class="text">Add Photo</span>
          </label>
          <div class="image-preview"></div>
          <button type="button" class="remove-btn" style="display:none;">√ó</button>
        </div>
        <div class="image-slot empty" data-index="4">
          <input type="file" accept="image/*" class="image-input" id="imageInput4">
          <label for="imageInput4" class="image-label">
            <span class="plus">+</span>
            <span class="text">Add Photo</span>
          </label>
          <div class="image-preview"></div>
          <button type="button" class="remove-btn" style="display:none;">√ó</button>
        </div>
        <div class="image-slot empty" data-index="5">
          <input type="file" accept="image/*" class="image-input" id="imageInput5">
          <label for="imageInput5" class="image-label">
            <span class="plus">+</span>
            <span class="text">Add Photo</span>
          </label>
          <div class="image-preview"></div>
          <button type="button" class="remove-btn" style="display:none;">√ó</button>
        </div>
      </div>
    </section>

    <!-- Audio Sample Section -->
    <section class="form-section">
      <h2>Audio Sample <span class="optional">(Optional)</span></h2>
      <p class="section-desc">Drop your full track and select up to 1:30 for the sample clip. Will be converted to MP3 128kbps.</p>

      <div class="audio-upload" id="audioUpload">
        <input type="file" accept="audio/*" id="audioInput" class="audio-input">

        <!-- Drop zone / Upload state -->
        <label for="audioInput" class="audio-label" id="audioLabel">
          <span class="icon">üéµ</span>
          <span class="text">Drop full track here or click to browse</span>
          <span class="hint">WAV, MP3, FLAC, OGG supported</span>
        </label>

        <!-- Loading state -->
        <div class="audio-loading" id="audioLoading" style="display:none;">
          <div class="spinner"></div>
          <span>Loading waveform...</span>
        </div>

        <!-- Waveform editor -->
        <div class="waveform-editor" id="waveformEditor" style="display:none;">
          <div class="waveform-header">
            <span class="track-name" id="trackName">track.mp3</span>
            <button type="button" class="change-track-btn" id="changeTrack">Change track</button>
          </div>

          <div class="waveform-container">
            <div id="waveform"></div>
          </div>

          <div class="region-controls">
            <div class="time-display">
              <div class="time-input">
                <label>Start</label>
                <input type="text" id="regionStart" value="0:00" readonly>
              </div>
              <div class="region-duration">
                <span id="regionDuration">0:00</span>
                <span class="max-hint">/ 1:30 max</span>
              </div>
              <div class="time-input">
                <label>End</label>
                <input type="text" id="regionEnd" value="0:00" readonly>
              </div>
            </div>

            <div class="playback-controls">
              <button type="button" class="play-btn" id="playRegion">
                <span class="play-icon">‚ñ∂</span> Play Selection
              </button>
              <button type="button" class="reset-btn" id="resetRegion">Reset to Start</button>
            </div>

            <p class="region-hint">Drag the highlighted region or its edges to select your sample clip</p>
          </div>

          <div class="sample-ready" id="sampleReady" style="display:none;">
            <span class="check">‚úì</span>
            <span>Sample clip ready (<span id="finalDuration">0:00</span>)</span>
          </div>
        </div>

        <!-- Processing state -->
        <div class="audio-processing" id="audioProcessing" style="display:none;">
          <div class="spinner"></div>
          <span id="processingText">Converting to MP3...</span>
        </div>
      </div>
    </section>

    <!-- Record Details Section -->
    <section class="form-section">
      <h2>Record Details</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="artist">Artist <span class="required">*</span></label>
          <input type="text" id="artist" name="artist" required maxlength="100" placeholder="e.g. Goldie">
        </div>
        <div class="form-group">
          <label for="title">Title <span class="required">*</span></label>
          <input type="text" id="title" name="title" required maxlength="100" placeholder="e.g. Timeless">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="label">Label</label>
          <input type="text" id="label" name="label" maxlength="100" placeholder="e.g. Metalheadz">
        </div>
        <div class="form-group">
          <label for="catalogNumber">Catalogue Number</label>
          <input type="text" id="catalogNumber" name="catalogNumber" maxlength="50" placeholder="e.g. METH001">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="format">Format <span class="required">*</span></label>
          <select id="format" name="format" required>
            <option value="LP">LP (12" Album)</option>
            <option value="12&quot;">12" Single</option>
            <option value="10&quot;">10"</option>
            <option value="7&quot;">7"</option>
            <option value="EP">EP</option>
            <option value="Box Set">Box Set</option>
            <option value="Compilation">Compilation</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="releaseYear">Release Year</label>
          <input type="number" id="releaseYear" name="releaseYear" min="1900" max="2030" placeholder="e.g. 1995">
        </div>
      </div>

      <div class="form-group">
        <label for="genre">Genre</label>
        <input type="text" id="genre" name="genre" maxlength="50" placeholder="e.g. Drum & Bass, Jungle, House">
      </div>
    </section>

    <!-- Condition Section -->
    <section class="form-section">
      <h2>Condition</h2>
      <p class="section-desc">Use the Goldmine grading scale. Be honest - it builds trust!</p>

      <div class="form-row">
        <div class="form-group">
          <label for="mediaCondition">Media Condition <span class="required">*</span></label>
          <select id="mediaCondition" name="mediaCondition" required>
            <option value="">Select condition...</option>
            <option value="M">M - Mint (Unplayed)</option>
            <option value="NM">NM - Near Mint (Almost perfect)</option>
            <option value="VG+">VG+ - Very Good Plus (Shows some play)</option>
            <option value="VG">VG - Very Good (Surface noise, light scratches)</option>
            <option value="G+">G+ - Good Plus (Plays through with noise)</option>
            <option value="G">G - Good (Significant wear)</option>
            <option value="F">F - Fair (Plays but damaged)</option>
            <option value="P">P - Poor (Barely plays)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sleeveCondition">Sleeve Condition <span class="required">*</span></label>
          <select id="sleeveCondition" name="sleeveCondition" required>
            <option value="">Select condition...</option>
            <option value="M">M - Mint (Perfect)</option>
            <option value="NM">NM - Near Mint (Almost perfect)</option>
            <option value="VG+">VG+ - Very Good Plus (Minor wear)</option>
            <option value="VG">VG - Very Good (Visible wear)</option>
            <option value="G+">G+ - Good Plus (Wear and marks)</option>
            <option value="G">G - Good (Significant wear)</option>
            <option value="F">F - Fair (Damaged but intact)</option>
            <option value="P">P - Poor (Heavily damaged)</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="conditionNotes">Condition Notes</label>
        <textarea id="conditionNotes" name="conditionNotes" maxlength="500" rows="3" placeholder="Describe any specific wear, marks, or issues..."></textarea>
        <div class="char-count"><span id="notesCount">0</span>/500</div>
      </div>
    </section>

    <!-- Pricing Section -->
    <section class="form-section">
      <h2>Pricing</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="price">Price (GBP) <span class="required">*</span></label>
          <div class="input-prefix">
            <span class="prefix">¬£</span>
            <input type="number" id="price" name="price" required min="0.01" max="10000" step="0.01" placeholder="0.00">
          </div>
        </div>
        <div class="form-group">
          <label for="shippingCost">Shipping Cost (GBP) <span class="required">*</span></label>
          <div class="input-prefix">
            <span class="prefix">¬£</span>
            <input type="number" id="shippingCost" name="shippingCost" required min="0" max="100" step="0.01" placeholder="0.00">
          </div>
          <p class="form-hint">UK shipping cost. International buyers will see an estimate.</p>
        </div>
      </div>

      <div class="price-breakdown" id="priceBreakdown" style="display:none;">
        <div class="breakdown-row">
          <span>Your price:</span>
          <span id="breakdownPrice">¬£0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Shipping:</span>
          <span id="breakdownShipping">¬£0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Processing fee (3%):</span>
          <span id="breakdownProcessing">-¬£0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Fresh Wax fee (10%):</span>
          <span id="breakdownPlatform">-¬£0.00</span>
        </div>
        <div class="breakdown-row total">
          <span>You receive:</span>
          <span id="breakdownTotal">¬£0.00</span>
        </div>
      </div>
    </section>

    <!-- Description Section -->
    <section class="form-section">
      <h2>Description <span class="optional">(Optional)</span></h2>
      <div class="form-group">
        <textarea id="description" name="description" maxlength="2000" rows="5" placeholder="Any additional details about the record, pressing info, history, etc..."></textarea>
        <div class="char-count"><span id="descCount">0</span>/2000</div>
      </div>
    </section>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save as Draft</button>
      <button type="submit" class="btn btn-primary" id="submitBtn">Submit for Review</button>
    </div>
  </form>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h3>Uploading...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="uploadProgress"></div>
      </div>
      <p id="uploadStatus">Preparing images...</p>
    </div>
  </div>
</ProDashboardLayout>

<script>
  // Load lamejs for MP3 encoding
  const lameScript = document.createElement('script');
  lameScript.src = 'https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js';
  document.head.appendChild(lameScript);
</script>

<!-- WaveSurfer.js for waveform visualization -->
<script src="https://unpkg.com/wavesurfer.js@7"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let currentUser = null;
  let sellerInfo = null;
  let uploadedImages = [];
  let audioFile = null;
  let convertedAudioBlob = null;
  let audioDuration = 0;

  const MAX_AUDIO_DURATION = 90; // 1:30 in seconds

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = '/login?redirect=/artist/vinyl/new';
      return;
    }
    currentUser = user;

    // Fetch seller info
    try {
      const response = await fetch(`/api/get-user-type?uid=${user.uid}`);
      const data = await response.json();
      if (!data.isVinylSeller) {
        alert('You need to be an approved vinyl seller to list records.');
        window.location.href = '/artist/dashboard';
        return;
      }
      sellerInfo = { id: user.uid, name: data.displayName || user.displayName || 'Unknown' };
    } catch (e) {
      console.error('Failed to verify seller status:', e);
    }
  });

  // Image upload handlers
  document.querySelectorAll('.image-input').forEach(input => {
    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const slot = e.target.closest('.image-slot');
      const index = parseInt(slot.dataset.index);
      const preview = slot.querySelector('.image-preview');
      const removeBtn = slot.querySelector('.remove-btn');

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.style.backgroundImage = `url(${e.target.result})`;
        slot.classList.remove('empty');
        slot.classList.add('has-image');
        removeBtn.style.display = 'block';
      };
      reader.readAsDataURL(file);

      // Store for upload
      uploadedImages[index] = { file, uploaded: false, url: null };
    });
  });

  // Remove image handlers
  document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const slot = e.target.closest('.image-slot');
      const index = parseInt(slot.dataset.index);
      const preview = slot.querySelector('.image-preview');
      const input = slot.querySelector('.image-input');

      preview.style.backgroundImage = '';
      slot.classList.add('empty');
      slot.classList.remove('has-image');
      btn.style.display = 'none';
      input.value = '';
      uploadedImages[index] = null;
    });
  });

  // Waveform and region variables
  let wavesurfer = null;
  let activeRegion = null;
  let originalAudioBuffer = null;
  let regionStart = 0;
  let regionEnd = 0;

  // Initialize waveform with regions plugin
  function initWaveform() {
    if (wavesurfer) {
      wavesurfer.destroy();
    }

    const regions = WaveSurfer.Regions.create();

    wavesurfer = WaveSurfer.create({
      container: '#waveform',
      waveColor: '#999',
      progressColor: '#000',
      cursorColor: '#333',
      height: 100,
      normalize: true,
      plugins: [regions],
    });

    // Region event handlers
    regions.on('region-updated', (region) => {
      // Enforce max duration
      let start = region.start;
      let end = region.end;
      let duration = end - start;

      if (duration > MAX_AUDIO_DURATION) {
        // Trim from the end
        end = start + MAX_AUDIO_DURATION;
        region.setOptions({ start, end });
        duration = MAX_AUDIO_DURATION;
      }

      regionStart = start;
      regionEnd = end;
      updateRegionDisplay();
    });

    regions.on('region-clicked', (region, e) => {
      e.stopPropagation();
      region.play();
    });

    return { wavesurfer, regions };
  }

  function updateRegionDisplay() {
    const duration = regionEnd - regionStart;
    document.getElementById('regionStart').value = formatDuration(regionStart);
    document.getElementById('regionEnd').value = formatDuration(regionEnd);
    document.getElementById('regionDuration').textContent = formatDuration(duration);
    document.getElementById('finalDuration').textContent = formatDuration(duration);

    // Show warning if at max
    const durationEl = document.getElementById('regionDuration');
    if (duration >= MAX_AUDIO_DURATION - 0.5) {
      durationEl.style.color = '#dc2626';
    } else {
      durationEl.style.color = '#000';
    }

    // Show ready indicator
    if (duration > 0) {
      document.getElementById('sampleReady').style.display = 'flex';
      audioDuration = duration;
    }
  }

  // Audio file handler
  document.getElementById('audioInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    audioFile = file;

    const audioLabel = document.getElementById('audioLabel');
    const audioLoading = document.getElementById('audioLoading');
    const waveformEditor = document.getElementById('waveformEditor');

    // Show loading state
    audioLabel.style.display = 'none';
    audioLoading.style.display = 'flex';

    try {
      // Initialize wavesurfer
      const { wavesurfer: ws, regions } = initWaveform();

      // Load the file
      const fileUrl = URL.createObjectURL(file);
      await ws.load(fileUrl);

      // Store decoded audio for later extraction
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const arrayBuffer = await file.arrayBuffer();
      originalAudioBuffer = await audioContext.decodeAudioData(arrayBuffer);

      // Get duration and set initial region
      const totalDuration = ws.getDuration();
      const initialEnd = Math.min(totalDuration, MAX_AUDIO_DURATION);

      // Create the selection region
      activeRegion = regions.addRegion({
        start: 0,
        end: initialEnd,
        color: 'rgba(0, 0, 0, 0.2)',
        drag: true,
        resize: true,
        minLength: 5, // Minimum 5 seconds
      });

      regionStart = 0;
      regionEnd = initialEnd;
      audioDuration = initialEnd;

      // Update display
      document.getElementById('trackName').textContent = file.name;
      updateRegionDisplay();

      // Show waveform editor
      audioLoading.style.display = 'none';
      waveformEditor.style.display = 'block';

    } catch (error) {
      console.error('Failed to load audio:', error);
      alert('Failed to load audio file. Please try a different file format.');
      audioLoading.style.display = 'none';
      audioLabel.style.display = 'flex';
      e.target.value = '';
    }
  });

  // Drag and drop support
  const audioUpload = document.getElementById('audioUpload');
  audioUpload.addEventListener('dragover', (e) => {
    e.preventDefault();
    audioUpload.classList.add('drag-over');
  });
  audioUpload.addEventListener('dragleave', () => {
    audioUpload.classList.remove('drag-over');
  });
  audioUpload.addEventListener('drop', (e) => {
    e.preventDefault();
    audioUpload.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('audio/')) {
      const input = document.getElementById('audioInput');
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      input.dispatchEvent(new Event('change'));
    }
  });

  // Play region button
  document.getElementById('playRegion').addEventListener('click', () => {
    if (activeRegion) {
      activeRegion.play();
    }
  });

  // Reset region button
  document.getElementById('resetRegion').addEventListener('click', () => {
    if (activeRegion && wavesurfer) {
      const totalDuration = wavesurfer.getDuration();
      const newEnd = Math.min(totalDuration, MAX_AUDIO_DURATION);
      activeRegion.setOptions({ start: 0, end: newEnd });
      regionStart = 0;
      regionEnd = newEnd;
      updateRegionDisplay();
    }
  });

  // Change track button
  document.getElementById('changeTrack').addEventListener('click', () => {
    const audioInput = document.getElementById('audioInput');
    const audioLabel = document.getElementById('audioLabel');
    const waveformEditor = document.getElementById('waveformEditor');
    const sampleReady = document.getElementById('sampleReady');

    // Reset everything
    if (wavesurfer) {
      wavesurfer.destroy();
      wavesurfer = null;
    }
    activeRegion = null;
    originalAudioBuffer = null;
    audioFile = null;
    convertedAudioBlob = null;
    audioDuration = 0;

    audioInput.value = '';
    waveformEditor.style.display = 'none';
    sampleReady.style.display = 'none';
    audioLabel.style.display = 'flex';
  });

  // Extract selected region and convert to MP3
  async function extractAndConvertRegion() {
    if (!originalAudioBuffer || regionEnd <= regionStart) {
      return null;
    }

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const sampleRate = originalAudioBuffer.sampleRate;
    const channels = originalAudioBuffer.numberOfChannels;

    // Calculate sample positions
    const startSample = Math.floor(regionStart * sampleRate);
    const endSample = Math.floor(regionEnd * sampleRate);
    const length = endSample - startSample;

    // Create new buffer for the extracted region
    const extractedBuffer = audioContext.createBuffer(channels, length, sampleRate);

    // Copy the samples
    for (let channel = 0; channel < channels; channel++) {
      const sourceData = originalAudioBuffer.getChannelData(channel);
      const destData = extractedBuffer.getChannelData(channel);
      for (let i = 0; i < length; i++) {
        destData[i] = sourceData[startSample + i];
      }
    }

    // Convert to MP3
    return await convertBufferToMp3(extractedBuffer, 128);
  }

  // Convert AudioBuffer to MP3
  async function convertBufferToMp3(audioBuffer, bitrate) {
    return new Promise(async (resolve, reject) => {
      try {
        const channels = audioBuffer.numberOfChannels;
        const sampleRate = audioBuffer.sampleRate;
        const samples = audioBuffer.length;

        let leftChannel = audioBuffer.getChannelData(0);
        let rightChannel = channels > 1 ? audioBuffer.getChannelData(1) : leftChannel;

        // Wait for lamejs to load
        await new Promise(r => {
          if (window.lamejs) r();
          else lameScript.onload = r;
        });

        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, bitrate);
        const mp3Data = [];

        const blockSize = 1152;
        for (let i = 0; i < samples; i += blockSize) {
          const leftChunk = new Int16Array(blockSize);
          const rightChunk = new Int16Array(blockSize);

          for (let j = 0; j < blockSize && (i + j) < samples; j++) {
            leftChunk[j] = Math.max(-32768, Math.min(32767, leftChannel[i + j] * 32767));
            rightChunk[j] = Math.max(-32768, Math.min(32767, rightChannel[i + j] * 32767));
          }

          const mp3buf = channels === 1
            ? mp3encoder.encodeBuffer(leftChunk)
            : mp3encoder.encodeBuffer(leftChunk, rightChunk);

          if (mp3buf.length > 0) {
            mp3Data.push(mp3buf);
          }
        }

        const mp3buf = mp3encoder.flush();
        if (mp3buf.length > 0) {
          mp3Data.push(mp3buf);
        }

        const blob = new Blob(mp3Data, { type: 'audio/mpeg' });
        resolve(blob);
      } catch (error) {
        reject(error);
      }
    });
  }

  function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Character counters
  document.getElementById('conditionNotes').addEventListener('input', (e) => {
    document.getElementById('notesCount').textContent = e.target.value.length;
  });

  document.getElementById('description').addEventListener('input', (e) => {
    document.getElementById('descCount').textContent = e.target.value.length;
  });

  // Price breakdown
  const priceInput = document.getElementById('price');
  const shippingInput = document.getElementById('shippingCost');

  function updateBreakdown() {
    const price = parseFloat(priceInput.value) || 0;
    const shipping = parseFloat(shippingInput.value) || 0;

    if (price <= 0) {
      document.getElementById('priceBreakdown').style.display = 'none';
      return;
    }

    const processingFee = (price + shipping) * 0.03;
    const platformFee = price * 0.10;
    const total = price + shipping - processingFee - platformFee;

    document.getElementById('breakdownPrice').textContent = `¬£${price.toFixed(2)}`;
    document.getElementById('breakdownShipping').textContent = `¬£${shipping.toFixed(2)}`;
    document.getElementById('breakdownProcessing').textContent = `-¬£${processingFee.toFixed(2)}`;
    document.getElementById('breakdownPlatform').textContent = `-¬£${platformFee.toFixed(2)}`;
    document.getElementById('breakdownTotal').textContent = `¬£${total.toFixed(2)}`;
    document.getElementById('priceBreakdown').style.display = 'block';
  }

  priceInput.addEventListener('input', updateBreakdown);
  shippingInput.addEventListener('input', updateBreakdown);

  // Form submission
  document.getElementById('listingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await submitListing(true);
  });

  document.getElementById('saveDraftBtn').addEventListener('click', async () => {
    await submitListing(false);
  });

  async function submitListing(publish) {
    if (!currentUser || !sellerInfo) {
      alert('Please wait for authentication to complete.');
      return;
    }

    const form = document.getElementById('listingForm');
    const formData = new FormData(form);

    // Validate required fields
    if (!formData.get('artist') || !formData.get('title')) {
      alert('Please fill in artist and title.');
      return;
    }
    if (!formData.get('mediaCondition') || !formData.get('sleeveCondition')) {
      alert('Please select media and sleeve condition.');
      return;
    }
    if (!formData.get('price') || parseFloat(formData.get('price')) <= 0) {
      alert('Please enter a valid price.');
      return;
    }

    // Must have at least one image to publish
    const hasImages = uploadedImages.some(img => img && img.file);
    if (publish && !hasImages) {
      alert('Please add at least one photo to publish your listing.');
      return;
    }

    // Show upload modal
    const modal = document.getElementById('uploadModal');
    const progress = document.getElementById('uploadProgress');
    const status = document.getElementById('uploadStatus');
    modal.style.display = 'flex';

    try {
      // Upload images
      const imageUrls = [];
      const imagesToUpload = uploadedImages.filter(img => img && img.file && !img.uploaded);

      for (let i = 0; i < imagesToUpload.length; i++) {
        status.textContent = `Uploading image ${i + 1} of ${imagesToUpload.length}...`;
        progress.style.width = `${((i + 1) / (imagesToUpload.length + 2)) * 100}%`;

        const imgData = new FormData();
        imgData.append('file', imagesToUpload[i].file);
        imgData.append('sellerId', sellerInfo.id);
        imgData.append('imageIndex', i.toString());

        const response = await fetch('/api/vinyl/upload-image', {
          method: 'POST',
          body: imgData
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to upload image');
        }

        imageUrls.push(result.url);
      }

      // Upload audio if present - extract selected region first
      let audioUrl = null;
      if (originalAudioBuffer && regionEnd > regionStart) {
        status.textContent = 'Extracting audio sample...';
        progress.style.width = '70%';

        // Extract the selected region and convert to MP3
        const audioBlob = await extractAndConvertRegion();

        if (audioBlob) {
          status.textContent = 'Uploading audio sample...';
          progress.style.width = '80%';

          const audioData = new FormData();
          audioData.append('file', audioBlob, 'sample.mp3');
          audioData.append('sellerId', sellerInfo.id);
          audioData.append('duration', (regionEnd - regionStart).toString());

          const response = await fetch('/api/vinyl/upload-audio', {
            method: 'POST',
            body: audioData
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || 'Failed to upload audio');
          }

          audioUrl = result.url;
          audioDuration = regionEnd - regionStart;
        }
      }

      // Create listing
      status.textContent = 'Creating listing...';
      progress.style.width = '90%';

      const listingData = {
        action: 'create',
        sellerId: sellerInfo.id,
        sellerName: sellerInfo.name,
        artist: formData.get('artist'),
        title: formData.get('title'),
        label: formData.get('label'),
        catalogNumber: formData.get('catalogNumber'),
        format: formData.get('format'),
        releaseYear: formData.get('releaseYear') ? parseInt(formData.get('releaseYear')) : null,
        genre: formData.get('genre'),
        mediaCondition: formData.get('mediaCondition'),
        sleeveCondition: formData.get('sleeveCondition'),
        conditionNotes: formData.get('conditionNotes'),
        price: parseFloat(formData.get('price')),
        shippingCost: parseFloat(formData.get('shippingCost') || '0'),
        description: formData.get('description'),
        images: imageUrls,
        audioSampleUrl: audioUrl,
        audioSampleDuration: audioUrl ? audioDuration : null
      };

      const createResponse = await fetch('/api/vinyl/listing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(listingData)
      });

      const createResult = await createResponse.json();
      if (!createResult.success) {
        throw new Error(createResult.error || 'Failed to create listing');
      }

      // Publish if requested
      if (publish && createResult.listingId) {
        status.textContent = 'Submitting for review...';
        progress.style.width = '95%';

        await fetch('/api/vinyl/listing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'publish',
            sellerId: sellerInfo.id,
            listingId: createResult.listingId
          })
        });
      }

      progress.style.width = '100%';
      status.textContent = publish ? 'Listing submitted for review!' : 'Draft saved!';

      setTimeout(() => {
        window.location.href = '/artist/vinyl';
      }, 1500);

    } catch (error) {
      console.error('Submission error:', error);
      modal.style.display = 'none';
      alert('Error: ' + error.message);
    }
  }
</script>

<style>
  .page-header { margin-bottom: 2rem; }
  .back-link { color: #666; text-decoration: none; font-size: 0.9rem; }
  .back-link:hover { color: #000; }
  .page-header h1 { margin: 0.5rem 0 0.25rem; font-size: 1.75rem; }
  .subtitle { color: #666; margin: 0; }

  .listing-form { max-width: 800px; }

  .form-section {
    background: #fff;
    border: 1px solid #e5e5e5;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .form-section h2 {
    font-size: 1.1rem;
    margin: 0 0 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .optional { font-weight: 400; color: #999; font-size: 0.85rem; }
  .section-desc { color: #666; font-size: 0.9rem; margin: 0 0 1rem; }

  .image-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .image-slot {
    aspect-ratio: 1;
    border: 2px dashed #ddd;
    position: relative;
    background: #fafafa;
    overflow: hidden;
  }

  .image-slot.has-image { border-style: solid; border-color: #000; }

  .image-input { display: none; }

  .image-label {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #999;
  }

  .image-label .plus { font-size: 2rem; line-height: 1; }
  .image-label .text { font-size: 0.8rem; margin-top: 0.5rem; }

  .image-slot.has-image .image-label { display: none; }

  .image-preview {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
  }

  .remove-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #000;
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
  }

  .audio-upload {
    border: 2px dashed #ddd;
    padding: 2rem;
    text-align: center;
    background: #fafafa;
  }

  .audio-input { display: none; }

  .audio-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: #666;
  }

  .audio-label .icon { font-size: 2rem; }
  .audio-label .hint { font-size: 0.8rem; color: #999; }

  .audio-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .audio-preview audio { width: 100%; max-width: 400px; }

  .audio-info { display: flex; align-items: center; gap: 1rem; }

  .remove-audio-btn {
    background: none;
    border: none;
    color: #dc2626;
    cursor: pointer;
    text-decoration: underline;
  }

  .audio-upload.drag-over {
    border-color: #000;
    background: #f0f0f0;
  }

  .audio-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: #666;
    padding: 2rem;
  }

  .audio-processing {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: #666;
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid #e5e5e5;
    border-top-color: #000;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Waveform Editor Styles */
  .waveform-editor {
    text-align: left;
  }

  .waveform-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .track-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
    max-width: 70%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .change-track-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    text-decoration: underline;
    font-size: 0.85rem;
  }

  .change-track-btn:hover {
    color: #000;
  }

  .waveform-container {
    background: #fff;
    border: 1px solid #ddd;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  #waveform {
    width: 100%;
  }

  .region-controls {
    background: #fff;
    border: 1px solid #ddd;
    padding: 1rem;
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .time-input {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .time-input label {
    font-size: 0.75rem;
    color: #999;
    margin-bottom: 0.25rem;
  }

  .time-input input {
    width: 60px;
    text-align: center;
    padding: 0.5rem;
    border: 1px solid #ddd;
    font-family: monospace;
    font-size: 0.9rem;
    background: #f9f9f9;
  }

  .region-duration {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
  }

  .region-duration .max-hint {
    font-size: 0.8rem;
    font-weight: 400;
    color: #999;
    display: block;
  }

  .playback-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .play-btn {
    background: #000;
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .play-btn:hover {
    background: #333;
  }

  .reset-btn {
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .reset-btn:hover {
    background: #eee;
  }

  .region-hint {
    font-size: 0.8rem;
    color: #999;
    text-align: center;
    margin: 0;
  }

  .sample-ready {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: #e8f5e9;
    border: 1px solid #c8e6c9;
    color: #2e7d32;
    margin-top: 1rem;
  }

  .sample-ready .check {
    font-size: 1.2rem;
  }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

  .form-group { margin-bottom: 1rem; }
  .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    font-size: 1rem;
    font-family: inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: #000;
  }

  .required { color: #dc2626; }
  .form-hint { font-size: 0.8rem; color: #999; margin-top: 0.25rem; }
  .char-count { font-size: 0.8rem; color: #999; text-align: right; }

  .input-prefix { position: relative; }
  .input-prefix .prefix {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
  }
  .input-prefix input { padding-left: 1.75rem; }

  .price-breakdown {
    background: #f9f9f9;
    padding: 1rem;
    margin-top: 1rem;
    border: 1px solid #e5e5e5;
  }

  .breakdown-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    font-size: 0.9rem;
  }

  .breakdown-row.total {
    border-top: 2px solid #000;
    font-weight: 700;
    font-size: 1rem;
    margin-top: 0.5rem;
    padding-top: 0.75rem;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1rem 0;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
  }

  .btn-primary { background: #000; color: #fff; }
  .btn-primary:hover { background: #333; }
  .btn-secondary { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
  .btn-secondary:hover { background: #eee; }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal {
    background: #fff;
    padding: 2rem;
    width: 90%;
    max-width: 400px;
    text-align: center;
  }

  .modal h3 { margin: 0 0 1rem; }

  .progress-bar {
    height: 8px;
    background: #e5e5e5;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  .progress-fill {
    height: 100%;
    background: #000;
    width: 0;
    transition: width 0.3s;
  }

  @media (max-width: 600px) {
    .image-grid { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
    .form-actions { flex-direction: column; }
    .btn { width: 100%; }
    .playback-controls { flex-direction: column; }
    .play-btn, .reset-btn { width: 100%; justify-content: center; }
    .time-display { gap: 0.5rem; }
    .region-duration { font-size: 1.2rem; }
  }
</style>
