---
// src/pages/artist/vinyl/orders.astro
// Vinyl seller's orders management page
import VinylDashboardLayout from '../../../layouts/VinylDashboardLayout.astro';
export const prerender = false;
---

<VinylDashboardLayout title="Vinyl Orders" activeSection="orders">
  <div class="page-header">
    <div class="header-content">
      <h1>Vinyl Orders</h1>
      <p class="subtitle">Manage orders for your vinyl listings</p>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-grid">
    <div class="stat-card warning">
      <div class="stat-value" id="awaitingCount">0</div>
      <div class="stat-label">Awaiting Shipment</div>
    </div>
    <div class="stat-card info">
      <div class="stat-value" id="shippedCount">0</div>
      <div class="stat-label">Shipped</div>
    </div>
    <div class="stat-card success">
      <div class="stat-value" id="deliveredCount">0</div>
      <div class="stat-label">Delivered</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalEarnings">¬£0</div>
      <div class="stat-label">Total Earnings</div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="filter-bar">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All Orders</button>
      <button class="filter-tab" data-filter="awaiting">Awaiting Shipment</button>
      <button class="filter-tab" data-filter="shipped">Shipped</button>
      <button class="filter-tab" data-filter="delivered">Delivered</button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="ordersLoadingState" class="orders-loading-state">
    <div class="spinner"></div>
    <p>Loading your orders...</p>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display:none;">
    <div class="empty-icon">üì¶</div>
    <h3>No orders yet</h3>
    <p>When someone buys your vinyl, orders will appear here</p>
  </div>

  <!-- Orders List -->
  <div id="ordersList" class="orders-list" style="display:none;">
  </div>

  <!-- Ship Order Modal -->
  <div id="shipModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Mark as Shipped</h3>
        <button class="modal-close" onclick="closeShipModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="carrier">Carrier</label>
          <select id="carrier">
            <option value="Royal Mail">Royal Mail</option>
            <option value="Evri">Evri (Hermes)</option>
            <option value="DPD">DPD</option>
            <option value="UPS">UPS</option>
            <option value="FedEx">FedEx</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="trackingNumber">Tracking Number (Optional)</label>
          <input type="text" id="trackingNumber" placeholder="e.g. AB123456789GB">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeShipModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmShip()">Mark as Shipped</button>
      </div>
    </div>
  </div>
</VinylDashboardLayout>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let currentUser = null;
  let allOrders = [];
  let currentFilter = 'all';
  let currentOrderId = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = '/login?redirect=/artist/vinyl/orders';
      return;
    }
    currentUser = user;
    loadOrders();
  });

  async function loadOrders() {
    try {
      // Use API endpoint instead of direct Firestore
      const response = await fetch(`/api/vinyl/orders?sellerId=${encodeURIComponent(currentUser.uid)}`);
      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'Failed to load orders');
      }

      allOrders = result.orders || [];

      updateStats();
      renderOrders();

      document.getElementById('ordersLoadingState').style.display = 'none';

      if (allOrders.length === 0) {
        document.getElementById('emptyState').style.display = 'flex';
      } else {
        document.getElementById('ordersList').style.display = 'block';
      }

    } catch (error) {
      console.error('Error loading orders:', error);
      document.getElementById('ordersLoadingState').innerHTML = `
        <div class="empty-icon">‚ùå</div>
        <h3>Error loading orders</h3>
        <p>${error.message}</p>
      `;
    }
  }

  function updateStats() {
    const awaiting = allOrders.filter(o => o.status === 'paid');
    const shipped = allOrders.filter(o => o.status === 'shipped');
    const delivered = allOrders.filter(o => o.status === 'delivered');
    const earnings = allOrders
      .filter(o => ['paid', 'shipped', 'delivered'].includes(o.status))
      .reduce((sum, o) => sum + (o.sellerPayout || 0), 0);

    document.getElementById('awaitingCount').textContent = awaiting.length;
    document.getElementById('shippedCount').textContent = shipped.length;
    document.getElementById('deliveredCount').textContent = delivered.length;
    document.getElementById('totalEarnings').textContent = '¬£' + earnings.toFixed(2);
  }

  function renderOrders() {
    let filtered = allOrders.filter(o => {
      switch (currentFilter) {
        case 'awaiting': return o.status === 'paid';
        case 'shipped': return o.status === 'shipped';
        case 'delivered': return o.status === 'delivered';
        default: return true;
      }
    });

    const list = document.getElementById('ordersList');
    const emptyState = document.getElementById('emptyState');

    if (filtered.length === 0) {
      list.style.display = 'none';
      emptyState.style.display = 'flex';
      return;
    }

    emptyState.style.display = 'none';
    list.style.display = 'block';

    list.innerHTML = filtered.map(o => {
      const statusClass = getStatusClass(o.status);
      const statusLabel = getStatusLabel(o.status);
      const date = o.createdAt ? new Date(o.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Unknown';

      const items = (o.items || []).map(item =>
        `<div class="item-row">
          <span class="item-title">${item.artist || ''} - ${item.title || ''}</span>
          <span class="item-price">¬£${(item.price || 0).toFixed(2)}</span>
        </div>`
      ).join('');

      const address = o.shippingAddress ? `
        <div class="address">
          <strong>Ship to:</strong><br>
          ${o.shippingAddress.name || ''}<br>
          ${o.shippingAddress.line1 || ''}<br>
          ${o.shippingAddress.line2 ? o.shippingAddress.line2 + '<br>' : ''}
          ${o.shippingAddress.city || ''}, ${o.shippingAddress.postcode || ''}<br>
          ${o.shippingAddress.country || 'United Kingdom'}
        </div>
      ` : '';

      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-id">
              <span class="label">Order</span>
              <code>${o.id.substring(0, 12)}...</code>
            </div>
            <div class="order-date">${date}</div>
            <span class="status-badge ${statusClass}">${statusLabel}</span>
          </div>

          <div class="order-body">
            <div class="order-items">${items}</div>
            ${address}
          </div>

          <div class="order-footer">
            <div class="order-totals">
              <span>Your payout: <strong>¬£${(o.sellerPayout || 0).toFixed(2)}</strong></span>
            </div>
            <div class="order-actions">
              ${o.status === 'paid' ? `
                <button class="btn btn-primary" onclick="openShipModal('${o.id}')">Mark as Shipped</button>
              ` : o.status === 'shipped' ? `
                <span class="shipped-info">
                  ${o.carrier ? `<span>${o.carrier}</span>` : ''}
                  ${o.trackingNumber ? `<code>${o.trackingNumber}</code>` : ''}
                </span>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function getStatusClass(status) {
    switch (status) {
      case 'paid': return 'warning';
      case 'shipped': return 'info';
      case 'delivered': return 'success';
      default: return '';
    }
  }

  function getStatusLabel(status) {
    switch (status) {
      case 'paid': return 'Awaiting Shipment';
      case 'shipped': return 'Shipped';
      case 'delivered': return 'Delivered';
      case 'cancelled': return 'Cancelled';
      case 'refunded': return 'Refunded';
      default: return status;
    }
  }

  // Filter handlers
  document.querySelectorAll('.filter-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderOrders();
    });
  });

  // Ship modal
  window.openShipModal = function(orderId) {
    currentOrderId = orderId;
    document.getElementById('shipModal').style.display = 'flex';
  };

  window.closeShipModal = function() {
    currentOrderId = null;
    document.getElementById('shipModal').style.display = 'none';
    document.getElementById('carrier').value = 'Royal Mail';
    document.getElementById('trackingNumber').value = '';
  };

  window.confirmShip = async function() {
    if (!currentOrderId) return;

    const carrier = document.getElementById('carrier').value;
    const trackingNumber = document.getElementById('trackingNumber').value.trim();

    try {
      // Get auth token
      const idToken = await currentUser.getIdToken();

      const response = await fetch('/api/vinyl/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}`
        },
        body: JSON.stringify({
          action: 'mark-shipped',
          orderId: currentOrderId,
          sellerId: currentUser.uid,
          carrier,
          trackingNumber
        })
      });

      const result = await response.json();
      if (!result.success) {
        throw new Error(result.error || 'Failed to update order');
      }

      closeShipModal();
      loadOrders();

    } catch (error) {
      alert('Error: ' + error.message);
    }
  };
</script>

<style>
  .page-header { margin-bottom: 2rem; }
  .page-header h1 { margin: 0; font-size: 1.75rem; color: #fff; }
  .subtitle { color: #888; margin: 0.25rem 0 0; }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
  }

  .stat-card.success { border-color: #16a34a; }
  .stat-card.warning { border-color: #f97316; }
  .stat-card.info { border-color: #0284c7; }

  .stat-value { font-size: 1.75rem; font-weight: 800; color: #fff; }
  .stat-card.success .stat-value { color: #22c55e; }
  .stat-card.warning .stat-value { color: #f97316; }
  .stat-card.info .stat-value { color: #38bdf8; }
  .stat-label { font-size: 0.8rem; color: #888; margin-top: 0.25rem; }

  .filter-bar { margin-bottom: 1.5rem; }
  .filter-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }

  .filter-tab {
    padding: 0.5rem 1rem;
    background: #252525;
    border: 1px solid #333;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    color: #ccc;
    transition: all 0.2s;
  }

  .filter-tab:hover { background: #333; }
  .filter-tab.active { background: #f97316; color: #fff; border-color: #f97316; }

  .orders-loading-state, .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
    color: #888;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #333;
    border-top-color: #f97316;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
  .empty-state h3 { margin: 0 0 0.5rem; color: #fff; }
  .empty-state p { color: #888; margin: 0; }

  .orders-list { display: flex; flex-direction: column; gap: 1rem; }

  .order-card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    overflow: hidden;
  }

  .order-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #252525;
    border-bottom: 1px solid #333;
    flex-wrap: wrap;
  }

  .order-id { flex: 1; }
  .order-id .label { font-size: 0.8rem; color: #888; display: block; }
  .order-id code { font-size: 0.9rem; color: #f97316; background: #333; padding: 0.15rem 0.4rem; border-radius: 4px; }

  .order-date { font-size: 0.9rem; color: #888; }

  .status-badge {
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    background: #333;
    color: #fff;
    border-radius: 4px;
  }

  .status-badge.success { background: #16a34a; }
  .status-badge.warning { background: #f97316; }
  .status-badge.info { background: #0284c7; }

  .order-body {
    padding: 1rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .order-items { display: flex; flex-direction: column; gap: 0.5rem; }

  .item-row {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
  }

  .item-title { font-weight: 500; color: #fff; }
  .item-price { color: #f97316; font-weight: 600; }

  .address {
    font-size: 0.9rem;
    color: #888;
    line-height: 1.5;
  }

  .address strong { color: #ccc; }

  .order-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #252525;
    border-top: 1px solid #333;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .order-totals { color: #ccc; }
  .order-totals strong { color: #22c55e; }

  .shipped-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #888;
  }

  .shipped-info code { background: #333; color: #f97316; padding: 0.25rem 0.5rem; border-radius: 4px; }

  .btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary { background: #f97316; color: #fff; }
  .btn-primary:hover { background: #ea580c; }
  .btn-secondary { background: #333; color: #fff; border: 1px solid #444; }
  .btn-secondary:hover { background: #444; }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #333;
  }

  .modal-header h3 { margin: 0; color: #fff; }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #888;
  }

  .modal-close:hover { color: #fff; }

  .modal-body { padding: 1rem; }

  .form-group { margin-bottom: 1rem; }
  .form-group label { display: block; font-weight: 600; margin-bottom: 0.35rem; color: #ccc; }
  .form-group input, .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #444;
    border-radius: 8px;
    font-size: 1rem;
    background: #252525;
    color: #fff;
  }

  .form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #f97316;
  }

  .form-group input::placeholder { color: #666; }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid #333;
  }

  @media (max-width: 768px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .order-body { grid-template-columns: 1fr; }
  }
</style>
