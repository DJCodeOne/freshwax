---
// /src/pages/artist/payouts.astro
// Artist Payouts Dashboard - View earnings and payout history
// Source of truth: salesLedger collection

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getDocument, queryCollection } from '../../lib/firebase-rest';
import { saQueryCollection } from '../../lib/firebase-service-account';

const partnerId = Astro.cookies.get('partnerId')?.value || '';
let partner: any = null;
let payouts: any[] = [];
let pendingPayouts: any[] = [];
let ledgerEntries: any[] = [];
let summary = {
  totalEarnings: 0,
  pendingBalance: 0,
  thisMonthEarnings: 0,
  stripeConnected: false,
  paidOut: 0
};

// Get service account credentials
const env = (Astro.locals as any)?.runtime?.env;
const projectId = env?.FIREBASE_PROJECT_ID || import.meta.env.FIREBASE_PROJECT_ID || 'freshwax-store';
const clientEmail = env?.FIREBASE_CLIENT_EMAIL || import.meta.env.FIREBASE_CLIENT_EMAIL;
const privateKey = env?.FIREBASE_PRIVATE_KEY || import.meta.env.FIREBASE_PRIVATE_KEY;

let serviceAccountKey: string | null = null;
if (clientEmail && privateKey) {
  serviceAccountKey = JSON.stringify({
    type: 'service_account',
    project_id: projectId,
    private_key_id: 'auto',
    private_key: privateKey.replace(/\\n/g, '\n'),
    client_email: clientEmail,
    client_id: '',
    auth_uri: 'https://accounts.google.com/o/oauth2/auth',
    token_uri: 'https://oauth2.googleapis.com/token'
  });
}

if (partnerId) {
  try {
    const partnerDoc = await getDocument('artists', partnerId);
    if (partnerDoc) {
      partner = { id: partnerId, ...partnerDoc };

      // Query salesLedger for this artist's earnings (source of truth)
      if (serviceAccountKey) {
        try {
          const allLedgerEntries = await saQueryCollection(serviceAccountKey, projectId, 'salesLedger', {
            orderBy: { field: 'timestamp', direction: 'DESCENDING' },
            limit: 500
          });

          // Filter entries where this artist is the submitter (person to be paid)
          ledgerEntries = allLedgerEntries.filter((e: any) =>
            e.submitterId === partnerId ||
            e.artistId === partnerId ||
            e.artistName === partnerDoc.artistName
          );

          // Calculate earnings from ledger
          let totalEarned = 0;
          let totalPaid = 0;
          let thisMonthEarned = 0;

          const now = new Date();
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

          ledgerEntries.forEach((entry: any) => {
            const artistPayout = entry.artistPayout || entry.actualArtistPayout || 0;
            totalEarned += artistPayout;

            if (entry.artistPayoutStatus === 'paid') {
              totalPaid += entry.artistPayoutPaid || artistPayout;
            }

            // This month earnings
            const entryDate = new Date(entry.timestamp);
            if (entryDate >= monthStart) {
              thisMonthEarned += artistPayout;
            }
          });

          summary.totalEarnings = totalEarned;
          summary.paidOut = totalPaid;
          summary.pendingBalance = totalEarned - totalPaid;
          summary.thisMonthEarnings = thisMonthEarned;
        } catch (ledgerErr) {
          console.error('Error fetching ledger entries:', ledgerErr);
          // Fall back to partner.totalEarnings
          summary.totalEarnings = partnerDoc.totalEarnings || 0;
        }
      } else {
        // Fallback if no service account
        summary.totalEarnings = partnerDoc.totalEarnings || 0;
      }

      // Fetch payouts history (for display)
      payouts = await queryCollection('payouts', {
        filters: [{ field: 'artistId', op: 'EQUAL', value: partnerId }],
        orderBy: [{ field: 'createdAt', direction: 'DESCENDING' }],
        limit: 50
      });

      // Fetch pending payouts
      pendingPayouts = await queryCollection('pendingPayouts', {
        filters: [
          { field: 'artistId', op: 'EQUAL', value: partnerId },
          { field: 'status', op: 'IN', value: ['awaiting_connect', 'retry_pending', 'processing'] }
        ],
        orderBy: [{ field: 'createdAt', direction: 'DESCENDING' }]
      });

      summary.stripeConnected = !!partner.stripeConnectId && partner.stripeConnectStatus === 'active';
    }
  } catch (e) {
    console.error('Error fetching payout data:', e);
  }
}

// Calculate monthly earnings for the last 6 months (from ledger entries)
const monthlyEarnings: { month: string; year: number; earnings: number; count: number }[] = [];
const now = new Date();
for (let i = 0; i < 6; i++) {
  const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
  const monthStart = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
  const monthEnd = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0, 23, 59, 59);

  // Use ledger entries as source of truth
  const monthLedgerEntries = ledgerEntries.filter((e: any) => {
    const entryDate = new Date(e.timestamp);
    return entryDate >= monthStart && entryDate <= monthEnd;
  });

  const earnings = monthLedgerEntries.reduce((sum: number, e: any) => {
    return sum + (e.artistPayout || e.actualArtistPayout || 0);
  }, 0);

  monthlyEarnings.push({
    month: targetDate.toLocaleDateString('en-GB', { month: 'short' }),
    year: targetDate.getFullYear(),
    earnings: earnings,
    count: monthLedgerEntries.length
  });
}

// Reverse so oldest is first (for the chart display)
const chartData = monthlyEarnings.reverse();
const maxEarning = Math.max(...chartData.map(d => d.earnings), 1); // At least 1 to avoid division by zero

const isLoggedIn = !!partner;

const formatDate = (dateStr: string) => {
  if (!dateStr) return 'Unknown';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
};

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(price || 0);
};

const getStatusClass = (status: string) => {
  const s = (status || 'pending').toLowerCase();
  if (s === 'completed') return 'completed';
  if (s === 'processing') return 'processing';
  if (s === 'failed' || s === 'retry_pending') return 'failed';
  if (s === 'awaiting_connect') return 'awaiting';
  return 'pending';
};

const getStatusLabel = (status: string) => {
  const s = (status || 'pending').toLowerCase();
  if (s === 'completed') return 'Completed';
  if (s === 'processing') return 'Processing';
  if (s === 'failed') return 'Failed';
  if (s === 'retry_pending') return 'Retry Pending';
  if (s === 'awaiting_connect') return 'Awaiting Setup';
  return 'Pending';
};

export const prerender = false;
---

<Layout title="Payouts">
  <Header />

  <main class="payouts-main">
    <div class="container">
      {!isLoggedIn ? (
        <div class="login-prompt">
          <p>Please log in to view your payouts.</p>
          <a href="/login" class="login-btn">Sign In</a>
        </div>
      ) : (
        <>
          <!-- Page Header -->
          <div class="page-header">
            <div class="header-left">
              <a href="/artist/dashboard" class="back-link">‚Üê Dashboard</a>
              <h1>Payouts</h1>
              <p>Track your earnings and payout history</p>
            </div>
          </div>

          <!-- Stripe Connect Status -->
          {!summary.stripeConnected && (
            <div class="connect-banner">
              <div class="banner-icon">üè¶</div>
              <div class="banner-content">
                <h3>Complete Your Payment Setup</h3>
                <p>Connect your bank account via Stripe to receive automatic payouts when customers buy your music.</p>
                {summary.pendingBalance > 0 && (
                  <p class="pending-amount">You have {formatPrice(summary.pendingBalance)} waiting to be paid out!</p>
                )}
              </div>
              <a href="/artist/account#stripe-connect-section" class="setup-btn">Set Up Payments</a>
            </div>
          )}

          <!-- Summary Cards -->
          <div class="summary-grid">
            <div class="summary-card total">
              <div class="card-icon">üí∞</div>
              <div class="card-content">
                <div class="card-value">{formatPrice(summary.totalEarnings)}</div>
                <div class="card-label">Total Earnings</div>
              </div>
            </div>

            <div class="summary-card paid">
              <div class="card-icon">‚úì</div>
              <div class="card-content">
                <div class="card-value">{formatPrice(summary.paidOut)}</div>
                <div class="card-label">Paid Out</div>
              </div>
            </div>

            <div class="summary-card pending">
              <div class="card-icon">‚è≥</div>
              <div class="card-content">
                <div class="card-value">{formatPrice(summary.pendingBalance)}</div>
                <div class="card-label">Awaiting Payout</div>
              </div>
            </div>

            <div class="summary-card month">
              <div class="card-icon">üìÖ</div>
              <div class="card-content">
                <div class="card-value">{formatPrice(summary.thisMonthEarnings)}</div>
                <div class="card-label">This Month</div>
              </div>
            </div>
          </div>

          <!-- Monthly Earnings Chart -->
          {ledgerEntries.length > 0 && (
            <section class="earnings-chart-section">
              <h2>Earnings Overview</h2>
              <p class="section-desc">Your earnings over the last 6 months</p>

              <div class="chart-container">
                {chartData.map((data, index) => {
                  const heightPercent = maxEarning > 0 ? (data.earnings / maxEarning) * 100 : 0;
                  const isCurrentMonth = index === chartData.length - 1;
                  return (
                    <div class="chart-bar-wrap">
                      <div class="chart-value">{formatPrice(data.earnings)}</div>
                      <div class="chart-bar-container">
                        <div
                          class={`chart-bar ${isCurrentMonth ? 'current' : ''} ${data.earnings === 0 ? 'empty' : ''}`}
                          style={`height: ${Math.max(heightPercent, 2)}%;`}
                        >
                          {data.count > 0 && (
                            <span class="bar-count">{data.count}</span>
                          )}
                        </div>
                      </div>
                      <div class="chart-label">
                        <span class="month-name">{data.month}</span>
                        {(index === 0 || data.year !== chartData[index - 1]?.year) && (
                          <span class="year-label">{data.year}</span>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              <div class="chart-legend">
                <span class="legend-item">
                  <span class="legend-dot current"></span>
                  Current month
                </span>
                <span class="legend-item">
                  <span class="legend-dot"></span>
                  Previous months
                </span>
              </div>
            </section>
          )}

          <!-- Pending Payouts -->
          {pendingPayouts.length > 0 && (
            <section class="payouts-section">
              <h2>Pending Payouts</h2>
              <p class="section-desc">
                {summary.stripeConnected
                  ? 'These payouts are being processed and will arrive in your bank account soon.'
                  : 'Complete your Stripe setup to receive these payouts.'}
              </p>

              <div class="payouts-table-wrap">
                <table class="payouts-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Order</th>
                      <th>Amount</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {pendingPayouts.map(payout => (
                      <tr>
                        <td>{formatDate(payout.createdAt)}</td>
                        <td class="order-num">#{(payout.orderNumber || payout.orderId || '').slice(-8).toUpperCase()}</td>
                        <td class="amount">{formatPrice(payout.amount)}</td>
                        <td>
                          <span class={`status-pill ${getStatusClass(payout.status)}`}>
                            {getStatusLabel(payout.status)}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          )}

          <!-- Payout History -->
          <section class="payouts-section">
            <h2>Payout History</h2>

            {payouts.length === 0 ? (
              <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <h3>No payouts yet</h3>
                <p>When customers purchase your music, your payouts will appear here.</p>
              </div>
            ) : (
              <div class="payouts-table-wrap">
                <table class="payouts-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Order</th>
                      <th>Amount</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {payouts.map(payout => (
                      <tr>
                        <td>{formatDate(payout.createdAt)}</td>
                        <td class="order-num">#{(payout.orderNumber || payout.orderId || '').slice(-8).toUpperCase()}</td>
                        <td class="amount">{formatPrice(payout.amount)}</td>
                        <td>
                          <span class={`status-pill ${getStatusClass(payout.status)}`}>
                            {getStatusLabel(payout.status)}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </section>

          <!-- Info Section -->
          <section class="info-section">
            <h3>How Payouts Work</h3>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-icon">1Ô∏è‚É£</div>
                <div class="info-content">
                  <h4>Customer Purchases</h4>
                  <p>When a customer buys your music, the payment is processed and your share is calculated.</p>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon">2Ô∏è‚É£</div>
                <div class="info-content">
                  <h4>Choose Your Method</h4>
                  <p>Set your preferred payout method in Account Settings - Stripe Connect or PayPal.</p>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon">3Ô∏è‚É£</div>
                <div class="info-content">
                  <h4>Get Paid</h4>
                  <p>Stripe: Bank deposit in 2-3 days. PayPal: Instant to your PayPal account.</p>
                </div>
              </div>
            </div>

            <div class="payment-methods-info">
              <h4>Payment Methods</h4>
              <div class="method-cards">
                <div class="method-card recommended">
                  <span class="method-icon">üí≥</span>
                  <div class="method-details">
                    <strong>Stripe Connect <span class="badge-recommended">Recommended</span></strong>
                    <p>Direct bank deposits. 2-3 business days. <strong>No payout fees!</strong></p>
                  </div>
                </div>
                <div class="method-card">
                  <span class="method-icon">üÖøÔ∏è</span>
                  <div class="method-details">
                    <strong>PayPal</strong>
                    <p>Instant to PayPal. Global coverage. <span class="fee-warning">+2% payout fee</span></p>
                  </div>
                </div>
              </div>
              <p class="fee-note">Fresh Wax takes just 1% platform fee. Stripe payouts are free - PayPal charges an additional 2% per payout.</p>
            </div>
          </section>
        </>
      )}
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .payouts-main {
    min-height: calc(100vh - 200px);
    background: linear-gradient(to bottom, #000000, #111827);
    padding: 2rem 0;
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Page Header */
  .page-header {
    margin-bottom: 2rem;
  }

  .header-left h1 {
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 2.5rem;
    color: #fff;
    margin: 0.5rem 0 0.25rem;
  }

  .header-left p {
    color: #9ca3af;
    font-size: 1.0625rem;
  }

  .back-link {
    color: #9ca3af;
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
  }

  .back-link:hover {
    color: #fff;
  }

  /* Login Prompt */
  .login-prompt {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 4rem 2rem;
    text-align: center;
    color: #9ca3af;
  }

  .login-btn {
    display: inline-block;
    background: #000;
    color: #fff;
    padding: 0.875rem 2rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 1rem;
  }

  /* Connect Banner */
  .connect-banner {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.1));
    border: 2px solid #6366f1;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .banner-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
  }

  .banner-content {
    flex: 1;
    min-width: 200px;
  }

  .banner-content h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.5rem;
  }

  .banner-content p {
    color: #9ca3af;
    font-size: 0.9375rem;
    margin: 0;
  }

  .banner-content .pending-amount {
    color: #fbbf24;
    font-weight: 600;
    margin-top: 0.5rem;
  }

  .setup-btn {
    display: inline-block;
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: #fff;
    padding: 0.875rem 1.5rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    flex-shrink: 0;
  }

  .setup-btn:hover {
    background: linear-gradient(135deg, #818cf8, #6366f1);
  }

  /* Summary Grid */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .summary-card {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .summary-card.total {
    border-color: #22c55e;
    background: linear-gradient(to bottom, rgba(22, 163, 74, 0.1), #111827);
  }

  .summary-card.paid {
    border-color: #10b981;
    background: linear-gradient(to bottom, rgba(16, 185, 129, 0.1), #111827);
  }

  .summary-card.month {
    border-color: #3b82f6;
    background: linear-gradient(to bottom, rgba(59, 130, 246, 0.1), #111827);
  }

  .summary-card.pending {
    border-color: #f59e0b;
    background: linear-gradient(to bottom, rgba(245, 158, 11, 0.1), #111827);
  }

  .summary-card.status {
    border-color: #6366f1;
    background: linear-gradient(to bottom, rgba(99, 102, 241, 0.1), #111827);
  }

  .card-icon {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .card-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
  }

  .card-label {
    font-size: 0.875rem;
    color: #9ca3af;
    text-transform: uppercase;
    font-weight: 600;
  }

  /* Sections */
  .payouts-section {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
  }

  .payouts-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.5rem;
  }

  .section-desc {
    color: #9ca3af;
    font-size: 0.9375rem;
    margin: 0 0 1.5rem;
  }

  /* Table */
  .payouts-table-wrap {
    overflow-x: auto;
  }

  .payouts-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
  }

  .payouts-table th {
    text-align: left;
    padding: 0.875rem 1rem;
    background: linear-gradient(to bottom, #000000, #111827);
    font-weight: 700;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #9ca3af;
    border-bottom: 2px solid #374151;
  }

  .payouts-table td {
    padding: 1rem;
    border-bottom: 1px solid #374151;
    color: #e5e7eb;
  }

  .order-num {
    font-family: monospace;
    color: #9ca3af;
  }

  .amount {
    font-weight: 700;
    color: #22c55e;
  }

  .status-pill {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .status-pill.completed {
    background: rgba(22, 163, 74, 0.2);
    color: #22c55e;
  }

  .status-pill.processing {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
  }

  .status-pill.failed {
    background: rgba(220, 38, 38, 0.2);
    color: #f87171;
  }

  .status-pill.awaiting {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
  }

  .status-pill.pending {
    background: rgba(156, 163, 175, 0.2);
    color: #9ca3af;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.5rem;
  }

  .empty-state p {
    color: #9ca3af;
    font-size: 0.9375rem;
    margin: 0;
  }

  /* Info Section */
  .info-section {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 1.75rem;
  }

  .info-section h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 1.5rem;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .info-item {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }

  .info-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .info-content h4 {
    font-size: 1rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.25rem;
  }

  .info-content p {
    color: #9ca3af;
    font-size: 0.875rem;
    margin: 0;
    line-height: 1.5;
  }

  /* Payment Methods Info */
  .payment-methods-info {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #374151;
  }

  .payment-methods-info h4 {
    font-size: 1rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 1rem;
  }

  .method-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .method-card {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid #374151;
    border-radius: 10px;
    padding: 1rem;
  }

  .method-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .method-details strong {
    display: block;
    color: #fff;
    font-size: 0.9375rem;
    margin-bottom: 0.25rem;
  }

  .method-details p {
    color: #9ca3af;
    font-size: 0.8125rem;
    margin: 0;
    line-height: 1.4;
  }

  .fee-note {
    color: #6b7280;
    font-size: 0.8125rem;
    margin: 0;
    font-style: italic;
  }

  .method-card.recommended {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.05);
  }

  .badge-recommended {
    background: #22c55e;
    color: #000;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    text-transform: uppercase;
    margin-left: 0.5rem;
    vertical-align: middle;
  }

  .fee-warning {
    color: #f59e0b;
    font-weight: 600;
  }

  /* Earnings Chart */
  .earnings-chart-section {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
  }

  .earnings-chart-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.5rem;
  }

  .chart-container {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 0.75rem;
    height: 200px;
    padding: 1rem 0;
    margin-top: 1rem;
  }

  .chart-bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    max-width: 100px;
  }

  .chart-value {
    font-size: 0.75rem;
    color: #9ca3af;
    font-weight: 600;
    margin-bottom: 0.5rem;
    white-space: nowrap;
  }

  .chart-bar-container {
    flex: 1;
    width: 100%;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }

  .chart-bar {
    width: 100%;
    max-width: 50px;
    background: linear-gradient(to top, #3b82f6, #60a5fa);
    border-radius: 6px 6px 0 0;
    position: relative;
    transition: all 0.3s ease;
    min-height: 4px;
  }

  .chart-bar:hover {
    filter: brightness(1.1);
    transform: scaleX(1.05);
  }

  .chart-bar.current {
    background: linear-gradient(to top, #22c55e, #4ade80);
  }

  .chart-bar.empty {
    background: #374151;
    opacity: 0.5;
  }

  .bar-count {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.6875rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 700;
  }

  .chart-label {
    margin-top: 0.75rem;
    text-align: center;
  }

  .month-name {
    display: block;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #e5e7eb;
  }

  .year-label {
    display: block;
    font-size: 0.6875rem;
    color: #6b7280;
    margin-top: 0.125rem;
  }

  .chart-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #374151;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: #9ca3af;
  }

  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    background: linear-gradient(to top, #3b82f6, #60a5fa);
  }

  .legend-dot.current {
    background: linear-gradient(to top, #22c55e, #4ade80);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .connect-banner {
      flex-direction: column;
      text-align: center;
    }

    .setup-btn {
      width: 100%;
      text-align: center;
    }

    .summary-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .payouts-table {
      font-size: 0.8125rem;
    }

    .payouts-table th,
    .payouts-table td {
      padding: 0.75rem 0.5rem;
    }

    .chart-container {
      height: 150px;
      gap: 0.5rem;
    }

    .chart-value {
      font-size: 0.625rem;
    }

    .chart-bar {
      max-width: 35px;
    }

    .month-name {
      font-size: 0.6875rem;
    }

    .chart-legend {
      gap: 1rem;
    }

    .legend-item {
      font-size: 0.75rem;
    }
  }
</style>
