---
// /src/pages/artist/releases.astro
// My Releases - View, edit and manage music releases

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getDocument, queryCollection } from '../../lib/firebase-rest';

const partnerId = Astro.cookies.get('partnerId')?.value || '';
let partner = null;
let releases: any[] = [];

if (partnerId) {
  try {
    partner = await getDocument('artists', partnerId);
    if (partner) {
      // Get releases for this artist by email (since uploads use email, not artistId)
      const artistEmail = partner.email;
      if (artistEmail) {
        releases = await queryCollection('releases', {
          filters: [{ field: 'email', op: 'EQUAL', value: artistEmail }]
        });
      }

      // Sort by createdAt descending
      releases.sort((a, b) => {
        const dateA = a.createdAt || a.uploadedAt || '';
        const dateB = b.createdAt || b.uploadedAt || '';
        return String(dateB).localeCompare(String(dateA));
      });
    }
  } catch (e) {
    console.error('Error fetching releases:', e);
  }
}

const isLoggedIn = !!partner;

const formatDate = (dateStr: string) => {
  if (!dateStr) return 'Unknown';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
};

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(price || 0);
};

const formatNumber = (num: number) => new Intl.NumberFormat('en-GB').format(num || 0);

// Musical keys list
const musicalKeys = [
  'C Major', 'C Minor', 'C# Major', 'C# Minor',
  'D Major', 'D Minor', 'D# Major', 'D# Minor',
  'E Major', 'E Minor',
  'F Major', 'F Minor', 'F# Major', 'F# Minor',
  'G Major', 'G Minor', 'G# Major', 'G# Minor',
  'A Major', 'A Minor', 'A# Major', 'A# Minor',
  'B Major', 'B Minor'
];

export const prerender = false;
---

<Layout title="My Releases">
  <Header />
  
  <main class="releases-main">
    <div class="container">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-left">
          <a href="/artist/dashboard" class="back-link">‚Üê Dashboard</a>
          <h1>My Releases</h1>
          <p>View, edit and manage your music catalogue</p>
        </div>
        <div class="header-actions">
          <a href="/artist/release-stats" class="stats-btn">
            üìä Analytics
          </a>
          <a href="/pro/releases/new" class="upload-btn">
            <span>+</span> Upload Release
          </a>
        </div>
      </div>

      {!isLoggedIn ? (
        <div class="login-prompt">
          <p>Please log in to view your releases.</p>
          <a href="/login" class="login-btn">Sign In</a>
        </div>
      ) : releases.length === 0 ? (
        <div class="empty-state">
          <div class="empty-icon">üíø</div>
          <h2>No releases yet</h2>
          <p>Upload your first release to get started!</p>
          <a href="/pro/releases/new" class="upload-btn">Upload Release</a>
        </div>
      ) : (
        <>
        <!-- Global Sale Controls -->
        <div class="global-sale-controls">
          <div class="global-sale-header">
            <span class="sale-icon">üè∑Ô∏è</span>
            <h3>Global Sale</h3>
            <label class="toggle-switch">
              <input type="checkbox" id="globalSaleToggle" />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="global-sale-options" id="globalSaleOptions">
            <div class="sale-field">
              <label>Discount</label>
              <select id="globalDiscountSelect" class="sale-select">
                <option value="0">No discount</option>
                <option value="10">10% off</option>
                <option value="20">20% off</option>
                <option value="25">25% off</option>
                <option value="30">30% off</option>
                <option value="40">40% off</option>
                <option value="50">50% off</option>
                <option value="60">60% off</option>
                <option value="75">75% off</option>
              </select>
            </div>
            <button class="apply-global-sale-btn" id="applyGlobalSale">Apply to All Releases</button>
          </div>
        </div>

        <div class="releases-list">
          {releases.map((release) => (
            <div class="release-card" data-release-id={release.id}>
              <!-- Release Header -->
              <div class="release-header">
                <div class="artwork-container">
                  <img
                    src={release.coverArtUrl || release.artworkUrl || release.artwork_url || '/place-holder.webp'}
                    alt={release.releaseName || release.title}
                    class="release-artwork"
                  />
                  {release.saleDiscount && release.saleDiscount > 0 && (
                    <div class="sale-badge">{release.saleDiscount}% OFF</div>
                  )}
                </div>
                <div class="release-info">
                  <h2>{release.releaseName || release.title}</h2>
                  <p class="release-artist">{release.artistName || release.artist}</p>
                  <div class="release-meta">
                    <span class="meta-item">
                      <span class="meta-icon">üìÖ</span>
                      {formatDate(release.releaseDate || release.createdAt || release.uploadedAt)}
                    </span>
                    <span class="meta-item">
                      <span class="meta-icon">üéµ</span>
                      {release.genre || 'Drum and Bass'}
                    </span>
                    <span class={`status-badge ${release.status || 'pending'}`}>
                      {release.status === 'live' ? 'üü¢ Live' : 'üü° Pending'}
                    </span>
                  </div>
                </div>
                <div class="release-actions">
                  <a href={`/item/${release.id}`} class="action-btn view" target="_blank">
                    View
                  </a>
                  <button class="action-btn delete" data-release-id={release.id} data-release-name={release.releaseName || release.title}>
                    Delete
                  </button>
                </div>
              </div>

              <!-- Stats Row -->
              <div class="stats-row">
                <div class="stat">
                  <span class="stat-value">{formatNumber(release.stats?.plays || release.plays || 0)}</span>
                  <span class="stat-label">Plays</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{formatNumber(release.stats?.downloads || release.sales || 0)}</span>
                  <span class="stat-label">Sales</span>
                </div>
                <div class="stat">
                  <span class="stat-value green">{formatPrice(release.pricePerSale || release.price || 0)}</span>
                  <span class="stat-label">Price</span>
                </div>
                <div class="stat">
                  <span class="stat-value green">{(release.ratings?.average || release.overallRating?.average || 0).toFixed(1)}</span>
                  <span class="stat-label">Rating ({release.ratings?.count || release.overallRating?.count || 0})</span>
                </div>
                <div class="stat">
                  <span class="stat-value">{release.comments?.length || 0}</span>
                  <span class="stat-label">Comments</span>
                </div>
              </div>

              <!-- Editable Fields -->
              <div class="edit-section">
                <div class="section-header">
                  <h3>Release Details</h3>
                  <button class="edit-toggle-btn" data-release-id={release.id}>
                    <span class="edit-icon">‚úèÔ∏è</span> Edit
                  </button>
                </div>
                
                <!-- View Mode -->
                <div class="details-view" data-release-id={release.id}>
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="detail-label">Tracks</span>
                      <span class="detail-value">{release.tracks?.length || 0} tracks</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Track Price</span>
                      <span class="detail-value">{formatPrice(release.trackPrice || 0)}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Release Price</span>
                      <span class="detail-value">{formatPrice(release.pricePerSale || release.price || 0)}</span>
                    </div>
                  </div>
                  <div class="description-view">
                    <span class="detail-label">Description</span>
                    <p class="detail-value">{release.releaseDescription || release.description || 'No description'}</p>
                  </div>
                </div>
                
                <!-- Edit Mode -->
                <div class="details-edit hidden" data-release-id={release.id}>
                  <!-- Pricing Section -->
                  <div class="edit-section-title">Pricing</div>
                  <div class="edit-grid">
                    <div class="edit-field">
                      <label>Track Price (¬£)</label>
                      <input
                        type="number"
                        class="edit-input track-price-input"
                        data-release-id={release.id}
                        value={release.trackPrice ? Number(release.trackPrice).toFixed(2) : ''}
                        placeholder="e.g. 2.50"
                        min="0"
                        step="0.01"
                      />
                    </div>
                    <div class="edit-field">
                      <label>Release Price (¬£)</label>
                      <input
                        type="number"
                        class="edit-input price-input"
                        data-release-id={release.id}
                        value={(release.pricePerSale || release.price) ? Number(release.pricePerSale || release.price).toFixed(2) : ''}
                        placeholder="e.g. 8.00"
                        min="0"
                        step="0.01"
                      />
                    </div>
                    <div class="edit-field">
                      <label>Sale Discount</label>
                      <select class="edit-input sale-discount-input" data-release-id={release.id}>
                        <option value="0" selected={!release.saleDiscount || release.saleDiscount === 0}>No discount</option>
                        <option value="10" selected={release.saleDiscount === 10}>10% off</option>
                        <option value="20" selected={release.saleDiscount === 20}>20% off</option>
                        <option value="25" selected={release.saleDiscount === 25}>25% off</option>
                        <option value="30" selected={release.saleDiscount === 30}>30% off</option>
                        <option value="40" selected={release.saleDiscount === 40}>40% off</option>
                        <option value="50" selected={release.saleDiscount === 50}>50% off</option>
                        <option value="60" selected={release.saleDiscount === 60}>60% off</option>
                        <option value="75" selected={release.saleDiscount === 75}>75% off</option>
                      </select>
                    </div>
                  </div>

                  <!-- Music Details Section -->
                  <div class="edit-section-title">Music Details</div>
                  <div class="edit-grid">
                    <div class="edit-field">
                      <label>Genre</label>
                      <input
                        type="text"
                        class="edit-input genre-input"
                        data-release-id={release.id}
                        value={release.genre || 'Drum and Bass'}
                        placeholder="e.g. Drum and Bass"
                      />
                    </div>
                  </div>

                  <!-- Track BPM & Key Section -->
                  <div class="edit-section-title">Track Details (BPM & Key)</div>
                  <div class="track-details-list" data-release-id={release.id}>
                    {(release.tracks || []).map((track: any, index: number) => (
                      <div class="track-detail-row" data-track-index={index}>
                        <span class="track-number">{index + 1}.</span>
                        <span class="track-name" title={track.trackName || `Track ${index + 1}`}>
                          {(track.trackName || `Track ${index + 1}`).length > 25
                            ? (track.trackName || `Track ${index + 1}`).substring(0, 22) + '...'
                            : (track.trackName || `Track ${index + 1}`)}
                        </span>
                        <input
                          type="number"
                          class="track-bpm-input"
                          data-track-index={index}
                          value={track.bpm || ''}
                          placeholder="BPM"
                          min="60"
                          max="300"
                        />
                        <select class="track-key-input" data-track-index={index}>
                          <option value="">Key...</option>
                          {musicalKeys.map(key => (
                            <option value={key} selected={track.key === key}>{key}</option>
                          ))}
                        </select>
                      </div>
                    ))}
                    {(!release.tracks || release.tracks.length === 0) && (
                      <p class="no-tracks-msg">No tracks found for this release</p>
                    )}
                  </div>

                  <!-- Recording Details Section -->
                  <div class="edit-section-title">Recording Details</div>
                  <div class="edit-grid">
                    <div class="edit-field">
                      <label>Original Release Date</label>
                      <input
                        type="date"
                        class="edit-input original-date-input"
                        data-release-id={release.id}
                        value={release.originalReleaseDate ? release.originalReleaseDate.split('T')[0] : ''}
                      />
                      <span class="field-hint">If previously released elsewhere</span>
                    </div>
                    <div class="edit-field">
                      <label>Recorded Location</label>
                      <input
                        type="text"
                        class="edit-input recording-location-input"
                        data-release-id={release.id}
                        value={release.recordingLocation || ''}
                        placeholder="e.g. London, UK"
                      />
                    </div>
                    <div class="edit-field">
                      <label>Recorded Year</label>
                      <input
                        type="number"
                        class="edit-input recording-year-input"
                        data-release-id={release.id}
                        value={release.recordingYear || ''}
                        placeholder="e.g. 2024"
                        min="1980"
                        max="2030"
                      />
                    </div>
                  </div>

                  <!-- Credits Section -->
                  <div class="edit-section-title">Credits</div>
                  <div class="edit-grid">
                    <div class="edit-field">
                      <label>Mastered By</label>
                      <input
                        type="text"
                        class="edit-input mastered-by-input"
                        data-release-id={release.id}
                        value={release.masteredBy || ''}
                        placeholder="e.g. Mastering Studio"
                      />
                    </div>
                    <div class="edit-field">
                      <label>Producer</label>
                      <input
                        type="text"
                        class="edit-input producer-input"
                        data-release-id={release.id}
                        value={release.producer || ''}
                        placeholder="e.g. Producer name"
                      />
                    </div>
                    <div class="edit-field">
                      <label>Label</label>
                      <input
                        type="text"
                        class="edit-input label-input"
                        data-release-id={release.id}
                        value={release.label || release.labelCode || ''}
                        placeholder="e.g. Fresh Wax"
                      />
                    </div>
                  </div>

                  <!-- Description Section -->
                  <div class="edit-section-title">Description</div>
                  <div class="edit-field full-width">
                    <textarea
                      class="edit-input description-input"
                      data-release-id={release.id}
                      placeholder="Describe your release..."
                      maxlength="500"
                    >{release.releaseDescription || release.description || ''}</textarea>
                    <span class="char-count"><span class="current">{(release.releaseDescription || release.description || '').length}</span>/500</span>
                  </div>

                  <div class="edit-actions">
                    <button class="cancel-edit-btn" data-release-id={release.id}>Cancel</button>
                    <button class="save-edit-btn" data-release-id={release.id}>Save Changes</button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
        </>
      )}
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal-overlay" id="deleteModal">
      <div class="delete-modal">
        <div class="delete-modal-icon">‚ö†Ô∏è</div>
        <h3>Delete Release?</h3>
        <p>Are you sure you want to delete <strong id="deleteReleaseName"></strong>?</p>
        <p class="delete-warning">This action cannot be undone. All tracks and data will be permanently removed.</p>
        <div class="delete-modal-actions">
          <button class="modal-btn cancel" id="cancelDelete">Cancel</button>
          <button class="modal-btn confirm" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .releases-main {
    min-height: calc(100vh - 200px);
    background: linear-gradient(to bottom, #000000, #111827);
    padding: 2rem 0;
  }
  
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }
  
  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .header-left h1 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 2.5rem;
    color: #fff;
    margin: 0.5rem 0 0.25rem;
  }
  
  .header-left p {
    color: #9ca3af;
    font-size: 1.0625rem;
  }
  
  .back-link {
    color: #9ca3af;
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .back-link:hover {
    color: #fff;
  }
  
  .header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }
  
  .stats-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(to bottom, #1f2937, #111827);
    color: #fff;
    padding: 0.875rem 1.25rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
    border: 2px solid #374151;
  }
  
  .stats-btn:hover {
    background: linear-gradient(to bottom, #374151, #1f2937);
    border-color: #4b5563;
  }
  
  .upload-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #000;
    color: #fff;
    padding: 0.875rem 1.5rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
  }
  
  .upload-btn:hover {
    background: #222;
    transform: translateY(-2px);
  }
  
  .upload-btn span {
    font-size: 1.25rem;
    font-weight: 300;
  }
  
  /* Login/Empty States */
  .login-prompt, .empty-state {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 4rem 2rem;
    text-align: center;
  }
  
  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }
  
  .empty-state h2 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }
  
  .empty-state p {
    color: #9ca3af;
    margin-bottom: 1.5rem;
    font-size: 1.0625rem;
  }
  
  .login-btn {
    display: inline-block;
    background: #000;
    color: #fff;
    padding: 0.875rem 2rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
  }
  
  /* Global Sale Controls */
  .global-sale-controls {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
  }

  .global-sale-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .global-sale-header .sale-icon {
    font-size: 1.5rem;
  }

  .global-sale-header h3 {
    flex: 1;
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    color: #fff;
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #374151;
    transition: 0.3s;
    border-radius: 26px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }

  .toggle-switch input:checked + .toggle-slider {
    background-color: #dc2626;
  }

  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(24px);
  }

  .global-sale-options {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #374151;
    align-items: center;
    gap: 1rem;
  }

  .global-sale-options.active {
    display: flex;
  }

  .sale-field {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sale-field label {
    font-size: 0.9375rem;
    color: #9ca3af;
  }

  .sale-select {
    padding: 0.5rem 1rem;
    border: 2px solid #374151;
    border-radius: 8px;
    background: #1f2937;
    color: #fff;
    font-size: 0.9375rem;
    cursor: pointer;
  }

  .sale-select:focus {
    outline: none;
    border-color: #dc2626;
  }

  .apply-global-sale-btn {
    padding: 0.625rem 1.25rem;
    background: #dc2626;
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .apply-global-sale-btn:hover {
    background: #b91c1c;
  }

  .apply-global-sale-btn:disabled {
    background: #6b7280;
    cursor: not-allowed;
  }

  /* Releases List */
  .releases-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .release-card {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.2s;
  }

  .release-card:hover {
    border-color: #4b5563;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  /* Release Header */
  .release-header {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.5rem;
    border-bottom: 2px solid #374151;
  }

  .artwork-container {
    position: relative;
    flex-shrink: 0;
  }

  .release-artwork {
    width: 100px;
    height: 100px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #4b5563;
  }

  .sale-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc2626;
    color: #fff;
    font-size: 0.6875rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
    animation: pulse-badge 2s ease-in-out infinite;
  }

  @keyframes pulse-badge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  .release-info {
    flex: 1;
    min-width: 0;
  }
  
  .release-info h2 {
    font-size: 1.375rem;
    font-weight: 700;
    margin: 0 0 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #fff;
  }
  
  .release-artist {
    font-size: 1.0625rem;
    color: #9ca3af;
    margin: 0 0 0.5rem;
  }
  
  .release-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.9375rem;
    color: #9ca3af;
  }
  
  .meta-icon {
    font-size: 1rem;
  }
  
  .status-badge {
    font-size: 0.8125rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
  }
  
  .status-badge.live {
    background: rgba(22, 163, 74, 0.2);
    color: #22c55e;
    border: 1px solid #22c55e;
  }
  
  .status-badge.pending {
    background: rgba(217, 119, 6, 0.2);
    color: #fbbf24;
    border: 1px solid #fbbf24;
  }
  
  .release-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .action-btn {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .action-btn.view {
    background: linear-gradient(to bottom, #374151, #1f2937);
    color: #fff;
    border: 2px solid #4b5563;
  }
  
  .action-btn.view:hover {
    background: linear-gradient(to bottom, #4b5563, #374151);
    border-color: #6b7280;
  }

  .action-btn.delete {
    background: linear-gradient(to bottom, #7f1d1d, #450a0a);
    color: #fca5a5;
    border: 2px solid #991b1b;
  }

  .action-btn.delete:hover {
    background: linear-gradient(to bottom, #991b1b, #7f1d1d);
    border-color: #dc2626;
    color: #fff;
  }

  /* Delete Modal */
  .delete-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .delete-modal-overlay.active {
    display: flex;
  }

  .delete-modal {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
  }

  .delete-modal-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .delete-modal h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.75rem;
  }

  .delete-modal p {
    color: #9ca3af;
    margin: 0 0 0.5rem;
    font-size: 1rem;
  }

  .delete-modal strong {
    color: #fff;
  }

  .delete-warning {
    color: #fca5a5 !important;
    font-size: 0.875rem !important;
    margin-top: 1rem !important;
  }

  .delete-modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .modal-btn {
    flex: 1;
    padding: 0.875rem 1.5rem;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }

  .modal-btn.cancel {
    background: linear-gradient(to bottom, #374151, #1f2937);
    color: #fff;
    border: 2px solid #4b5563;
  }

  .modal-btn.cancel:hover {
    background: linear-gradient(to bottom, #4b5563, #374151);
    border-color: #6b7280;
  }

  .modal-btn.confirm {
    background: #dc2626;
    color: #fff;
  }

  .modal-btn.confirm:hover {
    background: #b91c1c;
  }

  .modal-btn.confirm:disabled {
    background: #6b7280;
    cursor: not-allowed;
  }
  
  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(to bottom, #374151, #1f2937);
    border-bottom: 2px solid #374151;
  }
  
  .stat {
    text-align: center;
  }
  
  .stat-value {
    display: block;
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 1.5rem;
    color: #fff;
    line-height: 1;
  }
  
  .stat-value.green { color: #22c55e; }
  
  .stat-label {
    display: block;
    font-size: 0.75rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-top: 0.25rem;
  }
  
  /* Edit Section */
  .edit-section {
    padding: 1.5rem;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .section-header h3 {
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #9ca3af;
    margin: 0;
  }
  
  .edit-toggle-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    padding: 0.5rem 0.875rem;
    border-radius: 8px;
    transition: all 0.2s;
  }
  
  .edit-toggle-btn:hover {
    background: #374151;
    color: #fff;
  }
  
  /* View Mode */
  .details-view.hidden {
    display: none;
  }
  
  .details-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .detail-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .detail-value {
    font-size: 1.0625rem;
    color: #e5e7eb;
  }
  
  .description-view {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .description-view p {
    font-size: 1rem;
    color: #e5e7eb;
    line-height: 1.5;
    margin: 0;
  }
  
  /* Edit Mode */
  .details-edit.hidden {
    display: none;
  }
  
  .edit-section-title {
    font-size: 0.8125rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #9ca3af;
    margin: 1.25rem 0 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #374151;
  }

  .edit-section-title:first-child {
    margin-top: 0;
  }

  .edit-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .edit-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .field-hint {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }
  
  .edit-field.full-width {
    grid-column: 1 / -1;
  }
  
  .edit-field label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #e5e7eb;
  }
  
  .edit-input {
    padding: 0.75rem 1rem;
    border: 2px solid #374151;
    border-radius: 10px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.2s;
    background: #fff;
    color: #111827;
  }
  
  .edit-input:focus {
    outline: none;
    border-color: #dc2626;
  }

  /* Track Details List */
  .track-details-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }

  .track-detail-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #1f2937;
    border-radius: 8px;
    border: 1px solid #374151;
  }

  .track-detail-row .track-number {
    color: #9ca3af;
    font-size: 0.875rem;
    font-weight: 600;
    min-width: 1.5rem;
  }

  .track-detail-row .track-name {
    flex: 1;
    color: #e5e7eb;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }

  .track-detail-row .track-bpm-input {
    width: 70px;
    padding: 0.375rem 0.5rem;
    border: 1px solid #4b5563;
    border-radius: 6px;
    font-size: 0.8125rem;
    background: #fff;
    color: #111827;
    text-align: center;
  }

  .track-detail-row .track-key-input {
    width: 100px;
    padding: 0.375rem 0.5rem;
    border: 1px solid #4b5563;
    border-radius: 6px;
    font-size: 0.8125rem;
    background: #fff;
    color: #111827;
  }

  .track-detail-row .track-bpm-input:focus,
  .track-detail-row .track-key-input:focus {
    outline: none;
    border-color: #dc2626;
  }

  .no-tracks-msg {
    color: #6b7280;
    font-size: 0.875rem;
    text-align: center;
    padding: 1rem;
  }

  textarea.edit-input {
    min-height: 100px;
    resize: vertical;
  }
  
  .char-count {
    font-size: 0.8125rem;
    color: #9ca3af;
    text-align: right;
    margin-top: 0.25rem;
  }
  
  .edit-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .cancel-edit-btn {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .cancel-edit-btn:hover {
    background: linear-gradient(to bottom, #374151, #1f2937);
    color: #fff;
    border-color: #4b5563;
  }
  
  .save-edit-btn {
    padding: 0.75rem 1.5rem;
    background: #dc2626;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .save-edit-btn:hover {
    background: #b91c1c;
  }
  
  .save-edit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }
    
    .header-actions {
      flex-direction: column;
    }
    
    .stats-btn, .upload-btn {
      text-align: center;
      justify-content: center;
    }
    
    .release-header {
      flex-direction: column;
      text-align: center;
    }
    
    .release-artwork {
      width: 120px;
      height: 120px;
    }
    
    .release-meta {
      justify-content: center;
    }
    
    .release-actions {
      width: 100%;
    }
    
    .action-btn {
      flex: 1;
      text-align: center;
    }
    
    .stats-row {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .stats-row .stat:nth-child(4),
    .stats-row .stat:nth-child(5) {
      grid-column: span 1;
    }
    
    .details-grid, .edit-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 480px) {
    .stats-row {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-value {
      font-size: 1.25rem;
    }
  }
</style>

<script type="module">
  // Initialize Firebase for auth
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let currentIdToken = null;
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentIdToken = await user.getIdToken();
    }
  });

  // Toggle edit mode
  document.querySelectorAll('.edit-toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const releaseId = btn.dataset.releaseId;
      const viewEl = document.querySelector(`.details-view[data-release-id="${releaseId}"]`);
      const editEl = document.querySelector(`.details-edit[data-release-id="${releaseId}"]`);
      
      viewEl?.classList.add('hidden');
      editEl?.classList.remove('hidden');
      btn.style.display = 'none';
    });
  });
  
  // Cancel edit
  document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const releaseId = btn.dataset.releaseId;
      const viewEl = document.querySelector(`.details-view[data-release-id="${releaseId}"]`);
      const editEl = document.querySelector(`.details-edit[data-release-id="${releaseId}"]`);
      const toggleBtn = document.querySelector(`.edit-toggle-btn[data-release-id="${releaseId}"]`);
      
      editEl?.classList.add('hidden');
      viewEl?.classList.remove('hidden');
      if (toggleBtn) toggleBtn.style.display = '';
    });
  });
  
  // Character count for description
  document.querySelectorAll('.description-input').forEach(textarea => {
    const releaseId = textarea.dataset.releaseId;
    const charCount = textarea.closest('.edit-field')?.querySelector('.char-count .current');
    
    textarea.addEventListener('input', () => {
      if (charCount) {
        charCount.textContent = textarea.value.length;
      }
    });
  });
  
  // Save changes
  document.querySelectorAll('.save-edit-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const releaseId = btn.dataset.releaseId;
      const card = document.querySelector(`.release-card[data-release-id="${releaseId}"]`);

      // Get all input values
      const getValue = (selector) => card.querySelector(`${selector}[data-release-id="${releaseId}"]`)?.value || null;

      // Collect per-track BPM and Key
      const trackDetailsList = card.querySelector(`.track-details-list[data-release-id="${releaseId}"]`);
      const trackUpdates = [];
      if (trackDetailsList) {
        const trackRows = trackDetailsList.querySelectorAll('.track-detail-row');
        trackRows.forEach((row) => {
          const index = parseInt(row.dataset.trackIndex);
          const bpmInput = row.querySelector('.track-bpm-input');
          const keyInput = row.querySelector('.track-key-input');
          trackUpdates.push({
            index,
            bpm: bpmInput?.value ? parseInt(bpmInput.value) : null,
            key: keyInput?.value || null
          });
        });
      }

      const data = {
        id: releaseId,
        // Pricing
        trackPrice: getValue('.track-price-input') ? parseFloat(getValue('.track-price-input')) : null,
        pricePerSale: getValue('.price-input') ? parseFloat(getValue('.price-input')) : null,
        saleDiscount: parseInt(getValue('.sale-discount-input')) || 0,
        // Music details
        genre: getValue('.genre-input') || null,
        trackUpdates: trackUpdates.length > 0 ? trackUpdates : null,
        // Recording details
        originalReleaseDate: getValue('.original-date-input') || null,
        recordingLocation: getValue('.recording-location-input') || null,
        recordingYear: getValue('.recording-year-input') ? parseInt(getValue('.recording-year-input')) : null,
        // Credits
        masteredBy: getValue('.mastered-by-input') || null,
        producer: getValue('.producer-input') || null,
        label: getValue('.label-input') || null,
        // Description
        releaseDescription: getValue('.description-input')?.trim() || null
      };

      // Add idToken for authenticated writes
      if (currentIdToken) {
        data.idToken = currentIdToken;
      }

      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const response = await fetch('/api/update-release', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          // Update view values
          const viewEl = card.querySelector(`.details-view[data-release-id="${releaseId}"]`);
          const detailValues = viewEl?.querySelectorAll('.detail-value');
          if (detailValues) {
            // detailValues[0] is track count - don't update
            detailValues[1].textContent = data.trackPrice ? `¬£${data.trackPrice.toFixed(2)}` : '¬£0.00';
            detailValues[2].textContent = data.pricePerSale ? `¬£${data.pricePerSale.toFixed(2)}` : '¬£0.00';
          }

          const descView = viewEl?.querySelector('.description-view p');
          if (descView) {
            descView.textContent = data.releaseDescription || 'No description';
          }

          // Update stats row (Plays, Sales, Price, Rating)
          const statValues = card.querySelectorAll('.stats-row .stat-value');
          if (statValues[2]) statValues[2].textContent = data.pricePerSale ? `¬£${data.pricePerSale.toFixed(2)}` : '¬£0.00';

          // Update sale badge
          updateSaleBadge(card, data.saleDiscount);

          // Close edit mode
          const editEl = card.querySelector(`.details-edit[data-release-id="${releaseId}"]`);
          const toggleBtn = card.querySelector(`.edit-toggle-btn[data-release-id="${releaseId}"]`);

          editEl?.classList.add('hidden');
          viewEl?.classList.remove('hidden');
          if (toggleBtn) toggleBtn.style.display = '';
        } else {
          alert(result.error || 'Failed to save changes');
        }
      } catch (error) {
        console.error('Error saving:', error);
        alert('Failed to save changes. Please try again.');
      }

      btn.textContent = 'Save Changes';
      btn.disabled = false;
    });
  });

  // Helper function to update sale badge
  function updateSaleBadge(card, discount) {
    const artworkContainer = card.querySelector('.artwork-container');
    let badge = artworkContainer?.querySelector('.sale-badge');

    if (discount > 0) {
      if (!badge) {
        badge = document.createElement('div');
        badge.className = 'sale-badge';
        artworkContainer?.appendChild(badge);
      }
      badge.textContent = `${discount}% OFF`;
    } else if (badge) {
      badge.remove();
    }
  }

  // Global sale toggle
  const globalSaleToggle = document.getElementById('globalSaleToggle');
  const globalSaleOptions = document.getElementById('globalSaleOptions');
  const globalDiscountSelect = document.getElementById('globalDiscountSelect');
  const applyGlobalSaleBtn = document.getElementById('applyGlobalSale');

  globalSaleToggle?.addEventListener('change', () => {
    if (globalSaleToggle.checked) {
      globalSaleOptions?.classList.add('active');
    } else {
      globalSaleOptions?.classList.remove('active');
    }
  });

  // Apply global sale to all releases
  applyGlobalSaleBtn?.addEventListener('click', async () => {
    const discount = parseInt(globalDiscountSelect?.value) || 0;
    const releaseCards = document.querySelectorAll('.release-card');

    if (releaseCards.length === 0) return;

    applyGlobalSaleBtn.textContent = 'Applying...';
    applyGlobalSaleBtn.disabled = true;

    let successCount = 0;
    let errorCount = 0;

    for (const card of releaseCards) {
      const releaseId = card.dataset.releaseId;

      try {
        const response = await fetch('/api/update-release', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: releaseId,
            saleDiscount: discount,
            idToken: currentIdToken
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update the sale discount select in the edit form
          const saleSelect = card.querySelector('.sale-discount-input');
          if (saleSelect) saleSelect.value = discount;

          // Update the sale badge
          updateSaleBadge(card, discount);
          successCount++;
        } else {
          errorCount++;
        }
      } catch (error) {
        console.error('Error applying sale:', error);
        errorCount++;
      }
    }

    applyGlobalSaleBtn.textContent = 'Apply to All Releases';
    applyGlobalSaleBtn.disabled = false;

    if (errorCount === 0) {
      alert(`Sale applied to ${successCount} release${successCount !== 1 ? 's' : ''} successfully!`);
    } else {
      alert(`Applied to ${successCount} releases. ${errorCount} failed.`);
    }
  });

  // Delete release functionality
  let deleteReleaseId = null;
  const deleteModal = document.getElementById('deleteModal');
  const deleteReleaseName = document.getElementById('deleteReleaseName');
  const cancelDeleteBtn = document.getElementById('cancelDelete');
  const confirmDeleteBtn = document.getElementById('confirmDelete');

  // Open delete modal
  document.querySelectorAll('.action-btn.delete').forEach(btn => {
    btn.addEventListener('click', () => {
      deleteReleaseId = btn.dataset.releaseId;
      const releaseName = btn.dataset.releaseName || 'this release';
      deleteReleaseName.textContent = releaseName;
      deleteModal.classList.add('active');
    });
  });

  // Close modal on cancel
  cancelDeleteBtn?.addEventListener('click', () => {
    deleteModal.classList.remove('active');
    deleteReleaseId = null;
  });

  // Close modal on overlay click
  deleteModal?.addEventListener('click', (e) => {
    if (e.target === deleteModal) {
      deleteModal.classList.remove('active');
      deleteReleaseId = null;
    }
  });

  // Confirm delete
  confirmDeleteBtn?.addEventListener('click', async () => {
    if (!deleteReleaseId) return;

    confirmDeleteBtn.textContent = 'Deleting...';
    confirmDeleteBtn.disabled = true;

    try {
      const response = await fetch('/api/delete-release', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          releaseId: deleteReleaseId,
          idToken: currentIdToken
        })
      });

      const result = await response.json();

      if (result.success) {
        // Remove the release card from the page
        const card = document.querySelector(`.release-card[data-release-id="${deleteReleaseId}"]`);
        if (card) {
          card.style.transition = 'opacity 0.3s, transform 0.3s';
          card.style.opacity = '0';
          card.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            card.remove();
            // Check if no releases left
            const remainingCards = document.querySelectorAll('.release-card');
            if (remainingCards.length === 0) {
              location.reload();
            }
          }, 300);
        }
        deleteModal.classList.remove('active');
      } else {
        alert(result.error || 'Failed to delete release');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Failed to delete release. Please try again.');
    }

    confirmDeleteBtn.textContent = 'Delete';
    confirmDeleteBtn.disabled = false;
    deleteReleaseId = null;
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && deleteModal.classList.contains('active')) {
      deleteModal.classList.remove('active');
      deleteReleaseId = null;
    }
  });
</script>
