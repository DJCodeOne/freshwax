---
// /src/pages/artist/dashboard.astro
// Fresh Wax Partner Dashboard - Uses Layout, Header, Footer
// DJ Mixes section is always accessible - no approval needed
// Releases and Merch sections require approval

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getDocument, queryCollection } from '../../lib/firebase-rest';
import { getAdminUids } from '../../lib/admin';

// Check for partnerId cookie first, then fall back to userId or customerId
let partnerId = Astro.cookies.get('partnerId')?.value || '';
if (!partnerId) {
  // Fallback to userId cookie
  partnerId = Astro.cookies.get('userId')?.value || '';
}
if (!partnerId) {
  // Fallback to customerId cookie
  partnerId = Astro.cookies.get('customerId')?.value || '';
}

// Debug logging
console.log('[Partner Dashboard] partnerId:', partnerId || 'NOT SET');
console.log('[Partner Dashboard] Cookies - partnerId:', Astro.cookies.get('partnerId')?.value || 'none',
            'userId:', Astro.cookies.get('userId')?.value || 'none',
            'customerId:', Astro.cookies.get('customerId')?.value || 'none');

// Admin UIDs from environment
const isAdminUser = getAdminUids().includes(partnerId);

let partner = null;
let stats = {
  releases: 0,
  liveReleases: 0,
  pendingReleases: 0,
  merchProducts: 0,
  merchSold: 0,
  totalOrders: 0,
  vinylListings: 0,
  vinylSold: 0,
  vinylOrders: 0,
  // Earnings stats
  totalEarnings: 0,
  pendingBalance: 0,
  stripeConnected: false
};

if (partnerId) {
  try {
    // Try artists collection first
    const partnerDoc = await getDocument('artists', partnerId);
    console.log('[Partner Dashboard] artists doc exists:', !!partnerDoc);

    if (partnerDoc) {
      partner = { id: partnerId, ...partnerDoc };
      console.log('[Partner Dashboard] Found in artists:', partner.artistName);

      // Fetch earnings stats
      stats.totalEarnings = partnerDoc.totalEarnings || 0;
      stats.pendingBalance = partnerDoc.pendingBalance || 0;
      stats.stripeConnected = !!partnerDoc.stripeConnectId && partnerDoc.stripeConnectStatus === 'active';
    } else {
      // Fallback: check users collection for partner info
      const userData = await getDocument('users', partnerId);
      console.log('[Partner Dashboard] users doc exists:', !!userData);

      if (userData) {
        console.log('[Partner Dashboard] User roles:', JSON.stringify(userData?.roles));

        // Check if they have partner roles
        if (userData.roles?.artist || userData.roles?.dj || userData.roles?.merchSupplier || userData.roles?.vinylSeller) {
          partner = {
            id: partnerId,
            artistName: userData.partnerInfo?.displayName || userData.displayName || userData.fullName || userData.name || 'Partner',
            email: userData.email,
            isArtist: userData.roles?.artist || false,
            isDJ: userData.roles?.dj || false,
            isMerchSupplier: userData.roles?.merchSupplier || userData.roles?.merchSeller || false,
            isVinylSeller: userData.roles?.vinylSeller || false,
            approved: userData.partnerInfo?.approved || userData.approved || false,
            avatarUrl: userData.avatarUrl || null
          };
          console.log('[Partner Dashboard] Created partner from users:', partner.artistName, 'approved:', partner.approved);
        }
      }
    }

    // Admin fallback - if document lookup failed but user is admin, create default partner
    if (!partner && isAdminUser) {
      console.log('[Partner Dashboard] Admin fallback - creating default partner for:', partnerId);
      partner = {
        id: partnerId,
        artistName: 'Admin',
        email: 'admin@freshwax.co.uk',
        isArtist: true,
        isDJ: true,
        isMerchSupplier: true,
        isVinylSeller: true,
        approved: true,
        avatarUrl: null
      };
    }

    if (partner) {
      // Fetch displayName and avatar from customers collection (user's preferred display name)
      try {
        const customerData = await getDocument('customers', partnerId);
        if (customerData) {
          // Use customer's displayName if available (this is what they set in their profile)
          if (customerData?.displayName) {
            partner.displayName = customerData.displayName;
          }
          // Also get avatar if not already set
          if (!partner.avatarUrl && !partner.imageUrl && !partner.photoURL) {
            partner.avatarUrl = customerData?.avatarUrl || customerData?.photoURL || null;
          }
        }
      } catch (e) {
        // Ignore errors fetching customer data
      }

      const approved = partner.approved === true;
      const effectiveIsArtist = partner.isArtist !== false;
      const effectiveIsDJ = !!partner.isDJ || effectiveIsArtist;
      const effectiveIsMerchSupplier = !!partner.isMerchSupplier;
      const effectiveIsVinylSeller = !!partner.isVinylSeller;

      // Fetch artist/label stats (only if approved)
      if (effectiveIsArtist && approved) {
        // Query releases by multiple strategies for reliability
        const artistEmail = partner.email;
        const releaseMap = new Map<string, any>();

        // Strategy 1: Query by artistId (most reliable)
        const byArtistId = await queryCollection('releases', {
          filters: [{ field: 'artistId', op: 'EQUAL', value: partnerId }]
        });
        byArtistId.forEach(r => releaseMap.set(r.id, r));

        // Strategy 2: Query by userId (backup)
        if (releaseMap.size === 0) {
          const byUserId = await queryCollection('releases', {
            filters: [{ field: 'userId', op: 'EQUAL', value: partnerId }]
          });
          byUserId.forEach(r => releaseMap.set(r.id, r));
        }

        // Strategy 3: Query by email (legacy uploads)
        if (artistEmail && releaseMap.size === 0) {
          const byEmail = await queryCollection('releases', {
            filters: [{ field: 'email', op: 'EQUAL', value: artistEmail }]
          });
          byEmail.forEach(r => releaseMap.set(r.id, r));
        }

        const releases = Array.from(releaseMap.values());
        stats.releases = releases.length;
        stats.liveReleases = releases.filter(r => r.status === 'live').length;
        stats.pendingReleases = releases.filter(r => r.status === 'pending').length;
      }

      // Fetch merch stats (only if approved)
      if (effectiveIsMerchSupplier && approved) {
        // Try multiple strategies to find products linked to this supplier
        let merchProducts: any[] = [];

        // Strategy 1: Query by supplierId
        merchProducts = await queryCollection('merch', {
          filters: [{ field: 'supplierId', op: 'EQUAL', value: partnerId }]
        });

        // Strategy 2: If no results, try by supplier name
        if (merchProducts.length === 0 && partner.artistName) {
          merchProducts = await queryCollection('merch', {
            filters: [{ field: 'supplierName', op: 'EQUAL', value: partner.artistName }]
          });
        }

        // Strategy 3: Check merch-suppliers collection for linked products
        if (merchProducts.length === 0) {
          try {
            const supplierData = await getDocument('merch-suppliers', partnerId);
            if (supplierData?.products && supplierData.products.length > 0) {
              const productPromises = supplierData.products.slice(0, 50).map((pid: string) =>
                getDocument('merch', pid)
              );
              const productDocs = await Promise.all(productPromises);
              merchProducts = productDocs.filter((d): d is NonNullable<typeof d> => d !== null);
            }
          } catch (e) {
            // Ignore errors from merch-suppliers lookup
          }
        }

        stats.merchProducts = merchProducts.length;

        // Get product IDs for order matching
        const productIds = merchProducts.map(p => p.id);

        // Calculate total stock from products
        const totalProductStock = merchProducts.reduce((sum, p) => {
          return sum + (p.totalStock || p.stock || 0);
        }, 0);

        // Fetch orders containing this supplier's products
        if (productIds.length > 0) {
          // Query orders (REST API doesn't support != so we'll filter client-side)
          const orders = await queryCollection('orders', {
            orderBy: { field: 'createdAt', direction: 'DESCENDING' },
            limit: 100
          });

          let unitsSold = 0;
          let orderCount = 0;

          orders.filter(o => o.status !== 'cancelled').forEach(order => {
            const supplierItems = (order.items || []).filter((item: any) =>
              productIds.includes(item.productId) || item.supplierId === partnerId
            );

            if (supplierItems.length > 0) {
              orderCount++;
              unitsSold += supplierItems.reduce((sum: number, item: any) => sum + (item.quantity || 1), 0);
            }
          });

          stats.merchSold = unitsSold;
          stats.totalOrders = orderCount;
        } else {
          // Fall back to totalSold/soldStock from product docs
          stats.merchSold = merchProducts.reduce((sum, p) => {
            return sum + (p.totalSold || p.soldStock || p.sales || 0);
          }, 0);
        }
      }

      // Fetch vinyl seller stats (only if approved)
      if (effectiveIsVinylSeller && approved) {
        try {
          // Query vinyl listings by seller
          const vinylListings = await queryCollection('vinylListings', {
            filters: [{ field: 'sellerId', op: 'EQUAL', value: partnerId }]
          });

          stats.vinylListings = vinylListings.length;

          // Count sold listings
          stats.vinylSold = vinylListings.filter(l => l.status === 'sold').length;

          // Get vinyl listing IDs for order matching
          const listingIds = vinylListings.map(l => l.id);

          // Fetch orders containing vinyl items
          if (listingIds.length > 0) {
            const orders = await queryCollection('orders', {
              orderBy: { field: 'createdAt', direction: 'DESCENDING' },
              limit: 100
            });

            let vinylOrderCount = 0;
            orders.filter(o => o.status !== 'cancelled').forEach(order => {
              const vinylItems = (order.items || []).filter((item: any) =>
                listingIds.includes(item.productId) || item.sellerId === partnerId || item.type === 'vinyl'
              );
              if (vinylItems.length > 0) {
                vinylOrderCount++;
              }
            });

            stats.vinylOrders = vinylOrderCount;
          }
        } catch (vinylError) {
          console.error('[Partner Dashboard] Error fetching vinyl stats:', vinylError);
        }
      }
    }
  } catch (e) {
    console.error('Error fetching partner:', e);
  }
}

const isLoggedIn = !!partner;
const isApproved = partner?.approved === true;

// Role flags
const isArtist = partner?.isArtist !== false;
const isDJ = partner?.isDJ || isArtist;
const isMerchSupplier = partner?.isMerchSupplier || false;
const isVinylSeller = partner?.isVinylSeller || false;

// Show sections (even if grayed out)
const showReleaseSection = isArtist;
const showMerchSection = isMerchSupplier;
const showVinylSection = isVinylSeller;

const formatNumber = (num: number) => new Intl.NumberFormat('en-GB').format(num || 0);

export const prerender = false;
---

<Layout title="Partner Dashboard">
  <Header />
  
  <main class="dashboard-main">
    <!-- Loading state - shown while checking auth (hidden if already logged in server-side) -->
    <div id="loadingState" class="login-prompt" style={isLoggedIn ? 'display: none;' : ''}>
      <div class="login-card">
        <img src="/logo.webp" alt="Fresh Wax" class="login-logo" />
        <h1>Partner Dashboard</h1>
        <p>Checking authentication...</p>
        <div style="display: flex; justify-content: center; padding: 2rem;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
    
    <!-- Login prompt - shown if not logged in -->
    <div id="loginPrompt" class="login-prompt" style="display: none;">
      <div class="login-card">
        <img src="/logo.webp" alt="Fresh Wax" class="login-logo" />
        <h1>Partner Dashboard</h1>
        <p>Sign in to manage your releases, mixes, and sales.</p>
        <a href="/login" class="btn-primary">Sign In</a>
        <a href="/register" class="btn-secondary">Create Account</a>
      </div>
    </div>
    
    {isLoggedIn && (
      <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
          <div class="welcome-left">
            <div class="avatar">
              {partner.avatarUrl || partner.imageUrl || partner.photoURL ? (
                <img src={partner.avatarUrl || partner.imageUrl || partner.photoURL} alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
                <span style="display:none;">{(partner.displayName || partner.artistName)?.charAt(0).toUpperCase() || '?'}</span>
              ) : (
                <span>{(partner.displayName || partner.artistName)?.charAt(0).toUpperCase() || '?'}</span>
              )}
            </div>
            <div class="welcome-text">
              <h1>Welcome back, {partner.displayName || partner.artistName || 'Partner'}</h1>
              <div class="role-badges">
                {isArtist && <span class={`role-badge artist ${!isApproved ? 'pending' : ''}`}>Artist / Producer / Label {!isApproved && '(Pending)'}</span>}
                {isDJ && <span class="role-badge dj">DJ</span>}
                {isMerchSupplier && <span class={`role-badge merch ${!isApproved ? 'pending' : ''}`}>Merch Supplier {!isApproved && '(Pending)'}</span>}
                {isVinylSeller && <span class={`role-badge vinyl ${!isApproved ? 'pending' : ''}`}>Vinyl Seller {!isApproved && '(Pending)'}</span>}
              </div>
            </div>
          </div>
          {!isApproved && (
            <div class="approval-notice">
              <span class="notice-icon">‚è≥</span>
              <span>Account pending approval - DJ Mixes available now!</span>
            </div>
          )}
        </div>

        <!-- EARNINGS SECTION -->
        {isApproved && (
          <section class="dashboard-section earnings-section">
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üí∞</span>
                <h2>Earnings</h2>
              </div>
              <p class="section-desc">Track your music sales and payouts</p>
            </div>

            <div class="earnings-grid">
              <div class="earnings-card total">
                <div class="earnings-icon">üí∑</div>
                <div class="earnings-value">{new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(stats.totalEarnings)}</div>
                <div class="earnings-label">Total Earnings</div>
              </div>

              {stats.pendingBalance > 0 && (
                <div class="earnings-card pending">
                  <div class="earnings-icon">‚è≥</div>
                  <div class="earnings-value">{new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(stats.pendingBalance)}</div>
                  <div class="earnings-label">Pending Payout</div>
                </div>
              )}

              <a href="/artist/payouts" class="earnings-card action">
                <div class="earnings-icon">üìä</div>
                <div class="earnings-text">
                  <span class="action-title">View Payouts</span>
                  <span class="action-desc">See payout history</span>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              {!stats.stripeConnected && (
                <a href="/artist/account#stripe-connect-section" class="earnings-card connect">
                  <div class="earnings-icon">üè¶</div>
                  <div class="earnings-text">
                    <span class="action-title">Set Up Payments</span>
                    <span class="action-desc">Connect Stripe to get paid</span>
                  </div>
                  <span class="card-arrow">‚Üí</span>
                </a>
              )}
            </div>
          </section>
        )}

        <!-- MUSIC RELEASES SECTION (Requires Approval) -->
        {showReleaseSection && (
          <section class={`dashboard-section releases-section ${!isApproved ? 'restricted' : ''}`}>
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üíø</span>
                <h2>Music Releases</h2>
                {!isApproved && <span class="section-badge pending-red">Approval Required</span>}
              </div>
              <p class="section-desc">Upload and manage your music releases</p>
            </div>

            {!isApproved && (
              <div class="restricted-overlay">
                <div class="restricted-message">
                  <span class="lock-icon">üîí</span>
                  <h3>Awaiting Approval</h3>
                  <p>This section will be available once your account is approved.</p>
                </div>
              </div>
            )}

            <div class="cards-grid two-col">
              <a href={isApproved ? "/pro/releases/new" : "#"} class={`action-card primary-red ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üì¶</div>
                <div class="card-body">
                  <h3>Upload Release</h3>
                  <p>Submit a new release to the store</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/releases" : "#"} class={`action-card release-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üìÇ</div>
                <div class="card-body">
                  <h3>My Releases</h3>
                  <p>View, edit & manage your catalogue</p>
                </div>
                <span class="release-count">{stats.releases}</span>
              </a>
            </div>
          </section>
        )}

        <!-- MERCH SECTION (Requires Approval) -->
        {showMerchSection && (
          <section class={`dashboard-section ${!isApproved ? 'restricted' : ''}`}>
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üëï</span>
                <h2>Merchandise</h2>
                {!isApproved && <span class="section-badge pending">Approval Required</span>}
              </div>
              <p class="section-desc">Monitor stock levels, track sales and manage orders</p>
            </div>

            {!isApproved && (
              <div class="restricted-overlay">
                <div class="restricted-message">
                  <span class="lock-icon">üîí</span>
                  <h3>Awaiting Approval</h3>
                  <p>This section will be available once your account is approved.</p>
                </div>
              </div>
            )}

            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-number">{stats.merchProducts}</div>
                <div class="stat-label">Products</div>
              </div>
              <div class="stat-card green">
                <div class="stat-number">{stats.merchSold}</div>
                <div class="stat-label">Units Sold</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">{stats.totalOrders}</div>
                <div class="stat-label">Orders</div>
              </div>
            </div>

            <div class="cards-grid merch-grid">
              <a href={isApproved ? "/artist/merch" : "#"} class={`action-card merch-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">üì¶</div>
                </div>
                <div class="card-body">
                  <h3>View Stock</h3>
                  <p>Check current inventory levels</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/merch-sales" : "#"} class={`action-card merch-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">üí∞</div>
                </div>
                <div class="card-body">
                  <h3>Sales Report</h3>
                  <p>Track orders and revenue</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/merch-orders" : "#"} class={`action-card merch-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">üìã</div>
                </div>
                <div class="card-body">
                  <h3>Order History</h3>
                  <p>View all customer orders</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/merch-analytics" : "#"} class={`action-card merch-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">üìä</div>
                </div>
                <div class="card-body">
                  <h3>Analytics</h3>
                  <p>Sales trends and insights</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>
            </div>
          </section>
        )}

        <!-- VINYL SECTION (Requires Approval) -->
        {showVinylSection && (
          <section class={`dashboard-section vinyl-section ${!isApproved ? 'restricted' : ''}`}>
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üìÄ</span>
                <h2>Vinyl Crates</h2>
                {!isApproved && <span class="section-badge pending-orange">Approval Required</span>}
              </div>
              <p class="section-desc">Manage your vinyl listings, sales, and reviews</p>
            </div>

            {!isApproved && (
              <div class="restricted-overlay">
                <div class="restricted-message">
                  <span class="lock-icon">üîí</span>
                  <h3>Awaiting Approval</h3>
                  <p>This section will be available once your account is approved.</p>
                </div>
              </div>
            )}

            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-number">{stats.vinylListings}</div>
                <div class="stat-label">Listings</div>
              </div>
              <div class="stat-card green">
                <div class="stat-number">{stats.vinylSold}</div>
                <div class="stat-label">Sold</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">{stats.vinylOrders}</div>
                <div class="stat-label">Orders</div>
              </div>
            </div>

            <div class="cards-grid vinyl-grid">
              <a href={isApproved ? "/artist/vinyl/new" : "#"} class={`action-card vinyl-card primary-orange ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">‚ûï</div>
                </div>
                <div class="card-body">
                  <h3>List Vinyl</h3>
                  <p>Add new records to Crates</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/vinyl" : "#"} class={`action-card vinyl-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">üì¶</div>
                </div>
                <div class="card-body">
                  <h3>My Listings</h3>
                  <p>View and manage your vinyl</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/vinyl/orders" : "#"} class={`action-card vinyl-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon-wrap">
                  <div class="card-icon">üìã</div>
                </div>
                <div class="card-body">
                  <h3>Orders</h3>
                  <p>Track sales and shipments</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/crates" : "#"} class={`action-card vinyl-card ${!isApproved ? 'disabled' : ''}`} target="_blank">
                <div class="card-icon-wrap">
                  <div class="card-icon">üõí</div>
                </div>
                <div class="card-body">
                  <h3>View Crates</h3>
                  <p>See the marketplace</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>
            </div>
          </section>
        )}

        <!-- ACCOUNT SECTION -->
        <section class="dashboard-section account-section">
          <div class="section-header">
            <div class="section-title-wrap">
              <span class="section-icon">‚öôÔ∏è</span>
              <h2>Account</h2>
            </div>
            <p class="section-desc">Manage your profile, orders and settings</p>
          </div>

          <div class="cards-grid two-col">
            <a href="/artist/account" class="action-card primary">
              <div class="card-icon">üë§</div>
              <div class="card-body">
                <h3>My Account</h3>
                <p>Profile, orders, payouts & settings</p>
              </div>
              <span class="card-arrow">‚Üí</span>
            </a>

            <a href="/contact" class="action-card">
              <div class="card-icon">üí¨</div>
              <div class="card-body">
                <h3>Support</h3>
                <p>Get help & contact us</p>
              </div>
              <span class="card-arrow">‚Üí</span>
            </a>
          </div>
        </section>
      </div>
    )}
  </main>

  <Footer />
</Layout>

<style>
  .dashboard-main {
    min-height: calc(100vh - 200px);
    background: linear-gradient(to bottom, #000000, #111827);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }
  
  /* Login Prompt */
  .login-prompt {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #374151;
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .login-card {
    background: linear-gradient(to bottom, #1f2937, #111827);
    padding: 3rem;
    border-radius: 16px;
    text-align: center;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    border: 2px solid #374151;
  }
  
  .login-logo {
    height: 80px;
    margin-bottom: 1.5rem;
  }
  
  .login-card h1 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #fff;
  }
  
  .login-card p {
    color: #9ca3af;
    margin-bottom: 2rem;
    font-size: 1rem;
  }
  
  .btn-primary {
    display: block;
    width: 100%;
    padding: 1rem;
    background: #000;
    color: #fff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.0625rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s;
  }
  
  .btn-primary:hover {
    background: #222;
    transform: translateY(-2px);
  }
  
  .btn-secondary {
    display: block;
    width: 100%;
    padding: 1rem;
    background: linear-gradient(to bottom, #1f2937, #111827);
    color: #fff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.0625rem;
    border: 2px solid #ddd;
    transition: all 0.2s;
  }
  
  .btn-secondary:hover {
    border-color: #fff;
  }
  
  /* Welcome Section */
  .welcome-section {
    background: linear-gradient(135deg, #000 0%, #1a1a2e 50%, #16213e 100%);
    color: #fff;
    padding: 2.5rem 3rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1.5rem;
    border: 2px solid #374151;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  
  .welcome-left {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }
  
  .avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #374151, #1f2937);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.25rem;
    font-weight: 700;
    font-family: 'Inter', sans-serif; font-weight: 700;
    border: 3px solid #4b5563;
    overflow: hidden;
  }
  
  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .welcome-text h1 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 2.5rem;
    font-weight: 400;
    margin-bottom: 0.75rem;
    letter-spacing: 0.02em;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  .role-badges {
    display: flex;
    gap: 0.625rem;
    flex-wrap: wrap;
  }
  
  .role-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .role-badge.artist { background: #22c55e; color: #fff; }
  .role-badge.artist.pending { background: #fbbf24; color: #000; }
  .role-badge.dj { background: #dc2626; color: #fff; }
  .role-badge.merch { background: linear-gradient(to bottom, #374151, #1f2937); color: #fff; border: 2px solid #4b5563; }
  .role-badge.merch.pending { background: #fbbf24; color: #000; }
  .role-badge.vinyl { background: linear-gradient(to bottom, #f97316, #ea580c); color: #fff; }
  .role-badge.vinyl.pending { background: #fbbf24; color: #000; }
  
  .approval-notice {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.1);
    padding: 0.75rem 1.25rem;
    border-radius: 10px;
    font-size: 0.9375rem;
  }
  
  .notice-icon { font-size: 1.25rem; }
  
  /* Dashboard Sections */
  .dashboard-section {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    position: relative;
  }
  
  .dashboard-section.restricted .stats-row,
  .dashboard-section.restricted .cards-grid,
  .dashboard-section.restricted .info-banner {
    opacity: 0.3;
    pointer-events: none;
    filter: grayscale(100%);
  }
  
  .restricted-overlay {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    text-align: center;
  }
  
  .restricted-message {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  }
  
  .lock-icon { font-size: 2rem; display: block; margin-bottom: 0.5rem; }
  .restricted-message h3 { font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem; color: #fff; }
  .restricted-message p { font-size: 0.9375rem; color: #9ca3af; max-width: 300px; margin: 0 auto; }

  /* Earnings Section */
  .earnings-section {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-color: #6366f1;
  }

  .earnings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .earnings-card {
    background: linear-gradient(to bottom, #374151, #1f2937);
    border: 2px solid #4b5563;
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: all 0.2s;
  }

  .earnings-card.total {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
  }

  .earnings-card.pending {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-color: #f59e0b;
  }

  .earnings-card.action,
  .earnings-card.connect {
    flex-direction: row;
    text-align: left;
    gap: 1rem;
    text-decoration: none;
    color: inherit;
  }

  .earnings-card.action:hover,
  .earnings-card.connect:hover {
    background: linear-gradient(to bottom, #4b5563, #374151);
    border-color: #6b7280;
    transform: translateY(-2px);
  }

  .earnings-card.connect {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    border-color: #6366f1;
  }

  .earnings-card.connect:hover {
    background: linear-gradient(135deg, #818cf8, #6366f1);
  }

  .earnings-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .earnings-card.action .earnings-icon,
  .earnings-card.connect .earnings-icon {
    margin-bottom: 0;
    font-size: 1.75rem;
  }

  .earnings-value {
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 1.75rem;
    color: #fff;
    line-height: 1;
  }

  .earnings-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: rgba(255,255,255,0.8);
    text-transform: uppercase;
    margin-top: 0.25rem;
  }

  .earnings-text {
    flex: 1;
  }

  .action-title {
    display: block;
    font-weight: 600;
    font-size: 1rem;
    color: #fff;
  }

  .action-desc {
    display: block;
    font-size: 0.8125rem;
    color: #9ca3af;
    margin-top: 0.125rem;
  }

  .earnings-card .card-arrow {
    font-size: 1.25rem;
    color: #9ca3af;
    transition: transform 0.2s;
  }

  .earnings-card:hover .card-arrow {
    transform: translateX(4px);
    color: #fff;
  }

  .section-header { margin-bottom: 1.5rem; }
  
  .section-title-wrap {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.25rem;
    flex-wrap: wrap;
  }
  
  .section-icon { font-size: 1.75rem; }
  
  .section-header h2 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 2rem;
    font-weight: 400;
    color: #fff;
  }
  
  .section-badge {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.8125rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .section-badge.available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
  .section-badge.pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
  .section-badge.pending-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
  .section-badge.pending-orange { background: rgba(249, 115, 22, 0.2); color: #f97316; }
  
  .dashboard-section.releases-section {
    border-color: rgba(239, 68, 68, 0.3);
  }

  .dashboard-section.releases-section:hover {
    border-color: rgba(239, 68, 68, 0.5);
  }

  .dashboard-section.vinyl-section {
    border-color: rgba(249, 115, 22, 0.3);
  }

  .dashboard-section.vinyl-section:hover {
    border-color: rgba(249, 115, 22, 0.5);
  }

  /* Vinyl Cards Grid - 2x2 Layout */
  .cards-grid.vinyl-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .action-card.vinyl-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.25rem;
    flex-direction: row;
    align-items: center;
    gap: 1rem;
  }

  .action-card.vinyl-card:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(249, 115, 22, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .action-card.vinyl-card .card-icon-wrap {
    flex-shrink: 0;
  }

  .action-card.vinyl-card .card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.2));
    border: 1px solid rgba(249, 115, 22, 0.3);
    border-radius: 12px;
    font-size: 1.5rem;
  }

  .action-card.vinyl-card.primary-orange {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(234, 88, 12, 0.1));
    border-color: rgba(249, 115, 22, 0.5);
  }

  .action-card.vinyl-card.primary-orange:hover {
    border-color: #f97316;
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.25), rgba(234, 88, 12, 0.15));
  }

  .action-card.vinyl-card .card-body h3 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
  }

  .action-card.vinyl-card .card-body p {
    font-size: 0.8rem;
    color: #6b7280;
  }

  .action-card.vinyl-card .card-arrow {
    font-size: 1.25rem;
    color: #4b5563;
  }

  .action-card.vinyl-card:hover .card-arrow {
    color: #f97316;
  }

  @media (max-width: 640px) {
    .cards-grid.vinyl-grid {
      grid-template-columns: 1fr;
    }
  }

  .section-desc { color: #9ca3af; font-size: 1.0625rem; margin-left: 2.5rem; }
  
  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
  }
  
  .stat-card.green { background: rgba(16, 185, 129, 0.15); border-color: #10b981; }
  .stat-card.red { background: rgba(220, 38, 38, 0.15); border-color: #dc2626; }
  .stat-card.amber { background: rgba(251, 191, 36, 0.15); border-color: #fcd34d; }
  
  .stat-number {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 2.5rem;
    line-height: 1;
    color: #fff;
    margin-bottom: 0.25rem;
  }
  
  .stat-card.green .stat-number { color: #10b981; }
  .stat-card.red .stat-number { color: #dc2626; }
  .stat-card.amber .stat-number { color: #fbbf24; }
  
  .stat-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  
  /* Action Cards */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }
  
  .cards-grid.small { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
  .cards-grid.two-col { grid-template-columns: repeat(2, 1fr); }
  .cards-grid.four-col { grid-template-columns: repeat(4, 1fr); }
  
  /* Merch Cards Grid - 2x2 Layout */
  .cards-grid.merch-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
  
  .action-card.merch-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.25rem;
    flex-direction: row;
    align-items: center;
    gap: 1rem;
  }
  
  .action-card.merch-card:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(102, 126, 234, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }
  
  .action-card.merch-card .card-icon-wrap {
    flex-shrink: 0;
  }
  
  .action-card.merch-card .card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 12px;
    font-size: 1.5rem;
  }
  
  .action-card.merch-card .card-body h3 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
  }
  
  .action-card.merch-card .card-body p {
    font-size: 0.8rem;
    color: #6b7280;
  }
  
  .action-card.merch-card .card-arrow {
    font-size: 1.25rem;
    color: #4b5563;
  }
  
  .action-card.merch-card:hover .card-arrow {
    color: #667eea;
  }
  
  @media (max-width: 640px) {
    .cards-grid.merch-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .action-card {
    background: linear-gradient(to bottom, #1f2937, #111827);
    border: 2px solid #374151;
    border-radius: 12px;
    padding: 1.75rem;
    text-decoration: none;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    transition: all 0.2s;
  }
  
  .action-card:hover {
    border-color: #4b5563;
    background: linear-gradient(to bottom, #374151, #1f2937);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  
  .action-card.primary { background: #000; border-color: #3b82f6; color: #fff; }
  .action-card.primary:hover { background: #111; border-color: #60a5fa; }
  .action-card.primary-red { background: #000; border-color: #ef4444; color: #fff; }
  .action-card.primary-red:hover { background: #111; border-color: #f87171; }
  .action-card.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
  .action-card.compact { padding: 1.25rem; }
  
  .card-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(to bottom, #374151, #1f2937);
    border: 2px solid #4b5563;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    flex-shrink: 0;
  }
  
  .action-card.primary .card-icon { background: #1f2937; border-color: #3b82f6; }
  .action-card.primary-red .card-icon { background: #1f2937; border-color: #ef4444; }
  .action-card.compact .card-icon { width: 40px; height: 40px; font-size: 1.25rem; }
  
  .card-body { flex: 1; min-width: 0; }
  .card-body h3 { font-size: 1.375rem; font-weight: 700; margin-bottom: 0.25rem; color: #fff; }
  .card-body p { font-size: 1.0625rem; color: #9ca3af; line-height: 1.4; }
  .action-card.primary .card-body p { color: #9ca3af; }
  .action-card.primary-red .card-body p { color: #9ca3af; }
  .action-card.compact .card-body h3 { font-size: 1rem; }
  .action-card.compact .card-body p { font-size: 0.875rem; }
  
  .card-arrow { font-size: 1.5rem; color: #6b7280; transition: transform 0.2s; }
  .action-card:hover .card-arrow { transform: translateX(4px); color: #fff; }
  .action-card.primary .card-arrow { color: #9ca3af; }
  .action-card.primary:hover .card-arrow { color: #fff; }
  .action-card.primary-red .card-arrow { color: #9ca3af; }
  .action-card.primary-red:hover .card-arrow { color: #fff; }
  
  .action-card.release-card { border-color: rgba(239, 68, 68, 0.4); }
  .action-card.release-card:hover { border-color: #ef4444; }
  .action-card.release-card .card-icon { border-color: rgba(239, 68, 68, 0.5); }
  
  .release-count {
    background: #dc2626;
    color: #fff;
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 2rem;
    min-width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
  }
  
  /* Info Banner */
  .info-banner {
    background: #f0f9ff;
    border: 2px solid #bae6fd;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9375rem;
    color: #0369a1;
  }
  
  .info-icon { font-size: 1.25rem; }
  
  /* Account Section - same dark theme as other sections */
  .account-section { background: linear-gradient(to bottom, #1f2937, #111827); border-color: #374151; }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .cards-grid.four-col { grid-template-columns: repeat(2, 1fr); }
  }
  
  @media (max-width: 768px) {
    .container { padding: 1rem; }
    .welcome-section { padding: 1.5rem; flex-direction: column; text-align: center; }
    .welcome-left { flex-direction: column; }
    .welcome-text h1 { font-size: 2rem; }
    .avatar { width: 60px; height: 60px; font-size: 1.75rem; }
    .role-badges { justify-content: center; }
    .dashboard-section { padding: 1.5rem; }
    .section-desc { margin-left: 0; margin-top: 0.5rem; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .cards-grid { grid-template-columns: 1fr; }
    .cards-grid.two-col { grid-template-columns: 1fr; }
    .cards-grid.four-col { grid-template-columns: 1fr; }
    .restricted-overlay { position: relative; top: 0; transform: none; margin-bottom: 1rem; }
  }
  
  @media (max-width: 480px) {
    .stat-number { font-size: 2rem; }
    .section-title-wrap { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
  }
</style>

<script is:inline type="module">
  import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  
  // Helper to check if a cookie is properly set (not empty or expired)
  function hasCookie(name) {
    const value = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return value && !value.endsWith('=') && !value.endsWith('=;');
  }
  
  // Get UI elements
  const loadingState = document.getElementById('loadingState');
  const loginPrompt = document.getElementById('loginPrompt');
  
  function showLoading() {
    if (loadingState) loadingState.style.display = 'flex';
    if (loginPrompt) loginPrompt.style.display = 'none';
  }
  
  function showLogin() {
    if (loadingState) loadingState.style.display = 'none';
    if (loginPrompt) loginPrompt.style.display = 'flex';
  }
  
  function hideAll() {
    if (loadingState) loadingState.style.display = 'none';
    if (loginPrompt) loginPrompt.style.display = 'none';
  }
  
  onAuthStateChanged(auth, async (user) => {
    console.log('[Partner Dashboard Client] Auth state changed, user:', user?.uid || 'NOT LOGGED IN');
    
    if (!user) {
      // Not logged in - show login prompt
      console.log('[Partner Dashboard Client] No user, showing login prompt');
      document.cookie = 'partnerId=; path=/; max-age=0';
      showLogin();
      return;
    }
    
    // User is logged in
    console.log('[Partner Dashboard Client] User logged in:', user.uid);
    
    // Always ensure userId cookie is set
    if (!hasCookie('userId')) {
      document.cookie = `userId=${user.uid}; path=/; max-age=2592000; SameSite=Lax`;
      console.log('[Partner Dashboard Client] Set userId cookie');
    }
    
    // Check if partnerId cookie exists and is valid
    const hasPartnerCookie = hasCookie('partnerId');
    console.log('[Partner Dashboard Client] hasPartnerCookie:', hasPartnerCookie);
    
    if (!hasPartnerCookie) {
      console.log('[Partner Dashboard Client] No partnerId cookie, checking profile...');
      showLoading();
      
      try {
        // Fetch user profile to check if they're a partner
        const response = await fetch(`/api/get-user-type?uid=${encodeURIComponent(user.uid)}`);
        const profile = await response.json();
        
        console.log('[Partner Dashboard Client] Profile:', profile);
        
        // If they have any partner role, set the cookie and reload
        if (profile.success && (profile.isPro || profile.roles?.artist || profile.roles?.dj || profile.roles?.merchSupplier || profile.roles?.vinylSeller)) {
          document.cookie = `partnerId=${user.uid}; path=/; max-age=2592000; SameSite=Lax`;
          console.log('[Partner Dashboard Client] Set partnerId cookie, reloading...');
          window.location.reload();
        } else {
          // They're logged in but not a partner - show login prompt with message
          console.log('[Partner Dashboard Client] User has no partner roles, showing login');
          showLogin();
        }
      } catch (e) {
        console.error('[Partner Dashboard Client] Error fetching profile:', e);
        showLogin();
      }
    } else {
      // partnerId cookie exists - if we're seeing this, the server should have rendered the dashboard
      // Hide loading state just in case
      hideAll();
    }
  });
</script>
