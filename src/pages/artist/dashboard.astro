---
// /src/pages/artist/dashboard.astro
// Fresh Wax Partner Dashboard - Uses Layout, Header, Footer
// DJ Mixes section is always accessible - no approval needed
// Releases and Merch sections require approval

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { initializeApp, cert, getApps } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

const partnerId = Astro.cookies.get('partnerId')?.value || '';
let partner = null;
let stats = {
  releases: 0,
  liveReleases: 0,
  pendingReleases: 0,
  mixes: 0,
  mixPlays: 0,
  mixLikes: 0,
  mixRatings: 0,
  merchProducts: 0,
  merchSold: 0,
  totalOrders: 0
};

if (partnerId) {
  try {
    const partnerDoc = await db.collection('artists').doc(partnerId).get();
    if (partnerDoc.exists) {
      partner = { id: partnerDoc.id, ...partnerDoc.data() };
      
      const approved = partner.approved === true;
      const effectiveIsArtist = partner.isArtist !== false;
      const effectiveIsDJ = !!partner.isDJ || effectiveIsArtist;
      const effectiveIsMerchSupplier = !!partner.isMerchSupplier;
      
      // Fetch artist/label stats (only if approved)
      if (effectiveIsArtist && approved) {
        const releasesSnap = await db.collection('releases')
          .where('artistId', '==', partnerId)
          .get();
        stats.releases = releasesSnap.size;
        stats.liveReleases = releasesSnap.docs.filter(d => d.data().status === 'live').length;
        stats.pendingReleases = releasesSnap.docs.filter(d => d.data().status === 'pending').length;
      }
      
      // Fetch DJ/mix stats (always available - no approval needed)
      if (effectiveIsDJ || effectiveIsArtist) {
        // Query by userId first
        let mixesSnap = await db.collection('dj-mixes')
          .where('userId', '==', partnerId)
          .get();
        
        // If no results, also try matching by djName (for older mixes without userId)
        if (mixesSnap.empty && partner.artistName) {
          const byNameSnap = await db.collection('dj-mixes')
            .where('djName', '==', partner.artistName)
            .get();
          if (!byNameSnap.empty) {
            mixesSnap = byNameSnap;
          }
        }
        
        stats.mixes = mixesSnap.size;
        stats.mixPlays = mixesSnap.docs.reduce((sum, d) => sum + (d.data().plays || 0), 0);
        stats.mixLikes = mixesSnap.docs.reduce((sum, d) => sum + (d.data().likes || 0), 0);
        stats.mixRatings = mixesSnap.docs.reduce((sum, d) => {
          const ratings = d.data().ratings;
          return sum + (ratings?.count || 0);
        }, 0);
      }
      
      // Fetch merch stats (only if approved)
      if (effectiveIsMerchSupplier && approved) {
        const merchSnap = await db.collection('merch')
          .where('supplierId', '==', partnerId)
          .get();
        stats.merchProducts = merchSnap.size;
        stats.merchSold = merchSnap.docs.reduce((sum, d) => sum + (d.data().totalSold || 0), 0);
      }
    }
  } catch (e) {
    console.error('Error fetching partner:', e);
  }
}

const isLoggedIn = !!partner;
const isApproved = partner?.approved === true;

// Role flags
const isArtist = partner?.isArtist !== false;
const isDJ = partner?.isDJ || isArtist;
const isMerchSupplier = partner?.isMerchSupplier || false;

// Show sections (even if grayed out)
const showReleaseSection = isArtist;
const showMixSection = isDJ || isArtist;
const showMerchSection = isMerchSupplier;

const formatNumber = (num: number) => new Intl.NumberFormat('en-GB').format(num || 0);

export const prerender = false;
---

<Layout title="Partner Dashboard | Fresh Wax">
  <Header />
  
  <main class="dashboard-main">
    {!isLoggedIn ? (
      <div class="login-prompt">
        <div class="login-card">
          <img src="/logo.webp" alt="Fresh Wax" class="login-logo" />
          <h1>Partner Dashboard</h1>
          <p>Sign in to manage your releases, mixes, and sales.</p>
          <a href="/login" class="btn-primary">Sign In</a>
          <a href="/register" class="btn-secondary">Create Account</a>
        </div>
      </div>
    ) : (
      <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
          <div class="welcome-left">
            <div class="avatar">{partner.artistName?.charAt(0).toUpperCase() || '?'}</div>
            <div class="welcome-text">
              <h1>Welcome back, {partner.artistName || 'Partner'}</h1>
              <div class="role-badges">
                {isArtist && <span class={`role-badge artist ${!isApproved ? 'pending' : ''}`}>Artist / Producer / Label {!isApproved && '(Pending)'}</span>}
                {isDJ && <span class="role-badge dj">DJ</span>}
                {isMerchSupplier && <span class={`role-badge merch ${!isApproved ? 'pending' : ''}`}>Merch Supplier {!isApproved && '(Pending)'}</span>}
              </div>
            </div>
          </div>
          {!isApproved && (
            <div class="approval-notice">
              <span class="notice-icon">‚è≥</span>
              <span>Account pending approval - DJ Mixes available now!</span>
            </div>
          )}
        </div>

        <!-- DJ MIXES SECTION (Always Available) -->
        {showMixSection && (
          <section class="dashboard-section">
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üéß</span>
                <h2>DJ Mixes</h2>
                <span class="section-badge available">No Approval Required</span>
              </div>
              <p class="section-desc">Upload and manage your DJ mixes</p>
            </div>

            <div class="cards-grid two-col">
              <a href="/upload-mix" class="action-card primary">
                <div class="card-icon">‚¨ÜÔ∏è</div>
                <div class="card-body">
                  <h3>Upload Mix</h3>
                  <p>Share a new mix or set</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href="/artist/mixes" class="action-card">
                <div class="card-icon">üìÇ</div>
                <div class="card-body">
                  <h3>My Mixes</h3>
                  <p>View, edit & manage your mixes</p>
                </div>
                <span class="mix-count">{stats.mixes}</span>
              </a>
            </div>
          </section>
        )}

        <!-- MUSIC RELEASES SECTION (Requires Approval) -->
        {showReleaseSection && (
          <section class={`dashboard-section ${!isApproved ? 'restricted' : ''}`}>
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üíø</span>
                <h2>Music Releases</h2>
                {!isApproved && <span class="section-badge pending">Approval Required</span>}
              </div>
              <p class="section-desc">Upload and manage your music releases</p>
            </div>

            {!isApproved && (
              <div class="restricted-overlay">
                <div class="restricted-message">
                  <span class="lock-icon">üîí</span>
                  <h3>Awaiting Approval</h3>
                  <p>This section will be available once your account is approved.</p>
                </div>
              </div>
            )}

            <div class="cards-grid two-col">
              <a href={isApproved ? "https://freshwax-uploader.pages.dev" : "#"} class={`action-card primary ${!isApproved ? 'disabled' : ''}`} target={isApproved ? "_blank" : undefined}>
                <div class="card-icon">üì¶</div>
                <div class="card-body">
                  <h3>Upload Release</h3>
                  <p>Submit a new release to the store</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/releases" : "#"} class={`action-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üìÇ</div>
                <div class="card-body">
                  <h3>My Releases</h3>
                  <p>View, edit & manage your catalogue</p>
                </div>
                <span class="release-count">{stats.releases}</span>
              </a>
            </div>
          </section>
        )}

        <!-- MERCH SECTION (Requires Approval) -->
        {showMerchSection && (
          <section class={`dashboard-section ${!isApproved ? 'restricted' : ''}`}>
            <div class="section-header">
              <div class="section-title-wrap">
                <span class="section-icon">üëï</span>
                <h2>Merchandise</h2>
                {!isApproved && <span class="section-badge pending">Approval Required</span>}
              </div>
              <p class="section-desc">Monitor stock levels, track sales and manage orders</p>
            </div>

            {!isApproved && (
              <div class="restricted-overlay">
                <div class="restricted-message">
                  <span class="lock-icon">üîí</span>
                  <h3>Awaiting Approval</h3>
                  <p>This section will be available once your account is approved.</p>
                </div>
              </div>
            )}

            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-number">{stats.merchProducts}</div>
                <div class="stat-label">Products</div>
              </div>
              <div class="stat-card green">
                <div class="stat-number">{stats.merchSold}</div>
                <div class="stat-label">Units Sold</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">{stats.totalOrders}</div>
                <div class="stat-label">Orders</div>
              </div>
            </div>

            <div class="info-banner">
              <span class="info-icon">‚ÑπÔ∏è</span>
              <span>To add or update products, please contact Fresh Wax admin</span>
            </div>

            <div class="cards-grid">
              <a href={isApproved ? "/artist/merch" : "#"} class={`action-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üì¶</div>
                <div class="card-body">
                  <h3>View Stock</h3>
                  <p>Check current inventory levels</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/merch-sales" : "#"} class={`action-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üí∞</div>
                <div class="card-body">
                  <h3>Sales Report</h3>
                  <p>Track orders and revenue</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/merch-orders" : "#"} class={`action-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üìã</div>
                <div class="card-body">
                  <h3>Order History</h3>
                  <p>View all customer orders</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>

              <a href={isApproved ? "/artist/merch-analytics" : "#"} class={`action-card ${!isApproved ? 'disabled' : ''}`}>
                <div class="card-icon">üìä</div>
                <div class="card-body">
                  <h3>Analytics</h3>
                  <p>Sales trends and insights</p>
                </div>
                <span class="card-arrow">‚Üí</span>
              </a>
            </div>
          </section>
        )}

        <!-- ACCOUNT SECTION -->
        <section class="dashboard-section account-section">
          <div class="section-header">
            <div class="section-title-wrap">
              <span class="section-icon">‚öôÔ∏è</span>
              <h2>Account</h2>
            </div>
            <p class="section-desc">Manage your profile, orders and settings</p>
          </div>

          <div class="cards-grid two-col">
            <a href="/artist/account" class="action-card primary">
              <div class="card-icon">üë§</div>
              <div class="card-body">
                <h3>My Account</h3>
                <p>Profile, orders, payouts & settings</p>
              </div>
              <span class="card-arrow">‚Üí</span>
            </a>

            <a href="/contact" class="action-card">
              <div class="card-icon">üí¨</div>
              <div class="card-body">
                <h3>Support</h3>
                <p>Get help & contact us</p>
              </div>
              <span class="card-arrow">‚Üí</span>
            </a>
          </div>
        </section>
      </div>
    )}
  </main>

  <Footer />
</Layout>

<style>
  .dashboard-main {
    min-height: calc(100vh - 200px);
    background: #f5f5f5;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }
  
  /* Login Prompt */
  .login-prompt {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  
  .login-card {
    background: #fff;
    padding: 3rem;
    border-radius: 16px;
    text-align: center;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 2px solid #e5e5e5;
  }
  
  .login-logo {
    height: 80px;
    margin-bottom: 1.5rem;
  }
  
  .login-card h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #000;
  }
  
  .login-card p {
    color: #666;
    margin-bottom: 2rem;
    font-size: 1rem;
  }
  
  .btn-primary {
    display: block;
    width: 100%;
    padding: 1rem;
    background: #000;
    color: #fff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.0625rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s;
  }
  
  .btn-primary:hover {
    background: #222;
    transform: translateY(-2px);
  }
  
  .btn-secondary {
    display: block;
    width: 100%;
    padding: 1rem;
    background: #fff;
    color: #000;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.0625rem;
    border: 2px solid #ddd;
    transition: all 0.2s;
  }
  
  .btn-secondary:hover {
    border-color: #000;
  }
  
  /* Welcome Section */
  .welcome-section {
    background: #000;
    color: #fff;
    padding: 2rem 2.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1.5rem;
  }
  
  .welcome-left {
    display: flex;
    align-items: center;
    gap: 1.25rem;
  }
  
  .avatar {
    width: 64px;
    height: 64px;
    background: #fff;
    color: #000;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    font-weight: 700;
    font-family: 'Bebas Neue', sans-serif;
  }
  
  .welcome-text h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    font-weight: 400;
    margin-bottom: 0.5rem;
  }
  
  .role-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .role-badge {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .role-badge.artist { background: #22c55e; color: #fff; }
  .role-badge.artist.pending { background: #fbbf24; color: #000; }
  .role-badge.dj { background: #dc2626; color: #fff; }
  .role-badge.merch { background: #fff; color: #000; }
  .role-badge.merch.pending { background: #fbbf24; color: #000; }
  
  .approval-notice {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.1);
    padding: 0.75rem 1.25rem;
    border-radius: 10px;
    font-size: 0.9375rem;
  }
  
  .notice-icon { font-size: 1.25rem; }
  
  /* Dashboard Sections */
  .dashboard-section {
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    position: relative;
  }
  
  .dashboard-section.restricted .stats-row,
  .dashboard-section.restricted .cards-grid,
  .dashboard-section.restricted .info-banner {
    opacity: 0.3;
    pointer-events: none;
    filter: grayscale(100%);
  }
  
  .restricted-overlay {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    text-align: center;
  }
  
  .restricted-message {
    background: #fff;
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  }
  
  .lock-icon { font-size: 2rem; display: block; margin-bottom: 0.5rem; }
  .restricted-message h3 { font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem; color: #000; }
  .restricted-message p { font-size: 0.9375rem; color: #666; max-width: 300px; margin: 0 auto; }
  
  .section-header { margin-bottom: 1.5rem; }
  
  .section-title-wrap {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.25rem;
    flex-wrap: wrap;
  }
  
  .section-icon { font-size: 1.75rem; }
  
  .section-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    font-weight: 400;
    color: #000;
  }
  
  .section-badge {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.8125rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .section-badge.available { background: #dcfce7; color: #16a34a; }
  .section-badge.pending { background: #fef3c7; color: #d97706; }
  
  .section-desc { color: #888; font-size: 1.0625rem; margin-left: 2.5rem; }
  
  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background: #f8f8f8;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
  }
  
  .stat-card.green { background: #f0fdf4; border-color: #86efac; }
  .stat-card.red { background: #fef2f2; border-color: #fca5a5; }
  .stat-card.amber { background: #fffbeb; border-color: #fcd34d; }
  
  .stat-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    line-height: 1;
    color: #000;
    margin-bottom: 0.25rem;
  }
  
  .stat-card.green .stat-number { color: #16a34a; }
  .stat-card.red .stat-number { color: #dc2626; }
  .stat-card.amber .stat-number { color: #d97706; }
  
  .stat-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  
  /* Action Cards */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }
  
  .cards-grid.small { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
  .cards-grid.two-col { grid-template-columns: repeat(2, 1fr); }
  
  .action-card {
    background: #f8f8f8;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 1.75rem;
    text-decoration: none;
    color: inherit;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    transition: all 0.2s;
  }
  
  .action-card:hover {
    border-color: #000;
    background: #fff;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  }
  
  .action-card.primary { background: #000; border-color: #000; color: #fff; }
  .action-card.primary:hover { background: #222; border-color: #222; }
  .action-card.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
  .action-card.compact { padding: 1.25rem; }
  
  .card-icon {
    width: 56px;
    height: 56px;
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    flex-shrink: 0;
  }
  
  .action-card.primary .card-icon { background: #222; border-color: #333; }
  .action-card.compact .card-icon { width: 40px; height: 40px; font-size: 1.25rem; }
  
  .card-body { flex: 1; min-width: 0; }
  .card-body h3 { font-size: 1.375rem; font-weight: 700; margin-bottom: 0.25rem; }
  .card-body p { font-size: 1.0625rem; color: #888; line-height: 1.4; }
  .action-card.primary .card-body p { color: #aaa; }
  .action-card.compact .card-body h3 { font-size: 1rem; }
  .action-card.compact .card-body p { font-size: 0.875rem; }
  
  .card-arrow { font-size: 1.5rem; color: #ccc; transition: transform 0.2s; }
  .action-card:hover .card-arrow { transform: translateX(4px); color: #000; }
  .action-card.primary .card-arrow { color: #666; }
  .action-card.primary:hover .card-arrow { color: #fff; }
  
  .mix-count {
    background: #dc2626;
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    min-width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
  }
  
  .release-count {
    background: #dc2626;
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    min-width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
  }
  
  /* Info Banner */
  .info-banner {
    background: #f0f9ff;
    border: 2px solid #bae6fd;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9375rem;
    color: #0369a1;
  }
  
  .info-icon { font-size: 1.25rem; }
  
  /* Account Section */
  .account-section { background: #f8f8f8; border-color: #e5e5e5; }
  
  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 1rem; }
    .welcome-section { padding: 1.5rem; flex-direction: column; text-align: center; }
    .welcome-left { flex-direction: column; }
    .welcome-text h1 { font-size: 1.5rem; }
    .avatar { width: 50px; height: 50px; font-size: 1.5rem; }
    .role-badges { justify-content: center; }
    .dashboard-section { padding: 1.5rem; }
    .section-desc { margin-left: 0; margin-top: 0.5rem; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .cards-grid { grid-template-columns: 1fr; }
    .cards-grid.two-col { grid-template-columns: 1fr; }
    .restricted-overlay { position: relative; top: 0; transform: none; margin-bottom: 1rem; }
  }
  
  @media (max-width: 480px) {
    .stat-number { font-size: 2rem; }
    .section-title-wrap { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
  }
</style>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
  
  const firebaseConfig = {
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.appspot.com",
    messagingSenderId: "1098330475390",
    appId: "1:1098330475390:web:b2e6b8c6e4c2a9a8b8c9d0"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      document.cookie = 'partnerId=; path=/; max-age=0';
    }
  });
</script>
