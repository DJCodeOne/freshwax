---
// src/pages/merch.astro
// Public Merch Store - Cloudflare Pages compatible (uses REST API)

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import FloatingShuffleButton from '../components/FloatingShuffleButton.astro';
import { queryCollection } from '../lib/firebase-rest';

export const prerender = false;

// Fetch merch using REST API (no Admin SDK)
let products: any[] = [];
let categories: Record<string, string> = {};
let productTypes: Record<string, string> = {};

try {
  const merchData = await queryCollection('merch', {
    filters: [
      { field: 'published', op: 'EQUAL', value: true },
      { field: 'status', op: 'EQUAL', value: 'active' }
    ],
    cacheKey: 'merch-active-published',
    cacheTTL: 10 * 60 * 1000 // 10 min cache
  });
  
  products = merchData.map(doc => {
    // Build filter options
    if (doc.category && doc.categoryName) {
      categories[doc.category] = doc.categoryName;
    }
    if (doc.productType && doc.productTypeName) {
      productTypes[doc.productType] = doc.productTypeName;
    }
    
    // Calculate stock status
    const stock = doc.totalStock || 0;
    const threshold = doc.lowStockThreshold || 5;
    let stockStatus = 'in-stock';
    let stockLabel = 'In Stock';
    
    if (stock === 0) {
      stockStatus = 'out-of-stock';
      stockLabel = 'Out of Stock';
    } else if (stock <= threshold) {
      stockStatus = 'low-stock';
      stockLabel = 'Low Stock';
    }
    
    return {
      ...doc,
      stockStatus,
      stockLabel,
      retailPrice: parseFloat(doc.retailPrice) || 0,
      salePrice: doc.salePrice ? parseFloat(doc.salePrice) : null,
    };
  });
  
  // Sort: featured first, then by date
  products.sort((a, b) => {
    if (a.featured && !b.featured) return -1;
    if (!a.featured && b.featured) return 1;
    const dateA = new Date(a.createdAt || 0).getTime();
    const dateB = new Date(b.createdAt || 0).getTime();
    return dateB - dateA;
  });
  
} catch (e) {
  console.error('[Merch] Error fetching:', e);
}

// Stats
const totalProducts = products.length;
const inStockCount = products.filter(p => p.stockStatus !== 'out-of-stock').length;
const onSaleCount = products.filter(p => p.onSale).length;

// JSON for client filtering
const productsJson = JSON.stringify(products.map(p => ({
  id: p.id,
  name: p.name,
  category: p.category,
  productType: p.productType,
  stockStatus: p.stockStatus,
  onSale: p.onSale,
  featured: p.featured,
  retailPrice: p.retailPrice,
  salePrice: p.salePrice,
})));
---

<Layout title="Merch">
  <Header />
  
  <!-- Full Width Layout with Sidebar -->
  <div class="merch-layout">
    <!-- Filters Sidebar - Full Height -->
    <aside class="merch-sidebar">
      <div class="sidebar-inner">
        
        <!-- Category Filter -->
        <div class="filter-section">
          <div class="filter-header">Category</div>
          <div class="filter-options">
            <label class="filter-option">
              <input type="radio" name="category" value="" checked class="filter-radio" />
              <span>All Categories</span>
            </label>
            {Object.entries(categories).map(([key, name]) => (
              <label class="filter-option">
                <input type="radio" name="category" value={key} class="filter-radio" />
                <span>{name}</span>
              </label>
            ))}
          </div>
        </div>

        <!-- Product Type Filter -->
        {Object.keys(productTypes).length > 0 && (
          <div class="filter-section">
            <div class="filter-header">Type</div>
            <div class="filter-options">
              <label class="filter-option">
                <input type="radio" name="type" value="" checked class="filter-radio" />
                <span>All Types</span>
              </label>
              {Object.entries(productTypes).map(([key, name]) => (
                <label class="filter-option">
                  <input type="radio" name="type" value={key} class="filter-radio" />
                  <span>{name}</span>
                </label>
              ))}
            </div>
          </div>
        )}

        <!-- Stock Filter -->
        <div class="filter-section">
          <div class="filter-header">Availability</div>
          <div class="filter-options">
            <label class="filter-option">
              <input type="radio" name="stock" value="" checked class="filter-radio" />
              <span>All</span>
            </label>
            <label class="filter-option">
              <input type="radio" name="stock" value="in-stock" class="filter-radio" />
              <span>In Stock Only</span>
            </label>
            {onSaleCount > 0 && (
              <label class="filter-option">
                <input type="radio" name="stock" value="on-sale" class="filter-radio" />
                <span>On Sale</span>
              </label>
            )}
          </div>
        </div>

        <button id="clearFilters" class="clear-filters-btn">
          Clear Filters
        </button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="merch-content">
      <!-- Hero -->
      <section class="merch-hero">
        <div class="hero-pattern"></div>
        <div class="hero-inner">
          <h1 class="merch-title">OFFICIAL MERCH</h1>
          <p class="hero-subtitle">Support the underground. Wear the sound.</p>
        </div>
      </section>

      <!-- Products Section -->
      <main class="products-main">
        <!-- Header -->
        <div class="products-header">
          <p class="products-count">
            Showing <strong id="visibleCount">{products.length}</strong> of <strong>{products.length}</strong> products
          </p>
          <select id="sortSelect" class="sort-select">
            <option value="featured">Featured</option>
            <option value="newest">Newest</option>
            <option value="price-low">Price: Low â†’ High</option>
            <option value="price-high">Price: High â†’ Low</option>
            <option value="name">Name A-Z</option>
          </select>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="products-grid">
            {products.length === 0 ? (
              <div class="col-span-full bg-white border-2 border-gray-200 p-12 text-center">
                <div class="text-6xl mb-4">ðŸ‘•</div>
                <h3 class="text-xl font-bold mb-2">No Products Yet</h3>
                <p class="text-gray-600">Check back soon for official Fresh Wax merchandise!</p>
              </div>
            ) : (
              products.map(product => (
                <article 
                  class="product-card bg-white border-2 border-gray-200 hover:border-black transition-all duration-200 hover:-translate-y-1 hover:shadow-xl group"
                  data-id={product.id}
                  data-category={product.category || ''}
                  data-type={product.productType || ''}
                  data-stock={product.stockStatus}
                  data-sale={product.onSale ? 'true' : 'false'}
                  data-featured={product.featured ? 'true' : 'false'}
                  data-price={product.salePrice || product.retailPrice}
                  data-name={product.name}
                  data-created={product.createdAt || ''}
                >
                  <!-- Badges -->
                  <div class="absolute top-3 left-3 z-10 flex flex-col gap-1">
                    {product.featured && (
                      <span class="px-2 py-1 bg-black text-white text-xs font-bold uppercase">Featured</span>
                    )}
                    {product.onSale && (
                      <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold uppercase">Sale</span>
                    )}
                    {product.stockStatus === 'low-stock' && (
                      <span class="px-2 py-1 bg-amber-500 text-white text-xs font-bold uppercase">Low Stock</span>
                    )}
                    {product.stockStatus === 'out-of-stock' && (
                      <span class="px-2 py-1 bg-gray-400 text-white text-xs font-bold uppercase">Sold Out</span>
                    )}
                  </div>

                  <!-- Image -->
                  <div class="p-4">
                    <div class="relative aspect-square overflow-hidden bg-gray-100">
                      <img 
                        src={product.primaryImage || product.images?.[0]?.url || '/logo.webp'} 
                        alt={product.name}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                        onerror="this.src='/logo.webp'"
                      />
                      <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button 
                          class="quick-view-btn px-6 py-3 bg-white text-black font-bold text-base uppercase tracking-wide hover:bg-red-600 hover:text-white transition-colors"
                          data-product={JSON.stringify(product)}
                        >
                          Quick View
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Info -->
                  <div class="p-4 pt-0">
                    <div class="text-lg text-gray-500 uppercase tracking-wide mb-1">
                      {product.categoryName || 'Fresh Wax'}
                    </div>
                    <h3 class="font-bold text-2xl mb-1 line-clamp-1">{product.name}</h3>
                    <div class="text-xl text-gray-600 mb-2">{product.productTypeName || product.productType}</div>
                    
                    <div class="flex items-baseline gap-2">
                      {product.onSale && product.salePrice ? (
                        <>
                          <span class="text-2xl font-bold text-red-600">Â£{product.salePrice.toFixed(2)}</span>
                          <span class="text-lg text-gray-400 line-through">Â£{product.retailPrice.toFixed(2)}</span>
                        </>
                      ) : (
                        <span class="text-2xl font-bold">Â£{product.retailPrice.toFixed(2)}</span>
                      )}
                    </div>

                    {product.colors && product.colors.length > 0 && (
                      <div class="flex gap-1 mt-3">
                        {product.colors.slice(0, 5).map((color: any) => (
                          <div 
                            class="w-6 h-6 border-2 border-gray-300 hover:border-black transition-colors" 
                            style={`background-color: ${color.hex || '#ccc'}`}
                            title={color.name}
                          />
                        ))}
                        {product.colors.length > 5 && (
                          <div class="w-6 h-6 border-2 border-gray-300 bg-gray-100 flex items-center justify-center text-xs text-gray-500">
                            +{product.colors.length - 5}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </article>
              ))
            )}
          </div>
        </main>
      </div>
    </div>

  <!-- Quick View Modal -->
  <div id="quickViewModal" class="fixed inset-0 bg-black/80 z-[1000] flex items-center justify-center p-4 opacity-0 invisible transition-all duration-300">
    <div class="bg-white border-3 border-black max-w-5xl w-full max-h-[90vh] overflow-y-auto transform translate-y-5 transition-transform duration-300">
      <div class="bg-black text-white px-6 py-5 flex justify-between items-center sticky top-0">
        <h3 class="font-bold text-2xl uppercase tracking-wide">Quick View</h3>
        <button id="closeModal" class="text-4xl hover:text-red-500 transition-colors">&times;</button>
      </div>
      <div class="md:grid md:grid-cols-2">
        <!-- Images -->
        <div class="bg-gray-100 p-6">
          <img id="modalMainImage" src="/logo.webp" alt="Product image" class="w-full aspect-square object-cover" />
          <div id="modalThumbnails" class="flex gap-3 pt-4"></div>
        </div>
        <!-- Details -->
        <div class="p-8 flex flex-col">
          <div id="modalCategory" class="text-xl text-gray-500 uppercase tracking-wide">Category</div>
          <h2 id="modalName" class="text-4xl font-bold mt-2 mb-3">Product Name</h2>
          <div id="modalPrice" class="text-4xl font-bold mb-6">Â£0.00</div>
          <p id="modalDescription" class="text-gray-600 text-xl leading-relaxed mb-8">Description</p>
          
          <div id="modalSizes" class="mb-6 hidden">
            <div class="text-xl font-bold uppercase mb-3">Size</div>
            <div id="modalSizeGrid" class="flex flex-wrap gap-3"></div>
          </div>
          
          <div id="modalColors" class="mb-6 hidden">
            <div class="text-xl font-bold uppercase mb-3">Colour</div>
            <div id="modalColorGrid" class="flex flex-wrap gap-3"></div>
          </div>
          
          <div id="modalStock" class="flex items-center gap-3 text-xl mb-8">
            <span class="w-3 h-3 rounded-full bg-green-500"></span>
            <span>In Stock</span>
          </div>
          
          <button id="addToCartBtn" class="mt-auto w-full py-5 bg-black text-white text-xl font-bold uppercase tracking-wide hover:bg-red-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
            Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 px-6 py-4 bg-black text-white font-bold border-2 border-white z-[9999] transform translate-y-24 opacity-0 transition-all duration-300">
    Added to cart!
  </div>

  <FloatingShuffleButton />

  <!-- Simple Footer -->
  <footer class="bg-gray-900 text-gray-400 py-6 text-center text-sm relative z-50">
    <div class="container mx-auto px-4">
      <p>&copy; {new Date().getFullYear()} Fresh Wax Records. All rights reserved.</p>
    </div>
  </footer>
</Layout>

<script define:vars={{ productsJson }}>
  window.PRODUCTS_DATA = JSON.parse(productsJson);
</script>

<script>
  // State
  let currentProduct: any = null;
  let selectedSize: string | null = null;
  let selectedColor: string | null = null;
  let userCanPurchase = true;

  function init() {
    setupFilters();
    setupQuickView();
    setupModal();
    checkUserPurchasePermission();
  }

  // Check if user is allowed to make purchases
  async function checkUserPurchasePermission() {
    try {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
      const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
      
      const firebaseConfig = {
        apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      
      onAuthStateChanged(auth, async (user: any) => {
        if (user) {
          const response = await fetch('/api/get-user-type?uid=' + user.uid);
          const data = await response.json();
          
          // Artists who are NOT also customers cannot buy
          if (data.isArtist && !data.isCustomer) {
            userCanPurchase = false;
          }
        }
      });
    } catch (e) {
      console.error('Error checking user type:', e);
    }
  }

  // Filters
  function setupFilters() {
    const filterInputs = document.querySelectorAll<HTMLInputElement>('.bg-white input[type="radio"]');
    const sortSelect = document.getElementById('sortSelect') as HTMLSelectElement;
    const clearBtn = document.getElementById('clearFilters');

    filterInputs.forEach(input => {
      input.addEventListener('change', applyFilters);
    });

    sortSelect?.addEventListener('change', applyFilters);

    clearBtn?.addEventListener('click', () => {
      filterInputs.forEach(input => {
        if (input.value === '') input.checked = true;
      });
      if (sortSelect) sortSelect.value = 'featured';
      applyFilters();
    });
  }

  function applyFilters() {
    const category = (document.querySelector('input[name="category"]:checked') as HTMLInputElement)?.value || '';
    const type = (document.querySelector('input[name="type"]:checked') as HTMLInputElement)?.value || '';
    const stock = (document.querySelector('input[name="stock"]:checked') as HTMLInputElement)?.value || '';
    const sort = (document.getElementById('sortSelect') as HTMLSelectElement)?.value || 'featured';

    const grid = document.getElementById('productsGrid');
    const cards = Array.from(grid?.querySelectorAll('.product-card') || []) as HTMLElement[];
    let visible = 0;

    cards.forEach(card => {
      let show = true;

      if (category && card.dataset.category !== category) show = false;
      if (type && card.dataset.type !== type) show = false;
      if (stock === 'in-stock' && card.dataset.stock === 'out-of-stock') show = false;
      if (stock === 'on-sale' && card.dataset.sale !== 'true') show = false;

      card.classList.toggle('hidden', !show);
      if (show) visible++;
    });

    // Sort visible cards
    const visibleCards = cards.filter(c => !c.classList.contains('hidden'));
    visibleCards.sort((a, b) => {
      switch (sort) {
        case 'featured':
          if (a.dataset.featured === 'true' && b.dataset.featured !== 'true') return -1;
          if (a.dataset.featured !== 'true' && b.dataset.featured === 'true') return 1;
          return 0;
        case 'newest':
          return new Date(b.dataset.created || 0).getTime() - new Date(a.dataset.created || 0).getTime();
        case 'price-low':
          return parseFloat(a.dataset.price || '0') - parseFloat(b.dataset.price || '0');
        case 'price-high':
          return parseFloat(b.dataset.price || '0') - parseFloat(a.dataset.price || '0');
        case 'name':
          return (a.dataset.name || '').localeCompare(b.dataset.name || '');
        default:
          return 0;
      }
    });

    visibleCards.forEach(card => grid?.appendChild(card));

    const countEl = document.getElementById('visibleCount');
    if (countEl) countEl.textContent = String(visible);
  }

  // Quick View
  function setupQuickView() {
    document.querySelectorAll('.quick-view-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const productData = JSON.parse((btn as HTMLElement).dataset.product || '{}');
        openQuickView(productData);
      });
    });
  }

  function openQuickView(product: any) {
    currentProduct = product;
    selectedSize = null;
    selectedColor = null;

    const modal = document.getElementById('quickViewModal');
    
    // Populate modal
    (document.getElementById('modalCategory') as HTMLElement).textContent = product.categoryName || 'Fresh Wax';
    (document.getElementById('modalName') as HTMLElement).textContent = product.name;
    (document.getElementById('modalDescription') as HTMLElement).textContent = product.description || 'No description available.';

    // Price
    const priceEl = document.getElementById('modalPrice') as HTMLElement;
    if (product.onSale && product.salePrice) {
      priceEl.innerHTML = `<span class="text-red-600">Â£${product.salePrice.toFixed(2)}</span> <span class="text-base text-gray-400 line-through">Â£${product.retailPrice.toFixed(2)}</span>`;
    } else {
      priceEl.textContent = `Â£${product.retailPrice.toFixed(2)}`;
    }

    // Images
    const mainImg = document.getElementById('modalMainImage') as HTMLImageElement;
    const thumbs = document.getElementById('modalThumbnails') as HTMLElement;
    
    // Set alt text for accessibility
    mainImg.alt = product.name + ' - Fresh Wax merchandise';
    
    const images = product.images || [];
    if (images.length === 0 && product.primaryImage) {
      images.push({ url: product.primaryImage });
    }

    if (images.length > 0) {
      mainImg.src = images[0].url || images[0];
      
      if (images.length > 1) {
        thumbs.innerHTML = images.map((img: any, idx: number) => {
          const url = img.url || img;
          return `<img src="${url}" alt="${product.name} thumbnail ${idx + 1}" class="w-16 h-16 object-cover border-2 ${idx === 0 ? 'border-black' : 'border-transparent'} cursor-pointer hover:border-black transition-colors" data-idx="${idx}" />`;
        }).join('');
        thumbs.style.display = 'flex';

        thumbs.querySelectorAll('img').forEach(thumb => {
          thumb.addEventListener('click', () => {
            mainImg.src = (thumb as HTMLImageElement).src;
            thumbs.querySelectorAll('img').forEach(t => t.classList.replace('border-black', 'border-transparent'));
            thumb.classList.replace('border-transparent', 'border-black');
          });
        });
      } else {
        thumbs.style.display = 'none';
      }
    } else {
      mainImg.src = '/logo.webp';
      thumbs.style.display = 'none';
    }

    // Sizes
    const sizesContainer = document.getElementById('modalSizes') as HTMLElement;
    const sizeGrid = document.getElementById('modalSizeGrid') as HTMLElement;

    if (product.hasSizes && product.sizes?.length > 0) {
      sizeGrid.innerHTML = product.sizes.map((size: string) => 
        `<button class="size-btn px-4 py-2 border-2 border-gray-300 font-medium text-sm hover:border-black transition-colors" data-size="${size}">${size}</button>`
      ).join('');
      sizesContainer.classList.remove('hidden');

      sizeGrid.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          sizeGrid.querySelectorAll('.size-btn').forEach(b => b.classList.remove('bg-black', 'text-white', 'border-black'));
          btn.classList.add('bg-black', 'text-white', 'border-black');
          selectedSize = (btn as HTMLElement).dataset.size || null;
          updateAddToCartBtn();
        });
      });
    } else {
      sizesContainer.classList.add('hidden');
    }

    // Colors
    const colorsContainer = document.getElementById('modalColors') as HTMLElement;
    const colorGrid = document.getElementById('modalColorGrid') as HTMLElement;

    if (product.hasColors && product.colors?.length > 0) {
      colorGrid.innerHTML = product.colors.map((color: any) => 
        `<button class="color-btn w-10 h-10 border-2 border-gray-300 hover:border-black transition-colors relative" data-color="${color.name}" style="background-color: ${color.hex || '#ccc'}" title="${color.name}"></button>`
      ).join('');
      colorsContainer.classList.remove('hidden');

      colorGrid.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          colorGrid.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-2', 'ring-black', 'ring-offset-2'));
          btn.classList.add('ring-2', 'ring-black', 'ring-offset-2');
          selectedColor = (btn as HTMLElement).dataset.color || null;
          updateAddToCartBtn();
        });
      });
    } else {
      colorsContainer.classList.add('hidden');
    }

    // Stock
    const stockEl = document.getElementById('modalStock') as HTMLElement;
    const dotClass = product.stockStatus === 'out-of-stock' ? 'bg-gray-400' 
                   : product.stockStatus === 'low-stock' ? 'bg-amber-500' 
                   : 'bg-green-500';
    stockEl.innerHTML = `<span class="w-2 h-2 rounded-full ${dotClass}"></span><span>${product.stockLabel}</span>`;

    updateAddToCartBtn();

    // Show modal
    modal?.classList.remove('invisible', 'opacity-0');
    modal?.querySelector('.bg-white')?.classList.remove('translate-y-5');
    document.body.style.overflow = 'hidden';
  }

  function updateAddToCartBtn() {
    const btn = document.getElementById('addToCartBtn') as HTMLButtonElement;
    if (!currentProduct || !btn) return;

    if (currentProduct.stockStatus === 'out-of-stock') {
      btn.disabled = true;
      btn.textContent = 'Out of Stock';
      return;
    }

    const needsSize = currentProduct.hasSizes && currentProduct.sizes?.length > 0;
    const needsColor = currentProduct.hasColors && currentProduct.colors?.length > 0;

    if ((needsSize && !selectedSize) || (needsColor && !selectedColor)) {
      btn.disabled = true;
      btn.textContent = 'Select Options';
    } else {
      btn.disabled = false;
      btn.textContent = 'Add to Cart';
    }
  }

  // Modal controls
  function setupModal() {
    const modal = document.getElementById('quickViewModal');
    const closeBtn = document.getElementById('closeModal');
    const addBtn = document.getElementById('addToCartBtn');

    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
    addBtn?.addEventListener('click', addToCart);
  }

  function closeModal() {
    const modal = document.getElementById('quickViewModal');
    modal?.classList.add('opacity-0');
    modal?.querySelector('.bg-white')?.classList.add('translate-y-5');
    setTimeout(() => {
      modal?.classList.add('invisible');
      document.body.style.overflow = '';
    }, 300);
    currentProduct = null;
  }

  function addToCart() {
    if (!currentProduct) return;

    // Check if user is allowed to make purchases
    if (!userCanPurchase) {
      alert('Artist accounts cannot make purchases. Please create a separate customer account to buy items from the store.');
      return;
    }

    // Get customer ID from cookie
    const cookies = document.cookie.split(';');
    let customerId = null;
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'customerId' && value) {
        customerId = value;
        break;
      }
    }

    if (!customerId) {
      window.location.href = '/login?redirect=/merch';
      return;
    }

    // Use customer-specific cart key
    const cartKey = 'freshwax_cart_' + customerId;
    let cartData = { items: [] };
    try {
      const stored = localStorage.getItem(cartKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        cartData = parsed.items ? parsed : { items: parsed };
      }
    } catch (e) {
      console.error('[Merch] Cart parse error:', e);
    }

    const cart = cartData.items || [];
    const price = currentProduct.onSale && currentProduct.salePrice 
      ? currentProduct.salePrice 
      : currentProduct.retailPrice;

    const cartItem = {
      id: currentProduct.id,
      productId: currentProduct.id,
      type: 'merch',
      format: 'merch',
      name: currentProduct.name,
      title: currentProduct.name,
      price,
      image: currentProduct.primaryImage || currentProduct.images?.[0]?.url || '/logo.webp',
      artwork: currentProduct.primaryImage || currentProduct.images?.[0]?.url || '/logo.webp',
      size: selectedSize,
      color: selectedColor,
      quantity: 1
    };

    const variantKey = `${cartItem.id}-${cartItem.size || 'onesize'}-${cartItem.color || 'default'}`;
    const existingIdx = cart.findIndex((item: any) => {
      const itemKey = `${item.id}-${item.size || 'onesize'}-${item.color || 'default'}`;
      return itemKey === variantKey && item.type === 'merch';
    });

    if (existingIdx >= 0) {
      cart[existingIdx].quantity = (cart[existingIdx].quantity || 1) + 1;
    } else {
      cart.push(cartItem);
    }

    // Save to customer-specific cart
    const newCartData = {
      items: cart,
      updatedAt: new Date().toISOString()
    };
    localStorage.setItem(cartKey, JSON.stringify(newCartData));
    
    // Dispatch both event types for compatibility
    window.dispatchEvent(new CustomEvent('cart-updated', { detail: newCartData }));
    window.dispatchEvent(new CustomEvent('cartUpdated', { detail: newCartData }));

    // Update cart badge
    if (window.FreshWaxCart) {
      window.FreshWaxCart.updateBadge();
    }

    showToast('Added to cart!');
    closeModal();
  }

  function showToast(message: string) {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.classList.remove('translate-y-24', 'opacity-0');
    
    setTimeout(() => {
      toast.classList.add('translate-y-24', 'opacity-0');
    }, 3000);
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('astro:page-load', init);
</script>

<style>
  /* Full Height Layout */
  .merch-layout {
    display: flex;
    min-height: calc(100vh - 80px); /* Subtract header height */
  }

  /* Sidebar - Fixed Full Height */
  .merch-sidebar {
    width: 260px;
    background: #000;
    flex-shrink: 0;
    position: fixed;
    top: 80px; /* Header height */
    left: 0;
    height: calc(100vh - 80px);
    overflow-y: auto;
    z-index: 40;
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 2px solid #fff;
  }

  /* Add left margin to content to account for fixed sidebar */
  .merch-content {
    margin-left: 260px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .sidebar-inner {
    padding: 3rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    width: 100%;
  }

  .filter-section {
    background: #1a1a1a;
    border: 2px solid #333;
  }

  .filter-header {
    background: #dc2626;
    color: white;
    padding: 0.75rem 1rem;
    font-weight: 700;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .filter-options {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    color: #ccc;
    font-size: 0.875rem;
    transition: color 0.2s;
  }

  .filter-option:hover {
    color: #dc2626;
  }

  .filter-radio {
    width: 1rem;
    height: 1rem;
    accent-color: #dc2626;
  }

  .clear-filters-btn {
    width: 100%;
    padding: 0.75rem;
    background: #333;
    border: 2px solid #555;
    color: white;
    font-weight: 700;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .clear-filters-btn:hover {
    background: #dc2626;
    border-color: #dc2626;
  }

  /* Hero Section */
  .merch-hero {
    background: #000;
    color: white;
    padding: 3rem 0;
    position: relative;
    overflow: hidden;
    text-align: center;
  }

  .hero-pattern {
    position: absolute;
    inset: 0;
    opacity: 0.05;
    background-image: url('/logo.webp');
    background-size: 200px;
    background-repeat: repeat;
    filter: grayscale(1);
  }

  .hero-inner {
    position: relative;
    z-index: 10;
    padding: 0 1.5rem;
  }

  .hero-subtitle {
    color: #9ca3af;
    font-size: 1.125rem;
  }

  /* Products Section */
  .products-main {
    background: #f9fafb;
    flex: 1;
    padding: 2rem;
  }

  .products-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .products-count {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .products-count strong {
    color: #000;
  }

  .sort-select {
    padding: 0.5rem 1rem;
    border: 2px solid #000;
    background: white;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .sort-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px #000;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .products-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .products-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1280px) {
    .products-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .product-card {
    max-width: 330px;
    margin: 0 auto;
  }

  .product-card img {
    aspect-ratio: 1;
    object-fit: cover;
  }

  /* Title Styling */
  .merch-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 5.75rem;
    font-weight: 400;
    margin-bottom: 1rem;
    letter-spacing: 0.02em;
    text-shadow: 0 4px 30px rgba(0, 0, 0, 0.7), 0 0 80px rgba(220, 38, 38, 0.2);
    line-height: 0.95;
    text-transform: uppercase;
  }

  @media (min-width: 768px) {
    .merch-title {
      font-size: 6.75rem;
    }
  }

  @media (min-width: 1024px) {
    .merch-title {
      font-size: 7.25rem;
    }
  }

  /* Mobile Responsive */
  @media (max-width: 1023px) {
    .merch-layout {
      flex-direction: column;
    }

    .merch-sidebar {
      width: 100%;
      position: relative;
      top: 0;
      left: 0;
      height: auto;
      border-right: none;
      border-bottom: 2px solid #fff;
    }

    .merch-content {
      margin-left: 0;
    }

    .sidebar-inner {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .clear-filters-btn {
      grid-column: 1 / -1;
    }
  }

  @media (max-width: 640px) {
    .merch-title {
      font-size: 3.25rem;
    }

    .sidebar-inner {
      grid-template-columns: 1fr;
    }

    .products-main {
      padding: 1rem;
    }
  }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .product-card {
    position: relative;
  }
  
  .hidden {
    display: none !important;
  }
</style>