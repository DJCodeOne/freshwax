---
// src/pages/giftcards.astro
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/giftcards.css';

export const prerender = false;

const faqs = [
  {
    question: "How do Fresh Wax gift cards work?",
    answer: "Fresh Wax gift cards are digital vouchers that can be redeemed for store credit. Once redeemed, the value is added to your account balance and can be used towards any purchase including digital downloads, vinyl records, DJ mixes, and merchandise."
  },
  {
    question: "What denominations are available?",
    answer: "We offer gift cards in ¬£10, ¬£25, ¬£50, and ¬£100 denominations. You can also purchase multiple gift cards for larger amounts."
  },
  {
    question: "Do gift cards expire?",
    answer: "No, Fresh Wax gift cards never expire. Once purchased, the credit is valid indefinitely and can be redeemed at any time."
  },
  {
    question: "How do I redeem a gift card?",
    answer: "Sign in to your Fresh Wax account and enter your gift card code in your dashboard or at checkout. The credit will be instantly added to your account balance."
  },
  {
    question: "Can I use a gift card with other payment methods?",
    answer: "Yes, you can combine gift card credit with other payment methods at checkout. If your order total exceeds your gift card balance, you can pay the remaining amount with a card."
  },
  {
    question: "Can I send a gift card to someone else?",
    answer: "Absolutely! When purchasing a gift card, you'll receive a unique code that you can share with the recipient via email, message, or printed card. They can then redeem it on their own account."
  }
];
---

<Layout 
  title="Gift Cards" 
  description="Buy Fresh Wax gift cards for jungle and drum & bass fans. Digital gift cards from ¬£10 to ¬£100, never expire. Perfect for music lovers."
  faqs={faqs}
>
  <Header />
  
  <main class="giftcards-main">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">
        <div class="hero-icon">
          <svg viewBox="0 0 64 64" width="80" height="80">
            <rect x="8" y="28" width="48" height="32" rx="4" fill="#dc2626"/>
            <rect x="28" y="28" width="8" height="32" fill="#b91c1c"/>
            <rect x="8" y="28" width="48" height="8" fill="#ef4444"/>
            <rect x="4" y="16" width="56" height="16" rx="4" fill="#fbbf24"/>
            <rect x="28" y="16" width="8" height="16" fill="#f59e0b"/>
            <path d="M32 16 C32 8, 20 4, 16 12 C14 16, 20 16, 28 16" fill="#dc2626"/>
            <path d="M32 16 C32 8, 44 4, 48 12 C50 16, 44 16, 36 16" fill="#dc2626"/>
          </svg>
        </div>
        <h1>GIFT <span class="red">CARDS</span></h1>
        <p class="hero-subtitle">Give the gift of underground music</p>
      </div>
    </section>
    
    <!-- Redeem Section -->
    <section class="redeem-section">
      <div class="redeem-card">
        <h2>Have a Gift Card?</h2>
        <p>Enter your code in your dashboard or at checkout to credit your account</p>
        
        <div id="redeemContainer">
          <div id="loginPrompt" class="login-prompt">
            <p>Please <a href="/login" id="signInLink">sign in</a> or <a href="/register" id="registerLink">create an account</a> to redeem your gift card.</p>
          </div>
          
          <form id="redeemForm" class="redeem-form hidden">
            <div class="code-input-wrapper">
              <input 
                type="text" 
                id="giftCardCode" 
                placeholder="FWGC-XXXX-XXXX-XXXX" 
                maxlength="19"
                autocomplete="off"
                spellcheck="false"
              />
              <button type="submit" id="redeemBtn">
                <span class="btn-text">Redeem</span>
                <span class="btn-loading hidden">
                  <svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" /></svg>
                </span>
              </button>
            </div>
            <p id="redeemError" class="error-message"></p>
            <p id="redeemSuccess" class="success-message"></p>
          </form>
        </div>
        
        <!-- Current Balance (shown when logged in) -->
        <div id="balanceDisplay" class="balance-display hidden">
          <div class="balance-label">Your Credit Balance</div>
          <div class="balance-amount" id="creditBalance">¬£0.00</div>
          <a href="/account/dashboard#credit" class="view-history-link">View transaction history ‚Üí</a>
        </div>
      </div>
    </section>
    
    <!-- Buy Gift Cards Section -->
    <section class="buy-section">
      <div class="buy-container">
        <h2>Buy a Gift Card</h2>
        <p class="buy-subtitle">Perfect for birthdays, Christmas, or just because. Send credit to any music lover.</p>
        
        <div class="amount-selector">
          <button type="button" class="amount-btn" data-amount="5">¬£5</button>
          <button type="button" class="amount-btn" data-amount="10">¬£10</button>
          <button type="button" class="amount-btn" data-amount="20">¬£20</button>
          <button type="button" class="amount-btn" data-amount="50">¬£50</button>
          <button type="button" class="amount-btn" data-amount="75">¬£75</button>
          <button type="button" class="amount-btn" data-amount="custom">Custom</button>
        </div>
        
        <div id="customAmountWrapper" class="custom-amount-wrapper hidden">
          <label for="customAmount">Enter amount (¬£5 - ¬£500)</label>
          <input type="number" id="customAmount" min="5" max="500" placeholder="Enter amount" />
        </div>
        
        <div class="selected-amount">
          <span class="amount-label">Gift Card Value:</span>
          <span class="amount-value" id="selectedAmount">¬£0</span>
        </div>
        
        <div class="recipient-section">
          <h3 class="recipient-title">Recipient Details</h3>
          
          <div class="recipient-toggle">
            <label class="toggle-option">
              <input type="radio" name="recipientType" value="gift" checked />
              <span class="toggle-label">üéÅ Send as Gift</span>
            </label>
            <label class="toggle-option">
              <input type="radio" name="recipientType" value="self" />
              <span class="toggle-label">üë§ For Myself</span>
            </label>
          </div>
          
          <div id="giftFields" class="gift-fields">
            <div class="form-row">
              <div class="form-group">
                <label for="recipientName">Recipient's Name</label>
                <input type="text" id="recipientName" placeholder="Their name" maxlength="50" />
              </div>
              <div class="form-group">
                <label for="recipientEmail">Recipient's Email *</label>
                <input type="email" id="recipientEmail" placeholder="their@email.com" required />
              </div>
            </div>
            
            <div class="form-group">
              <label for="giftMessage">Personal Message (optional)</label>
              <textarea id="giftMessage" placeholder="Write a message to include in the email..." maxlength="500" rows="3"></textarea>
              <span class="char-count"><span id="messageCount">0</span>/500</span>
            </div>
          </div>
          
          <div id="selfFields" class="self-fields hidden">
            <div class="self-info">
              <p class="self-note">The gift card code will be sent to you:</p>
              <div class="self-details">
                <div class="self-detail-row">
                  <span class="self-label">Name:</span>
                  <span class="self-value" id="selfNameDisplay">-</span>
                </div>
                <div class="self-detail-row">
                  <span class="self-label">Email:</span>
                  <span class="self-value" id="selfEmailDisplay">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Payment Method Selection -->
        <div id="paymentMethodSection" class="payment-method-section hidden">
          <h4>Payment Method</h4>
          <div class="payment-methods">
            <label class="payment-option">
              <input type="radio" name="paymentMethod" value="stripe" checked />
              <span class="payment-label">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                  <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Card
              </span>
            </label>
            <label class="payment-option">
              <input type="radio" name="paymentMethod" value="paypal" />
              <span class="payment-label">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#003087">
                  <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 0 0-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 0 0 .554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.816-5.09a.932.932 0 0 1 .923-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.471z"/>
                </svg>
                PayPal
              </span>
            </label>
          </div>
        </div>

        <div id="purchaseLoginPrompt" class="purchase-login-prompt">
          <p>Please <a href="/login" id="purchaseSignInLink">sign in</a> or <a href="/register" id="purchaseRegisterLink">create an account</a> to purchase a gift card.</p>
        </div>

        <div id="purchaseActions" class="purchase-actions hidden">
          <button id="purchaseBtn" class="purchase-btn" disabled>
            <span class="btn-text">Select an amount</span>
            <span class="btn-loading hidden">
              <svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" /></svg>
              Processing...
            </span>
          </button>
          <p class="payment-note">Secure payment via Stripe or PayPal</p>
        </div>
        
        <p id="purchaseError" class="purchase-error"></p>
        <div id="purchaseSuccess" class="purchase-success hidden">
          <div class="success-icon">‚úÖ</div>
          <h3>Gift Card Sent!</h3>
          <p id="successMessage">Your gift card has been sent successfully.</p>
          <div class="success-details">
            <div class="success-row">
              <span class="success-label">Amount:</span>
              <span class="success-value" id="purchasedAmount">¬£0</span>
            </div>
            <div class="success-row">
              <span class="success-label">Date:</span>
              <span class="success-value" id="purchasedDate">-</span>
            </div>
            <div class="success-row">
              <span class="success-label">Expires:</span>
              <span class="success-value" id="purchasedExpiry">-</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- My Purchased Gift Cards -->
    <section id="myPurchasedCards" class="purchased-section hidden">
      <h2>My Purchased Gift Cards</h2>
      <div id="purchasedCardsList" class="purchased-list">
        <p class="empty-state">Loading...</p>
      </div>
    </section>
    
    <!-- How It Works -->
    <section class="how-it-works">
      <h2>How Gift Cards Work</h2>
      <div class="steps">
        <div class="step">
          <div class="step-number">1</div>
          <h4>Get a Code</h4>
          <p>Receive a gift card code via email or from a friend</p>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <h4>Redeem</h4>
          <p>Enter your code above to add credit to your account</p>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <h4>Shop</h4>
          <p>Use your credit at checkout - it's automatically applied!</p>
        </div>
      </div>
    </section>
    
    <!-- What Can You Buy Section -->
    <section class="info-section">
      <h2 class="info-title">What Can You Buy?</h2>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-icon">üéµ</div>
          <h3>Digital Downloads</h3>
          <p>High-quality WAV and MP3 releases from our catalogue.</p>
        </div>
        <div class="info-card">
          <div class="info-icon">üìÄ</div>
          <h3>Vinyl Records</h3>
          <p>Limited edition pressings and exclusive releases.</p>
        </div>
        <div class="info-card">
          <div class="info-icon">üëï</div>
          <h3>Merchandise</h3>
          <p>Branded t-shirts, hoodies, caps, and accessories.</p>
        </div>
        <div class="info-card">
          <div class="info-icon">üéõÔ∏è</div>
          <h3>Sample Packs</h3>
          <p>Discover new soundscapes, percussion, basslines and voices.</p>
        </div>
      </div>
    </section>
    
  </main>

  <Footer />
</Layout>


<script type="module">
  import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "307622215498",
    appId: "1:307622215498:web:e66cee39e098fe973c7081"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let currentUser = null;
  let selectedAmount = 0;
  
  // Helper to get authenticated user (waits for auth to be ready)
  async function getAuthUser() {
    if (window.authReady) await window.authReady;
    return window.firebaseAuth?.currentUser || window.authUser || auth.currentUser || null;
  }
  
  // Format code as user types
  const codeInput = document.getElementById('giftCardCode');
  if (codeInput) {
    codeInput.addEventListener('input', (e) => {
      let value = e.target.value.toUpperCase().replace(/[^A-HJ-NP-Z2-9]/g, '');
      
      // Add dashes after FWGC and every 4 chars
      if (value.length > 4) {
        const prefix = value.substring(0, 4);
        const rest = value.substring(4);
        const chunks = rest.match(/.{1,4}/g) || [];
        value = prefix + '-' + chunks.join('-');
      }
      
      e.target.value = value;
    });
  }
  
  // Handle redeem form
  const redeemForm = document.getElementById('redeemForm');
  if (redeemForm) {
    redeemForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        document.getElementById('redeemError').textContent = 'Please sign in to redeem';
        document.getElementById('redeemError').style.display = 'block';
        return;
      }
      
      const code = document.getElementById('giftCardCode').value.trim();
      const btn = document.getElementById('redeemBtn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');
      const errorEl = document.getElementById('redeemError');
      const successEl = document.getElementById('redeemSuccess');
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      
      btn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      
      try {
        const response = await fetch('/api/giftcards/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code,
            userId: currentUser.uid
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successEl.textContent = result.message;
          successEl.style.display = 'block';
          document.getElementById('giftCardCode').value = '';
          
          // Update balance display
          const balanceEl = document.getElementById('creditBalance');
          if (balanceEl) {
            balanceEl.textContent = `¬£${result.newBalance.toFixed(2)}`;
          }
        } else {
          errorEl.textContent = result.error || 'Failed to redeem gift card';
          errorEl.style.display = 'block';
        }
      } catch (error) {
        console.error('Redeem error:', error);
        errorEl.textContent = 'Something went wrong. Please try again.';
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }
    });
  }
  
  // Load user balance
  async function loadBalance(user) {
    try {
      const idToken = await user.getIdToken();
      const response = await fetch('/api/giftcards/balance', {
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });
      const result = await response.json();

      if (result.success) {
        const balanceEl = document.getElementById('creditBalance');
        const balanceDisplay = document.getElementById('balanceDisplay');

        if (balanceEl) {
          balanceEl.textContent = `¬£${result.balance.toFixed(2)}`;
        }
        if (balanceDisplay) {
          balanceDisplay.classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Error loading balance:', error);
    }
  }
  
  // Store user display name
  let currentUserName = '';
  
  // Fetch user name from Firestore
  async function fetchUserName(userId) {
    try {
      const response = await fetch(`/api/get-user-type?userId=${userId}`);
      const result = await response.json();
      if (result.success && result.displayName) {
        currentUserName = result.displayName;
      }
    } catch (e) {
      console.log('Could not fetch user name');
    }
  }
  
  // Load user's purchased gift cards
  async function loadPurchasedCards() {
    if (!currentUser) return;
    
    const section = document.getElementById('myPurchasedCards');
    const list = document.getElementById('purchasedCardsList');
    
    if (!section || !list) return;
    
    try {
      const response = await fetch(`/api/giftcards/purchased?userId=${currentUser.uid}`);
      const result = await response.json();
      
      if (result.success && result.purchasedCards.length > 0) {
        section.classList.remove('hidden');
        
        list.innerHTML = result.purchasedCards.map(card => {
          const purchasedDate = new Date(card.purchasedAt).toLocaleDateString('en-GB');
          const expiryDate = card.displayExpiresAt 
            ? new Date(card.displayExpiresAt).toLocaleDateString('en-GB')
            : '1 year from redemption';
          
          const recipient = card.recipientType === 'gift' 
            ? `To: ${card.recipientName || card.recipientEmail}`
            : 'For myself';
          
          return `
            <div class="purchased-card">
              <div class="purchased-card-info">
                <span class="purchased-card-amount">¬£${card.amount}</span>
                <span class="purchased-card-meta">Purchased: ${purchasedDate} ‚Ä¢ Expires: ${expiryDate}</span>
                <span class="purchased-card-recipient">${recipient}</span>
              </div>
              <span class="purchased-card-status sent">Sent</span>
            </div>
          `;
        }).join('');
      } else {
        section.classList.add('hidden');
      }
    } catch (error) {
      console.error('Error loading purchased cards:', error);
      section.classList.add('hidden');
    }
  }
  
  // Update UI based on auth state
  async function updateAuthUI(user) {
    const loginPrompt = document.getElementById('loginPrompt');
    const redeemFormEl = document.getElementById('redeemForm');
    const purchaseLoginPrompt = document.getElementById('purchaseLoginPrompt');
    const purchaseActions = document.getElementById('purchaseActions');
    const paymentMethodSection = document.getElementById('paymentMethodSection');
    const selfEmailDisplay = document.getElementById('selfEmailDisplay');
    const selfNameDisplay = document.getElementById('selfNameDisplay');

    if (user) {
      // User is logged in - hide login prompts, show forms
      loginPrompt?.classList.add('hidden');
      redeemFormEl?.classList.remove('hidden');
      purchaseLoginPrompt?.classList.add('hidden');
      purchaseActions?.classList.remove('hidden');
      paymentMethodSection?.classList.remove('hidden');
      loadBalance(user);
      
      // Fetch user name
      await fetchUserName(user.uid);
      
      // Load purchased gift cards
      loadPurchasedCards();
      
      // Update self displays
      if (selfEmailDisplay) {
        selfEmailDisplay.textContent = user.email || '-';
      }
      if (selfNameDisplay) {
        selfNameDisplay.textContent = currentUserName || user.displayName || user.email?.split('@')[0] || '-';
      }
    } else {
      // User is logged out - show login prompts
      loginPrompt?.classList.remove('hidden');
      redeemFormEl?.classList.add('hidden');
      purchaseLoginPrompt?.classList.remove('hidden');
      purchaseActions?.classList.add('hidden');
      paymentMethodSection?.classList.add('hidden');
      document.getElementById('balanceDisplay')?.classList.add('hidden');
      document.getElementById('myPurchasedCards')?.classList.add('hidden');
      
      // Clear self displays
      if (selfEmailDisplay) {
        selfEmailDisplay.textContent = '-';
      }
      if (selfNameDisplay) {
        selfNameDisplay.textContent = '-';
      }
      currentUserName = '';
    }
  }
  
  // Auth state listener
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    await updateAuthUI(user);
  });
  
  // Handle back/forward navigation (bfcache)
  window.addEventListener('pageshow', async (event) => {
    if (event.persisted) {
      // Page was restored from bfcache, re-check auth
      const user = await getAuthUser();
      currentUser = user;
      updateAuthUI(user);
    }
  });
  
  // Handle login link clicks - check auth state and redirect appropriately
  function handleAuthLinkClick(e) {
    e.preventDefault();
    if (currentUser) {
      // User is logged in, go to dashboard credit section
      window.location.href = '/account/dashboard#credit';
    } else {
      // User is not logged in, go to appropriate page
      const isRegister = e.target.textContent.toLowerCase().includes('create') || 
                         e.target.href?.includes('register');
      window.location.href = isRegister ? '/register' : '/login';
    }
  }
  
  // Attach click handlers to all auth links
  document.getElementById('signInLink')?.addEventListener('click', handleAuthLinkClick);
  document.getElementById('registerLink')?.addEventListener('click', handleAuthLinkClick);
  document.getElementById('purchaseSignInLink')?.addEventListener('click', handleAuthLinkClick);
  document.getElementById('purchaseRegisterLink')?.addEventListener('click', handleAuthLinkClick);
  
  // Amount selection - using event delegation
  const customAmountWrapper = document.getElementById('customAmountWrapper');
  const customAmountInput = document.getElementById('customAmount');
  const selectedAmountDisplay = document.getElementById('selectedAmount');
  const purchaseBtn = document.getElementById('purchaseBtn');

  // Initialize display
  if (selectedAmountDisplay) {
    selectedAmountDisplay.textContent = '¬£0';
  }
  if (purchaseBtn) {
    purchaseBtn.querySelector('.btn-text').textContent = 'Select an amount';
    purchaseBtn.disabled = true;
  }

  function updateSelectedAmount(amount) {
    selectedAmount = amount;
    if (selectedAmountDisplay) {
      selectedAmountDisplay.textContent = `¬£${amount}`;
    }
    if (purchaseBtn) {
      if (amount > 0) {
        purchaseBtn.querySelector('.btn-text').textContent = `Purchase Gift Card - ¬£${amount}`;
        purchaseBtn.disabled = false;
      } else {
        purchaseBtn.querySelector('.btn-text').textContent = 'Select an amount';
        purchaseBtn.disabled = true;
      }
    }
  }

  // Event delegation for amount buttons
  document.querySelector('.amount-selector')?.addEventListener('click', (e) => {
    const btn = e.target.closest('.amount-btn');
    if (!btn) return;

    const amount = btn.dataset.amount;

    // Remove active class from all buttons
    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));

    // Add active to clicked button
    btn.classList.add('active');

    if (amount === 'custom') {
      customAmountWrapper?.classList.remove('hidden');
      const customVal = parseInt(customAmountInput?.value) || 0;
      updateSelectedAmount(customVal >= 5 ? customVal : 0);
    } else {
      customAmountWrapper?.classList.add('hidden');
      updateSelectedAmount(parseInt(amount));
    }
  });

  customAmountInput?.addEventListener('input', (e) => {
    let value = parseInt(e.target.value) || 0;
    if (value > 500) {
      value = 500;
      e.target.value = 500;
    }
    updateSelectedAmount(value >= 5 ? value : 0);
  });
  
  // Recipient type toggle
  const recipientTypeInputs = document.querySelectorAll('input[name="recipientType"]');
  const giftFields = document.getElementById('giftFields');
  const selfFields = document.getElementById('selfFields');
  
  recipientTypeInputs.forEach(input => {
    input.addEventListener('change', () => {
      if (input.value === 'gift') {
        giftFields?.classList.remove('hidden');
        selfFields?.classList.add('hidden');
      } else {
        giftFields?.classList.add('hidden');
        selfFields?.classList.remove('hidden');
        
        // Update self displays with current user info
        const selfEmailDisplay = document.getElementById('selfEmailDisplay');
        const selfNameDisplay = document.getElementById('selfNameDisplay');
        
        if (currentUser) {
          if (selfEmailDisplay) {
            selfEmailDisplay.textContent = currentUser.email || '-';
          }
          if (selfNameDisplay) {
            selfNameDisplay.textContent = currentUserName || currentUser.displayName || currentUser.email?.split('@')[0] || '-';
          }
        }
      }
    });
  });
  
  // Message character count
  const giftMessage = document.getElementById('giftMessage');
  const messageCount = document.getElementById('messageCount');
  
  giftMessage?.addEventListener('input', () => {
    if (messageCount) {
      messageCount.textContent = giftMessage.value.length;
    }
  });
  
  // Purchase gift card
  purchaseBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    
    const errorEl = document.getElementById('purchaseError');
    
    if (!currentUser) {
      errorEl.textContent = 'Please sign in to purchase';
      errorEl.style.display = 'block';
      return;
    }
    
    // Validate amount is selected
    if (!selectedAmount || selectedAmount < 5) {
      errorEl.textContent = 'Please select an amount (minimum ¬£5)';
      errorEl.style.display = 'block';
      return;
    }
    
    const recipientType = document.querySelector('input[name="recipientType"]:checked')?.value || 'gift';
    const recipientName = document.getElementById('recipientName')?.value.trim() || '';
    const recipientEmail = document.getElementById('recipientEmail')?.value.trim() || '';
    const message = document.getElementById('giftMessage')?.value.trim() || '';
    
    // Validate recipient email for gifts
    if (recipientType === 'gift' && !recipientEmail) {
      errorEl.textContent = 'Please enter the recipient\'s email address';
      errorEl.style.display = 'block';
      return;
    }
    
    // Email validation
    if (recipientType === 'gift' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(recipientEmail)) {
      errorEl.textContent = 'Please enter a valid email address';
      errorEl.style.display = 'block';
      return;
    }
    
    const successEl = document.getElementById('purchaseSuccess');
    const btnText = purchaseBtn.querySelector('.btn-text');
    const btnLoading = purchaseBtn.querySelector('.btn-loading');
    
    errorEl.style.display = 'none';
    successEl.classList.add('hidden');
    
    purchaseBtn.disabled = true;
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');
    
    // Use user's name for self purchase
    const finalRecipientName = recipientType === 'self'
      ? (currentUserName || currentUser.displayName || currentUser.email?.split('@')[0] || '')
      : recipientName;

    // Get selected payment method
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'stripe';

    const purchaseData = {
      amount: selectedAmount,
      buyerUserId: currentUser.uid,
      buyerEmail: currentUser.email,
      buyerName: currentUserName || currentUser.displayName || '',
      recipientType,
      recipientName: finalRecipientName,
      recipientEmail: recipientType === 'gift' ? recipientEmail : currentUser.email,
      message
    };

    try {
      if (paymentMethod === 'stripe') {
        // Create Stripe checkout session
        const response = await fetch('/api/giftcards/create-stripe-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(purchaseData)
        });
        const result = await response.json();

        if (result.success && result.checkoutUrl) {
          // Redirect to Stripe checkout
          window.location.href = result.checkoutUrl;
        } else {
          errorEl.textContent = result.error || 'Failed to create checkout session';
          errorEl.style.display = 'block';
          purchaseBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
        }
      } else {
        // Create PayPal order
        const response = await fetch('/api/giftcards/create-paypal-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(purchaseData)
        });
        const result = await response.json();

        if (result.success && result.approvalUrl) {
          // Redirect to PayPal approval
          window.location.href = result.approvalUrl;
        } else {
          errorEl.textContent = result.error || 'Failed to create PayPal order';
          errorEl.style.display = 'block';
          purchaseBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
        }
      }
    } catch (error) {
      console.error('Purchase error:', error);
      errorEl.textContent = 'Something went wrong. Please try again.';
      errorEl.style.display = 'block';
      purchaseBtn.disabled = false;
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
    }
  });
</script>
