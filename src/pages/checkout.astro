---
// src/pages/checkout.astro
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/checkout.css';

export const prerender = false;
---

<Layout title="Checkout" noindex={true}>
  <Header />
  
  <main class="checkout-main">
    
    <!-- Page Header -->
    <div class="page-header-container">
      <div class="page-header-pattern"></div>
      <header class="checkout-header">
        <h1>CHECK<span class="red">OUT</span></h1>
        <a href="/cart" class="back-btn">‚Üê Back to Bag</a>
      </header>
    </div>
    
    <!-- PayPal SDK loaded dynamically when needed -->
    
    <div id="error-message" class="error-message"></div>
    
    <div id="checkout-content">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading your cart...</span>
      </div>
    </div>
  </main>

  <Footer />
</Layout>



<script>
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let currentUser = null;
  let customerData = null;
  let cart = [];
  
  function getCustomerIdFromCookie() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'customerId' && value) {
        return value;
      }
    }
    return null;
  }
  
  function loadCart() {
    try {
      const customerId = getCustomerIdFromCookie();
      if (!customerId) {
        cart = [];
        return cart;
      }
      
      const cartKey = 'freshwax_cart_' + customerId;
      const stored = localStorage.getItem(cartKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        cart = parsed.items ? parsed.items : (Array.isArray(parsed) ? parsed : []);
      } else {
        cart = [];
      }
    } catch (e) {
      console.error('[Checkout] Cart parse error:', e);
      cart = [];
    }
    return cart;
  }
  
  // Check for duplicate audio purchases via API
  async function checkDuplicatePurchases(userId) {
    if (!userId) return { duplicates: [], ownedReleases: [] };
    
    try {
      const response = await fetch('/api/check-duplicates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, cartItems: cart })
      });
      
      if (!response.ok) {
        throw new Error('Failed to check duplicates');
      }
      
      const data = await response.json();
      return data;
    } catch (e) {
      console.error('[Checkout] Error checking duplicate purchases:', e);
      return { duplicates: [], ownedReleases: [] };
    }
  }
  
  // Remove duplicate items from cart
  function removeDuplicatesFromCart(duplicates) {
    const customerId = getCustomerIdFromCookie();
    if (!customerId) return;
    
    const duplicateKeys = new Set(duplicates.map(d => {
      const item = d.item;
      if (item.trackId) {
        return `${item.releaseId || item.productId || item.id}_${item.trackId}`;
      }
      return item.releaseId || item.productId || item.id;
    }));
    
    cart = cart.filter(item => {
      const key = item.trackId 
        ? `${item.releaseId || item.productId || item.id}_${item.trackId}`
        : (item.releaseId || item.productId || item.id);
      return !duplicateKeys.has(key);
    });
    
    // Save updated cart
    const cartKey = 'freshwax_cart_' + customerId;
    localStorage.setItem(cartKey, JSON.stringify({ items: cart, updatedAt: Date.now() }));
    
    // Dispatch cart update event
    window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { count: cart.reduce((sum, item) => sum + item.quantity, 0) } }));
  }
  
  function calculateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const hasPhysicalItems = cart.some(item =>
      item.type === 'vinyl' || item.type === 'merch' || item.productType === 'vinyl' || item.productType === 'merch'
    );

    // Free orders: no shipping, no fees
    if (subtotal === 0) {
      return { subtotal: 0, shipping: 0, hasPhysicalItems, freshWaxFee: 0, stripeFee: 0, serviceFees: 0, total: 0 };
    }

    const shipping = hasPhysicalItems ? (subtotal >= 50 ? 0 : 4.99) : 0;

    // Bandcamp-style pricing: fees come OUT of the sale, not added on top
    // Customer pays exactly what's displayed (subtotal + shipping)
    // Fees are deducted from artist payout, not charged to customer
    const total = subtotal + shipping;

    // Calculate fees for backend/payout purposes (deducted from artist share)
    const freshWaxFee = subtotal * 0.01; // 1% Fresh Wax platform fee
    const stripeFee = (total * 0.014) + 0.20; // Stripe processing fee
    const serviceFees = freshWaxFee + stripeFee;

    return { subtotal, shipping, hasPhysicalItems, freshWaxFee, stripeFee, serviceFees, total };
  }
  
  function getBadgeStyle(type) {
    if (type === 'vinyl') return 'background: #000; color: #fff; border-color: #fff;';
    if (type === 'merch') return 'background: #1e1b4b; color: #a5b4fc; border-color: #a5b4fc;';
    return 'background: #052e16; color: #22c55e; border-color: #22c55e;';
  }
  
  async function loadCustomerData(uid) {
    try {
      
      // Try customers collection first - direct document lookup
      const customerDoc = await getDoc(doc(db, 'customers', uid));
      if (customerDoc.exists()) {
        const data = customerDoc.data();
        return data;
      }
      
      // Try querying customers by uid field
      const customersRef = collection(db, 'customers');
      const q = query(customersRef, where('uid', '==', uid));
      const customerSnap = await getDocs(q);
      if (!customerSnap.empty) {
        const data = customerSnap.docs[0].data();
        return data;
      }
      
      // Try users collection
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        return data;
      }
      
    } catch (e) {
      console.error('[Checkout] Error loading customer data:', e);
    }
    return null;
  }
  
  // Postcode lookup function - uses free postcodes.io API
  // Validates postcode and auto-fills city/county (street address entered manually)
  async function lookupPostcode() {
    const postcodeInput = document.getElementById('postcodeSearch');
    const findBtn = document.getElementById('findAddressBtn');
    const manualEntry = document.getElementById('manualAddressFields');
    const manualEntryLink = document.getElementById('manualEntryLink');
    const lookupError = document.getElementById('lookupError');
    
    const postcode = postcodeInput.value.trim();
    
    if (!postcode) {
      lookupError.textContent = 'Please enter a postcode';
      lookupError.style.color = '#ff6b6b';
      lookupError.style.display = 'block';
      return;
    }
    
    // Update button state
    findBtn.disabled = true;
    findBtn.textContent = 'Validating...';
    lookupError.style.display = 'none';
    
    try {
      const response = await fetch(`/api/postcode-lookup?postcode=${encodeURIComponent(postcode)}`);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Postcode not found');
      }
      
      // Postcode validated! Auto-fill the location fields
      document.getElementById('postcode').value = data.postcode;
      document.getElementById('city').value = data.city || '';
      document.getElementById('county').value = data.county || '';
      
      // Show success message
      lookupError.textContent = '‚úì Postcode verified! Please enter your street address below.';
      lookupError.style.color = '#22c55e';
      lookupError.style.display = 'block';
      
      // Show address fields for manual entry
      manualEntry.style.display = 'block';
      if (manualEntryLink) manualEntryLink.style.display = 'none';
      
      // Focus on address line 1 for quick entry
      setTimeout(() => {
        document.getElementById('address1')?.focus();
      }, 100);
      
    } catch (error) {
      lookupError.textContent = error.message || 'Failed to lookup postcode';
      lookupError.style.color = '#ff6b6b';
      lookupError.style.display = 'block';
      // Show manual fields on error so user can still proceed
      manualEntry.style.display = 'block';
      if (manualEntryLink) manualEntryLink.style.display = 'none';
    } finally {
      findBtn.disabled = false;
      findBtn.textContent = 'Verify Postcode';
    }
  }
  
  // Handle address selection (kept for backwards compatibility)
  function handleAddressSelect(event) {
    const value = event.target.value;
    const manualEntry = document.getElementById('manualAddressFields');
    manualEntry.style.display = 'block';
  }
  
  function renderCheckout() {
    const container = document.getElementById('checkout-content');
    loadCart();
    
    if (cart.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 4rem 2rem; background: #fff; border: 2px solid #d1d5db; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.5;">üõí</div>
          <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 2rem; margin-bottom: 0.75rem; color: #dc2626;">YOUR CART IS EMPTY</h2>
          <p style="font-size: 1rem; color: #6b7280; margin-bottom: 2rem;">Add some items before checking out.</p>
          <a href="/" style="display: inline-block; padding: 0.875rem 2rem; background: #dc2626; color: #fff; text-decoration: none; border-radius: 8px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.125rem; letter-spacing: 0.04em;">BROWSE STORE</a>
        </div>
      `;
      return;
    }
    
    const { subtotal, shipping, hasPhysicalItems, freshWaxFee, stripeFee, serviceFees, total } = calculateTotals();
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Pre-fill from customer data
    const cd = customerData || {};
    
    const email = currentUser?.email || cd.email || '';
    const firstName = cd.firstName || cd.name?.split(' ')[0] || '';
    const lastName = cd.lastName || cd.name?.split(' ').slice(1).join(' ') || '';
    const phone = cd.phone || '';
    const address1 = cd.address1 || cd.addressLine1 || '';
    const address2 = cd.address2 || cd.addressLine2 || '';
    const city = cd.city || '';
    const county = cd.county || '';
    const postcode = cd.postcode || '';
    const country = cd.country || 'United Kingdom';
    
    
    // Check if we have saved address data
    const hasSavedAddress = address1 && city && postcode;
    
    container.innerHTML = `
      <form id="checkoutForm">
        <!-- Order Items -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 1.5rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.75rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">YOUR ORDER</h2>
            <span style="font-size: 1.125rem; color: #d1d5db; font-weight: 500;">${itemCount} ${itemCount === 1 ? 'item' : 'items'}</span>
          </div>
          <div style="padding: 1.25rem;">
            <div style="display: flex; flex-direction: column; gap: 0.875rem;">
              ${cart.map(item => {
                const itemType = item.type || item.productType || 'digital';
                const artistName = item.artist || '';
                return `
                <article style="display: flex; align-items: center; gap: 1.25rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="width: 70px; height: 70px; border-radius: 6px; overflow: hidden; background: #e5e7eb; border: 1px solid #d1d5db; flex-shrink: 0;">
                    <img src="${item.image}" alt="${item.name}" style="width: 70px; height: 70px; object-fit: cover; display: block;">
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <h3 style="margin: 0 0 0.25rem 0; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.375rem; color: #dc2626; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.02em;">${item.name}</h3>
                    ${artistName ? `<p style="margin: 0 0 0.375rem 0; font-size: 1rem; color: #6b7280;">${artistName}</p>` : ''}
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                      <span style="display: inline-block; padding: 0.2rem 0.5rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; border-radius: 3px; border: 1px solid; ${getBadgeStyle(itemType)}">${itemType}</span>
                      ${item.color ? `<span style="font-size: 0.9375rem; color: #6b7280;">${typeof item.color === 'object' ? item.color.name : item.color}</span>` : ''}
                      ${item.size ? `<span style="font-size: 0.9375rem; color: #6b7280;">Size: ${item.size}</span>` : ''}
                      ${item.quantity > 1 ? `<span style="font-size: 0.9375rem; color: #6b7280;">√ó${item.quantity}</span>` : ''}
                    </div>
                  </div>
                  <div style="text-align: right; flex-shrink: 0;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: #16a34a;">¬£${(item.price * item.quantity).toFixed(2)}</div>
                    ${item.quantity > 1 ? `<div style="font-size: 0.875rem; color: #6b7280;">¬£${item.price.toFixed(2)} each</div>` : ''}
                  </div>
                </article>
              `}).join('')}
            </div>
            
            <!-- Totals -->
            <div style="display: flex; flex-direction: column; gap: 0.625rem; padding: 1.25rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 1.25rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.125rem; color: #6b7280;">Subtotal</span>
                <span style="font-size: 1.25rem; font-weight: 600; color: #111827;">¬£${subtotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.125rem; color: #6b7280;">Shipping</span>
                <span style="font-size: 1.25rem; font-weight: 600; color: #16a34a;">${hasPhysicalItems ? (shipping === 0 ? 'FREE' : '¬£' + shipping.toFixed(2)) : 'Digital'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; margin-top: 0.625rem; border-top: 2px solid #dc2626;">
                <span style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; letter-spacing: 0.04em; color: #111827;">TOTAL</span>
                <span style="font-size: 1.875rem; font-weight: 700; color: #dc2626;">¬£${total.toFixed(2)}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Contact Details -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="padding: 1rem 1.25rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">CONTACT DETAILS</h2>
          </div>
          <div style="padding: 1.25rem;">
            <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="firstName" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">First Name *</label>
                <input type="text" id="firstName" name="firstName" required placeholder="John" value="${firstName}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="lastName" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required placeholder="Doe" value="${lastName}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
            </div>
            <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="email" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Email Address *</label>
                <input type="email" id="email" name="email" required placeholder="you@example.com" value="${email}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="phone" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Phone Number</label>
                <input type="tel" id="phone" name="phone" placeholder="+44 7XXX XXXXXX" value="${phone}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
            </div>
          </div>
        </div>
        
        ${hasPhysicalItems ? `
        <!-- Postal Address -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="padding: 1rem 1.25rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">POSTAL ADDRESS</h2>
          </div>
          <div style="padding: 1.25rem;">
            
            <!-- Postcode Lookup -->
            <div style="margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px solid #e5e7eb;">
              <label style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em; display: block; margin-bottom: 0.375rem;">Verify Your Postcode</label>
              <div class="postcode-lookup-row" style="display: flex; gap: 0.75rem;">
                <input type="text" id="postcodeSearch" placeholder="Enter postcode (e.g. E1 6AN)" value="${postcode}" style="flex: 1; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit; text-transform: uppercase;">
                <button type="button" id="findAddressBtn" onclick="lookupPostcode()" style="padding: 0.875rem 1.25rem; background: #dc2626; color: #fff; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                  Verify
                </button>
              </div>
              <div id="lookupError" style="margin-top: 0.5rem; font-size: 0.8125rem; color: #dc2626; display: none;"></div>
            </div>
            
            <!-- Manual Address Fields -->
            <div id="manualAddressFields" style="display: ${hasSavedAddress ? 'block' : 'none'};">
              <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="address1" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Address Line 1 *</label>
                  <input type="text" id="address1" name="address1" required placeholder="123 Music Street" value="${address1}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="address2" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Address Line 2</label>
                  <input type="text" id="address2" name="address2" placeholder="Flat 4B" value="${address2}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
              </div>
              <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="city" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">City *</label>
                  <input type="text" id="city" name="city" required placeholder="London" value="${city}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="postcode" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Postcode *</label>
                  <input type="text" id="postcode" name="postcode" required placeholder="E1 6AN" value="${postcode}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit; text-transform: uppercase;">
                </div>
              </div>
              <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="county" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">County</label>
                  <input type="text" id="county" name="county" placeholder="Greater London" value="${county}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="country" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Country *</label>
                  <select id="country" name="country" required style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit; cursor: pointer;">
                    <option value="United Kingdom" ${country === 'United Kingdom' ? 'selected' : ''}>United Kingdom</option>
                    <option value="Ireland" ${country === 'Ireland' ? 'selected' : ''}>Ireland</option>
                    <option value="Germany" ${country === 'Germany' ? 'selected' : ''}>Germany</option>
                    <option value="France" ${country === 'France' ? 'selected' : ''}>France</option>
                    <option value="Netherlands" ${country === 'Netherlands' ? 'selected' : ''}>Netherlands</option>
                    <option value="Belgium" ${country === 'Belgium' ? 'selected' : ''}>Belgium</option>
                    <option value="USA" ${country === 'USA' ? 'selected' : ''}>United States</option>
                    <option value="Canada" ${country === 'Canada' ? 'selected' : ''}>Canada</option>
                    <option value="Australia" ${country === 'Australia' ? 'selected' : ''}>Australia</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Enter Manually Link (shown when fields hidden) -->
            <div id="manualEntryLink" style="display: ${hasSavedAddress ? 'none' : 'block'}; margin-top: 0.75rem;">
              <button type="button" onclick="document.getElementById('manualAddressFields').style.display='block'; document.getElementById('manualEntryLink').style.display='none';" style="background: none; border: none; color: #60a5fa; font-size: 0.875rem; cursor: pointer; text-decoration: underline;">
                Or enter address manually
              </button>
            </div>
            
            ${currentUser ? `
            <label style="display: flex; align-items: center; gap: 0.75rem; margin-top: 1.25rem; padding: 1rem; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; cursor: pointer;">
              <input type="checkbox" id="saveDetails" name="saveDetails" style="width: 20px; height: 20px; accent-color: #dc2626; cursor: pointer;">
              <span style="font-size: 0.875rem; color: #1e40af; font-weight: 500;">Save these details for faster checkout</span>
            </label>
            ` : ''}
          </div>
        </div>
        ` : ''}
        
        <!-- Payment / Complete Order Section -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="padding: 1rem 1.25rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">${total === 0 ? 'COMPLETE ORDER' : 'PAYMENT METHOD'}</h2>
          </div>
          <div style="padding: 1.25rem;">
            ${total === 0 ? `
            <!-- Free Order - No Payment Required -->
            <div style="text-align: center; margin-bottom: 1.25rem;">
              <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: #dcfce7; border: 2px solid #16a34a; border-radius: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span style="font-size: 1.125rem; font-weight: 700; color: #16a34a;">FREE ORDER - No Payment Required</span>
              </div>
            </div>
            <button type="submit" id="submitBtn" style="width: 100%; padding: 1rem; background: #16a34a; color: #fff; border: none; border-radius: 10px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.375rem; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s;">
              COMPLETE FREE ORDER
            </button>
            ` : `
            <!-- Payment Options -->
            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.25rem;">
              <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; background: #f9fafb; border: 2px solid #d1d5db; border-radius: 10px; cursor: pointer; transition: all 0.2s;" id="stripeOption" onclick="selectPaymentMethod('stripe')">
                <input type="radio" name="paymentMethod" value="stripe" checked style="width: 20px; height: 20px; accent-color: #dc2626;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #111827; font-size: 1rem;">Credit / Debit Card</div>
                  <div style="font-size: 0.8125rem; color: #6b7280;">Visa, Mastercard, Amex</div>
                </div>
                <svg width="40" height="25" viewBox="0 0 40 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect width="40" height="25" rx="3" fill="#635BFF"/>
                  <path d="M17.5 16.5L19.5 8.5H22L20 16.5H17.5Z" fill="white"/>
                  <path d="M28.5 8.7C28 8.5 27.2 8.3 26.2 8.3C23.8 8.3 22.1 9.5 22.1 11.2C22.1 12.5 23.3 13.2 24.2 13.6C25.1 14 25.4 14.3 25.4 14.7C25.4 15.3 24.7 15.6 24 15.6C23 15.6 22.5 15.5 21.7 15.1L21.4 15L21.1 17C21.7 17.3 22.8 17.5 24 17.5C26.5 17.5 28.2 16.3 28.2 14.5C28.2 13.5 27.5 12.7 26.2 12.1C25.4 11.7 24.9 11.4 24.9 11C24.9 10.6 25.4 10.2 26.3 10.2C27.1 10.2 27.7 10.4 28.1 10.5L28.4 10.6L28.5 8.7Z" fill="white"/>
                  <path d="M32.5 8.5H30.5C29.9 8.5 29.4 8.7 29.2 9.3L25.7 16.5H28.2L28.7 15.1H31.7L32 16.5H34.2L32.5 8.5ZM29.4 13.3C29.6 12.8 30.5 10.5 30.5 10.5C30.5 10.5 30.7 10 30.8 9.6L31 10.4C31 10.4 31.5 12.6 31.6 13.3H29.4Z" fill="white"/>
                  <path d="M15.2 8.5L12.8 14L12.5 12.5C12 11.1 10.7 9.5 9.2 8.7L11.3 16.5H13.9L17.8 8.5H15.2Z" fill="white"/>
                  <path d="M11 8.5H7.1L7 8.7C10 9.5 12 11.5 12.5 13.5L11.9 9.4C11.8 8.7 11.4 8.5 11 8.5Z" fill="#FAA61A"/>
                </svg>
              </label>

              <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; background: #f9fafb; border: 2px solid #d1d5db; border-radius: 10px; cursor: pointer; transition: all 0.2s;" id="paypalOption" onclick="selectPaymentMethod('paypal')">
                <input type="radio" name="paymentMethod" value="paypal" style="width: 20px; height: 20px; accent-color: #dc2626;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #111827; font-size: 1rem;">PayPal</div>
                  <div style="font-size: 0.8125rem; color: #6b7280;">Pay securely with PayPal</div>
                </div>
                <svg width="80" height="22" viewBox="0 0 101 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12.237 4.5H7.55c-.3 0-.56.217-.61.515L5.176 16.84c-.036.22.135.42.36.42h2.23c.3 0 .56-.217.61-.515l.48-3.07c.05-.298.31-.515.61-.515h1.4c2.92 0 4.6-1.412 5.04-4.212.2-1.225.008-2.188-.57-2.862-.63-.74-1.75-1.135-3.1-1.135zm.51 4.15c-.24 1.6-1.46 1.6-2.64 1.6h-.67l.47-2.99c.028-.18.18-.31.36-.31h.31c.8 0 1.56 0 1.95.456.23.273.3.678.22 1.244z" fill="#253B80"/>
                  <path d="M32.69 8.59h-2.24c-.18 0-.33.13-.36.31l-.1.61-.15-.22c-.47-.68-1.51-.91-2.55-.91-2.39 0-4.43 1.81-4.83 4.35-.21 1.27.09 2.48.82 3.33.67.78 1.62 1.1 2.76 1.1 1.95 0 3.03-1.25 3.03-1.25l-.1.6c-.04.22.13.42.36.42h2.01c.3 0 .56-.22.61-.52l1.2-7.6c.04-.22-.13-.42-.36-.42zm-3.05 4.21c-.21 1.24-1.2 2.08-2.46 2.08-.63 0-1.14-.2-1.46-.59-.32-.38-.44-.93-.34-1.53.2-1.23 1.21-2.09 2.45-2.09.62 0 1.12.21 1.45.6.34.4.47.95.36 1.53z" fill="#253B80"/>
                  <path d="M49.63 8.59h-2.25c-.2 0-.39.1-.5.27l-2.9 4.26-1.23-4.1c-.08-.26-.31-.43-.58-.43h-2.21c-.25 0-.42.24-.34.47l2.31 6.8-2.18 3.07c-.17.24 0 .57.29.57h2.24c.2 0 .38-.1.5-.26l6.98-10.08c.17-.24 0-.57-.28-.57z" fill="#253B80"/>
                  <path d="M59.49 4.5h-4.69c-.3 0-.56.217-.61.515l-1.76 11.825c-.04.22.13.42.36.42h2.42c.21 0 .39-.15.43-.36l.5-3.16c.05-.3.31-.52.61-.52h1.4c2.92 0 4.6-1.41 5.04-4.21.2-1.23.01-2.19-.57-2.87-.63-.74-1.75-1.13-3.1-1.13zm.51 4.15c-.24 1.6-1.46 1.6-2.64 1.6h-.67l.47-2.99c.03-.18.18-.31.36-.31h.31c.8 0 1.56 0 1.95.46.23.27.3.68.22 1.24z" fill="#179BD7"/>
                  <path d="M79.95 8.59h-2.24c-.18 0-.33.13-.36.31l-.1.61-.15-.22c-.47-.68-1.51-.91-2.55-.91-2.39 0-4.43 1.81-4.83 4.35-.21 1.27.09 2.48.82 3.33.67.78 1.62 1.1 2.76 1.1 1.95 0 3.03-1.25 3.03-1.25l-.1.6c-.04.22.13.42.36.42h2.01c.3 0 .56-.22.61-.52l1.2-7.6c.04-.22-.13-.42-.36-.42zm-3.05 4.21c-.21 1.24-1.2 2.08-2.46 2.08-.63 0-1.14-.2-1.46-.59-.32-.38-.44-.93-.34-1.53.2-1.23 1.21-2.09 2.45-2.09.62 0 1.12.21 1.45.6.34.4.47.95.36 1.53z" fill="#179BD7"/>
                  <path d="M88.45 4.96l-1.79 11.39c-.04.22.13.42.36.42h1.93c.3 0 .56-.22.61-.52l1.76-11.82c.04-.22-.13-.42-.36-.42h-2.15c-.18 0-.33.13-.36.31z" fill="#179BD7"/>
                </svg>
              </label>
            </div>

            <!-- Stripe Payment Button (shown by default) -->
            <div id="stripePaymentSection">
              <button type="submit" id="submitBtn" style="width: 100%; padding: 1rem; background: #dc2626; color: #fff; border: none; border-radius: 10px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.375rem; font-weight: 400; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s;">
                PAY WITH CARD
              </button>
            </div>

            <!-- PayPal Button Container (hidden by default) -->
            <div id="paypalPaymentSection" style="display: none;">
              <div id="paypal-button-container" style="min-height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center;"></div>
              <p style="text-align: center; font-size: 0.8125rem; color: #6b7280; margin-top: 0.75rem;">
                You'll be redirected to PayPal to complete payment
              </p>
            </div>
            `}

            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; font-size: 0.8125rem; color: #6b7280;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              ${total === 0 ? 'Secure Checkout' : 'Secure, Encrypted Checkout'}
            </div>
          </div>
        </div>
      </form>
    `;
    
    // Show duplicate warning if any found
    if (duplicatePurchases && duplicatePurchases.length > 0) {
      const itemsList = duplicatePurchases.map(d => `<li><strong>${d.item.name}</strong> - ${d.reason}</li>`).join('');
      
      const warningHtml = `
        <div id="duplicate-warning" style="background: #7f1d1d; border: 3px solid #dc2626; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: flex-start; gap: 1rem;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fca5a5" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div style="flex: 1;">
              <h3 style="color: #fca5a5; font-size: 1.125rem; font-weight: 700; margin: 0 0 0.5rem 0;">You Already Own Some Items</h3>
              <p style="color: #fecaca; font-size: 0.9375rem; margin: 0 0 1rem 0;">The following items are already in your purchase history:</p>
              <ul style="color: #fecaca; font-size: 0.875rem; margin: 0 0 1rem 0; padding-left: 1.25rem;">${itemsList}</ul>
              <button type="button" id="removeDuplicatesBtn" style="background: #dc2626; color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9375rem;">
                Remove These Items From Cart
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Insert at top of checkout content
      container.insertAdjacentHTML('afterbegin', warningHtml);
      
      // Add click handler for remove button
      document.getElementById('removeDuplicatesBtn')?.addEventListener('click', () => {
        removeDuplicatesFromCart(duplicatePurchases);
        document.getElementById('duplicate-warning')?.remove();
        duplicatePurchases = [];
        renderCheckout();
      });
    }
    
    // Make postcode lookup available globally
    window.lookupPostcode = lookupPostcode;

    // Make payment method selection available globally
    window.selectPaymentMethod = selectPaymentMethod;

    document.getElementById('checkoutForm').addEventListener('submit', handleSubmit);

    // Initialize PayPal buttons when PayPal is selected
    setupPaymentMethods();
  }

  let selectedPaymentMethod = 'stripe';
  let paypalButtonsRendered = false;

  function selectPaymentMethod(method) {
    selectedPaymentMethod = method;

    const stripeOption = document.getElementById('stripeOption');
    const paypalOption = document.getElementById('paypalOption');
    const stripeSection = document.getElementById('stripePaymentSection');
    const paypalSection = document.getElementById('paypalPaymentSection');

    if (method === 'stripe') {
      stripeOption.style.borderColor = '#dc2626';
      stripeOption.style.background = '#fef2f2';
      paypalOption.style.borderColor = '#d1d5db';
      paypalOption.style.background = '#f9fafb';
      stripeSection.style.display = 'block';
      paypalSection.style.display = 'none';
      document.querySelector('input[name="paymentMethod"][value="stripe"]').checked = true;
    } else {
      paypalOption.style.borderColor = '#dc2626';
      paypalOption.style.background = '#fef2f2';
      stripeOption.style.borderColor = '#d1d5db';
      stripeOption.style.background = '#f9fafb';
      stripeSection.style.display = 'none';
      paypalSection.style.display = 'block';
      document.querySelector('input[name="paymentMethod"][value="paypal"]').checked = true;

      // Load PayPal SDK and render buttons
      loadPayPalSDK();
    }
  }

  function setupPaymentMethods() {
    // Set default styling
    const stripeOption = document.getElementById('stripeOption');
    if (stripeOption) {
      stripeOption.style.borderColor = '#dc2626';
      stripeOption.style.background = '#fef2f2';
    }
  }

  // PayPal SDK loading
  let paypalSDKLoaded = false;
  const PAYPAL_CLIENT_ID = import.meta.env.PUBLIC_PAYPAL_CLIENT_ID || 'AZL6pU1E2TbA9DdGgLvljJsON4-IwXIyWsHhQ_Od-BtMXTZTTgThss7pVuZzscyovO1z7XZRKgLRwpmv';

  function loadPayPalSDK() {
    if (paypalSDKLoaded) {
      renderPayPalButtons();
      return;
    }

    const script = document.createElement('script');
    script.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=GBP&intent=capture`;
    script.async = true;
    script.onload = () => {
      paypalSDKLoaded = true;
      renderPayPalButtons();
    };
    script.onerror = () => {
      console.error('[Checkout] Failed to load PayPal SDK');
      document.getElementById('paypal-button-container').innerHTML = '<p style="color: #dc2626; text-align: center;">Failed to load PayPal. Please try again or use card payment.</p>';
    };
    document.head.appendChild(script);
  }

  function renderPayPalButtons() {
    if (paypalButtonsRendered || !window.paypal) return;

    const container = document.getElementById('paypal-button-container');
    if (!container) return;

    // Set flag immediately to prevent double rendering
    paypalButtonsRendered = true;
    container.innerHTML = '';

    window.paypal.Buttons({
      style: {
        layout: 'vertical',
        color: 'gold',
        shape: 'rect',
        label: 'paypal',
        height: 55
      },

      createOrder: async function(data, actions) {
        // Check email verification for new users - must verify before purchasing
        if (window.FreshWax?.checkEmailVerified) {
          const verified = await window.FreshWax.checkEmailVerified('complete purchases');
          if (!verified) {
            throw new Error('Email verification required');
          }
        }

        const form = document.getElementById('checkoutForm');
        const { subtotal, shipping, hasPhysicalItems, freshWaxFee, stripeFee, serviceFees, total } = calculateTotals();

        // Validate form
        if (!form.checkValidity()) {
          form.reportValidity();
          throw new Error('Please fill in all required fields');
        }

        const orderData = {
          customer: {
            email: form.email.value,
            firstName: form.firstName.value,
            lastName: form.lastName.value,
            phone: form.phone?.value || '',
            userId: currentUser?.uid || null
          },
          shipping: hasPhysicalItems ? {
            address1: form.address1.value,
            address2: form.address2?.value || '',
            city: form.city.value,
            county: form.county?.value || '',
            postcode: form.postcode.value,
            country: form.country.value
          } : null,
          items: cart.map(item => ({
            id: item.id || item.productId,
            productId: item.productId || item.id,
            releaseId: item.releaseId || item.productId || item.id,
            trackId: item.trackId || null,
            name: item.name,
            type: item.type || item.productType,
            price: item.price,
            quantity: item.quantity,
            image: item.image || item.artwork,
            size: item.size || null,
            color: typeof item.color === 'object' ? item.color.name : item.color || null
          })),
          totals: { subtotal, shipping, freshWaxFee, stripeFee, serviceFees, total },
          hasPhysicalItems
        };

        // Create PayPal order
        const response = await fetch('/api/paypal/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Failed to create PayPal order');
        }

        // Store order data for capture
        window.pendingPayPalOrderData = orderData;

        return result.orderId;
      },

      onApprove: async function(data, actions) {
        const errorMsg = document.getElementById('error-message');
        errorMsg.style.display = 'none';

        try {
          // Get idToken if logged in
          let idToken = null;
          if (currentUser) {
            try {
              idToken = await currentUser.getIdToken();
            } catch (e) {
              console.warn('Could not get ID token');
            }
          }

          // Capture the payment
          const response = await fetch('/api/paypal/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paypalOrderId: data.orderID,
              orderData: window.pendingPayPalOrderData,
              idToken
            })
          });

          const result = await response.json();

          if (result.success) {
            // Clear cart
            const customerId = getCustomerIdFromCookie();
            if (customerId) {
              localStorage.removeItem('freshwax_cart_' + customerId);
            }
            localStorage.removeItem('cart');
            window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { items: [] } }));

            // Redirect to confirmation
            window.location.href = `/order-confirmation/${result.orderId}`;
          } else {
            throw new Error(result.error || 'Payment failed');
          }
        } catch (error) {
          console.error('PayPal capture error:', error);
          errorMsg.textContent = error.message || 'Payment failed. Please try again.';
          errorMsg.style.display = 'block';
        }
      },

      onError: function(err) {
        console.error('PayPal error:', err);
        const errorMsg = document.getElementById('error-message');
        errorMsg.textContent = 'PayPal error. Please try again or use card payment.';
        errorMsg.style.display = 'block';
      },

      onCancel: function() {
        console.log('PayPal payment cancelled');
      }
    }).render('#paypal-button-container').catch(err => {
      console.error('PayPal render error:', err);
      // Reset flag on error so user can retry
      paypalButtonsRendered = false;
    });
  }
  
  async function handleSubmit(e) {
    e.preventDefault();

    // Check email verification for new users - must verify before purchasing
    if (window.FreshWax?.checkEmailVerified) {
      const verified = await window.FreshWax.checkEmailVerified('complete purchases');
      if (!verified) return;
    }

    const { subtotal, shipping, hasPhysicalItems, freshWaxFee, stripeFee, serviceFees, total } = calculateTotals();

    // If PayPal is selected and not a free order, don't process here (PayPal buttons handle it)
    if (selectedPaymentMethod === 'paypal' && total > 0) {
      return;
    }

    const submitBtn = document.getElementById('submitBtn');
    const errorMsg = document.getElementById('error-message');

    submitBtn.disabled = true;
    submitBtn.style.background = '#333';
    submitBtn.style.color = '#999';
    errorMsg.style.display = 'none';

    // Check if this is a free order
    const isFreeOrder = total === 0;

    if (isFreeOrder) {
      submitBtn.textContent = 'PROCESSING...';
    } else {
      submitBtn.textContent = 'REDIRECTING TO PAYMENT...';
    }

    const form = e.target;

    // Save details to customer account if checkbox is checked
    const saveDetails = form.saveDetails?.checked;
    if (saveDetails && currentUser) {
      try {
        const customerRef = doc(db, 'customers', currentUser.uid);
        await setDoc(customerRef, {
          firstName: form.firstName.value,
          lastName: form.lastName.value,
          email: form.email.value,
          phone: form.phone?.value || '',
          address1: form.address1?.value || '',
          address2: form.address2?.value || '',
          city: form.city?.value || '',
          county: form.county?.value || '',
          postcode: form.postcode?.value || '',
          country: form.country?.value || 'United Kingdom',
          updatedAt: new Date().toISOString()
        }, { merge: true });
      } catch (e) {
        console.error('Error saving customer details:', e);
      }
    }

    const orderData = {
      customer: {
        email: form.email.value,
        firstName: form.firstName.value,
        lastName: form.lastName.value,
        phone: form.phone?.value || '',
        userId: currentUser?.uid || null
      },
      shipping: hasPhysicalItems ? {
        address1: form.address1.value,
        address2: form.address2?.value || '',
        city: form.city.value,
        county: form.county?.value || '',
        postcode: form.postcode.value,
        country: form.country.value
      } : null,
      items: cart.map(item => ({
        id: item.id || item.productId,
        productId: item.productId || item.id,
        releaseId: item.releaseId || item.productId || item.id,
        trackId: item.trackId || null,
        name: item.name,
        type: item.type || item.productType,
        price: item.price,
        quantity: item.quantity,
        image: item.image || item.artwork,
        artwork: item.artwork || item.image,
        size: item.size || null,
        color: typeof item.color === 'object' ? item.color.name : item.color || null,
        artist: item.artist || null,
        title: item.title || null
      })),
      totals: { subtotal, shipping, freshWaxFee, stripeFee, serviceFees, total },
      hasPhysicalItems
    };

    try {
      // Get Firebase ID token for authenticated write
      if (currentUser) {
        try {
          orderData.idToken = await currentUser.getIdToken();
        } catch (tokenErr) {
          console.warn('Could not get ID token:', tokenErr);
        }
      }

      // Handle free orders (total = 0) differently
      if (isFreeOrder) {
        console.log('[Checkout] Processing free order...');

        const response = await fetch('/api/complete-free-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (result.success && result.orderId) {
          console.log('[Checkout] Free order completed:', result.orderNumber);

          // Clear cart
          const customerId = getCustomerIdFromCookie();
          if (customerId) {
            localStorage.removeItem('freshwax_cart_' + customerId);
          }

          // Redirect to success page
          window.location.href = '/checkout/success?orderId=' + result.orderId;
        } else {
          throw new Error(result.error || 'Failed to complete free order');
        }
      } else {
        // Create Stripe checkout session
        const response = await fetch('/api/stripe/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (result.success && result.checkoutUrl) {
          // Redirect to Stripe checkout
          window.location.href = result.checkoutUrl;
        } else {
          throw new Error(result.error || 'Failed to create checkout session');
        }
      }
    } catch (error) {
      console.error('Checkout error:', error);
      errorMsg.textContent = error.message || 'Something went wrong. Please try again.';
      errorMsg.style.display = 'block';
      submitBtn.disabled = false;

      if (isFreeOrder) {
        submitBtn.textContent = 'COMPLETE FREE ORDER';
        submitBtn.style.background = '#16a34a';
      } else {
        submitBtn.textContent = `PAY WITH CARD ‚Äî ¬£${total.toFixed(2)}`;
        submitBtn.style.background = '#dc2626';
      }
      submitBtn.style.color = '#fff';
    }
  }
  
  // Check if logged-in user is a customer (only customers can buy)
  async function checkUserType(uid) {
    try {
      const response = await fetch('/api/get-user-type?uid=' + uid);
      const data = await response.json();
      return data;
    } catch (e) {
      console.error('Error checking user type:', e);
      return { isCustomer: false, isArtist: false };
    }
  }
  
  // Show access denied message for non-customers
  function showAccessDenied() {
    const container = document.getElementById('checkout-content');
    container.innerHTML = `
      <div style="text-align: center; padding: 4rem 2rem; background: #1a0a0a; border: 3px solid #dc2626; border-radius: 12px;">
        <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 2.5rem; margin-bottom: 0.75rem; color: #ff6b6b;">CUSTOMER ACCOUNT REQUIRED</h2>
        <p style="font-size: 1.125rem; color: #888; margin-bottom: 1rem;">Only customer accounts can make purchases.</p>
        <p style="font-size: 1rem; color: #666; margin-bottom: 2rem;">If you're an artist, please create a separate customer account to buy items from the store.</p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a href="/register" style="display: inline-block; padding: 1rem 2.5rem; background: #dc2626; color: #fff; text-decoration: none; border-radius: 10px; font-size: 1.125rem; font-weight: 600;">Create Customer Account</a>
          <a href="/" style="display: inline-block; padding: 1rem 2.5rem; background: #333; color: #fff; text-decoration: none; border-radius: 10px; font-size: 1.125rem; font-weight: 600;">Back to Store</a>
        </div>
      </div>
    `;
  }
  
  let userTypeChecked = false;
  let isAllowedToBuy = true;
  let duplicatePurchases = [];
  
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    
    // If no Firebase auth AND no customerId cookie, redirect to login
    const customerId = getCustomerIdFromCookie();
    if (!user && !customerId) {
      window.location.href = '/login?redirect=/checkout';
      return;
    }
    
    // If we have a cookie but no Firebase auth, still try to load customer data
    // The cookie contains the user ID
    const userId = user?.uid || customerId;
    
    if (userId) {
      // Check if user is allowed to make purchases
      const userType = await checkUserType(userId);
      
      // Artists who are NOT also customers cannot buy
      if (userType.isArtist && !userType.isCustomer) {
        isAllowedToBuy = false;
        showAccessDenied();
        return;
      }
      
      customerData = await loadCustomerData(userId);
      
      // Load cart and check for duplicates
      loadCart();
      const { duplicates } = await checkDuplicatePurchases(userId);
      duplicatePurchases = duplicates;
    } else {
      // No user at all - redirect to login
      window.location.href = '/login?redirect=/checkout';
      return;
    }
    
    userTypeChecked = true;
    renderCheckout();
  });
</script>

<script is:inline src="/email-verify-check.js"></script>