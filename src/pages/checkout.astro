---
// src/pages/checkout.astro
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/checkout.css';

export const prerender = false;
---

<Layout title="Checkout" noindex={true}>
  <Header />
  
  <main class="checkout-main">
    
    <!-- Page Header -->
    <div class="page-header-container">
      <div class="page-header-pattern"></div>
      <header class="checkout-header">
        <h1>CHECK<span class="red">OUT</span></h1>
        <a href="/cart" class="back-btn">‚Üê Back to Bag</a>
      </header>
    </div>
    
    <!-- Test Banner -->
    <div class="test-banner">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
      </svg>
      Test Mode ‚Äî No Payment Will Be Taken
    </div>
    
    <div id="error-message" class="error-message"></div>
    
    <div id="checkout-content">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading your cart...</span>
      </div>
    </div>
  </main>

  <Footer />
</Layout>



<script>
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let currentUser = null;
  let customerData = null;
  let cart = [];
  
  function getCustomerIdFromCookie() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'customerId' && value) {
        return value;
      }
    }
    return null;
  }
  
  function loadCart() {
    try {
      const customerId = getCustomerIdFromCookie();
      if (!customerId) {
        cart = [];
        return cart;
      }
      
      const cartKey = 'freshwax_cart_' + customerId;
      const stored = localStorage.getItem(cartKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        cart = parsed.items ? parsed.items : (Array.isArray(parsed) ? parsed : []);
      } else {
        cart = [];
      }
    } catch (e) {
      console.error('[Checkout] Cart parse error:', e);
      cart = [];
    }
    return cart;
  }
  
  // Check for duplicate audio purchases via API
  async function checkDuplicatePurchases(userId) {
    if (!userId) return { duplicates: [], ownedReleases: [] };
    
    try {
      const response = await fetch('/api/check-duplicates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, cartItems: cart })
      });
      
      if (!response.ok) {
        throw new Error('Failed to check duplicates');
      }
      
      const data = await response.json();
      return data;
    } catch (e) {
      console.error('[Checkout] Error checking duplicate purchases:', e);
      return { duplicates: [], ownedReleases: [] };
    }
  }
  
  // Remove duplicate items from cart
  function removeDuplicatesFromCart(duplicates) {
    const customerId = getCustomerIdFromCookie();
    if (!customerId) return;
    
    const duplicateKeys = new Set(duplicates.map(d => {
      const item = d.item;
      if (item.trackId) {
        return `${item.releaseId || item.productId || item.id}_${item.trackId}`;
      }
      return item.releaseId || item.productId || item.id;
    }));
    
    cart = cart.filter(item => {
      const key = item.trackId 
        ? `${item.releaseId || item.productId || item.id}_${item.trackId}`
        : (item.releaseId || item.productId || item.id);
      return !duplicateKeys.has(key);
    });
    
    // Save updated cart
    const cartKey = 'freshwax_cart_' + customerId;
    localStorage.setItem(cartKey, JSON.stringify({ items: cart, updatedAt: Date.now() }));
    
    // Dispatch cart update event
    window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { count: cart.reduce((sum, item) => sum + item.quantity, 0) } }));
  }
  
  function calculateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const hasPhysicalItems = cart.some(item => 
      item.type === 'vinyl' || item.type === 'merch' || item.productType === 'vinyl' || item.productType === 'merch'
    );
    const shipping = hasPhysicalItems ? (subtotal >= 50 ? 0 : 4.99) : 0;
    return { subtotal, shipping, hasPhysicalItems, total: subtotal + shipping };
  }
  
  function getBadgeStyle(type) {
    if (type === 'vinyl') return 'background: #000; color: #fff; border-color: #fff;';
    if (type === 'merch') return 'background: #1e1b4b; color: #a5b4fc; border-color: #a5b4fc;';
    return 'background: #052e16; color: #22c55e; border-color: #22c55e;';
  }
  
  async function loadCustomerData(uid) {
    try {
      
      // Try customers collection first - direct document lookup
      const customerDoc = await getDoc(doc(db, 'customers', uid));
      if (customerDoc.exists()) {
        const data = customerDoc.data();
        return data;
      }
      
      // Try querying customers by uid field
      const customersRef = collection(db, 'customers');
      const q = query(customersRef, where('uid', '==', uid));
      const customerSnap = await getDocs(q);
      if (!customerSnap.empty) {
        const data = customerSnap.docs[0].data();
        return data;
      }
      
      // Try users collection
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        return data;
      }
      
    } catch (e) {
      console.error('[Checkout] Error loading customer data:', e);
    }
    return null;
  }
  
  // Postcode lookup function - uses free postcodes.io API
  // Validates postcode and auto-fills city/county (street address entered manually)
  async function lookupPostcode() {
    const postcodeInput = document.getElementById('postcodeSearch');
    const findBtn = document.getElementById('findAddressBtn');
    const manualEntry = document.getElementById('manualAddressFields');
    const manualEntryLink = document.getElementById('manualEntryLink');
    const lookupError = document.getElementById('lookupError');
    
    const postcode = postcodeInput.value.trim();
    
    if (!postcode) {
      lookupError.textContent = 'Please enter a postcode';
      lookupError.style.color = '#ff6b6b';
      lookupError.style.display = 'block';
      return;
    }
    
    // Update button state
    findBtn.disabled = true;
    findBtn.textContent = 'Validating...';
    lookupError.style.display = 'none';
    
    try {
      const response = await fetch(`/api/postcode-lookup?postcode=${encodeURIComponent(postcode)}`);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Postcode not found');
      }
      
      // Postcode validated! Auto-fill the location fields
      document.getElementById('postcode').value = data.postcode;
      document.getElementById('city').value = data.city || '';
      document.getElementById('county').value = data.county || '';
      
      // Show success message
      lookupError.textContent = '‚úì Postcode verified! Please enter your street address below.';
      lookupError.style.color = '#22c55e';
      lookupError.style.display = 'block';
      
      // Show address fields for manual entry
      manualEntry.style.display = 'block';
      if (manualEntryLink) manualEntryLink.style.display = 'none';
      
      // Focus on address line 1 for quick entry
      setTimeout(() => {
        document.getElementById('address1')?.focus();
      }, 100);
      
    } catch (error) {
      lookupError.textContent = error.message || 'Failed to lookup postcode';
      lookupError.style.color = '#ff6b6b';
      lookupError.style.display = 'block';
      // Show manual fields on error so user can still proceed
      manualEntry.style.display = 'block';
      if (manualEntryLink) manualEntryLink.style.display = 'none';
    } finally {
      findBtn.disabled = false;
      findBtn.textContent = 'Verify Postcode';
    }
  }
  
  // Handle address selection (kept for backwards compatibility)
  function handleAddressSelect(event) {
    const value = event.target.value;
    const manualEntry = document.getElementById('manualAddressFields');
    manualEntry.style.display = 'block';
  }
  
  function renderCheckout() {
    const container = document.getElementById('checkout-content');
    loadCart();
    
    if (cart.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 4rem 2rem; background: #fff; border: 2px solid #d1d5db; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.5;">üõí</div>
          <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 2rem; margin-bottom: 0.75rem; color: #dc2626;">YOUR CART IS EMPTY</h2>
          <p style="font-size: 1rem; color: #6b7280; margin-bottom: 2rem;">Add some items before checking out.</p>
          <a href="/" style="display: inline-block; padding: 0.875rem 2rem; background: #dc2626; color: #fff; text-decoration: none; border-radius: 8px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.125rem; letter-spacing: 0.04em;">BROWSE STORE</a>
        </div>
      `;
      return;
    }
    
    const { subtotal, shipping, hasPhysicalItems, total } = calculateTotals();
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Pre-fill from customer data
    const cd = customerData || {};
    
    const email = currentUser?.email || cd.email || '';
    const firstName = cd.firstName || cd.name?.split(' ')[0] || '';
    const lastName = cd.lastName || cd.name?.split(' ').slice(1).join(' ') || '';
    const phone = cd.phone || '';
    const address1 = cd.address1 || cd.addressLine1 || '';
    const address2 = cd.address2 || cd.addressLine2 || '';
    const city = cd.city || '';
    const county = cd.county || '';
    const postcode = cd.postcode || '';
    const country = cd.country || 'United Kingdom';
    
    
    // Check if we have saved address data
    const hasSavedAddress = address1 && city && postcode;
    
    container.innerHTML = `
      <form id="checkoutForm">
        <!-- Order Items -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 1.5rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.75rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">YOUR ORDER</h2>
            <span style="font-size: 1.125rem; color: #d1d5db; font-weight: 500;">${itemCount} ${itemCount === 1 ? 'item' : 'items'}</span>
          </div>
          <div style="padding: 1.25rem;">
            <div style="display: flex; flex-direction: column; gap: 0.875rem;">
              ${cart.map(item => {
                const itemType = item.type || item.productType || 'digital';
                const artistName = item.artist || '';
                return `
                <article style="display: flex; align-items: center; gap: 1.25rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <div style="width: 70px; height: 70px; border-radius: 6px; overflow: hidden; background: #e5e7eb; border: 1px solid #d1d5db; flex-shrink: 0;">
                    <img src="${item.image}" alt="${item.name}" style="width: 70px; height: 70px; object-fit: cover; display: block;">
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <h3 style="margin: 0 0 0.25rem 0; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.375rem; color: #dc2626; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.02em;">${item.name}</h3>
                    ${artistName ? `<p style="margin: 0 0 0.375rem 0; font-size: 1rem; color: #6b7280;">${artistName}</p>` : ''}
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                      <span style="display: inline-block; padding: 0.2rem 0.5rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; border-radius: 3px; border: 1px solid; ${getBadgeStyle(itemType)}">${itemType}</span>
                      ${item.color ? `<span style="font-size: 0.9375rem; color: #6b7280;">${typeof item.color === 'object' ? item.color.name : item.color}</span>` : ''}
                      ${item.size ? `<span style="font-size: 0.9375rem; color: #6b7280;">Size: ${item.size}</span>` : ''}
                      ${item.quantity > 1 ? `<span style="font-size: 0.9375rem; color: #6b7280;">√ó${item.quantity}</span>` : ''}
                    </div>
                  </div>
                  <div style="text-align: right; flex-shrink: 0;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: #16a34a;">¬£${(item.price * item.quantity).toFixed(2)}</div>
                    ${item.quantity > 1 ? `<div style="font-size: 0.875rem; color: #6b7280;">¬£${item.price.toFixed(2)} each</div>` : ''}
                  </div>
                </article>
              `}).join('')}
            </div>
            
            <!-- Totals -->
            <div style="display: flex; flex-direction: column; gap: 0.625rem; padding: 1.25rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 1.25rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.125rem; color: #6b7280;">Subtotal</span>
                <span style="font-size: 1.25rem; font-weight: 600; color: #111827;">¬£${subtotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.125rem; color: #6b7280;">Shipping</span>
                <span style="font-size: 1.25rem; font-weight: 600; color: #16a34a;">${hasPhysicalItems ? (shipping === 0 ? 'FREE' : '¬£' + shipping.toFixed(2)) : 'Digital'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; margin-top: 0.625rem; border-top: 2px solid #dc2626;">
                <span style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; letter-spacing: 0.04em; color: #111827;">TOTAL</span>
                <span style="font-size: 1.875rem; font-weight: 700; color: #dc2626;">¬£${total.toFixed(2)}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Contact Details -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="padding: 1rem 1.25rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">CONTACT DETAILS</h2>
          </div>
          <div style="padding: 1.25rem;">
            <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="firstName" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">First Name *</label>
                <input type="text" id="firstName" name="firstName" required placeholder="John" value="${firstName}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="lastName" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required placeholder="Doe" value="${lastName}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
            </div>
            <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="email" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Email Address *</label>
                <input type="email" id="email" name="email" required placeholder="you@example.com" value="${email}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                <label for="phone" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Phone Number</label>
                <input type="tel" id="phone" name="phone" placeholder="+44 7XXX XXXXXX" value="${phone}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
              </div>
            </div>
          </div>
        </div>
        
        ${hasPhysicalItems ? `
        <!-- Postal Address -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="padding: 1rem 1.25rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">POSTAL ADDRESS</h2>
          </div>
          <div style="padding: 1.25rem;">
            
            <!-- Postcode Lookup -->
            <div style="margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px solid #e5e7eb;">
              <label style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em; display: block; margin-bottom: 0.375rem;">Verify Your Postcode</label>
              <div class="postcode-lookup-row" style="display: flex; gap: 0.75rem;">
                <input type="text" id="postcodeSearch" placeholder="Enter postcode (e.g. E1 6AN)" value="${postcode}" style="flex: 1; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit; text-transform: uppercase;">
                <button type="button" id="findAddressBtn" onclick="lookupPostcode()" style="padding: 0.875rem 1.25rem; background: #dc2626; color: #fff; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                  Verify
                </button>
              </div>
              <div id="lookupError" style="margin-top: 0.5rem; font-size: 0.8125rem; color: #dc2626; display: none;"></div>
            </div>
            
            <!-- Manual Address Fields -->
            <div id="manualAddressFields" style="display: ${hasSavedAddress ? 'block' : 'none'};">
              <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="address1" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Address Line 1 *</label>
                  <input type="text" id="address1" name="address1" required placeholder="123 Music Street" value="${address1}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="address2" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Address Line 2</label>
                  <input type="text" id="address2" name="address2" placeholder="Flat 4B" value="${address2}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
              </div>
              <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="city" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">City *</label>
                  <input type="text" id="city" name="city" required placeholder="London" value="${city}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="postcode" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Postcode *</label>
                  <input type="text" id="postcode" name="postcode" required placeholder="E1 6AN" value="${postcode}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit; text-transform: uppercase;">
                </div>
              </div>
              <div class="checkout-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="county" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">County</label>
                  <input type="text" id="county" name="county" placeholder="Greater London" value="${county}" style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                  <label for="country" style="font-size: 0.8125rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.04em;">Country *</label>
                  <select id="country" name="country" required style="width: 100%; padding: 0.875rem 1rem; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; font-size: 1rem; font-family: inherit; cursor: pointer;">
                    <option value="United Kingdom" ${country === 'United Kingdom' ? 'selected' : ''}>United Kingdom</option>
                    <option value="Ireland" ${country === 'Ireland' ? 'selected' : ''}>Ireland</option>
                    <option value="Germany" ${country === 'Germany' ? 'selected' : ''}>Germany</option>
                    <option value="France" ${country === 'France' ? 'selected' : ''}>France</option>
                    <option value="Netherlands" ${country === 'Netherlands' ? 'selected' : ''}>Netherlands</option>
                    <option value="Belgium" ${country === 'Belgium' ? 'selected' : ''}>Belgium</option>
                    <option value="USA" ${country === 'USA' ? 'selected' : ''}>United States</option>
                    <option value="Canada" ${country === 'Canada' ? 'selected' : ''}>Canada</option>
                    <option value="Australia" ${country === 'Australia' ? 'selected' : ''}>Australia</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Enter Manually Link (shown when fields hidden) -->
            <div id="manualEntryLink" style="display: ${hasSavedAddress ? 'none' : 'block'}; margin-top: 0.75rem;">
              <button type="button" onclick="document.getElementById('manualAddressFields').style.display='block'; document.getElementById('manualEntryLink').style.display='none';" style="background: none; border: none; color: #60a5fa; font-size: 0.875rem; cursor: pointer; text-decoration: underline;">
                Or enter address manually
              </button>
            </div>
            
            ${currentUser ? `
            <label style="display: flex; align-items: center; gap: 0.75rem; margin-top: 1.25rem; padding: 1rem; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; cursor: pointer;">
              <input type="checkbox" id="saveDetails" name="saveDetails" style="width: 20px; height: 20px; accent-color: #dc2626; cursor: pointer;">
              <span style="font-size: 0.875rem; color: #1e40af; font-weight: 500;">Save these details for faster checkout</span>
            </label>
            ` : ''}
          </div>
        </div>
        ` : ''}
        
        <!-- Payment -->
        <div style="background: #fff; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
          <div style="padding: 1rem 1.25rem; background: linear-gradient(to right, #1f2937 0%, #374151 100%); border-bottom: 2px solid #dc2626;">
            <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #fff; margin: 0;">PAYMENT</h2>
          </div>
          <div style="padding: 1.25rem;">
            <p style="font-size: 0.9375rem; color: #6b7280; line-height: 1.6; text-align: center; padding: 0.5rem 0;">
              This is a test checkout. No payment will be processed.<br>
              Click below to complete your order and receive download links.
            </p>
            <button type="submit" id="submitBtn" style="width: 100%; padding: 1rem; margin-top: 1rem; background: #dc2626; color: #fff; border: none; border-radius: 10px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.375rem; font-weight: 400; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s;">
              COMPLETE ORDER ‚Äî ¬£${total.toFixed(2)}
            </button>
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 0.875rem; font-size: 0.8125rem; color: #6b7280;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              Secure Checkout
            </div>
          </div>
        </div>
      </form>
    `;
    
    // Show duplicate warning if any found
    if (duplicatePurchases && duplicatePurchases.length > 0) {
      const itemsList = duplicatePurchases.map(d => `<li><strong>${d.item.name}</strong> - ${d.reason}</li>`).join('');
      
      const warningHtml = `
        <div id="duplicate-warning" style="background: #7f1d1d; border: 3px solid #dc2626; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: flex-start; gap: 1rem;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fca5a5" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div style="flex: 1;">
              <h3 style="color: #fca5a5; font-size: 1.125rem; font-weight: 700; margin: 0 0 0.5rem 0;">You Already Own Some Items</h3>
              <p style="color: #fecaca; font-size: 0.9375rem; margin: 0 0 1rem 0;">The following items are already in your purchase history:</p>
              <ul style="color: #fecaca; font-size: 0.875rem; margin: 0 0 1rem 0; padding-left: 1.25rem;">${itemsList}</ul>
              <button type="button" id="removeDuplicatesBtn" style="background: #dc2626; color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9375rem;">
                Remove These Items From Cart
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Insert at top of checkout content
      container.insertAdjacentHTML('afterbegin', warningHtml);
      
      // Add click handler for remove button
      document.getElementById('removeDuplicatesBtn')?.addEventListener('click', () => {
        removeDuplicatesFromCart(duplicatePurchases);
        document.getElementById('duplicate-warning')?.remove();
        duplicatePurchases = [];
        renderCheckout();
      });
    }
    
    // Make postcode lookup available globally
    window.lookupPostcode = lookupPostcode;
    
    document.getElementById('checkoutForm').addEventListener('submit', handleSubmit);
  }
  
  async function handleSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const errorMsg = document.getElementById('error-message');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'PROCESSING...';
    submitBtn.style.background = '#333';
    submitBtn.style.color = '#666';
    errorMsg.style.display = 'none';
    
    const form = e.target;
    const { subtotal, shipping, hasPhysicalItems, total } = calculateTotals();
    
    // Save details to customer account if checkbox is checked
    const saveDetails = form.saveDetails?.checked;
    if (saveDetails && currentUser) {
      try {
        const customerRef = doc(db, 'customers', currentUser.uid);
        await setDoc(customerRef, {
          firstName: form.firstName.value,
          lastName: form.lastName.value,
          email: form.email.value,
          phone: form.phone?.value || '',
          address1: form.address1?.value || '',
          address2: form.address2?.value || '',
          city: form.city?.value || '',
          county: form.county?.value || '',
          postcode: form.postcode?.value || '',
          country: form.country?.value || 'United Kingdom',
          updatedAt: new Date().toISOString()
        }, { merge: true });
      } catch (e) {
        console.error('Error saving customer details:', e);
      }
    }
    
    const orderData = {
      customer: {
        email: form.email.value,
        firstName: form.firstName.value,
        lastName: form.lastName.value,
        phone: form.phone?.value || '',
        userId: currentUser?.uid || null
      },
      shipping: hasPhysicalItems ? {
        address1: form.address1.value,
        address2: form.address2?.value || '',
        city: form.city.value,
        county: form.county?.value || '',
        postcode: form.postcode.value,
        country: form.country.value
      } : null,
      items: cart.map(item => ({
        id: item.id || item.productId,
        productId: item.productId || item.id,
        releaseId: item.releaseId || item.productId || item.id,
        trackId: item.trackId || null,
        name: item.name,
        type: item.type || item.productType,
        price: item.price,
        quantity: item.quantity,
        image: item.image || item.artwork,
        artwork: item.artwork || item.image,
        size: item.size || null,
        color: typeof item.color === 'object' ? item.color.name : item.color || null,
        artist: item.artist || null,
        title: item.title || null
      })),
      totals: { subtotal, shipping, total },
      hasPhysicalItems,
      paymentMethod: 'test_mode',
      paymentStatus: 'completed'
    };

    try {
      // Get Firebase ID token for authenticated write
      if (currentUser) {
        try {
          orderData.idToken = await currentUser.getIdToken();
        } catch (tokenErr) {
          console.warn('Could not get ID token:', tokenErr);
        }
      }

      const response = await fetch('/api/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Clear customer-specific cart
        const customerId = getCustomerIdFromCookie();
        if (customerId) {
          localStorage.removeItem('freshwax_cart_' + customerId);
        }
        localStorage.removeItem('cart'); // Also clear legacy cart
        window.dispatchEvent(new CustomEvent('cart-updated', { detail: { items: [] } }));
        window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { items: [] } }));
        window.location.href = `/order-confirmation/${result.orderId}`;
      } else {
        throw new Error(result.error || 'Failed to create order');
      }
    } catch (error) {
      console.error('Checkout error:', error);
      errorMsg.textContent = error.message || 'Something went wrong. Please try again.';
      errorMsg.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = `COMPLETE ORDER ‚Äî ¬£${total.toFixed(2)}`;
      submitBtn.style.background = '#fff';
      submitBtn.style.color = '#000';
    }
  }
  
  // Check if logged-in user is a customer (only customers can buy)
  async function checkUserType(uid) {
    try {
      const response = await fetch('/api/get-user-type?uid=' + uid);
      const data = await response.json();
      return data;
    } catch (e) {
      console.error('Error checking user type:', e);
      return { isCustomer: false, isArtist: false };
    }
  }
  
  // Show access denied message for non-customers
  function showAccessDenied() {
    const container = document.getElementById('checkout-content');
    container.innerHTML = `
      <div style="text-align: center; padding: 4rem 2rem; background: #1a0a0a; border: 3px solid #dc2626; border-radius: 12px;">
        <h2 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 2.5rem; margin-bottom: 0.75rem; color: #ff6b6b;">CUSTOMER ACCOUNT REQUIRED</h2>
        <p style="font-size: 1.125rem; color: #888; margin-bottom: 1rem;">Only customer accounts can make purchases.</p>
        <p style="font-size: 1rem; color: #666; margin-bottom: 2rem;">If you're an artist, please create a separate customer account to buy items from the store.</p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a href="/register" style="display: inline-block; padding: 1rem 2.5rem; background: #dc2626; color: #fff; text-decoration: none; border-radius: 10px; font-size: 1.125rem; font-weight: 600;">Create Customer Account</a>
          <a href="/" style="display: inline-block; padding: 1rem 2.5rem; background: #333; color: #fff; text-decoration: none; border-radius: 10px; font-size: 1.125rem; font-weight: 600;">Back to Store</a>
        </div>
      </div>
    `;
  }
  
  let userTypeChecked = false;
  let isAllowedToBuy = true;
  let duplicatePurchases = [];
  
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    
    // If no Firebase auth AND no customerId cookie, redirect to login
    const customerId = getCustomerIdFromCookie();
    if (!user && !customerId) {
      window.location.href = '/login?redirect=/checkout';
      return;
    }
    
    // If we have a cookie but no Firebase auth, still try to load customer data
    // The cookie contains the user ID
    const userId = user?.uid || customerId;
    
    if (userId) {
      // Check if user is allowed to make purchases
      const userType = await checkUserType(userId);
      
      // Artists who are NOT also customers cannot buy
      if (userType.isArtist && !userType.isCustomer) {
        isAllowedToBuy = false;
        showAccessDenied();
        return;
      }
      
      customerData = await loadCustomerData(userId);
      
      // Load cart and check for duplicates
      loadCart();
      const { duplicates } = await checkDuplicatePurchases(userId);
      duplicatePurchases = duplicates;
    } else {
      // No user at all - redirect to login
      window.location.href = '/login?redirect=/checkout';
      return;
    }
    
    userTypeChecked = true;
    renderCheckout();
  });
</script>