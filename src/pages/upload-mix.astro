---
// src/pages/upload-mix.astro
// UPDATED: Genre dropdown, tracklist, duration calculation, character limits (DJ:15, Title:20, Desc:150)
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Upload DJ Mix - Fresh Wax" noindex={true}>
  <Header />
  
  <main class="min-h-screen bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 relative">
    <!-- Background Image -->
    <div class="fixed inset-0 z-0 pointer-events-none">
      <div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-10" style="background-image: url('/logo.webp');"></div>
    </div>

    <!-- Hero Section -->
    <section id="hero-section" class="bg-gradient-to-r from-black via-gray-900 to-black text-white py-16 relative overflow-hidden z-10">
      <div class="absolute inset-0 opacity-10">
        <div style="background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0); background-size: 40px 40px; position: absolute; inset: 0;"></div>
      </div>
      
      <div class="container mx-auto px-6 max-w-4xl text-center relative z-10">
        <div class="mb-4">
          <span class="inline-block px-4 py-2 bg-red-600 text-white text-sm font-bold uppercase tracking-wider rounded-full shadow-lg">
            Upload Mix
          </span>
        </div>
        <h1 class="hero-title">
          SHARE YOUR MIX
        </h1>
        <p class="text-lg sm:text-xl text-gray-300 font-medium max-w-2xl mx-auto">
          Upload your Jungle & Drum and Bass DJ sets
        </p>

        <!-- Animated Divider -->
        <div class="flex items-center justify-center gap-3 mt-6">
          <div style="height: 2px; width: 60px; background: linear-gradient(to right, transparent, rgba(220, 38, 38, 0.6)); border-radius: 1px;"></div>
          <div style="position: relative; height: 3px; width: 80px; background: rgba(220, 38, 38, 0.2); border-radius: 2px; overflow: hidden;">
            <div style="position: absolute; top: 0; height: 100%; width: 100%; background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.4) 20%, #dc2626 50%, rgba(220, 38, 38, 0.4) 80%, transparent); border-radius: 2px; animation: kittScanner 2.6s ease-in-out infinite; box-shadow: 0 0 20px rgba(220, 38, 38, 0.8), 0 0 40px rgba(220, 38, 38, 0.6);"></div>
          </div>
          <div style="height: 2px; width: 60px; background: linear-gradient(to left, transparent, rgba(220, 38, 38, 0.6)); border-radius: 1px;"></div>
        </div>
      </div>
    </section>

    <!-- Login Required Banner (hidden by default, shown if not logged in) -->
    <div id="login-banner" class="hidden bg-red-600 text-white p-6 text-center relative z-10">
      <p class="text-lg font-bold mb-4">üîí You must be logged in to upload DJ mixes</p>
      <div class="flex gap-4 justify-center flex-wrap">
        <a href="/login?redirect=/upload-mix" class="px-6 py-3 bg-white text-red-600 rounded-lg hover:bg-gray-100 transition-all font-bold text-sm uppercase">
          Login as Customer
        </a>
        <a href="/login?redirect=/upload-mix" class="px-6 py-3 bg-white text-red-600 rounded-lg hover:bg-gray-100 transition-all font-bold text-sm uppercase">
          Login as Artist/DJ
        </a>
      </div>
    </div>

    <!-- Upload Form -->
    <section class="container mx-auto px-6 py-12 max-w-4xl relative z-10">
      <div class="bg-white rounded-2xl shadow-xl border-2 border-black overflow-hidden">
        <form id="upload-form" class="p-8 space-y-6">
          
          <!-- DJ Name -->
          <div>
            <label for="dj-name" class="block text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">
              DJ Name <span class="text-red-600">*</span>
              <span class="text-gray-500 text-xs font-normal ml-2">(<span id="dj-name-count">0</span>/30)</span>
            </label>
            <input
              type="text"
              id="dj-name"
              name="djName"
              required
              maxlength="30"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all"
              placeholder="Enter your DJ name"
            />
          </div>

          <!-- Mix Title -->
          <div>
            <label for="mix-title" class="block text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">
              Mix Title <span class="text-red-600">*</span>
              <span class="text-gray-500 text-xs font-normal ml-2">(<span id="mix-title-count">0</span>/50)</span>
            </label>
            <input
              type="text"
              id="mix-title"
              name="mixTitle"
              required
              maxlength="50"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all"
              placeholder="Enter mix title"
            />
          </div>

          <!-- Genre Selection -->
          <div>
            <label for="genre-select" class="block text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">
              Genre <span class="text-red-600">*</span>
            </label>
            <select
              id="genre-select"
              name="genre"
              required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all bg-white"
            >
              <option value=""></option>
              <option value="Jungle">Jungle</option>
              <option value="Drum and Bass">Drum and Bass</option>
              <option value="Hardcore">Hardcore</option>
              <option value="Jungle Techno">Jungle Techno</option>
              <option value="Old Skool">Old Skool</option>
              <option value="Tribal">Tribal</option>
              <option value="Ragga Jungle">Ragga Jungle</option>
              <option value="Darkstep">Darkstep</option>
              <option value="Techstep">Techstep</option>
              <option value="Breakcore">Breakcore</option>
              <option value="Other">Other (Specify below)</option>
            </select>
            
            <!-- Other Genre Input (hidden by default) -->
            <div id="other-genre-container" class="hidden mt-3">
              <label for="other-genre" class="block text-sm font-bold text-gray-700 mb-2">
                Specify Genre <span class="text-red-600">*</span>
                <span class="text-gray-500 text-xs font-normal ml-2">(<span id="other-genre-count">0</span>/15)</span>
              </label>
              <input
                type="text"
                id="other-genre"
                name="otherGenre"
                maxlength="15"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all"
                placeholder=""
              />
            </div>
          </div>

          <!-- Description / Shout Outs -->
          <div>
            <label for="mix-description" class="block text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">
              About Mix / Shout Outs <span class="text-gray-500 text-xs">(Optional)</span>
              <span class="text-gray-500 text-xs font-normal ml-2">(<span id="mix-description-count">0</span>/150)</span>
            </label>
            <textarea
              id="mix-description"
              name="mixDescription"
              rows="3"
              maxlength="150"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all resize-none"
              placeholder="Comment about your mix, add shout outs..."
            ></textarea>
            
            <!-- Emoji Selector -->
            <div class="mt-2 p-3 bg-gray-50 rounded-lg border-2 border-gray-400">
              <p class="text-xs font-bold text-gray-700 mb-3 uppercase tracking-wide">Quick Emojis:</p>
              <div class="emoji-grid">
                <button type="button" class="emoji-btn" data-emoji="üî•" title="Fire">üî•</button>
                <button type="button" class="emoji-btn" data-emoji="üéß" title="Headphones">üéß</button>
                <button type="button" class="emoji-btn" data-emoji="üéµ" title="Music">üéµ</button>
                <button type="button" class="emoji-btn" data-emoji="üíØ" title="100">üíØ</button>
                <button type="button" class="emoji-btn" data-emoji="‚ö°" title="Lightning">‚ö°</button>
                <button type="button" class="emoji-btn" data-emoji="üöÄ" title="Rocket">üöÄ</button>
                <button type="button" class="emoji-btn" data-emoji="üí•" title="Boom">üí•</button>
                <button type="button" class="emoji-btn" data-emoji="üéâ" title="Party">üéâ</button>
                <button type="button" class="emoji-btn" data-emoji="üôå" title="Hands Up">üôå</button>
                <button type="button" class="emoji-btn" data-emoji="üëä" title="Fist Bump">üëä</button>
                <button type="button" class="emoji-btn" data-emoji="ü§ô" title="Call Me">ü§ô</button>
                <button type="button" class="emoji-btn" data-emoji="üëè" title="Clap">üëè</button>
                <button type="button" class="emoji-btn" data-emoji="üí™" title="Strong">üí™</button>
                <button type="button" class="emoji-btn" data-emoji="‚ù§Ô∏è" title="Heart">‚ù§Ô∏è</button>
                <button type="button" class="emoji-btn" data-emoji="üñ§" title="Black Heart">üñ§</button>
                <button type="button" class="emoji-btn" data-emoji="üîä" title="Volume">üîä</button>
                <button type="button" class="emoji-btn" data-emoji="üé§" title="Mic">üé§</button>
                <button type="button" class="emoji-btn" data-emoji="‚ú®" title="Sparkles">‚ú®</button>
                <button type="button" class="emoji-btn" data-emoji="ü•Å" title="Drum">ü•Å</button>
                <button type="button" class="emoji-btn" data-emoji="‚≠ê" title="Star">‚≠ê</button>
              </div>
            </div>
            
            <p id="description-error" class="text-red-600 text-sm mt-1 hidden font-semibold"></p>
          </div>

          <!-- Tracklist -->
          <div>
            <label for="tracklist" class="block text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">
              Tracklist <span class="text-gray-500 text-xs">(Optional)</span>
              <span class="text-gray-500 text-xs font-normal ml-2">(<span id="tracklist-count">0</span>/1500)</span>
            </label>
            <textarea
              id="tracklist"
              name="tracklist"
              rows="8"
              maxlength="1500"
              class="w-full px-4 py-3 border-2 border-gray-400 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent transition-all resize-none font-mono text-sm"
              placeholder="Artist - Track Title
Artist - Track Title
Artist - Track Title
...

(One track per line, numbers added automatically)"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">List your tracks, one per line. Format: Artist - Track Title (track numbers added automatically)</p>
          </div>

          <!-- Audio File Upload -->
          <div>
            <label class="block text-sm font-bold text-blue-600 mb-2 uppercase tracking-wide">
              Audio File <span class="text-gray-500 text-xs font-normal">(.mp3 only, up to 500MB)</span> <span class="text-red-600">*</span>
            </label>
            
            <div id="audio-drop-zone" class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center hover:border-blue-600 transition-all cursor-pointer bg-blue-50 hover:bg-blue-100">
              <svg class="w-16 h-16 mx-auto mb-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
              </svg>
              <p class="text-blue-700 font-semibold mb-2">Drag & drop your MP3 file here</p>
              <p class="text-blue-500 text-sm mb-4">or</p>
              <button type="button" id="audio-browse-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-bold">
                Browse Files
              </button>
              <input type="file" id="audio-file-input" accept=".mp3,audio/mpeg" class="hidden" />
            </div>

            <!-- Audio File Preview -->
            <div id="audio-preview" class="hidden mt-4 p-4 bg-gradient-to-r from-gray-100 to-gray-50 rounded-lg border-2 border-gray-300">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                  <svg class="w-10 h-10 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                  </svg>
                  <div>
                    <p id="audio-filename" class="font-bold text-gray-900"></p>
                    <p id="audio-filesize" class="text-sm text-gray-600"></p>
                    <p id="audio-duration" class="text-sm text-red-600 font-semibold"></p>
                  </div>
                </div>
                <button type="button" id="audio-remove-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all font-bold text-sm">
                  Remove
                </button>
              </div>
            </div>
            
            <!-- Hidden duration input -->
            <input type="hidden" id="audio-duration-seconds" name="durationSeconds" value="0" />
          </div>

          <!-- Artwork Upload -->
          <div>
            <label class="block text-sm font-bold text-green-600 mb-2 uppercase tracking-wide">
              Artwork <span class="text-gray-500 text-xs font-normal">(Optional - Square cover image)</span>
            </label>
            
            <!-- Drop Zone (Hidden when artwork selected) -->
            <div id="artwork-drop-zone" class="border-2 border-dashed border-green-300 rounded-lg p-8 text-center hover:border-green-600 transition-all cursor-pointer bg-green-50 hover:bg-green-100">
              <svg class="w-16 h-16 mx-auto mb-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-green-700 font-semibold mb-2">Drag & drop your artwork here</p>
              <p class="text-green-500 text-sm mb-4">JPG, PNG (Recommended: 1000x1000px)</p>
              <button type="button" id="artwork-browse-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-bold">
                Browse Files
              </button>
              <input type="file" id="artwork-file-input" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden" />
            </div>

            <!-- Artwork Preview (Shows when artwork selected) -->
            <div id="artwork-preview" class="hidden">
              <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg border-2 border-green-300 p-6">
                <div class="flex flex-col md:flex-row items-center gap-6">
                  <!-- Large Preview -->
                  <div class="flex-shrink-0">
                    <img id="artwork-preview-img" src="" alt="Artwork preview" class="w-48 h-48 object-cover rounded-lg shadow-lg border-2 border-green-300" />
                  </div>
                  
                  <!-- Info & Actions -->
                  <div class="flex-1 text-center md:text-left">
                    <p class="font-bold text-green-800 text-lg mb-2">Artwork Selected</p>
                    <p id="artwork-filename" class="text-green-700 mb-1"></p>
                    <p id="artwork-filesize" class="text-sm text-green-600 mb-4"></p>
                    <button type="button" id="artwork-remove-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-bold">
                      Change Artwork
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Progress Bar (Hidden by default) -->
          <div id="upload-progress-container" class="hidden">
            <div class="bg-gradient-to-r from-gray-100 to-gray-50 rounded-lg border-2 border-gray-300 p-6">
              <div class="flex items-center justify-between mb-3">
                <p class="font-bold text-gray-900">Uploading...</p>
                <p id="upload-progress-text" class="text-sm font-bold text-red-600">0%</p>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="upload-progress-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 transition-all duration-300 ease-out" style="width: 0%"></div>
              </div>
              <p id="upload-status-text" class="text-sm text-gray-600 mt-3 text-center">Preparing upload...</p>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="pt-4">
            <button
              type="submit"
              id="submit-btn"
              disabled
              class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-4 rounded-lg font-black text-lg uppercase tracking-wide hover:from-red-700 hover:to-red-800 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Checking Login...
            </button>
          </div>

          <!-- Info Text -->
          <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
            <p class="text-sm text-green-900">
              <strong>‚úì Goes Live Instantly:</strong> Your mix will appear on the DJ Mixes page as soon as the upload completes!
            </p>
          </div>
        </form>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /* Fonts loaded in Layout.astro */

  .hero-title {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 3.5rem;
    font-weight: 900;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
    text-shadow: 0 4px 30px rgba(0, 0, 0, 0.7), 0 0 80px rgba(220, 38, 38, 0.2);
    line-height: 0.95;
    text-transform: uppercase;
  }

  @media (min-width: 768px) {
    .hero-title {
      font-size: 4.5rem;
    }
  }

  @media (min-width: 1024px) {
    .hero-title {
      font-size: 5rem;
    }
  }

  @keyframes kittScanner {
    0% { left: -100%; opacity: 0; }
    5% { opacity: 1; }
    45% { opacity: 1; }
    50% { left: 100%; opacity: 0; }
    55% { opacity: 1; }
    95% { opacity: 1; }
    100% { left: -100%; opacity: 0; }
  }

  .drag-over {
    border-color: #2563eb !important;
    background-color: #eff6ff !important;
  }

  #artwork-drop-zone.drag-over {
    border-color: #16a34a !important;
    background-color: #f0fdf4 !important;
  }

  /* Emoji Grid - 10 columns on desktop, 6 on tablet, 5 on mobile */
  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 0.5rem;
  }

  .emoji-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
    font-size: 1.5rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .emoji-btn:hover {
    background: #fef2f2;
    border-color: #dc2626;
    transform: scale(1.1);
  }

  .emoji-btn:active {
    transform: scale(0.95);
  }

  /* Tablet */
  @media (max-width: 768px) {
    .emoji-grid {
      grid-template-columns: repeat(6, 1fr);
    }
    
    .emoji-btn {
      font-size: 1.25rem;
    }

    .hero-title {
      font-size: 3.5rem;
    }
  }

  /* Mobile */
  @media (max-width: 480px) {
    .emoji-grid {
      grid-template-columns: repeat(5, 1fr);
      gap: 0.375rem;
    }
    
    .emoji-btn {
      font-size: 1.125rem;
      border-radius: 0.375rem;
    }

    /* Mobile form optimizations */
    #upload-form {
      padding: 1.25rem !important;
    }

    #upload-form .space-y-6 > div {
      margin-bottom: 1.25rem;
    }

    #upload-form input,
    #upload-form select,
    #upload-form textarea {
      font-size: 16px !important; /* Prevents zoom on iOS */
      padding: 0.75rem !important;
    }

    #upload-form label {
      font-size: 0.75rem;
    }

    #audio-drop-zone,
    #artwork-drop-zone {
      padding: 1.5rem 1rem !important;
    }

    #audio-drop-zone svg,
    #artwork-drop-zone svg {
      width: 3rem !important;
      height: 3rem !important;
    }

    #audio-drop-zone p,
    #artwork-drop-zone p {
      font-size: 0.875rem;
    }

    #audio-browse-btn,
    #artwork-browse-btn {
      padding: 0.5rem 1rem !important;
      font-size: 0.875rem !important;
    }

    /* Hero section mobile */
    #hero-section {
      padding-top: 2.5rem !important;
      padding-bottom: 2.5rem !important;
    }

    .hero-title {
      font-size: 2rem !important;
    }

    #hero-section p {
      font-size: 1rem !important;
    }
  }
</style>

<!-- Firebase Authentication -->
<script is:inline type="module">
  import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  // Firebase config - matches working admin login
  const firebaseConfig = {
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  // Initialize Firebase if not already initialized
  const app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  window.firebaseAuth = auth;

  // Helper to get cookie value
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }
  window.getCookie = getCookie;

  const submitBtn = document.getElementById('submit-btn');
  const loginBanner = document.getElementById('login-banner');
  const uploadForm = document.getElementById('upload-form');
  const heroSection = document.getElementById('hero-section');

  // Initially disable form until auth check completes
  if (uploadForm) {
    uploadForm.style.opacity = '0.5';
    uploadForm.style.pointerEvents = 'none';
  }

  onAuthStateChanged(auth, (user) => {
    
    if (!user) {
      // Not logged in - show login banner, disable form
      submitBtn.disabled = true;
      submitBtn.textContent = 'üîí Login Required to Upload';
      loginBanner.classList.remove('hidden');
      
      if (uploadForm) {
        uploadForm.style.opacity = '0.5';
        uploadForm.style.pointerEvents = 'none';
        uploadForm.querySelectorAll('input, textarea, button, select').forEach(el => {
          el.disabled = true;
        });
      }
      
    } else {
      // Logged in - enable form
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload Mix';
      loginBanner.classList.add('hidden');
      
      if (uploadForm) {
        uploadForm.style.opacity = '1';
        uploadForm.style.pointerEvents = 'auto';
        uploadForm.querySelectorAll('input, textarea, button, select').forEach(el => {
          el.disabled = false;
        });
      }
      
    }
  });
</script>

<script>

  // Auth helper - wait for auth to be ready
  async function getAuthUser() {
    if (window.authReady) await window.authReady;
    return window.firebaseAuth?.currentUser || window.authUser || null;
  }

  let selectedAudioFile = null;
  let selectedArtworkFile = null;
  let audioDurationSeconds = 0;

  // Get elements
  const form = document.getElementById('upload-form');
  const submitBtn = document.getElementById('submit-btn');
  
  // Genre elements
  const genreSelect = document.getElementById('genre-select');
  const otherGenreContainer = document.getElementById('other-genre-container');
  const otherGenreInput = document.getElementById('other-genre');
  const otherGenreCount = document.getElementById('other-genre-count');
  
  // Audio elements
  const audioDropZone = document.getElementById('audio-drop-zone');
  const audioBrowseBtn = document.getElementById('audio-browse-btn');
  const audioFileInput = document.getElementById('audio-file-input');
  const audioPreview = document.getElementById('audio-preview');
  const audioFilename = document.getElementById('audio-filename');
  const audioFilesize = document.getElementById('audio-filesize');
  const audioDurationEl = document.getElementById('audio-duration');
  const audioDurationInput = document.getElementById('audio-duration-seconds');
  const audioRemoveBtn = document.getElementById('audio-remove-btn');
  
  // Artwork elements
  const artworkDropZone = document.getElementById('artwork-drop-zone');
  const artworkBrowseBtn = document.getElementById('artwork-browse-btn');
  const artworkFileInput = document.getElementById('artwork-file-input');
  const artworkPreview = document.getElementById('artwork-preview');
  const artworkPreviewImg = document.getElementById('artwork-preview-img');
  const artworkFilename = document.getElementById('artwork-filename');
  const artworkFilesize = document.getElementById('artwork-filesize');
  const artworkRemoveBtn = document.getElementById('artwork-remove-btn');
  
  // Progress elements
  const progressContainer = document.getElementById('upload-progress-container');
  const progressBar = document.getElementById('upload-progress-bar');
  const progressText = document.getElementById('upload-progress-text');
  const statusText = document.getElementById('upload-status-text');

  // Character counter elements
  const djNameInput = document.getElementById('dj-name');
  const djNameCount = document.getElementById('dj-name-count');
  const mixTitleInput = document.getElementById('mix-title');
  const mixTitleCount = document.getElementById('mix-title-count');
  const mixDescriptionInput = document.getElementById('mix-description');
  const mixDescriptionCount = document.getElementById('mix-description-count');
  const tracklistInput = document.getElementById('tracklist');
  const tracklistCount = document.getElementById('tracklist-count');
  const descriptionError = document.getElementById('description-error');

  // Genre selection handler
  genreSelect.addEventListener('change', () => {
    if (genreSelect.value === 'Other') {
      otherGenreContainer.classList.remove('hidden');
      otherGenreInput.required = true;
    } else {
      otherGenreContainer.classList.add('hidden');
      otherGenreInput.required = false;
      otherGenreInput.value = '';
    }
  });

  otherGenreInput.addEventListener('input', () => {
    otherGenreCount.textContent = otherGenreInput.value.length;
  });

  // Profanity filter
  const profanityList = [
    'fuck', 'shit', 'ass', 'bitch', 'damn', 'crap', 'piss', 'dick', 'cock', 
    'pussy', 'bastard', 'whore', 'slut', 'cunt', 'twat', 'bollocks', 'wanker',
    'fck', 'fuk', 'sh!t', 'b!tch', 'a$$', 'f**k', 's**t', 'b**ch'
  ];

  function validateDescription(text) {
    const lower = text.toLowerCase();
    
    const urlPatterns = [
      /https?:\/\//i,
      /www\./i,
      /\.[a-z]{2,}(\/|$|\s)/i,
      /[a-z0-9-]+\.(com|net|org|co\.uk|io|me|tv|fm|club|xyz|online)/i
    ];
    
    for (const pattern of urlPatterns) {
      if (pattern.test(text)) {
        return { valid: false, error: '‚ùå Links and URLs are not allowed' };
      }
    }
    
    for (const word of profanityList) {
      const pattern = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
      if (pattern.test(lower)) {
        return { valid: false, error: '‚ùå Please keep it clean - no profanity' };
      }
    }
    
    if (/bit\.ly|tinyurl|goo\.gl|t\.co|shorturl/i.test(text)) {
      return { valid: false, error: '‚ùå Link shorteners are not allowed' };
    }
    
    return { valid: true, error: '' };
  }

  // Character counter handlers
  djNameInput.addEventListener('input', () => {
    djNameCount.textContent = djNameInput.value.length;
  });

  mixTitleInput.addEventListener('input', () => {
    mixTitleCount.textContent = mixTitleInput.value.length;
  });

  mixDescriptionInput.addEventListener('input', () => {
    const text = mixDescriptionInput.value;
    mixDescriptionCount.textContent = text.length;
    
    if (text.trim()) {
      const validation = validateDescription(text);
      if (!validation.valid) {
        descriptionError.textContent = validation.error;
        descriptionError.classList.remove('hidden');
        mixDescriptionInput.classList.add('border-red-500');
        mixDescriptionInput.classList.remove('border-gray-300');
      } else {
        descriptionError.classList.add('hidden');
        mixDescriptionInput.classList.remove('border-red-500');
        mixDescriptionInput.classList.add('border-gray-300');
      }
    } else {
      descriptionError.classList.add('hidden');
      mixDescriptionInput.classList.remove('border-red-500');
      mixDescriptionInput.classList.add('border-gray-300');
    }
  });

  tracklistInput.addEventListener('input', () => {
    tracklistCount.textContent = tracklistInput.value.length;
  });

  // Emoji button handlers
  document.querySelectorAll('.emoji-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const emoji = btn.getAttribute('data-emoji');
      const currentText = mixDescriptionInput.value;
      const cursorPos = mixDescriptionInput.selectionStart;
      
      const newText = currentText.slice(0, cursorPos) + emoji + currentText.slice(cursorPos);
      
      if (newText.length <= 150) {
        mixDescriptionInput.value = newText;
        const newCursorPos = cursorPos + emoji.length;
        mixDescriptionInput.setSelectionRange(newCursorPos, newCursorPos);
        mixDescriptionInput.focus();
        mixDescriptionInput.dispatchEvent(new Event('input'));
        
        btn.style.transform = 'scale(1.2)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 200);
      } else {
        alert('Adding this emoji would exceed the 150 character limit!');
      }
    });
  });

  // File size formatter
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Format duration
  function formatDuration(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hrs > 0) {
      return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Audio file handling with duration calculation
  function handleAudioFile(file) {
    if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {
      alert('Please select an MP3 file');
      return;
    }

    selectedAudioFile = file;

    audioFilename.textContent = file.name;
    audioFilesize.textContent = formatFileSize(file.size);
    audioDurationEl.textContent = 'Calculating duration...';
    audioDropZone.classList.add('hidden');
    audioPreview.classList.remove('hidden');

    // Calculate duration using Audio element
    const audioUrl = URL.createObjectURL(file);
    const tempAudio = new Audio();
    
    tempAudio.addEventListener('loadedmetadata', () => {
      audioDurationSeconds = Math.round(tempAudio.duration);
      audioDurationInput.value = audioDurationSeconds;
      audioDurationEl.textContent = `Duration: ${formatDuration(audioDurationSeconds)}`;
      URL.revokeObjectURL(audioUrl);
    });

    tempAudio.addEventListener('error', () => {
      console.error('Error loading audio for duration');
      audioDurationEl.textContent = 'Duration: Unknown';
      URL.revokeObjectURL(audioUrl);
    });

    tempAudio.src = audioUrl;
  }

  audioBrowseBtn.addEventListener('click', () => audioFileInput.click());
  audioFileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      handleAudioFile(e.target.files[0]);
    }
  });

  audioDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    audioDropZone.classList.add('drag-over');
  });

  audioDropZone.addEventListener('dragleave', () => {
    audioDropZone.classList.remove('drag-over');
  });

  audioDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    audioDropZone.classList.remove('drag-over');
    if (e.dataTransfer?.files && e.dataTransfer.files[0]) {
      handleAudioFile(e.dataTransfer.files[0]);
    }
  });

  audioRemoveBtn.addEventListener('click', () => {
    selectedAudioFile = null;
    audioDurationSeconds = 0;
    audioDurationInput.value = '0';
    audioFileInput.value = '';
    audioPreview.classList.add('hidden');
    audioDropZone.classList.remove('hidden');
  });

  // Artwork file handling
  function handleArtworkFile(file) {
    if (!file.type.includes('image/')) {
      alert('Please select an image file (JPG, PNG, WEBP)');
      return;
    }

    selectedArtworkFile = file;

    const reader = new FileReader();
    reader.onload = (e) => {
      if (e.target?.result) {
        artworkPreviewImg.src = e.target.result;
      }
    };
    reader.readAsDataURL(file);

    artworkFilename.textContent = file.name;
    artworkFilesize.textContent = formatFileSize(file.size);
    artworkDropZone.classList.add('hidden');
    artworkPreview.classList.remove('hidden');
  }

  artworkBrowseBtn.addEventListener('click', () => artworkFileInput.click());
  artworkFileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      handleArtworkFile(e.target.files[0]);
    }
  });

  artworkDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    artworkDropZone.classList.add('drag-over');
  });

  artworkDropZone.addEventListener('dragleave', () => {
    artworkDropZone.classList.remove('drag-over');
  });

  artworkDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    artworkDropZone.classList.remove('drag-over');
    if (e.dataTransfer?.files && e.dataTransfer.files[0]) {
      handleArtworkFile(e.dataTransfer.files[0]);
    }
  });

  artworkRemoveBtn.addEventListener('click', () => {
    selectedArtworkFile = null;
    artworkFileInput.value = '';
    artworkPreview.classList.add('hidden');
    artworkDropZone.classList.remove('hidden');
  });

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Wait for auth to be ready
    const user = await getAuthUser();
    if (!user) {
      alert('Please log in to upload mixes');
      window.location.href = '/login?redirect=/upload-mix';
      return;
    }
    
    const djName = djNameInput.value.trim();
    const mixTitle = mixTitleInput.value.trim();
    const mixDescription = mixDescriptionInput.value.trim();
    const tracklist = tracklistInput.value.trim();
    const genreValue = genreSelect.value;
    const otherGenreValue = otherGenreInput.value.trim();
    
    // Validate required fields
    if (!djName || !mixTitle) {
      alert('Please fill in DJ Name and Mix Title');
      return;
    }

    if (!genreValue) {
      alert('Please select a genre');
      return;
    }

    if (genreValue === 'Other' && !otherGenreValue) {
      alert('Please specify the genre');
      otherGenreInput.focus();
      return;
    }

    // Validate description if provided
    if (mixDescription) {
      const validation = validateDescription(mixDescription);
      if (!validation.valid) {
        alert(validation.error + '\n\nPlease update your shout outs and try again.');
        mixDescriptionInput.focus();
        return;
      }
    }

    if (!selectedAudioFile) {
      alert('Please select an audio file');
      return;
    }

    // Determine final genre
    const finalGenre = genreValue === 'Other' ? otherGenreValue : genreValue;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Uploading...';
    progressContainer.classList.remove('hidden');

    try {
      const formData = new FormData();
      formData.append('djName', djName);
      formData.append('mixTitle', mixTitle);
      formData.append('mixDescription', mixDescription);
      formData.append('genre', finalGenre);
      formData.append('tracklist', tracklist);
      formData.append('durationSeconds', audioDurationSeconds.toString());
      formData.append('audioFile', selectedAudioFile);
      
      // Add userId from auth (user is already verified above) or cookie fallback
      const userId = user?.uid || getCookie('partnerId') || getCookie('customerId') || '';
      formData.append('userId', userId);
      
      if (selectedArtworkFile) {
        formData.append('artworkFile', selectedArtworkFile);
      }

      statusText.textContent = 'Uploading audio file...';

      // Use XMLHttpRequest for real upload progress tracking
      const result = await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        
        // Track upload progress (data being sent to server)
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            // Cap visual progress at 85% during upload phase
            // Server processing takes the remaining 15%
            const visualProgress = Math.min(percentComplete * 0.85, 85);
            progressBar.style.width = visualProgress + '%';
            progressText.textContent = Math.round(visualProgress) + '%';
            
            // Update status text based on progress
            if (percentComplete < 100) {
              const mbUploaded = (e.loaded / (1024 * 1024)).toFixed(1);
              const mbTotal = (e.total / (1024 * 1024)).toFixed(1);
              statusText.textContent = `Uploading... ${mbUploaded}MB / ${mbTotal}MB`;
            }
          }
        });
        
        // When upload to server completes, show processing state
        xhr.upload.addEventListener('load', () => {
          progressBar.style.width = '90%';
          progressText.textContent = '90%';
          statusText.textContent = 'Processing on server...';
          submitBtn.textContent = 'Processing...';
        });
        
        // Handle response
        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const response = JSON.parse(xhr.responseText);
              resolve(response);
            } catch (e) {
              reject(new Error('Invalid server response'));
            }
          } else {
            try {
              const errorResponse = JSON.parse(xhr.responseText);
              reject(new Error(errorResponse.error || errorResponse.details || `Server error: ${xhr.status}`));
            } catch (e) {
              reject(new Error(`Server error: ${xhr.status}`));
            }
          }
        });
        
        xhr.addEventListener('error', () => {
          reject(new Error('Network error - please check your connection'));
        });
        
        xhr.addEventListener('abort', () => {
          reject(new Error('Upload cancelled'));
        });
        
        xhr.open('POST', '/api/upload-mix');
        xhr.send(formData);
      });

      // Upload complete!
      progressBar.style.width = '100%';
      progressText.textContent = '100%';

      if (result.success) {
        
        statusText.textContent = 'Upload complete! Mix is now LIVE!';
        submitBtn.textContent = 'Complete!';
        
        alert(`‚úÖ Mix uploaded and published successfully!

Mix: ${mixTitle}
DJ: ${djName}
Genre: ${finalGenre}
Duration: ${formatDuration(audioDurationSeconds)}
Status: LIVE

Your mix is now available on the DJ Mixes page!`);
        
        setTimeout(() => {
          window.location.href = '/dj-mixes';
        }, 2000);
      } else {
        throw new Error(result.error || result.details || 'Upload failed');
      }

    } catch (error) {
      console.error('‚úó Upload error:', error);
      statusText.textContent = 'Upload failed - ' + (error.message || 'Unknown error');
      
      alert(`Failed to upload mix: ${error.message || 'Unknown error'}\n\nPlease check your connection and try again.`);
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload Mix';
      progressContainer.classList.add('hidden');
      progressBar.style.width = '0%';
    }
  });

</script>