---
// src/pages/blog/[slug].astro
// Individual blog post page with full article and SEO

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { blogPosts, getPostBySlug } from '../../data/blog-posts';

export const prerender = true;

export function getStaticPaths() {
  return blogPosts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { slug } = Astro.params;
const error = !post ? 'Post not found' : null;

// Format date helper
function formatDate(dateString: string): string {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

// Estimate read time
function getReadTime(content: string): string {
  if (!content) return '1 min read';
  const text = content.replace(/<[^>]*>/g, '');
  const words = text.split(/\s+/).length;
  const minutes = Math.max(1, Math.ceil(words / 200));
  return `${minutes} min read`;
}

// Generate excerpt from content if not provided
function generateExcerpt(content: string, maxLength: number = 160): string {
  if (!content) return '';
  const text = content.replace(/<[^>]*>/g, '');
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

// Apply Fresh Wax branding to text (white Fresh, red Wax)
function brandFreshWax(text: string): string {
  if (!text) return '';
  return text.replace(/Fresh\s+Wax/gi, 'Fresh <span class="text-red">Wax</span>');
}

// Prepare SEO data
const seoTitle = post?.title || 'Post Not Found';
const seoDescription = post?.excerpt || (post?.content ? generateExcerpt(post.content) : 'Read this article on Fresh Wax blog.');
const seoImage = post?.featuredImage || '/og-image.jpg';
const publishedTime = post?.publishedAt || new Date().toISOString();
const modifiedTime = publishedTime;
---

<Layout
  title={seoTitle}
  description={seoDescription}
  image={seoImage}
  type="article"
  article={{
    publishedTime: publishedTime,
    modifiedTime: modifiedTime,
    author: post?.author || 'Fresh Wax',
    tags: post?.tags || [],
    section: post?.category || 'Blog'
  }}
  breadcrumbs={[
    { name: 'Blog', url: '/blog' },
    { name: post?.title || 'Post', url: `/blog/${slug}` }
  ]}
>
  <Header />

  <div class="blog-post-page">
    <!-- Branded Header -->
    <div class="blog-header">
      <a href="/blog" class="blog-title-link">
        <h2 class="blog-site-title">FRESH <span class="text-red">WAX</span> BLOG</h2>
      </a>
    </div>

    {error || !post ? (
      <div class="error-container">
        <div class="error-content">
          <h1>Post Not Found</h1>
          <p>The article you're looking for doesn't exist or has been removed.</p>
          <a href="/blog" class="back-link">← Back to Blog</a>
        </div>
      </div>
    ) : (
      <article class="blog-article">
        <!-- Featured Image -->
        {post.featuredImage && (
          <div class="featured-image">
            <img src={post.featuredImage} alt={post.title} />
          </div>
        )}

        <!-- Article Header -->
        <header class="article-header">
          <div class="header-meta">
            {post.category && (
              <span class="category-badge">{post.category}</span>
            )}
            <span class="date">{formatDate(post.publishedAt)}</span>
            <span class="separator">·</span>
            <span class="read-time">{getReadTime(post.content)}</span>
          </div>

          <h1 class="article-title" set:html={brandFreshWax(post.title)} />

          {post.excerpt && (
            <p class="article-excerpt">{post.excerpt}</p>
          )}

          <div class="author-info">
            <div class="author-avatar">
              <span class="avatar-initial">{(post.author || 'F')[0].toUpperCase()}</span>
            </div>
            <div class="author-details">
              <span class="author-name">{post.author || 'Fresh Wax'}</span>
              <span class="author-role">Author</span>
            </div>
          </div>
        </header>

        <!-- Article Content -->
        <div class="article-content" set:html={post.content} />

        <!-- Tags -->
        {post.tags && post.tags.length > 0 && (
          <div class="article-tags">
            <span class="tags-label">Tags:</span>
            {post.tags.map((tag: string) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}

        <!-- Share Section -->
        <div class="share-section">
          <span class="share-label">Share this article:</span>
          <div class="share-buttons">
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(`https://freshwax.co.uk/blog/${slug}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="share-btn twitter"
              aria-label="Share on Twitter"
            >
              <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(`https://freshwax.co.uk/blog/${slug}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="share-btn facebook"
              aria-label="Share on Facebook"
            >
              <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <button
              class="share-btn copy"
              aria-label="Copy link"
              onclick="copyLink()"
            >
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="article-nav">
          <a href="/blog" class="nav-link">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Blog
          </a>
        </nav>
      </article>
    )}
  </div>

  <Footer />
</Layout>

<script is:inline>
  function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
      const btn = document.querySelector('.share-btn.copy');
      if (btn) {
        btn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
        setTimeout(() => {
          btn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>';
        }, 2000);
      }
    });
  }
</script>

<style>
  .blog-post-page {
    min-height: 100vh;
    background: #000000;
  }

  /* Branded Header */
  .blog-header {
    padding: 2rem 1.5rem;
    text-align: center;
    border-bottom: 1px solid #1a1a1a;
  }

  .blog-title-link {
    text-decoration: none;
  }

  .blog-site-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #ffffff;
    letter-spacing: 0.1em;
    margin: 0;
  }

  .blog-site-title .text-red,
  .article-title :global(.text-red),
  :global(.text-red) {
    color: #dc2626;
  }

  /* Error State */
  .error-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    padding: 2rem;
  }

  .error-content {
    text-align: center;
  }

  .error-content h1 {
    font-size: 2rem;
    color: #ffffff;
    margin-bottom: 1rem;
  }

  .error-content p {
    color: #9ca3af;
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #dc2626;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: #ef4444;
  }

  /* Article Layout */
  .blog-article {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1.5rem 4rem;
  }

  /* Featured Image */
  .featured-image {
    position: relative;
    margin: 0 -1.5rem 2rem;
    aspect-ratio: 16/9;
    overflow: hidden;
    background: #1a1a1a;
  }

  @media (min-width: 900px) {
    .featured-image {
      margin: 0 -100px 3rem;
      border-radius: 1rem;
    }
  }

  .featured-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Article Header */
  .article-header {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #222222;
  }

  .header-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #9ca3af;
  }

  .category-badge {
    padding: 0.25rem 0.75rem;
    background: #dc2626;
    color: #ffffff;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .separator {
    color: #4b5563;
  }

  .article-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: #ffffff;
    line-height: 1.2;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
  }

  .article-excerpt {
    font-size: 1.25rem;
    color: #9ca3af;
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #dc2626;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .avatar-initial {
    color: #ffffff;
    font-size: 1.25rem;
    font-weight: 700;
  }

  .author-details {
    display: flex;
    flex-direction: column;
  }

  .author-name {
    color: #ffffff;
    font-weight: 600;
  }

  .author-role {
    color: #6b7280;
    font-size: 0.875rem;
  }

  /* Article Content */
  .article-content {
    font-size: 1.125rem;
    line-height: 1.8;
    color: #d1d5db;
  }

  .article-content :global(h1),
  .article-content :global(h2),
  .article-content :global(h3),
  .article-content :global(h4),
  .article-content :global(h5),
  .article-content :global(h6) {
    color: #ffffff;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .article-content :global(h2) {
    font-size: 1.75rem;
  }

  .article-content :global(h3) {
    font-size: 1.5rem;
  }

  .article-content :global(p) {
    margin-bottom: 1.5rem;
  }

  .article-content :global(a) {
    color: #dc2626;
    text-decoration: underline;
    transition: color 0.2s;
  }

  .article-content :global(a:hover) {
    color: #ef4444;
  }

  .article-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 2rem 0;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid #dc2626;
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #9ca3af;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .article-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .article-content :global(code) {
    background: #1f1f1f;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    font-family: 'Fira Code', monospace;
  }

  .article-content :global(pre) {
    background: #1f1f1f;
    padding: 1.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 2rem 0;
  }

  .article-content :global(pre code) {
    background: none;
    padding: 0;
  }

  /* Tags */
  .article-tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #222222;
  }

  .tags-label {
    color: #6b7280;
    font-size: 0.875rem;
  }

  .tag {
    padding: 0.35rem 0.75rem;
    background: #1f1f1f;
    color: #9ca3af;
    font-size: 0.8rem;
    border-radius: 2rem;
    border: 1px solid #333333;
  }

  /* Share Section */
  .share-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #222222;
  }

  .share-label {
    color: #6b7280;
    font-size: 0.875rem;
  }

  .share-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .share-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1f1f1f;
    border: 1px solid #333333;
    border-radius: 0.5rem;
    color: #9ca3af;
    text-decoration: none;
    transition: all 0.2s;
    cursor: pointer;
  }

  .share-btn:hover {
    color: #ffffff;
    border-color: #444444;
  }

  .share-btn.twitter:hover {
    background: #1da1f2;
    border-color: #1da1f2;
  }

  .share-btn.facebook:hover {
    background: #1877f2;
    border-color: #1877f2;
  }

  .share-btn.copy:hover {
    background: #dc2626;
    border-color: #dc2626;
  }

  .share-btn svg {
    width: 18px;
    height: 18px;
  }

  /* Navigation */
  .article-nav {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #222222;
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #dc2626;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
  }

  .nav-link:hover {
    color: #ef4444;
  }

  .nav-link svg {
    width: 20px;
    height: 20px;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .article-title {
      font-size: 1.75rem;
    }

    .article-excerpt {
      font-size: 1rem;
    }

    .article-content {
      font-size: 1rem;
    }

    .share-section {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
