---
// Registration page with role selection
// All users get customer + DJ base access automatically
// Artist and Merch Seller require admin approval

const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID
};

// reCAPTCHA site key (v3)
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || '';
---
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register | Fresh Wax</title>
  <!-- reCAPTCHA v3 - loaded dynamically if site key is configured -->
</head>
<body>
  <main class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <a href="/" class="logo-link">
          <div class="logo-wrapper">
            <img src="/logo.webp" alt="Fresh Wax" class="logo-img" width="160" height="53">
          </div>
        </a>
        <h1 class="brand-title"><span class="brand-fresh">Fresh</span> <span class="brand-wax">Wax</span></h1>
        <h2>Create Account</h2>
        <p>Join the jungle & drum and bass community</p>
      </div>

      <!-- Social Login Options -->
      <div class="social-login">
        <button type="button" id="googleSignIn" class="btn btn-social btn-google">
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span>Continue with Google</span>
        </button>
      </div>

      <div class="form-divider">
        <span>or register with email</span>
      </div>

      <form id="registerForm" class="auth-form">
        <div class="form-group">
          <label for="displayName">Display Name</label>
          <div class="input-with-status">
            <input type="text" id="displayName" name="displayName" required placeholder="Enter the name you want use across the site" minlength="2" maxlength="30">
            <span class="input-status" id="displayNameStatus"></span>
          </div>
          <small class="input-hint" id="displayNameHint"></small>
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required placeholder="your@email.com">
        </div>

        <div class="form-group password-field">
          <label for="password">Password</label>
          <div class="input-wrapper">
            <input type="password" id="password" name="password" required minlength="8">
            <button type="button" class="password-toggle" data-target="password" aria-label="Show password">
              <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
          <div class="password-strength" id="passwordStrength">
            <div class="strength-bar">
              <div class="strength-fill" id="strengthFill"></div>
            </div>
            <span class="strength-text" id="strengthText"></span>
          </div>
          <ul class="password-requirements" id="passwordRequirements">
            <li id="req-length"><span class="req-icon">○</span> At least 8 characters</li>
            <li id="req-upper"><span class="req-icon">○</span> One uppercase letter</li>
            <li id="req-number"><span class="req-icon">○</span> One number</li>
            <li id="req-special"><span class="req-icon">○</span> One special character</li>
          </ul>
        </div>

        <div class="form-group password-field">
          <label for="confirmPassword">Confirm Password</label>
          <div class="input-wrapper">
            <input type="password" id="confirmPassword" name="confirmPassword" required>
            <button type="button" class="password-toggle" data-target="confirmPassword" aria-label="Show password">
              <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-divider">
          <span>Account Type</span>
        </div>

        <div class="role-selection">
          <p class="role-info">Select additional roles below if needed:</p>

          <label class="role-option role-included">
            <input type="checkbox" checked disabled>
            <div class="role-content">
              <span class="role-title">Customer / DJ <span class="role-badge">Included</span></span>
              <span class="role-desc">Buy music, comment, rate releases, upload DJ mixes, and book live stream slots.</span>
            </div>
          </label>

          <label class="role-option">
            <input type="checkbox" name="requestArtist" id="requestArtist">
            <div class="role-content">
              <span class="role-title">Artist / Label</span>
              <span class="role-desc">Upload and sell releases on the store. Requires admin approval.</span>
            </div>
          </label>

          <label class="role-option">
            <input type="checkbox" name="requestMerchSeller" id="requestMerchSeller">
            <div class="role-content">
              <span class="role-title">Merch Seller</span>
              <span class="role-desc">Sell merchandise through Fresh Wax. Requires admin approval.</span>
            </div>
          </label>

          <label class="role-option">
            <input type="checkbox" name="requestVinylSeller" id="requestVinylSeller">
            <div class="role-content">
              <span class="role-title">Vinyl Seller</span>
              <span class="role-desc">Sell vinyl records through the Crates marketplace. Requires admin approval.</span>
            </div>
          </label>
        </div>

        <div id="artistDetails" class="conditional-fields" style="display: none;">
          <div class="form-group">
            <label for="artistName">Artist / Label Name</label>
            <input type="text" id="artistName" name="artistName" placeholder="Your artist or label name">
          </div>
          <div class="form-group">
            <label for="artistBio">Tell us about yourself</label>
            <textarea id="artistBio" name="artistBio" rows="3" placeholder="Brief description of your music, releases, etc."></textarea>
          </div>
          <div class="form-group">
            <label for="artistLinks">Links (SoundCloud, Bandcamp, etc.)</label>
            <input type="text" id="artistLinks" name="artistLinks" placeholder="https://soundcloud.com/yourname">
          </div>
        </div>

        <div id="merchDetails" class="conditional-fields" style="display: none;">
          <div class="form-group">
            <label for="businessName">Business Name</label>
            <input type="text" id="businessName" name="businessName" placeholder="Your business or brand name">
          </div>
          <div class="form-group">
            <label for="merchDescription">What do you sell?</label>
            <textarea id="merchDescription" name="merchDescription" rows="3" placeholder="Describe the merchandise you want to sell"></textarea>
          </div>
          <div class="form-group">
            <label for="merchWebsite">Website (optional)</label>
            <input type="text" id="merchWebsite" name="merchWebsite" placeholder="https://yourwebsite.com">
          </div>
        </div>

        <div id="vinylDetails" class="conditional-fields" style="display: none;">
          <div class="form-group">
            <label for="vinylStoreName">Store / Seller Name</label>
            <input type="text" id="vinylStoreName" name="vinylStoreName" placeholder="Your store or seller name">
          </div>
          <div class="form-group">
            <label for="vinylDescription">Tell us about your collection</label>
            <textarea id="vinylDescription" name="vinylDescription" rows="3" placeholder="What kind of vinyl do you sell? Genres, era, condition, quantity..."></textarea>
          </div>
          <div class="form-group">
            <label for="vinylLocation">Location (City/Region)</label>
            <input type="text" id="vinylLocation" name="vinylLocation" placeholder="e.g. London, Manchester, Bristol">
          </div>
          <div class="form-group">
            <label for="vinylDiscogsUrl">Discogs Profile (optional)</label>
            <input type="text" id="vinylDiscogsUrl" name="vinylDiscogsUrl" placeholder="https://discogs.com/user/yourname">
          </div>
        </div>

        <div class="form-group terms-container">
          <label class="checkbox-label">
            <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
            <span>I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a></span>
          </label>
        </div>

        <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
          <span class="btn-text">Create Account</span>
          <span class="btn-loading" style="display: none;">Creating...</span>
        </button>

        <div id="formError" class="form-error" style="display: none;"></div>
        <div id="formSuccess" class="form-success" style="display: none;"></div>

        <p class="recaptcha-notice">
          This site is protected by reCAPTCHA and the Google
          <a href="https://policies.google.com/privacy" target="_blank">Privacy Policy</a> and
          <a href="https://policies.google.com/terms" target="_blank">Terms of Service</a> apply.
        </p>
      </form>

      <div class="auth-footer">
        <p>Already have an account? <a href="/login">Sign in</a></p>
      </div>
    </div>
  </main>

  <style>
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: var(--bg-primary, #0a0a0a);
    }

    .auth-card {
      width: 100%;
      max-width: 560px;
      background: var(--bg-secondary, #141414);
      border-radius: 12px;
      padding: 2.5rem;
      border: 1px solid var(--border-color, #262626);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo-link {
      display: inline-block;
      margin-bottom: 1rem;
    }

    .logo-wrapper {
      width: 100px;
      height: 100px;
      background: #fff;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      padding: 0.5rem;
    }

    .logo-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .brand-title {
      font-size: 2rem;
      font-weight: 700;
      margin: 1rem 0 0.5rem;
    }

    .brand-title .brand-fresh {
      color: #fff;
    }

    .brand-title .brand-wax {
      color: #dc2626;
    }

    .auth-header h2 {
      margin: 1rem 0 0.5rem;
      font-size: 1.75rem;
      color: var(--text-primary, #fff);
    }

    .auth-header p {
      color: var(--text-secondary, #a3a3a3);
      font-size: 1rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: var(--text-secondary, #a3a3a3);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--bg-tertiary, #1a1a1a);
      border: 1px solid var(--border-color, #262626);
      border-radius: 8px;
      color: var(--text-primary, #fff);
      font-size: 1.05rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #ef4444;
    }

    .password-field .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-field .input-wrapper input {
      padding-right: 3rem;
      width: 100%;
    }

    .password-toggle {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted, #666);
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      z-index: 10;
    }

    .password-toggle:hover {
      color: var(--text-primary, #fff);
    }

    .password-toggle:focus {
      outline: none;
      color: var(--text-primary, #fff);
    }

    .form-divider {
      display: flex;
      align-items: center;
      margin: 1.75rem 0;
      color: var(--text-secondary, #a3a3a3);
      font-size: 1rem;
    }

    .form-divider::before,
    .form-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color, #262626);
    }

    .form-divider span {
      padding: 0 1rem;
    }

    .role-selection {
      margin-bottom: 1.75rem;
    }

    .role-info {
      font-size: 1rem;
      color: var(--text-secondary, #a3a3a3);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .role-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1.125rem;
      background: var(--bg-tertiary, #1a1a1a);
      border: 1px solid var(--border-color, #262626);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .role-option:hover {
      border-color: #ef4444;
    }

    .role-option input {
      margin-top: 0.25rem;
      accent-color: #ef4444;
      width: 18px;
      height: 18px;
    }

    .role-content {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .role-title {
      font-weight: 600;
      color: var(--text-primary, #fff);
      font-size: 1.05rem;
    }

    .role-desc {
      font-size: 0.9rem;
      color: var(--text-secondary, #a3a3a3);
    }

    .role-included {
      opacity: 0.7;
      cursor: default;
      border-color: #22c55e40;
      background: #22c55e10;
    }

    .role-included:hover {
      border-color: #22c55e40;
    }

    .role-badge {
      font-size: 0.7rem;
      background: #22c55e;
      color: #000;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .conditional-fields {
      background: var(--bg-tertiary, #1a1a1a);
      border: 1px solid var(--border-color, #262626);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .conditional-fields .form-group:last-child {
      margin-bottom: 0;
    }

    .terms-container {
      margin: 1.5rem 0;
      padding: 1.125rem;
      background: var(--bg-tertiary, #1a1a1a);
      border: 1px solid var(--border-color, #262626);
      border-radius: 8px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-secondary, #a3a3a3);
    }

    .checkbox-label input {
      width: 18px;
      height: 18px;
      accent-color: #ef4444;
      flex-shrink: 0;
      margin: 0;
    }

    .checkbox-label span {
      line-height: 1.4;
    }

    .checkbox-label a {
      color: #22c55e;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    .btn {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: #ef4444;
      color: #fff;
    }

    .btn-primary:hover {
      background: #dc2626;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-full {
      width: 100%;
    }

    .form-error {
      margin-top: 1rem;
      padding: 0.875rem 1rem;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: #ef4444;
      font-size: 1rem;
    }

    .form-success {
      margin-top: 1rem;
      padding: 0.875rem 1rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      color: #22c55e;
      font-size: 1rem;
    }

    .auth-footer {
      text-align: center;
      margin-top: 1.75rem;
      padding-top: 1.75rem;
      border-top: 1px solid var(--border-color, #262626);
      color: var(--text-secondary, #a3a3a3);
      font-size: 1rem;
    }

    .auth-footer a {
      color: #fff;
      font-weight: 600;
    }

    .auth-footer a:hover {
      text-decoration: underline;
    }

    /* Social Login Buttons */
    .social-login {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .btn-social {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.875rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-color, #262626);
    }

    .btn-google {
      background: #fff;
      color: #333;
    }

    .btn-google:hover {
      background: #f5f5f5;
      border-color: #ccc;
    }

    .btn-social:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Display Name Check */
    .input-with-status {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-with-status input {
      width: 100%;
      padding-right: 2.5rem;
    }

    .input-status {
      position: absolute;
      right: 0.75rem;
      font-size: 1.25rem;
    }

    .input-status.checking {
      color: #a3a3a3;
      animation: pulse 1s infinite;
    }

    .input-status.available {
      color: #22c55e;
    }

    .input-status.taken {
      color: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .input-hint {
      display: block;
      margin-top: 0.375rem;
      font-size: 0.85rem;
      color: var(--text-secondary, #a3a3a3);
    }

    .input-hint.error {
      color: #ef4444;
    }

    .input-hint.success {
      color: #22c55e;
    }

    /* Password Strength Indicator */
    .password-strength {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .strength-bar {
      flex: 1;
      height: 4px;
      background: var(--bg-tertiary, #1a1a1a);
      border-radius: 2px;
      overflow: hidden;
    }

    .strength-fill {
      height: 100%;
      width: 0;
      transition: width 0.3s, background-color 0.3s;
      border-radius: 2px;
    }

    .strength-fill.weak {
      width: 25%;
      background: #ef4444;
    }

    .strength-fill.fair {
      width: 50%;
      background: #f97316;
    }

    .strength-fill.good {
      width: 75%;
      background: #eab308;
    }

    .strength-fill.strong {
      width: 100%;
      background: #22c55e;
    }

    .strength-text {
      font-size: 0.8rem;
      font-weight: 500;
      min-width: 50px;
    }

    .strength-text.weak { color: #ef4444; }
    .strength-text.fair { color: #f97316; }
    .strength-text.good { color: #eab308; }
    .strength-text.strong { color: #22c55e; }

    /* Password Requirements List */
    .password-requirements {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.25rem 1rem;
    }

    .password-requirements li {
      font-size: 0.8rem;
      color: var(--text-secondary, #666);
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .password-requirements li.met {
      color: #22c55e;
    }

    .password-requirements li.met .req-icon {
      color: #22c55e;
    }

    .req-icon {
      font-size: 0.7rem;
    }

    /* reCAPTCHA badge positioning */
    .grecaptcha-badge {
      visibility: hidden;
    }

    .recaptcha-notice {
      font-size: 0.75rem;
      color: var(--text-secondary, #666);
      text-align: center;
      margin-top: 1rem;
    }

    .recaptcha-notice a {
      color: var(--text-secondary, #888);
    }
  </style>

  <script>
    // Password visibility toggle - runs immediately
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.password-toggle').forEach(function(button) {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          var targetId = this.getAttribute('data-target');
          var input = document.getElementById(targetId);
          var eyeOpen = this.querySelector('.eye-open');
          var eyeClosed = this.querySelector('.eye-closed');
          
          if (input.type === 'password') {
            input.type = 'text';
            eyeOpen.style.display = 'none';
            eyeClosed.style.display = 'block';
          } else {
            input.type = 'password';
            eyeOpen.style.display = 'block';
            eyeClosed.style.display = 'none';
          }
        });
      });
    });
  </script>

  <script type="module" define:vars={{ firebaseConfig, recaptchaSiteKey }}>
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, updateProfile, sendEmailVerification, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Initialize reCAPTCHA if site key is configured
    let recaptchaReady = false;
    if (recaptchaSiteKey) {
      const script = document.createElement('script');
      script.src = `https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`;
      script.async = true;
      script.onload = () => {
        grecaptcha.ready(() => {
          recaptchaReady = true;
          console.log('[Register] reCAPTCHA ready');
        });
      };
      document.head.appendChild(script);
    }

    // Get reCAPTCHA token
    async function getRecaptchaToken(action) {
      if (!recaptchaSiteKey || !recaptchaReady) return null;
      try {
        return await grecaptcha.execute(recaptchaSiteKey, { action });
      } catch (err) {
        console.error('[Register] reCAPTCHA error:', err);
        return null;
      }
    }

    // ==================== PASSWORD STRENGTH CHECKER ====================
    const passwordInput = document.getElementById('password');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const reqLength = document.getElementById('req-length');
    const reqUpper = document.getElementById('req-upper');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');

    function checkPasswordStrength(password) {
      const checks = {
        length: password.length >= 8,
        upper: /[A-Z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~]/.test(password)
      };

      // Update requirement indicators
      updateRequirement(reqLength, checks.length);
      updateRequirement(reqUpper, checks.upper);
      updateRequirement(reqNumber, checks.number);
      updateRequirement(reqSpecial, checks.special);

      // Calculate strength score
      const score = Object.values(checks).filter(Boolean).length;

      // Update strength bar and text
      strengthFill.className = 'strength-fill';
      strengthText.className = 'strength-text';

      if (password.length === 0) {
        strengthText.textContent = '';
        return;
      }

      if (score <= 2) {
        strengthFill.classList.add('weak');
        strengthText.classList.add('weak');
        strengthText.textContent = 'Weak';
      } else if (score === 3) {
        strengthFill.classList.add('fair');
        strengthText.classList.add('fair');
        strengthText.textContent = 'Fair';
      } else if (score === 4) {
        strengthFill.classList.add('good');
        strengthText.classList.add('good');
        strengthText.textContent = 'Good';
      } else {
        strengthFill.classList.add('strong');
        strengthText.classList.add('strong');
        strengthText.textContent = 'Strong';
      }

      return checks;
    }

    function updateRequirement(element, met) {
      if (met) {
        element.classList.add('met');
        element.querySelector('.req-icon').textContent = '✓';
      } else {
        element.classList.remove('met');
        element.querySelector('.req-icon').textContent = '○';
      }
    }

    passwordInput.addEventListener('input', () => {
      checkPasswordStrength(passwordInput.value);
    });

    // ==================== DISPLAY NAME AVAILABILITY CHECK ====================
    const displayNameInput = document.getElementById('displayName');
    const displayNameStatus = document.getElementById('displayNameStatus');
    const displayNameHint = document.getElementById('displayNameHint');
    let nameCheckTimeout = null;
    let lastCheckedName = '';

    async function checkDisplayNameAvailability(name) {
      if (name.length < 2) {
        displayNameStatus.textContent = '';
        displayNameStatus.className = 'input-status';
        displayNameHint.textContent = '';
        displayNameHint.className = 'input-hint';
        return;
      }

      // Show checking status
      displayNameStatus.textContent = '⟳';
      displayNameStatus.className = 'input-status checking';
      displayNameHint.textContent = 'Checking availability...';
      displayNameHint.className = 'input-hint';

      try {
        // Query users collection for this display name (case-insensitive)
        const normalizedName = name.toLowerCase();
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('displayNameLower', '==', normalizedName));
        const snapshot = await getDocs(q);

        // Also check customers collection
        const customersRef = collection(db, 'customers');
        const q2 = query(customersRef, where('displayNameLower', '==', normalizedName));
        const snapshot2 = await getDocs(q2);

        const isTaken = !snapshot.empty || !snapshot2.empty;

        if (isTaken) {
          displayNameStatus.textContent = '✗';
          displayNameStatus.className = 'input-status taken';
          displayNameHint.textContent = 'This name is already taken';
          displayNameHint.className = 'input-hint error';
        } else {
          displayNameStatus.textContent = '✓';
          displayNameStatus.className = 'input-status available';
          displayNameHint.textContent = 'Name is available';
          displayNameHint.className = 'input-hint success';
        }
      } catch (err) {
        console.error('[Register] Name check error:', err);
        displayNameStatus.textContent = '';
        displayNameStatus.className = 'input-status';
        displayNameHint.textContent = '';
        displayNameHint.className = 'input-hint';
      }
    }

    displayNameInput.addEventListener('input', () => {
      const name = displayNameInput.value.trim();

      // Clear previous timeout
      if (nameCheckTimeout) clearTimeout(nameCheckTimeout);

      // Don't check if same as last
      if (name === lastCheckedName) return;

      // Debounce the check
      nameCheckTimeout = setTimeout(() => {
        lastCheckedName = name;
        checkDisplayNameAvailability(name);
      }, 500);
    });

    // ==================== GOOGLE SIGN-IN HANDLER ====================
    const googleBtn = document.getElementById('googleSignIn');

    googleBtn.addEventListener('click', async () => {
      formError.style.display = 'none';

      try {
        // Get reCAPTCHA token for social login
        const recaptchaToken = await getRecaptchaToken('social_login');

        const provider = new GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');

        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Check if user already exists
        const userDoc = await getDoc(doc(db, 'users', user.uid));

        if (userDoc.exists()) {
          // Existing user - redirect to dashboard
          window.location.href = '/account/dashboard';
          return;
        }

        // New user - create account
        const userData = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          displayNameLower: (user.displayName || user.email.split('@')[0]).toLowerCase(),
          photoURL: user.photoURL || null,
          provider: 'Google',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          roles: {
            customer: true,
            djEligible: false,
            artist: false,
            merchSeller: false,
            vinylSeller: false
          },
          pendingRoles: {}
        };

        await setDoc(doc(db, 'users', user.uid), userData);

        // Also create in customers collection
        await setDoc(doc(db, 'customers', user.uid), {
          uid: user.uid,
          email: user.email,
          displayName: userData.displayName,
          displayNameLower: userData.displayNameLower,
          createdAt: serverTimestamp()
        });

        // Social login users are considered verified
        formSuccess.innerHTML = `
          <strong>Welcome to Fresh Wax!</strong><br>
          Your account has been created with Google.
        `;
        formSuccess.style.display = 'block';

        setTimeout(() => {
          window.location.href = '/account/dashboard';
        }, 2000);

      } catch (error) {
        console.error('[Register] Google sign-in error:', error);

        if (error.code === 'auth/popup-closed-by-user') {
          return;
        }

        if (error.code === 'auth/account-exists-with-different-credential') {
          formError.textContent = 'An account already exists with this email. Try signing in with email/password.';
        } else {
          formError.textContent = 'Google sign-in failed. Please try again.';
        }
        formError.style.display = 'block';
      }
    });

    // ==================== TOGGLE CONDITIONAL FIELDS ====================
    const artistCheckbox = document.getElementById('requestArtist');
    const merchCheckbox = document.getElementById('requestMerchSeller');
    const vinylCheckbox = document.getElementById('requestVinylSeller');
    const artistDetails = document.getElementById('artistDetails');
    const merchDetails = document.getElementById('merchDetails');
    const vinylDetails = document.getElementById('vinylDetails');

    artistCheckbox.addEventListener('change', () => {
      artistDetails.style.display = artistCheckbox.checked ? 'block' : 'none';
    });

    merchCheckbox.addEventListener('change', () => {
      merchDetails.style.display = merchCheckbox.checked ? 'block' : 'none';
    });

    vinylCheckbox.addEventListener('change', () => {
      vinylDetails.style.display = vinylCheckbox.checked ? 'block' : 'none';
    });

    // ==================== FORM SUBMISSION ====================
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const formError = document.getElementById('formError');
    const formSuccess = document.getElementById('formSuccess');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset messages
      formError.style.display = 'none';
      formSuccess.style.display = 'none';

      // Get form data
      const displayName = document.getElementById('displayName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const requestArtist = artistCheckbox.checked;
      const requestMerchSeller = merchCheckbox.checked;
      const requestVinylSeller = vinylCheckbox.checked;

      // Validation
      if (displayName.length < 2) {
        formError.textContent = 'Display name must be at least 2 characters';
        formError.style.display = 'block';
        return;
      }

      // Check if display name is taken
      if (displayNameStatus.className.includes('taken')) {
        formError.textContent = 'Please choose a different display name';
        formError.style.display = 'block';
        return;
      }

      if (password !== confirmPassword) {
        formError.textContent = 'Passwords do not match';
        formError.style.display = 'block';
        return;
      }

      // Check password strength
      const pwChecks = checkPasswordStrength(password);
      if (!pwChecks.length) {
        formError.textContent = 'Password must be at least 8 characters';
        formError.style.display = 'block';
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';

      // Get reCAPTCHA token
      const recaptchaToken = await getRecaptchaToken('register');

      try {
        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Update display name
        await updateProfile(user, { displayName });

        // Build user document
        const userData = {
          uid: user.uid,
          email: user.email,
          displayName: displayName,
          displayNameLower: displayName.toLowerCase(),
          provider: 'email',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          roles: {
            customer: true,  // Auto-granted
            djEligible: false,  // Must meet requirements
            artist: false,  // Requires approval
            merchSeller: false,  // Requires approval
            vinylSeller: false  // Requires approval
          },
          pendingRoles: {}
        };

        // Add artist request if selected
        if (requestArtist) {
          userData.pendingRoles.artist = {
            requestedAt: serverTimestamp(),
            status: 'pending',
            artistName: document.getElementById('artistName').value.trim(),
            bio: document.getElementById('artistBio').value.trim(),
            links: document.getElementById('artistLinks').value.trim()
          };
        }

        // Add merch seller request if selected
        if (requestMerchSeller) {
          userData.pendingRoles.merchSeller = {
            requestedAt: serverTimestamp(),
            status: 'pending',
            businessName: document.getElementById('businessName').value.trim(),
            description: document.getElementById('merchDescription').value.trim(),
            website: document.getElementById('merchWebsite').value.trim()
          };
        }

        // Add vinyl seller request if selected
        if (requestVinylSeller) {
          userData.pendingRoles.vinylSeller = {
            requestedAt: serverTimestamp(),
            status: 'pending',
            storeName: document.getElementById('vinylStoreName').value.trim(),
            description: document.getElementById('vinylDescription').value.trim(),
            location: document.getElementById('vinylLocation').value.trim(),
            discogsUrl: document.getElementById('vinylDiscogsUrl').value.trim()
          };
        }

        // Save to Firestore
        await setDoc(doc(db, 'users', user.uid), userData);

        // Also create in customers collection for compatibility
        await setDoc(doc(db, 'customers', user.uid), {
          uid: user.uid,
          email: user.email,
          displayName: displayName,
          displayNameLower: displayName.toLowerCase(),
          createdAt: serverTimestamp()
        });

        // Also write pending requests to pendingRoleRequests collection (for REST API access)
        if (requestArtist) {
          await setDoc(doc(db, 'pendingRoleRequests', `${user.uid}_artist`), {
            id: `${user.uid}_artist`,
            uid: user.uid,
            userId: user.uid,
            roleType: 'artist',
            displayName: displayName,
            email: user.email,
            status: 'pending',
            requestedAt: serverTimestamp(),
            artistName: document.getElementById('artistName').value.trim(),
            bio: document.getElementById('artistBio').value.trim(),
            links: document.getElementById('artistLinks').value.trim()
          });
        }

        if (requestMerchSeller) {
          await setDoc(doc(db, 'pendingRoleRequests', `${user.uid}_merchSeller`), {
            id: `${user.uid}_merchSeller`,
            uid: user.uid,
            userId: user.uid,
            roleType: 'merchSeller',
            displayName: displayName,
            email: user.email,
            status: 'pending',
            requestedAt: serverTimestamp(),
            businessName: document.getElementById('businessName').value.trim(),
            description: document.getElementById('merchDescription').value.trim(),
            website: document.getElementById('merchWebsite').value.trim()
          });
        }

        if (requestVinylSeller) {
          await setDoc(doc(db, 'pendingRoleRequests', `${user.uid}_vinylSeller`), {
            id: `${user.uid}_vinylSeller`,
            uid: user.uid,
            userId: user.uid,
            roleType: 'vinylSeller',
            displayName: displayName,
            email: user.email,
            status: 'pending',
            requestedAt: serverTimestamp(),
            storeName: document.getElementById('vinylStoreName').value.trim(),
            description: document.getElementById('vinylDescription').value.trim(),
            location: document.getElementById('vinylLocation').value.trim(),
            discogsUrl: document.getElementById('vinylDiscogsUrl').value.trim()
          });
        }

        // Send email verification
        try {
          await sendEmailVerification(user, {
            url: window.location.origin + '/login?verified=true',
            handleCodeInApp: false
          });
          console.log('[Register] Verification email sent to:', user.email);
        } catch (verifyError) {
          console.error('[Register] Failed to send verification email:', verifyError);
          // Continue anyway - they can resend from verify-email page
        }

        // Show success message
        formSuccess.innerHTML = `
          <strong>Account created!</strong><br>
          We've sent a verification email to <strong>${email}</strong>.<br>
          Please check your inbox and click the link to verify your email.
        `;
        formSuccess.style.display = 'block';

        // Redirect to verify-email page
        setTimeout(() => {
          window.location.href = '/verify-email';
        }, 3000);

      } catch (error) {
        console.error('Registration error:', error);
        
        let errorMessage = 'Registration failed. Please try again.';
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'This email is already registered. Try signing in instead.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'Password is too weak. Please choose a stronger password.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email address.';
        }

        formError.textContent = errorMessage;
        formError.style.display = 'block';

        // Reset button
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
