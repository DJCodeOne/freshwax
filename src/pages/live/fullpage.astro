---
// src/pages/live/fullpage.astro
// Full page live stream view - large player with chat and reactions
import { ClientRouter } from 'astro:transitions';
export const prerender = false;

// GIPHY API key - use env var if set, otherwise fallback to public key
const giphyApiKey = import.meta.env.GIPHY_API_KEY || 'p0USqLUVxus8d82HAcPhQ2GqG6SfraYr';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Stream - Fresh Wax</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- HLS.js for video playback -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
  <ClientRouter />
</head>
<body>
  
  <!-- Shoutout Modal -->
  <div id="shoutoutModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content shoutout-modal-content">
      <button class="modal-close" id="closeShoutoutModal">√ó</button>
      <h2>üì£ Send a Shoutout</h2>
      <p class="shoutout-hint">Birthdays üéÇ ‚Ä¢ Big ups üôå ‚Ä¢ Locations üìç ‚Ä¢ Party vibes üéâ</p>
      <div class="shoutout-input-wrapper">
        <input type="text" id="shoutoutInput" placeholder="Type your shoutout..." maxlength="30" autocomplete="off" />
        <span class="shoutout-char-count"><span id="shoutoutCharCount">0</span>/30</span>
      </div>
      <div class="shoutout-emoji-row">
        <button type="button" class="shoutout-emoji" data-emoji="üéÇ">üéÇ</button>
        <button type="button" class="shoutout-emoji" data-emoji="üéâ">üéâ</button>
        <button type="button" class="shoutout-emoji" data-emoji="üî•">üî•</button>
        <button type="button" class="shoutout-emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
        <button type="button" class="shoutout-emoji" data-emoji="üôå">üôå</button>
        <button type="button" class="shoutout-emoji" data-emoji="üìç">üìç</button>
        <button type="button" class="shoutout-emoji" data-emoji="üéµ">üéµ</button>
        <button type="button" class="shoutout-emoji" data-emoji="üëä">üëä</button>
      </div>
      <button id="sendShoutoutBtn" class="send-shoutout-btn" disabled>
        <span>Send Shoutout</span>
        <span class="shoutout-cost">FREE</span>
      </button>
    </div>
  </div>
  
  <div class="fullpage-container">
    <div class="player-section">
      <!-- Top Bar -->
      <div class="top-bar">
        <a href="/live" class="back-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          <span>Back</span>
        </a>
        
        <div class="stream-info">
          <div class="live-badge" id="liveBadge">
            <span class="live-dot"></span>
            <span id="liveStatusText">OFFLINE</span>
          </div>
          <h1 id="streamTitle">No Live Streams</h1>
        </div>
        
        <div class="stream-stats">
          <div class="stat">
            <span class="stat-value" id="viewerCount">0</span>
            <span class="stat-label">Views</span>
          </div>
          <a href="/account/dj-lobby" id="djLobbyBtn" class="dj-lobby-btn hidden">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            <span>DJ Lobby</span>
          </a>
        </div>
      </div>
      
      <!-- Player Area -->
      <div class="player-wrapper">
        <div id="offlineOverlay" class="offline-overlay">
          <div class="offline-content">
            <div class="offline-icon">OFFLINE</div>
            <h2>No one is streaming right now</h2>
            <p>Check back soon for live sets</p>
          </div>
        </div>
        
        <div id="audioPlayer" class="audio-player hidden">
          <div class="audio-content">
            <div class="audio-cover">
              <img id="streamCover" src="/place-holder.webp" alt="Stream Cover" />
            </div>
            <div class="audio-info">
              <div class="audio-live-badge">
                <span class="live-pulse"></span>
                <span>LIVE</span>
              </div>
              <div class="audio-title" id="audioTitle">Live Stream</div>
              <div class="audio-dj" id="audioDjName">DJ Name</div>
            </div>
            <div class="audio-bars">
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
              <div class="audio-bar"></div>
            </div>
          </div>
          <audio id="audioElement" crossorigin="anonymous"></audio>
        </div>
        
        <div id="videoPlayer" class="video-player hidden" transition:persist="live-video-player">
          <video id="hlsVideoElement" class="hls-video" controls playsinline></video>
        </div>

        <!-- Playlist Player Container -->
        <div id="playlistPlayer" class="playlist-player"></div>
      </div>
      
      <!-- Controls Bar -->
      <div class="player-controls">
        <button id="playPauseBtn" class="control-btn play-btn">
          <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg id="pauseIcon" class="hidden" viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
        
        <!-- Emoji Reactions - disabled by default until stream is live -->
        <div class="inline-reactions">
          <button id="likeBtn" class="reaction-btn reactions-disabled" title="Love" data-emoji="‚ù§Ô∏è,üíñ,üíó,üíì,üíï" disabled>
            <span class="reaction-emoji">‚ù§Ô∏è</span>
          </button>
          <button id="fireBtn" class="reaction-btn reactions-disabled" title="Fire" data-emoji="üî•,üî•,üî•,üî•,üî•" disabled>
            <span class="reaction-emoji">üî•</span>
          </button>
          <button id="explosionBtn" class="reaction-btn reactions-disabled" title="Explosion" data-emoji="üí•,üí•,üí•,üí•,üí•" disabled>
            <span class="reaction-emoji">üí•</span>
          </button>
          <button id="starBtn" class="reaction-btn reactions-disabled" title="Star" data-emoji="‚≠ê,üåü,‚ú®,‚≠ê,üåü" disabled>
            <span class="reaction-emoji">‚≠ê</span>
          </button>
          <button id="bassBtn" class="reaction-btn reactions-disabled" title="Bass" data-emoji="üîä,üîä,üîâ,üîä,üéµ" disabled>
            <span class="reaction-emoji">üîä</span>
          </button>
          <button id="fistBtn" class="reaction-btn reactions-disabled" title="Fist" data-emoji="üëä,üëä,üëä,üëä,üëä" disabled>
            <span class="reaction-emoji">üëä</span>
          </button>
          <button id="rocketBtn" class="reaction-btn reactions-disabled" title="Rocket" data-emoji="üöÄ,üöÄ,üöÄ,üöÄ,üöÄ" disabled>
            <span class="reaction-emoji">üöÄ</span>
          </button>
          <button id="animToggleBtn" class="reaction-btn anim-toggle-btn reactions-disabled" title="Turn off emoji animations" disabled>
            <svg class="anim-on-icon" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            <svg class="anim-off-icon hidden" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>
          </button>
        </div>
        
        <div class="volume-control">
          <svg class="volume-icon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
          </svg>
          <input type="range" id="volumeSlider" min="0" max="100" value="80" class="volume-slider" />
        </div>
        
        <div class="listeners-dropdown-container">
          <button class="listeners-toggle" id="listenersToggle">
            <span>üë•</span>
            <span id="listenerCountMini">0</span>
            <span>listening</span>
            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M7 10l5 5 5-5z"/>
            </svg>
          </button>
          <div class="listeners-dropdown hidden" id="listenersDropdown">
            <div class="listeners-header">
              <span>üë• Listeners</span>
              <span class="listeners-count-badge" id="listenersCountBadge">0</span>
            </div>
            <div class="listeners-list" id="listenersList">
              <div class="listeners-empty">No listeners yet</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Shoutout Bar -->
      <div class="shoutout-bar" id="shoutoutBar">
        <div class="shoutout-left">
          <span class="shoutout-label">üì£ SHOUT OUTS</span>
          <button id="shoutoutBtn" class="shoutout-btn" title="Send a shoutout">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M12 5v14M5 12h14"/>
            </svg>
          </button>
        </div>
        <div class="shoutout-marquee">
          <div class="shoutout-track" id="shoutoutTrack">
            <span class="shoutout-placeholder">üéâ Send a shoutout to appear here!</span>
          </div>
        </div>
      </div>
      
      <!-- Now Playing Bar -->
      <div class="now-playing-bar" id="nowPlayingBar">
        <div class="now-playing-left">
          <img id="djAvatar" src="/place-holder.webp" alt="" class="np-avatar" />
          <div class="np-info">
            <span class="np-label" id="npLabel">NOW PLAYING</span>
            <span class="np-name" id="djName">Waiting...</span>
          </div>
        </div>
        <div class="now-playing-center">
          <span class="np-track-title" id="npTrackTitle">No track playing</span>
        </div>
        <div class="now-playing-right">
          <div class="np-duration-box">
            <span class="np-duration-value" id="npDuration">--:--</span>
            <span class="np-duration-label">LEFT</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Multi-Chat Section - 3 Columns -->
    <aside class="chat-section multi-chat">
      <!-- Fresh Wax Chat Column -->
      <div class="chat-column" id="fwChatColumn" data-chat="freshwax">
        <div class="chat-column-header">
          <div class="chat-column-title">
            <span class="chat-icon">üí¨</span>
            <span>Fresh Wax</span>
          </div>
          <button class="chat-expand-btn" data-target="freshwax" title="Expand Fresh Wax Chat">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
          </button>
        </div>
        <div class="chat-column-body">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-welcome">
              <p>Welcome to <span class="brand-fresh">Fresh</span> <span class="brand-wax">Wax</span> Live!</p>
              <p class="chat-hint">Chat is active during live streams.</p>
            </div>
          </div>

          <div id="chatInputSection" class="chat-input-section">
            <div id="loginPrompt" class="login-prompt">
              <p><a href="/login?redirect=/live/fullpage">Sign in</a> to chat</p>
            </div>

            <div id="chatForm" class="chat-form hidden">
              <div class="chat-tools">
                <button type="button" id="emojiBtn" class="tool-btn" title="Emojis">üòä</button>
                <button type="button" id="giphyBtn" class="tool-btn" title="GIFs">GIF</button>
              </div>
              <div class="chat-input-wrapper">
                <input type="text" id="chatInput" placeholder="Say something..." maxlength="500" autocomplete="off" />
                <button type="submit" id="sendBtn">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
              </div>
            </div>
          </div>

          <div id="emojiPicker" class="emoji-picker hidden">
            <div class="emoji-categories">
              <button class="emoji-cat active" data-cat="music">Music</button>
              <button class="emoji-cat" data-cat="reactions">Fire</button>
              <button class="emoji-cat" data-cat="faces">Faces</button>
              <button class="emoji-cat" data-cat="vibes">Vibes</button>
            </div>
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>

          <div id="giphyPicker" class="giphy-picker hidden">
            <div class="giphy-search">
              <input type="text" id="giphySearch" placeholder="Search GIFs..." />
            </div>
            <div class="giphy-grid" id="giphyGrid">
              <p class="giphy-hint">Search for a GIF above</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Twitch Chat Column -->
      <div class="chat-column" id="twitchChatColumn" data-chat="twitch">
        <div class="chat-column-header twitch-header">
          <div class="chat-column-title">
            <svg class="twitch-icon" viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
            </svg>
            <span>Twitch</span>
          </div>
          <button class="chat-expand-btn" data-target="twitch" title="Expand Twitch Chat">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
          </button>
        </div>
        <div class="chat-column-body">
          <iframe
            id="twitchChatFrame"
            class="external-chat-frame"
            allow="autoplay"
            allowfullscreen
          ></iframe>
          <div class="external-chat-placeholder" id="twitchChatPlaceholder">
            <svg class="placeholder-icon twitch-placeholder-icon" viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
              <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
            </svg>
            <p>Twitch chat appears when streaming</p>
          </div>
        </div>
      </div>

      <!-- YouTube Chat Column -->
      <div class="chat-column" id="youtubeChatColumn" data-chat="youtube">
        <div class="chat-column-header youtube-header">
          <div class="chat-column-title">
            <svg class="youtube-icon" viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
            <span>YouTube</span>
          </div>
          <button class="chat-expand-btn" data-target="youtube" title="Expand YouTube Chat">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
          </button>
        </div>
        <div class="chat-column-body">
          <iframe
            id="youtubeChatFrame"
            class="external-chat-frame"
            allow="autoplay"
            allowfullscreen
          ></iframe>
          <div class="external-chat-placeholder" id="youtubeChatPlaceholder">
            <svg class="placeholder-icon youtube-placeholder-icon" viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
            <p>YouTube chat appears when streaming</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Expanded Chat Modal -->
    <div id="expandedChatModal" class="expanded-chat-modal hidden">
      <div class="expanded-chat-backdrop"></div>
      <div class="expanded-chat-content">
        <div class="expanded-chat-header">
          <div class="expanded-chat-title" id="expandedChatTitle">Chat</div>
          <button class="expanded-chat-close" id="closeExpandedChat">
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        <div class="expanded-chat-body" id="expandedChatBody"></div>
      </div>
    </div>
  </div>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #0a0a0f 0%, #111118 50%, #0d0d12 100%);
    color: #fff;
    overflow: hidden;
  }
  
  .fullpage-container {
    display: grid;
    grid-template-columns: 1fr 720px;
    grid-template-rows: 1fr;
    height: 100vh;
    max-height: 100vh;
    overflow: hidden;
  }

  @media (max-width: 1400px) {
    .fullpage-container { grid-template-columns: 1fr 540px; }
  }

  @media (max-width: 1200px) {
    .fullpage-container { grid-template-columns: 1fr 400px; }
    .chat-section.multi-chat { grid-template-columns: 1fr; }
    .chat-column:nth-child(2), .chat-column:nth-child(3) { display: none; }
  }

  @media (max-width: 900px) {
    .fullpage-container { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
    .chat-section { height: 300px; }
    .chat-section.multi-chat { grid-template-columns: 1fr; }
  }
  
  .player-section {
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
    min-width: 0;
    overflow: hidden;
  }
  
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.25rem;
    background: rgba(0,0,0,0.5);
    border-bottom: 1px solid #222;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .back-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #222;
    border-radius: 8px;
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s;
    border: 1px solid #333;
  }
  
  .back-btn:hover { background: #dc2626; border-color: #dc2626; }
  
  .stream-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    min-width: 0;
  }
  
  .live-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.75rem;
    background: #333;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 1px;
    color: #888;
  }
  
  .live-badge.is-live {
    background: rgba(220, 38, 38, 0.2);
    border: 1px solid #dc2626;
    color: #dc2626;
    animation: live-badge-glow 2s ease-in-out infinite;
  }
  .live-dot { width: 8px; height: 8px; background: #888; border-radius: 50%; }
  .live-badge.is-live .live-dot { background: #dc2626; animation: pulse 1.5s ease-in-out infinite; }
  .live-badge.is-live #liveStatusText {
    animation: live-text-pulse 2s ease-in-out infinite;
  }

  @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
  @keyframes live-text-pulse {
    0%, 100% { opacity: 1; text-shadow: 0 0 5px rgba(220, 38, 38, 0.5); }
    50% { opacity: 0.7; text-shadow: 0 0 10px rgba(220, 38, 38, 0.8); }
  }
  @keyframes live-badge-glow {
    0%, 100% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.3); }
    50% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.6), 0 0 25px rgba(220, 38, 38, 0.3); }
  }
  
  .stream-info h1 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 1.5rem;
    font-weight: 400;
    letter-spacing: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .stream-stats { display: flex; align-items: center; gap: 1.5rem; }
  .stat { display: flex; flex-direction: column; align-items: center; gap: 0.125rem; }
  .stat-value { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.25rem; color: #dc2626; }
  .stat-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }

  /* Duration box - fixed width to prevent wobbling */
  .stat.duration-stat {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    min-width: 80px;
  }
  .stat.duration-stat .stat-value {
    font-variant-numeric: tabular-nums;
    min-width: 50px;
    text-align: center;
  }
  
  .dj-lobby-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #9333ea, #7c3aed);
    border-radius: 8px;
    color: #fff;
    text-decoration: none;
    font-size: 0.8125rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .dj-lobby-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4); }
  
  .player-wrapper {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    min-height: 0;
    overflow: hidden;
  }
  
  .offline-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0a0a1a 0%, #1a1033 25%, #2d1b4e 50%, #1a1033 75%, #0a0a1a 100%);
  }
  
  .offline-content { text-align: center; }
  .offline-icon { font-family: 'Bebas Neue', sans-serif; font-size: 4rem; color: #666; letter-spacing: 0.25rem; margin-bottom: 1rem; }
  .offline-content h2 { font-size: 1.25rem; color: #666; margin-bottom: 0.5rem; }
  .offline-content p { font-size: 0.875rem; color: #555; }
  
  .audio-player {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0a 100%);
  }
  
  .audio-content { text-align: center; padding: 2rem; }
  .audio-cover { width: 200px; height: 200px; margin: 0 auto 1.5rem; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 3px solid #333; }
  .audio-cover img { width: 100%; height: 100%; object-fit: cover; }
  .audio-info { margin-bottom: 1rem; }
  .audio-live-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(220, 38, 38, 0.2); border: 1px solid #dc2626; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: #dc2626; letter-spacing: 1px; margin-bottom: 0.75rem; }
  .live-pulse { width: 8px; height: 8px; background: #dc2626; border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
  .audio-title { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; letter-spacing: 1px; margin-bottom: 0.25rem; }
  .audio-dj { font-size: 1rem; color: #888; }
  
  .audio-bars { display: flex; align-items: flex-end; justify-content: center; gap: 4px; height: 50px; margin-top: 1rem; }
  .audio-bar { width: 6px; background: linear-gradient(to top, #dc2626, #f87171); border-radius: 3px; animation: barPulse 0.8s ease-in-out infinite; }
  .audio-bar:nth-child(1) { height: 20%; animation-delay: 0s; }
  .audio-bar:nth-child(2) { height: 40%; animation-delay: 0.1s; }
  .audio-bar:nth-child(3) { height: 60%; animation-delay: 0.15s; }
  .audio-bar:nth-child(4) { height: 80%; animation-delay: 0.2s; }
  .audio-bar:nth-child(5) { height: 100%; animation-delay: 0.25s; }
  .audio-bar:nth-child(6) { height: 70%; animation-delay: 0.3s; }
  .audio-bar:nth-child(7) { height: 90%; animation-delay: 0.35s; }
  .audio-bar:nth-child(8) { height: 50%; animation-delay: 0.4s; }
  .audio-bar:nth-child(9) { height: 80%; animation-delay: 0.45s; }
  .audio-bar:nth-child(10) { height: 60%; animation-delay: 0.5s; }
  .audio-bar:nth-child(11) { height: 40%; animation-delay: 0.55s; }
  .audio-bar:nth-child(12) { height: 25%; animation-delay: 0.6s; }
  @keyframes barPulse { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.4); } }
  
  .video-player { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .hls-video { width: 100%; height: 100%; max-width: 100%; max-height: 100%; object-fit: contain; background: #000; }

  /* Playlist player - fullscreen embed */
  .playlist-player {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
  }
  .playlist-player:empty { display: none; }
  .playlist-player iframe {
    width: 100% !important;
    height: 100% !important;
    border: none;
  }
  
  .player-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #111;
    border-top: 1px solid #222;
    border-bottom: 1px solid #222;
  }
  
  .control-btn {
    width: 48px;
    height: 48px;
    background: #dc2626;
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  .control-btn:hover { background: #b91c1c; transform: scale(1.05); }
  
  .inline-reactions { display: flex; align-items: center; gap: 0.25rem; flex: 1; }
  
  .reaction-btn {
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .reaction-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); transform: scale(1.1); }
  .reaction-btn:active { transform: scale(0.95); }
  .reaction-btn.liked { transform: scale(1.2); }
  .reaction-btn.disabled, .reaction-btn.reactions-disabled, .reaction-btn:disabled { opacity: 0.3; filter: grayscale(100%); cursor: not-allowed; pointer-events: none; }
  .reaction-btn.disabled:hover, .reaction-btn.reactions-disabled:hover, .reaction-btn:disabled:hover { transform: none; background: rgba(255,255,255,0.05); }
  .reaction-emoji { font-size: 1.25rem; }
  
  .reaction-btn.anim-toggle-btn { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); }
  .reaction-btn.anim-toggle-btn:hover { background: rgba(16, 185, 129, 0.2); }
  .reaction-btn.anim-toggle-btn.off { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
  .reaction-btn.anim-toggle-btn .anim-off-icon { display: none; }
  .reaction-btn.anim-toggle-btn .anim-on-icon { display: block; color: #10b981; }
  .reaction-btn.anim-toggle-btn.off .anim-off-icon { display: block; color: #ef4444; }
  .reaction-btn.anim-toggle-btn.off .anim-on-icon { display: none; }
  
  .volume-control { display: flex; align-items: center; gap: 0.5rem; }
  .volume-icon { color: #888; }
  .volume-slider { width: 100px; height: 6px; -webkit-appearance: none; appearance: none; background: #333; border-radius: 3px; cursor: pointer; }
  .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #dc2626; border-radius: 50%; cursor: pointer; }
  
  .listeners-dropdown-container { position: relative; }
  .listeners-toggle { display: flex; align-items: center; gap: 0.375rem; font-size: 0.8125rem; color: #888; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .listeners-toggle:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .listeners-toggle.active { background: rgba(220, 38, 38, 0.2); border-color: #dc2626; color: #fff; }
  .listeners-toggle.active .dropdown-arrow { transform: rotate(180deg); }
  .dropdown-arrow { transition: transform 0.2s; }
  
  .listeners-dropdown { position: absolute; bottom: calc(100% + 0.5rem); right: 0; width: 280px; background: #1a1a1a; border: 1px solid #333; border-radius: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.4); z-index: 100; overflow: hidden; }
  .listeners-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #111; border-bottom: 1px solid #333; font-weight: 600; font-size: 0.875rem; }
  .listeners-count-badge { background: #dc2626; color: #fff; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 10px; }
  .listeners-list { max-height: 250px; overflow-y: auto; }
  .listeners-empty { padding: 1.5rem; text-align: center; color: #666; font-size: 0.875rem; }
  .listener-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 1rem; border-bottom: 1px solid #222; transition: background 0.2s; }
  .listener-item:last-child { border-bottom: none; }
  .listener-item:hover { background: rgba(255,255,255,0.05); }
  .listener-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: linear-gradient(135deg, #374151, #1f2937); display: flex; align-items: center; justify-content: center; font-size: 0.875rem; flex-shrink: 0; }
  .listener-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
  .listener-info { flex: 1; min-width: 0; }
  .listener-name { font-size: 0.875rem; font-weight: 500; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .listener-status { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 0.25rem; }
  .listener-dot { width: 6px; height: 6px; background: #10b981; border-radius: 50%; }
  
  .listeners-mini { display: flex; align-items: center; gap: 0.375rem; font-size: 0.8125rem; color: #888; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; }
  
  .shoutout-bar { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: linear-gradient(90deg, rgba(220, 38, 38, 0.1) 0%, transparent 50%); border-bottom: 1px solid #222; width: 100%; overflow: hidden; }
  .shoutout-left { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
  .shoutout-label { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.875rem; letter-spacing: 1px; color: #dc2626; }
  .shoutout-btn { width: 28px; height: 28px; background: #dc2626; border: none; border-radius: 6px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .shoutout-btn:hover { background: #b91c1c; transform: scale(1.1); }
  .shoutout-btn.disabled { opacity: 0.5; cursor: not-allowed; }
  .shoutout-btn.disabled:hover { background: #dc2626; transform: none; }
  .shoutout-marquee { flex: 1; overflow: hidden; min-width: 0; position: relative; display: flex; align-items: center; justify-content: center; min-height: 24px; }
  .shoutout-track { display: inline-block; white-space: nowrap; }
  .shoutout-track.scrolling { position: absolute; left: 100%; top: 50%; transform: translateY(-50%); animation: shoutout-scroll 20s linear forwards; text-align: left; }
  .shoutout-track:hover { animation-play-state: paused; }
  .shoutout-item { color: #fff; font-size: 0.9rem; font-weight: 500; }
  .shoutout-divider { color: #dc2626; padding: 0 1.5rem; }
  .shoutout-placeholder { color: #555; font-size: 0.875rem; font-style: italic; }
  @keyframes shoutout-scroll { 0% { transform: translateY(-50%) translateX(0); } 100% { transform: translateY(-50%) translateX(calc(-100% - 100vw)); } }
  
  .now-playing-bar { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: #0a0a0a; border-top: 2px solid #222; }
  .now-playing-left { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
  .np-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
  .np-info { display: flex; flex-direction: column; gap: 0.125rem; }
  .np-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 1px; color: #dc2626; }
  .np-name { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.125rem; letter-spacing: 0.5px; }
  .now-playing-center { flex: 1; text-align: center; padding: 0 1rem; min-width: 0; }
  .np-track-title { font-size: 1rem; font-weight: 600; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
  .now-playing-right { display: flex; align-items: center; gap: 0.75rem; text-align: right; flex-shrink: 0; }
  .np-duration-box { display: flex; flex-direction: row; align-items: center; gap: 0.75rem; background: rgba(0, 0, 0, 0.5); border: 1px solid #333; border-radius: 8px; padding: 0.4rem 0.75rem; }
  .np-duration-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }
  .np-duration-value { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1rem; color: #dc2626; font-variant-numeric: tabular-nums; min-width: 50px; text-align: right; }
  .np-set-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }
  .np-set-title { font-size: 0.9375rem; color: #ccc; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .np-genre { font-size: 0.75rem; color: #dc2626; background: rgba(220, 38, 38, 0.1); padding: 0.25rem 0.5rem; border-radius: 4px; }

  /* Playlist mode styling */
  .now-playing-bar.playlist-mode { background: linear-gradient(90deg, #0a0a0a 0%, rgba(220, 38, 38, 0.1) 50%, #0a0a0a 100%); }
  .now-playing-bar.playlist-mode .np-label { color: #22c55e; }
  .now-playing-bar.playlist-mode .np-track-title { color: #dc2626; }

  /* Multi-Chat Section - 3 Columns */
  .chat-section { display: flex; flex-direction: column; background: #111; border-left: 2px solid #222; height: 100%; min-height: 0; overflow: hidden; }
  .chat-section.multi-chat {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: 1fr;
    gap: 0;
    height: 100%;
    min-height: 0;
    overflow: hidden;
  }

  /* Chat Columns */
  .chat-column {
    display: flex;
    flex-direction: column;
    border-right: 1px solid #222;
    overflow: hidden;
    min-height: 0;
    max-height: 100%;
  }
  .chat-column:last-child { border-right: none; }

  .chat-column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: #0a0a0a;
    border-bottom: 2px solid #222;
    min-height: 40px;
  }

  .chat-column-header.twitch-header { background: linear-gradient(135deg, #18181b 0%, #0a0a0a 100%); border-bottom-color: #9146ff40; }
  .chat-column-header.youtube-header { background: linear-gradient(135deg, #1a0a0a 0%, #0a0a0a 100%); border-bottom-color: #ff000040; }

  .chat-column-title {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
    letter-spacing: 0.5px;
  }

  .chat-icon { font-size: 0.875rem; }
  .twitch-icon { fill: #9146ff; }
  .youtube-icon { fill: #ff0000; }

  .chat-expand-btn {
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    color: #888;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .chat-expand-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
  .chat-expand-btn svg { fill: currentColor; }

  .chat-column-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    min-height: 0;
  }

  /* External Chat Frames (Twitch/YouTube) */
  .external-chat-frame {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: none;
    background: #18181b;
  }
  #youtubeChatFrame { background: #0f0f0f; }

  .external-chat-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #555;
    text-align: center;
    padding: 1rem;
    background: #111;
  }
  .external-chat-placeholder.hidden { display: none; }
  .placeholder-icon { opacity: 0.3; margin-bottom: 0.75rem; }
  .twitch-placeholder-icon { fill: #9146ff; }
  .youtube-placeholder-icon { fill: #ff0000; }
  .external-chat-placeholder p { font-size: 0.7rem; line-height: 1.4; }

  /* Expanded Chat Modal */
  .expanded-chat-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .expanded-chat-modal.hidden { display: none; }

  .expanded-chat-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(4px);
  }

  .expanded-chat-content {
    position: relative;
    width: 90%;
    max-width: 600px;
    height: 80vh;
    background: #111;
    border: 2px solid #333;
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .expanded-chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    background: #0a0a0a;
    border-bottom: 2px solid #333;
  }

  .expanded-chat-title {
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .expanded-chat-title.twitch { color: #9146ff; }
  .expanded-chat-title.youtube { color: #ff0000; }
  .expanded-chat-title.freshwax { color: #dc2626; }

  .expanded-chat-close {
    width: 36px;
    height: 36px;
    background: #333;
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .expanded-chat-close:hover { background: #dc2626; }

  .expanded-chat-body {
    flex: 1;
    overflow: hidden;
  }
  .expanded-chat-body iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  .chat-messages { flex: 1; overflow-y: auto; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
  .chat-welcome { text-align: center; padding: 1rem 0.5rem; color: #9ca3af; }
  .chat-welcome p { font-size: 0.7rem; margin-bottom: 0.25rem; }
  .chat-hint { font-size: 0.65rem; color: #9ca3af; }
  
  /* Fresh Wax Branding */
  .brand-fresh { color: #fff; font-weight: 700; }
  .brand-wax { color: #dc2626; font-weight: 700; }
  .brand-fresh.dark { color: #000; }
  .brand-logo { font-family: 'Inter', sans-serif; font-weight: 700; letter-spacing: 1px; }
  .chat-input-section { padding: 0.5rem; background: #0a0a0a; border-top: 1px solid #222; position: relative; }
  .login-prompt { text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.7rem; color: #888; }
  .login-prompt a { color: #dc2626; font-weight: 600; }
  .chat-form { display: flex; flex-direction: column; gap: 0.35rem; }
  .chat-tools { display: flex; gap: 0.25rem; }
  .tool-btn { padding: 0.25rem 0.5rem; background: #222; border: 1px solid #333; border-radius: 4px; color: #888; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; }
  .tool-btn:hover { background: #333; color: #fff; }
  .chat-input-wrapper { display: flex; gap: 0.35rem; }
  .chat-input-wrapper input { flex: 1; padding: 0.5rem; background: #222; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 0.75rem; min-width: 0; }
  .chat-input-wrapper input:focus { outline: none; border-color: #dc2626; }
  .chat-input-wrapper button { width: 32px; height: 32px; background: #dc2626; border: none; border-radius: 6px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
  .chat-input-wrapper button:hover { background: #b91c1c; }
  .chat-input-wrapper button svg { width: 14px; height: 14px; }
  
  .emoji-picker, .giphy-picker { position: absolute; bottom: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); z-index: 100; }
  .emoji-categories { display: flex; gap: 0.125rem; padding: 0.35rem; border-bottom: 1px solid #333; flex-wrap: wrap; }
  .emoji-cat { padding: 0.25rem 0.5rem; background: #222; border: none; border-radius: 4px; font-size: 0.6rem; color: #888; cursor: pointer; transition: all 0.2s; }
  .emoji-cat.active { background: #dc2626; color: #fff; }
  .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.125rem; padding: 0.5rem; max-height: 150px; overflow-y: auto; }
  .giphy-search { padding: 0.5rem; border-bottom: 1px solid #333; }
  .giphy-search input { width: 100%; padding: 0.35rem 0.5rem; background: #222; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 0.7rem; }
  .giphy-grid { padding: 0.5rem; max-height: 150px; overflow-y: auto; }
  .giphy-hint { text-align: center; color: #666; font-size: 0.7rem; padding: 0.5rem; }
  
  /* Floating emojis handled via inline JS styles */
  
  .modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
  .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.8); }
  .modal-content { position: relative; background: #1a1a1a; border: 2px solid #333; border-radius: 20px; padding: 3rem; max-width: 580px; width: 90%; }
  .modal-close { position: absolute; top: 1.25rem; right: 1.25rem; width: 40px; height: 40px; background: #333; border: none; border-radius: 50%; color: #fff; font-size: 1.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .shoutout-modal-content h2 { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 2rem; margin-bottom: 1rem; }
  .shoutout-hint { font-size: 1rem; color: #888; margin-bottom: 1.5rem; }
  .shoutout-input-wrapper { position: relative; margin-bottom: 1.25rem; }
  .shoutout-input-wrapper input { width: 100%; padding: 1.25rem 4.5rem 1.25rem 1.5rem; background: #222; border: 2px solid #333; border-radius: 10px; color: #fff; font-size: 1.25rem; }
  .shoutout-char-count { position: absolute; right: 1.25rem; top: 50%; transform: translateY(-50%); font-size: 1rem; color: #666; }
  .shoutout-emoji-row { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; justify-content: center; }
  .shoutout-emoji { width: 54px; height: 54px; background: #222; border: 2px solid #333; border-radius: 10px; font-size: 1.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .send-shoutout-btn { width: 100%; padding: 1.25rem; background: #dc2626; border: none; border-radius: 10px; color: #fff; font-weight: 700; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
  .send-shoutout-btn:disabled { background: #333; cursor: not-allowed; }
  .shoutout-cost { font-size: 1rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 4px; }
  
  .hidden { display: none !important; }
  
  @media (max-width: 768px) {
    .stream-stats { gap: 1rem; }
    .stat-value { font-size: 1rem; }
    .inline-reactions { gap: 0.125rem; }
    .reaction-btn { width: 36px; height: 36px; }
    .reaction-emoji { font-size: 1rem; }
    .volume-slider { width: 60px; }
    .now-playing-right { display: none; }
  }
</style>

<script define:vars={{ giphyApiKey }}>
  const GIPHY_API_KEY = giphyApiKey;
  
  let currentUser = null;
  let currentStream = null;
  let userInfo = null;
  let animationsEnabled = true;
  let hlsPlayer = null;
  let isVideoPlaying = false;
  let currentHlsUrl = null; // Track current URL to avoid re-initializing

  // Autoplay preference - persisted across sessions
  const AUTOPLAY_KEY = 'freshwax_autoplay';
  function shouldAutoplay() {
    return localStorage.getItem(AUTOPLAY_KEY) === 'true';
  }
  function rememberAutoplay() {
    localStorage.setItem(AUTOPLAY_KEY, 'true');
  }

  // Setup HLS player for video streams
  function setupHlsPlayer(stream) {
    const videoElement = document.getElementById('hlsVideoElement');
    // Use hlsUrl (from status API) or fall back to videoStreamUrl/streamUrl
    const hlsUrl = stream?.hlsUrl || stream?.videoStreamUrl || stream?.streamUrl;

    if (!videoElement || !hlsUrl) {
      console.log('[HLS] No video element or stream URL. Stream:', stream);
      return;
    }

    // Skip if already playing the same stream
    if (currentHlsUrl === hlsUrl && hlsPlayer) {
      console.log('[HLS] Already playing this stream, skipping re-init');
      return;
    }

    console.log('[HLS] Setting up player for:', hlsUrl);
    currentHlsUrl = hlsUrl;

    // Clean up existing player
    if (hlsPlayer) {
      hlsPlayer.destroy();
      hlsPlayer = null;
    }

    const nativeHlsSupport = videoElement.canPlayType('application/vnd.apple.mpegurl');

    // Only use native HLS if "probably" - "maybe" doesn't work in Chrome
    if (nativeHlsSupport === 'probably') {
      console.log('[HLS] Using native HLS support');
      videoElement.src = hlsUrl;
      // Attempt autoplay for native
      attemptAutoplay(videoElement);
    } else if (window.Hls && Hls.isSupported()) {
      console.log('[HLS] Using HLS.js library');
      hlsPlayer = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 90,
        maxBufferLength: 30,
        maxMaxBufferLength: 60
      });

      hlsPlayer.loadSource(hlsUrl);
      hlsPlayer.attachMedia(videoElement);

      hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
        console.log('[HLS] Manifest parsed, attempting autoplay');
        attemptAutoplay(videoElement);
      });

      hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
        console.error('[HLS] Error:', data.type, data.details);
        if (data.fatal) {
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
            setTimeout(() => hlsPlayer?.loadSource(hlsUrl), 3000);
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
            hlsPlayer.recoverMediaError();
          }
        }
      });
    } else {
      console.error('[HLS] Not supported');
    }

    // Sync video events with UI
    videoElement.addEventListener('play', () => {
      isVideoPlaying = true;
      document.getElementById('playIcon')?.classList.add('hidden');
      document.getElementById('pauseIcon')?.classList.remove('hidden');
    });

    videoElement.addEventListener('pause', () => {
      isVideoPlaying = false;
      document.getElementById('playIcon')?.classList.remove('hidden');
      document.getElementById('pauseIcon')?.classList.add('hidden');
    });
  }

  // Always try unmuted autoplay first, fall back to play button if blocked
  async function attemptAutoplay(videoElement) {
    try {
      videoElement.muted = false;
      await videoElement.play();
      isVideoPlaying = true;
      document.getElementById('playIcon')?.classList.add('hidden');
      document.getElementById('pauseIcon')?.classList.remove('hidden');
      console.log('[HLS] Unmuted autoplay successful');
      rememberAutoplay();
    } catch (err) {
      console.log('[HLS] Autoplay blocked, showing play button:', err.name);
      document.getElementById('playIcon')?.classList.remove('hidden');
      document.getElementById('pauseIcon')?.classList.add('hidden');
    }
  }

  async function initAuth() {
    try {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
      const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
      
      const app = initializeApp({
        apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store"
      });
      
      const auth = getAuth(app);
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        updateChatUI();
        if (user) await checkIfDj(user.uid);
      });
    } catch (e) { console.error('Auth error:', e); }
  }
  
  async function checkIfDj(userId) {
    try {
      const response = await fetch(`/api/get-user-type?uid=${userId}`);
      const result = await response.json();
      if (result.success) {
        userInfo = { isDj: result.roles?.dj === true || result.roles?.artist === true, isAdmin: result.isAdmin || false, isApproved: result.isApproved || false };
        if ((userInfo.isDj && userInfo.isApproved) || userInfo.isAdmin) document.getElementById('djLobbyBtn')?.classList.remove('hidden');
      }
    } catch (e) { console.log('Could not check DJ status'); }
  }
  
  function updateChatUI() {
    const loginPrompt = document.getElementById('loginPrompt');
    const chatForm = document.getElementById('chatForm');
    const reactionBtns = document.querySelectorAll('.reaction-btn[data-emoji]');
    const shoutoutBtn = document.getElementById('shoutoutBtn');
    
    if (currentUser) {
      loginPrompt?.classList.add('hidden');
      chatForm?.classList.remove('hidden');
      // Enable reaction buttons
      reactionBtns.forEach(btn => {
        btn.classList.remove('disabled');
        btn.title = btn.dataset.originalTitle || btn.title;
      });
      if (shoutoutBtn) {
        shoutoutBtn.classList.remove('disabled');
        shoutoutBtn.title = 'Send a shoutout';
      }
    } else {
      loginPrompt?.classList.remove('hidden');
      chatForm?.classList.add('hidden');
      // Show login required on reaction buttons
      reactionBtns.forEach(btn => {
        btn.dataset.originalTitle = btn.title;
        btn.title = 'Sign in to react';
        btn.classList.add('disabled');
      });
      if (shoutoutBtn) {
        shoutoutBtn.title = 'Sign in to send a shoutout';
        shoutoutBtn.classList.add('disabled');
      }
    }
  }
  
  // Enable/disable reaction buttons based on stream status
  function setReactionButtonsEnabled(enabled) {
    const reactionButtons = document.querySelectorAll('.reaction-btn, .anim-toggle-btn');
    reactionButtons.forEach(btn => {
      if (enabled) {
        btn.classList.remove('reactions-disabled');
        btn.disabled = false;
      } else {
        btn.classList.add('reactions-disabled');
        btn.disabled = true;
      }
    });
    window.emojiAnimationsEnabled = enabled;
  }

  // Duration timer
  let streamStartTime = null;
  let durationInterval = null;
  let trackTotalDuration = null;
  let isCountdownMode = false;
  let lastPlaylistTrackId = null;

  function formatDuration(seconds) {
    if (seconds < 0) seconds = 0;
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    if (hrs > 0) {
      return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function updateDurationDisplay() {
    if (!streamStartTime) return;
    const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
    let formatted;

    if (isCountdownMode && trackTotalDuration) {
      // Countdown mode for playlist
      const remaining = trackTotalDuration - elapsed;
      formatted = formatDuration(remaining);
    } else {
      // Count up mode for live stream
      formatted = formatDuration(elapsed);
    }

    const npDurationEl = document.getElementById('npDuration');
    if (npDurationEl) npDurationEl.textContent = formatted;
  }

  async function fetchVideoDuration(platform, embedId) {
    if (platform === 'youtube' && embedId) {
      try {
        const response = await fetch(`/api/youtube/duration?videoId=${embedId}`);
        if (response.ok) {
          const data = await response.json();
          if (data.duration) return data.duration;
        }
      } catch (e) {
        console.warn('[Fullpage] Could not fetch duration:', e);
      }
    }
    return null;
  }

  function startDurationTimer(startedAt) {
    // Clear any existing interval
    if (durationInterval) clearInterval(durationInterval);

    // Set start time from stream data or use current time
    streamStartTime = startedAt ? new Date(startedAt).getTime() : Date.now();
    isCountdownMode = false;
    trackTotalDuration = null;

    // Update immediately and then every second
    updateDurationDisplay();
    durationInterval = setInterval(updateDurationDisplay, 1000);
  }

  async function startPlaylistDurationTimer(track) {
    // Clear any existing interval
    if (durationInterval) clearInterval(durationInterval);

    const trackId = track.id || track.url;
    if (trackId === lastPlaylistTrackId && durationInterval) return;
    lastPlaylistTrackId = trackId;

    streamStartTime = Date.now();
    isCountdownMode = true;
    trackTotalDuration = null;

    // Show loading state
    const npDurationEl = document.getElementById('npDuration');
    if (npDurationEl) npDurationEl.textContent = '--:--';

    // Fetch duration for countdown
    if (track.platform && track.embedId) {
      trackTotalDuration = await fetchVideoDuration(track.platform, track.embedId);
    }

    updateDurationDisplay();
    durationInterval = setInterval(updateDurationDisplay, 1000);
  }

  function stopDurationTimer() {
    if (durationInterval) {
      clearInterval(durationInterval);
      durationInterval = null;
    }
    streamStartTime = null;
    trackTotalDuration = null;
    isCountdownMode = false;
    lastPlaylistTrackId = null;
    const npDurationEl = document.getElementById('npDuration');
    if (npDurationEl) npDurationEl.textContent = '--:--';
  }

  async function loadStreamStatus() {
    try {
      // Add cache buster to prevent stale cached responses
      const cacheBuster = Date.now();
      const response = await fetch(`/api/livestream/status?_t=${cacheBuster}`);
      const result = await response.json();

      if (result.isLive && result.streams && result.streams.length > 0) {
        const stream = result.streams[0];
        currentStream = stream;

        // Start duration timer if not already running
        if (!durationInterval) {
          startDurationTimer(stream.startedAt);
        }

        // Update track title in now playing
        const npTrackTitle = document.getElementById('npTrackTitle');
        if (npTrackTitle) {
          npTrackTitle.textContent = stream.title || 'Live Set';
        }

        // Enable reaction buttons when live
        setReactionButtonsEnabled(true);

        document.getElementById('liveBadge')?.classList.add('is-live');
        document.getElementById('liveStatusText').textContent = 'LIVE';
        document.getElementById('streamTitle').textContent = stream.title || 'Live Stream';
        document.getElementById('djName').textContent = stream.djName || 'DJ';
        document.getElementById('setTitle').textContent = stream.title || 'Live Set';
        document.getElementById('streamGenre').textContent = stream.genre || 'Jungle / D&B';
        document.getElementById('viewerCount').textContent = stream.currentViewers || 0;
        document.getElementById('listenerCountMini').textContent = stream.currentViewers || 0;
        document.getElementById('audioTitle').textContent = stream.title || 'Live Stream';
        document.getElementById('audioDjName').textContent = stream.djName || 'DJ';
        
        if (stream.djAvatar) {
          document.getElementById('djAvatar').src = stream.djAvatar;
          document.getElementById('streamCover').src = stream.djAvatar;
        }
        
        document.getElementById('offlineOverlay')?.classList.add('hidden');

        // Check if this is a video stream (HLS/Red5) or audio-only (Icecast)
        const isVideoStream = stream.hlsUrl || stream.streamSource === 'red5' ||
                             (stream.streamType !== 'audio' && !stream.audioStreamUrl?.includes('8000'));

        if (isVideoStream) {
          document.getElementById('videoPlayer')?.classList.remove('hidden');
          document.getElementById('audioPlayer')?.classList.add('hidden');
          // Initialize HLS player for video stream
          setupHlsPlayer(stream);
        } else {
          document.getElementById('audioPlayer')?.classList.remove('hidden');
          document.getElementById('videoPlayer')?.classList.add('hidden');
        }
        
        // Register as listener if logged in
        registerAsListener();

        // Setup external chats (Twitch & YouTube)
        setupExternalChats(stream);
      } else {
        // No live stream - show placeholders
        stopDurationTimer();
        const npTrackTitle = document.getElementById('npTrackTitle');
        if (npTrackTitle) npTrackTitle.textContent = 'No track playing';
        document.getElementById('djName').textContent = 'Waiting...';
        setupExternalChats(null);
      }
    } catch (e) { console.error('Error loading stream:', e); }
  }

  // External Chat Integration (Twitch & YouTube)
  let currentTwitchChannel = null;
  let currentYoutubeVideoId = null;

  // Fresh Wax Twitch channel (always active when streaming)
  const FRESHWAX_TWITCH_CHANNEL = 'freshwaxuk';
  // Fresh Wax YouTube channel handle for links
  const FRESHWAX_YOUTUBE_CHANNEL = 'freshwaxlive';

  function setupExternalChats(stream) {
    const host = window.location.hostname;

    // Setup Twitch Chat - Always use Fresh Wax channel when live
    const twitchFrame = document.getElementById('twitchChatFrame');
    const twitchPlaceholder = document.getElementById('twitchChatPlaceholder');

    if (stream) {
      // Use DJ's Twitch channel if available, otherwise Fresh Wax channel
      const twitchChannel = stream.twitchChannel || stream.twitchUsername || FRESHWAX_TWITCH_CHANNEL;
      currentTwitchChannel = twitchChannel.trim().toLowerCase();

      const twitchChatUrl = `https://www.twitch.tv/embed/${currentTwitchChannel}/chat?parent=${host}&darkpopout`;

      if (twitchFrame) {
        twitchFrame.src = twitchChatUrl;
        twitchPlaceholder?.classList.add('hidden');
      }
    } else {
      // Show placeholder when offline
      currentTwitchChannel = null;
      if (twitchFrame) twitchFrame.src = '';
      twitchPlaceholder?.classList.remove('hidden');
    }

    // Setup YouTube Chat
    const youtubeFrame = document.getElementById('youtubeChatFrame');
    const youtubePlaceholder = document.getElementById('youtubeChatPlaceholder');

    // Check for YouTube video ID in multiple locations
    const youtubeVideoId = stream?.youtubeLiveId || stream?.youtubeIntegration?.videoId;

    if (stream && youtubeVideoId) {
      // We have a YouTube live video ID - load the chat
      currentYoutubeVideoId = youtubeVideoId;
      const youtubeChatUrl = `https://www.youtube.com/live_chat?v=${currentYoutubeVideoId}&embed_domain=${host}`;

      if (youtubeFrame) {
        youtubeFrame.src = youtubeChatUrl;
        youtubePlaceholder?.classList.add('hidden');
      }
    } else if (stream) {
      // No YouTube video ID yet - try to fetch it
      currentYoutubeVideoId = null;
      if (youtubeFrame) youtubeFrame.src = '';

      // Show loading state
      if (youtubePlaceholder) {
        youtubePlaceholder.innerHTML = `
          <svg class="placeholder-icon youtube-placeholder-icon" viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
          <p style="font-size: 0.65rem;">Connecting to YouTube...</p>
        `;
        youtubePlaceholder.classList.remove('hidden');
      }

      // Try to fetch YouTube live ID from API
      fetchYouTubeLiveId(stream.streamKey);
    } else {
      // Show placeholder when offline
      currentYoutubeVideoId = null;
      if (youtubeFrame) youtubeFrame.src = '';
      youtubePlaceholder?.classList.remove('hidden');
    }
  }

  // Fetch YouTube live video ID from API
  async function fetchYouTubeLiveId(streamKey) {
    try {
      const response = await fetch('/api/livestream/youtube-live-id', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ streamKey })
      });

      const data = await response.json();
      const host = window.location.hostname;
      const youtubeFrame = document.getElementById('youtubeChatFrame');
      const youtubePlaceholder = document.getElementById('youtubeChatPlaceholder');

      if (data.success && data.youtubeLiveId) {
        currentYoutubeVideoId = data.youtubeLiveId;

        if (youtubeFrame) {
          youtubeFrame.src = `https://www.youtube.com/live_chat?v=${currentYoutubeVideoId}&embed_domain=${host}`;
          youtubePlaceholder?.classList.add('hidden');
        }
      } else {
        // Show YouTube channel link if no live video found
        if (youtubePlaceholder) {
          youtubePlaceholder.innerHTML = `
            <svg class="placeholder-icon youtube-placeholder-icon" viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
            <p>YouTube chat</p>
            <a href="https://www.youtube.com/@${FRESHWAX_YOUTUBE_CHANNEL}/live" target="_blank" style="color: #ff0000; font-size: 0.65rem; margin-top: 0.5rem;">Watch on YouTube</a>
          `;
        }
      }
    } catch (error) {
      console.error('[YouTube] Error fetching live ID:', error);
    }
  }

  // Legacy function for backwards compatibility
  function setupTwitchChat(twitchChannel) {
    setupExternalChats(currentStream);
  }

  // Expand Chat Modal
  const expandedChatModal = document.getElementById('expandedChatModal');
  const expandedChatTitle = document.getElementById('expandedChatTitle');
  const expandedChatBody = document.getElementById('expandedChatBody');
  const closeExpandedChat = document.getElementById('closeExpandedChat');

  function openExpandedChat(chatType) {
    const host = window.location.hostname;
    let title = '';
    let content = '';
    let titleClass = '';

    switch(chatType) {
      case 'freshwax':
        title = 'üí¨ Fresh Wax Chat';
        titleClass = 'freshwax';
        // Clone the Fresh Wax chat for the modal - simplified version
        content = `<div style="padding: 2rem; text-align: center; color: #888;">
          <p>Fresh Wax chat is in the main view</p>
          <p style="font-size: 0.75rem; margin-top: 0.5rem;">Use the chat input below the stream</p>
        </div>`;
        break;

      case 'twitch':
        title = 'Twitch Chat';
        titleClass = 'twitch';
        if (currentTwitchChannel) {
          content = `<iframe src="https://www.twitch.tv/embed/${currentTwitchChannel}/chat?parent=${host}&darkpopout" style="width:100%;height:100%;border:none;"></iframe>`;
        } else {
          content = `<div style="padding: 2rem; text-align: center; color: #888;">Twitch chat unavailable</div>`;
        }
        break;

      case 'youtube':
        title = 'YouTube Chat';
        titleClass = 'youtube';
        if (currentYoutubeVideoId) {
          content = `<iframe src="https://www.youtube.com/live_chat?v=${currentYoutubeVideoId}&embed_domain=${host}" style="width:100%;height:100%;border:none;"></iframe>`;
        } else {
          const youtubeChannel = FRESHWAX_YOUTUBE_CHANNEL;
          content = `<div style="padding: 2rem; text-align: center; color: #888;">
            <p>YouTube chat requires an active live stream</p>
            <a href="https://www.youtube.com/@${youtubeChannel}/live" target="_blank" style="color: #ff0000; display: inline-block; margin-top: 1rem; padding: 0.5rem 1rem; background: rgba(255,0,0,0.1); border-radius: 6px;">Watch on YouTube</a>
          </div>`;
        }
        break;
    }

    if (expandedChatTitle) {
      expandedChatTitle.textContent = title;
      expandedChatTitle.className = 'expanded-chat-title ' + titleClass;
    }
    if (expandedChatBody) expandedChatBody.innerHTML = content;
    expandedChatModal?.classList.remove('hidden');
  }

  function closeExpandedChatModal() {
    expandedChatModal?.classList.add('hidden');
    if (expandedChatBody) expandedChatBody.innerHTML = '';
  }

  // Expand button click handlers
  document.querySelectorAll('.chat-expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      if (target) openExpandedChat(target);
    });
  });

  closeExpandedChat?.addEventListener('click', closeExpandedChatModal);
  document.querySelector('.expanded-chat-backdrop')?.addEventListener('click', closeExpandedChatModal);
  
  document.getElementById('playPauseBtn')?.addEventListener('click', () => {
    const audio = document.getElementById('audioElement');
    const video = document.getElementById('hlsVideoElement');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const activePlayer = audio?.src ? audio : video;

    if (activePlayer?.paused) {
      rememberAutoplay();
      activePlayer.muted = false;
      activePlayer.play();
      playIcon?.classList.add('hidden');
      pauseIcon?.classList.remove('hidden');
    } else {
      activePlayer?.pause();
      playIcon?.classList.remove('hidden');
      pauseIcon?.classList.add('hidden');
    }
  });
  
  document.getElementById('volumeSlider')?.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    const audio = document.getElementById('audioElement');
    const video = document.getElementById('hlsVideoElement');
    if (audio) audio.volume = volume;
    if (video) video.volume = volume;
  });
  
  function createFloatingEmoji(startX, startY, emojiList) {
    if (!animationsEnabled) return;
    
    const heart = document.createElement('div');
    const emojis = emojiList || ['‚ù§Ô∏è', 'üíñ', 'üíó', 'üíì', 'üíï'];
    heart.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    
    const spreadX = (Math.random() - 0.5) * 60;
    const wiggleAmount = 20 + Math.random() * 30;
    const duration = 2000 + Math.random() * 1000;
    const fontSize = 28 + Math.floor(Math.random() * 20);
    const posX = startX + spreadX;
    const posY = startY;
    
    Object.assign(heart.style, {
      position: 'fixed',
      left: posX + 'px',
      top: posY + 'px',
      fontSize: fontSize + 'px',
      lineHeight: '1',
      pointerEvents: 'none',
      zIndex: '99999',
      opacity: '1',
      transform: 'scale(0)',
      margin: '0',
      padding: '0'
    });
    
    document.body.appendChild(heart);
    
    const startTime = performance.now();
    
    function animate(time) {
      const elapsed = time - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const moveY = easeOut * 350;
      const wiggle = Math.sin(progress * Math.PI * 4) * wiggleAmount * (1 - progress);
      
      let scale = 1;
      if (progress < 0.1) scale = progress * 12;
      else if (progress < 0.2) scale = 1.2 - (progress - 0.1) * 2;
      else scale = 1 - (progress - 0.2) * 0.3;
      
      const opacity = progress > 0.6 ? 1 - (progress - 0.6) / 0.4 : 1;
      
      heart.style.left = (posX + wiggle) + 'px';
      heart.style.top = (posY - moveY) + 'px';
      heart.style.opacity = String(opacity);
      heart.style.transform = 'scale(' + scale + ')';
      
      if (progress < 1) requestAnimationFrame(animate);
      else heart.remove();
    }
    
    requestAnimationFrame(animate);
  }
  
  function triggerReactionBurst(element, emojiList) {
    // Always start from center of screen for consistent experience
    const x = window.innerWidth / 2;
    const y = window.innerHeight / 2;

    const numHearts = 6 + Math.floor(Math.random() * 5);
    for (let i = 0; i < numHearts; i++) {
      setTimeout(() => createFloatingEmoji(x, y, emojiList), i * 70);
    }
  }

  // Expose for remote emoji broadcasts
  window.triggerReactionBurst = triggerReactionBurst;
  window.createFloatingEmoji = createFloatingEmoji;
  
  document.querySelectorAll('.reaction-btn[data-emoji]').forEach(btn => {
    btn.addEventListener('click', async () => {
      // Require login for reactions
      if (!currentUser) {
        alert('Please sign in to react to the stream');
        return;
      }
      
      const emojiList = btn.dataset.emoji.split(',');
      
      // Trigger visual animation
      triggerReactionBurst(btn, emojiList);
      btn.classList.add('liked');
      setTimeout(() => btn.classList.remove('liked'), 300);
      
      // Send reaction to server
      if (currentStream) {
        try {
          await fetch('/api/livestream/react', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'emoji',
              emoji: emojiList.join(','),
              streamId: currentStream.id,
              userId: currentUser.uid
            })
          });
        } catch (e) { console.log('Reaction sent locally'); }
      }
    });
  });
  
  document.getElementById('animToggleBtn')?.addEventListener('click', () => {
    animationsEnabled = !animationsEnabled;
    document.getElementById('animToggleBtn')?.classList.toggle('off', !animationsEnabled);
  });
  
  document.getElementById('shoutoutBtn')?.addEventListener('click', () => {
    // Require login for shoutouts
    if (!currentUser) {
      alert('Please sign in to send a shoutout');
      return;
    }
    document.getElementById('shoutoutModal')?.classList.remove('hidden');
  });
  document.getElementById('closeShoutoutModal')?.addEventListener('click', () => document.getElementById('shoutoutModal')?.classList.add('hidden'));
  document.querySelector('.modal-backdrop')?.addEventListener('click', () => document.getElementById('shoutoutModal')?.classList.add('hidden'));
  
  const shoutoutInput = document.getElementById('shoutoutInput');
  const shoutoutCharCount = document.getElementById('shoutoutCharCount');
  const sendShoutoutBtn = document.getElementById('sendShoutoutBtn');
  
  shoutoutInput?.addEventListener('input', () => {
    const len = shoutoutInput.value.length;
    if (shoutoutCharCount) shoutoutCharCount.textContent = len;
    if (sendShoutoutBtn) sendShoutoutBtn.disabled = len === 0;
  });
  
  document.querySelectorAll('.shoutout-emoji').forEach(btn => {
    btn.addEventListener('click', () => {
      if (shoutoutInput && shoutoutInput.value.length < 30) {
        shoutoutInput.value += btn.dataset.emoji;
        shoutoutInput.dispatchEvent(new Event('input'));
      }
    });
  });
  
  sendShoutoutBtn?.addEventListener('click', async () => {
    // Require login for shoutouts
    if (!currentUser) {
      alert('Please sign in to send a shoutout');
      return;
    }
    
    const message = shoutoutInput?.value.trim();
    if (!message) return;
    
    const userName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Anonymous';
    const userId = currentUser.uid;
    
    // Disable button while sending
    sendShoutoutBtn.disabled = true;
    sendShoutoutBtn.innerHTML = '<span>Sending...</span>';
    
    try {
      const streamId = currentStream?.id || 'default';
      
      const response = await fetch('/api/livestream/react', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'shoutout',
          streamId: streamId,
          userId: userId,
          userName: userName,
          message: message
        })
      });
      
      if (response.ok) {
        // Add to local track - scrolls from right to left
        const track = document.getElementById('shoutoutTrack');
        if (track) {
          track.innerHTML = `<span class="shoutout-item">üì£ ${userName}: ${message}</span>`;
          track.classList.add('scrolling');
          // Reset animation after it completes
          track.addEventListener('animationend', () => {
            track.classList.remove('scrolling');
            track.innerHTML = '<span class="shoutout-placeholder">üéâ Send a shoutout to appear here!</span>';
          }, { once: true });
        }
      }
    } catch (e) { console.error('Shoutout error:', e); }
    
    // Close modal and reset
    document.getElementById('shoutoutModal')?.classList.add('hidden');
    shoutoutInput.value = '';
    if (shoutoutCharCount) shoutoutCharCount.textContent = '0';
    sendShoutoutBtn.disabled = true;
    sendShoutoutBtn.innerHTML = '<span>Send Shoutout</span><span class="shoutout-cost">FREE</span>';
  });

  // Shoutout queue and animation
  const shoutoutQueue = [];
  let isShoutoutPlaying = false;
  const shoutoutTrack = document.getElementById('shoutoutTrack');

  function playNextShoutout() {
    if (isShoutoutPlaying || shoutoutQueue.length === 0) return;

    isShoutoutPlaying = true;
    const shoutout = shoutoutQueue.shift();

    if (shoutoutTrack) {
      shoutoutTrack.innerHTML = `<span class="shoutout-item">üì£ ${shoutout.name}: ${shoutout.message}</span>`;
      shoutoutTrack.classList.remove('scrolling');

      // Trigger reflow to restart animation
      void shoutoutTrack.offsetWidth;
      shoutoutTrack.classList.add('scrolling');

      // After animation ends, check for more shoutouts
      setTimeout(() => {
        isShoutoutPlaying = false;
        if (shoutoutQueue.length > 0) {
          playNextShoutout();
        } else {
          // Reset to placeholder
          shoutoutTrack.classList.remove('scrolling');
          shoutoutTrack.innerHTML = '<span class="shoutout-placeholder">üéâ Send a shoutout to appear here!</span>';
        }
      }, 20000); // Match animation duration
    }
  }

  // Listen for incoming shoutouts from Pusher
  window.handleIncomingShoutout = function(data) {
    shoutoutQueue.push({ name: data.name, message: data.message });
    playNextShoutout();
  };

  // Listen for incoming emoji reactions from Pusher
  window.handleIncomingEmoji = function(data) {
    if (window.triggerReactionBurst && data.emoji) {
      const emojis = data.emoji.split(',');
      window.triggerReactionBurst(null, emojis);
    }
  };

  const emojiCategories = {
    music: ['üéµ', 'üé∂', 'üéß', 'üé§', 'üéπ', 'ü•Å', 'üé∏', 'üé∫', 'üé∑', 'üéª', 'ü™ò', 'üéº', 'üìª', 'üíø', 'üìÄ', 'üîä'],
    reactions: ['üî•', 'üí•', '‚≠ê', '‚ú®', 'üí´', 'üåü', '‚ö°', 'üíØ', 'üöÄ', 'üí™', 'üëä', 'üôå', 'üëè', 'ü§ô', 'ü§ò', 'üëÜ'],
    faces: ['üòÄ', 'üòÅ', 'üòÇ', 'ü§£', 'üòç', 'ü•≥', 'ü§©', 'üòé', 'ü•∫', 'üò≠', 'üíÄ', 'ü´†', 'ü§Ø', 'üòà', 'üëª', 'ü§ñ'],
    vibes: ['‚ù§Ô∏è', 'üíñ', 'üíó', 'üíì', 'üíï', 'üíú', 'üíô', 'üíö', 'üíõ', 'üß°', 'üñ§', 'ü§ç', 'üíù', 'üíò', 'üíû', '‚ù£Ô∏è']
  };
  
  const emojiGrid = document.getElementById('emojiGrid');
  
  function renderEmojis(category) {
    if (!emojiGrid) return;
    emojiGrid.innerHTML = '';
    emojiCategories[category].forEach(emoji => {
      const btn = document.createElement('button');
      btn.className = 'emoji-btn';
      btn.textContent = emoji;
      btn.style.cssText = 'width:32px;height:32px;background:transparent;border:none;font-size:1.25rem;cursor:pointer;border-radius:4px;';
      btn.addEventListener('click', () => {
        const chatInput = document.getElementById('chatInput');
        if (chatInput) chatInput.value += emoji;
        document.getElementById('emojiPicker')?.classList.add('hidden');
      });
      emojiGrid.appendChild(btn);
    });
  }
  
  document.querySelectorAll('.emoji-cat').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.emoji-cat').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderEmojis(btn.dataset.cat);
    });
  });
  
  document.getElementById('emojiBtn')?.addEventListener('click', () => {
    document.getElementById('giphyPicker')?.classList.add('hidden');
    document.getElementById('emojiPicker')?.classList.toggle('hidden');
    renderEmojis('music');
  });
  
  document.getElementById('giphyBtn')?.addEventListener('click', () => {
    document.getElementById('emojiPicker')?.classList.add('hidden');
    const picker = document.getElementById('giphyPicker');
    picker?.classList.toggle('hidden');
    if (!picker?.classList.contains('hidden')) {
      searchGiphy(''); // Load trending
    }
  });

  // Giphy search functionality
  let giphySearchTimeout = null;
  const giphySearch = document.getElementById('giphySearch');

  giphySearch?.addEventListener('input', (e) => {
    clearTimeout(giphySearchTimeout);
    giphySearchTimeout = setTimeout(() => searchGiphy(e.target.value), 500);
  });

  async function searchGiphy(query) {
    const giphyGrid = document.getElementById('giphyGrid');
    if (!GIPHY_API_KEY || !giphyGrid) {
      if (giphyGrid) giphyGrid.innerHTML = '<p class="giphy-hint">GIF search unavailable</p>';
      return;
    }

    giphyGrid.innerHTML = '<p class="giphy-hint">Loading...</p>';

    try {
      const url = query.trim()
        ? `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20&rating=pg-13`
        : `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20&rating=pg-13`;

      const response = await fetch(url);
      const data = await response.json();

      if (data.data && data.data.length > 0) {
        giphyGrid.innerHTML = data.data.map(gif => `
          <div class="giphy-item" style="cursor:pointer;margin:2px;display:inline-block;" onclick="selectGif('${gif.images.fixed_height.url}', '${gif.id}')">
            <img src="${gif.images.fixed_height_small.url}" alt="${gif.title}" style="width:100px;height:auto;border-radius:4px;" />
          </div>
        `).join('');
      } else {
        giphyGrid.innerHTML = '<p class="giphy-hint">No GIFs found</p>';
      }
    } catch (error) {
      console.error('[Giphy] Error:', error);
      giphyGrid.innerHTML = '<p class="giphy-hint">Failed to load GIFs</p>';
    }
  }

  window.selectGif = async function(giphyUrl, giphyId) {
    console.log('[Picker] Select GIF:', giphyUrl);
    document.getElementById('giphyPicker')?.classList.add('hidden');

    // Send GIF as chat message
    if (!currentUser) {
      alert('Please sign in to send GIFs');
      return;
    }

    try {
      const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
      const db = getFirestore();
      const streamId = currentStream?.slotId || currentStream?.id || window.currentStreamId;

      if (streamId) {
        await addDoc(collection(db, `livestreamChats/${streamId}/messages`), {
          userId: currentUser.uid,
          userName: userInfo?.displayName || currentUser.displayName || 'Anonymous',
          type: 'giphy',
          giphyUrl,
          giphyId,
          timestamp: serverTimestamp()
        });
      }
    } catch (e) {
      console.error('[GIF] Send error:', e);
    }
  };
  
  // Listeners dropdown
  const listenersToggle = document.getElementById('listenersToggle');
  const listenersDropdown = document.getElementById('listenersDropdown');
  const listenersList = document.getElementById('listenersList');
  const listenersCountBadge = document.getElementById('listenersCountBadge');
  let listeners = [];
  
  listenersToggle?.addEventListener('click', () => {
    listenersToggle.classList.toggle('active');
    listenersDropdown?.classList.toggle('hidden');
    if (!listenersDropdown?.classList.contains('hidden')) {
      loadListeners();
    }
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.listeners-dropdown-container')) {
      listenersToggle?.classList.remove('active');
      listenersDropdown?.classList.add('hidden');
    }
  });
  
  async function loadListeners() {
    if (!currentStream?.id) return;
    
    try {
      const response = await fetch(`/api/livestream/listeners?streamId=${currentStream.id}`);
      const result = await response.json();
      
      if (result.success && result.listeners) {
        listeners = result.listeners;
        renderListeners();
      }
    } catch (e) {
      console.log('Could not load listeners');
      // Show mock data for testing
      renderListeners();
    }
  }
  
  function renderListeners() {
    if (!listenersList) return;
    
    if (listeners.length === 0) {
      listenersList.innerHTML = '<div class="listeners-empty">No listeners yet</div>';
      if (listenersCountBadge) listenersCountBadge.textContent = '0';
      return;
    }
    
    if (listenersCountBadge) listenersCountBadge.textContent = listeners.length;
    
    listenersList.innerHTML = listeners.map(listener => `
      <div class="listener-item">
        <div class="listener-avatar">
          ${listener.avatarUrl 
            ? `<img src="${listener.avatarUrl}" alt="" onerror="this.parentElement.innerHTML='${(listener.name || 'A')[0].toUpperCase()}'" />`
            : (listener.name || 'A')[0].toUpperCase()
          }
        </div>
        <div class="listener-info">
          <div class="listener-name">${listener.name || 'Anonymous'}</div>
          <div class="listener-status">
            <span class="listener-dot"></span>
            <span>Listening now</span>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // Register current user as listener when stream loads
  async function registerAsListener() {
    if (!currentUser || !currentStream?.id) return;
    
    try {
      await fetch('/api/livestream/listeners', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'join',
          streamId: currentStream.id,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Anonymous',
          avatarUrl: currentUser.photoURL || null
        })
      });
    } catch (e) {
      console.log('Could not register as listener');
    }
  }
  
  // Send heartbeat to keep listener active
  async function sendListenerHeartbeat() {
    if (!currentUser || !currentStream?.id) return;
    
    try {
      await fetch('/api/livestream/listeners', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'heartbeat',
          streamId: currentStream.id,
          userId: currentUser.uid
        })
      });
    } catch (e) {
      // Silently fail
    }
  }
  
  // Unregister when leaving
  window.addEventListener('beforeunload', () => {
    if (currentUser && currentStream?.id) {
      navigator.sendBeacon('/api/livestream/listeners', JSON.stringify({
        action: 'leave',
        streamId: currentStream.id,
        userId: currentUser.uid
      }));
    }
  });
  
  // Track initialization to prevent duplicate handlers
  let intervalsSetup = false;

  function setupIntervals() {
    if (intervalsSetup) return;
    intervalsSetup = true;
    setInterval(loadStreamStatus, 30000);
    setInterval(sendListenerHeartbeat, 30000);
    setInterval(() => {
      if (!listenersDropdown?.classList.contains('hidden')) {
        loadListeners();
      }
    }, 10000);
  }

  function initPage() {
    console.log('[Fullpage] Initializing page...');
    initAuth();
    loadStreamStatus();
    setupIntervals();
  }

  // Initialize on first load
  initPage();

  // Re-initialize on View Transitions navigation
  document.addEventListener('astro:page-load', () => {
    console.log('[Fullpage] astro:page-load - re-initializing');
    initPage();
  });

  // Listen for playlist updates to show current track
  let isPlaylistActive = false;

  window.addEventListener('playlistUpdate', (event) => {
    const detail = event.detail;
    const npLabel = document.getElementById('npLabel');
    const djNameEl = document.getElementById('djName');
    const npTrackTitle = document.getElementById('npTrackTitle');
    const djAvatar = document.getElementById('djAvatar');
    const nowPlayingBar = document.getElementById('nowPlayingBar');

    if (detail.isPlaying && detail.queue && detail.queue.length > 0) {
      // Playlist is active - show current track
      const currentTrack = detail.queue[detail.currentIndex];
      if (currentTrack) {
        isPlaylistActive = true;
        nowPlayingBar?.classList.add('playlist-mode');

        if (npLabel) npLabel.textContent = 'PLAYLIST';
        if (djNameEl) djNameEl.textContent = currentTrack.addedByName || 'DJ';
        if (npTrackTitle) npTrackTitle.textContent = currentTrack.title || 'Unknown Track';
        if (djAvatar && currentTrack.thumbnail) {
          djAvatar.src = currentTrack.thumbnail;
        }

        // Start countdown timer for playlist track
        startPlaylistDurationTimer(currentTrack);
      }
    } else if (isPlaylistActive) {
      // Playlist stopped - revert to stream info
      isPlaylistActive = false;
      nowPlayingBar?.classList.remove('playlist-mode');

      if (npLabel) npLabel.textContent = 'NOW PLAYING';
      if (currentStream) {
        if (djNameEl) djNameEl.textContent = currentStream.djName || 'DJ';
        if (npTrackTitle) npTrackTitle.textContent = currentStream.title || 'Live Set';
        if (djAvatar && currentStream.djAvatar) {
          djAvatar.src = currentStream.djAvatar;
        }
      } else {
        if (djNameEl) djNameEl.textContent = 'Waiting...';
        if (npTrackTitle) npTrackTitle.textContent = 'No track playing';
      }
    }
  });
</script>
</body>
</html>
