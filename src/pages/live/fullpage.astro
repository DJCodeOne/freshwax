---
// src/pages/live/fullpage.astro
// Full page live stream view - immersive player with chat
import { ClientRouter } from 'astro:transitions';
import LiveChat from '../../components/live/LiveChat.astro';
export const prerender = false;

const giphyApiKey = import.meta.env.GIPHY_API_KEY || 'p0USqLUVxus8d82HAcPhQ2GqG6SfraYr';

// Pusher config for client-side
const pusherConfig = {
  key: import.meta.env.PUBLIC_PUSHER_KEY || '',
  cluster: import.meta.env.PUBLIC_PUSHER_CLUSTER || 'eu'
};
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Stream - Fresh Wax</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles/live.css" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
  <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

  <script define:vars={{ pusherConfig, giphyApiKey }}>
    window.PUSHER_CONFIG = pusherConfig;
    window.GIPHY_API_KEY = giphyApiKey;
    window.isFullpageMode = true;
  </script>

  <ClientRouter />
</head>
<body class="fullpage-body">

  <!-- Emoji Animation Container -->
  <div id="emojiAnimationContainer" class="emoji-animation-container"></div>

  <!-- Shoutout Modal -->
  <div id="shoutoutModal" class="modal hidden">
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-content shoutout-modal-content">
      <button class="modal-close" data-close-modal>&times;</button>
      <h2>Send a Shoutout</h2>
      <p class="shoutout-hint">Birthdays, Big ups, Locations, Party vibes</p>
      <div class="shoutout-input-wrapper">
        <input type="text" id="shoutoutInput" placeholder="Type your shoutout..." maxlength="30" autocomplete="off" />
        <span class="shoutout-char-count"><span id="shoutoutCharCount">0</span>/30</span>
      </div>
      <div class="shoutout-emoji-row">
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F382;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F389;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F525;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x2764;&#xFE0F;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F64C;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F4CD;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F3B5;</button>
        <button type="button" class="shoutout-emoji" data-emoji="">&#x1F44A;</button>
      </div>
      <button id="sendShoutoutBtn" class="send-shoutout-btn" disabled>
        <span>Send Shoutout</span>
        <span class="shoutout-cost">FREE</span>
      </button>
    </div>
  </div>

  <div class="fp-layout">
    <!-- Main Content Area -->
    <main class="fp-main">
      <!-- Top Bar -->
      <div class="fp-top-bar">
        <a href="/live" class="fp-back-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          <span>Back</span>
        </a>

        <div class="fp-stream-info">
          <div class="live-badge" id="liveBadge">
            <span class="live-dot"></span>
            <span id="liveStatusText">LOADING...</span>
          </div>
          <span class="fp-stream-title" id="streamTitle">Fresh Wax Live</span>
        </div>

        <div class="fp-stats">
          <div class="fp-stat">
            <span class="fp-stat-icon">&#x1F441;</span>
            <span id="viewerCount">0</span>
          </div>
          <div class="fp-stat fp-timer" id="durationStat">
            <span class="fp-timer-label" id="durationLabel">DURATION</span>
            <span class="fp-timer-value" id="streamDuration">0:00</span>
          </div>
        </div>
      </div>

      <!-- Player Container -->
      <div class="fp-player-container" id="playerContainer">
        <!-- Relay Source Attribution -->
        <div class="relay-attribution" id="relayAttribution">www.theundergroundlair.fr</div>

        <!-- Offline Overlay -->
        <div id="offlineOverlay" class="offline-overlay is-loading">
          <div class="offline-overlay-content">
            <div class="offline-icon-large" id="offlineIconText">LOADING...</div>
            <p class="offline-text" id="offlineMainText">Checking for active streams</p>
            <p class="offline-subtext" id="offlineSubText">Please wait...</p>
          </div>
        </div>

        <!-- Initializing Overlay -->
        <div id="initializingOverlay" class="initializing-overlay">
          <div class="initializing-content">
            <div class="initializing-spinner"></div>
            <p>Connecting to stream...</p>
          </div>
        </div>

        <!-- Audio Player (BUTT/Relay mode) -->
        <div id="audioPlayer" class="audio-player hidden">
          <div class="audio-player-content">
            <div class="audio-branding">
              <span class="brand-fresh">FRESH</span><span class="brand-wax">WAX</span>
            </div>
            <div class="audio-dj-info">
              <div class="audio-dj-name" id="audioDjName">DJ Name</div>
              <div class="audio-show-title" id="audioShowTitle">Live Session</div>
              <div class="audio-live-badge" id="audioModeBadge">
                <span class="live-pulse"></span>
                <span id="audioModeText">AUDIO ONLY</span>
              </div>
            </div>
            <div class="audio-turntables">
              <div class="vinyl-container vinyl-left">
                <div class="vinyl-record spinning">
                  <div class="vinyl-label">
                    <img id="vinylDjAvatar" src="/place-holder.webp" alt="DJ" class="vinyl-avatar" />
                  </div>
                </div>
                <div class="tonearm tonearm-left"></div>
              </div>
              <div class="audio-waveform">
                {Array(20).fill(0).map(() => <div class="audio-bar"></div>)}
              </div>
              <div class="vinyl-container vinyl-right">
                <div class="vinyl-record spinning">
                  <div class="vinyl-label vinyl-label-right">
                    <img id="vinylDjAvatar2" src="/place-holder.webp" alt="DJ" class="vinyl-avatar" />
                  </div>
                </div>
                <div class="tonearm tonearm-right"></div>
              </div>
            </div>
          </div>
          <audio id="audioElement" crossorigin="anonymous" preload="auto"></audio>
        </div>

        <!-- Video Player (HLS mode) -->
        <div id="videoPlayer" class="video-player hidden">
          <video id="hlsVideoElement" class="hls-video" playsinline webkit-playsinline></video>
          <!-- Playlist Player (overlay) -->
          <div id="playlistPlayer" class="playlist-player hidden"></div>
        </div>
      </div>

      <!-- Controls Bar -->
      <div class="fp-controls">
        <button id="playBtn" class="control-btn play-btn" disabled>
          <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg id="pauseIcon" class="hidden" viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>

        <!-- LED Meters -->
        <div class="led-meters" id="ledMeters">
          <div class="led-meter led-meter-left" id="ledMeterLeft">
            {Array(16).fill(0).map((_, i) => <div class="led-segment" data-level={i}></div>)}
          </div>
          <div class="led-meter led-meter-right" id="ledMeterRight">
            {Array(16).fill(0).map((_, i) => <div class="led-segment" data-level={i}></div>)}
          </div>
        </div>

        <!-- Emoji Reactions -->
        <div class="reaction-buttons" id="reactionButtons">
          <button class="reaction-btn" data-emoji="heart" title="Love">&#x2764;&#xFE0F;</button>
          <button class="reaction-btn" data-emoji="fire" title="Fire">&#x1F525;</button>
          <button class="reaction-btn" data-emoji="explosion" title="Explosion">&#x1F4A5;</button>
          <button class="reaction-btn" data-emoji="star" title="Star">&#x2B50;</button>
          <button class="reaction-btn" data-emoji="bass" title="Bass">&#x1F50A;</button>
          <button class="reaction-btn" data-emoji="fist" title="Fist">&#x1F44A;</button>
          <button class="reaction-btn" data-emoji="rocket" title="Rocket">&#x1F680;</button>
        </div>

        <div class="volume-control">
          <svg class="volume-icon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
          </svg>
          <input type="range" id="volumeSlider" min="0" max="100" value="80" class="volume-slider" />
        </div>

        <button id="shoutoutBtn" class="shoutout-btn" title="Send a shoutout">
          <span>&#x1F4E3;</span>
        </button>
      </div>

      <!-- Shoutout Bar -->
      <div class="shoutout-bar" id="shoutoutBar">
        <div class="shoutout-left">
          <span class="shoutout-label">&#x1F4E3; SHOUT OUTS</span>
        </div>
        <div class="shoutout-marquee">
          <div class="shoutout-track" id="shoutoutTrack">
            <span class="shoutout-placeholder">&#x1F389; Send a shoutout to appear here!</span>
          </div>
        </div>
      </div>

      <!-- NOW PLAYING Bar -->
      <div class="dj-info-bar" id="djInfoBar">
        <img id="djAvatar" src="/place-holder.webp" alt="" class="dj-avatar" />
        <div class="dj-info-center">
          <span class="dj-info-label" id="controlsLabel">NOW PLAYING</span>
          <span class="dj-info-name" id="controlsDjName">--</span>
        </div>
        <div class="dj-info-right">
          <div class="dj-info-timer" id="countdownBox">
            <span class="dj-info-timer-label" id="countdownLabel">LEFT</span>
            <span class="dj-info-timer-value" id="countdownValue">--:--</span>
          </div>
          <span class="stream-genre" id="streamGenre">Jungle / D&B</span>
        </div>
      </div>
    </main>

    <!-- Chat Sidebar -->
    <aside class="fp-sidebar">
      <!-- Chat Tabs -->
      <div class="fp-chat-tabs">
        <button class="fp-chat-tab active" data-tab="freshwax">
          <span class="brand-fresh">Fresh</span><span class="brand-wax">Wax</span>
        </button>
        <button class="fp-chat-tab" data-tab="twitch" id="twitchTab">
          <svg class="twitch-icon" viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
          </svg>
          <span>Twitch</span>
        </button>
        <button class="fp-chat-tab" data-tab="youtube" id="youtubeTab">
          <svg class="youtube-icon" viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
          <span>YouTube</span>
        </button>
      </div>

      <!-- Fresh Wax Chat -->
      <div class="fp-chat-panel active" data-panel="freshwax">
        <LiveChat giphyApiKey={giphyApiKey} />
      </div>

      <!-- Twitch Chat -->
      <div class="fp-chat-panel" data-panel="twitch">
        <div class="external-chat-container" id="twitchChatContainer">
          <div class="external-chat-placeholder" id="twitchPlaceholder">
            <svg class="twitch-icon" viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
              <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
            </svg>
            <p>No Twitch stream connected</p>
            <p class="hint">Twitch chat will appear when DJ connects their channel</p>
          </div>
          <iframe id="twitchChatFrame" class="external-chat-frame hidden" allowfullscreen></iframe>
        </div>
      </div>

      <!-- YouTube Chat -->
      <div class="fp-chat-panel" data-panel="youtube">
        <div class="external-chat-container" id="youtubeChatContainer">
          <div class="external-chat-placeholder" id="youtubePlaceholder">
            <svg class="youtube-icon" viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
            <p>No YouTube stream connected</p>
            <p class="hint">YouTube chat will appear when DJ connects their channel</p>
          </div>
          <iframe id="youtubeChatFrame" class="external-chat-frame hidden" allowfullscreen></iframe>
        </div>
      </div>
    </aside>
  </div>

<style>
  /* Fullpage-specific styles */
  .fullpage-body {
    margin: 0;
    padding: 0;
    background: #0a0a0a;
    color: #fff;
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    height: 100vh;
  }

  .fp-layout {
    display: flex;
    height: 100vh;
    width: 100vw;
  }

  .fp-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  /* Top Bar */
  .fp-top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
    position: absolute;
    top: 0;
    left: 0;
    right: 400px;
    z-index: 100;
  }

  .fp-back-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #fff;
    text-decoration: none;
    padding: 0.5rem 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    transition: background 0.2s;
  }
  .fp-back-btn:hover { background: rgba(255,255,255,0.2); }

  .fp-stream-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .fp-stream-title {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .fp-stats {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .fp-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #ccc;
  }

  .fp-stat-icon { font-size: 1.1rem; }

  .fp-timer {
    flex-direction: column;
    align-items: flex-end;
    gap: 0;
  }

  .fp-timer-label {
    font-size: 0.65rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .fp-timer-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    color: #dc2626;
  }

  /* Player Container */
  .fp-player-container {
    flex: 1;
    position: relative;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .fp-player-container .video-player,
  .fp-player-container .audio-player {
    width: 100%;
    height: 100%;
  }

  .fp-player-container .hls-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Relay Attribution - hidden by default, shown by JS for relay streams */
  .relay-attribution {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    color: #fff;
    font-size: 0.9rem;
    font-weight: 500;
    z-index: 50;
    opacity: 0.8;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    display: none;
  }

  /* Controls */
  .fp-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: #111;
    border-top: 1px solid #222;
  }

  .fp-controls .play-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #dc2626;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background 0.2s;
  }
  .fp-controls .play-btn:hover { transform: scale(1.05); }
  .fp-controls .play-btn:disabled { background: #444; cursor: not-allowed; }
  .fp-controls .play-btn.playing { background: #16a34a; }

  .fp-controls .led-meters {
    display: flex;
    gap: 4px;
    flex: 0 0 auto;
  }

  .fp-controls .led-meter {
    display: flex;
    flex-direction: column-reverse;
    gap: 2px;
    height: 40px;
  }

  .fp-controls .led-segment {
    width: 8px;
    height: 2px;
    background: #333;
    border-radius: 1px;
  }
  .fp-controls .led-segment.active[data-level="0"],
  .fp-controls .led-segment.active[data-level="1"],
  .fp-controls .led-segment.active[data-level="2"],
  .fp-controls .led-segment.active[data-level="3"],
  .fp-controls .led-segment.active[data-level="4"],
  .fp-controls .led-segment.active[data-level="5"],
  .fp-controls .led-segment.active[data-level="6"],
  .fp-controls .led-segment.active[data-level="7"],
  .fp-controls .led-segment.active[data-level="8"],
  .fp-controls .led-segment.active[data-level="9"] {
    background: #22c55e;
  }
  .fp-controls .led-segment.active[data-level="10"],
  .fp-controls .led-segment.active[data-level="11"],
  .fp-controls .led-segment.active[data-level="12"] {
    background: #eab308;
  }
  .fp-controls .led-segment.active[data-level="13"],
  .fp-controls .led-segment.active[data-level="14"],
  .fp-controls .led-segment.active[data-level="15"] {
    background: #dc2626;
  }

  .fp-controls .reaction-buttons {
    display: flex;
    gap: 0.25rem;
    flex: 1;
    justify-content: center;
  }

  .fp-controls .reaction-btn {
    background: transparent;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .fp-controls .reaction-btn:hover {
    background: rgba(255,255,255,0.1);
    transform: scale(1.1);
  }
  .fp-controls .reaction-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .fp-controls .volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .fp-controls .volume-icon { color: #888; }

  .fp-controls .volume-slider {
    width: 100px;
    height: 4px;
    -webkit-appearance: none;
    background: #333;
    border-radius: 2px;
    outline: none;
  }
  .fp-controls .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: #dc2626;
    border-radius: 50%;
    cursor: pointer;
  }

  .fp-controls .shoutout-btn {
    background: transparent;
    border: 1px solid #dc2626;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    color: #dc2626;
    cursor: pointer;
    font-size: 1.25rem;
    transition: all 0.2s;
  }
  .fp-controls .shoutout-btn:hover {
    background: #dc2626;
    color: white;
  }

  /* Sidebar */
  .fp-sidebar {
    width: 400px;
    background: #111;
    border-left: 1px solid #222;
    display: flex;
    flex-direction: column;
  }

  .fp-chat-tabs {
    display: flex;
    background: #0a0a0a;
    border-bottom: 1px solid #222;
  }

  .fp-chat-tab {
    flex: 1;
    padding: 0.75rem;
    background: transparent;
    border: none;
    color: #666;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    transition: all 0.2s;
    border-bottom: 2px solid transparent;
  }
  .fp-chat-tab:hover { color: #999; }
  .fp-chat-tab.active {
    color: #fff;
    border-bottom-color: #dc2626;
  }
  .fp-chat-tab .brand-fresh { color: #fff; }
  .fp-chat-tab .brand-wax { color: #dc2626; }
  .fp-chat-tab.active .brand-fresh { color: #fff; }
  .fp-chat-tab.active .brand-wax { color: #dc2626; }
  .fp-chat-tab .twitch-icon { color: #9146ff; }
  .fp-chat-tab .youtube-icon { color: #ff0000; }

  .fp-chat-panel {
    flex: 1;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }
  .fp-chat-panel.active { display: flex; }

  .external-chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .external-chat-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #666;
    text-align: center;
    padding: 2rem;
  }
  .external-chat-placeholder svg { opacity: 0.3; margin-bottom: 1rem; }
  .external-chat-placeholder .hint { font-size: 0.85rem; margin-top: 0.5rem; color: #444; }

  .external-chat-frame {
    flex: 1;
    border: none;
    width: 100%;
  }
  .external-chat-frame.hidden { display: none; }

  /* Responsive */
  @media (max-width: 900px) {
    .fp-layout { flex-direction: column; }
    .fp-sidebar { width: 100%; height: 300px; border-left: none; border-top: 1px solid #222; }
    .fp-top-bar { right: 0; }
  }
</style>

<script>
  // Fullpage initialization
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[Fullpage] Initializing...');

    // Chat tab switching
    const chatTabs = document.querySelectorAll('.fp-chat-tab');
    const chatPanels = document.querySelectorAll('.fp-chat-panel');

    chatTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;

        chatTabs.forEach(t => t.classList.remove('active'));
        chatPanels.forEach(p => p.classList.remove('active'));

        tab.classList.add('active');
        document.querySelector(`.fp-chat-panel[data-panel="${targetTab}"]`)?.classList.add('active');

        // Load external chat iframe if needed
        if (targetTab === 'twitch') loadTwitchChat();
        if (targetTab === 'youtube') loadYoutubeChat();
      });
    });

    // Load Twitch chat
    function loadTwitchChat() {
      const stream = window.liveStreamState?.currentStream;
      if (!stream?.twitchChannel) return;

      const frame = document.getElementById('twitchChatFrame');
      const placeholder = document.getElementById('twitchPlaceholder');
      if (!frame || frame.src) return;

      const host = window.location.hostname;
      const parents = ['freshwax.co.uk', 'www.freshwax.co.uk', 'freshwax.pages.dev', host]
        .filter((v, i, a) => a.indexOf(v) === i)
        .map(d => `parent=${d}`).join('&');

      frame.src = `https://www.twitch.tv/embed/${stream.twitchChannel}/chat?${parents}&darkpopout`;
      frame.classList.remove('hidden');
      placeholder?.classList.add('hidden');
    }

    // Load YouTube chat
    function loadYoutubeChat() {
      const stream = window.liveStreamState?.currentStream;
      if (!stream?.youtubeLiveId) return;

      const frame = document.getElementById('youtubeChatFrame');
      const placeholder = document.getElementById('youtubePlaceholder');
      if (!frame || frame.src) return;

      const host = window.location.hostname;
      frame.src = `https://www.youtube.com/live_chat?v=${stream.youtubeLiveId}&embed_domain=${host}`;
      frame.classList.remove('hidden');
      placeholder?.classList.add('hidden');
    }

    // Update external chat tabs visibility based on stream
    function updateExternalChatTabs() {
      const stream = window.liveStreamState?.currentStream;
      const twitchTab = document.getElementById('twitchTab');
      const youtubeTab = document.getElementById('youtubeTab');

      if (twitchTab) {
        twitchTab.style.opacity = stream?.twitchChannel ? '1' : '0.3';
      }
      if (youtubeTab) {
        youtubeTab.style.opacity = stream?.youtubeLiveId ? '1' : '0.3';
      }
    }

    // Listen for stream updates
    const checkStreamInterval = setInterval(() => {
      if (window.liveStreamState?.currentStream) {
        updateExternalChatTabs();
      }
    }, 2000);

    // Shoutout modal
    const shoutoutBtn = document.getElementById('shoutoutBtn');
    const shoutoutModal = document.getElementById('shoutoutModal');

    shoutoutBtn?.addEventListener('click', () => {
      shoutoutModal?.classList.remove('hidden');
    });

    // Close modal handlers
    document.querySelectorAll('[data-close-modal]').forEach(el => {
      el.addEventListener('click', () => {
        shoutoutModal?.classList.add('hidden');
      });
    });

    // Shoutout character count
    const shoutoutInput = document.getElementById('shoutoutInput');
    const shoutoutCharCount = document.getElementById('shoutoutCharCount');
    const sendShoutoutBtn = document.getElementById('sendShoutoutBtn');

    shoutoutInput?.addEventListener('input', () => {
      const len = shoutoutInput.value.length;
      if (shoutoutCharCount) shoutoutCharCount.textContent = len;
      if (sendShoutoutBtn) sendShoutoutBtn.disabled = len === 0;
    });

    // Shoutout emoji buttons
    document.querySelectorAll('.shoutout-emoji').forEach(btn => {
      btn.addEventListener('click', () => {
        if (shoutoutInput) {
          const emoji = btn.textContent;
          if (shoutoutInput.value.length + emoji.length <= 30) {
            shoutoutInput.value += emoji;
            shoutoutInput.dispatchEvent(new Event('input'));
          }
        }
      });
    });

    // Send shoutout
    sendShoutoutBtn?.addEventListener('click', async () => {
      const text = shoutoutInput?.value?.trim();
      if (!text) return;

      const user = window.liveStreamState?.currentUser;
      if (!user) {
        alert('Please sign in to send shoutouts');
        return;
      }

      try {
        const streamId = window.currentStreamId || 'playlist-global';
        await fetch('/api/livestream/shoutout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            streamId,
            userId: user.uid,
            userName: user.displayName || 'Anonymous',
            text
          })
        });

        if (shoutoutInput) shoutoutInput.value = '';
        if (shoutoutCharCount) shoutoutCharCount.textContent = '0';
        if (sendShoutoutBtn) sendShoutoutBtn.disabled = true;
        shoutoutModal?.classList.add('hidden');
      } catch (e) {
        console.error('Shoutout error:', e);
      }
    });

    console.log('[Fullpage] Initialized');
  });
</script>

<!-- Main live stream manager - handles everything -->
<script type="module" src="/live-stream.js?v=20260103-fullpage"></script>

</body>
</html>
