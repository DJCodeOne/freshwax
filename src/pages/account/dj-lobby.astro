---
// src/pages/account/dj-lobby.astro
// DJ-only lobby with stream preview, private chat, streaming instructions, and takeover system
export const prerender = false;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Lobby - Fresh Wax</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Auth Gate -->
  <div id="authGate" class="auth-gate">
    <div class="auth-content">
      <div class="spinner"></div>
      <p>Checking DJ access...</p>
    </div>
  </div>
  
  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied hidden">
    <div class="denied-content">
      <div class="denied-icon">üîí</div>
      <h1>DJ Access Only</h1>
      <p>This area is restricted to approved DJs.</p>
      <a href="/live" class="back-btn">Back to Live</a>
    </div>
  </div>
  
  <!-- Main Lobby -->
  <div id="mainLobby" class="lobby-container hidden">
    <header class="lobby-header">
      <div class="header-left">
        <a href="/live" class="back-link">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          Back to Live
        </a>
      </div>
      <div class="header-center">
        <h1>DJ <span class="red">LOBBY</span></h1>
        <p>Private space for Fresh Wax DJs</p>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="header-avatar-container">
            <img id="headerAvatar" src="/logo.webp" alt="" class="header-avatar" />
            <div id="headerAvatarLetter" class="header-avatar-letter hidden">?</div>
          </div>
          <span id="headerName" class="header-name">Loading...</span>
        </div>
        <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
      </div>
    </header>
    
    <div class="lobby-layout">
      <!-- Far Left Column: Stream Key -->
      <div class="key-column">
        <!-- Stream Control Card -->
        <div class="stream-control-card">
          <a href="/account/go-live" id="goLiveBtn" class="go-live-btn">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            Go Live
          </a>
          <div class="control-divider"></div>
          <button id="lobbyEndStreamBtn" class="lobby-end-stream-btn disabled" disabled>
            <span class="end-icon">‚èπ</span>
            <span class="end-text">End Stream</span>
          </button>
          <p id="endStreamStatus" class="end-stream-status">No active stream</p>
        </div>
        
        <!-- My Stream Key & Details -->
        <div class="stream-key-section">
          <div class="section-header">
            <h3>üîë Your Stream Key</h3>
            <span id="keyStatus" class="key-status">Checking...</span>
          </div>
          
          <div id="keyNotAvailable" class="key-not-available">
            <div class="lock-icon">üîí</div>
            <p>Your stream key will be available <strong>15 minutes</strong> before your scheduled slot.</p>
            <p id="nextSlotInfo" class="next-slot-info">You have no upcoming slots booked.</p>
            <a href="/account/go-live" class="book-slot-link">Book a Slot ‚Üí</a>
          </div>
          
          <div id="keyAvailable" class="key-available hidden">
            <div class="key-header">
              <span class="unlocked-icon">üîì</span>
              <div>
                <strong id="slotTimeDisplay">Your slot: --:-- - --:--</strong>
                <span id="countdownToSlot" class="countdown-text"></span>
              </div>
            </div>
            
            <div class="stream-credentials">
              <div class="cred-row">
                <label>RTMP Server URL</label>
                <div class="cred-value">
                  <code id="rtmpUrl">rtmp://stream.freshwax.co.uk/live</code>
                  <button class="copy-btn" data-copy="rtmpUrl">Copy</button>
                </div>
              </div>
              <div class="cred-row">
                <label>Stream Key</label>
                <div class="cred-value">
                  <code id="myStreamKey">-</code>
                  <button class="copy-btn" data-copy="myStreamKey">Copy</button>
                </div>
              </div>
            </div>
            
            <div class="ready-section">
              <p>Ready to go? Set yourself as ready so the stream transitions smoothly.</p>
              <button id="setReadyBtn" class="ready-btn">
                <span id="readyBtnText">‚úì I'm Ready</span>
              </button>
              <p id="readyStatus" class="ready-status hidden">‚úì You're set as ready. Stream will transition automatically when current DJ finishes.</p>
            </div>
          </div>
          
          <!-- Currently Live Controls -->
          <div id="myStreamControls" class="my-stream-controls hidden">
            <div class="live-badge">üî¥ YOU ARE LIVE</div>
            <div class="live-stats">
              <span id="myStreamDuration">Duration: 00:00</span>
            </div>
            <button id="endStreamBtn" class="end-stream-btn">End Stream</button>
          </div>
        </div>
        
        <!-- Takeover Section -->
        <div class="takeover-section" id="takeoverBox">
          <div class="section-header">
            <h3>üîÑ Stream Takeover</h3>
          </div>
          
          <div id="takeoverRequest" class="takeover-content hidden">
            <p>Request to take over from <strong id="takeoverFromName">DJ</strong></p>
            <button id="requestTakeoverBtn" class="takeover-btn">Request Takeover</button>
            <p id="takeoverPending" class="takeover-pending hidden">‚è≥ Waiting for response... <span id="takeoverCountdown"></span></p>
            <p id="takeoverAttemptsLeft" class="takeover-attempts">3 requests remaining this session</p>
            <p id="takeoverLimitReached" class="takeover-limit hidden">‚ö†Ô∏è No requests remaining this session</p>
          </div>
          
          <div id="incomingTakeover" class="incoming-takeover hidden">
            <div class="incoming-badge">‚ö° TAKEOVER REQUEST</div>
            <div class="incoming-dj">
              <img id="incomingDjAvatar" src="/logo.webp" alt="" />
              <div>
                <strong id="incomingDjName">DJ Name</strong>
                <span>wants to take over</span>
              </div>
            </div>
            <div class="incoming-actions">
              <button id="acceptTakeoverBtn" class="accept-btn">‚úì Accept</button>
              <button id="declineTakeoverBtn" class="decline-btn">‚úï Decline</button>
            </div>
          </div>
          
          <div id="takeoverApproved" class="takeover-approved hidden">
            <div class="approved-badge">‚úì APPROVED</div>
            <p>Copy these into OBS:</p>
            <div class="takeover-creds">
              <div class="cred-row">
                <label>Server</label>
                <div class="cred-value">
                  <code id="takeoverServerUrl">-</code>
                  <button class="copy-btn" data-copy="takeoverServerUrl">Copy</button>
                </div>
              </div>
              <div class="cred-row">
                <label>Key</label>
                <div class="cred-value">
                  <code id="takeoverStreamKey">-</code>
                  <button class="copy-btn" data-copy="takeoverStreamKey">Copy</button>
                </div>
              </div>
            </div>
          </div>
          
          <div id="noStreamTakeover" class="no-stream-msg">
            <p>No active stream to take over.</p>
          </div>
        </div>
        
        <!-- Streaming Setup Link -->
        <div class="setup-link-section">
          <a href="/account/streaming-setup" class="setup-link-btn">
            <span class="setup-icon">üìñ</span>
            <span class="setup-text">Streaming Setup Guide</span>
            <span class="setup-arrow">‚Üí</span>
          </a>
        </div>
      </div>
      
      <!-- Middle Column: Preview Only -->
      <div class="main-column">
        <!-- Current Stream Preview -->
        <div class="preview-section">
          <div class="preview-header">
            <h2>Current Stream</h2>
            <div class="stream-status" id="streamStatus">
              <span class="status-dot offline"></span>
              <span id="statusText">No one streaming</span>
            </div>
          </div>
          
          <div class="preview-player" id="previewPlayer">
            <div id="offlineState" class="offline-state">
              <div class="offline-icon">üì°</div>
              <h3>No Live Stream</h3>
              <p>Be the first to go live!</p>
            </div>
            
            <div id="videoPreview" class="video-preview hidden">
              <video id="hlsVideo" playsinline></video>
            </div>
            
            <div id="audioPreview" class="audio-preview hidden">
              <div class="audio-visualizer">
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
                <div class="viz-bar"></div><div class="viz-bar"></div>
              </div>
              <img id="streamCover" src="/logo.webp" alt="Stream" class="stream-cover" />
              <audio id="audioElement" crossorigin="anonymous"></audio>
            </div>
            
            <!-- Time Remaining Overlay -->
            <div id="timeRemaining" class="time-remaining hidden">
              <span class="time-label">Time Remaining</span>
              <span id="timeLeft" class="time-value">--:--</span>
            </div>
          </div>
          
          <div class="player-controls">
            <button id="playPauseBtn" class="control-btn">
              <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M8 5v14l11-7z"/>
              </svg>
              <svg id="pauseIcon" class="hidden" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
              </svg>
            </button>
            
            <div class="volume-control">
              <button id="muteBtn" class="control-btn small">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
              </button>
              <input type="range" id="volumeSlider" min="0" max="100" value="80" />
            </div>
            
            <div class="stream-info-display">
              <img id="currentDjAvatar" src="/logo.webp" alt="" class="current-dj-avatar" />
              <div class="current-dj-details">
                <span id="currentDjName" class="dj-name">-</span>
                <span id="currentStreamTitle" class="stream-title">No stream</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column: Chat + DJs Online side by side -->
      <div class="right-column">
        <!-- Chat Section -->
        <div class="chat-section">
          <div class="chat-header">
            <h2>üí¨ DJ Chat</h2>
            <div class="chat-header-actions">
              <span class="chat-hint">Private</span>
              <button id="openDmBtn" class="dm-btn">DM</button>
            </div>
          </div>
          
          <div class="chat-messages" id="chatMessages">
            <div class="chat-welcome">
              <p>Welcome to the DJ Lobby! üëã</p>
              <p class="hint">Chat with other DJs, coordinate sets, and hang out.</p>
            </div>
          </div>
          
          <div class="chat-input-section">
            <div class="chat-input-wrapper">
              <input type="text" id="chatInput" placeholder="Message other DJs..." maxlength="500" autocomplete="off" />
              <button id="sendBtn" type="button">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <!-- DJs Online Box -->
        <div class="djs-online-box">
          <div class="box-header">
            <h3>üéß DJs in Lobby</h3>
            <span class="online-count"><span id="onlineDjCount">0</span> online</span>
          </div>
          <div id="djsList" class="djs-list">
            <p class="empty-state">No DJs online yet</p>
          </div>
        </div>
      </div>
    </div>
    
    <footer class="lobby-footer">
      <span>Fresh Wax</span>
      <span class="footer-dot">‚Ä¢</span>
      <span>DJ Lobby</span>
    </footer>
    
    <!-- DM Modal -->
    <div id="dmModal" class="dm-modal hidden">
      <div class="dm-modal-overlay"></div>
      <div class="dm-modal-content">
        <div class="dm-modal-header">
          <h2>üì© Direct Message</h2>
          <button id="closeDmBtn" class="close-dm-btn">‚úï</button>
        </div>
        
        <!-- DJ Selection View -->
        <div id="dmSelectView" class="dm-view">
          <p class="dm-select-hint">Select a DJ to message privately:</p>
          <div id="dmDjList" class="dm-dj-list">
            <p class="empty-state">No other DJs online</p>
          </div>
          <div class="dm-notice">
            <span class="notice-icon">‚ö†Ô∏è</span>
            <span>Messages are not stored and will be deleted when this chat closes.</span>
          </div>
        </div>
        
        <!-- Chat View -->
        <div id="dmChatView" class="dm-view hidden">
          <div class="dm-chat-header">
            <button id="dmBackBtn" class="dm-back-btn">‚Üê Back</button>
            <div class="dm-chat-with">
              <span id="dmChatWithName">DJ Name</span>
            </div>
          </div>
          <div class="dm-messages" id="dmMessages">
            <div class="dm-welcome">
              <p>Start a private conversation</p>
              <p class="hint">Only you and this DJ can see these messages.</p>
            </div>
          </div>
          <div class="dm-input-section">
            <div class="dm-input-wrapper">
              <input type="text" id="dmInput" placeholder="Type a message..." maxlength="500" autocomplete="off" />
              <button id="dmSendBtn" type="button">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="dm-notice small">
            <span class="notice-icon">‚ö†Ô∏è</span>
            <span>This chat is temporary and not stored.</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- DM Notification -->
    <div id="dmNotification" class="dm-notification hidden">
      <div class="dm-notif-content">
        <span class="dm-notif-icon">üí¨</span>
        <span id="dmNotifText">New DM from DJ Name</span>
        <button id="dmNotifOpenBtn" class="dm-notif-open">Open</button>
        <button id="dmNotifDismissBtn" class="dm-notif-dismiss">‚úï</button>
      </div>
    </div>
  </div>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Inter', sans-serif;
    background: #9ca3af;
    color: #111;
    min-height: 100vh;
  }
  
  .hidden { display: none !important; }
  .red { color: #dc2626; }
  
  /* Auth Gate */
  .auth-gate {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #9ca3af;
    z-index: 100;
  }
  
  .auth-content {
    text-align: center;
    color: #333;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #ddd;
    border-top-color: #dc2626;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Access Denied */
  .access-denied {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    z-index: 100;
  }
  
  .denied-content {
    text-align: center;
    padding: 2rem;
  }
  
  .denied-icon { font-size: 4rem; margin-bottom: 1rem; }
  
  .denied-content h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }
  
  .denied-content p { color: #666; margin-bottom: 2rem; }
  
  .back-btn {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: #dc2626;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
  }
  
  /* Header */
  .lobby-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 2rem;
    background: #111;
    border-bottom: 2px solid #333;
  }
  
  .back-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #9ca3af;
    text-decoration: none;
    font-size: 0.9rem;
  }
  
  .back-link:hover { color: #fff; }
  
  .header-center { text-align: center; }
  
  .header-center h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    letter-spacing: 0.05em;
    color: #fff;
  }
  
  .header-center p { color: #9ca3af; font-size: 0.85rem; }
  
  .go-live-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.25rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  
  .go-live-btn.disabled {
    background: #6b7280;
    cursor: not-allowed;
    opacity: 0.6;
    pointer-events: none;
  }
  
  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .header-avatar-container {
    position: relative;
    width: 36px;
    height: 36px;
  }
  
  .header-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid #dc2626;
    object-fit: cover;
  }
  
  .header-avatar-letter {
    position: absolute;
    inset: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #dc2626;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    text-transform: uppercase;
    border: 2px solid #b91c1c;
  }
  
  .header-name {
    color: #fff;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .sign-out-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid #666;
    border-radius: 6px;
    color: #9ca3af;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .sign-out-btn:hover {
    background: #333;
    border-color: #888;
    color: #fff;
  }
  
  /* Stream Control Card */
  .stream-control-card {
    background: #fff;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    padding: 0.75rem;
    text-align: center;
  }
  
  .stream-control-card .go-live-btn {
    width: 100%;
    justify-content: center;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
  }
  
  .stream-control-card .go-live-btn:hover:not(.disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  .control-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 0.75rem 0;
  }
  
  .lobby-end-stream-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .lobby-end-stream-btn:hover:not(.disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  }
  
  .lobby-end-stream-btn.disabled {
    background: #9ca3af;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .end-icon {
    font-size: 1.1rem;
  }
  
  .end-stream-status {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: #666;
  }
  
  .end-stream-status.live {
    color: #dc2626;
    font-weight: 600;
  }
  
  /* Full Height Layout - No Scrolling */
  html, body {
    height: 100%;
    overflow: hidden;
  }
  
  .lobby-layout {
    display: grid;
    grid-template-columns: 280px 1fr 340px 200px;
    gap: 1rem;
    padding: 1rem;
    max-width: 100%;
    height: calc(100vh - 100px); /* Full height minus header and footer */
    overflow: hidden;
  }
  
  /* Footer */
  .lobby-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #4b5563;
    color: #9ca3af;
    font-size: 0.8rem;
    height: 40px;
  }
  
  .footer-dot {
    opacity: 0.5;
  }
  
  @media (max-width: 1600px) {
    .lobby-layout { grid-template-columns: 260px 1fr 300px 180px; }
  }
  
  @media (max-width: 1400px) {
    .lobby-layout { grid-template-columns: 240px 1fr 280px; }
    .djs-online-box { display: none; }
  }
  
  @media (max-width: 1200px) {
    html, body { overflow: auto; }
    .lobby-layout { 
      grid-template-columns: 1fr; 
      height: auto;
      min-height: calc(100vh - 100px);
    }
    .chat-section { min-height: 400px; }
    .djs-online-box { display: block; }
    
    /* Reorder sections for mobile - preview first, then key, then rest */
    .key-column { order: 2; }
    .main-column { order: 1; }
    .chat-section { order: 3; }
    .djs-online-box { order: 4; }
  }
  
  .key-column {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    height: 100%;
    overflow-y: auto;
  }
  
  .main-column {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    height: 100%;
    overflow: hidden;
  }
  
  .right-column {
    display: contents;
  }
  
  /* Setup Link Button */
  .setup-link-section {
    background: #fff;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    padding: 0.75rem;
  }
  
  .setup-link-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    text-decoration: none;
    color: #111;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .setup-link-btn:hover {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    transform: translateY(-1px);
  }
  
  .setup-icon {
    font-size: 1.25rem;
  }
  
  .setup-text {
    flex: 1;
    font-size: 0.95rem;
  }
  
  .setup-arrow {
    color: #9ca3af;
    font-size: 1.1rem;
  }
  
  .setup-link-btn:hover .setup-arrow {
    color: #3b82f6;
  }
  
  /* Preview Section */
  .preview-section, .stream-key-section, .takeover-section {
    background: #fff;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    padding: 1rem;
  }
  
  .preview-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .preview-header, .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }
  
  .preview-header h2, .section-header h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.25rem;
    letter-spacing: 0.05em;
  }
  
  .section-header h3 { font-size: 1.1rem; }
  
  .stream-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 1rem;
    background: #f3f4f6;
    border-radius: 20px;
    font-size: 0.85rem;
  }
  
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }
  
  .status-dot.offline { background: #9ca3af; }
  .status-dot.live {
    background: #dc2626;
    animation: pulse-red 1.5s infinite;
  }
  
  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
  }
  
  /* Player - Fill Available Space */
  .preview-player {
    background: #111;
    border: 2px solid #333;
    border-radius: 10px;
    flex: 1;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }
  
  .offline-state {
    text-align: center;
    padding: 1.5rem;
    color: #fff;
  }
  
  .offline-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.5; }
  .offline-state h3 { font-size: 1.25rem; margin-bottom: 0.35rem; }
  .offline-state p { color: #888; font-size: 0.9rem; }
  
  .video-preview {
    width: 100%;
    height: 100%;
    position: absolute;
    inset: 0;
  }
  
  .video-preview video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
  }
  
  .audio-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    padding: 2rem;
  }
  
  .audio-visualizer {
    display: flex;
    gap: 6px;
    height: 80px;
    align-items: flex-end;
  }
  
  .viz-bar {
    width: 8px;
    background: linear-gradient(to top, #dc2626, #f87171);
    border-radius: 4px;
    animation: viz 0.5s ease-in-out infinite alternate;
  }
  
  .viz-bar:nth-child(1) { height: 25px; animation-delay: 0s; }
  .viz-bar:nth-child(2) { height: 50px; animation-delay: 0.1s; }
  .viz-bar:nth-child(3) { height: 35px; animation-delay: 0.2s; }
  .viz-bar:nth-child(4) { height: 65px; animation-delay: 0.3s; }
  .viz-bar:nth-child(5) { height: 45px; animation-delay: 0.4s; }
  .viz-bar:nth-child(6) { height: 55px; animation-delay: 0.5s; }
  .viz-bar:nth-child(7) { height: 30px; animation-delay: 0.6s; }
  .viz-bar:nth-child(8) { height: 70px; animation-delay: 0.7s; }
  
  @keyframes viz { to { height: 80px; } }
  
  .stream-cover {
    width: 150px;
    height: 150px;
    border-radius: 12px;
    object-fit: cover;
    border: 3px solid #333;
  }
  
  /* Time Remaining */
  .time-remaining {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(0, 0, 0, 0.85);
    border: 2px solid #dc2626;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    text-align: center;
  }
  
  .time-label {
    display: block;
    color: #888;
    font-size: 0.7rem;
    text-transform: uppercase;
  }
  
  .time-value {
    display: block;
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    letter-spacing: 0.05em;
  }
  
  /* Controls */
  .player-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 12px;
    margin-top: 1rem;
  }
  
  .control-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: #dc2626;
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
  }
  
  .control-btn:hover { background: #b91c1c; }
  
  .control-btn.small {
    width: 36px;
    height: 36px;
    background: #333;
  }
  
  .volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  #volumeSlider {
    width: 120px;
    height: 6px;
    -webkit-appearance: none;
    background: #e5e7eb;
    border-radius: 3px;
    cursor: pointer;
  }
  
  #volumeSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: #dc2626;
    border-radius: 50%;
  }
  
  .stream-info-display {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-left: auto;
  }
  
  .current-dj-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid #e5e7eb;
  }
  
  .dj-name { font-weight: 600; display: block; }
  .stream-title { color: #666; font-size: 0.85rem; }
  
  /* Stream Key Section */
  .key-status {
    font-size: 0.8rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-weight: 600;
  }
  
  .key-status.locked {
    background: #fee2e2;
    color: #dc2626;
  }
  
  .key-status.unlocked {
    background: #d1fae5;
    color: #059669;
  }
  
  .key-not-available {
    text-align: center;
    padding: 2rem 1rem;
    background: #f9fafb;
    border-radius: 8px;
  }
  
  .lock-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }
  .key-not-available p { color: #666; margin-bottom: 0.5rem; }
  .next-slot-info { color: #999; font-size: 0.9rem; }
  
  .book-slot-link {
    display: inline-block;
    margin-top: 1rem;
    color: #dc2626;
    font-weight: 600;
    text-decoration: none;
  }
  
  .key-available {
    background: #f0fdf4;
    border: 2px solid #10b981;
    border-radius: 8px;
    padding: 1rem;
  }
  
  .key-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .unlocked-icon { font-size: 1.5rem; }
  .key-header strong { display: block; color: #111; }
  .countdown-text { color: #059669; font-size: 0.85rem; }
  
  .stream-credentials, .takeover-creds {
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .cred-row {
    margin-bottom: 0.75rem;
  }
  
  .cred-row:last-child { margin-bottom: 0; }
  
  .cred-row label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
  }
  
  .cred-value {
    display: flex;
    gap: 0.5rem;
  }
  
  .cred-value code {
    flex: 1;
    padding: 0.5rem 0.75rem;
    background: #f3f4f6;
    border-radius: 6px;
    font-family: monospace;
    font-size: 0.85rem;
    word-break: break-all;
  }
  
  .copy-btn {
    padding: 0.5rem 1rem;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
  }
  
  .copy-btn:hover { background: #111; }
  
  /* Ready Section */
  .ready-section {
    text-align: center;
    padding-top: 1rem;
    border-top: 1px solid #d1fae5;
  }
  
  .ready-section p { color: #666; font-size: 0.9rem; margin-bottom: 0.75rem; }
  
  .ready-btn {
    padding: 0.75rem 2rem;
    background: #10b981;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
  }
  
  .ready-btn:hover { background: #059669; }
  .ready-btn.is-ready {
    background: #059669;
    pointer-events: none;
  }
  
  .ready-status {
    margin-top: 0.75rem;
    color: #059669;
    font-weight: 600;
  }
  
  /* My Stream Controls */
  .my-stream-controls {
    margin-top: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border: 2px solid #dc2626;
    border-radius: 8px;
    text-align: center;
  }
  
  .live-badge {
    display: inline-block;
    background: #dc2626;
    color: #fff;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    animation: pulse-badge 1s infinite;
  }
  
  @keyframes pulse-badge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  .live-stats {
    margin: 0.75rem 0;
    color: #666;
    font-size: 0.9rem;
  }
  
  .end-stream-btn {
    padding: 0.6rem 1.5rem;
    background: #dc2626;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  
  /* Takeover Section */
  .takeover-content, .incoming-takeover, .takeover-approved, .no-stream-msg {
    padding: 0.5rem 0;
  }
  
  .takeover-btn {
    padding: 0.6rem 1.25rem;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  
  .takeover-pending {
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #fef3c7;
    border-radius: 6px;
    color: #92400e;
    font-size: 0.85rem;
  }
  
  .takeover-attempts {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: #666;
  }
  
  .takeover-limit {
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #fee2e2;
    border-radius: 6px;
    color: #dc2626;
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  .takeover-btn.disabled {
    background: #9ca3af;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .incoming-takeover {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border: 2px solid #dc2626;
    border-radius: 8px;
    padding: 1rem;
  }
  
  .incoming-badge {
    display: inline-block;
    background: #dc2626;
    color: #fff;
    padding: 0.3rem 0.75rem;
    border-radius: 16px;
    font-weight: 700;
    font-size: 0.8rem;
    margin-bottom: 0.75rem;
  }
  
  .incoming-dj {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .incoming-dj img {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid #dc2626;
  }
  
  .incoming-dj strong { display: block; }
  .incoming-dj span { color: #666; font-size: 0.85rem; }
  
  .incoming-actions { display: flex; gap: 0.75rem; }
  
  .accept-btn, .decline-btn {
    flex: 1;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  
  .accept-btn { background: #10b981; color: #fff; }
  .decline-btn { background: #6b7280; color: #fff; }
  
  .takeover-approved {
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border: 2px solid #10b981;
    border-radius: 8px;
    padding: 1rem;
  }
  
  .approved-badge {
    display: inline-block;
    background: #10b981;
    color: #fff;
    padding: 0.3rem 0.75rem;
    border-radius: 16px;
    font-weight: 700;
    font-size: 0.8rem;
    margin-bottom: 0.75rem;
  }
  
  .no-stream-msg { color: #666; }

  /* Chat Section - Full Height */
  .chat-section {
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    overflow: hidden;
    height: 100%;
  }
  
  .chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: #111;
    color: #fff;
    flex-shrink: 0;
  }
  
  .chat-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 0.05em;
  }
  
  .chat-hint {
    color: #10b981;
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    background: rgba(16, 185, 129, 0.2);
    border-radius: 12px;
    font-weight: 600;
  }
  
  .chat-header-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .dm-btn {
    padding: 0.2rem 0.6rem;
    background: #3b82f6;
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .dm-btn:hover {
    background: #2563eb;
  }
  
  /* DM Modal */
  .dm-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .dm-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
  }
  
  .dm-modal-content {
    position: relative;
    background: #fff;
    border-radius: 16px;
    width: 90%;
    max-width: 450px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  .dm-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: #111;
    color: #fff;
  }
  
  .dm-modal-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.25rem;
    letter-spacing: 0.05em;
  }
  
  .close-dm-btn {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.25rem;
  }
  
  .close-dm-btn:hover { color: #fff; }
  
  .dm-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .dm-select-hint {
    padding: 1rem 1.25rem;
    color: #666;
    font-size: 0.9rem;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .dm-dj-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-height: 150px;
    max-height: 300px;
  }
  
  .dm-dj-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .dm-dj-item:hover {
    border-color: #3b82f6;
    background: #eff6ff;
  }
  
  .dm-dj-item img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .dm-dj-avatar-letter {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #dc2626;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    text-transform: uppercase;
    flex-shrink: 0;
  }
  
  .dm-dj-info {
    flex: 1;
  }
  
  .dm-dj-name {
    font-weight: 600;
    color: #111;
  }
  
  .dm-dj-status {
    font-size: 0.75rem;
    color: #666;
  }
  
  .dm-notice {
    padding: 0.75rem 1rem;
    background: #fef3c7;
    border-top: 1px solid #fcd34d;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: #92400e;
  }
  
  .dm-notice.small {
    padding: 0.5rem 0.75rem;
    font-size: 0.7rem;
  }
  
  .notice-icon {
    flex-shrink: 0;
  }
  
  /* DM Chat View */
  .dm-chat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .dm-back-btn {
    padding: 0.4rem 0.75rem;
    background: #e5e7eb;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    color: #666;
  }
  
  .dm-back-btn:hover {
    background: #d1d5db;
    color: #111;
  }
  
  .dm-chat-with {
    flex: 1;
  }
  
  #dmChatWithName {
    font-weight: 600;
    color: #111;
  }
  
  .dm-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: #fafafa;
    min-height: 200px;
    max-height: 350px;
  }
  
  .dm-welcome {
    text-align: center;
    padding: 1.5rem;
    color: #666;
  }
  
  .dm-welcome p:first-child {
    font-weight: 600;
    color: #111;
    margin-bottom: 0.25rem;
  }
  
  .dm-welcome .hint {
    font-size: 0.85rem;
  }
  
  .dm-message {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    max-width: 85%;
  }
  
  .dm-message.sent {
    margin-left: auto;
    background: #eff6ff;
    border-color: #3b82f6;
  }
  
  .dm-message-content {
    flex: 1;
    min-width: 0;
  }
  
  .dm-message-name {
    font-weight: 600;
    font-size: 0.8rem;
    color: #111;
    margin-bottom: 0.15rem;
  }
  
  .dm-message-text {
    font-size: 0.85rem;
    color: #333;
    word-wrap: break-word;
  }
  
  .dm-message-time {
    font-size: 0.65rem;
    color: #9ca3af;
    margin-top: 0.25rem;
  }
  
  .dm-input-section {
    padding: 0.75rem;
    background: #fff;
    border-top: 1px solid #e5e7eb;
  }
  
  .dm-input-wrapper {
    display: flex;
    gap: 0.5rem;
    background: #f3f4f6;
    border-radius: 24px;
    padding: 0.4rem 0.4rem 0.4rem 0.75rem;
    border: 2px solid #e5e7eb;
  }
  
  .dm-input-wrapper:focus-within {
    border-color: #3b82f6;
  }
  
  #dmInput {
    flex: 1;
    background: none;
    border: none;
    color: #111;
    font-size: 0.9rem;
    outline: none;
  }
  
  #dmSendBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: #3b82f6;
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
  }
  
  #dmSendBtn:hover {
    background: #2563eb;
  }
  
  /* DM Notification */
  .dm-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 999;
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  .dm-notif-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #fff;
    border: 2px solid #3b82f6;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }
  
  .dm-notif-icon {
    font-size: 1.25rem;
  }
  
  #dmNotifText {
    font-size: 0.9rem;
    font-weight: 500;
    color: #111;
  }
  
  .dm-notif-open {
    padding: 0.4rem 0.75rem;
    background: #3b82f6;
    border: none;
    border-radius: 6px;
    color: #fff;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
  }
  
  .dm-notif-open:hover {
    background: #2563eb;
  }
  
  .dm-notif-dismiss {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 1rem;
    cursor: pointer;
    padding: 0.25rem;
  }
  
  .dm-notif-dismiss:hover {
    color: #666;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: #fafafa;
  }
  
  .chat-welcome {
    text-align: center;
    padding: 1rem;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .chat-welcome p { font-weight: 600; font-size: 0.9rem; }
  .chat-welcome .hint { color: #666; font-size: 0.8rem; margin-top: 0.5rem; font-weight: 400; }
  
  .chat-message {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .chat-message img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
  }
  
  .chat-avatar-letter {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #dc2626;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.95rem;
    text-transform: uppercase;
    flex-shrink: 0;
  }
  
  .chat-message-content { flex: 1; min-width: 0; }
  
  .chat-message-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }
  
  .chat-message-name { font-weight: 600; font-size: 0.85rem; }
  .chat-message-time { color: #9ca3af; font-size: 0.7rem; }
  .chat-message-text { color: #333; font-size: 0.85rem; word-wrap: break-word; }
  
  .chat-input-section {
    padding: 0.75rem;
    background: #fff;
    border-top: 1px solid #e5e7eb;
    flex-shrink: 0;
  }
  
  .chat-input-wrapper {
    display: flex;
    gap: 0.5rem;
    background: #f3f4f6;
    border-radius: 24px;
    padding: 0.4rem 0.4rem 0.4rem 0.75rem;
    border: 2px solid #e5e7eb;
  }
  
  .chat-input-wrapper:focus-within { border-color: #dc2626; }
  
  #chatInput {
    flex: 1;
    background: none;
    border: none;
    color: #111;
    font-size: 0.9rem;
    outline: none;
  }
  
  #sendBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: #dc2626;
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
  }
  
  /* DJs Online Box - Full Height */
  .djs-online-box {
    background: #fff;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }
  
  .box-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    flex-shrink: 0;
  }
  
  .box-header h3 { font-size: 0.9rem; font-weight: 700; }
  
  .online-count {
    background: #10b981;
    color: #fff;
    padding: 0.15rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  
  .djs-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    flex: 1;
    overflow-y: auto;
  }
  
  .dj-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.6rem;
    background: #f3f4f6;
    border-radius: 16px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  
  .dj-item img {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .dj-avatar-letter {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #dc2626;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.7rem;
    text-transform: uppercase;
    flex-shrink: 0;
  }
  
  .dj-item.is-live {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border: 2px solid #dc2626;
  }
  
  .dj-item.is-live::after { content: 'üî¥'; margin-left: 0.2rem; font-size: 0.65rem; }
  .dj-item.is-ready::after { content: '‚úì'; margin-left: 0.2rem; color: #10b981; }
  
  .empty-state { color: #9ca3af; font-size: 0.8rem; font-style: italic; }
  
  /* ============================================
     MOBILE & TABLET OPTIMIZATIONS
     Optimized for streaming via Bluetooth to cars, speakers, soundbars, casting to TV
     ============================================ */
  
  /* Tablet landscape */
  @media (max-width: 1024px) {
    .lobby-header { 
      flex-direction: column; 
      gap: 0.75rem; 
      padding: 0.75rem 1rem;
    }
    .lobby-layout { 
      grid-template-columns: 1fr;
      padding: 0.75rem; 
      gap: 0.75rem; 
    }
    .preview-section, .stream-key-section, .takeover-section {
      padding: 1rem;
    }
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }
  }
  
  /* Tablet portrait & large phones */
  @media (max-width: 768px) {
    body {
      font-size: 16px; /* Prevent zoom on input focus */
    }
    
    .lobby-header { 
      padding: 0.75rem; 
      gap: 0.5rem;
    }
    
    .header-center h1 {
      font-size: 1.5rem;
    }
    
    .header-center p {
      font-size: 0.75rem;
    }
    
    .back-link, .go-live-btn {
      font-size: 0.8rem;
      padding: 0.5rem 0.75rem;
    }
    
    .lobby-layout { 
      padding: 0.5rem; 
      gap: 0.5rem; 
    }
    
    /* Stream preview - prioritize this for listeners */
    .preview-section {
      padding: 0.75rem;
    }
    
    .preview-header h2 {
      font-size: 1.1rem;
    }
    
    .preview-player {
      min-height: 200px;
    }
    
    /* Larger touch targets for controls */
    .player-controls { 
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.75rem 0;
    }
    
    .control-btn {
      min-width: 48px;
      min-height: 48px;
      padding: 0.75rem;
    }
    
    .control-btn.small {
      min-width: 44px;
      min-height: 44px;
    }
    
    .volume-control {
      flex: 1;
      min-width: 120px;
    }
    
    #volumeSlider {
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    #volumeSlider::-webkit-slider-thumb {
      width: 24px;
      height: 24px;
      -webkit-appearance: none;
    }
    
    .stream-info-display { 
      width: 100%; 
      margin: 0.5rem 0 0 0;
      padding: 0.5rem;
      background: rgba(0,0,0,0.05);
      border-radius: 8px;
    }
    
    .current-dj-avatar {
      width: 36px;
      height: 36px;
    }
    
    .dj-name {
      font-size: 0.95rem;
    }
    
    /* Stream key section - compact on mobile */
    .stream-key-section {
      padding: 0.75rem;
    }
    
    .section-header h3 {
      font-size: 1rem;
    }
    
    .key-not-available {
      padding: 1rem;
    }
    
    .lock-icon {
      font-size: 2rem;
    }
    
    .cred-row {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .cred-value {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .cred-value code {
      font-size: 0.75rem;
      padding: 0.75rem;
      word-break: break-all;
    }
    
    .copy-btn {
      width: 100%;
      padding: 0.75rem;
      min-height: 44px;
    }
    
    .ready-btn, .end-stream-btn, .takeover-btn {
      width: 100%;
      padding: 1rem;
      min-height: 48px;
      font-size: 1rem;
    }
    
    /* Chat section - smaller on mobile */
    .chat-section {
      min-height: 300px;
    }
    
    .chat-header {
      padding: 0.75rem;
    }
    
    .chat-header h2 {
      font-size: 1rem;
    }
    
    .chat-messages {
      padding: 0.5rem;
    }
    
    .chat-input-wrapper input {
      font-size: 16px; /* Prevent zoom */
      padding: 0.75rem;
    }
    
    #sendBtn {
      min-width: 48px;
      min-height: 48px;
    }
    
    /* DJs online box */
    .djs-online-box {
      padding: 0.75rem;
    }
    
    .dj-item {
      padding: 0.5rem 0.75rem;
    }
    
    /* Speed test modal */
    .speed-modal-content {
      width: 95%;
      max-width: none;
      margin: 1rem;
    }
    
    .speed-modal-body {
      padding: 1rem;
    }
    
    .speed-results-grid {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }
    
    .result-value {
      font-size: 1.75rem;
    }
    
    .rec-card {
      padding: 0.75rem;
    }
    
    .start-test-btn, .retest-btn {
      width: 100%;
      min-height: 48px;
    }
  }
  
  /* Small phones */
  @media (max-width: 480px) {
    .lobby-header {
      padding: 0.5rem;
    }
    
    .header-center h1 {
      font-size: 1.25rem;
    }
    
    .preview-player {
      min-height: 180px;
    }
    
    .time-remaining {
      top: 0.5rem;
      right: 0.5rem;
      padding: 0.4rem 0.6rem;
    }
    
    .time-value {
      font-size: 1rem;
    }
    
    .player-controls {
      justify-content: center;
    }
    
    .volume-control {
      order: 3;
      width: 100%;
      justify-content: center;
    }
    
    .stream-info-display {
      flex-direction: column;
      text-align: center;
      gap: 0.5rem;
    }
    
    .current-dj-avatar {
      margin: 0 auto;
    }
    
    .chat-section {
      min-height: 250px;
    }
    
    .chat-message {
      padding: 0.5rem;
    }
    
    .message-avatar {
      width: 28px;
      height: 28px;
    }
  }
  
  /* Touch device optimizations */
  @media (hover: none) and (pointer: coarse) {
    /* Larger touch targets */
    .control-btn, .copy-btn, button {
      min-height: 44px;
    }
    
    /* Remove hover effects that don't work on touch */
    .control-btn:hover,
    .copy-btn:hover {
      transform: none;
    }
    
    /* Better scrolling */
    .chat-messages,
    .djs-list {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    
    /* Prevent text selection on buttons */
    button {
      -webkit-user-select: none;
      user-select: none;
    }
  }
  
  /* Landscape phone - prioritize player */
  @media (max-height: 500px) and (orientation: landscape) {
    .lobby-header {
      padding: 0.5rem 1rem;
      flex-direction: row;
    }
    
    .header-center h1 {
      font-size: 1.25rem;
    }
    
    .header-center p {
      display: none;
    }
    
    .preview-player {
      min-height: 150px;
    }
    
    .stream-key-section,
    .takeover-section,
    .chat-section,
    .djs-online-box {
      display: none;
    }
    
    .preview-section {
      height: calc(100vh - 80px);
    }
  }
  
  /* Reduce motion for performance/accessibility */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation: none !important;
      transition-duration: 0.01ms !important;
    }
    
    .viz-bar {
      animation: none;
    }
  }
  
  /* Dark mode support for OLED screens (battery saving) */
  @media (prefers-color-scheme: dark) {
    /* Users can override if they want dark mode */
  }
  
  /* High contrast mode */
  @media (prefers-contrast: high) {
    .control-btn,
    .copy-btn {
      border: 2px solid currentColor;
    }
  }
</style>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, doc, setDoc, deleteDoc, getDocs, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
  
  const app = initializeApp({
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store"
  });
  
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let currentUser = null;
  let userInfo = null;
  let currentStream = null;
  let mySlot = null;
  let presenceRef = null;
  let streamStartTime = null;
  let streamEndTime = null;
  
  // Takeover limiting - max 3 attempts per session
  let takeoverAttempts = 0;
  const MAX_TAKEOVER_ATTEMPTS = 3;
  let takeoverTimeout = null;
  let takeoverPending = false;
  
  // DM System
  let dmTargetDj = null;
  let dmMessages = [];
  let dmUnsubscribe = null;
  let onlineDjsCache = [];
  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = '/login?redirect=/account/dj-lobby';
      return;
    }
    currentUser = user;
    await checkDjAccess(user.uid);
  });
  
  async function checkDjAccess(userId) {
    try {
      const response = await fetch(`/api/get-user-type?uid=${userId}`);
      const result = await response.json();
      
      if (!result.success) { showAccessDenied(); return; }
      
      const isDj = result.roles?.dj === true || result.roles?.artist === true;
      const isApproved = result.isApproved === true;
      const isAdmin = result.isAdmin === true;
      
      if ((isDj && isApproved) || isAdmin) {
        const displayName = result.partnerDisplayName || result.name || 'DJ';
        userInfo = {
          id: userId,
          name: displayName,
          firstName: result.firstName || displayName.split(' ')[0] || 'D',
          avatar: result.avatarUrl || null,
          isAdmin: isAdmin
        };
        showLobby();
        initLobby();
      } else {
        showAccessDenied();
      }
    } catch (e) {
      console.error('Access check failed:', e);
      showAccessDenied();
    }
  }
  
  function showAccessDenied() {
    document.getElementById('authGate').classList.add('hidden');
    document.getElementById('accessDenied').classList.remove('hidden');
  }
  
  function showLobby() {
    document.getElementById('authGate').classList.add('hidden');
    document.getElementById('mainLobby').classList.remove('hidden');
    
    // Populate header with user info
    document.getElementById('headerName').textContent = userInfo.name;
    
    // Handle avatar with letter fallback
    const avatarImg = document.getElementById('headerAvatar');
    const avatarLetter = document.getElementById('headerAvatarLetter');
    
    if (userInfo.avatar && userInfo.avatar !== '/logo.webp') {
      // Try to load the image
      avatarImg.onload = () => {
        avatarImg.classList.remove('hidden');
        avatarLetter.classList.add('hidden');
      };
      avatarImg.onerror = () => {
        // Image failed, show letter
        avatarImg.classList.add('hidden');
        avatarLetter.classList.remove('hidden');
        avatarLetter.textContent = getAvatarLetter(userInfo.name, userInfo.firstName);
      };
      avatarImg.src = userInfo.avatar;
    } else {
      // No avatar URL, show letter
      avatarImg.classList.add('hidden');
      avatarLetter.classList.remove('hidden');
      avatarLetter.textContent = getAvatarLetter(userInfo.name, userInfo.firstName);
    }
  }
  
  function getAvatarLetter(displayName, firstName) {
    // Try display name first, then firstName
    const name = displayName || firstName || 'D';
    return name.charAt(0).toUpperCase();
  }
  
  async function initLobby() {
    await setPresence();
    await loadStreamStatus();
    await checkAndCleanupChat(); // Check if chat should be cleared
    await loadMySlot();
    subscribeToChat();
    subscribeToOnlineDjs();
    subscribeToTakeover();
    subscribeToIncomingDms();
    setupEventListeners();
    
    setInterval(loadStreamStatus, 10000);
    setInterval(updateTimeRemaining, 1000);
    setInterval(checkStreamKeyAvailability, 30000);
  }
  
  async function setPresence() {
    try {
      presenceRef = doc(db, 'djLobbyPresence', currentUser.uid);
      await setDoc(presenceRef, {
        odamiMa: currentUser.uid,
        name: userInfo.name,
        avatar: userInfo.avatar || null,
        avatarLetter: getAvatarLetter(userInfo.name, userInfo.firstName),
        joinedAt: serverTimestamp(),
        lastSeen: serverTimestamp(),
        isReady: false
      });
      
      setInterval(async () => {
        if (presenceRef) {
          await setDoc(presenceRef, { lastSeen: serverTimestamp() }, { merge: true });
        }
      }, 30000);
      
      window.addEventListener('beforeunload', async () => {
        if (presenceRef) { try { await deleteDoc(presenceRef); } catch(e) {} }
      });
    } catch (e) {
      console.error('Presence error:', e);
    }
  }
  
  // Check if chat should be cleaned up (2 hours since last stream ended and no one is live)
  async function checkAndCleanupChat() {
    try {
      // Get chat settings doc
      const settingsRef = doc(db, 'djLobbySettings', 'chatCleanup');
      const settingsSnap = await getDoc(settingsRef);
      const settings = settingsSnap.exists() ? settingsSnap.data() : {};
      
      const lastStreamEndTime = settings.lastStreamEndTime?.toMillis() || 0;
      const now = Date.now();
      const twoHoursMs = 2 * 60 * 60 * 1000; // 2 hours in milliseconds
      
      // If no one is currently streaming AND 2 hours have passed since last stream ended
      if (!currentStream && lastStreamEndTime > 0 && (now - lastStreamEndTime) > twoHoursMs) {
        console.log('Chat cleanup: 2+ hours since last stream, clearing chat history...');
        
        // Delete all DJ lobby chat messages
        const chatSnapshot = await getDocs(collection(db, 'djLobbyChat'));
        const deletePromises = [];
        chatSnapshot.forEach(document => {
          deletePromises.push(deleteDoc(doc(db, 'djLobbyChat', document.id)));
        });
        await Promise.all(deletePromises);
        
        // Reset the lastStreamEndTime so we don't keep deleting
        await setDoc(settingsRef, { 
          lastStreamEndTime: null,
          lastCleanup: serverTimestamp()
        }, { merge: true });
        
        console.log('Chat cleanup complete');
      }
    } catch (e) {
      console.error('Chat cleanup check error:', e);
    }
  }
  
  // Call this when a stream ends to record the time
  async function recordStreamEnd() {
    try {
      const settingsRef = doc(db, 'djLobbySettings', 'chatCleanup');
      await setDoc(settingsRef, { 
        lastStreamEndTime: serverTimestamp()
      }, { merge: true });
    } catch (e) {
      console.error('Record stream end error:', e);
    }
  }
  
  function subscribeToOnlineDjs() {
    onSnapshot(query(collection(db, 'djLobbyPresence')), (snapshot) => {
      const djs = [];
      const now = Date.now();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        const lastSeen = data.lastSeen?.toMillis() || 0;
        if (now - lastSeen < 120000) {
          djs.push({ id: doc.id, ...data });
        }
      });
      
      // Cache for DM list
      onlineDjsCache = djs;
      
      updateOnlineDjsList(djs);
    });
  }
  
  function updateOnlineDjsList(djs) {
    document.getElementById('onlineDjCount').textContent = djs.length;
    
    const list = document.getElementById('djsList');
    if (djs.length === 0) {
      list.innerHTML = '<p class="empty-state">No DJs online yet</p>';
      return;
    }
    
    list.innerHTML = djs.map(dj => {
      const isLive = currentStream && currentStream.djId === dj.odamiMa;
      const isMe = dj.odamiMa === currentUser?.uid;
      const isReady = dj.isReady === true;
      const avatarLetter = dj.avatarLetter || (dj.name ? dj.name.charAt(0).toUpperCase() : 'D');
      const hasAvatar = dj.avatar && dj.avatar !== '/logo.webp';
      
      return `
        <div class="dj-item ${isLive ? 'is-live' : ''} ${isReady && !isLive ? 'is-ready' : ''}">
          ${hasAvatar 
            ? `<img src="${dj.avatar}" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="dj-avatar-letter" style="display:none;">${avatarLetter}</span>`
            : `<span class="dj-avatar-letter">${avatarLetter}</span>`
          }
          <span>${dj.name}${isMe ? ' (you)' : ''}</span>
        </div>
      `;
    }).join('');
  }
  
  async function loadStreamStatus() {
    try {
      const response = await fetch('/api/livestream/status');
      const result = await response.json();
      
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.getElementById('statusText');
      const offlineState = document.getElementById('offlineState');
      const videoPreview = document.getElementById('videoPreview');
      const audioPreview = document.getElementById('audioPreview');
      const timeRemaining = document.getElementById('timeRemaining');
      const myControls = document.getElementById('myStreamControls');
      const takeoverRequest = document.getElementById('takeoverRequest');
      const noStreamTakeover = document.getElementById('noStreamTakeover');
      
      if (result.success && result.isLive && result.primaryStream) {
        currentStream = result.primaryStream;
        
        statusDot.classList.remove('offline');
        statusDot.classList.add('live');
        statusText.textContent = `${currentStream.djName} is LIVE`;
        
        offlineState.classList.add('hidden');
        timeRemaining.classList.remove('hidden');
        
        // Parse stream times
        if (currentStream.startedAt) {
          streamStartTime = new Date(currentStream.startedAt);
        }
        if (currentStream.endTime) {
          streamEndTime = new Date(currentStream.endTime);
        } else if (currentStream.duration) {
          streamEndTime = new Date(streamStartTime.getTime() + currentStream.duration * 60000);
        }
        
        document.getElementById('currentDjName').textContent = currentStream.djName || 'DJ';
        document.getElementById('currentStreamTitle').textContent = currentStream.title || 'Live Stream';
        if (currentStream.djAvatar) {
          document.getElementById('currentDjAvatar').src = currentStream.djAvatar;
        }
        
        if (currentStream.streamType === 'audio' || currentStream.streamUrl?.includes('8000')) {
          audioPreview.classList.remove('hidden');
          videoPreview.classList.add('hidden');
          if (currentStream.djAvatar) document.getElementById('streamCover').src = currentStream.djAvatar;
        } else {
          videoPreview.classList.remove('hidden');
          audioPreview.classList.add('hidden');
        }
        
        if (currentStream.djId === currentUser?.uid) {
          myControls.classList.remove('hidden');
          takeoverRequest.classList.add('hidden');
          noStreamTakeover.classList.add('hidden');
          
          // Enable end stream button for current streamer
          updateEndStreamButton(true, true);
        } else {
          myControls.classList.add('hidden');
          takeoverRequest.classList.remove('hidden');
          noStreamTakeover.classList.add('hidden');
          document.getElementById('takeoverFromName').textContent = currentStream.djName || 'current DJ';
          
          // Disable end stream button - not your stream
          updateEndStreamButton(true, false);
        }
        
        // Disable Go Live button when someone is streaming
        document.getElementById('goLiveBtn').classList.add('disabled');
      } else {
        currentStream = null;
        streamStartTime = null;
        streamEndTime = null;
        statusDot.classList.add('offline');
        statusDot.classList.remove('live');
        statusText.textContent = 'No one streaming';
        offlineState.classList.remove('hidden');
        videoPreview.classList.add('hidden');
        audioPreview.classList.add('hidden');
        timeRemaining.classList.add('hidden');
        myControls.classList.add('hidden');
        takeoverRequest.classList.add('hidden');
        noStreamTakeover.classList.remove('hidden');
        
        document.getElementById('currentDjName').textContent = '-';
        document.getElementById('currentStreamTitle').textContent = 'No stream';
        document.getElementById('currentDjAvatar').src = '/logo.webp';
        
        // Disable end stream button - no active stream
        updateEndStreamButton(false, false);
        
        // Enable Go Live button when no one is streaming
        document.getElementById('goLiveBtn').classList.remove('disabled');
      }
    } catch (e) {
      console.error('Stream status error:', e);
    }
  }
  
  function updateTimeRemaining() {
    const timeLeft = document.getElementById('timeLeft');
    
    if (!streamEndTime) {
      timeLeft.textContent = '--:--';
      return;
    }
    
    const now = new Date();
    const diff = streamEndTime - now;
    
    if (diff <= 0) {
      timeLeft.textContent = '00:00';
      timeLeft.style.color = '#dc2626';
      return;
    }
    
    const mins = Math.floor(diff / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    timeLeft.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    
    if (mins < 5) {
      timeLeft.style.color = '#dc2626';
    } else {
      timeLeft.style.color = '#fff';
    }
  }
  
  async function loadMySlot() {
    try {
      const now = new Date();
      const end = new Date(now.getTime() + 24 * 60 * 60 * 1000);
      
      const response = await fetch(`/api/livestream/slots?start=${now.toISOString()}&end=${end.toISOString()}&djId=${currentUser.uid}`);
      const result = await response.json();
      
      if (result.success && result.slots && result.slots.length > 0) {
        mySlot = result.slots[0];
        checkStreamKeyAvailability();
      } else {
        mySlot = null;
        showKeyNotAvailable();
      }
    } catch (e) {
      console.error('Load slot error:', e);
    }
  }
  
  function checkStreamKeyAvailability() {
    const keyStatus = document.getElementById('keyStatus');
    const keyNotAvailable = document.getElementById('keyNotAvailable');
    const keyAvailable = document.getElementById('keyAvailable');
    
    if (!mySlot) {
      keyStatus.textContent = 'No slot';
      keyStatus.className = 'key-status locked';
      showKeyNotAvailable();
      return;
    }
    
    const now = new Date();
    const slotStart = new Date(mySlot.startTime);
    const slotEnd = new Date(mySlot.endTime);
    const unlockTime = new Date(slotStart.getTime() - 15 * 60 * 1000);
    
    document.getElementById('nextSlotInfo').textContent = 
      `Your next slot: ${slotStart.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })} - ${slotEnd.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
    
    if (now >= unlockTime) {
      keyStatus.textContent = 'Available';
      keyStatus.className = 'key-status unlocked';
      keyNotAvailable.classList.add('hidden');
      keyAvailable.classList.remove('hidden');
      
      document.getElementById('slotTimeDisplay').textContent = 
        `Your slot: ${slotStart.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })} - ${slotEnd.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
      
      const minsUntil = Math.ceil((slotStart - now) / 60000);
      if (minsUntil > 0) {
        document.getElementById('countdownToSlot').textContent = `Starts in ${minsUntil} minutes`;
      } else {
        document.getElementById('countdownToSlot').textContent = `Your slot is NOW!`;
      }
      
      document.getElementById('myStreamKey').textContent = mySlot.streamKey || 'Loading...';
      
      if (!mySlot.streamKey) {
        fetchStreamKey();
      }
    } else {
      keyStatus.textContent = 'Locked';
      keyStatus.className = 'key-status locked';
      showKeyNotAvailable();
      
      const minsUntilUnlock = Math.ceil((unlockTime - now) / 60000);
      document.getElementById('nextSlotInfo').innerHTML = 
        `Your next slot: ${slotStart.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}<br>
         <span style="color: #dc2626;">Key unlocks in ${minsUntilUnlock} minutes</span>`;
    }
  }
  
  function showKeyNotAvailable() {
    document.getElementById('keyNotAvailable').classList.remove('hidden');
    document.getElementById('keyAvailable').classList.add('hidden');
  }
  
  async function fetchStreamKey() {
    try {
      const token = await currentUser.getIdToken();
      const response = await fetch('/api/livestream/slots', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ action: 'getStreamKey', slotId: mySlot.id, djId: currentUser.uid })
      });
      
      const result = await response.json();
      if (result.success && result.streamKey) {
        document.getElementById('myStreamKey').textContent = result.streamKey;
        mySlot.streamKey = result.streamKey;
      }
    } catch (e) {
      console.error('Fetch key error:', e);
    }
  }
  
  function subscribeToTakeover() {
    onSnapshot(doc(db, 'djTakeoverRequests', currentUser.uid), (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.data();
        if (data.status === 'pending' && data.targetDjId === currentUser.uid) {
          showIncomingTakeover(data);
        } else {
          hideIncomingTakeover();
        }
      } else {
        hideIncomingTakeover();
      }
    });
    
    onSnapshot(doc(db, 'djTakeoverRequests', `request_${currentUser.uid}`), (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.data();
        if (data.status === 'approved') {
          clearTakeoverTimeout();
          showTakeoverApproved(data);
        } else if (data.status === 'declined') {
          clearTakeoverTimeout();
          alert('Your takeover request was declined.');
          document.getElementById('takeoverPending').classList.add('hidden');
          
          // Check if more attempts available
          if (takeoverAttempts < MAX_TAKEOVER_ATTEMPTS) {
            document.getElementById('requestTakeoverBtn').classList.remove('hidden');
          }
          updateTakeoverAttemptsUI();
        }
      }
    });
  }
  
  function showIncomingTakeover(data) {
    const div = document.getElementById('incomingTakeover');
    document.getElementById('incomingDjName').textContent = data.requesterName || 'A DJ';
    document.getElementById('incomingDjAvatar').src = data.requesterAvatar || '/logo.webp';
    div.classList.remove('hidden');
    div.dataset.requesterId = data.requesterId;
  }
  
  function hideIncomingTakeover() {
    document.getElementById('incomingTakeover').classList.add('hidden');
  }
  
  function showTakeoverApproved(data) {
    const div = document.getElementById('takeoverApproved');
    document.getElementById('takeoverServerUrl').textContent = data.serverUrl || 'rtmp://stream.freshwax.co.uk/live';
    document.getElementById('takeoverStreamKey').textContent = data.streamKey || '-';
    div.classList.remove('hidden');
    document.getElementById('takeoverRequest').classList.add('hidden');
    document.getElementById('noStreamTakeover').classList.add('hidden');
  }
  
  function subscribeToChat() {
    onSnapshot(query(collection(db, 'djLobbyChat'), orderBy('createdAt', 'desc'), limit(50)), (snapshot) => {
      const messages = [];
      snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
      messages.reverse();
      renderMessages(messages);
    });
  }
  
  function renderMessages(messages) {
    const container = document.getElementById('chatMessages');
    
    if (messages.length === 0) {
      container.innerHTML = `
        <div class="chat-welcome">
          <p>Welcome to the DJ Lobby! üëã</p>
          <p class="hint">Chat with other DJs, coordinate sets, and hang out.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = messages.map(msg => {
      const time = msg.createdAt?.toDate ? 
        msg.createdAt.toDate().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
      const avatarLetter = msg.name ? msg.name.charAt(0).toUpperCase() : 'D';
      const hasAvatar = msg.avatar && msg.avatar !== '/logo.webp';
      
      return `
        <div class="chat-message">
          ${hasAvatar 
            ? `<img src="${msg.avatar}" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="chat-avatar-letter" style="display:none;">${avatarLetter}</span>`
            : `<span class="chat-avatar-letter">${avatarLetter}</span>`
          }
          <div class="chat-message-content">
            <div class="chat-message-header">
              <span class="chat-message-name">${escapeHtml(msg.name || 'DJ')}</span>
              <span class="chat-message-time">${time}</span>
            </div>
            <div class="chat-message-text">${escapeHtml(msg.text)}</div>
          </div>
        </div>
      `;
    }).join('');
    
    container.scrollTop = container.scrollHeight;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // ============================================
  // DM SYSTEM
  // ============================================
  
  function getDmChannelId(uid1, uid2) {
    // Create consistent channel ID regardless of who initiates
    return [uid1, uid2].sort().join('_');
  }
  
  function openDmModal() {
    document.getElementById('dmModal').classList.remove('hidden');
    document.getElementById('dmSelectView').classList.remove('hidden');
    document.getElementById('dmChatView').classList.add('hidden');
    populateDmDjList();
  }
  
  function closeDmModal() {
    document.getElementById('dmModal').classList.add('hidden');
    
    // Clean up DM messages from Firestore
    if (dmTargetDj && currentUser) {
      cleanupDmMessages();
    }
    
    // Unsubscribe from DM listener
    if (dmUnsubscribe) {
      dmUnsubscribe();
      dmUnsubscribe = null;
    }
    
    // Reset state
    dmTargetDj = null;
    dmMessages = [];
    document.getElementById('dmMessages').innerHTML = `
      <div class="dm-welcome">
        <p>Start a private conversation</p>
        <p class="hint">Only you and this DJ can see these messages.</p>
      </div>
    `;
  }
  
  function populateDmDjList() {
    const list = document.getElementById('dmDjList');
    const otherDjs = onlineDjsCache.filter(dj => dj.odamiMa !== currentUser?.uid);
    
    if (otherDjs.length === 0) {
      list.innerHTML = '<p class="empty-state">No other DJs online</p>';
      return;
    }
    
    list.innerHTML = otherDjs.map(dj => {
      const avatarLetter = dj.avatarLetter || (dj.name ? dj.name.charAt(0).toUpperCase() : 'D');
      const hasAvatar = dj.avatar && dj.avatar !== '/logo.webp';
      const isLive = currentStream && currentStream.djId === dj.odamiMa;
      
      return `
        <div class="dm-dj-item" data-dj-id="${dj.odamiMa}" data-dj-name="${escapeHtml(dj.name || 'DJ')}" data-dj-avatar="${dj.avatar || ''}" data-dj-letter="${avatarLetter}">
          ${hasAvatar 
            ? `<img src="${dj.avatar}" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="dm-dj-avatar-letter" style="display:none;">${avatarLetter}</span>`
            : `<span class="dm-dj-avatar-letter">${avatarLetter}</span>`
          }
          <div class="dm-dj-info">
            <div class="dm-dj-name">${escapeHtml(dj.name || 'DJ')}</div>
            <div class="dm-dj-status">${isLive ? 'üî¥ Live now' : 'Online'}</div>
          </div>
        </div>
      `;
    }).join('');
    
    // Add click handlers
    list.querySelectorAll('.dm-dj-item').forEach(item => {
      item.addEventListener('click', () => {
        const djId = item.dataset.djId;
        const djName = item.dataset.djName;
        const djAvatar = item.dataset.djAvatar;
        const djLetter = item.dataset.djLetter;
        selectDmTarget(djId, djName, djAvatar, djLetter);
      });
    });
  }
  
  function selectDmTarget(djId, djName, djAvatar, djLetter) {
    dmTargetDj = { id: djId, name: djName, avatar: djAvatar, letter: djLetter };
    
    // Switch to chat view
    document.getElementById('dmSelectView').classList.add('hidden');
    document.getElementById('dmChatView').classList.remove('hidden');
    document.getElementById('dmChatWithName').textContent = djName;
    
    // Clear messages
    dmMessages = [];
    renderDmMessages();
    
    // Subscribe to DM channel
    subscribeToDmChannel();
  }
  
  function goBackToDmList() {
    // Clean up current DM
    if (dmTargetDj && currentUser) {
      cleanupDmMessages();
    }
    
    if (dmUnsubscribe) {
      dmUnsubscribe();
      dmUnsubscribe = null;
    }
    
    dmTargetDj = null;
    dmMessages = [];
    
    // Switch to selection view
    document.getElementById('dmChatView').classList.add('hidden');
    document.getElementById('dmSelectView').classList.remove('hidden');
    populateDmDjList();
  }
  
  function subscribeToDmChannel() {
    if (!dmTargetDj || !currentUser) return;
    
    const channelId = getDmChannelId(currentUser.uid, dmTargetDj.id);
    
    dmUnsubscribe = onSnapshot(
      query(collection(db, 'djDirectMessages', channelId, 'messages'), orderBy('createdAt', 'asc')),
      (snapshot) => {
        dmMessages = [];
        snapshot.forEach(doc => {
          dmMessages.push({ id: doc.id, ...doc.data() });
        });
        renderDmMessages();
      }
    );
  }
  
  function renderDmMessages() {
    const container = document.getElementById('dmMessages');
    
    if (dmMessages.length === 0) {
      container.innerHTML = `
        <div class="dm-welcome">
          <p>Start a private conversation</p>
          <p class="hint">Only you and this DJ can see these messages.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = dmMessages.map(msg => {
      const isSent = msg.senderId === currentUser?.uid;
      const time = msg.createdAt?.toDate ? 
        msg.createdAt.toDate().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
      
      return `
        <div class="dm-message ${isSent ? 'sent' : ''}">
          <div class="dm-message-content">
            <div class="dm-message-name">${isSent ? 'You' : escapeHtml(msg.senderName || 'DJ')}</div>
            <div class="dm-message-text">${escapeHtml(msg.text)}</div>
            <div class="dm-message-time">${time}</div>
          </div>
        </div>
      `;
    }).join('');
    
    container.scrollTop = container.scrollHeight;
  }
  
  async function sendDmMessage() {
    const input = document.getElementById('dmInput');
    const text = input.value.trim();
    if (!text || !currentUser || !userInfo || !dmTargetDj) return;
    
    input.value = '';
    
    try {
      const channelId = getDmChannelId(currentUser.uid, dmTargetDj.id);
      
      await addDoc(collection(db, 'djDirectMessages', channelId, 'messages'), {
        senderId: currentUser.uid,
        senderName: userInfo.name,
        receiverId: dmTargetDj.id,
        receiverName: dmTargetDj.name,
        text: text,
        createdAt: serverTimestamp()
      });
      
      // Also update the channel doc for notification tracking
      await setDoc(doc(db, 'djDirectMessages', channelId), {
        participants: [currentUser.uid, dmTargetDj.id],
        lastMessage: text,
        lastSenderId: currentUser.uid,
        lastSenderName: userInfo.name,
        updatedAt: serverTimestamp()
      }, { merge: true });
      
    } catch (e) {
      console.error('DM send error:', e);
      input.value = text;
    }
  }
  
  async function cleanupDmMessages() {
    if (!dmTargetDj || !currentUser) return;
    
    try {
      const channelId = getDmChannelId(currentUser.uid, dmTargetDj.id);
      
      // Delete all messages in the channel
      const messagesRef = collection(db, 'djDirectMessages', channelId, 'messages');
      const snapshot = await getDocs(messagesRef);
      
      const deletePromises = [];
      snapshot.forEach(document => {
        deletePromises.push(deleteDoc(doc(db, 'djDirectMessages', channelId, 'messages', document.id)));
      });
      
      await Promise.all(deletePromises);
      
      // Delete channel doc
      await deleteDoc(doc(db, 'djDirectMessages', channelId));
      
    } catch (e) {
      console.error('DM cleanup error:', e);
    }
  }
  
  function subscribeToIncomingDms() {
    // Listen for DM channels where we're a participant
    onSnapshot(collection(db, 'djDirectMessages'), (snapshot) => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'modified' || change.type === 'added') {
          const data = change.doc.data();
          
          // Check if this is a new message for us (not from us)
          if (data.participants?.includes(currentUser?.uid) && 
              data.lastSenderId !== currentUser?.uid) {
            
            // Check if DM modal is open and we're chatting with this person
            const dmModalVisible = !document.getElementById('dmModal').classList.contains('hidden');
            const chattingWithSender = dmTargetDj?.id === data.lastSenderId;
            
            // Show notification if modal is closed or chatting with someone else
            if (!dmModalVisible || !chattingWithSender) {
              showDmNotification(data.lastSenderId, data.lastSenderName, data.lastMessage);
            }
          }
        }
      });
    });
  }
  
  function showDmNotification(senderId, senderName, message) {
    const notif = document.getElementById('dmNotification');
    const text = document.getElementById('dmNotifText');
    
    text.textContent = `New DM from ${senderName}`;
    notif.dataset.senderId = senderId;
    notif.dataset.senderName = senderName;
    notif.classList.remove('hidden');
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      notif.classList.add('hidden');
    }, 10000);
  }
  
  function openDmFromNotification() {
    const notif = document.getElementById('dmNotification');
    const senderId = notif.dataset.senderId;
    const senderName = notif.dataset.senderName;
    
    notif.classList.add('hidden');
    
    // Find the sender in online DJs cache
    const senderDj = onlineDjsCache.find(dj => dj.odamiMa === senderId);
    if (senderDj) {
      openDmModal();
      const avatarLetter = senderDj.avatarLetter || (senderDj.name ? senderDj.name.charAt(0).toUpperCase() : 'D');
      selectDmTarget(senderId, senderDj.name || senderName, senderDj.avatar || '', avatarLetter);
    } else {
      // DJ went offline, just open modal
      openDmModal();
    }
  }

  async function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !currentUser || !userInfo) return;
    
    input.value = '';
    
    try {
      await addDoc(collection(db, 'djLobbyChat'), {
        odamiMa: currentUser.uid,
        name: userInfo.name,
        avatar: userInfo.avatar,
        text: text,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      console.error('Send error:', e);
      input.value = text;
    }
  }
  
  function updateEndStreamButton(isLive, isMyStream) {
    const btn = document.getElementById('lobbyEndStreamBtn');
    const status = document.getElementById('endStreamStatus');
    const canEnd = isMyStream || userInfo?.isAdmin;
    
    if (isLive && canEnd) {
      btn.classList.remove('disabled');
      btn.disabled = false;
      btn.innerHTML = '<span class="end-icon">‚èπ</span><span class="end-text">End Stream</span>';
      if (isMyStream) {
        status.textContent = 'You are currently live';
        status.classList.add('live');
      } else {
        status.textContent = `Admin: End ${currentStream?.djName || 'DJ'}'s stream`;
        status.classList.add('live');
      }
    } else if (isLive) {
      btn.classList.add('disabled');
      btn.disabled = true;
      btn.innerHTML = '<span class="end-icon">‚èπ</span><span class="end-text">End Stream</span>';
      status.textContent = `${currentStream?.djName || 'Another DJ'} is streaming`;
      status.classList.remove('live');
    } else {
      btn.classList.add('disabled');
      btn.disabled = true;
      btn.innerHTML = '<span class="end-icon">‚èπ</span><span class="end-text">End Stream</span>';
      status.textContent = 'No active stream';
      status.classList.remove('live');
    }
  }
  
  function updateTakeoverAttemptsUI() {
    const attemptsLeft = MAX_TAKEOVER_ATTEMPTS - takeoverAttempts;
    const attemptsEl = document.getElementById('takeoverAttemptsLeft');
    const limitEl = document.getElementById('takeoverLimitReached');
    const btn = document.getElementById('requestTakeoverBtn');
    
    if (attemptsLeft <= 0) {
      attemptsEl.classList.add('hidden');
      limitEl.classList.remove('hidden');
      btn.classList.add('disabled');
      btn.disabled = true;
    } else {
      attemptsEl.classList.remove('hidden');
      limitEl.classList.add('hidden');
      attemptsEl.textContent = `${attemptsLeft} request${attemptsLeft !== 1 ? 's' : ''} remaining this session`;
      if (!takeoverPending) {
        btn.classList.remove('disabled');
        btn.disabled = false;
      }
    }
  }
  
  function clearTakeoverTimeout() {
    if (takeoverTimeout) {
      clearInterval(takeoverTimeout);
      takeoverTimeout = null;
    }
    takeoverPending = false;
  }
  
  function setupEventListeners() {
    // DM Modal
    document.getElementById('openDmBtn').addEventListener('click', openDmModal);
    document.getElementById('closeDmBtn').addEventListener('click', closeDmModal);
    document.querySelector('.dm-modal-overlay').addEventListener('click', closeDmModal);
    document.getElementById('dmBackBtn').addEventListener('click', goBackToDmList);
    
    document.getElementById('dmSendBtn').addEventListener('click', sendDmMessage);
    document.getElementById('dmInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendDmMessage();
    });
    
    // DM Notification
    document.getElementById('dmNotifOpenBtn').addEventListener('click', openDmFromNotification);
    document.getElementById('dmNotifDismissBtn').addEventListener('click', () => {
      document.getElementById('dmNotification').classList.add('hidden');
    });
    
    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try {
        if (presenceRef) {
          await deleteDoc(presenceRef);
        }
        await signOut(auth);
        window.location.href = '/live';
      } catch (e) {
        console.error('Sign out error:', e);
        window.location.href = '/live';
      }
    });
    
    // Lobby End Stream button
    document.getElementById('lobbyEndStreamBtn').addEventListener('click', async () => {
      const btn = document.getElementById('lobbyEndStreamBtn');
      if (btn.classList.contains('disabled')) return;
      
      if (!confirm('Are you sure you want to end your stream?')) return;
      
      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="end-icon">‚è≥</span><span class="end-text">Ending...</span>';
        
        // Use current stream's DJ ID (for admin ending someone else's stream)
        const targetDjId = currentStream?.djId || currentUser.uid;
        
        const token = await currentUser.getIdToken();
        const response = await fetch('/api/livestream/slots', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            action: 'endStream',
            djId: targetDjId,
            isAdmin: userInfo?.isAdmin || false
          })
        });
        
        const result = await response.json();
        if (result.success) {
          updateEndStreamButton(false, false);
          await recordStreamEnd(); // Record when stream ended for chat cleanup
          await loadStreamStatus();
        } else {
          alert('Failed to end stream: ' + (result.error || 'Unknown error'));
          btn.innerHTML = '<span class="end-icon">‚èπ</span><span class="end-text">End Stream</span>';
          btn.disabled = false;
        }
      } catch (e) {
        console.error('End stream error:', e);
        alert('Failed to end stream');
        btn.innerHTML = '<span class="end-icon">‚èπ</span><span class="end-text">End Stream</span>';
        btn.disabled = false;
      }
    });
    
    // Chat
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Play/Pause
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      const audio = document.getElementById('audioElement');
      const playIcon = document.getElementById('playIcon');
      const pauseIcon = document.getElementById('pauseIcon');
      
      if (!audio.src && currentStream?.streamUrl) {
        audio.src = currentStream.streamUrl;
        audio.play();
      } else if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
      
      playIcon.classList.toggle('hidden', !audio.paused);
      pauseIcon.classList.toggle('hidden', audio.paused);
    });
    
    // Volume
    document.getElementById('volumeSlider').addEventListener('input', (e) => {
      document.getElementById('audioElement').volume = e.target.value / 100;
    });
    
    document.getElementById('muteBtn').addEventListener('click', () => {
      const audio = document.getElementById('audioElement');
      audio.muted = !audio.muted;
      document.getElementById('volumeSlider').value = audio.muted ? 0 : audio.volume * 100;
    });
    
    // Ready button
    document.getElementById('setReadyBtn')?.addEventListener('click', async () => {
      try {
        await setDoc(presenceRef, { isReady: true }, { merge: true });
        document.getElementById('setReadyBtn').classList.add('is-ready');
        document.getElementById('readyBtnText').textContent = '‚úì Ready!';
        document.getElementById('readyStatus').classList.remove('hidden');
      } catch (e) {
        console.error('Ready error:', e);
      }
    });
    
    // Takeover
    document.getElementById('requestTakeoverBtn')?.addEventListener('click', async () => {
      if (!currentStream || !currentUser) return;
      if (takeoverPending) return;
      
      // Check if limit reached
      if (takeoverAttempts >= MAX_TAKEOVER_ATTEMPTS) {
        return;
      }
      
      try {
        // Increment attempts
        takeoverAttempts++;
        takeoverPending = true;
        updateTakeoverAttemptsUI();
        
        await setDoc(doc(db, 'djTakeoverRequests', currentStream.djId), {
          requesterId: currentUser.uid,
          requesterName: userInfo.name,
          requesterAvatar: userInfo.avatar,
          targetDjId: currentStream.djId,
          targetDjName: currentStream.djName,
          status: 'pending',
          createdAt: serverTimestamp()
        });
        
        await setDoc(doc(db, 'djTakeoverRequests', `request_${currentUser.uid}`), {
          requesterId: currentUser.uid,
          targetDjId: currentStream.djId,
          status: 'pending',
          createdAt: serverTimestamp()
        });
        
        document.getElementById('requestTakeoverBtn').classList.add('hidden');
        document.getElementById('takeoverPending').classList.remove('hidden');
        
        // Start 20-second timeout countdown
        let countdown = 20;
        const countdownEl = document.getElementById('takeoverCountdown');
        countdownEl.textContent = `(${countdown}s)`;
        
        takeoverTimeout = setInterval(() => {
          countdown--;
          countdownEl.textContent = `(${countdown}s)`;
          
          if (countdown <= 0) {
            clearInterval(takeoverTimeout);
            takeoverTimeout = null;
            takeoverPending = false;
            
            // Reset UI - timeout expired
            document.getElementById('takeoverPending').classList.add('hidden');
            
            // Check if more attempts available
            if (takeoverAttempts < MAX_TAKEOVER_ATTEMPTS) {
              document.getElementById('requestTakeoverBtn').classList.remove('hidden');
              document.getElementById('requestTakeoverBtn').classList.remove('disabled');
            }
            
            updateTakeoverAttemptsUI();
            
            // Clean up the pending request
            deleteDoc(doc(db, 'djTakeoverRequests', currentStream.djId)).catch(() => {});
            deleteDoc(doc(db, 'djTakeoverRequests', `request_${currentUser.uid}`)).catch(() => {});
          }
        }, 1000);
        
      } catch (e) {
        console.error('Takeover error:', e);
        alert('Failed to send takeover request');
        takeoverPending = false;
      }
    });
    
    document.getElementById('acceptTakeoverBtn')?.addEventListener('click', async () => {
      const div = document.getElementById('incomingTakeover');
      const requesterId = div.dataset.requesterId;
      if (!requesterId || !currentUser) return;
      
      try {
        const token = await currentUser.getIdToken();
        const response = await fetch('/api/livestream/slots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ action: 'getStreamKey', djId: currentUser.uid })
        });
        
        const result = await response.json();
        
        await setDoc(doc(db, 'djTakeoverRequests', `request_${requesterId}`), {
          status: 'approved',
          requesterId: requesterId,
          serverUrl: result.serverUrl || 'rtmp://stream.freshwax.co.uk/live',
          streamKey: result.streamKey || 'Contact admin',
          approvedAt: serverTimestamp()
        }, { merge: true });
        
        await deleteDoc(doc(db, 'djTakeoverRequests', currentUser.uid));
        hideIncomingTakeover();
        alert('Takeover approved!');
      } catch (e) {
        console.error('Accept error:', e);
      }
    });
    
    document.getElementById('declineTakeoverBtn')?.addEventListener('click', async () => {
      const div = document.getElementById('incomingTakeover');
      const requesterId = div.dataset.requesterId;
      if (!requesterId) return;
      
      try {
        await setDoc(doc(db, 'djTakeoverRequests', `request_${requesterId}`), {
          status: 'declined',
          declinedAt: serverTimestamp()
        }, { merge: true });
        
        await deleteDoc(doc(db, 'djTakeoverRequests', currentUser.uid));
        hideIncomingTakeover();
      } catch (e) {
        console.error('Decline error:', e);
      }
    });
    
    // End stream
    document.getElementById('endStreamBtn')?.addEventListener('click', async () => {
      if (!confirm('End your stream?')) return;
      
      try {
        const token = await currentUser.getIdToken();
        const response = await fetch('/api/livestream/slots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ action: 'endStream', djId: currentUser.uid })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('Stream ended');
          loadStreamStatus();
        } else {
          alert(result.error || 'Failed');
        }
      } catch (e) {
        console.error('End error:', e);
      }
    });
    
    // Copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const code = document.getElementById(btn.dataset.copy);
        if (code) {
          navigator.clipboard.writeText(code.textContent);
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
        }
      });
    });
  }
</script>
</body>
</html>
