---
// src/pages/account/dashboard.astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import '../../styles/dashboard.css';

export const prerender = false;
---

<Layout title="My Account" noindex={true}>
  <Header />
  
  <main class="dashboard-main">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="spinner"></div>
      <p>Loading your account...</p>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="mainContent" class="hidden">
      
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <div class="dashboard-header-left">
          <div class="user-avatar" id="userAvatar">
            <span id="avatarInitial">C</span>
          </div>
          <div>
            <h1 id="welcomeName">Welcome back</h1>
            <p class="user-email" id="userEmail">Loading...</p>
          </div>
        </div>
        <div class="dashboard-header-right">
          <a href="#" id="goPlusHeaderBtn" class="pro-dashboard-btn" style="background: #374151;" title="Upgrade to Plus">
            <span class="pro-icon">üëë</span>
            <span class="pro-text">Go Plus</span>
          </a>
          <a href="/artist/dashboard" id="proDashboardBtn" class="pro-dashboard-btn disabled" title="Available for approved partners">
            <span class="pro-icon">‚ö°</span>
            <span class="pro-text">Pro Dashboard</span>
          </a>
          <button id="logoutBtn" class="logout-btn">Sign Out</button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="orders">Orders <span class="badge" id="ordersBadge" style="display: none;">0</span></button>
        <button class="tab-btn" data-tab="downloads">Downloads</button>
        <button class="tab-btn" data-tab="credit">Credit <span class="credit-badge" id="creditBadge" style="display: none;">¬£0</span></button>
        <button class="tab-btn" data-tab="wishlist">Wishlist <span class="badge" id="wishlistBadge" style="display: none;">0</span></button>
        <button class="tab-btn" data-tab="following">Following <span class="badge" id="followingBadge" style="display: none;">0</span></button>
        <button class="tab-btn" data-tab="mixes">DJ Mixes</button>
        <button class="tab-btn" data-tab="profile">Profile</button>
      </div>

      <!-- Tab Content -->
      <div class="tab-panels">
        
        <!-- Overview Tab -->
        <div class="tab-panel active" id="panel-overview">
          <div class="stats-grid-full">
            <div class="stat-card">
              <div class="stat-value" id="statOrders">0</div>
              <div class="stat-label">Orders</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statVinyl">0</div>
              <div class="stat-label">Vinyl</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statDigitalEPs">0</div>
              <div class="stat-label">Digital</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statTracks">0</div>
              <div class="stat-label">Tracks</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statMerch">0</div>
              <div class="stat-label">Merch</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statSpent">¬£0</div>
              <div class="stat-label">Spent</div>
            </div>
          </div>

          <!-- Subscription Status Card -->
          <div class="subscription-card" id="subscriptionCard">
            <div class="subscription-header">
              <div class="subscription-tier" id="subscriptionTier">
                <span class="tier-badge free">Standard</span>
                <span class="tier-name">Account</span>
              </div>
              <div class="subscription-status" id="subscriptionStatus"></div>
            </div>

            <div class="subscription-usage" id="subscriptionUsage">
              <div class="usage-item">
                <span class="usage-label">DJ Mix Uploads</span>
                <span class="usage-value"><span id="mixUploadsUsed">0</span> / <span id="mixUploadsLimit">1</span> this week</span>
              </div>
              <div class="usage-item">
                <span class="usage-label">Live Streaming</span>
                <span class="usage-value"><span id="streamTimeUsed">0</span> / <span id="streamTimeLimit">1</span> hours today</span>
              </div>
            </div>

            <!-- Upgrade section removed - now in Go Plus modal -->

            <div class="subscription-pro hidden collapsed" id="subscriptionPro">
              <div class="pro-header" id="proHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
                <div class="pro-active">
                  <span class="pro-icon-large">‚ö°</span>
                  <span class="pro-message">You're a Plus member!</span>
                </div>
                <button class="pro-toggle-btn" id="proToggleBtn" style="background: none; border: none; color: #a3a3a3; font-size: 1.2rem; cursor: pointer; padding: 5px;">‚ñº</button>
              </div>
              <div class="pro-details" id="proDetails" style="display: none;">
                <p class="pro-expires" id="proExpires"></p>

                <!-- Referral Code Section -->
                <div class="referral-section" id="referralSection">
                <div class="referral-header">
                  <span class="referral-icon">üéÅ</span>
                  <span class="referral-title">Invite a Friend - 50% Off!</span>
                </div>
                <p class="referral-desc">Share your code with a friend and they'll get 50% off Plus (just ¬£5 instead of ¬£10)!</p>
                <div class="referral-code-box">
                  <code id="referralCodeDisplay" class="referral-code">Loading...</code>
                  <button class="copy-referral-btn" id="copyReferralBtn" title="Copy code">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                  </button>
                </div>
                <p class="referral-note" id="referralNote">One-time use code. Expires in 1 year.</p>
                <p class="referral-used hidden" id="referralUsed">‚úì Your referral code has been used!</p>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <h2>Recent Orders</h2>
              <button class="view-all-btn" data-tab="orders">View All ‚Üí</button>
            </div>
            <div id="recentOrdersList" class="orders-list">
              <div class="empty-state">
                <p style="color: #fff; margin: 0 0 1.5rem 0;">No orders yet</p>
                <a href="/" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Start Shopping</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-panel" id="panel-orders">
          <h2>My Orders</h2>
          <div id="ordersContainer" class="orders-list">
            <div class="empty-state">
              <p>Loading orders...</p>
            </div>
          </div>
        </div>

        <!-- Downloads Tab -->
        <div class="tab-panel" id="panel-downloads">
          <h2>My Downloads</h2>
          <div id="downloadsContainer" class="downloads-list">
            <div class="empty-state">
              <p>Loading downloads...</p>
            </div>
          </div>
        </div>

        <!-- Credit Tab -->
        <div class="tab-panel" id="panel-credit">
          <h2>Store Credit</h2>
          
          <!-- Balance Display -->
          <div class="credit-balance-card">
            <div class="balance-icon">üí≥</div>
            <div class="balance-info">
              <span class="balance-label">Available Balance</span>
              <span class="balance-amount" id="creditBalanceDisplay">¬£0.00</span>
            </div>
            <p class="balance-hint">Use your credit at checkout - it's automatically available!</p>
          </div>
          
          <!-- Redeem Gift Card -->
          <div class="redeem-section">
            <h3>Redeem Gift Card</h3>
            <p class="redeem-desc">Enter your gift card code to add credit to your account</p>
            
            <form id="dashboardRedeemForm" class="redeem-form">
              <div class="code-input-group">
                <input 
                  type="text" 
                  id="dashboardGiftCode" 
                  placeholder="FWGC-XXXX-XXXX-XXXX" 
                  maxlength="19"
                  autocomplete="off"
                  spellcheck="false"
                />
                <button type="submit" id="dashboardRedeemBtn" class="redeem-btn">
                  <span class="btn-text">Redeem</span>
                  <span class="btn-loading hidden">
                    <svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" /></svg>
                  </span>
                </button>
              </div>
              <p id="dashboardRedeemError" class="redeem-error"></p>
              <p id="dashboardRedeemSuccess" class="redeem-success"></p>
            </form>
          </div>
          
          <!-- Transaction History -->
          <div class="transactions-section">
            <h3>Transaction History</h3>
            <div id="transactionsList" class="transactions-list">
              <div class="empty-state">
                <p style="color: #9ca3af;">No transactions yet</p>
              </div>
            </div>
          </div>
          
          <!-- Get More Credit -->
          <div class="get-credit-cta">
            <a href="/giftcards" class="cta-link">
              <span class="cta-icon">üéÅ</span>
              <span>Learn more about Gift Cards ‚Üí</span>
            </a>
          </div>
        </div>

        <!-- Wishlist Tab -->
        <div class="tab-panel" id="panel-wishlist">
          <div class="section-header-flex">
            <h2>My Wishlist</h2>
            <a href="/releases" class="btn-secondary-sm">Browse Releases ‚Üí</a>
          </div>
          <p class="wishlist-intro" style="color: #9ca3af; margin-bottom: 1.5rem; font-size: 0.875rem;">
            Releases you've saved for later. Click the bookmark icon on any release to add it here.
          </p>
          <div id="wishlistContainer" class="wishlist-grid">
            <div class="empty-state">
              <p style="color: #fff; margin: 0 0 1.5rem 0; font-size: 0.875rem;">Your wishlist is empty</p>
              <a href="/releases" style="display: inline-block; padding: 0.7rem 1.4rem; background: #dc2626; color: #fff; font-weight: 600; font-size: 0.8rem; border-radius: 6px; text-decoration: none;">Browse Releases</a>
            </div>
          </div>
        </div>

        <!-- Following Tab -->
        <div class="tab-panel" id="panel-following">
          <div class="section-header-flex">
            <h2>Artists I Follow</h2>
            <a href="/releases" class="btn-secondary-sm">Discover Artists ‚Üí</a>
          </div>
          <p class="following-intro" style="color: #9ca3af; margin-bottom: 1.5rem; font-size: 0.9375rem;">
            Stay updated with new releases from your favourite artists. Click the Follow button on any release to add artists here.
          </p>
          <div id="followingContainer" class="following-grid">
            <div class="empty-state">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">You're not following any artists yet</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          </div>
        </div>

        <!-- DJ Mixes Tab -->
        <div class="tab-panel" id="panel-mixes">
          <div class="section-header-flex">
            <h2>My DJ Mixes</h2>
            <a href="/upload-mix" class="btn-primary-sm">+ Upload Mix</a>
          </div>
          <div class="mixes-stats" id="mixesStats">
            <div class="stat-mini"><span class="stat-value" id="statMixes">0</span><span class="stat-label">Mixes</span></div>
            <div class="stat-mini"><span class="stat-value" id="statMixPlays">0</span><span class="stat-label">Total Plays</span></div>
            <div class="stat-mini"><span class="stat-value" id="statMixLikes">0</span><span class="stat-label">Likes</span></div>
          </div>
          <div id="mixesContainer" class="mixes-list"><div class="empty-state"><p>Loading mixes...</p></div></div>
        </div>

        <!-- Profile Tab -->
        <div class="tab-panel" id="panel-profile">
          <h2>My Profile</h2>
          
          <!-- Avatar Upload Section -->
          <div class="avatar-upload-section">
            <div class="avatar-preview-large" id="avatarPreviewLarge">
              <span id="avatarInitialLarge">?</span>
              <img id="avatarImageLarge" src="" alt="Profile" class="hidden" />
            </div>
            <div class="avatar-upload-controls">
              <h3>Profile Picture</h3>
              <p class="avatar-hint">This image will appear next to your comments, in chat, and across the site.</p>
              <div class="avatar-buttons">
                <label for="avatarUpload" class="btn-upload">
                  <span>üì∑ Upload Image</span>
                  <input type="file" id="avatarUpload" accept="image/jpeg,image/png,image/webp" style="display: none;" />
                </label>
                <button type="button" id="removeAvatarBtn" class="btn-remove hidden">Remove</button>
              </div>
              <p class="avatar-specs">JPG, PNG or WebP. Max 2MB. Round images work best.</p>
              <div id="avatarUploadStatus" class="avatar-status"></div>
            </div>
          </div>
          
          <form id="profileForm" class="profile-form">
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" maxlength="30">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" maxlength="30">
              </div>
            </div>
            <div class="form-group">
              <label for="displayName">Display Name</label>
              <input type="text" id="displayName" name="displayName" placeholder="How you appear on the site" maxlength="15">
              <p class="field-hint">This is how you'll be known across <span class="brand-fresh">Fresh</span> <span class="brand-wax">Wax</span> (max 15 characters)</p>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" readonly>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" maxlength="20">
              </div>
            </div>
            
            <!-- Shipping Address Section -->
            <div class="address-section">
              <h3>Shipping Address</h3>
              <p class="address-hint">Save your address to speed up checkout</p>
              
              <!-- Postcode Lookup -->
              <div class="postcode-lookup">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                  <label for="postcodeSearch">Find Address by Postcode</label>
                  <div style="display: flex; gap: 0.75rem;">
                    <input type="text" id="postcodeSearch" placeholder="E1 6AN" style="max-width: 140px; text-transform: uppercase;">
                    <button type="button" id="lookupBtn" class="lookup-btn">Verify</button>
                  </div>
                  <div id="lookupError" class="lookup-error"></div>
                  <div id="lookupSuccess" class="lookup-success"></div>
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom: 0.5rem;">
                <label for="address1">Address Line 1</label>
                <input type="text" id="address1" name="address1" placeholder="Street address" maxlength="100">
              </div>
              <div class="form-group">
                <label for="address2">Address Line 2 (Optional)</label>
                <input type="text" id="address2" name="address2" placeholder="Flat, unit, building, etc." maxlength="100">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" maxlength="50">
                </div>
                <div class="form-group">
                  <label for="county">County</label>
                  <input type="text" id="county" name="county" maxlength="50">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="postcode">Postcode</label>
                  <input type="text" id="postcode" name="postcode" style="text-transform: uppercase;" maxlength="10">
                </div>
                <div class="form-group">
                  <label for="country">Country</label>
                  <select id="country" name="country">
                    <option value="United Kingdom" selected>United Kingdom</option>
                    <option value="Ireland">Ireland</option>
                    <option value="United States">United States</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Germany">Germany</option>
                    <option value="France">France</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Spain">Spain</option>
                    <option value="Italy">Italy</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Norway">Norway</option>
                    <option value="Denmark">Denmark</option>
                    <option value="Finland">Finland</option>
                    <option value="Austria">Austria</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Poland">Poland</option>
                    <option value="Czech Republic">Czech Republic</option>
                    <option value="Japan">Japan</option>
                    <option value="South Korea">South Korea</option>
                    <option value="Singapore">Singapore</option>
                    <option value="Hong Kong">Hong Kong</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>
            </div>
            
            <button type="submit" class="save-btn">Save Changes</button>
          </form>

          <!-- Selling & Payments Section (for vendors) -->
          <div class="selling-section hidden" id="sellingSection">
            <h3>Selling & Payments</h3>
            <p class="selling-hint">Manage how you receive payments for your sales on Fresh Wax.</p>
            <div class="selling-links">
              <a href="/account/payment-settings" class="selling-link">
                <span class="selling-icon">&#128179;</span>
                <div class="selling-info">
                  <strong>Payment Settings</strong>
                  <span>Set up Stripe or PayPal to receive payouts</span>
                </div>
                <span class="selling-arrow">&rarr;</span>
              </a>
              <a href="/account/selling" class="selling-link" id="vinylSellingLink" style="display:none;">
                <span class="selling-icon">&#128230;</span>
                <div class="selling-info">
                  <strong>Vinyl Selling</strong>
                  <span>Manage your vinyl crate listings</span>
                </div>
                <span class="selling-arrow">&rarr;</span>
              </a>
              <a href="/artist/dashboard" class="selling-link" id="artistDashboardLink" style="display:none;">
                <span class="selling-icon">&#9889;</span>
                <div class="selling-info">
                  <strong>Artist Dashboard</strong>
                  <span>Manage releases, merch and analytics</span>
                </div>
                <span class="selling-arrow">&rarr;</span>
              </a>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="danger-zone">
            <h3>Data & Account</h3>
            <div class="danger-zone-content">
              <!-- Download Data Section -->
              <div class="data-section">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <div>
                  <strong>Download Your Data</strong>
                  <p>Export your order history and download your audio and artwork files.</p>
                </div>
              </div>
              <button type="button" id="downloadDataBtn" class="download-data-btn">Download My Data</button>
              
              <div class="danger-divider"></div>
              
              <!-- Delete Account Section -->
              <div class="danger-warning">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                  <strong>Delete Account</strong>
                  <p>This will disable your account and you will be logged out. Your data will be retained for 30 days in case you change your mind. Contact support to restore your account or request permanent deletion.</p>
                </div>
              </div>
              <button type="button" id="deleteAccountBtn" class="delete-account-btn">Delete My Account</button>
            </div>
          </div>
        </div>

        <!-- Download Data Modal -->
        <div id="downloadDataModal" class="modal-overlay hidden">
          <div class="modal-content download-modal">
            <h2>Download Your Data</h2>
            <p class="modal-description">Select items to download:</p>
            
            <!-- Order History Section -->
            <div class="download-section">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                <span>Order History</span>
              </div>
              <label class="download-option">
                <input type="checkbox" id="downloadOrdersPdf" checked />
                <span class="option-check"></span>
                <div class="option-info">
                  <strong>Order History (PDF)</strong>
                  <span>Complete record of all your orders</span>
                </div>
              </label>
            </div>
            
            <!-- Music Purchases Section -->
            <div class="download-section">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18V5l12-2v13"/>
                  <circle cx="6" cy="18" r="3"/>
                  <circle cx="18" cy="16" r="3"/>
                </svg>
                <span>Music Purchases</span>
                <button type="button" class="toggle-all-btn" data-section="music">Deselect All</button>
              </div>
              <div id="musicDownloadsList" class="downloads-list-container">
                <div class="loading-placeholder">Loading your purchases...</div>
              </div>
            </div>
            
            <!-- DJ Mixes Section -->
            <div class="download-section" id="djMixesSection" style="display: none;">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Your DJ Mixes</span>
                <button type="button" class="toggle-all-btn" data-section="mixes">Deselect All</button>
              </div>
              <div id="mixesDownloadsList" class="downloads-list-container">
                <div class="loading-placeholder">Loading your mixes...</div>
              </div>
            </div>
            
            <div class="modal-buttons">
              <button type="button" id="cancelDownloadBtn" class="cancel-btn">Cancel</button>
              <button type="button" id="confirmDownloadBtn" class="confirm-download-btn">Download Selected</button>
            </div>
          </div>
        </div>

        <!-- Delete Account Modal -->
        <div id="deleteModal" class="modal-overlay hidden">
          <div class="modal-content">
            <div class="modal-header">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              <h3>Delete Account</h3>
            </div>
            <div class="modal-body">
              <p class="modal-warning">Are you sure you want to delete your account?</p>
              <ul class="modal-list">
                <li>Your account will be disabled immediately</li>
                <li>You will be logged out</li>
                <li>Your data is kept for 30 days for recovery</li>
                <li>Contact support to restore or permanently delete</li>
              </ul>
              <div class="confirm-delete">
                <label for="confirmDelete">Type <strong>delete</strong> to confirm:</label>
                <input type="text" id="confirmDeleteInput" placeholder="delete" autocomplete="off">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="cancelDeleteBtn" class="modal-btn cancel">Cancel</button>
              <button type="button" id="confirmDeleteBtn" class="modal-btn delete" disabled>Delete Account</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Go Plus Modal -->
    <div id="goPlusModal" class="goplus-modal hidden">
      <div class="goplus-modal-backdrop"></div>
      <div class="goplus-modal-content">
        <button class="goplus-modal-close" id="goPlusModalClose">&times;</button>
        <div class="goplus-modal-header">
          <svg class="goplus-modal-crown" viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
            <path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/>
          </svg>
          <h2>Go Plus</h2>
          <p class="goplus-price">¬£10<span>/year</span></p>
        </div>
        <div class="goplus-modal-body">
          <ul class="goplus-benefits">
            <li><span class="benefit-icon">‚úì</span> 5 DJ mix uploads per week (vs 2 standard)</li>
            <li><span class="benefit-icon">‚úì</span> Long duration events up to 24 hours</li>
            <li><span class="benefit-icon">‚úì</span> Book multiple slots for day-long events</li>
            <li><span class="benefit-icon">‚úì</span> Book slots up to 1 month in advance</li>
            <li><span class="benefit-icon">‚úì</span> 1,000 tracks in cloud playlist (syncs across devices)</li>
            <li><span class="benefit-icon">‚úì</span> !skip command in chat (3 per day)</li>
            <li><span class="benefit-icon">‚úì</span> Record live stream button enabled</li>
            <li><span class="benefit-icon">‚úì</span> Gold crown on your chat avatar</li>
          </ul>
        </div>
        <div class="goplus-modal-footer">
          <div class="goplus-promo-section">
            <label for="goPlusPromoCode" class="promo-label">Have a promo code?</label>
            <div class="promo-input-wrapper">
              <input type="text" id="goPlusPromoCode" placeholder="Enter code" maxlength="20" autocomplete="off" />
              <button type="button" id="goPlusApplyPromo" class="promo-apply-btn">Apply</button>
            </div>
            <p id="goPlusPromoMessage" class="promo-message"></p>
            <div id="goPlusDiscountedPrice" class="discounted-price hidden">
              <span class="original-price">¬£10</span>
              <span class="sale-price">¬£5</span>
              <span class="discount-badge">50% OFF</span>
            </div>
          </div>
          <button id="goPlusUpgradeBtn" class="goplus-upgrade-btn">
            <span class="btn-text">Upgrade Now - ¬£10</span>
            <span class="btn-loading hidden">Processing...</span>
          </button>
          <p class="goplus-secure">Secure payment via Stripe</p>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script is:inline>
  // Go Plus button handler - separate script to avoid module loading issues
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[GoPlusInit] Setting up Go Plus button');
    var btn = document.getElementById('goPlusHeaderBtn');
    var modal = document.getElementById('goPlusModal');
    console.log('[GoPlusInit] Button:', btn, 'Modal:', modal);
    if (btn) {
      btn.onclick = function(e) {
        e.preventDefault();
        console.log('[GoPlusInit] Button clicked!');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      };
      console.log('[GoPlusInit] Click handler attached');
    }
  });
</script>

<script>
  import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: (typeof import.meta !== 'undefined' && import.meta.env?.PUBLIC_FIREBASE_API_KEY) || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  // Initialize Firebase only once
  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let currentUser = null;
  let customerData = null;
  let orders = [];
  let appliedPromoCode = null; // Track applied promo code for Plus upgrade
  let authUnsubscribe = null;

  // Load customer data from Firestore (customers collection only)
  async function loadCustomerData(uid) {
    try {
      const customerDoc = await getDoc(doc(db, 'customers', uid));
      
      if (customerDoc.exists()) {
        const data = customerDoc.data();
        return {
          ...data,
          displayName: data.displayName || data.fullName || data.firstName || ''
        };
      }
      return {};
    } catch (e) {
      console.error('Error loading customer data:', e);
      return {};
    }
  }

  // Fetch orders via API
  async function fetchOrders(userId) {
    try {
      // Get auth token for secure API call
      const idToken = currentUser ? await currentUser.getIdToken() : null;
      if (!idToken) {
        console.error('[Dashboard] No auth token available');
        return [];
      }

      const response = await fetch(`/api/get-orders?userId=${encodeURIComponent(userId)}`, {
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });
      const data = await response.json();

      if (data.success) {
        return data.orders || [];
      } else {
        console.error('[Dashboard] API error:', data.error);
        return [];
      }
    } catch (error) {
      console.error('[Dashboard] Fetch error:', error);
      return [];
    }
  }

  // Fetch mixes via API
  let mixesLoaded = false;

  // Reset mixesLoaded when page becomes visible again (user returns from editing)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      mixesLoaded = false; // Force refetch on next tab click
    }
  });

  async function fetchMixes(userId, forceRefresh = false) {
    if (mixesLoaded && !forceRefresh) return;

    const container = document.getElementById('mixesContainer');
    if (!container) return;

    try {
      const response = await fetch(`/api/get-dj-mixes?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();

      if (data.success && data.mixes) {
        const mixes = data.mixes;
        mixesLoaded = true;
        
        // Update stats
        const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);
        const totalLikes = mixes.reduce((sum, m) => sum + (m.likes || 0), 0);
        
        const statMixes = document.getElementById('statMixes');
        const statMixPlays = document.getElementById('statMixPlays');
        const statMixLikes = document.getElementById('statMixLikes');
        
        if (statMixes) statMixes.textContent = mixes.length;
        if (statMixPlays) statMixPlays.textContent = totalPlays.toLocaleString();
        if (statMixLikes) statMixLikes.textContent = totalLikes.toLocaleString();
        
        if (mixes.length === 0) {
          container.innerHTML = `
            <div class="empty-state-mixes">
              <div class="empty-icon">üéß</div>
              <h3>No mixes yet</h3>
              <p>Upload your first DJ mix to share with the community.</p>
              <a href="/upload-mix" class="btn-primary-sm">Upload Mix</a>
            </div>
          `;
        } else {
          container.innerHTML = mixes.slice(0, 6).map(mix => {
            // Calculate rating score (weighted average of plays, likes, downloads)
            const plays = mix.plays || mix.playCount || 0;
            const likes = mix.likes || mix.likeCount || 0;
            const downloads = mix.downloads || mix.downloadCount || 0;
            // Handle comments - could be array or number
            const commentsArray = Array.isArray(mix.comments) ? mix.comments : [];
            const commentsCount = mix.commentCount || commentsArray.length || 0;
            const rating = Math.min(100, Math.round((plays * 0.3 + likes * 2 + downloads * 1.5 + commentsCount * 3) / 10)) || 0;
            const chartPosition = mix.chartPosition || '-';
            
            // Handle various field name formats from API
            const djName = mix.dj_name || mix.djName || mix.artist || 'Unknown DJ';
            const rawArtworkUrl = mix.artwork_url || mix.artworkUrl || mix.artwork || mix.imageUrl || mix.coverUrl || '';
            // Add cache-busting parameter using updatedAt timestamp to show fresh artwork after edits
            const cacheBuster = mix.updatedAt ? new Date(mix.updatedAt).getTime() : Date.now();
            const artworkUrl = rawArtworkUrl ? `${rawArtworkUrl}${rawArtworkUrl.includes('?') ? '&' : '?'}v=${cacheBuster}` : '';
            const mixTitle = mix.title || mix.name || 'Untitled Mix';
            const genre = mix.genre || 'Jungle & D&B';
            
            // Fix duration - handle NaN, null, undefined, 0, strings, formatted strings
            let rawDuration = mix.durationSeconds || mix.duration_seconds || mix.duration || 0;
            // Handle formatted strings like "1:30:00" or "45:30"
            if (typeof rawDuration === 'string' && rawDuration.includes(':')) {
              const parts = rawDuration.split(':').map(Number);
              if (parts.length === 3) {
                rawDuration = parts[0] * 3600 + parts[1] * 60 + parts[2];
              } else if (parts.length === 2) {
                rawDuration = parts[0] * 60 + parts[1];
              }
            }
            const durationNum = typeof rawDuration === 'number' ? rawDuration : parseInt(rawDuration, 10);
            let durationDisplay = '';
            if (durationNum && !isNaN(durationNum) && durationNum > 0) {
              const hrs = Math.floor(durationNum / 3600);
              const mins = Math.floor((durationNum % 3600) / 60);
              const secs = Math.floor(durationNum % 60);
              if (hrs > 0) {
                durationDisplay = `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
              } else {
                durationDisplay = `${mins}:${secs.toString().padStart(2, '0')}`;
              }
            }
            
            // Get latest comment preview - only show if it has real text (min 3 chars, not just emoji)
            const latestComment = commentsArray.length > 0 ? commentsArray[commentsArray.length - 1] : null;
            let commentText = latestComment ? (latestComment.text || latestComment.comment || '') : '';
            // Strip emoji-only comments and very short ones
            const textOnly = commentText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
            const commentPreview = textOnly.length >= 3 ? commentText.substring(0, 80) : '';
            const commentAuthor = (commentPreview && latestComment) ? (latestComment.username || latestComment.author || 'Anonymous') : '';
            
            return `
            <div style="display: flex; flex-direction: row; align-items: stretch; background: linear-gradient(to bottom, #1f2937, #111827); border: 2px solid #374151; border-radius: 12px; overflow: hidden; margin-bottom: 1.25rem;">
              <div style="width: 240px; min-width: 240px; height: 240px; background: #000; overflow: hidden; flex-shrink: 0;">
                ${artworkUrl ? 
                  `<img src="${artworkUrl}" alt="${mixTitle}" style="width: 100%; height: 100%; object-fit: cover; display: block;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%); color: #fff; font-size: 4rem;\\'>üéß</div>';">` : 
                  '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%); color: #fff; font-size: 4rem;">üéß</div>'}
              </div>
              <div style="flex: 1; padding: 1.75rem 2rem; display: flex; flex-direction: column; justify-content: center; gap: 1.25rem; min-width: 0;">
                <div>
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                    <h4 style="font-family: 'Inter', sans-serif; font-weight: 700; font-size: 2.5rem; color: #dc2626; margin: 0; line-height: 1.1; letter-spacing: 0.02em;">${mixTitle}</h4>
                    ${chartPosition !== '-' ? `<span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.9rem; font-weight: 600;">#${chartPosition}</span>` : ''}
                  </div>
                  <p style="font-size: 1.25rem; color: #9ca3af; margin: 0; font-weight: 500;">by ${djName}</p>
                  <p style="font-size: 1.125rem; color: #6b7280; margin: 0.5rem 0 0 0;">${genre}${durationDisplay ? ' ‚Ä¢ ' + durationDisplay : ''}</p>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; background: linear-gradient(to bottom, #374151, #1f2937); padding: 0.625rem 1rem; border-radius: 8px; align-items: center; border: 1px solid #4b5563;">
                  <div style="text-align: center; min-width: 40px;">
                    <div style="font-size: 1.125rem; font-weight: 700; color: #fff;">${plays.toLocaleString()}</div>
                    <div style="font-size: 0.625rem; color: #9ca3af; text-transform: uppercase;">Plays</div>
                  </div>
                  <div style="text-align: center; min-width: 40px;">
                    <div style="font-size: 1.125rem; font-weight: 700; color: #dc2626;">${likes.toLocaleString()}</div>
                    <div style="font-size: 0.625rem; color: #9ca3af; text-transform: uppercase;">Likes</div>
                  </div>
                  <div style="text-align: center; min-width: 40px;">
                    <div style="font-size: 1.125rem; font-weight: 700; color: #fff;">${downloads.toLocaleString()}</div>
                    <div style="font-size: 0.625rem; color: #9ca3af; text-transform: uppercase;">DLs</div>
                  </div>
                  <div style="text-align: center; min-width: 40px;">
                    <div style="font-size: 1.125rem; font-weight: 700; color: #fff;">${commentsCount.toLocaleString()}</div>
                    <div style="font-size: 0.625rem; color: #9ca3af; text-transform: uppercase;">Cmts</div>
                  </div>
                  <div style="text-align: center; min-width: 40px;">
                    <div style="font-size: 1.125rem; font-weight: 700; color: #f59e0b;">‚òÖ${rating}</div>
                    <div style="font-size: 0.625rem; color: #9ca3af; text-transform: uppercase;">Score</div>
                  </div>
                  <div style="display: flex; gap: 0.5rem; margin-left: auto; flex-shrink: 0;">
                    <a href="/dj-mix/${mix.id}" style="display: inline-block; padding: 0.4rem 0.875rem; background: #000; color: #fff; font-size: 0.8rem; font-weight: 600; border-radius: 5px; text-decoration: none; white-space: nowrap;">View Mix ‚Üí</a>
                    <a href="/account/mixes" style="display: inline-block; padding: 0.4rem 0.875rem; background: linear-gradient(to bottom, #1f2937, #111827); color: #fff; font-size: 0.8rem; font-weight: 600; border-radius: 5px; text-decoration: none; border: 2px solid #4b5563; white-space: nowrap;">Manage</a>
                  </div>
                </div>
                
                ${commentPreview ? `
                <div style="background: linear-gradient(to bottom, #374151, #1f2937); padding: 1rem 1.5rem; border-radius: 8px; border-left: 3px solid #dc2626;">
                  <p style="font-size: 1.125rem; color: #e5e7eb; margin: 0; font-style: italic;">"${commentPreview}${commentPreview.length >= 80 ? '...' : ''}"</p>
                  <p style="font-size: 0.9rem; color: #9ca3af; margin: 0.5rem 0 0 0;">‚Äî ${commentAuthor}</p>
                </div>
                ` : ''}
              </div>
            </div>
          `;}).join('');
        }
      } else {
        container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Could not load mixes</p></div>';
      }
    } catch (error) {
      console.error('[Dashboard] Mixes fetch error:', error);
      container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Error loading mixes</p></div>';
    }
  }

  // Load wishlist count for badge (lightweight)
  async function loadWishlistCount(userId) {
    const badge = document.getElementById('wishlistBadge');
    if (!badge) return;
    
    try {
      const response = await fetch(`/api/wishlist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        const count = data.count || 0;
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
    } catch (err) {
      // Silent fail
    }
  }

  // Load wishlist
  let wishlistLoaded = false;
  async function loadWishlist(userId) {
    if (wishlistLoaded) return;
    
    const container = document.getElementById('wishlistContainer');
    const badge = document.getElementById('wishlistBadge');
    if (!container) return;
    
    container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Loading wishlist...</p></div>';
    
    try {
      const response = await fetch(`/api/wishlist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        wishlistLoaded = true;
        const wishlist = data.wishlist || [];
        
        // Update badge
        if (badge) {
          badge.textContent = wishlist.length;
          badge.style.display = wishlist.length > 0 ? 'inline-flex' : 'none';
        }
        
        if (wishlist.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">Your wishlist is empty</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          `;
        } else {
          container.innerHTML = wishlist.map(release => {
            const price = release.pricePerSale || release.pricing?.digital || 0;
            const vinylPrice = release.vinylPrice || release.vinyl?.price || release.pricing?.vinyl || 0;
            const hasVinyl = release.vinylRelease || release.vinyl?.available;
            const genre = release.genre || '';
            const labelCode = release.labelCode || '';
            
            return `
              <div class="wishlist-card" data-release-id="${release.id}">
                <div class="wishlist-card-artwork">
                  <a href="/item/${release.id}">
                    <img src="${release.coverArtUrl || '/place-holder.webp'}" alt="${release.releaseName}" loading="lazy" onerror="this.src='/place-holder.webp'">
                  </a>
                </div>
                <div class="wishlist-card-content">
                  <h4 class="wishlist-card-title">${release.releaseName || 'Unknown'}</h4>
                  <p class="wishlist-card-artist">by ${release.artistName || 'Unknown Artist'}</p>
                  <div class="wishlist-card-meta">
                    ${genre ? `<span class="wishlist-card-tag">${genre}</span>` : ''}
                    ${labelCode ? `<span class="wishlist-card-tag">${labelCode}</span>` : ''}
                    <span class="wishlist-card-tag" style="background:#22c55e;color:#fff;">DIGITAL</span>
                    ${hasVinyl ? `<span class="wishlist-card-tag" style="background:#dc2626;color:#fff;">VINYL</span>` : ''}
                  </div>
                </div>
                <div class="wishlist-card-right">
                  <div class="wishlist-card-price">
                    <span class="price-digital"><span class="price-label">Digital</span> ¬£${price.toFixed(2)}</span>
                    ${hasVinyl ? `<span class="price-vinyl"><span class="price-label">Vinyl</span> ¬£${vinylPrice.toFixed(2)}</span>` : ''}
                  </div>
                  <div class="wishlist-card-actions">
                    <a href="/item/${release.id}" class="wishlist-btn-view">View</a>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Attach remove handlers
          container.querySelectorAll('.wishlist-card-remove').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.preventDefault();
              const releaseId = btn.dataset.releaseId;
              const card = btn.closest('.wishlist-card');
              
              // Optimistic removal
              card.style.opacity = '0.5';
              card.style.pointerEvents = 'none';
              
              try {
                const res = await fetch('/api/wishlist', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    userId: userId,
                    releaseId: releaseId,
                    action: 'remove'
                  })
                });
                
                const result = await res.json();
                if (result.success) {
                  card.remove();
                  
                  // Update badge and check if empty
                  const remaining = container.querySelectorAll('.wishlist-card').length;
                  if (badge) {
                    badge.textContent = remaining;
                    badge.style.display = remaining > 0 ? 'inline' : 'none';
                  }
                  
                  if (remaining === 0) {
                    container.innerHTML = `
                      <div class="empty-state" style="grid-column: 1/-1;">
                        <p style="color: #fff; margin: 0 0 1.5rem 0;">Your wishlist is empty</p>
                        <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
                      </div>
                    `;
                  }
                } else {
                  card.style.opacity = '1';
                  card.style.pointerEvents = 'auto';
                }
              } catch (err) {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
              }
            });
          });
          
          // Attach add to cart handlers
          container.querySelectorAll('.wishlist-btn-cart').forEach(btn => {
            btn.addEventListener('click', () => {
              const releaseId = btn.dataset.releaseId;
              const price = parseFloat(btn.dataset.price) || 0;
              const title = btn.dataset.title;
              const artist = btn.dataset.artist;
              const artwork = btn.dataset.artwork;
              
              // Use existing cart system
              if (window.addToCart) {
                window.addToCart({
                  id: releaseId,
                  type: 'digital',
                  price: price,
                  title: title,
                  artist: artist,
                  artwork: artwork
                });
              } else if (window.FreshWaxCart && window.FreshWaxCart.add) {
                window.FreshWaxCart.add({
                  releaseId: releaseId,
                  productType: 'digital',
                  price: price,
                  title: title,
                  artist: artist,
                  artwork: artwork
                });
              } else {
                // Fallback: dispatch cart event
                window.dispatchEvent(new CustomEvent('add-to-cart', {
                  detail: {
                    releaseId: releaseId,
                    productType: 'digital',
                    price: price,
                    title: title,
                    artist: artist,
                    artwork: artwork
                  }
                }));
              }
              
              // Visual feedback
              btn.textContent = 'Added ‚úì';
              btn.style.background = '#16a34a';
              btn.style.borderColor = '#16a34a';
              setTimeout(() => {
                btn.textContent = 'Add to Cart';
                btn.style.background = '#dc2626';
                btn.style.borderColor = '#dc2626';
              }, 2000);
            });
          });
        }
      } else {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Could not load wishlist</p></div>';
      }
    } catch (error) {
      console.error('[Dashboard] Wishlist fetch error:', error);
      container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Error loading wishlist</p></div>';
    }
  }

  // Load following count for badge
  async function loadFollowingCount(userId) {
    const badge = document.getElementById('followingBadge');
    if (!badge) return;
    
    try {
      const response = await fetch(`/api/follow-artist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        const count = data.count || 0;
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
    } catch (err) {
      // Silent fail
    }
  }

  // Load followed artists
  let followingLoaded = false;
  async function loadFollowing(userId) {
    if (followingLoaded) return;
    
    const container = document.getElementById('followingContainer');
    const badge = document.getElementById('followingBadge');
    if (!container) return;
    
    container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Loading artists...</p></div>';
    
    try {
      const response = await fetch(`/api/follow-artist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        followingLoaded = true;
        const artists = data.followedArtists || [];
        
        // Update badge
        if (badge) {
          badge.textContent = artists.length;
          badge.style.display = artists.length > 0 ? 'inline-flex' : 'none';
        }
        
        if (artists.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">You're not following any artists yet</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          `;
        } else {
          container.innerHTML = artists.map(artist => {
            const latestRelease = artist.latestRelease;
            const releaseCount = artist.releaseCount || 0;
            
            return `
              <div class="following-card" data-artist-name="${artist.artistName}">
                <img src="${artist.coverArtUrl || '/place-holder.webp'}" alt="${artist.artistName}" class="following-card-avatar" onerror="this.src='/place-holder.webp'">
                <h4 class="following-card-name">${artist.artistName}</h4>
                <p class="following-card-releases">${releaseCount} release${releaseCount !== 1 ? 's' : ''}</p>
                ${latestRelease ? `
                  <div class="following-card-latest">
                    <div class="following-card-latest-label">Latest Release</div>
                    <div class="following-card-latest-title" title="${latestRelease.releaseName}">${latestRelease.releaseName}</div>
                  </div>
                ` : ''}
                <div class="following-card-actions">
                  ${latestRelease ? `<a href="/item/${latestRelease.id}" class="following-btn-view">View Latest</a>` : '<a href="/releases" class="following-btn-view">Browse</a>'}
                  <button class="following-btn-unfollow" data-artist-name="${artist.artistName}">Unfollow</button>
                </div>
              </div>
            `;
          }).join('');
          
          // Attach unfollow handlers
          container.querySelectorAll('.following-btn-unfollow').forEach(btn => {
            btn.addEventListener('click', async () => {
              const artistName = btn.dataset.artistName;
              const card = btn.closest('.following-card');
              
              // Optimistic removal
              card.style.opacity = '0.5';
              card.style.pointerEvents = 'none';
              
              try {
                const res = await fetch('/api/follow-artist', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    userId: userId,
                    artistName: artistName,
                    action: 'unfollow'
                  })
                });
                
                const result = await res.json();
                if (result.success) {
                  card.remove();
                  
                  // Update badge and check if empty
                  const remaining = container.querySelectorAll('.following-card').length;
                  if (badge) {
                    badge.textContent = remaining;
                    badge.style.display = remaining > 0 ? 'inline' : 'none';
                  }
                  
                  if (remaining === 0) {
                    container.innerHTML = `
                      <div class="empty-state" style="grid-column: 1/-1;">
                        <p style="color: #fff; margin: 0 0 1.5rem 0;">You're not following any artists yet</p>
                        <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
                      </div>
                    `;
                  }
                } else {
                  card.style.opacity = '1';
                  card.style.pointerEvents = 'auto';
                }
              } catch (err) {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
              }
            });
          });
        }
      } else {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Could not load artists</p></div>';
      }
    } catch (error) {
      console.error('[Dashboard] Following fetch error:', error);
      container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Error loading artists</p></div>';
    }
  }

  // Check if user is an approved partner and enable Partner Dashboard button
  // Partner Dashboard is ONLY for artists and merch sellers, NOT for DJs or customers
  async function checkPartnerStatus(userId) {
    const proDashboardBtn = document.getElementById('proDashboardBtn');
    if (!proDashboardBtn) return;

    try {
      const response = await fetch(`/api/get-user-type?uid=${encodeURIComponent(userId)}`);
      const data = await response.json();

      console.log('[Dashboard] Partner status check:', data);

      if (data.success) {
        // Partner Dashboard is only for artists and merch sellers (NOT DJs)
        const isArtist = data.roles?.artist === true;
        const isMerchSupplier = data.roles?.merchSupplier === true;
        const isVinylSeller = data.roles?.vinylSeller === true;
        const isArtistOrMerchSeller = isArtist || isMerchSupplier;
        const isAnyVendor = isArtist || isMerchSupplier || isVinylSeller;
        const isApprovedPartner = data.isApproved && isArtistOrMerchSeller;

        console.log('[Dashboard] isArtistOrMerchSeller:', isArtistOrMerchSeller, 'isApproved:', data.isApproved, 'isApprovedPartner:', isApprovedPartner, 'isVinylSeller:', isVinylSeller);

        // Show selling section for any vendor type
        const sellingSection = document.getElementById('sellingSection');
        if (sellingSection && isAnyVendor) {
          sellingSection.classList.remove('hidden');

          // Show role-specific links
          if (isVinylSeller) {
            const vinylLink = document.getElementById('vinylSellingLink');
            if (vinylLink) vinylLink.style.display = 'flex';
          }
          if (isApprovedPartner) {
            const artistLink = document.getElementById('artistDashboardLink');
            if (artistLink) artistLink.style.display = 'flex';
          }
        }

        if (isApprovedPartner) {
          // Enable the Partner Dashboard button for approved artists/merch sellers
          proDashboardBtn.classList.remove('disabled');
          proDashboardBtn.title = 'Access your releases and merch';

          // Set partnerId cookie for partner dashboard (30 days)
          document.cookie = `partnerId=${userId}; path=/; max-age=2592000; SameSite=Lax`;
          console.log('[Dashboard] partnerId cookie set for:', userId);
        } else if (isArtistOrMerchSeller) {
          // They have artist/merch roles but not approved yet
          proDashboardBtn.title = 'Pending approval - available for artists & merch sellers';
        } else {
          // DJs or customers - no access to Partner Dashboard
          proDashboardBtn.title = 'Available for artists & merch sellers only';
        }
      }
    } catch (error) {
      console.error('[Dashboard] Error checking partner status:', error);
    }
  }

  // Update UI with user data
  function updateUI(user, data) {
    const loadingScreen = document.getElementById('loadingScreen');
    const mainContent = document.getElementById('mainContent');
    
    if (!loadingScreen || !mainContent) {
      return;
    }
    
    loadingScreen.classList.add('hidden');
    mainContent.classList.remove('hidden');
    
    // Prioritize displayName, then firstName, then name, then email
    let displayName = data?.displayName || data?.firstName || data?.name || user.email?.split('@')[0] || 'Customer';
    
    // Truncate to 15 characters max
    if (displayName.length > 15) {
      displayName = displayName.substring(0, 12) + '...';
    }
    
    const initial = displayName.charAt(0).toUpperCase();
    const isPro = data?.isPro || data?.isArtist || data?.approved || false;
    const avatarUrl = data?.avatarUrl || data?.photoURL || null;
    
    // Main header avatar
    const avatarEl = document.getElementById('avatarInitial');
    const userAvatarContainer = document.getElementById('userAvatar');
    
    if (avatarEl) avatarEl.textContent = initial;
    if (userAvatarContainer) {
      if (avatarUrl) {
        userAvatarContainer.innerHTML = `<img src="${avatarUrl}" alt="${displayName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      } else {
        userAvatarContainer.innerHTML = `<span id="avatarInitial">${initial}</span>`;
        if (isPro) {
          userAvatarContainer.classList.add('is-pro');
        }
      }
    }
    
    // Profile tab avatar preview
    const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
    const avatarInitialLarge = document.getElementById('avatarInitialLarge');
    const avatarImageLarge = document.getElementById('avatarImageLarge');
    const removeAvatarBtn = document.getElementById('removeAvatarBtn');
    
    if (avatarPreviewLarge) {
      if (avatarUrl) {
        if (avatarInitialLarge) avatarInitialLarge.classList.add('hidden');
        if (avatarImageLarge) {
          avatarImageLarge.src = avatarUrl;
          avatarImageLarge.classList.remove('hidden');
        }
        if (removeAvatarBtn) removeAvatarBtn.classList.remove('hidden');
        avatarPreviewLarge.classList.remove('is-pro');
      } else {
        if (avatarInitialLarge) {
          avatarInitialLarge.textContent = initial;
          avatarInitialLarge.classList.remove('hidden');
        }
        if (avatarImageLarge) avatarImageLarge.classList.add('hidden');
        if (removeAvatarBtn) removeAvatarBtn.classList.add('hidden');
        if (isPro) {
          avatarPreviewLarge.classList.add('is-pro');
        } else {
          avatarPreviewLarge.classList.remove('is-pro');
        }
      }
    }
    
    // Store isPro status for avatar upload
    window.userIsPro = isPro;
    window.currentAvatarUrl = avatarUrl;
    
    const welcomeEl = document.getElementById('welcomeName');
    const emailEl = document.getElementById('userEmail');
    
    if (welcomeEl) welcomeEl.innerHTML = `Welcome, <span class="name-highlight">${displayName}</span>`;
    if (emailEl) emailEl.textContent = user.email;
    
    // Profile form
    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const displayNameEl = document.getElementById('displayName');
    const emailInputEl = document.getElementById('email');
    const phoneEl = document.getElementById('phone');
    const address1El = document.getElementById('address1');
    const address2El = document.getElementById('address2');
    const cityEl = document.getElementById('city');
    const countyEl = document.getElementById('county');
    const postcodeEl = document.getElementById('postcode');
    const countryEl = document.getElementById('country');
    
    if (firstNameEl) firstNameEl.value = data?.firstName || '';
    if (lastNameEl) lastNameEl.value = data?.lastName || '';
    if (displayNameEl) displayNameEl.value = data?.displayName || displayName || '';
    if (emailInputEl) emailInputEl.value = user.email || '';
    if (phoneEl) phoneEl.value = data?.phone || '';
    if (address1El) address1El.value = data?.address1 || '';
    if (address2El) address2El.value = data?.address2 || '';
    if (cityEl) cityEl.value = data?.city || '';
    if (countyEl) countyEl.value = data?.county || '';
    if (postcodeEl) postcodeEl.value = data?.postcode || '';
    if (countryEl) countryEl.value = data?.country || 'United Kingdom';
  }

  // Render orders
  function renderOrders(ordersList, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (!ordersList || ordersList.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p style="color: #fff; margin: 0 0 1.5rem 0;">No orders yet</p>
          <a href="/" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Start Shopping</a>
        </div>
      `;
      return;
    }
    
    container.innerHTML = ordersList.map(order => {
      const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('en-GB', {
        day: 'numeric', month: 'short', year: 'numeric'
      }) : '';
      
      // Use status (new) or orderStatus (legacy) for compatibility
      const orderStatus = order.status || order.orderStatus;
      const statusClass = orderStatus === 'completed' ? 'status-completed' :
                          orderStatus === 'shipped' ? 'status-shipped' : 'status-processing';
      const statusText = orderStatus ? orderStatus.charAt(0).toUpperCase() + orderStatus.slice(1) : 'Processing';
      
      const items = order.items || [];
      
      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-header-left">
              <div class="order-number">${order.orderNumber || 'Order'}</div>
              <div class="order-date">${orderDate}</div>
            </div>
            <div class="order-header-right">
              <div class="order-total">¬£${order.totals?.total?.toFixed(2) || '0.00'}</div>
              <span class="order-status ${statusClass}">${statusText}</span>
            </div>
          </div>
          
          <div class="order-items">
            ${items.map(item => {
              const itemType = item.type || item.productType || 'digital';
              const typeClass = itemType === 'vinyl' ? 'vinyl' : 
                               itemType === 'merch' ? 'merch' : 
                               itemType === 'track' ? 'track' : 'digital';
              return `
                <div class="order-item">
                  <img src="${item.image || '/place-holder.webp'}" alt="" class="order-item-image">
                  <div class="order-item-details">
                    <div class="order-item-name">${item.name || item.title || 'Item'}</div>
                    <div class="order-item-meta">
                      <span class="order-item-type ${typeClass}">${itemType}</span>
                      ${item.quantity > 1 ? `<span class="order-item-qty">√ó ${item.quantity}</span>` : ''}
                    </div>
                  </div>
                  <div class="order-item-price">¬£${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                </div>
              `;
            }).join('')}
          </div>
          
          <a href="/order-confirmation/${order.id}" class="order-view-link">
            View Order Details
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      `;
    }).join('');
  }

  // Update stats
  function updateStats(ordersList) {
    const orderCount = ordersList?.length || 0;
    const totalSpent = ordersList?.reduce((sum, o) => sum + (o.totals?.total || o.total || 0), 0) || 0;
    
    // Count vinyl, digital EPs (unique releases), tracks (unique track names), and merch
    let vinylCount = 0;
    let merchCount = 0;
    const uniqueReleases = new Set(); // Track unique digital releases
    const uniqueTracks = new Set(); // Track unique track names
    
    (ordersList || []).forEach(order => {
      (order.items || []).forEach(item => {
        // Check if it's merch
        const isMerch = item.type === 'merch' || 
                        item.type === 'merchandise' ||
                        (item.releaseId && item.releaseId.startsWith('merch_')) ||
                        (item.productId && item.productId.startsWith('merch_'));
        
        // Check if it's vinyl
        const isVinyl = item.type === 'vinyl' || 
                        item.format === 'vinyl' ||
                        item.isVinyl === true ||
                        (item.productType && item.productType.toLowerCase().includes('vinyl'));
        
        if (isMerch) {
          merchCount += item.quantity || 1;
        } else if (isVinyl) {
          vinylCount += item.quantity || 1;
        } else if (item.downloads?.tracks?.length > 0 || item.type === 'digital' || item.type === 'release' || item.type === 'track') {
          // It's a digital music item - track unique releases
          const releaseKey = item.releaseId || item.productId || item.id;
          if (releaseKey) {
            uniqueReleases.add(releaseKey);
          }
          
          // Count unique track names (not formats)
          if (item.downloads?.tracks) {
            item.downloads.tracks.forEach(track => {
              const trackName = track.name || track.title || track.trackName;
              if (trackName) {
                uniqueTracks.add(trackName);
              }
            });
          }
        }
      });
    });
    
    document.getElementById('statOrders').textContent = orderCount;
    const ordersBadge = document.getElementById('ordersBadge');
    ordersBadge.textContent = orderCount;
    ordersBadge.style.display = orderCount > 0 ? 'inline-flex' : 'none';
    document.getElementById('statVinyl').textContent = vinylCount;
    document.getElementById('statDigitalEPs').textContent = uniqueReleases.size;
    document.getElementById('statTracks').textContent = uniqueTracks.size;
    document.getElementById('statMerch').textContent = merchCount;
    document.getElementById('statSpent').textContent = '¬£' + totalSpent.toFixed(2);
  }

  // Download via server-side proxy to bypass CORS
  async function downloadFile(url, filename, button) {
    const originalText = button.innerHTML;
    button.classList.add('downloading');
    button.innerHTML = 'Downloading...';
    
    try {
      // Use server-side proxy to fetch the file
      const proxyUrl = `/api/download?url=${encodeURIComponent(url)}&filename=${encodeURIComponent(filename)}`;
      
      const response = await fetch(proxyUrl);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `Download failed: ${response.status}`);
      }
      
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = blobUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      window.URL.revokeObjectURL(blobUrl);
      
      button.innerHTML = '‚úì Done!';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('downloading');
      }, 2000);
      
    } catch (error) {
      console.error('Download error:', error);
      button.innerHTML = '‚úó Error';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('downloading');
      }, 2000);
    }
  }

  // Render downloads from orders
  function renderDownloads(ordersList) {
    const container = document.getElementById('downloadsContainer');
    if (!container) return;
    
    // Extract all digital items from orders
    const allDownloads = [];
    (ordersList || []).forEach(order => {
      (order.items || []).forEach(item => {
        if (item.downloads?.tracks?.length > 0 || item.type === 'digital' || item.type === 'release' || item.type === 'track' || item.type === 'vinyl') {
          allDownloads.push({
            ...item,
            orderNumber: order.orderNumber,
            orderDate: order.createdAt
          });
        }
      });
    });
    
    // Group downloads by release to avoid duplicate artwork buttons
    const releaseMap = new Map();
    
    allDownloads.forEach(item => {
      const releaseId = item.releaseId || item.productId || item.id;
      
      if (releaseMap.has(releaseId)) {
        // Add tracks to existing release group, avoid duplicates
        const existing = releaseMap.get(releaseId);
        if (item.downloads?.tracks) {
          item.downloads.tracks.forEach(track => {
            const trackExists = existing.downloads.tracks.some(t => t.name === track.name);
            if (!trackExists) {
              existing.downloads.tracks.push(track);
            }
          });
        }
      } else {
        // Create new release group
        releaseMap.set(releaseId, {
          ...item,
          downloads: {
            artistName: item.downloads?.artistName || item.artist || '',
            releaseName: item.downloads?.releaseName || item.name || '',
            artworkUrl: item.downloads?.artworkUrl || item.image || null,
            tracks: item.downloads?.tracks ? [...item.downloads.tracks] : []
          }
        });
      }
    });
    
    const downloads = Array.from(releaseMap.values());
    
    if (downloads.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p style="color: #fff; margin: 0 0 1.5rem 0;">No digital purchases yet</p>
          <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
        </div>
      `;
      return;
    }
    
    container.innerHTML = downloads.map(item => {
      const orderDate = item.orderDate ? new Date(item.orderDate).toLocaleDateString('en-GB', {
        day: 'numeric', month: 'short', year: 'numeric'
      }) : '';
      
      const artistName = item.downloads?.artistName || item.artist || '';
      const releaseName = item.downloads?.releaseName || item.name || '';
      const displayName = artistName ? artistName + ' - ' + releaseName : releaseName;
      const artworkFilename = artistName ? artistName + ' - ' + releaseName + ' - Artwork.jpg' : releaseName + ' - Artwork.jpg';
      
      const trackRows = (item.downloads?.tracks || []).map((track, idx) => {
        const trackFilename = artistName 
          ? artistName + ' - ' + track.name + ' - ' + releaseName
          : track.name;
        
        return `
          <div class="track-row">
            <span class="track-name">
              <span class="num">${String(idx + 1).padStart(2, '0')}</span>
              ${track.name}
            </span>
            <div class="dl-buttons">
              ${track.mp3Url ? `
                <button type="button" class="dl-btn mp3" data-url="${track.mp3Url}" data-filename="${trackFilename}.mp3">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  MP3
                </button>
              ` : ''}
              ${track.wavUrl ? `
                <button type="button" class="dl-btn wav" data-url="${track.wavUrl}" data-filename="${trackFilename}.wav">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  WAV
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      const trackCount = item.downloads?.tracks?.length || 0;
      const typeLabel = trackCount === 1 ? 'Single Track' : trackCount + ' Tracks';
      
      return `
        <div class="download-card">
          <div class="download-header">
            <img src="${item.image || item.downloads?.artworkUrl || '/place-holder.webp'}" alt="${displayName}" class="download-art">
            <div class="download-info">
              <h4>${displayName}</h4>
              <p>${typeLabel} ¬∑ ${orderDate}</p>
            </div>
          </div>
          ${item.downloads?.artworkUrl ? `
            <div class="artwork-dl">
              <button type="button" class="dl-btn art" data-url="${item.downloads.artworkUrl}" data-filename="${artworkFilename}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Artwork
              </button>
            </div>
          ` : ''}
          ${trackRows ? `<div class="track-list">${trackRows}</div>` : ''}
        </div>
      `;
    }).join('');
    
    // Attach download handlers
    container.querySelectorAll('.dl-btn[data-url]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const button = e.currentTarget;
        const url = button.dataset.url;
        const filename = button.dataset.filename || 'download';
        if (url) downloadFile(url, filename, button);
      });
    });
  }

  // Tab switching
  function initTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn, .view-all-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        if (!tabId) return;
        
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
        
        // Update panels
        tabPanels.forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + tabId)?.classList.add('active');
        
        // Load mixes on demand when mixes tab is clicked
        if (tabId === 'mixes' && currentUser) {
          fetchMixes(currentUser.uid);
        }
        
        // Load wishlist on demand when wishlist tab is clicked
        if (tabId === 'wishlist' && currentUser) {
          loadWishlist(currentUser.uid);
        }
        
        // Load following on demand when following tab is clicked
        if (tabId === 'following' && currentUser) {
          loadFollowing(currentUser.uid);
        }
      });
    });
  }

  // Logout
  function initLogout() {
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = '/';
      } catch (error) {
        console.error('Logout error:', error);
      }
    });
  }

  // Profile save
  function initProfileForm() {
    // Postcode lookup
    const lookupBtn = document.getElementById('lookupBtn');
    const postcodeSearch = document.getElementById('postcodeSearch');
    const lookupError = document.getElementById('lookupError');
    const lookupSuccess = document.getElementById('lookupSuccess');
    
    if (lookupBtn && postcodeSearch) {
      lookupBtn.addEventListener('click', async () => {
        const postcode = postcodeSearch.value.trim();
        if (!postcode) {
          lookupError.textContent = 'Please enter a postcode';
          lookupSuccess.textContent = '';
          return;
        }
        
        lookupBtn.textContent = 'Verifying...';
        lookupBtn.disabled = true;
        lookupError.textContent = '';
        lookupSuccess.textContent = '';
        
        try {
          const response = await fetch(`/api/postcode-lookup?postcode=${encodeURIComponent(postcode)}`);
          const data = await response.json();
          
          if (data.success) {
            document.getElementById('postcode').value = data.postcode;
            document.getElementById('city').value = data.city || '';
            document.getElementById('county').value = data.county || '';
            lookupSuccess.textContent = '‚úì Postcode verified! Please enter your street address.';
            document.getElementById('address1')?.focus();
          } else {
            lookupError.textContent = data.error || 'Could not verify postcode';
          }
        } catch (error) {
          lookupError.textContent = 'Failed to lookup postcode';
        }
        
        lookupBtn.textContent = 'Verify';
        lookupBtn.disabled = false;
      });
      
      // Allow Enter key in postcode search
      postcodeSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          lookupBtn.click();
        }
      });
    }
    
    // Profile form submit
    document.getElementById('profileForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const btn = e.target.querySelector('.save-btn');
      btn.textContent = 'Saving...';
      btn.disabled = true;
      
      const newDisplayName = document.getElementById('displayName').value;
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      
      try {
        const phoneValue = document.getElementById('phone').value;

        // Update customers collection (only collection with write rules for users)
        await setDoc(doc(db, 'customers', currentUser.uid), {
          firstName: firstName,
          lastName: lastName,
          fullName: firstName + ' ' + lastName,
          displayName: newDisplayName,
          phone: phoneValue,
          address1: document.getElementById('address1').value,
          address2: document.getElementById('address2').value,
          city: document.getElementById('city').value,
          county: document.getElementById('county').value,
          postcode: document.getElementById('postcode').value,
          country: document.getElementById('country').value,
          updatedAt: new Date().toISOString()
        }, { merge: true });

        // Update Firebase Auth profile
        await updateProfile(currentUser, { displayName: newDisplayName });

        // Sync profile to users collection for partner dashboard
        try {
          await fetch('/api/profile-sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: currentUser.uid,
              displayName: newDisplayName,
              phone: phoneValue,
              firstName: firstName,
              lastName: lastName,
              email: currentUser.email
            })
          });
        } catch (syncError) {
          console.error('Profile sync error:', syncError);
        }

        btn.textContent = 'Saved!';
        setTimeout(() => {
          btn.textContent = 'Save Changes';
          btn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Save error:', error);
        btn.textContent = 'Error - Try Again';
        btn.disabled = false;
      }
    });
    
    // Avatar upload handler
    const avatarUploadInput = document.getElementById('avatarUpload');
    const avatarStatus = document.getElementById('avatarUploadStatus');
    
    if (avatarUploadInput) {
      avatarUploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;
        
        // Validate file
        const maxSize = 2 * 1024 * 1024; // 2MB
        if (file.size > maxSize) {
          avatarStatus.textContent = 'File too large. Max 2MB.';
          avatarStatus.className = 'avatar-status error';
          return;
        }
        
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          avatarStatus.textContent = 'Invalid format. Use JPG, PNG, or WebP.';
          avatarStatus.className = 'avatar-status error';
          return;
        }
        
        avatarStatus.textContent = 'Uploading...';
        avatarStatus.className = 'avatar-status uploading';
        
        try {
          // Upload to API with authentication
          const formData = new FormData();
          formData.append('avatar', file);
          formData.append('userId', currentUser.uid);

          // Get idToken for Firestore write authentication
          const idToken = await currentUser.getIdToken();

          const response = await fetch('/api/upload-avatar', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${idToken}`
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            avatarStatus.textContent = 'Avatar updated!';
            avatarStatus.className = 'avatar-status success';
            
            // Update UI
            const avatarUrl = result.avatarUrl;
            window.currentAvatarUrl = avatarUrl;
            
            // Update sessionStorage cache so header stays updated across pages
            try {
              const cacheKey = 'freshwax_user_type_cache';
              const cached = sessionStorage.getItem(cacheKey);
              if (cached) {
                const data = JSON.parse(cached);
                data.avatarUrl = avatarUrl;
                data.timestamp = Date.now();
                sessionStorage.setItem(cacheKey, JSON.stringify(data));
              }
            } catch (e) {
              console.warn('Failed to update avatar cache:', e);
            }
            
            // Update dashboard header avatar (if exists)
            const userAvatarContainer = document.getElementById('userAvatar');
            if (userAvatarContainer) {
              userAvatarContainer.innerHTML = `<img src="${avatarUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
              userAvatarContainer.classList.remove('is-pro');
            }
            
            // Update all header avatars (mobile and desktop from Header.astro)
            document.querySelectorAll('.account-avatar').forEach(avatar => {
              const icon = avatar.querySelector('.account-avatar-icon');
              const initial = avatar.querySelector('.account-avatar-initial');
              const img = avatar.querySelector('.account-avatar-img');
              
              if (icon) icon.classList.add('fwx-hidden');
              if (initial) initial.classList.add('fwx-hidden');
              if (img) {
                img.src = avatarUrl;
                img.classList.remove('fwx-hidden');
              }
            });
            
            // Update profile preview
            const avatarInitialLarge = document.getElementById('avatarInitialLarge');
            const avatarImageLarge = document.getElementById('avatarImageLarge');
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');
            const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
            
            if (avatarInitialLarge) avatarInitialLarge.classList.add('hidden');
            if (avatarImageLarge) {
              avatarImageLarge.src = avatarUrl;
              avatarImageLarge.classList.remove('hidden');
            }
            if (removeAvatarBtn) removeAvatarBtn.classList.remove('hidden');
            if (avatarPreviewLarge) {
              avatarPreviewLarge.classList.remove('is-pro');
            }
            
            setTimeout(() => {
              avatarStatus.textContent = '';
            }, 3000);
          } else {
            avatarStatus.textContent = result.error || 'Upload failed';
            avatarStatus.className = 'avatar-status error';
          }
        } catch (error) {
          console.error('Avatar upload error:', error);
          avatarStatus.textContent = 'Upload failed. Please try again.';
          avatarStatus.className = 'avatar-status error';
        }
        
        // Reset input
        avatarUploadInput.value = '';
      });
    }
    
    // Remove avatar handler
    const removeAvatarBtn = document.getElementById('removeAvatarBtn');
    if (removeAvatarBtn) {
      removeAvatarBtn.addEventListener('click', async () => {
        if (!currentUser) return;
        
        const avatarStatus = document.getElementById('avatarUploadStatus');
        avatarStatus.textContent = 'Removing...';
        avatarStatus.className = 'avatar-status uploading';
        
        try {
          // Get idToken for Firestore write authentication
          const idToken = await currentUser.getIdToken();

          const response = await fetch('/api/upload-avatar', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify({ userId: currentUser.uid })
          });
          
          const result = await response.json();
          
          if (result.success) {
            avatarStatus.textContent = 'Avatar removed';
            avatarStatus.className = 'avatar-status success';
            window.currentAvatarUrl = null;
            
            // Get display name initial
            const displayName = document.getElementById('displayName')?.value || 
                               document.getElementById('firstName')?.value || 'U';
            const initial = displayName.charAt(0).toUpperCase();
            
            // Update sessionStorage cache
            try {
              const cacheKey = 'freshwax_user_type_cache';
              const cached = sessionStorage.getItem(cacheKey);
              if (cached) {
                const data = JSON.parse(cached);
                data.avatarUrl = null;
                data.timestamp = Date.now();
                sessionStorage.setItem(cacheKey, JSON.stringify(data));
              }
            } catch (e) {
              console.warn('Failed to update avatar cache:', e);
            }
            
            // Update dashboard header avatar (if exists)
            const userAvatarContainer = document.getElementById('userAvatar');
            if (userAvatarContainer) {
              userAvatarContainer.innerHTML = `<span id="avatarInitial">${initial}</span>`;
              if (window.userIsPro) {
                userAvatarContainer.classList.add('is-pro');
              }
            }
            
            // Update all header avatars (mobile and desktop from Header.astro)
            document.querySelectorAll('.account-avatar').forEach(avatar => {
              const icon = avatar.querySelector('.account-avatar-icon');
              const initialEl = avatar.querySelector('.account-avatar-initial');
              const img = avatar.querySelector('.account-avatar-img');
              
              if (icon) icon.classList.add('fwx-hidden');
              if (img) img.classList.add('fwx-hidden');
              if (initialEl) {
                initialEl.textContent = initial;
                initialEl.classList.remove('fwx-hidden');
              }
            });
            
            // Update profile preview
            const avatarInitialLarge = document.getElementById('avatarInitialLarge');
            const avatarImageLarge = document.getElementById('avatarImageLarge');
            const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
            
            if (avatarInitialLarge) {
              avatarInitialLarge.textContent = initial;
              avatarInitialLarge.classList.remove('hidden');
            }
            if (avatarImageLarge) avatarImageLarge.classList.add('hidden');
            removeAvatarBtn.classList.add('hidden');
            
            if (avatarPreviewLarge) {
              if (window.userIsPro) {
                avatarPreviewLarge.classList.add('is-pro');
              }
            }
            
            setTimeout(() => {
              avatarStatus.textContent = '';
            }, 3000);
          } else {
            avatarStatus.textContent = result.error || 'Failed to remove';
            avatarStatus.className = 'avatar-status error';
          }
        } catch (error) {
          console.error('Remove avatar error:', error);
          avatarStatus.textContent = 'Failed to remove. Please try again.';
          avatarStatus.className = 'avatar-status error';
        }
      });
    }
    
    // Initialize delete account functionality
    initDeleteAccount();
    
    // Initialize download data functionality
    initDownloadData();
  }
  
  // Download data functionality
  function initDownloadData() {
    const downloadBtn = document.getElementById('downloadDataBtn');
    const modal = document.getElementById('downloadDataModal');
    const cancelBtn = document.getElementById('cancelDownloadBtn');
    const confirmBtn = document.getElementById('confirmDownloadBtn');
    const musicList = document.getElementById('musicDownloadsList');
    const mixesList = document.getElementById('mixesDownloadsList');
    const mixesSection = document.getElementById('djMixesSection');
    
    if (!downloadBtn || !modal) return;
    
    let userMixes = [];
    let purchasedItems = [];
    
    // Open modal and load content
    downloadBtn.addEventListener('click', async () => {
      modal.classList.remove('hidden');
      loadDownloadableContent();
    });
    
    // Close modal
    cancelBtn?.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    
    // Click outside to close
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
    
    // Toggle all buttons
    document.querySelectorAll('.toggle-all-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.dataset.section;
        const container = section === 'music' ? musicList : mixesList;
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => { cb.checked = !allChecked; });
        btn.textContent = allChecked ? 'Select All' : 'Deselect All';
        updateDownloadButton();
      });
    });
    
    async function loadDownloadableContent() {
      // Load purchased music from orders
      purchasedItems = [];
      const releaseGroups = {};
      
      
      if (orders && orders.length > 0) {
        orders.forEach((order, orderIdx) => {
          if (order.items) {
            order.items.forEach((item, itemIdx) => {
              // Check if this is merch - be thorough
              const isMerchType = item.type === 'merch' || item.type === 'merchandise';
              const hasMerchId = (item.releaseId && item.releaseId.startsWith('merch_')) || 
                                 (item.productId && item.productId.startsWith('merch_')) ||
                                 (item.id && String(item.id).startsWith('merch_'));
              const hasMerchAttributes = !!(item.size || item.color);
              
              const isMerch = isMerchType || hasMerchId || (hasMerchAttributes && !item.downloads);
              
              if (isMerch) {
                return;
              }
              
              // Check if this is a music item
              const hasDownloadsObj = !!item.downloads;
              const hasDownloadTracks = item.downloads?.tracks?.length > 0;
              const isDigitalType = item.type === 'digital' || item.type === 'release' || item.type === 'track';
              const hasReleaseId = !!item.releaseId;
              const hasProductId = !!item.productId;
              
              const isMusic = hasDownloadsObj || hasDownloadTracks || isDigitalType || hasReleaseId || hasProductId;
              
              if (isMusic) {
                // Use releaseId as group key to combine tracks from same release
                const groupKey = item.releaseId || item.productId || `${item.id || item.name || item.title}-${order.orderId}-${itemIdx}`;
                
                if (!releaseGroups[groupKey]) {
                  const artistName = item.downloads?.artistName || item.artist || item.artistName || 'Unknown Artist';
                  const releaseName = item.downloads?.releaseName || item.name || item.title || item.releaseName || 'Unknown Release';
                  
                  releaseGroups[groupKey] = {
                    id: groupKey,
                    title: releaseName,
                    artist: artistName,
                    releaseId: item.releaseId || item.productId || item.id,
                    orderId: order.orderId || order.id,
                    purchaseDate: order.createdAt || order.date,
                    formats: ['WAV', 'MP3'],
                    hasArtwork: item.downloads?.artworkUrl || item.image || item.artworkUrl || item.coverUrl,
                    tracks: item.downloads?.tracks ? [...item.downloads.tracks] : []
                  };
                } else {
                  // Merge tracks from same release (avoid duplicates)
                  if (item.downloads?.tracks) {
                    item.downloads.tracks.forEach(track => {
                      const trackExists = releaseGroups[groupKey].tracks.some(t => t.name === track.name);
                      if (!trackExists) {
                        releaseGroups[groupKey].tracks.push(track);
                      }
                    });
                  }
                  // Update artwork if not already set
                  if (!releaseGroups[groupKey].hasArtwork) {
                    releaseGroups[groupKey].hasArtwork = item.downloads?.artworkUrl || item.image || item.artworkUrl || item.coverUrl;
                  }
                }
              }
            });
          }
        });
      }
      
      // Convert groups to array
      purchasedItems = Object.values(releaseGroups);
      
      
      // Render music purchases grouped by release
      if (purchasedItems.length > 0) {
        musicList.innerHTML = purchasedItems.map((item, index) => {
          const trackCount = item.tracks?.length || 0;
          const trackText = trackCount > 0 ? ` ‚Ä¢ ${trackCount} track${trackCount !== 1 ? 's' : ''}` : '';
          
          return `
            <label class="download-option">
              <input type="checkbox" data-type="music" data-id="${item.releaseId || item.id}" data-index="${index}" checked />
              <span class="option-check"></span>
              <div class="option-info">
                <strong>${escapeHtml(item.title)}</strong>
                <span>${escapeHtml(item.artist)}${trackText}</span>
                <div class="option-badges">
                  ${item.formats.map(f => `<span class="option-badge audio">${f}</span>`).join(' ')}
                  ${item.hasArtwork ? ' <span class="option-badge artwork">Artwork</span>' : ''}
                </div>
              </div>
            </label>
          `;
        }).join('');
      } else {
        musicList.innerHTML = '<div class="empty-downloads">No music purchases found</div>';
      }
      
      // Load user's DJ mixes
      try {
        const mixesResponse = await fetch(`/api/get-dj-mixes?userId=${currentUser.uid}`);
        const mixesData = await mixesResponse.json();
        
        if (mixesData.success && mixesData.mixes && mixesData.mixes.length > 0) {
          userMixes = mixesData.mixes;
          mixesSection.style.display = 'block';
          
          mixesList.innerHTML = userMixes.map((mix, index) => `
            <label class="download-option">
              <input type="checkbox" data-type="mix" data-id="${mix.id}" data-index="${index}" checked />
              <span class="option-check"></span>
              <div class="option-info">
                <strong>${escapeHtml(mix.title)}</strong>
                <span>${mix.plays || 0} plays</span>
                <div class="option-badges">
                  <span class="option-badge mix">DJ Mix</span>
                </div>
              </div>
            </label>
          `).join('');
        } else {
          mixesSection.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading mixes:', e);
        mixesSection.style.display = 'none';
      }
      
      // Add event listeners to checkboxes
      modal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateDownloadButton);
      });
      
      updateDownloadButton();
    }
    
    function updateDownloadButton() {
      const anyChecked = modal.querySelectorAll('input[type="checkbox"]:checked').length > 0;
      confirmBtn.disabled = !anyChecked;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    // Handle download
    confirmBtn?.addEventListener('click', async () => {
      if (!currentUser) return;
      
      const selected = {
        ordersPdf: document.getElementById('downloadOrdersPdf')?.checked || false,
        music: [],
        mixes: []
      };
      
      // Collect selected music
      modal.querySelectorAll('input[data-type="music"]:checked').forEach(cb => {
        const index = parseInt(cb.dataset.index);
        if (purchasedItems[index]) {
          selected.music.push(purchasedItems[index]);
        }
      });
      
      // Collect selected mixes
      modal.querySelectorAll('input[data-type="mix"]:checked').forEach(cb => {
        const index = parseInt(cb.dataset.index);
        if (userMixes[index]) {
          selected.mixes.push(userMixes[index]);
        }
      });
      
      const totalItems = (selected.ordersPdf ? 1 : 0) + selected.music.length + selected.mixes.length;
      if (totalItems === 0) return;
      
      confirmBtn.textContent = 'Preparing...';
      confirmBtn.disabled = true;
      
      try {
        let downloadCount = 0;
        
        // Download order history PDF
        if (selected.ordersPdf && orders.length > 0) {
          confirmBtn.textContent = `Downloading PDF...`;
          await downloadOrdersPdf();
          downloadCount++;
        }
        
        // Download selected music files
        for (const item of selected.music) {
          confirmBtn.textContent = `Downloading ${downloadCount + 1}/${totalItems}...`;
          
          // Download each track in the release
          if (item.tracks && item.tracks.length > 0) {
            for (const track of item.tracks) {
              // Download WAV version
              if (track.wavUrl || track.url) {
                const wavUrl = track.wavUrl || track.url;
                const filename = `${item.artist} - ${track.name}.wav`;
                window.open(`/api/download?url=${encodeURIComponent(wavUrl)}&filename=${encodeURIComponent(filename)}`, '_blank');
                await new Promise(r => setTimeout(r, 800));
              }
              // Download MP3 version if available
              if (track.mp3Url) {
                const filename = `${item.artist} - ${track.name}.mp3`;
                window.open(`/api/download?url=${encodeURIComponent(track.mp3Url)}&filename=${encodeURIComponent(filename)}`, '_blank');
                await new Promise(r => setTimeout(r, 800));
              }
            }
          }
          
          // Download artwork if available
          if (item.hasArtwork) {
            const artworkUrl = typeof item.hasArtwork === 'string' ? item.hasArtwork : null;
            if (artworkUrl) {
              const filename = `${item.artist} - ${item.title} - Artwork.jpg`;
              window.open(`/api/download?url=${encodeURIComponent(artworkUrl)}&filename=${encodeURIComponent(filename)}`, '_blank');
              await new Promise(r => setTimeout(r, 500));
            }
          }
          
          downloadCount++;
        }
        
        // Download selected DJ mixes
        for (const mix of selected.mixes) {
          confirmBtn.textContent = `Downloading ${downloadCount + 1}/${totalItems}...`;
          if (mix.audioUrl || mix.url) {
            const mixUrl = mix.audioUrl || mix.url;
            const filename = `${mix.title || 'DJ Mix'}.mp3`;
            window.open(`/api/download?url=${encodeURIComponent(mixUrl)}&filename=${encodeURIComponent(filename)}`, '_blank');
          }
          downloadCount++;
          await new Promise(r => setTimeout(r, 500));
        }
        
        confirmBtn.textContent = 'Done!';
        setTimeout(() => {
          modal.classList.add('hidden');
          confirmBtn.textContent = 'Download Selected';
          confirmBtn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Download error:', error);
        confirmBtn.textContent = 'Error - Try Again';
        setTimeout(() => {
          confirmBtn.textContent = 'Download Selected';
          confirmBtn.disabled = false;
        }, 2000);
      }
    });
    
    async function downloadOrdersPdf() {
      // Generate PDF content
      const pdfContent = generateOrdersPdfHtml();
      
      // Open print dialog for PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(pdfContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }
    
    function generateOrdersPdfHtml() {
      const fullName = customerData?.displayName || 
                       (customerData?.firstName && customerData?.lastName ? 
                        `${customerData.firstName} ${customerData.lastName}` : 
                        customerData?.firstName || 'Customer');
      const email = currentUser?.email || '';
      
      // Helper to create human-readable order ID
      function formatOrderId(order, index) {
        // If there's an orderNumber field, use it
        if (order.orderNumber) return order.orderNumber;
        
        // Create a friendly ID from date + last 4 chars
        const date = new Date(order.createdAt || order.date);
        const dateStr = date.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD
        const suffix = (order.orderId || order.id || '0000').slice(-4).toUpperCase();
        return `FW-${dateStr}-${suffix}`;
      }
      
      const orderRows = orders.map((order, index) => `
        <tr>
          <td>${formatOrderId(order, index)}</td>
          <td>${new Date(order.createdAt || order.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
          <td>${(order.items || []).map(i => i.title || i.name).join(', ') || 'N/A'}</td>
          <td>¬£${(order.total || 0).toFixed(2)}</td>
          <td>${order.status || order.orderStatus || 'Completed'}</td>
        </tr>
      `).join('');
      
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Fresh Wax - Order History</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; }
            .header { text-align: center; margin-bottom: 30px; }
            .logo { font-size: 42px; font-weight: bold; margin-bottom: 10px; }
            .logo .fresh { color: #fff; }
            .logo .wax { color: #dc2626; }
            .order-history-title { font-size: 28px; color: #333; margin: 20px 0 10px 0; }
            .customer-info { color: #9ca3af; font-size: 14px; margin-bottom: 5px; }
            .generated { color: #999; font-size: 12px; margin-bottom: 30px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background: linear-gradient(to bottom, #000000, #111827); font-weight: bold; }
            .footer { margin-top: 40px; text-align: center; color: #999; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo"><span class="fresh">Fresh</span> <span class="wax">Wax</span></div>
            <div class="order-history-title">Order History</div>
            <p class="customer-info"><strong>${fullName}</strong></p>
            <p class="customer-info">${email}</p>
            <p class="generated">Generated: ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${orderRows || '<tr><td colspan="5">No orders found</td></tr>'}
            </tbody>
          </table>
          
          <p class="footer">Total Orders: ${orders.length} | freshwax.co.uk</p>
        </body>
        </html>
      `;
    }
  }
  
  // Delete account functionality
  function initDeleteAccount() {
    const deleteBtn = document.getElementById('deleteAccountBtn');
    const modal = document.getElementById('deleteModal');
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const confirmInput = document.getElementById('confirmDeleteInput');
    
    if (!deleteBtn || !modal) return;
    
    // Open modal
    deleteBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      confirmInput.value = '';
      confirmBtn.disabled = true;
    });
    
    // Close modal
    cancelBtn?.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    
    // Click outside to close
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
    
    // Enable/disable confirm button based on input
    confirmInput?.addEventListener('input', () => {
      const isValid = confirmInput.value.toLowerCase() === 'delete';
      confirmBtn.disabled = !isValid;
    });
    
    // Handle delete
    confirmBtn?.addEventListener('click', async () => {
      if (!currentUser || confirmInput.value.toLowerCase() !== 'delete') return;
      
      confirmBtn.textContent = 'Deleting...';
      confirmBtn.classList.add('deleting');
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      
      try {
        // Call delete account API
        const response = await fetch('/api/delete-account', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.uid })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Sign out and redirect
          await signOut(auth);
          window.location.href = '/login?deleted=true';
        } else {
          throw new Error(result.error || 'Failed to delete account');
        }
      } catch (error) {
        console.error('Delete account error:', error);
        confirmBtn.textContent = 'Error - Try Again';
        confirmBtn.classList.remove('deleting');
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
        
        setTimeout(() => {
          confirmBtn.textContent = 'Delete Account';
        }, 3000);
      }
    });
  }

  // Initialize dashboard
  // ========================================
  // Credit / Gift Card Functions
  // ========================================
  
  let userCreditBalance = 0;
  let creditTransactions = [];
  
  async function loadCreditBalance(userId) {
    try {
      // Get auth token for secure API call
      const idToken = currentUser ? await currentUser.getIdToken() : null;
      if (!idToken) {
        console.error('[Dashboard] No auth token for credit balance');
        return;
      }

      const response = await fetch(`/api/giftcards/balance?userId=${userId}`, {
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });
      const result = await response.json();
      
      if (result.success) {
        userCreditBalance = result.balance || 0;
        creditTransactions = result.transactions || [];
        
        // Update balance display
        const balanceEl = document.getElementById('creditBalanceDisplay');
        if (balanceEl) {
          balanceEl.textContent = `¬£${userCreditBalance.toFixed(2)}`;
        }
        
        // Update badge
        const badge = document.getElementById('creditBadge');
        if (badge) {
          if (userCreditBalance > 0) {
            badge.textContent = `¬£${userCreditBalance.toFixed(0)}`;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }
        
        // Render transactions
        renderTransactions(creditTransactions);
      }
    } catch (error) {
      console.error('Error loading credit balance:', error);
    }
  }

  // Load subscription status and update UI
  async function loadSubscriptionStatus(userId) {
    try {
      const response = await fetch(`/api/subscription?userId=${userId}`);
      const result = await response.json();

      if (!result.success) return;

      const tierBadge = document.querySelector('#subscriptionTier .tier-badge');
      const tierName = document.querySelector('#subscriptionTier .tier-name');
      const upgradeSection = document.getElementById('subscriptionUpgrade');
      const proSection = document.getElementById('subscriptionPro');
      const proExpires = document.getElementById('proExpires');
      const goPlusHeaderBtn = document.getElementById('goPlusHeaderBtn');

      // Update tier badge
      if (result.subscription.isPro) {
        tierBadge.textContent = 'Plus';
        tierBadge.classList.remove('free');
        tierBadge.classList.add('plus');
        tierName.textContent = 'Member';

        // Show pro section, hide upgrade
        if (upgradeSection) upgradeSection.classList.add('hidden');
        if (proSection) proSection.classList.remove('hidden');

        // Hide Go Plus header button for Plus members
        if (goPlusHeaderBtn) goPlusHeaderBtn.classList.add('hidden');

        // Show expiry date
        if (proExpires && result.subscription.expiresAt) {
          const expDate = new Date(result.subscription.expiresAt);
          proExpires.textContent = `Your Plus membership expires on ${expDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`;
        }

        // Load referral code
        loadReferralCode(userId);

        // Set up toggle for Plus member section
        const proHeader = document.getElementById('proHeader');
        const proDetails = document.getElementById('proDetails');
        const proToggleBtn = document.getElementById('proToggleBtn');
        console.log('[Dashboard] Pro toggle setup:', { proHeader: !!proHeader, proDetails: !!proDetails, proToggleBtn: !!proToggleBtn });
        if (proHeader && proDetails && proToggleBtn) {
          proHeader.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = proDetails.style.display === 'none' || proDetails.style.display === '';
            console.log('[Dashboard] Pro toggle clicked, isHidden:', isHidden);
            proDetails.style.display = isHidden ? 'block' : 'none';
            proToggleBtn.textContent = isHidden ? '‚ñ≤' : '‚ñº';
          });
        }
      } else {
        tierBadge.textContent = 'Standard';
        tierBadge.classList.add('free');
        tierBadge.classList.remove('plus');
        tierName.textContent = 'Account';

        // Show upgrade section, hide pro
        if (upgradeSection) upgradeSection.classList.remove('hidden');
        if (proSection) proSection.classList.add('hidden');

        // Check if expired Plus user - show special renewal message
        if (result.subscription.wasPlus && result.subscription.isExpired) {
          const upgradeTitle = document.querySelector('.upgrade-title');
          const upgradeSubtitle = document.querySelector('.upgrade-subtitle');
          if (upgradeTitle) upgradeTitle.textContent = 'Renew Your Plus Membership';
          if (upgradeSubtitle) upgradeSubtitle.textContent = 'Your Plus subscription has expired. Renew now to restore your benefits!';

          // Change button text
          if (goPlusHeaderBtn) {
            const btnText = goPlusHeaderBtn.querySelector('.pro-text');
            if (btnText) btnText.textContent = 'Renew Plus';
          }

          // Show Plus ID if available
          if (result.subscription.plusId && proExpires) {
            proExpires.textContent = `Your Plus ID: ${result.subscription.plusId} (expired)`;
            proExpires.style.color = '#ef4444';
          }
        }

        // Show Go Plus header button for non-Plus users
        if (goPlusHeaderBtn) goPlusHeaderBtn.classList.remove('hidden');
      }

      // Check for expiring soon warning (for active Plus users)
      if (result.subscription.isPro && result.subscription.isExpiringSoon) {
        const expiryWarning = document.createElement('div');
        expiryWarning.className = 'expiry-warning';
        expiryWarning.innerHTML = `
          <span class="warning-icon">‚ö†Ô∏è</span>
          <span>Your Plus membership expires soon! <a href="#" onclick="document.getElementById('goPlusModal').classList.remove('hidden'); document.body.style.overflow='hidden'; return false;">Renew now</a></span>
        `;
        if (proExpires && proExpires.parentNode) {
          proExpires.parentNode.insertBefore(expiryWarning, proExpires.nextSibling);
        }
      }

      // Update usage stats
      const mixUploadsUsed = document.getElementById('mixUploadsUsed');
      const mixUploadsLimit = document.getElementById('mixUploadsLimit');
      const streamTimeUsed = document.getElementById('streamTimeUsed');
      const streamTimeLimit = document.getElementById('streamTimeLimit');

      if (mixUploadsUsed) mixUploadsUsed.textContent = result.usage.mixUploadsThisWeek;
      if (mixUploadsLimit) mixUploadsLimit.textContent = result.limits.mixUploadsPerWeek === 'unlimited' ? '‚àû' : result.limits.mixUploadsPerWeek;
      if (streamTimeUsed) streamTimeUsed.textContent = Math.floor(result.usage.streamMinutesToday / 60);
      if (streamTimeLimit) streamTimeLimit.textContent = result.limits.streamHoursPerDay;

    } catch (error) {
      console.error('Error loading subscription:', error);
    }
  }

  // Load and display referral code for Pro users
  async function loadReferralCode(userId) {
    try {
      console.log('[Dashboard] Loading referral code for:', userId);
      // Fetch user document to get referral code
      const response = await fetch(`/api/get-user-type?uid=${userId}`);
      const data = await response.json();
      console.log('[Dashboard] Referral data:', data);

      const referralCodeDisplay = document.getElementById('referralCodeDisplay');
      const copyReferralBtn = document.getElementById('copyReferralBtn');
      const referralNote = document.getElementById('referralNote');
      const referralUsed = document.getElementById('referralUsed');
      const referralSection = document.getElementById('referralSection');

      console.log('[Dashboard] Referral elements:', {
        referralCodeDisplay: !!referralCodeDisplay,
        referralSection: !!referralSection,
        hasReferralCode: !!data.referralCode
      });

      if (!referralSection) {
        console.log('[Dashboard] No referral section found');
        return;
      }

      if (data.referralCode) {
        referralCodeDisplay.textContent = data.referralCode;

        // Check if referral code has been used
        const codeCheckResponse = await fetch(`/api/giftcards/apply-referral?code=${data.referralCode}`);
        const codeCheck = await codeCheckResponse.json();

        if (!codeCheck.success && codeCheck.error?.includes('already been used')) {
          // Code was used
          referralNote.classList.add('hidden');
          referralUsed.classList.remove('hidden');
          copyReferralBtn.style.display = 'none';
        } else {
          // Code is still active
          referralNote.classList.remove('hidden');
          referralUsed.classList.add('hidden');

          // Set up copy button
          copyReferralBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(data.referralCode).then(() => {
              copyReferralBtn.classList.add('copied');
              copyReferralBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
              setTimeout(() => {
                copyReferralBtn.classList.remove('copied');
                copyReferralBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
              }, 2000);
            });
          });
        }
      } else {
        // No referral code yet - make the code box clickable
        referralCodeDisplay.textContent = 'Click to generate';
        referralCodeDisplay.style.cursor = 'pointer';
        referralNote.textContent = 'Click the box above to generate your unique referral code';
        copyReferralBtn.style.display = 'none';

        // Make the code display clickable to generate
        referralCodeDisplay.addEventListener('click', async () => {
          if (referralCodeDisplay.textContent === 'Generating...') return;
          referralCodeDisplay.textContent = 'Generating...';
          try {
            // Get fresh auth token
            const user = auth.currentUser;
            const idToken = user ? await user.getIdToken() : null;

            const res = await fetch('/api/generate-referral-code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(idToken ? { 'Authorization': `Bearer ${idToken}` } : {})
              },
              body: JSON.stringify({ userId })
            });
            const result = await res.json();
            if (result.success && result.code) {
              referralCodeDisplay.textContent = result.code;
              referralCodeDisplay.style.cursor = 'default';
              referralNote.textContent = 'One-time use code. Expires in 1 year.';
              copyReferralBtn.style.display = 'block';
              copyReferralBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(result.code).then(() => {
                  copyReferralBtn.classList.add('copied');
                  copyReferralBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
                  setTimeout(() => {
                    copyReferralBtn.classList.remove('copied');
                    copyReferralBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                  }, 2000);
                });
              });
            } else {
              referralCodeDisplay.textContent = 'Click to retry';
              referralNote.textContent = result.error || 'Failed to generate code';
            }
          } catch (err) {
            referralCodeDisplay.textContent = 'Click to retry';
            referralNote.textContent = 'Error generating code';
          }
        });
      }
    } catch (error) {
      console.error('Error loading referral code:', error);
      const referralCodeDisplay = document.getElementById('referralCodeDisplay');
      if (referralCodeDisplay) referralCodeDisplay.textContent = 'Error loading';
    }
  }

  // Handle promo code application for Plus upgrade
  async function handleApplyPromoCode() {
    if (!currentUser) {
      alert('Please sign in first');
      return;
    }

    const promoInput = document.getElementById('goPlusPromoCode');
    const promoMessage = document.getElementById('goPlusPromoMessage');
    const discountedPriceEl = document.getElementById('goPlusDiscountedPrice');
    const upgradeBtn = document.getElementById('goPlusUpgradeBtn');
    const applyBtn = document.getElementById('goPlusApplyPromo');

    const code = promoInput?.value.trim().toUpperCase();
    if (!code) {
      promoMessage.textContent = 'Please enter a promo code';
      promoMessage.className = 'promo-message error';
      return;
    }

    // Disable apply button while checking
    if (applyBtn) applyBtn.disabled = true;
    promoMessage.textContent = 'Checking...';
    promoMessage.className = 'promo-message';

    try {
      const response = await fetch('/api/plus/validate-promo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          code,
          userId: currentUser.uid
        })
      });

      const result = await response.json();

      if (result.success && result.valid) {
        appliedPromoCode = code;
        promoMessage.textContent = result.message || 'Promo code applied!';
        promoMessage.className = 'promo-message success';
        discountedPriceEl?.classList.remove('hidden');
        promoInput.disabled = true;
        if (applyBtn) applyBtn.textContent = 'Applied';

        // Update button text to show discounted price
        const btnText = upgradeBtn?.querySelector('.btn-text');
        if (btnText) btnText.textContent = 'Upgrade Now - ¬£5';
      } else {
        appliedPromoCode = null;
        promoMessage.textContent = result.error || 'Invalid promo code';
        promoMessage.className = 'promo-message error';
        discountedPriceEl?.classList.add('hidden');
      }
    } catch (error) {
      console.error('Promo validation error:', error);
      promoMessage.textContent = 'Failed to validate code. Please try again.';
      promoMessage.className = 'promo-message error';
    } finally {
      if (applyBtn && applyBtn.textContent !== 'Applied') applyBtn.disabled = false;
    }
  }

  // Handle upgrade button click - redirect to Stripe checkout
  async function handleUpgradeClick() {
    if (!currentUser) {
      alert('Please sign in to upgrade');
      return;
    }

    const goPlusHeaderBtn = document.getElementById('goPlusHeaderBtn');
    const goPlusUpgradeBtn = document.getElementById('goPlusUpgradeBtn');

    // Disable buttons and show processing state
    if (goPlusHeaderBtn) {
      goPlusHeaderBtn.style.pointerEvents = 'none';
      const btnText = goPlusHeaderBtn.querySelector('.pro-text');
      if (btnText) btnText.textContent = 'Processing...';
    }
    if (goPlusUpgradeBtn) {
      goPlusUpgradeBtn.disabled = true;
      const btnText = goPlusUpgradeBtn.querySelector('.btn-text');
      const btnLoading = goPlusUpgradeBtn.querySelector('.btn-loading');
      if (btnText) btnText.classList.add('hidden');
      if (btnLoading) btnLoading.classList.remove('hidden');
    }

    try {
      // Create Stripe checkout session for Pro subscription
      // Promo uses one-off payment, regular uses subscription
      const isPromo = !!appliedPromoCode;
      const response = await fetch('/api/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: isPromo ? 'payment' : 'subscription', // Promo is one-off payment
          priceId: isPromo ? 'plus_annual_promo' : 'plus_annual',
          userId: currentUser.uid,
          email: currentUser.email,
          promoCode: appliedPromoCode,
          successUrl: `${window.location.origin}/account/dashboard?upgraded=true`,
          cancelUrl: `${window.location.origin}/account/dashboard`,
        })
      });

      const result = await response.json();

      if (result.success && result.checkoutUrl) {
        window.location.href = result.checkoutUrl;
      } else {
        throw new Error(result.error || 'Failed to create checkout session');
      }
    } catch (error) {
      console.error('Upgrade error:', error);
      alert('Failed to start upgrade process. Please try again.');

      // Reset buttons
      if (goPlusHeaderBtn) {
        goPlusHeaderBtn.style.pointerEvents = '';
        const btnText = goPlusHeaderBtn.querySelector('.pro-text');
        if (btnText) btnText.textContent = 'Go Plus';
      }
      if (goPlusUpgradeBtn) {
        goPlusUpgradeBtn.disabled = false;
        const btnText = goPlusUpgradeBtn.querySelector('.btn-text');
        const btnLoading = goPlusUpgradeBtn.querySelector('.btn-loading');
        if (btnText) btnText.classList.remove('hidden');
        if (btnLoading) btnLoading.classList.add('hidden');
      }
    }
  }

  // Go Plus Modal functionality
  function initGoPlusModal() {
    console.log('[Dashboard] initGoPlusModal called');
    const goPlusHeaderBtn = document.getElementById('goPlusHeaderBtn');
    const modal = document.getElementById('goPlusModal');
    const closeBtn = document.getElementById('goPlusModalClose');
    const backdrop = modal?.querySelector('.goplus-modal-backdrop');
    const upgradeBtn = document.getElementById('goPlusUpgradeBtn');

    console.log('[Dashboard] Go Plus button:', goPlusHeaderBtn);
    console.log('[Dashboard] Go Plus modal:', modal);

    if (!goPlusHeaderBtn || !modal) {
      console.log('[Dashboard] Missing elements, cannot init Go Plus modal');
      return;
    }

    // Open modal when header button is clicked
    goPlusHeaderBtn.addEventListener('click', () => {
      console.log('[Dashboard] Go Plus button clicked!');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });

    // Close modal function
    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Close on X button
    closeBtn?.addEventListener('click', closeModal);

    // Close on backdrop click
    backdrop?.addEventListener('click', closeModal);

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Handle upgrade button in modal
    upgradeBtn?.addEventListener('click', handleUpgradeClick);

    // Handle promo code apply button
    const promoApplyBtn = document.getElementById('goPlusApplyPromo');
    promoApplyBtn?.addEventListener('click', handleApplyPromoCode);

    // Handle Enter key in promo input
    const promoInput = document.getElementById('goPlusPromoCode');
    promoInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleApplyPromoCode();
      }
    });

    // Reset promo state when modal closes
    const originalCloseModal = closeModal;
    closeModal = function() {
      originalCloseModal();
      // Reset promo code state
      appliedPromoCode = null;
      const promoInputEl = document.getElementById('goPlusPromoCode');
      const promoMessage = document.getElementById('goPlusPromoMessage');
      const discountedPriceEl = document.getElementById('goPlusDiscountedPrice');
      const promoBtnEl = document.getElementById('goPlusApplyPromo');
      const upgradeBtnText = document.getElementById('goPlusUpgradeBtn')?.querySelector('.btn-text');

      if (promoInputEl) { promoInputEl.value = ''; promoInputEl.disabled = false; }
      if (promoMessage) { promoMessage.textContent = ''; promoMessage.className = 'promo-message'; }
      if (discountedPriceEl) discountedPriceEl.classList.add('hidden');
      if (promoBtnEl) { promoBtnEl.textContent = 'Apply'; promoBtnEl.disabled = false; }
      if (upgradeBtnText) upgradeBtnText.textContent = 'Upgrade Now - ¬£10';
    };
  }

  // Check URL params for successful upgrade
  function checkUpgradeSuccess() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('upgraded') === 'true') {
      // Show success message
      alert('Welcome to Plus! Your subscription is now active.');
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  function renderTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    if (!container) return;
    
    if (!transactions || transactions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p style="color: #9ca3af;">No transactions yet</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = transactions.map(txn => {
      const isCredit = txn.amount > 0;
      const date = new Date(txn.createdAt).toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
      
      return `
        <div class="transaction-item ${isCredit ? 'credit' : 'debit'}">
          <div class="transaction-info">
            <span class="transaction-desc">${txn.description}</span>
            <span class="transaction-date">${date}</span>
          </div>
          <span class="transaction-amount ${isCredit ? 'positive' : 'negative'}">
            ${isCredit ? '+' : ''}¬£${Math.abs(txn.amount).toFixed(2)}
          </span>
        </div>
      `;
    }).join('');
  }
  
  function initCreditTab() {
    const form = document.getElementById('dashboardRedeemForm');
    const codeInput = document.getElementById('dashboardGiftCode');
    
    // Format code as user types
    if (codeInput) {
      codeInput.addEventListener('input', (e) => {
        let value = e.target.value.toUpperCase().replace(/[^A-HJ-NP-Z2-9]/g, '');
        
        if (value.length > 4) {
          const prefix = value.substring(0, 4);
          const rest = value.substring(4);
          const chunks = rest.match(/.{1,4}/g) || [];
          value = prefix + '-' + chunks.join('-');
        }
        
        e.target.value = value;
      });
    }
    
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentUser) return;
        
        const code = codeInput.value.trim();
        const btn = document.getElementById('dashboardRedeemBtn');
        const btnText = btn.querySelector('.btn-text');
        const btnLoading = btn.querySelector('.btn-loading');
        const errorEl = document.getElementById('dashboardRedeemError');
        const successEl = document.getElementById('dashboardRedeemSuccess');
        
        errorEl.style.display = 'none';
        successEl.style.display = 'none';
        
        if (!code) {
          errorEl.textContent = 'Please enter a gift card code';
          errorEl.style.display = 'block';
          return;
        }
        
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        
        try {
          const response = await fetch('/api/giftcards/redeem', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              code,
              userId: currentUser.uid
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            successEl.textContent = result.message;
            successEl.style.display = 'block';
            codeInput.value = '';
            
            // Reload credit balance
            await loadCreditBalance(currentUser.uid);
          } else {
            errorEl.textContent = result.error || 'Failed to redeem gift card';
            errorEl.style.display = 'block';
          }
        } catch (error) {
          console.error('Redeem error:', error);
          errorEl.textContent = 'Something went wrong. Please try again.';
          errorEl.style.display = 'block';
        } finally {
          btn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
        }
      });
    }
  }
  
  // ========================================
  // Dashboard Initialization
  // ========================================
  
  // Reset loaded flags - called on page init and when navigating back
  function resetLoadedFlags() {
    mixesLoaded = false;
    wishlistLoaded = false;
    followingLoaded = false;
  }
  
  // Handle browser back/forward navigation (bfcache)
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      // Page was restored from bfcache
      console.log('[Dashboard] Page restored from cache, resetting state');
      resetLoadedFlags();
      
      // Re-fetch data for current tab if needed
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab && currentUser) {
        const tabId = activeTab.getAttribute('data-tab');
        if (tabId === 'mixes') {
          fetchMixes(currentUser.uid);
        } else if (tabId === 'wishlist') {
          loadWishlist(currentUser.uid);
        } else if (tabId === 'following') {
          loadFollowing(currentUser.uid);
        }
      }
    }
  });

  function initDashboard() {
    // Only run on dashboard page
    if (!document.getElementById('loadingScreen') || !document.getElementById('mainContent')) {
      return;
    }
    
    
    // Reset state
    currentUser = null;
    customerData = null;
    orders = [];
    resetLoadedFlags();
    
    // Unsubscribe previous listener if exists
    if (authUnsubscribe) {
      authUnsubscribe();
    }
    
    // Auth state listener
    authUnsubscribe = onAuthStateChanged(auth, async (user) => {
      
      if (user) {
        currentUser = user;
        
        try {
          // Load customer data
          customerData = await loadCustomerData(user.uid);
          
          // Update UI first to show the dashboard
          updateUI(user, customerData);
          
          // Fetch orders via API
          orders = await fetchOrders(user.uid);
          
          // Render orders
          renderOrders(orders.slice(0, 5), 'recentOrdersList');
          renderOrders(orders, 'ordersContainer');
          
          // Render downloads from orders
          renderDownloads(orders);
          
          // Update stats
          updateStats(orders);
          
          // Load wishlist count for badge (don't wait for full data)
          loadWishlistCount(user.uid);
          
          // Load following count for badge
          loadFollowingCount(user.uid);
          
          // Check if user is approved partner and enable Partner Dashboard button
          checkPartnerStatus(user.uid);
          
          // Load credit balance
          loadCreditBalance(user.uid);
          
          // Initialize components
          initTabs();
          initLogout();
          initProfileForm();
          initCreditTab();

          // Load subscription status
          loadSubscriptionStatus(user.uid);

          // Check for successful upgrade redirect
          checkUpgradeSuccess();

          // Initialize Go Plus modal
          initGoPlusModal();

        } catch (error) {
          console.error('[Dashboard] Error loading dashboard:', error);
          // Still show dashboard even on error
          const loadingScreen = document.getElementById('loadingScreen');
          const mainContent = document.getElementById('mainContent');
          if (loadingScreen) loadingScreen.classList.add('hidden');
          if (mainContent) mainContent.classList.remove('hidden');
          
          // Initialize components
          initTabs();
          initLogout();
          initProfileForm();
          initGoPlusModal();
        }
        
      } else {
        window.location.href = '/login';
      }
    });
  }
  
  // Run on initial load and ViewTransitions navigation
  initDashboard();
  document.addEventListener('astro:page-load', initDashboard);
</script>

<style>
  /* Go Plus Header Button - Grey with Gold Crown */
  .go-plus-header-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #374151;
    color: #fff;
    border: 1px solid #4b5563;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .go-plus-header-btn:hover {
    background: #4b5563;
    transform: translateY(-1px);
  }

  .go-plus-header-btn .crown-icon {
    color: #f59e0b;
    width: 18px;
    height: 18px;
  }

  .go-plus-header-btn.hidden {
    display: none;
  }

  /* Go Plus Modal */
  .goplus-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .goplus-modal.hidden {
    display: none;
  }

  .goplus-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
  }

  .goplus-modal-content {
    position: relative;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 2px solid #f59e0b;
    border-radius: 1rem;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(245, 158, 11, 0.2);
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .goplus-modal-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 2rem;
    height: 2rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: #fff;
    font-size: 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .goplus-modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .goplus-modal-header {
    text-align: center;
    padding: 2rem 1.5rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .goplus-modal-crown {
    color: #f59e0b;
    margin-bottom: 0.5rem;
  }

  .goplus-modal-header h2 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 800;
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .goplus-price {
    margin: 0.5rem 0 0;
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
  }

  .goplus-price span {
    font-size: 1rem;
    font-weight: 400;
    color: #9ca3af;
  }

  .goplus-modal-body {
    padding: 1.5rem;
  }

  .goplus-benefits {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .goplus-benefits li {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0;
    color: #e5e7eb;
    font-size: 0.95rem;
  }

  .benefit-icon {
    color: #10b981;
    font-weight: 700;
    flex-shrink: 0;
  }

  .goplus-modal-footer {
    padding: 1rem 1.5rem 1.5rem;
    text-align: center;
  }

  .goplus-upgrade-btn {
    width: 100%;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #000;
    border: none;
    border-radius: 0.5rem;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
  }

  .goplus-upgrade-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
  }

  .goplus-upgrade-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .goplus-secure {
    margin: 0.75rem 0 0;
    font-size: 0.75rem;
    color: #6b7280;
  }

  /* Promo Code Section */
  .goplus-promo-section {
    margin-bottom: 1rem;
    text-align: left;
  }

  .promo-label {
    display: block;
    font-size: 0.85rem;
    color: #9ca3af;
    margin-bottom: 0.5rem;
  }

  .promo-input-wrapper {
    display: flex;
    gap: 0.5rem;
  }

  .promo-input-wrapper input {
    flex: 1;
    padding: 0.6rem 0.75rem;
    background: #1a1a2e;
    border: 1px solid #333;
    border-radius: 0.375rem;
    color: #fff;
    font-size: 0.9rem;
    text-transform: uppercase;
  }

  .promo-input-wrapper input:focus {
    outline: none;
    border-color: #f59e0b;
  }

  .promo-apply-btn {
    padding: 0.6rem 1rem;
    background: #374151;
    color: #fff;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .promo-apply-btn:hover {
    background: #4b5563;
  }

  .promo-apply-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .promo-message {
    margin: 0.5rem 0 0;
    font-size: 0.8rem;
    min-height: 1.2em;
  }

  .promo-message.error {
    color: #ef4444;
  }

  .promo-message.success {
    color: #22c55e;
  }

  .discounted-price {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 0.5rem;
  }

  .discounted-price .original-price {
    font-size: 1.1rem;
    color: #6b7280;
    text-decoration: line-through;
  }

  .discounted-price .sale-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #22c55e;
  }

  .discounted-price .discount-badge {
    padding: 0.25rem 0.5rem;
    background: #22c55e;
    color: #000;
    font-size: 0.7rem;
    font-weight: 700;
    border-radius: 0.25rem;
  }

  /* Subscription Card Styles */
  .subscription-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid #333;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1.5rem 0;
  }

  .subscription-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .subscription-tier {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .tier-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .tier-badge.free {
    background: #374151;
    color: #9ca3af;
  }

  .tier-badge.plus {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #000;
  }

  .tier-name {
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .subscription-usage {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
  }

  .usage-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .usage-label {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .usage-value {
    font-size: 1rem;
    color: #fff;
    font-weight: 500;
  }

  .subscription-upgrade {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
  }

  .upgrade-benefits h4 {
    margin: 0 0 0.5rem;
    color: #ef4444;
    font-size: 1rem;
  }

  .upgrade-benefits ul {
    margin: 0;
    padding-left: 1.25rem;
    color: #ccc;
    font-size: 0.85rem;
    line-height: 1.6;
  }

  .upgrade-btn {
    flex-shrink: 0;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: #fff;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.95rem;
  }

  .upgrade-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
  }

  .subscription-pro {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
  }

  .pro-active {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .pro-icon-large {
    font-size: 2rem;
  }

  .pro-message {
    font-size: 1.25rem;
    font-weight: 700;
    color: #f59e0b;
  }

  .pro-expires {
    margin: 0;
    color: #888;
    font-size: 0.85rem;
  }

  .expiry-warning {
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
    padding: 12px 16px;
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: #f59e0b;
  }

  .expiry-warning a {
    color: #f59e0b;
    font-weight: 600;
    text-decoration: underline;
  }

  /* Referral Code Section */
  .referral-section {
    margin-top: 1.5rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.1) 100%);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 12px;
    text-align: center;
    width: 100%;
    max-width: 400px;
  }

  .referral-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .referral-icon {
    font-size: 1.5rem;
  }

  .referral-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #22c55e;
  }

  .referral-desc {
    margin: 0 0 1rem 0;
    color: #ccc;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .referral-code-box {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.3);
    border: 2px dashed rgba(34, 197, 94, 0.5);
    border-radius: 8px;
    margin-bottom: 0.75rem;
  }

  .referral-code {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    color: #22c55e;
    letter-spacing: 0.05em;
  }

  .copy-referral-btn {
    padding: 0.5rem;
    background: rgba(34, 197, 94, 0.2);
    border: 1px solid rgba(34, 197, 94, 0.4);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .copy-referral-btn svg {
    color: #22c55e;
  }

  .copy-referral-btn:hover {
    background: rgba(34, 197, 94, 0.3);
    transform: scale(1.05);
  }

  .copy-referral-btn.copied {
    background: #22c55e;
  }

  .copy-referral-btn.copied svg {
    color: #fff;
  }

  .referral-note {
    margin: 0;
    color: #888;
    font-size: 0.75rem;
  }

  .referral-used {
    margin: 0.5rem 0 0 0;
    color: #888;
    font-size: 0.875rem;
    font-weight: 600;
  }

  @media (max-width: 640px) {
    .subscription-usage {
      grid-template-columns: 1fr;
    }

    .subscription-upgrade {
      flex-direction: column;
      text-align: center;
    }

    .upgrade-benefits ul {
      text-align: left;
    }

    .referral-section {
      max-width: 100%;
    }
  }
</style>