---
// src/pages/account/dashboard.astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export const prerender = false;
---

<Layout title="My Account - Fresh Wax" noindex={true}>
  <Header />
  
  <main class="dashboard-main">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="spinner"></div>
      <p>Loading your account...</p>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="mainContent" class="hidden">
      
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <div class="dashboard-header-left">
          <div class="user-avatar" id="userAvatar">
            <span id="avatarInitial">C</span>
          </div>
          <div>
            <h1 id="welcomeName">Welcome back</h1>
            <p class="user-email" id="userEmail">Loading...</p>
          </div>
        </div>
        <div class="dashboard-header-right">
          <a href="/artist/dashboard" id="proDashboardBtn" class="pro-dashboard-btn disabled" title="Available for approved artists & merch sellers">
            <span class="pro-icon">‚ö°</span>
            <span class="pro-text">Pro Dashboard</span>
          </a>
          <button id="logoutBtn" class="logout-btn">Sign Out</button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="orders">Orders <span class="badge" id="ordersBadge" style="display: none;">0</span></button>
        <button class="tab-btn" data-tab="downloads">Downloads</button>
        <button class="tab-btn" data-tab="credit">Credit <span class="credit-badge" id="creditBadge" style="display: none;">¬£0</span></button>
        <button class="tab-btn" data-tab="wishlist">Wishlist <span class="badge" id="wishlistBadge" style="display: none;">0</span></button>
        <button class="tab-btn" data-tab="following">Following <span class="badge" id="followingBadge" style="display: none;">0</span></button>
        <button class="tab-btn" data-tab="mixes">DJ Mixes</button>
        <button class="tab-btn" data-tab="profile">Profile</button>
      </div>

      <!-- Tab Content -->
      <div class="tab-panels">
        
        <!-- Overview Tab -->
        <div class="tab-panel active" id="panel-overview">
          <div class="stats-grid-full">
            <div class="stat-card">
              <div class="stat-value" id="statOrders">0</div>
              <div class="stat-label">Orders</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statVinyl">0</div>
              <div class="stat-label">Vinyl</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statDigitalEPs">0</div>
              <div class="stat-label">Digital</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statTracks">0</div>
              <div class="stat-label">Tracks</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statMerch">0</div>
              <div class="stat-label">Merch</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statSpent">¬£0</div>
              <div class="stat-label">Spent</div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-header">
              <h2>Recent Orders</h2>
              <button class="view-all-btn" data-tab="orders">View All ‚Üí</button>
            </div>
            <div id="recentOrdersList" class="orders-list">
              <div class="empty-state">
                <p style="color: #fff; margin: 0 0 1.5rem 0;">No orders yet</p>
                <a href="/" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Start Shopping</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-panel" id="panel-orders">
          <h2>My Orders</h2>
          <div id="ordersContainer" class="orders-list">
            <div class="empty-state">
              <p>Loading orders...</p>
            </div>
          </div>
        </div>

        <!-- Downloads Tab -->
        <div class="tab-panel" id="panel-downloads">
          <h2>My Downloads</h2>
          <div id="downloadsContainer" class="downloads-list">
            <div class="empty-state">
              <p>Loading downloads...</p>
            </div>
          </div>
        </div>

        <!-- Credit Tab -->
        <div class="tab-panel" id="panel-credit">
          <h2>Store Credit</h2>
          
          <!-- Balance Display -->
          <div class="credit-balance-card">
            <div class="balance-icon">üí≥</div>
            <div class="balance-info">
              <span class="balance-label">Available Balance</span>
              <span class="balance-amount" id="creditBalanceDisplay">¬£0.00</span>
            </div>
            <p class="balance-hint">Use your credit at checkout - it's automatically available!</p>
          </div>
          
          <!-- Redeem Gift Card -->
          <div class="redeem-section">
            <h3>Redeem Gift Card</h3>
            <p class="redeem-desc">Enter your gift card code to add credit to your account</p>
            
            <form id="dashboardRedeemForm" class="redeem-form">
              <div class="code-input-group">
                <input 
                  type="text" 
                  id="dashboardGiftCode" 
                  placeholder="FWGC-XXXX-XXXX-XXXX" 
                  maxlength="19"
                  autocomplete="off"
                  spellcheck="false"
                />
                <button type="submit" id="dashboardRedeemBtn" class="redeem-btn">
                  <span class="btn-text">Redeem</span>
                  <span class="btn-loading hidden">
                    <svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" /></svg>
                  </span>
                </button>
              </div>
              <p id="dashboardRedeemError" class="redeem-error"></p>
              <p id="dashboardRedeemSuccess" class="redeem-success"></p>
            </form>
          </div>
          
          <!-- Transaction History -->
          <div class="transactions-section">
            <h3>Transaction History</h3>
            <div id="transactionsList" class="transactions-list">
              <div class="empty-state">
                <p style="color: #888;">No transactions yet</p>
              </div>
            </div>
          </div>
          
          <!-- Get More Credit -->
          <div class="get-credit-cta">
            <a href="/giftcards" class="cta-link">
              <span class="cta-icon">üéÅ</span>
              <span>Learn more about Gift Cards ‚Üí</span>
            </a>
          </div>
        </div>

        <!-- Wishlist Tab -->
        <div class="tab-panel" id="panel-wishlist">
          <div class="section-header-flex">
            <h2>My Wishlist</h2>
            <a href="/releases" class="btn-secondary-sm">Browse Releases ‚Üí</a>
          </div>
          <p class="wishlist-intro" style="color: #9ca3af; margin-bottom: 1.5rem; font-size: 0.9375rem;">
            Releases you've saved for later. Click the bookmark icon on any release to add it here.
          </p>
          <div id="wishlistContainer" class="wishlist-grid">
            <div class="empty-state">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">Your wishlist is empty</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          </div>
        </div>

        <!-- Following Tab -->
        <div class="tab-panel" id="panel-following">
          <div class="section-header-flex">
            <h2>Artists I Follow</h2>
            <a href="/releases" class="btn-secondary-sm">Discover Artists ‚Üí</a>
          </div>
          <p class="following-intro" style="color: #9ca3af; margin-bottom: 1.5rem; font-size: 0.9375rem;">
            Stay updated with new releases from your favourite artists. Click the Follow button on any release to add artists here.
          </p>
          <div id="followingContainer" class="following-grid">
            <div class="empty-state">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">You're not following any artists yet</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          </div>
        </div>

        <!-- DJ Mixes Tab -->
        <div class="tab-panel" id="panel-mixes">
          <div class="section-header-flex">
            <h2>My DJ Mixes</h2>
            <a href="/upload-mix" class="btn-primary-sm">+ Upload Mix</a>
          </div>
          <div class="mixes-stats" id="mixesStats">
            <div class="stat-mini"><span class="stat-value" id="statMixes">0</span><span class="stat-label">Mixes</span></div>
            <div class="stat-mini"><span class="stat-value" id="statMixPlays">0</span><span class="stat-label">Total Plays</span></div>
            <div class="stat-mini"><span class="stat-value" id="statMixLikes">0</span><span class="stat-label">Likes</span></div>
          </div>
          <div id="mixesContainer" class="mixes-list"><div class="empty-state"><p>Loading mixes...</p></div></div>
          <div class="mixes-cta"><a href="/account/mixes" class="btn-secondary">Manage All Mixes ‚Üí</a></div>
        </div>

        <!-- Profile Tab -->
        <div class="tab-panel" id="panel-profile">
          <h2>My Profile</h2>
          
          <!-- Avatar Upload Section -->
          <div class="avatar-upload-section">
            <div class="avatar-preview-large" id="avatarPreviewLarge">
              <span id="avatarInitialLarge">?</span>
              <img id="avatarImageLarge" src="" alt="Profile" class="hidden" />
            </div>
            <div class="avatar-upload-controls">
              <h3>Profile Picture</h3>
              <p class="avatar-hint">This image will appear next to your comments, in chat, and across the site.</p>
              <div class="avatar-buttons">
                <label for="avatarUpload" class="btn-upload">
                  <span>üì∑ Upload Image</span>
                  <input type="file" id="avatarUpload" accept="image/jpeg,image/png,image/webp" style="display: none;" />
                </label>
                <button type="button" id="removeAvatarBtn" class="btn-remove hidden">Remove</button>
              </div>
              <p class="avatar-specs">JPG, PNG or WebP. Max 2MB. Square images work best.</p>
              <div id="avatarUploadStatus" class="avatar-status"></div>
            </div>
          </div>
          
          <form id="profileForm" class="profile-form">
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" maxlength="30">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" maxlength="30">
              </div>
            </div>
            <div class="form-group">
              <label for="displayName">Display Name</label>
              <input type="text" id="displayName" name="displayName" placeholder="How you appear on the site" maxlength="30">
              <p class="field-hint">This is how you'll be known across Fresh <span style="color: #dc2626;">Wax</span></p>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" readonly>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone">
              </div>
            </div>
            
            <!-- Shipping Address Section -->
            <div class="address-section">
              <h3>Shipping Address</h3>
              <p class="address-hint">Save your address to speed up checkout</p>
              
              <!-- Postcode Lookup -->
              <div class="postcode-lookup">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                  <label for="postcodeSearch">Find Address by Postcode</label>
                  <div style="display: flex; gap: 0.75rem;">
                    <input type="text" id="postcodeSearch" placeholder="E1 6AN" style="max-width: 140px; text-transform: uppercase;">
                    <button type="button" id="lookupBtn" class="lookup-btn">Verify</button>
                  </div>
                  <div id="lookupError" class="lookup-error"></div>
                  <div id="lookupSuccess" class="lookup-success"></div>
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom: 0.5rem;">
                <label for="address1">Address Line 1</label>
                <input type="text" id="address1" name="address1" placeholder="Street address">
              </div>
              <div class="form-group">
                <label for="address2">Address Line 2 (Optional)</label>
                <input type="text" id="address2" name="address2" placeholder="Flat, unit, building, etc.">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city">
                </div>
                <div class="form-group">
                  <label for="county">County</label>
                  <input type="text" id="county" name="county">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="postcode">Postcode</label>
                  <input type="text" id="postcode" name="postcode" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                  <label for="country">Country</label>
                  <select id="country" name="country">
                    <option value="United Kingdom" selected>United Kingdom</option>
                    <option value="Ireland">Ireland</option>
                    <option value="United States">United States</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Germany">Germany</option>
                    <option value="France">France</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Spain">Spain</option>
                    <option value="Italy">Italy</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Norway">Norway</option>
                    <option value="Denmark">Denmark</option>
                    <option value="Finland">Finland</option>
                    <option value="Austria">Austria</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Poland">Poland</option>
                    <option value="Czech Republic">Czech Republic</option>
                    <option value="Japan">Japan</option>
                    <option value="South Korea">South Korea</option>
                    <option value="Singapore">Singapore</option>
                    <option value="Hong Kong">Hong Kong</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>
            </div>
            
            <button type="submit" class="save-btn">Save Changes</button>
          </form>
          
          <!-- Danger Zone -->
          <div class="danger-zone">
            <h3>Data & Account</h3>
            <div class="danger-zone-content">
              <!-- Download Data Section -->
              <div class="data-section">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <div>
                  <strong>Download Your Data</strong>
                  <p>Export your order history and download your audio and artwork files.</p>
                </div>
              </div>
              <button type="button" id="downloadDataBtn" class="download-data-btn">Download My Data</button>
              
              <div class="danger-divider"></div>
              
              <!-- Delete Account Section -->
              <div class="danger-warning">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                  <strong>Delete Account</strong>
                  <p>Once you delete your account, there is no going back. All your data, orders, and downloads will be permanently removed. You will need to register for a new account.</p>
                </div>
              </div>
              <button type="button" id="deleteAccountBtn" class="delete-account-btn">Delete My Account</button>
            </div>
          </div>
        </div>

        <!-- Download Data Modal -->
        <div id="downloadDataModal" class="modal-overlay hidden">
          <div class="modal-content download-modal">
            <h2>Download Your Data</h2>
            <p class="modal-description">Select items to download:</p>
            
            <!-- Order History Section -->
            <div class="download-section">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                <span>Order History</span>
              </div>
              <label class="download-option">
                <input type="checkbox" id="downloadOrdersPdf" checked />
                <span class="option-check"></span>
                <div class="option-info">
                  <strong>Order History (PDF)</strong>
                  <span>Complete record of all your orders</span>
                </div>
              </label>
            </div>
            
            <!-- Music Purchases Section -->
            <div class="download-section">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18V5l12-2v13"/>
                  <circle cx="6" cy="18" r="3"/>
                  <circle cx="18" cy="16" r="3"/>
                </svg>
                <span>Music Purchases</span>
                <button type="button" class="toggle-all-btn" data-section="music">Deselect All</button>
              </div>
              <div id="musicDownloadsList" class="downloads-list-container">
                <div class="loading-placeholder">Loading your purchases...</div>
              </div>
            </div>
            
            <!-- DJ Mixes Section -->
            <div class="download-section" id="djMixesSection" style="display: none;">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Your DJ Mixes</span>
                <button type="button" class="toggle-all-btn" data-section="mixes">Deselect All</button>
              </div>
              <div id="mixesDownloadsList" class="downloads-list-container">
                <div class="loading-placeholder">Loading your mixes...</div>
              </div>
            </div>
            
            <div class="modal-buttons">
              <button type="button" id="cancelDownloadBtn" class="cancel-btn">Cancel</button>
              <button type="button" id="confirmDownloadBtn" class="confirm-download-btn">Download Selected</button>
            </div>
          </div>
        </div>

        <!-- Delete Account Modal -->
        <div id="deleteModal" class="modal-overlay hidden">
          <div class="modal-content">
            <div class="modal-header">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              <h3>Delete Account</h3>
            </div>
            <div class="modal-body">
              <p class="modal-warning">This action is <strong>permanent</strong> and cannot be undone.</p>
              <ul class="modal-list">
                <li>All your account data will be deleted</li>
                <li>Your order history will be removed</li>
                <li>Your downloads will no longer be accessible</li>
                <li>You will need to register a new account</li>
              </ul>
              <div class="confirm-delete">
                <label for="confirmDelete">Type <strong>delete</strong> to confirm:</label>
                <input type="text" id="confirmDeleteInput" placeholder="delete" autocomplete="off">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="cancelDeleteBtn" class="modal-btn cancel">Cancel</button>
              <button type="button" id="confirmDeleteBtn" class="modal-btn delete" disabled>Delete Account</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .dashboard-main {
    min-height: 100vh;
    background: #f5f5f5;
    padding: 2rem 1rem;
    position: relative;
  }
  
  .loading-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    color: #666;
    font-size: 1.125rem;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #ddd;
    border-top-color: #000;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .hidden { display: none !important; }
  
  #mainContent {
    max-width: 1000px;
    margin: 0 auto;
  }
  
  .tab-panels {
    max-width: 100%;
    margin: 0 auto;
  }
  
  /* Dashboard Header */
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 1.5rem 2rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .dashboard-header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .user-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    overflow: hidden;
  }
  
  .user-avatar.is-pro {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  }
  
  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .dashboard-header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    margin: 0;
    color: #000;
  }
  
  .dashboard-header h1 .name-highlight {
    color: #dc2626;
  }
  
  .user-email {
    font-size: 1rem;
    color: #666;
    margin: 0.25rem 0 0 0;
  }
  
  .logout-btn {
    padding: 0.75rem 1.5rem;
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .logout-btn:hover {
    border-color: #dc2626;
    color: #dc2626;
  }
  
  /* Tab Navigation */
  .tab-nav {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    background: #fff;
    padding: 0.75rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .tab-btn {
    flex: 1;
    min-width: 100px;
    justify-content: center;
    padding: 0.75rem 1rem;
    background: #fff;
    border: 2px solid #222;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #222;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
  
  .tab-btn:hover { background: #f5f5f5; color: #000; border-color: #000; }
  .tab-btn.active { background: #000; color: #fff; border-color: #000; }
  
  .badge {
    background: #dc2626;
    color: #fff;
    font-size: 0.75rem;
    min-width: 1.25rem;
    height: 1.25rem;
    padding: 0 0.375rem;
    border-radius: 0.625rem;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .badge:empty,
  .badge[style*="display: none"] {
    display: none !important;
  }
  
  .tab-btn.active .badge {
    background: #fff;
    color: #000;
  }
  
  /* Tab Panels */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  
  /* Credit Tab Styles */
  .credit-badge {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 700;
    margin-left: 0.5rem;
  }
  
  .credit-balance-card {
    background: linear-gradient(135deg, #064e3b 0%, #022c22 100%);
    border: 3px solid #10b981;
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .balance-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .balance-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .balance-label {
    color: #6ee7b7;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  
  .balance-amount {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 4rem;
    color: #fff;
    line-height: 1;
  }
  
  .balance-hint {
    color: #34d399;
    font-size: 0.9375rem;
    margin-top: 1rem;
  }
  
  .redeem-section {
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .redeem-section h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
  }
  
  .redeem-desc {
    color: #666;
    margin: 0 0 1.25rem 0;
    font-size: 0.9375rem;
  }
  
  .code-input-group {
    display: flex;
    gap: 1rem;
  }
  
  .code-input-group input {
    flex: 1;
    padding: 0.875rem 1rem;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 1rem;
    font-family: 'Monaco', 'Consolas', monospace;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    text-align: center;
  }
  
  .code-input-group input:focus {
    outline: none;
    border-color: #000;
  }
  
  .redeem-btn {
    padding: 0.875rem 1.5rem;
    background: #dc2626;
    border: none;
    border-radius: 10px;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    min-width: 110px;
    transition: all 0.2s;
  }
  
  .redeem-btn:hover {
    background: #b91c1c;
  }
  
  .redeem-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
  
  .redeem-btn .spinner {
    width: 18px;
    height: 18px;
    border-width: 2px;
    border-top-color: #fff;
  }
  
  .redeem-error {
    color: #dc2626;
    font-size: 0.875rem;
    margin: 0.75rem 0 0 0;
    display: none;
  }
  
  .redeem-success {
    color: #059669;
    font-size: 0.875rem;
    margin: 0.75rem 0 0 0;
    display: none;
  }
  
  .transactions-section {
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .transactions-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
  }
  
  .transactions-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f9f9f9;
    border-radius: 8px;
    border-left: 4px solid #ddd;
  }
  
  .transaction-item.credit {
    border-left-color: #10b981;
  }
  
  .transaction-item.debit {
    border-left-color: #ef4444;
  }
  
  .transaction-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .transaction-desc {
    font-weight: 500;
    font-size: 0.9375rem;
  }
  
  .transaction-date {
    color: #888;
    font-size: 0.8125rem;
  }
  
  .transaction-amount {
    font-weight: 700;
    font-size: 1.125rem;
  }
  
  .transaction-amount.positive {
    color: #059669;
  }
  
  .transaction-amount.negative {
    color: #dc2626;
  }
  
  .get-credit-cta {
    text-align: center;
  }
  
  .cta-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    border-radius: 10px;
    transition: all 0.2s;
  }
  
  .cta-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  }
  
  .cta-icon {
    font-size: 1.25rem;
  }
  
  @media (max-width: 600px) {
    .code-input-group {
      flex-direction: column;
    }
    
    .redeem-btn {
      width: 100%;
    }
    
    .balance-amount {
      font-size: 3rem;
    }
    
    .transaction-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .transaction-amount {
      align-self: flex-end;
    }
  }
  
  /* Stats Grid - Full Width */
  .stats-grid-full {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    background: #fff;
    padding: 1.5rem 1rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  
  .stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    color: #000;
    line-height: 1;
    margin-bottom: 0.5rem;
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
  }
  
  /* Sections */
  .section {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .section-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    margin: 0;
    color: #dc2626;
  }
  
  .view-all-btn {
    background: none;
    border: none;
    color: #2563eb;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
  }
  
  /* Orders List */
  .orders-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .order-card {
    display: block;
    padding: 1.25rem;
    background: #fafafa;
    border: 2px solid #eee;
    border-radius: 12px;
    transition: all 0.2s;
    text-decoration: none;
    color: inherit;
  }
  
  .order-card:hover {
    border-color: #000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid #e5e5e5;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .order-header-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .order-number {
    font-weight: 700;
    font-size: 1.125rem;
    color: #000;
  }
  
  .order-date {
    font-size: 0.9375rem;
    color: #666;
  }
  
  .order-header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.375rem;
  }
  
  .order-total {
    font-weight: 700;
    font-size: 1.25rem;
    color: #000;
  }
  
  .order-status {
    display: inline-block;
    padding: 0.3125rem 0.875rem;
    border-radius: 20px;
    font-size: 0.8125rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  
  .status-completed { background: #d1fae5; color: #059669; }
  .status-processing { background: #fef3c7; color: #d97706; }
  .status-shipped { background: #dbeafe; color: #2563eb; }
  
  /* Order Items Grid */
  .order-items {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .order-item {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.625rem;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e8e8e8;
  }
  
  .order-item-image {
    width: 48px;
    height: 48px;
    border-radius: 6px;
    object-fit: cover;
    background: #eee;
    flex-shrink: 0;
  }
  
  .order-item-details {
    flex: 1;
    min-width: 0;
  }
  
  .order-item-name {
    font-weight: 600;
    font-size: 1rem;
    color: #000;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .order-item-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.125rem;
  }
  
  .order-item-type {
    display: inline-block;
    padding: 0.1875rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    border-radius: 4px;
    letter-spacing: 0.02em;
  }
  
  .order-item-type.digital { background: #d1fae5; color: #059669; }
  .order-item-type.vinyl { background: #f3f4f6; color: #374151; }
  .order-item-type.merch { background: #e0e7ff; color: #4338ca; }
  .order-item-type.track { background: #fef3c7; color: #d97706; }
  
  .order-item-qty {
    font-size: 0.875rem;
    color: #888;
  }
  
  .order-item-price {
    font-weight: 600;
    font-size: 1rem;
    color: #000;
    flex-shrink: 0;
  }
  
  .order-view-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: #000;
    color: #fff;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.2s;
  }
  
  .order-view-link:hover {
    background: #333;
  }
  
  /* Empty State - Light text on dark background */
  .section .empty-state p,
  .orders-list .empty-state p,
  .downloads-list .empty-state p {
    margin: 0 0 1.5rem 0;
    color: #fff !important;
    font-size: 1.0625rem;
  }
  
  .empty-state .start-shopping-btn {
    display: inline-block !important;
    padding: 0.75rem 1.5rem !important;
    background: #dc2626 !important;
    color: #fff !important;
    font-weight: 600 !important;
    border-radius: 8px !important;
    text-decoration: none !important;
    transition: background 0.2s;
  }
  
  .empty-state .start-shopping-btn:hover {
    background: #b91c1c !important;
  }
  
  /* Avatar Upload Section */
  .avatar-upload-section {
    display: flex;
    align-items: flex-start;
    gap: 2rem;
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .avatar-preview-large {
    width: 120px;
    height: 120px;
    min-width: 120px;
    border-radius: 50%;
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: 700;
    color: #fff;
    overflow: hidden;
    border: 4px solid #e5e7eb;
    position: relative;
  }
  
  .avatar-preview-large.is-pro {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    border-color: #dc2626;
  }
  
  .avatar-preview-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .avatar-upload-controls {
    flex: 1;
  }
  
  .avatar-upload-controls h3 {
    font-size: 1.25rem;
    margin: 0 0 0.5rem 0;
    color: #111;
  }
  
  .avatar-hint {
    color: #666;
    font-size: 0.9375rem;
    margin: 0 0 1rem 0;
  }
  
  .avatar-buttons {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  
  .btn-upload {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: #000;
    color: #fff;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-upload:hover {
    background: #333;
  }
  
  .btn-remove {
    padding: 0.75rem 1.25rem;
    background: #fff;
    color: #dc2626;
    border: 2px solid #dc2626;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-remove:hover {
    background: #dc2626;
    color: #fff;
  }
  
  .avatar-specs {
    font-size: 0.8125rem;
    color: #888;
    margin: 0;
  }
  
  .avatar-status {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .avatar-status.success {
    color: #10b981;
  }
  
  .avatar-status.error {
    color: #dc2626;
  }
  
  .avatar-status.uploading {
    color: #3b82f6;
  }
  
  @media (max-width: 600px) {
    .avatar-upload-section {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .avatar-buttons {
      justify-content: center;
    }
  }
  
  /* Profile Form */
  .profile-form {
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-bottom: 1.25rem;
  }
  
  .form-group {
    margin-bottom: 1.25rem;
  }
  
  .form-row .form-group {
    margin-bottom: 0;
  }
  
  .form-group label {
    display: block;
    font-size: 0.9375rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .form-group input {
    width: 100%;
    padding: 0.875rem 1.125rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1.125rem;
    transition: border-color 0.2s;
  }
  
  .form-group input:focus {
    outline: none;
    border-color: #000;
  }
  
  .form-group input[readonly] {
    background: #f5f5f5;
    color: #888;
  }
  
  .field-hint {
    font-size: 0.85rem;
    color: #888;
    margin-top: 0.5rem;
  }
  
  .save-btn {
    padding: 1rem 2.5rem;
    background: #2563eb;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .save-btn:hover { background: #1d4ed8; }
  
  /* Address Section */
  .address-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid #eee;
    margin-bottom: 1.5rem;
  }
  
  .address-section h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    color: #000;
    margin: 0 0 0.25rem 0;
  }
  
  .address-hint {
    font-size: 1rem;
    color: #888;
    margin: 0 0 1.25rem 0;
  }
  
  .postcode-lookup {
    margin-bottom: 1.25rem;
    padding: 1.25rem;
    background: #f9f9f9;
    border-radius: 8px;
    border: 2px solid #eee;
  }
  
  .lookup-btn {
    padding: 0.875rem 1.5rem;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
  }
  
  .lookup-btn:hover { background: #333; }
  .lookup-btn:disabled { background: #999; cursor: not-allowed; }
  
  .lookup-error {
    color: #dc2626;
    font-size: 0.9375rem;
    margin-top: 0.5rem;
  }
  
  .lookup-success {
    color: #16a34a;
    font-size: 0.9375rem;
    margin-top: 0.5rem;
  }
  
  .form-group select {
    width: 100%;
    padding: 0.875rem 1.125rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1.125rem;
    background: #fff;
    cursor: pointer;
  }
  
  .form-group select:focus {
    outline: none;
    border-color: #000;
  }
  
  /* Danger Zone */
  .danger-zone {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid #e5e5e5;
  }
  
  .danger-zone h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.25rem;
    color: #333;
    margin: 0 0 1rem 0;
  }
  
  .danger-zone-content {
    background: #fafafa;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 1.5rem;
  }
  
  .data-section {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }
  
  .data-section svg {
    flex-shrink: 0;
    color: #22c55e;
  }
  
  .data-section strong {
    display: block;
    font-size: 1rem;
    color: #333;
    margin-bottom: 0.375rem;
  }
  
  .data-section p {
    font-size: 0.875rem;
    color: #666;
    margin: 0;
    line-height: 1.5;
  }
  
  .download-data-btn {
    background: #22c55e;
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .download-data-btn:hover {
    background: #16a34a;
  }
  
  .danger-divider {
    height: 2px;
    background: #fecaca;
    margin: 1.5rem 0;
  }
  
  .danger-warning {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }
  
  .danger-warning svg {
    flex-shrink: 0;
    color: #dc2626;
  }
  
  .danger-warning strong {
    display: block;
    font-size: 1rem;
    color: #991b1b;
    margin-bottom: 0.375rem;
  }
  
  .danger-warning p {
    font-size: 0.875rem;
    color: #7f1d1d;
    margin: 0;
    line-height: 1.5;
  }
  
  .delete-account-btn {
    background: #dc2626;
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .delete-account-btn:hover {
    background: #b91c1c;
  }
  
  /* Download Data Modal */
  .download-modal {
    max-width: 560px;
    padding: 2rem;
    max-height: 85vh;
    overflow-y: auto;
  }
  
  .download-modal h2 {
    margin: 0 0 0.5rem 0;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    color: #000;
  }
  
  .modal-description {
    color: #666;
    margin-bottom: 1.5rem;
  }
  
  .download-section {
    margin-bottom: 1.5rem;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    overflow: hidden;
  }
  
  .section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f5f5f5;
    font-weight: 600;
    font-size: 0.9375rem;
    color: #333;
    border-bottom: 1px solid #e5e5e5;
  }
  
  .section-title svg {
    color: #666;
  }
  
  .section-title span {
    flex: 1;
  }
  
  .toggle-all-btn {
    padding: 0.25rem 0.75rem;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .toggle-all-btn:hover {
    background: #f0f0f0;
  }
  
  .downloads-list-container {
    max-height: 180px;
    overflow-y: auto;
    padding: 0.75rem;
  }
  
  .loading-placeholder {
    padding: 1rem;
    text-align: center;
    color: #999;
    font-size: 0.875rem;
  }
  
  .empty-downloads {
    padding: 1rem;
    text-align: center;
    color: #999;
    font-size: 0.875rem;
  }
  
  .download-option {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  
  .download-option:last-child {
    margin-bottom: 0;
  }
  
  .download-option:hover {
    background: #f8f8f8;
    border-color: #22c55e;
    box-shadow: 0 2px 6px rgba(34, 197, 94, 0.15);
  }
  
  .download-option input {
    display: none;
  }
  
  .option-check {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 4px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-top: 2px;
  }
  
  .download-option input:checked + .option-check {
    background: #22c55e;
    border-color: #22c55e;
  }
  
  .download-option input:checked + .option-check::after {
    content: '‚úì';
    color: #fff;
    font-size: 12px;
    font-weight: bold;
  }
  
  .option-info {
    flex: 1;
    min-width: 0;
  }
  
  .option-info strong {
    display: block;
    font-size: 0.875rem;
    color: #333;
    margin-bottom: 0.125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .option-info span {
    font-size: 0.75rem;
    color: #888;
  }
  
  .option-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.375rem;
  }
  
  .option-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.1875rem 0.5rem;
    background: #e5e5e5;
    border-radius: 4px;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #666;
    white-space: nowrap;
  }
  
  .option-badge.audio { background: #dcfce7; color: #166534; }
  .option-badge.artwork { background: #dbeafe; color: #1e40af; }
  .option-badge.mix { background: #fef3c7; color: #92400e; }

  .modal-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e5e5;
  }
  
  .cancel-btn {
    padding: 0.875rem 1.5rem;
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .cancel-btn:hover {
    background: #e5e5e5;
  }

  .confirm-download-btn {
    background: #22c55e;
    color: #fff;
    border: none;
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .confirm-download-btn:hover {
    background: #16a34a;
  }
  
  .confirm-download-btn:disabled {
    background: #86efac;
    cursor: not-allowed;
  }
  
  /* Modal Overlay */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 1rem;
  }
  
  .modal-overlay.hidden {
    display: none;
  }
  
  .modal-content {
    background: #fff;
    border-radius: 16px;
    max-width: 480px;
    width: 100%;
    padding: 2rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlide 0.2s ease-out;
  }
  
  @keyframes modalSlide {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .modal-header {
    text-align: center;
    padding: 2rem 2rem 1rem;
  }
  
  .modal-header svg {
    margin-bottom: 1rem;
  }
  
  .modal-header h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    color: #dc2626;
    margin: 0;
  }
  
  .modal-body {
    padding: 0 2rem 1.5rem;
  }
  
  .modal-warning {
    text-align: center;
    font-size: 1rem;
    color: #374151;
    margin: 0 0 1.25rem 0;
  }
  
  .modal-list {
    background: #fef2f2;
    border-radius: 8px;
    padding: 1rem 1rem 1rem 2rem;
    margin: 0 0 1.5rem 0;
  }
  
  .modal-list li {
    font-size: 0.875rem;
    color: #991b1b;
    margin-bottom: 0.5rem;
  }
  
  .modal-list li:last-child {
    margin-bottom: 0;
  }
  
  .confirm-delete {
    margin-top: 1.25rem;
  }
  
  .confirm-delete label {
    display: block;
    font-size: 0.875rem;
    color: #374151;
    margin-bottom: 0.5rem;
  }
  
  .confirm-delete input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  .confirm-delete input:focus {
    outline: none;
    border-color: #dc2626;
  }
  
  .modal-footer {
    display: flex;
    gap: 0.75rem;
    padding: 0 2rem 2rem;
  }
  
  .modal-btn {
    flex: 1;
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .modal-btn.cancel {
    background: #f3f4f6;
    color: #374151;
    border: 2px solid #e5e7eb;
  }
  
  .modal-btn.cancel:hover {
    background: #e5e7eb;
  }
  
  .modal-btn.delete {
    background: #dc2626;
    color: #fff;
    border: 2px solid #dc2626;
  }
  
  .modal-btn.delete:hover:not(:disabled) {
    background: #b91c1c;
    border-color: #b91c1c;
  }
  
  .modal-btn.delete:disabled {
    background: #fca5a5;
    border-color: #fca5a5;
    cursor: not-allowed;
  }
  
  .modal-btn.delete.deleting {
    background: #991b1b;
    cursor: wait;
  }

  #panel-orders h2,
  #panel-downloads h2,
  #panel-profile h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    margin: 0 0 1.5rem 0;
    color: #000;
  }
  
  /* Downloads */
  .downloads-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .section-header-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .btn-secondary-sm {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 2px solid #4b5563;
    color: #fff;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }
  
  .btn-secondary-sm:hover {
    border-color: #fff;
    background: rgba(255,255,255,0.1);
  }
  
  /* Following Artists Grid */
  .following-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1.25rem;
  }
  
  .following-card {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    border: 2px solid #374151;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s;
    text-align: center;
    padding: 1.5rem;
  }
  
  .following-card:hover {
    border-color: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  
  .following-card-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 1rem;
    border: 3px solid #dc2626;
  }
  
  .following-card-name {
    font-size: 1.125rem;
    font-weight: 700;
    color: #fff;
    margin: 0 0 0.25rem 0;
  }
  
  .following-card-releases {
    font-size: 0.875rem;
    color: #9ca3af;
    margin: 0 0 0.75rem 0;
  }
  
  .following-card-latest {
    background: #374151;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .following-card-latest-label {
    font-size: 0.6875rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }
  
  .following-card-latest-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .following-card-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .following-btn-view {
    flex: 1;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 2px solid #4b5563;
    color: #fff;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    text-align: center;
  }
  
  .following-btn-view:hover {
    border-color: #fff;
    background: rgba(255,255,255,0.1);
  }
  
  .following-btn-unfollow {
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 2px solid #dc2626;
    color: #dc2626;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .following-btn-unfollow:hover {
    background: #dc2626;
    color: #fff;
  }
  
  .download-card {
    background: #fff;
    border: 2px solid #eee;
    border-radius: 12px;
    padding: 1.25rem;
    transition: border-color 0.2s;
  }
  
  .download-card:hover {
    border-color: #000;
  }
  
  .download-header {
    display: grid;
    grid-template-columns: 56px 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .download-art {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    object-fit: cover;
    background: #eee;
  }
  
  .download-info h4 {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0 0 0.25rem 0;
  }
  
  .download-info p {
    font-size: 0.875rem;
    color: #888;
    margin: 0;
    text-transform: uppercase;
  }
  
  .track-list {
    background: #f8f8f8;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .track-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    border-bottom: 1px solid #eee;
    gap: 1rem;
  }
  
  .track-row:last-child { border-bottom: none; }
  
  .track-name {
    font-size: 1rem;
    font-weight: 500;
    color: #333;
  }
  
  .track-name .num {
    display: inline-block;
    width: 24px;
    color: #999;
  }
  
  .dl-buttons {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .dl-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  
  .dl-btn svg { width: 14px; height: 14px; }
  
  .dl-btn.mp3 { background: #22c55e; color: #fff; }
  .dl-btn.mp3:hover { background: #16a34a; }
  
  .dl-btn.wav { background: #333; color: #fff; }
  .dl-btn.wav:hover { background: #000; }
  
  .dl-btn.art { background: #2563eb; color: #fff; }
  .dl-btn.art:hover { background: #1d4ed8; }
  
  .dl-btn.downloading { opacity: 0.6; pointer-events: none; }
  
  .artwork-dl {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #eee;
  }
  
  /* Responsive - Tablet Landscape */
  @media (max-width: 1024px) {
    .dashboard-container {
      padding: 1.5rem 1rem;
    }
    
    .stats-grid-full {
      grid-template-columns: repeat(6, 1fr);
      gap: 0.75rem;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  /* Responsive - Tablet Portrait */
  @media (max-width: 768px) {
    .dashboard-container {
      padding: 1.25rem 1rem;
      max-width: 100%;
    }
    
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .dashboard-header h1 {
      font-size: 1.5rem;
    }
    
    .logout-btn {
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
    }
    
    .tab-nav {
      padding: 0.5rem;
      gap: 0.375rem;
      margin-bottom: 1.25rem;
    }
    
    .tab-btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
      border-width: 2px;
    }
    
    .stats-grid-full {
      grid-template-columns: repeat(6, 1fr);
      gap: 0.5rem;
    }
    
    .stats-grid-full .stat-card {
      padding: 0.625rem 0.375rem;
    }
    
    .stats-grid-full .stat-value {
      font-size: 1.375rem;
    }
    
    .stats-grid-full .stat-label {
      font-size: 0.5625rem;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .stat-card {
      padding: 1rem;
    }
    
    .stat-value {
      font-size: 1.5rem;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .order-card {
      padding: 1rem;
    }
    
    .order-header {
      margin-bottom: 0.875rem;
      padding-bottom: 0.75rem;
    }
    
    .order-item-image {
      width: 44px;
      height: 44px;
    }
    
    .download-card {
      padding: 1rem;
    }
    
    .download-art {
      width: 60px;
      height: 60px;
    }
    
    .mixes-list {
      flex-direction: column;
      gap: 1rem;
    }
    
    .mix-card-title {
      font-size: 1.25rem;
    }
  }
  
  /* Responsive - Mobile Large */
  @media (max-width: 600px) {
    .dashboard-container {
      padding: 1rem 0.75rem;
    }
    
    .dashboard-header h1 {
      font-size: 1.375rem;
    }
    
    .user-email {
      font-size: 0.8125rem;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .postcode-lookup {
      padding: 0.875rem;
    }
    
    .address-section h3 {
      font-size: 1.125rem;
    }
    
    .tab-nav {
      border-radius: 10px;
      -webkit-overflow-scrolling: touch;
    }
    
    .tab-btn {
      padding: 0.5rem 0.625rem;
      font-size: 0.75rem;
      gap: 0.25rem;
    }
    
    .badge {
      font-size: 0.6875rem;
      padding: 0.125rem 0.375rem;
    }
    
    .stats-grid-full {
      grid-template-columns: repeat(6, 1fr);
      gap: 0.25rem;
    }
    
    .stats-grid-full .stat-card {
      padding: 0.5rem 0.125rem;
      border-radius: 6px;
    }
    
    .stats-grid-full .stat-value {
      font-size: 1rem;
    }
    
    .stats-grid-full .stat-label {
      font-size: 0.4375rem;
    }
    
    .stats-grid {
      grid-template-columns: 1fr 1fr;
      gap: 0.625rem;
    }
    
    .stat-card {
      padding: 0.875rem;
      border-radius: 10px;
    }
    
    .stat-value {
      font-size: 1.375rem;
    }
    
    .stat-label {
      font-size: 0.6875rem;
    }
    
    .order-card {
      padding: 1rem;
    }
    
    .order-header {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .order-header-right {
      flex-direction: row;
      align-items: center;
      width: 100%;
      justify-content: space-between;
    }
    
    .order-number {
      font-size: 0.9375rem;
    }
    
    .order-date {
      font-size: 0.75rem;
    }
    
    .order-total {
      font-size: 1rem;
    }
    
    .order-status {
      font-size: 0.625rem;
      padding: 0.1875rem 0.5rem;
    }
    
    .order-item {
      padding: 0.5rem;
      gap: 0.75rem;
    }
    
    .order-item-image {
      width: 40px;
      height: 40px;
    }
    
    .order-item-name {
      font-size: 0.8125rem;
    }
    
    .order-item-type {
      font-size: 0.5625rem;
    }
    
    .order-item-price {
      font-size: 0.8125rem;
    }
    
    .order-view-link {
      padding: 0.5rem;
      font-size: 0.75rem;
    }
    
    .profile-form {
      padding: 1.25rem;
      border-radius: 10px;
    }
    
    .form-group label {
      font-size: 0.75rem;
    }
    
    .form-group input {
      padding: 0.625rem 0.875rem;
      font-size: 0.9375rem;
    }
    
    .save-btn {
      padding: 0.75rem 1.5rem;
      font-size: 0.9375rem;
    }
    
    .empty-state {
      padding: 2rem 1rem;
    }
    
    .download-card {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .download-art {
      width: 80px;
      height: 80px;
    }
    
    .download-info {
      width: 100%;
    }
    
    .download-actions {
      width: 100%;
      flex-wrap: wrap;
    }
    
    .dl-btn {
      flex: 1;
      min-width: 70px;
      justify-content: center;
      text-align: center;
    }
    
    /* Mix Cards Mobile */
    .mixes-list {
      flex-direction: column;
      gap: 1rem;
    }
    
    .mix-card {
      flex-direction: column;
    }
    
    .mix-card-artwork {
      width: 100%;
      min-width: 100%;
      height: 180px;
    }
    
    .mix-card-content {
      padding: 1rem;
    }
    
    .mix-card-title {
      font-size: 1.25rem;
    }
    
    .mix-card-stats {
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    
    /* Danger Zone Mobile */
    .danger-zone {
      margin-top: 2rem;
      padding-top: 1.5rem;
    }
    
    .danger-zone-content {
      padding: 1.25rem;
    }
    
    .danger-warning {
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .danger-warning p {
      font-size: 0.8125rem;
    }
    
    .delete-account-btn {
      width: 100%;
    }
    
    /* Modal Mobile */
    .modal-content {
      margin: 0.5rem;
      max-height: calc(100vh - 2rem);
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 1.5rem 1.5rem 1rem;
    }
    
    .modal-header h3 {
      font-size: 1.5rem;
    }
    
    .modal-body {
      padding: 0 1.5rem 1.25rem;
    }
    
    .modal-footer {
      padding: 0 1.5rem 1.5rem;
      flex-direction: column;
    }
    
    .modal-btn {
      width: 100%;
    }
  }
  
  /* Responsive - Mobile Small */
  @media (max-width: 400px) {
    .dashboard-container {
      padding: 0.75rem 0.5rem;
    }
    
    .dashboard-header h1 {
      font-size: 1.25rem;
    }
    
    .tab-btn {
      padding: 0.375rem 0.5rem;
      font-size: 0.6875rem;
    }
    
    .stats-grid {
      gap: 0.5rem;
    }
    
    .stat-card {
      padding: 0.75rem;
    }
    
    .stat-value {
      font-size: 1.25rem;
    }
    
    .order-card,
    .download-card {
      padding: 0.875rem;
    }
    
    .profile-form {
      padding: 1rem;
    }
    
    .form-group input {
      padding: 0.5rem 0.75rem;
    }
  }
  
  /* Touch-friendly improvements */
  @media (hover: none) and (pointer: coarse) {
    .tab-btn,
    .logout-btn,
    .save-btn,
    .dl-btn,
    .order-view-link {
      min-height: 44px;
    }
    
    .order-card,
    .download-card {
      cursor: pointer;
    }
  }
  
  /* DJ Mixes Section */
  .section-header-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .section-header-flex h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    letter-spacing: 0.02em;
    margin: 0;
    text-transform: uppercase;
  }
  
  .btn-primary-sm {
    display: inline-block;
    background: #000;
    color: #fff;
    padding: 0.625rem 1.25rem;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
  }
  
  .btn-primary-sm:hover {
    background: #dc2626;
  }
  
  .mixes-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-mini {
    background: #f5f5f5;
    padding: 1.25rem 2rem;
    text-align: center;
    border: 1px solid #e5e5e5;
  }
  
  .stat-mini .stat-value {
    display: block;
    font-size: 1.75rem;
    font-weight: 700;
  }
  
  .stat-mini .stat-label {
    font-size: 0.8rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .mixes-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  
  /* Mix Card - Dashboard variant (horizontal layout) */
  .mix-card {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .mix-card:hover {
    transform: translateY(-2px);
    border-color: #dc2626;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }
  
  .mix-card-artwork {
    width: 180px;
    min-width: 180px;
    height: 180px;
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    overflow: hidden;
    flex-shrink: 0;
  }
  
  .mix-card-artwork img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .mix-card:hover .mix-card-artwork img {
    transform: scale(1.05);
  }
  
  .mix-artwork-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
    color: #fff;
    font-size: 2.5rem;
  }
  
  .mix-card-content {
    flex: 1;
    padding: 1.25rem 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 0.5rem;
    min-width: 0;
  }
  
  .mix-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .mix-card-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    color: #dc2626;
    margin: 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: 0.02em;
  }
  
  .mix-card-dj {
    font-size: 0.9rem;
    color: #374151;
    margin: 0;
    font-weight: 500;
  }
  
  .mix-card-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.25rem;
  }
  
  .mix-stat {
    font-size: 0.85rem;
    color: #6b7280;
  }
  
  .mix-stat.mix-rating {
    color: #f59e0b;
    font-weight: 600;
  }
  
  .mix-card-btn {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    background: #000;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    transition: background 0.2s;
    width: fit-content;
  }
  
  .mix-card-btn:hover {
    background: #dc2626;
  }
  
  .mix-chart-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 700;
    white-space: nowrap;
  }
  
  .mix-comment-preview {
    font-size: 0.7rem;
    color: #666;
    font-style: italic;
    margin-top: 0.25rem;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .mix-card-btn {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: #000;
    color: #fff;
    text-align: center;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.75rem;
    border-radius: 6px;
    transition: background 0.2s;
  }
  
  .mix-card-btn:hover {
    background: #dc2626;
  }
  
  /* Legacy mix-item styles (keep for compatibility) */
  .mix-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #fff;
    border: 2px solid #eee;
    border-radius: 12px;
    transition: all 0.2s;
  }
  
  .mix-item:hover {
    border-color: #dc2626;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
  }
  
  .mix-image {
    width: 70px;
    height: 70px;
    flex-shrink: 0;
    background: #eee;
    overflow: hidden;
    border-radius: 8px;
  }
  
  .mix-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .mix-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a1a, #333);
    color: #fff;
    font-size: 1.75rem;
  }
  
  .mix-info {
    flex: 1;
    min-width: 0;
  }
  
  .mix-info h4 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #000;
  }
  
  .mix-dj {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 0.375rem;
  }
  
  .mix-stats-small {
    font-size: 0.8125rem;
    color: #888;
    display: flex;
    gap: 1rem;
  }
  
  .mix-stats-small span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .mix-link {
    color: #fff;
    background: #dc2626;
    text-decoration: none;
    font-size: 0.8125rem;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    white-space: nowrap;
    transition: background 0.2s;
  }
  
  .mix-link:hover {
    background: #b91c1c;
  }
  
  .mixes-cta {
    margin-top: 1.5rem;
    text-align: center;
  }
  
  .btn-secondary {
    display: inline-block;
    background: #fff;
    color: #000;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    text-decoration: none;
    border: 2px solid #000;
  }
  
  .btn-secondary:hover {
    background: #000;
    color: #fff;
  }
  
  .empty-state-mixes {
    text-align: center;
    padding: 3rem 1rem;
    background: #f9f9f9;
    border: 1px dashed #ccc;
  }
  
  .empty-state-mixes .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .empty-state-mixes h3 {
    margin-bottom: 0.5rem;
  }
  
  .empty-state-mixes p {
    color: #666;
    margin-bottom: 1rem;
  }

  /* Pro Dashboard Button */
  .dashboard-header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .pro-dashboard-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: linear-gradient(135deg, #dc2626, #991b1b);
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.85rem;
    border: none;
    transition: all 0.2s;
  }
  
  .pro-dashboard-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
  }
  
  .pro-dashboard-btn.disabled {
    background: #e5e5e5;
    color: #999;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  .pro-dashboard-btn.disabled:hover {
    transform: none;
    box-shadow: none;
  }
  
  .pro-icon {
    font-size: 1rem;
  }
  
  .pro-dashboard-btn.disabled .pro-icon {
    opacity: 0.5;
  }
</style>

<!-- Global styles for dynamically generated order content -->
<style is:global>
  .orders-list .order-card {
    display: block;
    padding: 1.25rem;
    background: #fafafa;
    border: 2px solid #eee;
    border-radius: 12px;
    transition: all 0.2s;
    text-decoration: none;
    color: inherit;
    margin-bottom: 1rem;
  }
  
  .orders-list .order-card:last-child {
    margin-bottom: 0;
  }
  
  .orders-list .order-card:hover {
    border-color: #000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  
  .orders-list .order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid #e5e5e5;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .orders-list .order-header-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .orders-list .order-number {
    font-weight: 700;
    font-size: 1rem;
    color: #000;
  }
  
  .orders-list .order-date {
    font-size: 0.8125rem;
    color: #666;
  }
  
  .orders-list .order-header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.375rem;
  }
  
  .orders-list .order-total {
    font-weight: 700;
    font-size: 1.125rem;
    color: #000;
  }
  
  .orders-list .order-status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  
  .orders-list .status-completed { background: #d1fae5; color: #059669; }
  .orders-list .status-processing { background: #fef3c7; color: #d97706; }
  .orders-list .status-shipped { background: #dbeafe; color: #2563eb; }
  
  .orders-list .order-items {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .orders-list .order-item {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.625rem;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e8e8e8;
  }
  
  .orders-list .order-item-image {
    width: 48px;
    height: 48px;
    min-width: 48px;
    min-height: 48px;
    max-width: 48px;
    max-height: 48px;
    border-radius: 6px;
    object-fit: cover;
    background: #eee;
    flex-shrink: 0;
  }
  
  .orders-list .order-item-details {
    flex: 1;
    min-width: 0;
  }
  
  .orders-list .order-item-name {
    font-weight: 600;
    font-size: 0.875rem;
    color: #000;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .orders-list .order-item-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.125rem;
  }
  
  .orders-list .order-item-type {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    border-radius: 4px;
    letter-spacing: 0.02em;
  }
  
  .orders-list .order-item-type.digital { background: #d1fae5; color: #059669; }
  .orders-list .order-item-type.vinyl { background: #f3f4f6; color: #374151; }
  .orders-list .order-item-type.merch { background: #e0e7ff; color: #4338ca; }
  .orders-list .order-item-type.track { background: #fef3c7; color: #d97706; }
  
  .orders-list .order-item-qty {
    font-size: 0.75rem;
    color: #888;
  }
  
  .orders-list .order-item-price {
    font-weight: 600;
    font-size: 0.875rem;
    color: #000;
    flex-shrink: 0;
  }
  
  .orders-list .order-view-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    margin-top: 1rem;
    padding: 0.625rem;
    background: #000;
    color: #fff;
    border-radius: 8px;
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.2s;
  }
  
  .orders-list .order-view-link:hover {
    background: #333;
  }
  
  /* Responsive - Tablet */
  @media (max-width: 768px) {
    .orders-list .order-card {
      padding: 1rem;
    }
    
    .orders-list .order-header {
      margin-bottom: 0.875rem;
      padding-bottom: 0.75rem;
    }
    
    .orders-list .order-item-image {
      width: 44px;
      height: 44px;
      min-width: 44px;
      min-height: 44px;
      max-width: 44px;
      max-height: 44px;
    }
  }
  
  /* Responsive - Mobile */
  @media (max-width: 600px) {
    .orders-list .order-card {
      padding: 1rem;
    }
    
    .orders-list .order-header {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .orders-list .order-header-right {
      flex-direction: row;
      align-items: center;
      width: 100%;
      justify-content: space-between;
    }
    
    .orders-list .order-number {
      font-size: 0.9375rem;
    }
    
    .orders-list .order-date {
      font-size: 0.75rem;
    }
    
    .orders-list .order-total {
      font-size: 1rem;
    }
    
    .orders-list .order-status {
      font-size: 0.625rem;
      padding: 0.1875rem 0.5rem;
    }
    
    .orders-list .order-item {
      padding: 0.5rem;
      gap: 0.75rem;
    }
    
    .orders-list .order-item-image {
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      max-width: 40px;
      max-height: 40px;
    }
    
    .orders-list .order-item-name {
      font-size: 0.8125rem;
    }
    
    .orders-list .order-item-type {
      font-size: 0.5625rem;
    }
    
    .orders-list .order-item-price {
      font-size: 0.8125rem;
    }
    
    .orders-list .order-view-link {
      padding: 0.5rem;
      font-size: 0.75rem;
    }
  }
  
  /* Small Mobile */
  @media (max-width: 400px) {
    .orders-list .order-card {
      padding: 0.875rem;
    }
    
    .orders-list .order-item-image {
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      max-width: 36px;
      max-height: 36px;
    }
  }
  
  /* Downloads List Global Styles */
  .downloads-list .download-card {
    background: #fff;
    border: 2px solid #eee;
    border-radius: 12px;
    padding: 1.5rem;
    transition: border-color 0.2s;
    margin-bottom: 1rem;
  }
  
  .downloads-list .download-card:last-child {
    margin-bottom: 0;
  }
  
  .downloads-list .download-card:hover {
    border-color: #000;
  }
  
  .downloads-list .download-header {
    display: grid;
    grid-template-columns: 64px 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .downloads-list .download-art {
    width: 64px;
    height: 64px;
    min-width: 64px;
    min-height: 64px;
    max-width: 64px;
    max-height: 64px;
    border-radius: 8px;
    object-fit: cover;
    background: #eee;
  }
  
  .downloads-list .download-info h4 {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0 0 0.375rem 0;
    color: #000;
  }
  
  .downloads-list .download-info p {
    font-size: 0.875rem;
    color: #666;
    margin: 0;
    text-transform: uppercase;
  }
  
  .downloads-list .track-list {
    background: #f8f8f8;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .downloads-list .track-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #eee;
    gap: 1rem;
  }
  
  .downloads-list .track-row:last-child { 
    border-bottom: none; 
  }
  
  .downloads-list .track-name {
    font-size: 1rem;
    font-weight: 500;
    color: #333;
  }
  
  .downloads-list .track-name .num {
    display: inline-block;
    width: 28px;
    color: #999;
    font-weight: 600;
  }
  
  .downloads-list .dl-buttons {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .downloads-list .dl-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  
  .downloads-list .dl-btn svg {
    width: 14px;
    height: 14px;
  }
  
  .downloads-list .dl-btn.mp3 {
    background: #22c55e;
    color: #fff;
  }
  
  .downloads-list .dl-btn.wav {
    background: #333;
    color: #fff;
  }
  
  .downloads-list .dl-btn.art {
    background: #2563eb;
    color: #fff;
  }
  
  .downloads-list .dl-btn:hover {
    transform: translateY(-1px);
  }
  
  .downloads-list .dl-btn.downloading {
    opacity: 0.6;
    pointer-events: none;
  }
  
  .downloads-list .artwork-dl {
    margin-bottom: 0.75rem;
  }
  
  /* Downloads Mobile */
  @media (max-width: 600px) {
    .downloads-list .download-card {
      padding: 1.25rem;
    }
    
    .downloads-list .download-header {
      grid-template-columns: 56px 1fr;
      gap: 0.875rem;
    }
    
    .downloads-list .download-art {
      width: 56px;
      height: 56px;
      min-width: 56px;
      min-height: 56px;
      max-width: 56px;
      max-height: 56px;
    }
    
    .downloads-list .download-info h4 {
      font-size: 1.0625rem;
    }
    
    .downloads-list .download-info p {
      font-size: 0.8125rem;
    }
    
    .downloads-list .track-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.625rem;
      padding: 0.875rem 1rem;
    }
    
    .downloads-list .track-name {
      font-size: 0.9375rem;
    }
    
    .downloads-list .dl-buttons {
      width: 100%;
    }
    
    .downloads-list .dl-btn {
      flex: 1;
      justify-content: center;
    }
  }
  
  /* Wishlist - horizontal card layout (global for dynamic content) */
  .wishlist-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .wishlist-card {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .wishlist-card:hover {
    border-color: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }
  
  .wishlist-card-artwork {
    position: relative;
    width: 140px;
    min-width: 140px;
    height: 140px;
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    overflow: hidden;
    flex-shrink: 0;
  }
  
  .wishlist-card-artwork img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .wishlist-card:hover .wishlist-card-artwork img {
    transform: scale(1.05);
  }
  
  .wishlist-card-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(0,0,0,0.7);
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s;
  }
  
  .wishlist-card:hover .wishlist-card-remove {
    opacity: 1;
  }
  
  .wishlist-card-remove:hover {
    background: #dc2626;
  }
  
  .wishlist-card-content {
    flex: 1;
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 0.25rem;
    min-width: 0;
  }
  
  .wishlist-card-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    color: #dc2626;
    margin: 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: 0.02em;
  }
  
  .wishlist-card-artist {
    font-size: 0.9rem;
    color: #374151;
    margin: 0;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .wishlist-card-meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin: 0.375rem 0;
  }
  
  .wishlist-card-tag {
    font-size: 0.6875rem;
    padding: 0.25rem 0.5rem;
    background: #f3f4f6;
    color: #374151;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
  
  .wishlist-card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .wishlist-btn-view {
    padding: 0.5rem 1rem;
    background: #000;
    border: none;
    color: #fff;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    text-align: center;
  }
  
  .wishlist-btn-view:hover {
    background: #dc2626;
  }
  
  .wishlist-btn-cart {
    padding: 0.5rem 1rem;
    background: #dc2626;
    border: none;
    color: #fff;
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .wishlist-btn-cart:hover {
    background: #b91c1c;
  }
  
  .wishlist-card-price {
    font-size: 0.875rem;
    font-weight: 700;
    color: #22c55e;
  }
  
  /* Wishlist Mobile */
  @media (max-width: 600px) {
    .wishlist-card {
      flex-direction: column;
    }
    
    .wishlist-card-artwork {
      width: 100%;
      min-width: 100%;
      height: 160px;
    }
    
    .wishlist-card-content {
      padding: 1rem;
    }
    
    .wishlist-card-title {
      font-size: 1.25rem;
    }
    
    .wishlist-card-actions {
      flex-wrap: wrap;
    }
    
    .wishlist-btn-view,
    .wishlist-btn-cart {
      flex: 1;
      min-width: 100px;
      text-align: center;
    }
  }
</style>

<script>
  import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
    authDomain: "freshwax-store.firebaseapp.com",
    projectId: "freshwax-store",
    storageBucket: "freshwax-store.firebasestorage.app",
    messagingSenderId: "675435782973",
    appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
  };

  // Initialize Firebase only once
  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let currentUser = null;
  let customerData = null;
  let orders = [];
  let authUnsubscribe = null;

  // Load customer data from Firestore (customers collection only)
  async function loadCustomerData(uid) {
    try {
      const customerDoc = await getDoc(doc(db, 'customers', uid));
      
      if (customerDoc.exists()) {
        const data = customerDoc.data();
        return {
          ...data,
          displayName: data.displayName || data.fullName || data.firstName || ''
        };
      }
      return {};
    } catch (e) {
      console.error('Error loading customer data:', e);
      return {};
    }
  }

  // Fetch orders via API
  async function fetchOrders(userId) {
    try {
      const response = await fetch(`/api/get-orders?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        return data.orders || [];
      } else {
        console.error('[Dashboard] API error:', data.error);
        return [];
      }
    } catch (error) {
      console.error('[Dashboard] Fetch error:', error);
      return [];
    }
  }

  // Fetch mixes via API
  let mixesLoaded = false;
  async function fetchMixes(userId) {
    if (mixesLoaded) return;
    
    const container = document.getElementById('mixesContainer');
    if (!container) return;
    
    try {
      const response = await fetch(`/api/get-dj-mixes?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success && data.mixes) {
        const mixes = data.mixes;
        mixesLoaded = true;
        
        // Update stats
        const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);
        const totalLikes = mixes.reduce((sum, m) => sum + (m.likes || 0), 0);
        
        const statMixes = document.getElementById('statMixes');
        const statMixPlays = document.getElementById('statMixPlays');
        const statMixLikes = document.getElementById('statMixLikes');
        
        if (statMixes) statMixes.textContent = mixes.length;
        if (statMixPlays) statMixPlays.textContent = totalPlays.toLocaleString();
        if (statMixLikes) statMixLikes.textContent = totalLikes.toLocaleString();
        
        if (mixes.length === 0) {
          container.innerHTML = `
            <div class="empty-state-mixes">
              <div class="empty-icon">üéß</div>
              <h3>No mixes yet</h3>
              <p>Upload your first DJ mix to share with the community.</p>
              <a href="/upload-mix" class="btn-primary-sm">Upload Mix</a>
            </div>
          `;
        } else {
          container.innerHTML = mixes.slice(0, 6).map(mix => {
            // Calculate rating score (weighted average of plays, likes, downloads)
            const plays = mix.plays || mix.playCount || 0;
            const likes = mix.likes || mix.likeCount || 0;
            const downloads = mix.downloads || mix.downloadCount || 0;
            // Handle comments - could be array or number
            const commentsArray = Array.isArray(mix.comments) ? mix.comments : [];
            const commentsCount = mix.commentCount || commentsArray.length || 0;
            const rating = Math.min(100, Math.round((plays * 0.3 + likes * 2 + downloads * 1.5 + commentsCount * 3) / 10)) || 0;
            const chartPosition = mix.chartPosition || '-';
            
            // Handle various field name formats from API
            const djName = mix.dj_name || mix.djName || mix.artist || 'Unknown DJ';
            const artworkUrl = mix.artwork_url || mix.artworkUrl || mix.artwork || mix.imageUrl || mix.coverUrl || '';
            const mixTitle = mix.title || mix.name || 'Untitled Mix';
            const genre = mix.genre || 'Jungle & D&B';
            
            // Fix duration - handle NaN, null, undefined, 0
            const rawDuration = mix.duration || mix.durationSeconds || mix.duration_seconds || 0;
            const durationNum = parseInt(rawDuration, 10);
            const durationDisplay = (durationNum && !isNaN(durationNum) && durationNum > 0) ? Math.floor(durationNum / 60) + ' mins' : '';
            
            // Get latest comment preview - only show if it has real text (min 3 chars, not just emoji)
            const latestComment = commentsArray.length > 0 ? commentsArray[commentsArray.length - 1] : null;
            let commentText = latestComment ? (latestComment.text || latestComment.comment || '') : '';
            // Strip emoji-only comments and very short ones
            const textOnly = commentText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
            const commentPreview = textOnly.length >= 3 ? commentText.substring(0, 80) : '';
            const commentAuthor = (commentPreview && latestComment) ? (latestComment.username || latestComment.author || 'Anonymous') : '';
            
            return `
            <div style="display: flex; flex-direction: row; align-items: stretch; background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 1.25rem;">
              <div style="width: 220px; min-width: 220px; height: 220px; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); overflow: hidden; flex-shrink: 0;">
                ${artworkUrl ? 
                  `<img src="${artworkUrl}" alt="${mixTitle}" style="width: 100%; height: 100%; object-fit: contain; background: #000;">` : 
                  '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%); color: #fff; font-size: 3.5rem;">üéß</div>'}
              </div>
              <div style="flex: 1; padding: 1.5rem 2rem; display: flex; flex-direction: column; justify-content: center; gap: 1rem; min-width: 0;">
                <div>
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.375rem; flex-wrap: wrap;">
                    <h4 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: #dc2626; margin: 0; line-height: 1.1; letter-spacing: 0.02em;">${mixTitle}</h4>
                    ${chartPosition !== '-' ? `<span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8125rem; font-weight: 600;">#${chartPosition}</span>` : ''}
                  </div>
                  <p style="font-size: 1.125rem; color: #374151; margin: 0; font-weight: 500;">by ${djName}</p>
                  <p style="font-size: 1rem; color: #6b7280; margin: 0.375rem 0 0 0;">${genre}${durationDisplay ? ' ‚Ä¢ ' + durationDisplay : ''}</p>
                </div>
                
                <div style="display: flex; gap: 1.75rem; flex-wrap: wrap; background: #f9fafb; padding: 0.875rem 1.25rem; border-radius: 8px; align-items: center;">
                  <div style="text-align: center; min-width: 55px;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #111827;">${plays.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Plays</div>
                  </div>
                  <div style="text-align: center; min-width: 55px;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">${likes.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Likes</div>
                  </div>
                  <div style="text-align: center; min-width: 55px;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #111827;">${downloads.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">DLs</div>
                  </div>
                  <div style="text-align: center; min-width: 55px;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #111827;">${commentsCount.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Cmts</div>
                  </div>
                  <div style="text-align: center; min-width: 55px;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">‚òÖ${rating}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase;">Score</div>
                  </div>
                  <div style="display: flex; gap: 0.75rem; margin-left: auto;">
                    <a href="/dj-mix/${mix.id}" style="display: inline-block; padding: 0.5rem 1rem; background: #000; color: #fff; font-size: 0.875rem; font-weight: 600; border-radius: 6px; text-decoration: none;">View Mix ‚Üí</a>
                    <a href="/dj-mix/${mix.id}#description" style="display: inline-block; padding: 0.5rem 1rem; background: #fff; color: #000; font-size: 0.875rem; font-weight: 600; border-radius: 6px; text-decoration: none; border: 2px solid #e5e7eb;">Edit Description</a>
                  </div>
                </div>
                
                ${commentPreview ? `
                <div style="background: #f3f4f6; padding: 0.75rem 1.25rem; border-radius: 8px; border-left: 3px solid #dc2626;">
                  <p style="font-size: 1rem; color: #374151; margin: 0; font-style: italic;">"${commentPreview}${commentPreview.length >= 80 ? '...' : ''}"</p>
                  <p style="font-size: 0.8125rem; color: #6b7280; margin: 0.375rem 0 0 0;">‚Äî ${commentAuthor}</p>
                </div>
                ` : ''}
              </div>
            </div>
          `;}).join('');
        }
      } else {
        container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Could not load mixes</p></div>';
      }
    } catch (error) {
      console.error('[Dashboard] Mixes fetch error:', error);
      container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Error loading mixes</p></div>';
    }
  }

  // Load wishlist count for badge (lightweight)
  async function loadWishlistCount(userId) {
    const badge = document.getElementById('wishlistBadge');
    if (!badge) return;
    
    try {
      const response = await fetch(`/api/wishlist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        const count = data.count || 0;
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
    } catch (err) {
      // Silent fail
    }
  }

  // Load wishlist
  let wishlistLoaded = false;
  async function loadWishlist(userId) {
    if (wishlistLoaded) return;
    
    const container = document.getElementById('wishlistContainer');
    const badge = document.getElementById('wishlistBadge');
    if (!container) return;
    
    container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Loading wishlist...</p></div>';
    
    try {
      const response = await fetch(`/api/wishlist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        wishlistLoaded = true;
        const wishlist = data.wishlist || [];
        
        // Update badge
        if (badge) {
          badge.textContent = wishlist.length;
          badge.style.display = wishlist.length > 0 ? 'inline-flex' : 'none';
        }
        
        if (wishlist.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">Your wishlist is empty</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          `;
        } else {
          container.innerHTML = wishlist.map(release => {
            const price = release.pricePerSale || release.pricing?.digital || 0;
            const vinylPrice = release.vinylPrice || release.vinyl?.price || release.pricing?.vinyl || 0;
            const hasVinyl = release.vinylRelease || release.vinyl?.available;
            const genre = release.genre || '';
            const labelCode = release.labelCode || '';
            
            return `
              <div class="wishlist-card" data-release-id="${release.id}">
                <div class="wishlist-card-artwork">
                  <a href="/item/${release.id}">
                    <img src="${release.coverArtUrl || '/logo.webp'}" alt="${release.releaseName}" loading="lazy" onerror="this.src='/logo.webp'">
                  </a>
                  <button class="wishlist-card-remove" data-release-id="${release.id}" title="Remove from wishlist">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
                <div class="wishlist-card-content">
                  <h4 class="wishlist-card-title" title="${release.releaseName}">${release.releaseName || 'Unknown'}</h4>
                  <p class="wishlist-card-artist" title="${release.artistName}">by ${release.artistName || 'Unknown Artist'}</p>
                  <div class="wishlist-card-meta">
                    ${genre ? `<span class="wishlist-card-tag">${genre}</span>` : ''}
                    ${labelCode ? `<span class="wishlist-card-tag">${labelCode}</span>` : ''}
                    ${hasVinyl ? `<span class="wishlist-card-tag" style="background:#dc2626;color:#fff;">Vinyl Available</span>` : ''}
                  </div>
                  <div class="wishlist-card-price">
                    ¬£${price.toFixed(2)}${hasVinyl ? ` <span style="color:#6b7280;font-weight:500;">‚Ä¢ Vinyl ¬£${vinylPrice.toFixed(2)}</span>` : ''}
                  </div>
                  <div class="wishlist-card-actions">
                    <a href="/item/${release.id}" class="wishlist-btn-view">View Release</a>
                    <button class="wishlist-btn-cart" data-release-id="${release.id}" data-price="${price}" data-title="${release.releaseName}" data-artist="${release.artistName}" data-artwork="${release.coverArtUrl || '/logo.webp'}">Add to Cart</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Attach remove handlers
          container.querySelectorAll('.wishlist-card-remove').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.preventDefault();
              const releaseId = btn.dataset.releaseId;
              const card = btn.closest('.wishlist-card');
              
              // Optimistic removal
              card.style.opacity = '0.5';
              card.style.pointerEvents = 'none';
              
              try {
                const res = await fetch('/api/wishlist', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    userId: userId,
                    releaseId: releaseId,
                    action: 'remove'
                  })
                });
                
                const result = await res.json();
                if (result.success) {
                  card.remove();
                  
                  // Update badge and check if empty
                  const remaining = container.querySelectorAll('.wishlist-card').length;
                  if (badge) {
                    badge.textContent = remaining;
                    badge.style.display = remaining > 0 ? 'inline' : 'none';
                  }
                  
                  if (remaining === 0) {
                    container.innerHTML = `
                      <div class="empty-state" style="grid-column: 1/-1;">
                        <p style="color: #fff; margin: 0 0 1.5rem 0;">Your wishlist is empty</p>
                        <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
                      </div>
                    `;
                  }
                } else {
                  card.style.opacity = '1';
                  card.style.pointerEvents = 'auto';
                }
              } catch (err) {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
              }
            });
          });
          
          // Attach add to cart handlers
          container.querySelectorAll('.wishlist-btn-cart').forEach(btn => {
            btn.addEventListener('click', () => {
              const releaseId = btn.dataset.releaseId;
              const price = parseFloat(btn.dataset.price) || 0;
              const title = btn.dataset.title;
              const artist = btn.dataset.artist;
              const artwork = btn.dataset.artwork;
              
              // Use existing cart system
              if (window.addToCart) {
                window.addToCart({
                  id: releaseId,
                  type: 'digital',
                  price: price,
                  title: title,
                  artist: artist,
                  artwork: artwork
                });
              } else if (window.FreshWaxCart && window.FreshWaxCart.add) {
                window.FreshWaxCart.add({
                  releaseId: releaseId,
                  productType: 'digital',
                  price: price,
                  title: title,
                  artist: artist,
                  artwork: artwork
                });
              } else {
                // Fallback: dispatch cart event
                window.dispatchEvent(new CustomEvent('add-to-cart', {
                  detail: {
                    releaseId: releaseId,
                    productType: 'digital',
                    price: price,
                    title: title,
                    artist: artist,
                    artwork: artwork
                  }
                }));
              }
              
              // Visual feedback
              btn.textContent = 'Added ‚úì';
              btn.style.background = '#16a34a';
              btn.style.borderColor = '#16a34a';
              setTimeout(() => {
                btn.textContent = 'Add to Cart';
                btn.style.background = '#dc2626';
                btn.style.borderColor = '#dc2626';
              }, 2000);
            });
          });
        }
      } else {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Could not load wishlist</p></div>';
      }
    } catch (error) {
      console.error('[Dashboard] Wishlist fetch error:', error);
      container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Error loading wishlist</p></div>';
    }
  }

  // Load following count for badge
  async function loadFollowingCount(userId) {
    const badge = document.getElementById('followingBadge');
    if (!badge) return;
    
    try {
      const response = await fetch(`/api/follow-artist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        const count = data.count || 0;
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
    } catch (err) {
      // Silent fail
    }
  }

  // Load followed artists
  let followingLoaded = false;
  async function loadFollowing(userId) {
    if (followingLoaded) return;
    
    const container = document.getElementById('followingContainer');
    const badge = document.getElementById('followingBadge');
    if (!container) return;
    
    container.innerHTML = '<div class="empty-state"><p style="color: #fff;">Loading artists...</p></div>';
    
    try {
      const response = await fetch(`/api/follow-artist?userId=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      if (data.success) {
        followingLoaded = true;
        const artists = data.followedArtists || [];
        
        // Update badge
        if (badge) {
          badge.textContent = artists.length;
          badge.style.display = artists.length > 0 ? 'inline-flex' : 'none';
        }
        
        if (artists.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <p style="color: #fff; margin: 0 0 1.5rem 0;">You're not following any artists yet</p>
              <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
            </div>
          `;
        } else {
          container.innerHTML = artists.map(artist => {
            const latestRelease = artist.latestRelease;
            const releaseCount = artist.releaseCount || 0;
            
            return `
              <div class="following-card" data-artist-name="${artist.artistName}">
                <img src="${artist.coverArtUrl || '/logo.webp'}" alt="${artist.artistName}" class="following-card-avatar" onerror="this.src='/logo.webp'">
                <h4 class="following-card-name">${artist.artistName}</h4>
                <p class="following-card-releases">${releaseCount} release${releaseCount !== 1 ? 's' : ''}</p>
                ${latestRelease ? `
                  <div class="following-card-latest">
                    <div class="following-card-latest-label">Latest Release</div>
                    <div class="following-card-latest-title" title="${latestRelease.releaseName}">${latestRelease.releaseName}</div>
                  </div>
                ` : ''}
                <div class="following-card-actions">
                  ${latestRelease ? `<a href="/item/${latestRelease.id}" class="following-btn-view">View Latest</a>` : '<a href="/releases" class="following-btn-view">Browse</a>'}
                  <button class="following-btn-unfollow" data-artist-name="${artist.artistName}">Unfollow</button>
                </div>
              </div>
            `;
          }).join('');
          
          // Attach unfollow handlers
          container.querySelectorAll('.following-btn-unfollow').forEach(btn => {
            btn.addEventListener('click', async () => {
              const artistName = btn.dataset.artistName;
              const card = btn.closest('.following-card');
              
              // Optimistic removal
              card.style.opacity = '0.5';
              card.style.pointerEvents = 'none';
              
              try {
                const res = await fetch('/api/follow-artist', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    userId: userId,
                    artistName: artistName,
                    action: 'unfollow'
                  })
                });
                
                const result = await res.json();
                if (result.success) {
                  card.remove();
                  
                  // Update badge and check if empty
                  const remaining = container.querySelectorAll('.following-card').length;
                  if (badge) {
                    badge.textContent = remaining;
                    badge.style.display = remaining > 0 ? 'inline' : 'none';
                  }
                  
                  if (remaining === 0) {
                    container.innerHTML = `
                      <div class="empty-state" style="grid-column: 1/-1;">
                        <p style="color: #fff; margin: 0 0 1.5rem 0;">You're not following any artists yet</p>
                        <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
                      </div>
                    `;
                  }
                } else {
                  card.style.opacity = '1';
                  card.style.pointerEvents = 'auto';
                }
              } catch (err) {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
              }
            });
          });
        }
      } else {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Could not load artists</p></div>';
      }
    } catch (error) {
      console.error('[Dashboard] Following fetch error:', error);
      container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p style="color: #fff;">Error loading artists</p></div>';
    }
  }

  // Check if user is an approved partner and enable Pro Dashboard button
  async function checkPartnerStatus(userId) {
    const proDashboardBtn = document.getElementById('proDashboardBtn');
    if (!proDashboardBtn) return;
    
    try {
      const response = await fetch(`/api/get-user-type?uid=${encodeURIComponent(userId)}`);
      const data = await response.json();
      
      
      if (data.success) {
        // Check if they're an approved artist or merch supplier
        const isApprovedPartner = data.isApproved && (data.roles?.artist || data.roles?.merchSupplier);
        
        if (isApprovedPartner) {
          // Enable the Pro Dashboard button
          proDashboardBtn.classList.remove('disabled');
          proDashboardBtn.title = 'Access your releases and merch';
          
          // Set partnerId cookie for pro dashboard
          document.cookie = `partnerId=${userId}; path=/; max-age=86400; SameSite=Lax`;
        } else if (data.roles?.artist || data.roles?.merchSupplier) {
          // They have roles but not approved yet
          proDashboardBtn.title = 'Pending approval - check back soon!';
        } else {
          // Just a customer/DJ
          proDashboardBtn.title = 'Available for approved artists & merch sellers';
        }
      }
    } catch (error) {
      console.error('[Dashboard] Error checking partner status:', error);
    }
  }

  // Update UI with user data
  function updateUI(user, data) {
    const loadingScreen = document.getElementById('loadingScreen');
    const mainContent = document.getElementById('mainContent');
    
    if (!loadingScreen || !mainContent) {
      return;
    }
    
    loadingScreen.classList.add('hidden');
    mainContent.classList.remove('hidden');
    
    // Prioritize displayName, then firstName, then name, then email
    let displayName = data?.displayName || data?.firstName || data?.name || user.email?.split('@')[0] || 'Customer';
    
    // Truncate to 30 characters max
    if (displayName.length > 30) {
      displayName = displayName.substring(0, 27) + '...';
    }
    
    const initial = displayName.charAt(0).toUpperCase();
    const isPro = data?.isPro || data?.isArtist || data?.approved || false;
    const avatarUrl = data?.avatarUrl || data?.photoURL || null;
    
    // Main header avatar
    const avatarEl = document.getElementById('avatarInitial');
    const userAvatarContainer = document.getElementById('userAvatar');
    
    if (avatarEl) avatarEl.textContent = initial;
    if (userAvatarContainer) {
      if (avatarUrl) {
        userAvatarContainer.innerHTML = `<img src="${avatarUrl}" alt="${displayName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      } else {
        userAvatarContainer.innerHTML = `<span id="avatarInitial">${initial}</span>`;
        if (isPro) {
          userAvatarContainer.classList.add('is-pro');
        }
      }
    }
    
    // Profile tab avatar preview
    const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
    const avatarInitialLarge = document.getElementById('avatarInitialLarge');
    const avatarImageLarge = document.getElementById('avatarImageLarge');
    const removeAvatarBtn = document.getElementById('removeAvatarBtn');
    
    if (avatarPreviewLarge) {
      if (avatarUrl) {
        if (avatarInitialLarge) avatarInitialLarge.classList.add('hidden');
        if (avatarImageLarge) {
          avatarImageLarge.src = avatarUrl;
          avatarImageLarge.classList.remove('hidden');
        }
        if (removeAvatarBtn) removeAvatarBtn.classList.remove('hidden');
        avatarPreviewLarge.classList.remove('is-pro');
      } else {
        if (avatarInitialLarge) {
          avatarInitialLarge.textContent = initial;
          avatarInitialLarge.classList.remove('hidden');
        }
        if (avatarImageLarge) avatarImageLarge.classList.add('hidden');
        if (removeAvatarBtn) removeAvatarBtn.classList.add('hidden');
        if (isPro) {
          avatarPreviewLarge.classList.add('is-pro');
        } else {
          avatarPreviewLarge.classList.remove('is-pro');
        }
      }
    }
    
    // Store isPro status for avatar upload
    window.userIsPro = isPro;
    window.currentAvatarUrl = avatarUrl;
    
    const welcomeEl = document.getElementById('welcomeName');
    const emailEl = document.getElementById('userEmail');
    
    if (welcomeEl) welcomeEl.innerHTML = `Welcome, <span class="name-highlight">${displayName}</span>`;
    if (emailEl) emailEl.textContent = user.email;
    
    // Profile form
    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const displayNameEl = document.getElementById('displayName');
    const emailInputEl = document.getElementById('email');
    const phoneEl = document.getElementById('phone');
    const address1El = document.getElementById('address1');
    const address2El = document.getElementById('address2');
    const cityEl = document.getElementById('city');
    const countyEl = document.getElementById('county');
    const postcodeEl = document.getElementById('postcode');
    const countryEl = document.getElementById('country');
    
    if (firstNameEl) firstNameEl.value = data?.firstName || '';
    if (lastNameEl) lastNameEl.value = data?.lastName || '';
    if (displayNameEl) displayNameEl.value = data?.displayName || displayName || '';
    if (emailInputEl) emailInputEl.value = user.email || '';
    if (phoneEl) phoneEl.value = data?.phone || '';
    if (address1El) address1El.value = data?.address1 || '';
    if (address2El) address2El.value = data?.address2 || '';
    if (cityEl) cityEl.value = data?.city || '';
    if (countyEl) countyEl.value = data?.county || '';
    if (postcodeEl) postcodeEl.value = data?.postcode || '';
    if (countryEl) countryEl.value = data?.country || 'United Kingdom';
  }

  // Render orders
  function renderOrders(ordersList, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (!ordersList || ordersList.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p style="color: #fff; margin: 0 0 1.5rem 0;">No orders yet</p>
          <a href="/" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Start Shopping</a>
        </div>
      `;
      return;
    }
    
    container.innerHTML = ordersList.map(order => {
      const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('en-GB', {
        day: 'numeric', month: 'short', year: 'numeric'
      }) : '';
      
      const statusClass = order.orderStatus === 'completed' ? 'status-completed' : 
                          order.orderStatus === 'shipped' ? 'status-shipped' : 'status-processing';
      const statusText = order.orderStatus ? order.orderStatus.charAt(0).toUpperCase() + order.orderStatus.slice(1) : 'Processing';
      
      const items = order.items || [];
      
      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-header-left">
              <div class="order-number">${order.orderNumber || 'Order'}</div>
              <div class="order-date">${orderDate}</div>
            </div>
            <div class="order-header-right">
              <div class="order-total">¬£${order.totals?.total?.toFixed(2) || '0.00'}</div>
              <span class="order-status ${statusClass}">${statusText}</span>
            </div>
          </div>
          
          <div class="order-items">
            ${items.map(item => {
              const itemType = item.type || item.productType || 'digital';
              const typeClass = itemType === 'vinyl' ? 'vinyl' : 
                               itemType === 'merch' ? 'merch' : 
                               itemType === 'track' ? 'track' : 'digital';
              return `
                <div class="order-item">
                  <img src="${item.image || '/logo.webp'}" alt="" class="order-item-image">
                  <div class="order-item-details">
                    <div class="order-item-name">${item.name || item.title || 'Item'}</div>
                    <div class="order-item-meta">
                      <span class="order-item-type ${typeClass}">${itemType}</span>
                      ${item.quantity > 1 ? `<span class="order-item-qty">√ó ${item.quantity}</span>` : ''}
                    </div>
                  </div>
                  <div class="order-item-price">¬£${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                </div>
              `;
            }).join('')}
          </div>
          
          <a href="/order-confirmation/${order.id}" class="order-view-link">
            View Order Details
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      `;
    }).join('');
  }

  // Update stats
  function updateStats(ordersList) {
    const orderCount = ordersList?.length || 0;
    const totalSpent = ordersList?.reduce((sum, o) => sum + (o.totals?.total || o.total || 0), 0) || 0;
    
    // Count vinyl, digital EPs (unique releases), tracks (unique track names), and merch
    let vinylCount = 0;
    let merchCount = 0;
    const uniqueReleases = new Set(); // Track unique digital releases
    const uniqueTracks = new Set(); // Track unique track names
    
    (ordersList || []).forEach(order => {
      (order.items || []).forEach(item => {
        // Check if it's merch
        const isMerch = item.type === 'merch' || 
                        item.type === 'merchandise' ||
                        (item.releaseId && item.releaseId.startsWith('merch_')) ||
                        (item.productId && item.productId.startsWith('merch_'));
        
        // Check if it's vinyl
        const isVinyl = item.type === 'vinyl' || 
                        item.format === 'vinyl' ||
                        item.isVinyl === true ||
                        (item.productType && item.productType.toLowerCase().includes('vinyl'));
        
        if (isMerch) {
          merchCount += item.quantity || 1;
        } else if (isVinyl) {
          vinylCount += item.quantity || 1;
        } else if (item.downloads?.tracks?.length > 0 || item.type === 'digital' || item.type === 'release' || item.type === 'track') {
          // It's a digital music item - track unique releases
          const releaseKey = item.releaseId || item.productId || item.id;
          if (releaseKey) {
            uniqueReleases.add(releaseKey);
          }
          
          // Count unique track names (not formats)
          if (item.downloads?.tracks) {
            item.downloads.tracks.forEach(track => {
              const trackName = track.name || track.title || track.trackName;
              if (trackName) {
                uniqueTracks.add(trackName);
              }
            });
          }
        }
      });
    });
    
    document.getElementById('statOrders').textContent = orderCount;
    const ordersBadge = document.getElementById('ordersBadge');
    ordersBadge.textContent = orderCount;
    ordersBadge.style.display = orderCount > 0 ? 'inline-flex' : 'none';
    document.getElementById('statVinyl').textContent = vinylCount;
    document.getElementById('statDigitalEPs').textContent = uniqueReleases.size;
    document.getElementById('statTracks').textContent = uniqueTracks.size;
    document.getElementById('statMerch').textContent = merchCount;
    document.getElementById('statSpent').textContent = '¬£' + totalSpent.toFixed(2);
  }

  // Download via server-side proxy to bypass CORS
  async function downloadFile(url, filename, button) {
    const originalText = button.innerHTML;
    button.classList.add('downloading');
    button.innerHTML = 'Downloading...';
    
    try {
      // Use server-side proxy to fetch the file
      const proxyUrl = `/api/download?url=${encodeURIComponent(url)}&filename=${encodeURIComponent(filename)}`;
      
      const response = await fetch(proxyUrl);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `Download failed: ${response.status}`);
      }
      
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = blobUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      window.URL.revokeObjectURL(blobUrl);
      
      button.innerHTML = '‚úì Done!';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('downloading');
      }, 2000);
      
    } catch (error) {
      console.error('Download error:', error);
      button.innerHTML = '‚úó Error';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('downloading');
      }, 2000);
    }
  }

  // Render downloads from orders
  function renderDownloads(ordersList) {
    const container = document.getElementById('downloadsContainer');
    if (!container) return;
    
    // Extract all digital items from orders
    const allDownloads = [];
    (ordersList || []).forEach(order => {
      (order.items || []).forEach(item => {
        if (item.downloads?.tracks?.length > 0 || item.type === 'digital' || item.type === 'release' || item.type === 'track') {
          allDownloads.push({
            ...item,
            orderNumber: order.orderNumber,
            orderDate: order.createdAt
          });
        }
      });
    });
    
    // Group downloads by release to avoid duplicate artwork buttons
    const releaseMap = new Map();
    
    allDownloads.forEach(item => {
      const releaseId = item.releaseId || item.productId || item.id;
      
      if (releaseMap.has(releaseId)) {
        // Add tracks to existing release group, avoid duplicates
        const existing = releaseMap.get(releaseId);
        if (item.downloads?.tracks) {
          item.downloads.tracks.forEach(track => {
            const trackExists = existing.downloads.tracks.some(t => t.name === track.name);
            if (!trackExists) {
              existing.downloads.tracks.push(track);
            }
          });
        }
      } else {
        // Create new release group
        releaseMap.set(releaseId, {
          ...item,
          downloads: {
            artistName: item.downloads?.artistName || item.artist || '',
            releaseName: item.downloads?.releaseName || item.name || '',
            artworkUrl: item.downloads?.artworkUrl || item.image || null,
            tracks: item.downloads?.tracks ? [...item.downloads.tracks] : []
          }
        });
      }
    });
    
    const downloads = Array.from(releaseMap.values());
    
    if (downloads.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p style="color: #fff; margin: 0 0 1.5rem 0;">No digital purchases yet</p>
          <a href="/releases" style="display: inline-block; padding: 0.75rem 1.5rem; background: #dc2626; color: #fff; font-weight: 600; border-radius: 8px; text-decoration: none;">Browse Releases</a>
        </div>
      `;
      return;
    }
    
    container.innerHTML = downloads.map(item => {
      const orderDate = item.orderDate ? new Date(item.orderDate).toLocaleDateString('en-GB', {
        day: 'numeric', month: 'short', year: 'numeric'
      }) : '';
      
      const artistName = item.downloads?.artistName || item.artist || '';
      const releaseName = item.downloads?.releaseName || item.name || '';
      const displayName = artistName ? artistName + ' - ' + releaseName : releaseName;
      const artworkFilename = artistName ? artistName + ' - ' + releaseName + ' - Artwork.jpg' : releaseName + ' - Artwork.jpg';
      
      const trackRows = (item.downloads?.tracks || []).map((track, idx) => {
        const trackFilename = artistName 
          ? artistName + ' - ' + track.name + ' - ' + releaseName
          : track.name;
        
        return `
          <div class="track-row">
            <span class="track-name">
              <span class="num">${String(idx + 1).padStart(2, '0')}</span>
              ${track.name}
            </span>
            <div class="dl-buttons">
              ${track.mp3Url ? `
                <button type="button" class="dl-btn mp3" data-url="${track.mp3Url}" data-filename="${trackFilename}.mp3">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  MP3
                </button>
              ` : ''}
              ${track.wavUrl ? `
                <button type="button" class="dl-btn wav" data-url="${track.wavUrl}" data-filename="${trackFilename}.wav">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  WAV
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      const trackCount = item.downloads?.tracks?.length || 0;
      const typeLabel = trackCount === 1 ? 'Single Track' : trackCount + ' Tracks';
      
      return `
        <div class="download-card">
          <div class="download-header">
            <img src="${item.image || item.downloads?.artworkUrl || '/logo.webp'}" alt="${displayName}" class="download-art">
            <div class="download-info">
              <h4>${displayName}</h4>
              <p>${typeLabel} ¬∑ ${orderDate}</p>
            </div>
          </div>
          ${item.downloads?.artworkUrl ? `
            <div class="artwork-dl">
              <button type="button" class="dl-btn art" data-url="${item.downloads.artworkUrl}" data-filename="${artworkFilename}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Artwork
              </button>
            </div>
          ` : ''}
          ${trackRows ? `<div class="track-list">${trackRows}</div>` : ''}
        </div>
      `;
    }).join('');
    
    // Attach download handlers
    container.querySelectorAll('.dl-btn[data-url]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const button = e.currentTarget;
        const url = button.dataset.url;
        const filename = button.dataset.filename || 'download';
        if (url) downloadFile(url, filename, button);
      });
    });
  }

  // Tab switching
  function initTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn, .view-all-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        if (!tabId) return;
        
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
        
        // Update panels
        tabPanels.forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + tabId)?.classList.add('active');
        
        // Load mixes on demand when mixes tab is clicked
        if (tabId === 'mixes' && currentUser) {
          fetchMixes(currentUser.uid);
        }
        
        // Load wishlist on demand when wishlist tab is clicked
        if (tabId === 'wishlist' && currentUser) {
          loadWishlist(currentUser.uid);
        }
        
        // Load following on demand when following tab is clicked
        if (tabId === 'following' && currentUser) {
          loadFollowing(currentUser.uid);
        }
      });
    });
  }

  // Logout
  function initLogout() {
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    });
  }

  // Profile save
  function initProfileForm() {
    // Postcode lookup
    const lookupBtn = document.getElementById('lookupBtn');
    const postcodeSearch = document.getElementById('postcodeSearch');
    const lookupError = document.getElementById('lookupError');
    const lookupSuccess = document.getElementById('lookupSuccess');
    
    if (lookupBtn && postcodeSearch) {
      lookupBtn.addEventListener('click', async () => {
        const postcode = postcodeSearch.value.trim();
        if (!postcode) {
          lookupError.textContent = 'Please enter a postcode';
          lookupSuccess.textContent = '';
          return;
        }
        
        lookupBtn.textContent = 'Verifying...';
        lookupBtn.disabled = true;
        lookupError.textContent = '';
        lookupSuccess.textContent = '';
        
        try {
          const response = await fetch(`/api/postcode-lookup?postcode=${encodeURIComponent(postcode)}`);
          const data = await response.json();
          
          if (data.success) {
            document.getElementById('postcode').value = data.postcode;
            document.getElementById('city').value = data.city || '';
            document.getElementById('county').value = data.county || '';
            lookupSuccess.textContent = '‚úì Postcode verified! Please enter your street address.';
            document.getElementById('address1')?.focus();
          } else {
            lookupError.textContent = data.error || 'Could not verify postcode';
          }
        } catch (error) {
          lookupError.textContent = 'Failed to lookup postcode';
        }
        
        lookupBtn.textContent = 'Verify';
        lookupBtn.disabled = false;
      });
      
      // Allow Enter key in postcode search
      postcodeSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          lookupBtn.click();
        }
      });
    }
    
    // Profile form submit
    document.getElementById('profileForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const btn = e.target.querySelector('.save-btn');
      btn.textContent = 'Saving...';
      btn.disabled = true;
      
      const newDisplayName = document.getElementById('displayName').value;
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      
      try {
        // Update customers collection (only collection with write rules for users)
        await setDoc(doc(db, 'customers', currentUser.uid), {
          firstName: firstName,
          lastName: lastName,
          fullName: firstName + ' ' + lastName,
          displayName: newDisplayName,
          phone: document.getElementById('phone').value,
          address1: document.getElementById('address1').value,
          address2: document.getElementById('address2').value,
          city: document.getElementById('city').value,
          county: document.getElementById('county').value,
          postcode: document.getElementById('postcode').value,
          country: document.getElementById('country').value,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        // Update Firebase Auth profile
        await updateProfile(currentUser, { displayName: newDisplayName });
        
        btn.textContent = 'Saved!';
        setTimeout(() => {
          btn.textContent = 'Save Changes';
          btn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Save error:', error);
        btn.textContent = 'Error - Try Again';
        btn.disabled = false;
      }
    });
    
    // Avatar upload handler
    const avatarUploadInput = document.getElementById('avatarUpload');
    const avatarStatus = document.getElementById('avatarUploadStatus');
    
    if (avatarUploadInput) {
      avatarUploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;
        
        // Validate file
        const maxSize = 2 * 1024 * 1024; // 2MB
        if (file.size > maxSize) {
          avatarStatus.textContent = 'File too large. Max 2MB.';
          avatarStatus.className = 'avatar-status error';
          return;
        }
        
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          avatarStatus.textContent = 'Invalid format. Use JPG, PNG, or WebP.';
          avatarStatus.className = 'avatar-status error';
          return;
        }
        
        avatarStatus.textContent = 'Uploading...';
        avatarStatus.className = 'avatar-status uploading';
        
        try {
          // Upload to API
          const formData = new FormData();
          formData.append('avatar', file);
          formData.append('userId', currentUser.uid);
          
          const response = await fetch('/api/upload-avatar', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            avatarStatus.textContent = 'Avatar updated!';
            avatarStatus.className = 'avatar-status success';
            
            // Update UI
            const avatarUrl = result.avatarUrl;
            window.currentAvatarUrl = avatarUrl;
            
            // Update header avatar
            const userAvatarContainer = document.getElementById('userAvatar');
            if (userAvatarContainer) {
              userAvatarContainer.innerHTML = `<img src="${avatarUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
              userAvatarContainer.classList.remove('is-pro');
            }
            
            // Update profile preview
            const avatarInitialLarge = document.getElementById('avatarInitialLarge');
            const avatarImageLarge = document.getElementById('avatarImageLarge');
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');
            const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
            
            if (avatarInitialLarge) avatarInitialLarge.classList.add('hidden');
            if (avatarImageLarge) {
              avatarImageLarge.src = avatarUrl;
              avatarImageLarge.classList.remove('hidden');
            }
            if (removeAvatarBtn) removeAvatarBtn.classList.remove('hidden');
            if (avatarPreviewLarge) avatarPreviewLarge.classList.remove('is-pro');
            
            setTimeout(() => {
              avatarStatus.textContent = '';
            }, 3000);
          } else {
            avatarStatus.textContent = result.error || 'Upload failed';
            avatarStatus.className = 'avatar-status error';
          }
        } catch (error) {
          console.error('Avatar upload error:', error);
          avatarStatus.textContent = 'Upload failed. Please try again.';
          avatarStatus.className = 'avatar-status error';
        }
        
        // Reset input
        avatarUploadInput.value = '';
      });
    }
    
    // Remove avatar handler
    const removeAvatarBtn = document.getElementById('removeAvatarBtn');
    if (removeAvatarBtn) {
      removeAvatarBtn.addEventListener('click', async () => {
        if (!currentUser) return;
        
        const avatarStatus = document.getElementById('avatarUploadStatus');
        avatarStatus.textContent = 'Removing...';
        avatarStatus.className = 'avatar-status uploading';
        
        try {
          const response = await fetch('/api/upload-avatar', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.uid })
          });
          
          const result = await response.json();
          
          if (result.success) {
            avatarStatus.textContent = 'Avatar removed';
            avatarStatus.className = 'avatar-status success';
            window.currentAvatarUrl = null;
            
            // Get display name initial
            const displayName = document.getElementById('displayName')?.value || 'U';
            const initial = displayName.charAt(0).toUpperCase();
            
            // Update header avatar
            const userAvatarContainer = document.getElementById('userAvatar');
            if (userAvatarContainer) {
              userAvatarContainer.innerHTML = `<span id="avatarInitial">${initial}</span>`;
              if (window.userIsPro) {
                userAvatarContainer.classList.add('is-pro');
              }
            }
            
            // Update profile preview
            const avatarInitialLarge = document.getElementById('avatarInitialLarge');
            const avatarImageLarge = document.getElementById('avatarImageLarge');
            const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
            
            if (avatarInitialLarge) {
              avatarInitialLarge.textContent = initial;
              avatarInitialLarge.classList.remove('hidden');
            }
            if (avatarImageLarge) avatarImageLarge.classList.add('hidden');
            removeAvatarBtn.classList.add('hidden');
            
            if (avatarPreviewLarge && window.userIsPro) {
              avatarPreviewLarge.classList.add('is-pro');
            }
            
            setTimeout(() => {
              avatarStatus.textContent = '';
            }, 3000);
          } else {
            avatarStatus.textContent = result.error || 'Failed to remove';
            avatarStatus.className = 'avatar-status error';
          }
        } catch (error) {
          console.error('Remove avatar error:', error);
          avatarStatus.textContent = 'Failed to remove. Please try again.';
          avatarStatus.className = 'avatar-status error';
        }
      });
    }
    
    // Initialize delete account functionality
    initDeleteAccount();
    
    // Initialize download data functionality
    initDownloadData();
  }
  
  // Download data functionality
  function initDownloadData() {
    const downloadBtn = document.getElementById('downloadDataBtn');
    const modal = document.getElementById('downloadDataModal');
    const cancelBtn = document.getElementById('cancelDownloadBtn');
    const confirmBtn = document.getElementById('confirmDownloadBtn');
    const musicList = document.getElementById('musicDownloadsList');
    const mixesList = document.getElementById('mixesDownloadsList');
    const mixesSection = document.getElementById('djMixesSection');
    
    if (!downloadBtn || !modal) return;
    
    let userMixes = [];
    let purchasedItems = [];
    
    // Open modal and load content
    downloadBtn.addEventListener('click', async () => {
      modal.classList.remove('hidden');
      loadDownloadableContent();
    });
    
    // Close modal
    cancelBtn?.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    
    // Click outside to close
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
    
    // Toggle all buttons
    document.querySelectorAll('.toggle-all-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.dataset.section;
        const container = section === 'music' ? musicList : mixesList;
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => { cb.checked = !allChecked; });
        btn.textContent = allChecked ? 'Select All' : 'Deselect All';
        updateDownloadButton();
      });
    });
    
    async function loadDownloadableContent() {
      // Load purchased music from orders
      purchasedItems = [];
      const releaseGroups = {};
      
      
      if (orders && orders.length > 0) {
        orders.forEach((order, orderIdx) => {
          if (order.items) {
            order.items.forEach((item, itemIdx) => {
              // Check if this is merch - be thorough
              const isMerchType = item.type === 'merch' || item.type === 'merchandise';
              const hasMerchId = (item.releaseId && item.releaseId.startsWith('merch_')) || 
                                 (item.productId && item.productId.startsWith('merch_')) ||
                                 (item.id && String(item.id).startsWith('merch_'));
              const hasMerchAttributes = !!(item.size || item.color);
              
              const isMerch = isMerchType || hasMerchId || (hasMerchAttributes && !item.downloads);
              
              if (isMerch) {
                return;
              }
              
              // Check if this is a music item
              const hasDownloadsObj = !!item.downloads;
              const hasDownloadTracks = item.downloads?.tracks?.length > 0;
              const isDigitalType = item.type === 'digital' || item.type === 'release' || item.type === 'track';
              const hasReleaseId = !!item.releaseId;
              const hasProductId = !!item.productId;
              
              const isMusic = hasDownloadsObj || hasDownloadTracks || isDigitalType || hasReleaseId || hasProductId;
              
              if (isMusic) {
                // Use releaseId as group key to combine tracks from same release
                const groupKey = item.releaseId || item.productId || `${item.id || item.name || item.title}-${order.orderId}-${itemIdx}`;
                
                if (!releaseGroups[groupKey]) {
                  const artistName = item.downloads?.artistName || item.artist || item.artistName || 'Unknown Artist';
                  const releaseName = item.downloads?.releaseName || item.name || item.title || item.releaseName || 'Unknown Release';
                  
                  releaseGroups[groupKey] = {
                    id: groupKey,
                    title: releaseName,
                    artist: artistName,
                    releaseId: item.releaseId || item.productId || item.id,
                    orderId: order.orderId || order.id,
                    purchaseDate: order.createdAt || order.date,
                    formats: ['WAV', 'MP3'],
                    hasArtwork: item.downloads?.artworkUrl || item.image || item.artworkUrl || item.coverUrl,
                    tracks: item.downloads?.tracks ? [...item.downloads.tracks] : []
                  };
                } else {
                  // Merge tracks from same release (avoid duplicates)
                  if (item.downloads?.tracks) {
                    item.downloads.tracks.forEach(track => {
                      const trackExists = releaseGroups[groupKey].tracks.some(t => t.name === track.name);
                      if (!trackExists) {
                        releaseGroups[groupKey].tracks.push(track);
                      }
                    });
                  }
                  // Update artwork if not already set
                  if (!releaseGroups[groupKey].hasArtwork) {
                    releaseGroups[groupKey].hasArtwork = item.downloads?.artworkUrl || item.image || item.artworkUrl || item.coverUrl;
                  }
                }
              }
            });
          }
        });
      }
      
      // Convert groups to array
      purchasedItems = Object.values(releaseGroups);
      
      
      // Render music purchases grouped by release
      if (purchasedItems.length > 0) {
        musicList.innerHTML = purchasedItems.map((item, index) => {
          const trackCount = item.tracks?.length || 0;
          const trackText = trackCount > 0 ? ` ‚Ä¢ ${trackCount} track${trackCount !== 1 ? 's' : ''}` : '';
          
          return `
            <label class="download-option">
              <input type="checkbox" data-type="music" data-id="${item.releaseId || item.id}" data-index="${index}" checked />
              <span class="option-check"></span>
              <div class="option-info">
                <strong>${escapeHtml(item.title)}</strong>
                <span>${escapeHtml(item.artist)}${trackText}</span>
                <div class="option-badges">
                  ${item.formats.map(f => `<span class="option-badge audio">${f}</span>`).join(' ')}
                  ${item.hasArtwork ? ' <span class="option-badge artwork">Artwork</span>' : ''}
                </div>
              </div>
            </label>
          `;
        }).join('');
      } else {
        musicList.innerHTML = '<div class="empty-downloads">No music purchases found</div>';
      }
      
      // Load user's DJ mixes
      try {
        const mixesResponse = await fetch(`/api/get-dj-mixes?userId=${currentUser.uid}`);
        const mixesData = await mixesResponse.json();
        
        if (mixesData.success && mixesData.mixes && mixesData.mixes.length > 0) {
          userMixes = mixesData.mixes;
          mixesSection.style.display = 'block';
          
          mixesList.innerHTML = userMixes.map((mix, index) => `
            <label class="download-option">
              <input type="checkbox" data-type="mix" data-id="${mix.id}" data-index="${index}" checked />
              <span class="option-check"></span>
              <div class="option-info">
                <strong>${escapeHtml(mix.title)}</strong>
                <span>${mix.plays || 0} plays</span>
                <div class="option-badges">
                  <span class="option-badge mix">DJ Mix</span>
                </div>
              </div>
            </label>
          `).join('');
        } else {
          mixesSection.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading mixes:', e);
        mixesSection.style.display = 'none';
      }
      
      // Add event listeners to checkboxes
      modal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateDownloadButton);
      });
      
      updateDownloadButton();
    }
    
    function updateDownloadButton() {
      const anyChecked = modal.querySelectorAll('input[type="checkbox"]:checked').length > 0;
      confirmBtn.disabled = !anyChecked;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    // Handle download
    confirmBtn?.addEventListener('click', async () => {
      if (!currentUser) return;
      
      const selected = {
        ordersPdf: document.getElementById('downloadOrdersPdf')?.checked || false,
        music: [],
        mixes: []
      };
      
      // Collect selected music
      modal.querySelectorAll('input[data-type="music"]:checked').forEach(cb => {
        const index = parseInt(cb.dataset.index);
        if (purchasedItems[index]) {
          selected.music.push(purchasedItems[index]);
        }
      });
      
      // Collect selected mixes
      modal.querySelectorAll('input[data-type="mix"]:checked').forEach(cb => {
        const index = parseInt(cb.dataset.index);
        if (userMixes[index]) {
          selected.mixes.push(userMixes[index]);
        }
      });
      
      const totalItems = (selected.ordersPdf ? 1 : 0) + selected.music.length + selected.mixes.length;
      if (totalItems === 0) return;
      
      confirmBtn.textContent = 'Preparing...';
      confirmBtn.disabled = true;
      
      try {
        let downloadCount = 0;
        
        // Download order history PDF
        if (selected.ordersPdf && orders.length > 0) {
          confirmBtn.textContent = `Downloading PDF...`;
          await downloadOrdersPdf();
          downloadCount++;
        }
        
        // Download selected music files
        for (const item of selected.music) {
          confirmBtn.textContent = `Downloading ${downloadCount + 1}/${totalItems}...`;
          
          // Download each track in the release
          if (item.tracks && item.tracks.length > 0) {
            for (const track of item.tracks) {
              // Download WAV version
              if (track.wavUrl || track.url) {
                const wavUrl = track.wavUrl || track.url;
                const filename = `${item.artist} - ${track.name}.wav`;
                window.open(`/api/download?url=${encodeURIComponent(wavUrl)}&filename=${encodeURIComponent(filename)}`, '_blank');
                await new Promise(r => setTimeout(r, 800));
              }
              // Download MP3 version if available
              if (track.mp3Url) {
                const filename = `${item.artist} - ${track.name}.mp3`;
                window.open(`/api/download?url=${encodeURIComponent(track.mp3Url)}&filename=${encodeURIComponent(filename)}`, '_blank');
                await new Promise(r => setTimeout(r, 800));
              }
            }
          }
          
          // Download artwork if available
          if (item.hasArtwork) {
            const artworkUrl = typeof item.hasArtwork === 'string' ? item.hasArtwork : null;
            if (artworkUrl) {
              const filename = `${item.artist} - ${item.title} - Artwork.jpg`;
              window.open(`/api/download?url=${encodeURIComponent(artworkUrl)}&filename=${encodeURIComponent(filename)}`, '_blank');
              await new Promise(r => setTimeout(r, 500));
            }
          }
          
          downloadCount++;
        }
        
        // Download selected DJ mixes
        for (const mix of selected.mixes) {
          confirmBtn.textContent = `Downloading ${downloadCount + 1}/${totalItems}...`;
          if (mix.audioUrl || mix.url) {
            const mixUrl = mix.audioUrl || mix.url;
            const filename = `${mix.title || 'DJ Mix'}.mp3`;
            window.open(`/api/download?url=${encodeURIComponent(mixUrl)}&filename=${encodeURIComponent(filename)}`, '_blank');
          }
          downloadCount++;
          await new Promise(r => setTimeout(r, 500));
        }
        
        confirmBtn.textContent = 'Done!';
        setTimeout(() => {
          modal.classList.add('hidden');
          confirmBtn.textContent = 'Download Selected';
          confirmBtn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Download error:', error);
        confirmBtn.textContent = 'Error - Try Again';
        setTimeout(() => {
          confirmBtn.textContent = 'Download Selected';
          confirmBtn.disabled = false;
        }, 2000);
      }
    });
    
    async function downloadOrdersPdf() {
      // Generate PDF content
      const pdfContent = generateOrdersPdfHtml();
      
      // Open print dialog for PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(pdfContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }
    
    function generateOrdersPdfHtml() {
      const fullName = customerData?.displayName || 
                       (customerData?.firstName && customerData?.lastName ? 
                        `${customerData.firstName} ${customerData.lastName}` : 
                        customerData?.firstName || 'Customer');
      const email = currentUser?.email || '';
      
      // Helper to create human-readable order ID
      function formatOrderId(order, index) {
        // If there's an orderNumber field, use it
        if (order.orderNumber) return order.orderNumber;
        
        // Create a friendly ID from date + last 4 chars
        const date = new Date(order.createdAt || order.date);
        const dateStr = date.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD
        const suffix = (order.orderId || order.id || '0000').slice(-4).toUpperCase();
        return `FW-${dateStr}-${suffix}`;
      }
      
      const orderRows = orders.map((order, index) => `
        <tr>
          <td>${formatOrderId(order, index)}</td>
          <td>${new Date(order.createdAt || order.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
          <td>${(order.items || []).map(i => i.title || i.name).join(', ') || 'N/A'}</td>
          <td>¬£${(order.total || 0).toFixed(2)}</td>
          <td>${order.status || 'Completed'}</td>
        </tr>
      `).join('');
      
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Fresh Wax - Order History</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; }
            .header { text-align: center; margin-bottom: 30px; }
            .logo { font-size: 42px; font-weight: bold; margin-bottom: 10px; }
            .logo .fresh { color: #000; }
            .logo .wax { color: #dc2626; }
            .order-history-title { font-size: 28px; color: #333; margin: 20px 0 10px 0; }
            .customer-info { color: #666; font-size: 14px; margin-bottom: 5px; }
            .generated { color: #999; font-size: 12px; margin-bottom: 30px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background: #f5f5f5; font-weight: bold; }
            .footer { margin-top: 40px; text-align: center; color: #999; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo"><span class="fresh">Fresh</span> <span class="wax">Wax</span></div>
            <div class="order-history-title">Order History</div>
            <p class="customer-info"><strong>${fullName}</strong></p>
            <p class="customer-info">${email}</p>
            <p class="generated">Generated: ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${orderRows || '<tr><td colspan="5">No orders found</td></tr>'}
            </tbody>
          </table>
          
          <p class="footer">Total Orders: ${orders.length} | freshwax.co.uk</p>
        </body>
        </html>
      `;
    }
  }
  
  // Delete account functionality
  function initDeleteAccount() {
    const deleteBtn = document.getElementById('deleteAccountBtn');
    const modal = document.getElementById('deleteModal');
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const confirmInput = document.getElementById('confirmDeleteInput');
    
    if (!deleteBtn || !modal) return;
    
    // Open modal
    deleteBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      confirmInput.value = '';
      confirmBtn.disabled = true;
    });
    
    // Close modal
    cancelBtn?.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    
    // Click outside to close
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
    
    // Enable/disable confirm button based on input
    confirmInput?.addEventListener('input', () => {
      const isValid = confirmInput.value.toLowerCase() === 'delete';
      confirmBtn.disabled = !isValid;
    });
    
    // Handle delete
    confirmBtn?.addEventListener('click', async () => {
      if (!currentUser || confirmInput.value.toLowerCase() !== 'delete') return;
      
      confirmBtn.textContent = 'Deleting...';
      confirmBtn.classList.add('deleting');
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      
      try {
        // Call delete account API
        const response = await fetch('/api/delete-account', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.uid })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Sign out and redirect
          await signOut(auth);
          window.location.href = '/login?deleted=true';
        } else {
          throw new Error(result.error || 'Failed to delete account');
        }
      } catch (error) {
        console.error('Delete account error:', error);
        confirmBtn.textContent = 'Error - Try Again';
        confirmBtn.classList.remove('deleting');
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
        
        setTimeout(() => {
          confirmBtn.textContent = 'Delete Account';
        }, 3000);
      }
    });
  }

  // Initialize dashboard
  // ========================================
  // Credit / Gift Card Functions
  // ========================================
  
  let userCreditBalance = 0;
  let creditTransactions = [];
  
  async function loadCreditBalance(userId) {
    try {
      const response = await fetch(`/api/giftcards/balance?userId=${userId}`);
      const result = await response.json();
      
      if (result.success) {
        userCreditBalance = result.balance || 0;
        creditTransactions = result.transactions || [];
        
        // Update balance display
        const balanceEl = document.getElementById('creditBalanceDisplay');
        if (balanceEl) {
          balanceEl.textContent = `¬£${userCreditBalance.toFixed(2)}`;
        }
        
        // Update badge
        const badge = document.getElementById('creditBadge');
        if (badge) {
          if (userCreditBalance > 0) {
            badge.textContent = `¬£${userCreditBalance.toFixed(0)}`;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }
        
        // Render transactions
        renderTransactions(creditTransactions);
      }
    } catch (error) {
      console.error('Error loading credit balance:', error);
    }
  }
  
  function renderTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    if (!container) return;
    
    if (!transactions || transactions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p style="color: #888;">No transactions yet</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = transactions.map(txn => {
      const isCredit = txn.amount > 0;
      const date = new Date(txn.createdAt).toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
      
      return `
        <div class="transaction-item ${isCredit ? 'credit' : 'debit'}">
          <div class="transaction-info">
            <span class="transaction-desc">${txn.description}</span>
            <span class="transaction-date">${date}</span>
          </div>
          <span class="transaction-amount ${isCredit ? 'positive' : 'negative'}">
            ${isCredit ? '+' : ''}¬£${Math.abs(txn.amount).toFixed(2)}
          </span>
        </div>
      `;
    }).join('');
  }
  
  function initCreditTab() {
    const form = document.getElementById('dashboardRedeemForm');
    const codeInput = document.getElementById('dashboardGiftCode');
    
    // Format code as user types
    if (codeInput) {
      codeInput.addEventListener('input', (e) => {
        let value = e.target.value.toUpperCase().replace(/[^A-HJ-NP-Z2-9]/g, '');
        
        if (value.length > 4) {
          const prefix = value.substring(0, 4);
          const rest = value.substring(4);
          const chunks = rest.match(/.{1,4}/g) || [];
          value = prefix + '-' + chunks.join('-');
        }
        
        e.target.value = value;
      });
    }
    
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentUser) return;
        
        const code = codeInput.value.trim();
        const btn = document.getElementById('dashboardRedeemBtn');
        const btnText = btn.querySelector('.btn-text');
        const btnLoading = btn.querySelector('.btn-loading');
        const errorEl = document.getElementById('dashboardRedeemError');
        const successEl = document.getElementById('dashboardRedeemSuccess');
        
        errorEl.style.display = 'none';
        successEl.style.display = 'none';
        
        if (!code) {
          errorEl.textContent = 'Please enter a gift card code';
          errorEl.style.display = 'block';
          return;
        }
        
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        
        try {
          const response = await fetch('/api/giftcards/redeem', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              code,
              userId: currentUser.uid
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            successEl.textContent = result.message;
            successEl.style.display = 'block';
            codeInput.value = '';
            
            // Reload credit balance
            await loadCreditBalance(currentUser.uid);
          } else {
            errorEl.textContent = result.error || 'Failed to redeem gift card';
            errorEl.style.display = 'block';
          }
        } catch (error) {
          console.error('Redeem error:', error);
          errorEl.textContent = 'Something went wrong. Please try again.';
          errorEl.style.display = 'block';
        } finally {
          btn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
        }
      });
    }
  }
  
  // ========================================
  // Dashboard Initialization
  // ========================================
  
  // Reset loaded flags - called on page init and when navigating back
  function resetLoadedFlags() {
    mixesLoaded = false;
    wishlistLoaded = false;
    followingLoaded = false;
  }
  
  // Handle browser back/forward navigation (bfcache)
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      // Page was restored from bfcache
      console.log('[Dashboard] Page restored from cache, resetting state');
      resetLoadedFlags();
      
      // Re-fetch data for current tab if needed
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab && currentUser) {
        const tabId = activeTab.getAttribute('data-tab');
        if (tabId === 'mixes') {
          fetchMixes(currentUser.uid);
        } else if (tabId === 'wishlist') {
          loadWishlist(currentUser.uid);
        } else if (tabId === 'following') {
          loadFollowing(currentUser.uid);
        }
      }
    }
  });

  function initDashboard() {
    // Only run on dashboard page
    if (!document.getElementById('loadingScreen') || !document.getElementById('mainContent')) {
      return;
    }
    
    
    // Reset state
    currentUser = null;
    customerData = null;
    orders = [];
    resetLoadedFlags();
    
    // Unsubscribe previous listener if exists
    if (authUnsubscribe) {
      authUnsubscribe();
    }
    
    // Auth state listener
    authUnsubscribe = onAuthStateChanged(auth, async (user) => {
      
      if (user) {
        currentUser = user;
        
        try {
          // Load customer data
          customerData = await loadCustomerData(user.uid);
          
          // Update UI first to show the dashboard
          updateUI(user, customerData);
          
          // Fetch orders via API
          orders = await fetchOrders(user.uid);
          
          // Render orders
          renderOrders(orders.slice(0, 5), 'recentOrdersList');
          renderOrders(orders, 'ordersContainer');
          
          // Render downloads from orders
          renderDownloads(orders);
          
          // Update stats
          updateStats(orders);
          
          // Load wishlist count for badge (don't wait for full data)
          loadWishlistCount(user.uid);
          
          // Load following count for badge
          loadFollowingCount(user.uid);
          
          // Check if user is approved partner and enable Pro Dashboard button
          checkPartnerStatus(user.uid);
          
          // Load credit balance
          loadCreditBalance(user.uid);
          
          // Initialize components
          initTabs();
          initLogout();
          initProfileForm();
          initCreditTab();
          
        } catch (error) {
          console.error('[Dashboard] Error loading dashboard:', error);
          // Still show dashboard even on error
          const loadingScreen = document.getElementById('loadingScreen');
          const mainContent = document.getElementById('mainContent');
          if (loadingScreen) loadingScreen.classList.add('hidden');
          if (mainContent) mainContent.classList.remove('hidden');
          
          // Initialize components
          initTabs();
          initLogout();
          initProfileForm();
        }
        
      } else {
        window.location.href = '/login';
      }
    });
  }
  
  // Run on initial load and ViewTransitions navigation
  initDashboard();
  document.addEventListener('astro:page-load', initDashboard);
</script>