---
// New Release - Pro Dashboard
// Embed the external uploader in an iframe for now
import ProDashboardLayout from '../../../layouts/ProDashboardLayout.astro';

export const prerender = false;
---
<ProDashboardLayout title="New Release" activeSection="/pro/releases/new">
  <div class="new-release-page">
    <iframe
      src="https://freshwax-uploader.pages.dev"
      class="upload-iframe"
      frameborder="0"
      allow="clipboard-write"
    ></iframe>
  </div>

  <style>
    .new-release-page {
      width: 100%;
      height: calc(100vh - 80px);
      padding: 0;
    }

    .upload-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .new-release-page-old {
      max-width: 1000px;
      padding: 0 1rem 4rem;
    }

    .page-header {
      margin-bottom: 2rem;
      text-align: center;
    }

    .page-header h1 {
      margin: 0 0 0.5rem;
      font-size: 2rem;
      color: var(--text-primary, #fff);
    }

    .subtitle {
      color: var(--text-secondary, #a3a3a3);
      margin: 0;
      font-size: 1.1rem;
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem;
      color: var(--text-secondary, #a3a3a3);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color, #262626);
      border-top-color: var(--accent, #dc2626);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tailwind-like utility classes for the React form */
    :global(.max-w-4xl) { max-width: 56rem; }
    :global(.max-w-2xl) { max-width: 42rem; }
    :global(.mx-auto) { margin-left: auto; margin-right: auto; }
    :global(.mb-8) { margin-bottom: 2rem; }
    :global(.mb-6) { margin-bottom: 1.5rem; }
    :global(.mb-4) { margin-bottom: 1rem; }
    :global(.mb-3) { margin-bottom: 0.75rem; }
    :global(.mb-2) { margin-bottom: 0.5rem; }
    :global(.mt-4) { margin-top: 1rem; }
    :global(.mt-3) { margin-top: 0.75rem; }
    :global(.mt-2) { margin-top: 0.5rem; }
    :global(.p-8) { padding: 2rem; }
    :global(.p-4) { padding: 1rem; }
    :global(.p-2) { padding: 0.5rem; }
    :global(.pb-8) { padding-bottom: 2rem; }
    :global(.py-4) { padding-top: 1rem; padding-bottom: 1rem; }
    :global(.py-3) { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    :global(.py-2) { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    :global(.py-1) { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    :global(.px-8) { padding-left: 2rem; padding-right: 2rem; }
    :global(.px-6) { padding-left: 1.5rem; padding-right: 1.5rem; }
    :global(.px-4) { padding-left: 1rem; padding-right: 1rem; }
    :global(.px-3) { padding-left: 0.75rem; padding-right: 0.75rem; }
    :global(.pl-8) { padding-left: 2rem; }
    :global(.pr-4) { padding-right: 1rem; }
    :global(.gap-4) { gap: 1rem; }
    :global(.gap-3) { gap: 0.75rem; }
    :global(.gap-2) { gap: 0.5rem; }

    :global(.text-center) { text-align: center; }
    :global(.text-left) { text-align: left; }
    :global(.text-2xl) { font-size: 1.5rem; }
    :global(.text-xl) { font-size: 1.25rem; }
    :global(.text-lg) { font-size: 1.125rem; }
    :global(.text-sm) { font-size: 0.875rem; }
    :global(.text-xs) { font-size: 0.75rem; }
    :global(.font-bold) { font-weight: 700; }
    :global(.font-semibold) { font-weight: 600; }
    :global(.font-medium) { font-weight: 500; }
    :global(.uppercase) { text-transform: uppercase; }
    :global(.tracking-wider) { letter-spacing: 0.05em; }
    :global(.tracking-wide) { letter-spacing: 0.025em; }
    :global(.font-mono) { font-family: monospace; }

    :global(.flex) { display: flex; }
    :global(.flex-1) { flex: 1; }
    :global(.flex-col) { flex-direction: column; }
    :global(.items-center) { align-items: center; }
    :global(.items-start) { align-items: flex-start; }
    :global(.justify-center) { justify-content: center; }
    :global(.justify-between) { justify-content: space-between; }
    :global(.justify-end) { justify-content: flex-end; }

    :global(.grid) { display: grid; }
    :global(.grid-cols-2) { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    :global(.grid-cols-3) { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    :global(.w-full) { width: 100%; }
    :global(.w-32) { width: 8rem; }
    :global(.w-16) { width: 4rem; }
    :global(.w-5) { width: 1.25rem; }
    :global(.w-4) { width: 1rem; }
    :global(.h-32) { height: 8rem; }
    :global(.h-16) { height: 4rem; }
    :global(.h-5) { height: 1.25rem; }
    :global(.h-4) { height: 1rem; }
    :global(.h-3) { height: 0.75rem; }

    :global(.bg-white) { background-color: white; }
    :global(.bg-gray-50) { background-color: #f9fafb; }
    :global(.bg-gray-100) { background-color: #f3f4f6; }
    :global(.bg-gray-200) { background-color: #e5e7eb; }
    :global(.bg-green-50) { background-color: #f0fdf4; }
    :global(.bg-red-50) { background-color: #fef2f2; }
    :global(.bg-red-600) { background-color: #dc2626; }
    :global(.bg-black) { background-color: #000; }

    :global(.text-gray-900) { color: #111827; }
    :global(.text-gray-700) { color: #374151; }
    :global(.text-gray-600) { color: #4b5563; }
    :global(.text-gray-500) { color: #6b7280; }
    :global(.text-gray-400) { color: #9ca3af; }
    :global(.text-gray-300) { color: #d1d5db; }
    :global(.text-white) { color: white; }
    :global(.text-red-600) { color: #dc2626; }
    :global(.text-red-700) { color: #b91c1c; }
    :global(.text-green-700) { color: #15803d; }
    :global(.text-green-500) { color: #22c55e; }

    :global(.border) { border-width: 1px; }
    :global(.border-2) { border-width: 2px; }
    :global(.border-t) { border-top-width: 1px; }
    :global(.border-b-2) { border-bottom-width: 2px; }
    :global(.border-dashed) { border-style: dashed; }
    :global(.border-gray-200) { border-color: #e5e7eb; }
    :global(.border-gray-300) { border-color: #d1d5db; }
    :global(.border-green-300) { border-color: #86efac; }
    :global(.border-green-500) { border-color: #22c55e; }
    :global(.border-red-200) { border-color: #fecaca; }
    :global(.border-red-500) { border-color: #ef4444; }

    :global(.rounded-xl) { border-radius: 0.75rem; }
    :global(.rounded-lg) { border-radius: 0.5rem; }
    :global(.rounded) { border-radius: 0.25rem; }
    :global(.rounded-full) { border-radius: 9999px; }

    :global(.shadow-lg) { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }

    :global(.cursor-pointer) { cursor: pointer; }
    :global(.cursor-not-allowed) { cursor: not-allowed; }

    :global(.transition-colors) { transition-property: color, background-color, border-color; transition-duration: 150ms; }
    :global(.transition-all) { transition-property: all; transition-duration: 150ms; }
    :global(.transition-transform) { transition-property: transform; transition-duration: 150ms; }

    :global(.space-y-4 > :not([hidden]) ~ :not([hidden])) { margin-top: 1rem; }
    :global(.space-y-3 > :not([hidden]) ~ :not([hidden])) { margin-top: 0.75rem; }

    :global(.object-cover) { object-fit: cover; }
    :global(.resize-none) { resize: none; }
    :global(.sticky) { position: sticky; }
    :global(.bottom-0) { bottom: 0; }
    :global(.fixed) { position: fixed; }
    :global(.inset-0) { inset: 0; }
    :global(.z-50) { z-index: 50; }
    :global(.bg-opacity-50) { background-color: rgba(0, 0, 0, 0.5); }
    :global(.animate-spin) { animation: spin 1s linear infinite; }
    :global(.relative) { position: relative; }
    :global(.absolute) { position: absolute; }
    :global(.top-1\/2) { top: 50%; }
    :global(.left-4) { left: 1rem; }
    :global(.-translate-y-1\/2) { transform: translateY(-50%); }
    :global(.rotate-180) { transform: rotate(180deg); }

    :global(.placeholder-gray-400::placeholder) { color: #9ca3af; }

    :global(.focus\:outline-none:focus) { outline: none; }
    :global(.focus\:ring-2:focus) { box-shadow: 0 0 0 2px; }
    :global(.focus\:ring-red-600:focus) { box-shadow: 0 0 0 2px #dc2626; }
    :global(.focus\:border-transparent:focus) { border-color: transparent; }

    :global(.hover\:bg-gray-200:hover) { background-color: #e5e7eb; }
    :global(.hover\:bg-red-50:hover) { background-color: #fef2f2; }
    :global(.hover\:bg-red-100:hover) { background-color: #fee2e2; }
    :global(.hover\:bg-red-700:hover) { background-color: #b91c1c; }
    :global(.hover\:border-gray-400:hover) { border-color: #9ca3af; }
    :global(.hover\:text-red-700:hover) { color: #b91c1c; }
    :global(.hover\:text-red-800:hover) { color: #991b1b; }

    :global(.disabled\:bg-gray-400:disabled) { background-color: #9ca3af; }
    :global(.disabled\:cursor-not-allowed:disabled) { cursor: not-allowed; }

    :global(.file\:mr-4::file-selector-button) { margin-right: 1rem; }
    :global(.file\:py-2::file-selector-button) { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    :global(.file\:px-4::file-selector-button) { padding-left: 1rem; padding-right: 1rem; }
    :global(.file\:rounded::file-selector-button) { border-radius: 0.25rem; }
    :global(.file\:border-0::file-selector-button) { border: 0; }
    :global(.file\:text-sm::file-selector-button) { font-size: 0.875rem; }
    :global(.file\:font-semibold::file-selector-button) { font-weight: 600; }
    :global(.file\:bg-red-50::file-selector-button) { background-color: #fef2f2; }
    :global(.file\:text-red-600::file-selector-button) { color: #dc2626; }
    :global(.hover\:file\:bg-red-100:hover::file-selector-button) { background-color: #fee2e2; }

    /* Override dark mode form inputs for this page */
    :global(#form-container input),
    :global(#form-container select),
    :global(#form-container textarea) {
      background-color: white !important;
      color: #111827 !important;
    }

    :global(#form-container input:focus),
    :global(#form-container select:focus),
    :global(#form-container textarea:focus) {
      outline: none;
      box-shadow: 0 0 0 2px #dc2626;
    }

    :global(#form-container button[type="submit"]) {
      background-color: #dc2626;
      color: white;
    }

    :global(#form-container button[type="submit"]:hover:not(:disabled)) {
      background-color: #b91c1c;
    }

    @media (max-width: 768px) {
      :global(.grid-cols-2) { grid-template-columns: 1fr; }
      :global(.grid-cols-3) { grid-template-columns: 1fr 1fr; }
    }
  </style>

  <script type="module" is:inline>
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

    const firebaseConfig = window.FIREBASE_CONFIG || {
      apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY || 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
      authDomain: "freshwax-store.firebaseapp.com",
      projectId: "freshwax-store"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      const loadingEl = document.getElementById('auth-loading');
      const formContainer = document.getElementById('form-container');

      if (!user) {
        window.location.href = '/login?redirect=/pro/releases/new';
        return;
      }

      // Hide loading, show form
      if (loadingEl) loadingEl.style.display = 'none';
      if (formContainer) formContainer.style.display = 'block';

      // Pass user data to React component via custom event
      window.dispatchEvent(new CustomEvent('fw:user-ready', {
        detail: {
          email: user.email || '',
          userId: user.uid || '',
          artistName: user.displayName || ''
        }
      }));
    });
  </script>
</ProDashboardLayout>
