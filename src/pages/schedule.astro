---
// src/pages/schedule.astro
// Public streaming schedule page - Daily calendar view
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

export const prerender = false;
---

<Layout title="Stream Schedule - Fresh Wax">
  <Header />
  
  <main class="schedule-main">
    <div class="container">
      <div class="schedule-header">
        <h1>üìÖ STREAM <span class="red">SCHEDULE</span></h1>
        <p>See who's going live on Fresh Wax</p>
      </div>
      
      <!-- Day Navigation -->
      <div class="day-nav">
        <button id="prevDay" class="nav-btn">‚Üê Previous</button>
        <div class="day-selector">
          <button id="dayMinus2" class="day-btn" data-offset="-2"></button>
          <button id="dayMinus1" class="day-btn" data-offset="-1"></button>
          <button id="dayToday" class="day-btn active" data-offset="0"></button>
          <button id="dayPlus1" class="day-btn" data-offset="1"></button>
          <button id="dayPlus2" class="day-btn" data-offset="2"></button>
          <button id="dayPlus3" class="day-btn" data-offset="3"></button>
          <button id="dayPlus4" class="day-btn" data-offset="4"></button>
        </div>
        <button id="nextDay" class="nav-btn">Next ‚Üí</button>
      </div>
      
      <!-- Selected Date Display -->
      <div class="selected-date">
        <h2 id="selectedDateTitle">Today</h2>
        <p id="selectedDateFull">Loading...</p>
      </div>
      
      <!-- Daily Calendar Grid -->
      <div class="calendar-container">
        <div id="noShows" class="no-shows-banner hidden">
          <span class="no-shows-icon">üìª</span>
          <span>No shows scheduled - slots available!</span>
        </div>
        <div id="dailyCalendar" class="daily-calendar">
          <!-- Calendar rendered by JS -->
        </div>
      </div>
      
      <!-- DJ CTA -->
      <div class="dj-cta">
        <h3>Want to go live?</h3>
        <div class="dj-steps">
          <div class="dj-step">
            <span class="step-num">1</span>
            <span class="step-text">Upload a mix</span>
          </div>
          <div class="dj-step">
            <span class="step-num">2</span>
            <span class="step-text">Get 10 likes</span>
          </div>
          <div class="dj-step">
            <span class="step-num">3</span>
            <span class="step-text">Book a slot</span>
          </div>
        </div>
        <p>Prove yourself to the community and earn your spot on the schedule</p>
        <a href="/dj-lobby/book" class="cta-btn">Book a Slot ‚Üí</a>
      </div>
    </div>
  </main>
  
  <Footer />
</Layout>

<style is:global>
  .schedule-main {
    min-height: 100vh;
    background: linear-gradient(to bottom, #000 0%, #111 100%);
    padding: 1rem;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .schedule-header {
    text-align: center;
    margin-bottom: 1rem;
  }

  .schedule-header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3.5rem;
    color: #fff;
    margin: 0 0 0.25rem 0;
    letter-spacing: 0.02em;
  }

  .schedule-header .red {
    color: #dc2626;
  }

  .schedule-header p {
    color: #888;
    font-size: 1rem;
  }

  .day-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .nav-btn {
    background: #dc2626;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    font-weight: 700;
    font-size: 0.75rem;
    cursor: pointer;
    transition: background 0.2s;
    border-radius: 4px;
  }

  .nav-btn:hover {
    background: #b91c1c;
  }

  .day-selector {
    display: flex;
    gap: 0.25rem;
  }

  .day-btn {
    background: #1f2937;
    border: 2px solid #374151;
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    font-size: 0.7rem;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 70px;
    text-align: center;
    border-radius: 4px;
  }

  .day-btn:hover {
    background: #374151;
    border-color: #4b5563;
  }

  .day-btn.active {
    background: #dc2626;
    color: #fff;
    border-color: #dc2626;
  }

  .day-btn.today-marker {
    border-color: #dc2626;
  }

  .selected-date {
    text-align: center;
    margin-bottom: 1rem;
  }

  .selected-date h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    color: #fff;
    margin: 0;
    letter-spacing: 0.02em;
  }

  .selected-date p {
    color: #888;
    font-size: 0.875rem;
    margin: 0.125rem 0 0 0;
  }

  .calendar-container {
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .daily-calendar {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 2px;
    background: #333;
  }

  /* Each hour cell */
  .hour-row {
    background: #1a1a1a;
    display: flex;
    flex-direction: column;
    min-height: 55px;
  }

  .hour-row:nth-child(even) {
    background: #151515;
  }

  /* Time label at top of cell */
  .hour-time {
    text-align: center;
    padding: 0.25rem 0.15rem;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    letter-spacing: 0.02em;
    color: #dc2626;
    background: rgba(220, 38, 38, 0.1);
    border-bottom: 1px solid #333;
    line-height: 1;
  }

  /* Booking area below time */
  .hour-content {
    flex: 1;
    position: relative;
    padding: 0.2rem;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-height: 28px;
  }

  /* Slot blocks inside booking area */
  .slot-block {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: #fff;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s;
    position: relative;
    flex: 1;
  }

  .slot-block:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    z-index: 10;
  }

  .slot-block.live {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    animation: pulse-glow 2s infinite;
  }

  .slot-block.in_lobby {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    color: #000;
  }

  .slot-block.completed {
    background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
    opacity: 0.6;
  }

  .slot-inner {
    padding: 0.2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    text-align: center;
    height: 100%;
  }

  .slot-dj {
    font-weight: 700;
    font-size: 0.6rem;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .slot-title {
    font-size: 0.5rem;
    opacity: 0.85;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.1;
    max-width: 100%;
    display: none;
  }

  .slot-time {
    font-size: 0.45rem;
    font-weight: 600;
    opacity: 0.8;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 0.15rem;
    white-space: nowrap;
  }

  .slot-duration {
    background: rgba(255,255,255,0.2);
    padding: 0.05rem 0.15rem;
    border-radius: 2px;
    font-size: 0.45rem;
  }

  .slot-block.in_lobby .slot-duration {
    background: rgba(0,0,0,0.15);
  }

  .slot-status {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.4rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 1px 3px;
    border-radius: 2px;
    background: rgba(255,255,255,0.25);
  }

  .slot-block.live .slot-status {
    background: #fff;
    color: #dc2626;
    animation: pulse 1s infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 8px rgba(220, 38, 38, 0.3); }
    50% { box-shadow: 0 0 16px rgba(220, 38, 38, 0.5); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .no-shows-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #1a1a1a 0%, #111 100%);
    color: #888;
    font-size: 0.85rem;
    font-weight: 500;
    grid-column: 1 / -1;
    border-bottom: 1px solid #333;
  }

  .no-shows-banner.hidden {
    display: none;
  }

  .no-shows-banner .no-shows-icon {
    font-size: 1.25rem;
  }

  .dj-cta {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    color: #fff;
    padding: 1.5rem;
    text-align: center;
    border: 2px solid #374151;
    border-radius: 8px;
  }

  .dj-cta h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.75rem;
    margin: 0 0 1rem 0;
    letter-spacing: 0.02em;
  }

  .dj-steps {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1rem;
  }

  .dj-step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .step-num {
    width: 26px;
    height: 26px;
    background: #dc2626;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
  }

  .step-text {
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .dj-cta p {
    color: #888;
    margin: 0 0 1rem 0;
    font-size: 0.85rem;
  }

  .cta-btn {
    display: inline-block;
    background: #dc2626;
    color: #fff;
    padding: 0.6rem 1.25rem;
    font-weight: 700;
    text-decoration: none;
    transition: background 0.2s;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .cta-btn:hover {
    background: #b91c1c;
  }

  /* Grid time indicators */
  .daily-calendar .late-night .hour-time {
    color: #6b7280;
    background: rgba(107, 114, 128, 0.1);
  }

  @media (max-width: 1200px) {
    .daily-calendar {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  @media (max-width: 900px) {
    .daily-calendar {
      grid-template-columns: repeat(6, 1fr);
    }

    .hour-row {
      min-height: 50px;
    }
  }

  @media (max-width: 600px) {
    .schedule-main {
      padding: 0.5rem;
    }

    .day-nav {
      flex-direction: column;
      gap: 0.5rem;
    }

    .day-selector {
      flex-wrap: wrap;
      justify-content: center;
    }

    .day-btn {
      min-width: 50px;
      padding: 0.35rem 0.4rem;
      font-size: 0.6rem;
    }

    .schedule-header h1 {
      font-size: 2rem;
    }

    .daily-calendar {
      grid-template-columns: repeat(4, 1fr);
    }

    .hour-row {
      min-height: 45px;
    }

    .hour-time {
      font-size: 0.7rem;
      padding: 0.2rem;
    }

    .slot-dj {
      font-size: 0.5rem;
    }

    .dj-steps {
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }

    .dj-step {
      gap: 0.375rem;
    }

    .step-num {
      width: 22px;
      height: 22px;
      font-size: 0.7rem;
    }

    .step-text {
      font-size: 0.8rem;
    }

    .dj-cta {
      padding: 1rem;
    }

    .dj-cta h3 {
      font-size: 1.5rem;
    }
  }
</style>

<script>
  let allSlots = [];
  let selectedDate = new Date();
  selectedDate.setHours(0, 0, 0, 0);
  let refreshInterval = null;

  // Handle both initial load and View Transitions navigation
  function initSchedule() {
    // Reset state for fresh page load
    allSlots = [];
    selectedDate = new Date();
    selectedDate.setHours(0, 0, 0, 0);

    updateDayButtons();
    renderDailyCalendar(); // Render empty calendar immediately
    loadSchedule(); // Then load slots
    setupNavigation();

    // Auto-refresh every 30 seconds to catch new bookings
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
      loadSchedule();
    }, 30000);
  }

  // Cleanup on page leave
  function cleanupSchedule() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }
  }

  // DOMContentLoaded for initial page load
  document.addEventListener('DOMContentLoaded', initSchedule);

  // astro:page-load for View Transitions navigation
  document.addEventListener('astro:page-load', initSchedule);

  // Cleanup on page navigation
  document.addEventListener('astro:before-swap', cleanupSchedule);
  
  function setupNavigation() {
    // Remove existing listeners to prevent duplicates
    const prevBtn = document.getElementById('prevDay');
    const nextBtn = document.getElementById('nextDay');
    
    if (prevBtn) {
      const newPrevBtn = prevBtn.cloneNode(true);
      prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
      newPrevBtn.addEventListener('click', () => {
        selectedDate = new Date(selectedDate.getTime() - 24 * 60 * 60 * 1000);
        updateDayButtons();
        renderDailyCalendar();
      });
    }
    
    if (nextBtn) {
      const newNextBtn = nextBtn.cloneNode(true);
      nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
      newNextBtn.addEventListener('click', () => {
        selectedDate = new Date(selectedDate.getTime() + 24 * 60 * 60 * 1000);
        updateDayButtons();
        renderDailyCalendar();
      });
    }
    
    // Day button clicks - clone to remove old listeners
    document.querySelectorAll('.day-btn').forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.addEventListener('click', () => {
        const offset = parseInt(newBtn.dataset.offset);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        selectedDate = new Date(today.getTime() + offset * 24 * 60 * 60 * 1000);
        updateDayButtons();
        renderDailyCalendar();
      });
    });
  }
  
  function updateDayButtons() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    document.querySelectorAll('.day-btn').forEach(btn => {
      const offset = parseInt(btn.dataset.offset);
      const btnDate = new Date(today.getTime() + offset * 24 * 60 * 60 * 1000);
      
      // Set button text
      if (offset === 0) {
        btn.textContent = 'Today';
      } else if (offset === 1) {
        btn.textContent = 'Tomorrow';
      } else if (offset === -1) {
        btn.textContent = 'Yesterday';
      } else {
        btn.textContent = btnDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
      }
      
      // Set active state
      btn.classList.toggle('active', btnDate.getTime() === selectedDate.getTime());
      btn.classList.toggle('today-marker', offset === 0);
    });
    
    // Update selected date display
    const isToday = selectedDate.getTime() === today.getTime();
    const isTomorrow = selectedDate.getTime() === today.getTime() + 24 * 60 * 60 * 1000;
    const isYesterday = selectedDate.getTime() === today.getTime() - 24 * 60 * 60 * 1000;
    
    let titleText = '';
    if (isToday) titleText = "Today's Schedule";
    else if (isTomorrow) titleText = "Tomorrow's Schedule";
    else if (isYesterday) titleText = "Yesterday's Schedule";
    else titleText = selectedDate.toLocaleDateString('en-GB', { weekday: 'long' }) + "'s Schedule";
    
    document.getElementById('selectedDateTitle').textContent = titleText;
    document.getElementById('selectedDateFull').textContent = 
      selectedDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  }
  
  async function loadSchedule() {
    try {
      const start = new Date();
      start.setDate(start.getDate() - 7);
      const end = new Date();
      end.setDate(end.getDate() + 14);
      
      const response = await fetch(`/api/livestream/slots?start=${start.toISOString()}&end=${end.toISOString()}`);
      const data = await response.json();
      
      if (data.success) {
        allSlots = (data.slots || []).filter(s => s.status !== 'cancelled');
      }
    } catch (error) {
      console.error('Failed to load schedule:', error);
    }
    // Always render calendar after attempting to load
    renderDailyCalendar();
  }
  
  function renderDailyCalendar() {
    const calendar = document.getElementById('dailyCalendar');
    const noShows = document.getElementById('noShows');
    
    if (!calendar) {
      console.error('Calendar element not found');
      return;
    }
    
    const dayStart = new Date(selectedDate);
    dayStart.setHours(0, 0, 0, 0);
    const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
    
    // Filter slots for selected day
    const daySlots = allSlots.filter(slot => {
      const slotStart = new Date(slot.startTime);
      return slotStart >= dayStart && slotStart < dayEnd;
    }).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
    
    // Group slots by hour
    const slotsByHour = {};
    daySlots.forEach(slot => {
      const hour = new Date(slot.startTime).getHours();
      if (!slotsByHour[hour]) slotsByHour[hour] = [];
      slotsByHour[hour].push(slot);
    });
    
    // Build hour rows - all 24 hours starting from midnight
    let html = '';

    // Helper to format hour label compactly
    const formatHour = (h) => {
      const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
      const ampm = h >= 12 ? 'p' : 'a';
      return `${displayHour}${ampm}`;
    };

    // All 24 hours (0-23)
    for (let hour = 0; hour < 24; hour++) {
      const hourLabel = formatHour(hour);
      const hourSlots = slotsByHour[hour] || [];
      const isLateNight = hour < 9;

      html += `<div class="hour-row${isLateNight ? ' late-night' : ''}" data-hour="${hour}">`;
      html += `  <div class="hour-time">${hourLabel}</div>`;
      html += `  <div class="hour-content">`;

      // Add slots for this hour
      hourSlots.forEach(slot => {
        html += `
          <div class="slot-block ${slot.status || ''}">
            <div class="slot-inner">
              <div class="slot-dj">${slot.djName || 'TBA'}</div>
            </div>
            ${slot.status === 'live' ? '<span class="slot-status">LIVE</span>' : ''}
            ${slot.status === 'in_lobby' ? '<span class="slot-status">LOBBY</span>' : ''}
          </div>
        `;
      });

      html += `  </div>`;
      html += `</div>`;
    }
    
    calendar.innerHTML = html;
    
    // Show/hide no shows message but always show calendar
    if (noShows) {
      if (daySlots.length === 0) {
        noShows.classList.remove('hidden');
      } else {
        noShows.classList.add('hidden');
      }
    }
  }
</script>
