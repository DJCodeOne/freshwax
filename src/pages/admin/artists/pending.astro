---
// /src/pages/admin/artists/pending.astro
// Fresh Wax Partner Approvals - Unified Admin Design

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { initializeApp, cert, getApps } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

// Fetch pending partners
const pendingSnapshot = await db.collection('artists')
  .where('approved', '==', false)
  .orderBy('registeredAt', 'desc')
  .get();

const pendingPartners = pendingSnapshot.docs.map(doc => ({
  id: doc.id,
  ...doc.data(),
  registeredAt: doc.data().registeredAt?.toDate?.() || new Date()
}));

// Count by role - DJs are now customer-level, not partners
const counts = {
  all: pendingPartners.length,
  artists: pendingPartners.filter(p => p.isArtist).length,
  merch: pendingPartners.filter(p => p.isMerchSupplier).length
};

// Stats for header
const stats = [
  { label: 'Total Pending', value: counts.all, type: counts.all > 0 ? 'warning' : 'default' },
  { label: 'Artists', value: counts.artists, type: 'info' },
  { label: 'Merch Suppliers', value: counts.merch, type: 'info' },
];

export const prerender = false;
---

<AdminLayout title="Partner Approvals" activeNav="pending" showStats={true} stats={stats}>
  <Fragment slot="actions">
    <a href="/admin/artists/manage" class="btn btn-outline">View All Partners</a>
  </Fragment>

  <!-- Filter Tabs -->
  <div class="toolbar">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">
        All <span class="count">{counts.all}</span>
      </button>
      <button class="filter-tab" data-filter="artist">
        ðŸŽµ Artists <span class="count">{counts.artists}</span>
      </button>
      <button class="filter-tab" data-filter="merch">
        ðŸ‘• Merch <span class="count">{counts.merch}</span>
      </button>
    </div>
  </div>

  <!-- Partners List -->
  {pendingPartners.length === 0 ? (
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸŽ‰</div>
          <div class="empty-state-title">All caught up!</div>
          <p class="empty-state-text">No pending partner approvals at the moment.</p>
          <a href="/admin/artists/manage" class="btn btn-primary">View All Partners</a>
        </div>
      </div>
    </div>
  ) : (
    <div class="card">
      <div class="card-header">
        <h2>Pending Applications</h2>
        <span class="text-muted">{counts.all} awaiting review</span>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Partner</th>
              <th>Roles</th>
              <th>Registered</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="partnersTableBody">
            {pendingPartners.map(partner => (
              <tr 
                data-id={partner.id}
                data-roles={JSON.stringify({
                  artist: partner.isArtist || false,
                  dj: partner.isDJ || false,
                  merch: partner.isMerchSupplier || false
                })}
              >
                <td>
                  <div class="item-cell">
                    <div class="item-info">
                      <h4>{partner.artistName || partner.name || 'Unnamed'}</h4>
                      <p>{partner.email}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="flex gap-1 flex-wrap">
                    {partner.isArtist && <span class="badge badge-info">ðŸŽµ Artist</span>}
                    {partner.isDJ && <span class="badge badge-processing">ðŸŽ§ DJ</span>}
                    {partner.isMerchSupplier && <span class="badge badge-shipped">ðŸ‘• Merch</span>}
                  </div>
                </td>
                <td class="cell-secondary">
                  {partner.registeredAt.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                  })}
                </td>
                <td class="text-right">
                  <div class="flex gap-1 justify-end">
                    <button 
                      class="btn btn-success btn-sm approve-btn"
                      data-id={partner.id}
                    >
                      Approve
                    </button>
                    <button 
                      class="btn btn-danger btn-sm reject-btn"
                      data-id={partner.id}
                    >
                      Reject
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}

  <Fragment slot="scripts">
    <script is:inline>
      // Filter functionality
      const filterTabs = document.querySelectorAll('.filter-tab');
      const tableBody = document.getElementById('partnersTableBody');
      
      if (filterTabs.length && tableBody) {
        filterTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            filterTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const filter = tab.dataset.filter;
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
              const roles = JSON.parse(row.dataset.roles || '{}');
              
              if (filter === 'all') {
                row.style.display = '';
              } else if (filter === 'artist' && roles.artist) {
                row.style.display = '';
              } else if (filter === 'dj' && roles.dj) {
                row.style.display = '';
              } else if (filter === 'merch' && roles.merch) {
                row.style.display = '';
              } else {
                row.style.display = 'none';
              }
            });
          });
        });
      }

      // Approve partner
      document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const row = btn.closest('tr');
          
          btn.disabled = true;
          btn.textContent = 'Approving...';
          
          try {
            const response = await fetch('/api/admin/approve-partner', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ partnerId: id })
            });
            
            if (!response.ok) throw new Error('Failed to approve');
            
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            row.style.transition = 'all 0.3s';
            
            setTimeout(() => row.remove(), 300);
            
            showToast('Partner approved successfully!');
            updateCounts(-1, row.dataset.roles);
            
          } catch (error) {
            console.error(error);
            showToast('Failed to approve partner', 'error');
            btn.disabled = false;
            btn.textContent = 'Approve';
          }
        });
      });

      // Reject partner
      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to reject this partner? This will delete their application.')) {
            return;
          }
          
          const id = btn.dataset.id;
          const row = btn.closest('tr');
          
          btn.disabled = true;
          btn.textContent = 'Rejecting...';
          
          try {
            const response = await fetch('/api/admin/reject-partner', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ partnerId: id })
            });
            
            if (!response.ok) throw new Error('Failed to reject');
            
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            row.style.transition = 'all 0.3s';
            
            setTimeout(() => row.remove(), 300);
            
            showToast('Partner rejected');
            updateCounts(-1, row.dataset.roles);
            
          } catch (error) {
            console.error(error);
            showToast('Failed to reject partner', 'error');
            btn.disabled = false;
            btn.textContent = 'Reject';
          }
        });
      });

      // Update filter counts
      function updateCounts(delta, rolesJson) {
        const roles = JSON.parse(rolesJson || '{}');
        
        // Update "All" count
        const allTab = document.querySelector('[data-filter="all"] .count');
        if (allTab) allTab.textContent = parseInt(allTab.textContent) + delta;
        
        // Update role-specific counts
        if (roles.artist) {
          const tab = document.querySelector('[data-filter="artist"] .count');
          if (tab) tab.textContent = parseInt(tab.textContent) + delta;
        }
        if (roles.dj) {
          const tab = document.querySelector('[data-filter="dj"] .count');
          if (tab) tab.textContent = parseInt(tab.textContent) + delta;
        }
        if (roles.merch) {
          const tab = document.querySelector('[data-filter="merch"] .count');
          if (tab) tab.textContent = parseInt(tab.textContent) + delta;
        }
        
        // Check if empty
        const remaining = document.querySelectorAll('#partnersTableBody tr').length;
        if (remaining === 0) {
          location.reload();
        }
      }
    </script>
  </Fragment>
</AdminLayout>

<style>
  .filter-tab .count {
    background: var(--border-light);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-size: 0.7rem;
    margin-left: 0.25rem;
  }
  
  .filter-tab.active .count {
    background: rgba(255,255,255,0.3);
  }
</style>
