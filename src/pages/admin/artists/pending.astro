---
// /src/pages/admin/artists/pending.astro
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { queryCollection } from '../../../lib/firebase-rest';

const allUsers = await queryCollection('users', { skipCache: true });

const pendingPartners = allUsers.filter((user: any) => {
  const pending = user.pendingRoles || {};
  return pending.artist?.status === 'pending' || pending.merchSeller?.status === 'pending';
}).map((user: any) => {
  const pending = user.pendingRoles || {};
  const artistReq = pending.artist?.status === 'pending' ? pending.artist : null;
  const merchReq = pending.merchSeller?.status === 'pending' ? pending.merchSeller : null;
  return {
    id: user.id,
    email: user.email || '',
    artistName: artistReq?.artistName || user.displayName || 'Unknown',
    bio: artistReq?.bio || merchReq?.bio || '',
    links: artistReq?.links || merchReq?.links || '',
    isArtist: !!artistReq,
    isMerchSupplier: !!merchReq,
    registeredAt: new Date(artistReq?.requestedAt || merchReq?.requestedAt || user.createdAt || Date.now())
  };
}).sort((a: any, b: any) => b.registeredAt.getTime() - a.registeredAt.getTime());

const counts = { all: pendingPartners.length, artists: pendingPartners.filter((p: any) => p.isArtist).length, merch: pendingPartners.filter((p: any) => p.isMerchSupplier).length };
const stats = [{ label: 'Total Pending', value: counts.all, type: counts.all > 0 ? 'warning' : 'default' }, { label: 'Artists', value: counts.artists, type: 'info' }, { label: 'Merch', value: counts.merch, type: 'info' }];

export const prerender = false;
---
<AdminLayout title="Partner Approvals" activeNav="pending" showStats={true} stats={stats}>
  <div class="toolbar"><div class="filter-tabs">
    <button class="filter-tab active" data-filter="all">All <span class="count">{counts.all}</span></button>
    <button class="filter-tab" data-filter="artist">Artists <span class="count">{counts.artists}</span></button>
    <button class="filter-tab" data-filter="merch">Merch <span class="count">{counts.merch}</span></button>
  </div></div>

  {pendingPartners.length === 0 ? (
    <div class="card"><div class="card-body"><div class="empty-state"><div class="empty-state-title">No pending approvals</div></div></div></div>
  ) : (
    <div class="card"><div class="card-header"><h2>Pending Applications ({counts.all})</h2></div>
      <div class="table-wrapper"><table class="data-table"><thead><tr><th>Applicant</th><th>Bio</th><th>Type</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="tbl">{pendingPartners.map((p: any) => (
          <tr data-id={p.id} data-email={p.email} data-name={p.artistName} data-roles={JSON.stringify({artist:p.isArtist,merch:p.isMerchSupplier})}>
            <td><h4>{p.artistName}</h4><small>{p.email}</small></td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{p.bio || 'No bio'}</td>
            <td>{p.isArtist && <span class="badge badge-info">Artist</span>}{p.isMerchSupplier && <span class="badge">Merch</span>}</td>
            <td>{p.registeredAt.toLocaleDateString('en-GB')}</td>
            <td><button class="btn btn-success btn-sm approve-btn" data-id={p.id}>Approve</button> <button class="btn btn-danger btn-sm reject-btn" data-id={p.id}>Reject</button></td>
          </tr>
        ))}</tbody></table></div></div>
  )}
  <Fragment slot="scripts"><script type="module">
    import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import{getAuth,onAuthStateChanged}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import{getFirestore,doc,updateDoc,serverTimestamp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    const app=initializeApp({apiKey:import.meta.env.PUBLIC_FIREBASE_API_KEY,authDomain:"freshwax-store.firebaseapp.com",projectId:"freshwax-store"});
    const auth=getAuth(app),db=getFirestore(app),ADMINS=['Y3TGc171cHSWTqZDRSniyu7Jxc33','8WmxYeCp4PSym5iWHahgizokn5F2'];
    onAuthStateChanged(auth,u=>{if(!u||!ADMINS.includes(u.uid))window.location.href='/admin/login';});
    const tbl=document.getElementById('tbl');
    document.querySelectorAll('.filter-tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.filter-tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');const f=t.dataset.filter;tbl?.querySelectorAll('tr').forEach(r=>{const rl=JSON.parse(r.dataset.roles||'{}');r.style.display=(f==='all'||(f==='artist'&&rl.artist)||(f==='merch'&&rl.merch))?'':'none';});});
    document.querySelectorAll('.approve-btn').forEach(b=>b.onclick=async()=>{const id=b.dataset.id,row=b.closest('tr'),rl=JSON.parse(row.dataset.roles||'{}'),email=row.dataset.email,name=row.dataset.name;b.disabled=true;b.textContent='Approving...';try{const u={updatedAt:serverTimestamp()};if(rl.artist){u['roles.artist']=true;u['pendingRoles.artist.status']='approved';}if(rl.merch){u['roles.merchSeller']=true;u['pendingRoles.merchSeller.status']='approved';}await updateDoc(doc(db,'users',id),u);b.textContent='Sending email...';try{await fetch('/api/admin/send-approval-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,name,type:(rl.artist && rl.merch) ? 'both' : (rl.artist ? 'artist' : 'merch')})});}catch(emailErr){console.warn('Email failed:',emailErr);}row.remove();if(!tbl?.querySelector('tr'))location.reload();alert('Approved! Confirmation email sent.');}catch(e){alert(e.message);b.disabled=false;b.textContent='Approve';}});
    document.querySelectorAll('.reject-btn').forEach(b=>b.onclick=async()=>{const reason=prompt('Reason?');if(reason===null)return;const id=b.dataset.id,row=b.closest('tr'),rl=JSON.parse(row.dataset.roles||'{}');b.disabled=true;try{const u={updatedAt:serverTimestamp()};if(rl.artist)u['pendingRoles.artist.status']='rejected';if(rl.merch)u['pendingRoles.merchSeller.status']='rejected';await updateDoc(doc(db,'users',id),u);row.remove();if(!tbl?.querySelector('tr'))location.reload();alert('Rejected');}catch(e){alert(e.message);b.disabled=false;}});
  </script></Fragment>
</AdminLayout>
<style>.filter-tab .count{background:var(--border-light);padding:0.1rem 0.4rem;border-radius:4px;font-size:0.7rem;margin-left:0.25rem;}.filter-tab.active .count{background:rgba(255,255,255,0.3);}</style>
