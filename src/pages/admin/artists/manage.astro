---
// src/pages/admin/artists/manage.astro
// Admin Partner Management - Artists & Merch Suppliers
// DJs are now customer-level (no approval needed)
import AdminLayout from '../../../layouts/AdminLayout.astro';
export const prerender = false;
---

<AdminLayout title="Partner Management" activeNav="artists">
  <Fragment slot="actions">
    <a href="/admin/artists/pending" class="btn btn-secondary">
      <span>‚è≥</span> Pending Approvals
    </a>
  </Fragment>

  <!-- Stats Bar -->
  <div class="stats-grid mb-3">
    <div class="stat-card">
      <div class="stat-value" id="totalCount">0</div>
      <div class="stat-label">Total Partners</div>
    </div>
    <div class="stat-card success">
      <div class="stat-value" id="approvedCount">0</div>
      <div class="stat-label">Approved</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-value" id="pendingCount">0</div>
      <div class="stat-label">Pending Approval</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="artistCount">0</div>
      <div class="stat-label">Artists/Labels</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="merchCount">0</div>
      <div class="stat-label">Merch Suppliers</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="card mb-3">
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Search by name or email..." class="search-input">
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">All</button>
        <button class="filter-tab" data-filter="approved">Approved</button>
        <button class="filter-tab" data-filter="pending">Pending</button>
        <span class="filter-divider"></span>
        <button class="filter-tab" data-filter="artist">üéµ Artists</button>
        <button class="filter-tab" data-filter="merch">üëï Merch</button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="card">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading partners...</p>
    </div>
  </div>

  <!-- Partners Table -->
  <div id="partnersTable" class="card" style="display: none;">
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Partner</th>
            <th>Contact</th>
            <th>Roles</th>
            <th>Status</th>
            <th>Registered</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="partnersTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="card" style="display: none;">
    <div class="empty-state">
      <div class="empty-icon">üë•</div>
      <h3>No partners found</h3>
      <p>Try adjusting your search or filter criteria</p>
    </div>
  </div>

  <!-- Edit Partner Modal -->
  <Fragment slot="modals">
    <div id="editModal" class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h2>Edit Partner</h2>
          <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editPartnerId">
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Display Name <span class="required">*</span></label>
                <input type="text" id="editName" class="form-input" required>
                <p class="form-hint">How they appear on the store</p>
              </div>
              <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" id="editFullName" class="form-input">
                <p class="form-hint">Legal/real name</p>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" id="editEmail" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Phone / WhatsApp</label>
                <input type="tel" id="editPhone" class="form-input" placeholder="+44...">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Partner Roles</label>
              <p class="form-hint">Select which features this partner can access</p>
              <div class="role-cards">
                <label class="role-card-select">
                  <input type="checkbox" id="editRoleArtist" name="roles" value="artist">
                  <div class="role-card-content">
                    <span class="role-icon">üéµ</span>
                    <div class="role-info">
                      <strong>Artist / Label / Producer</strong>
                      <span>Upload releases, manage tracks, view sales</span>
                    </div>
                    <span class="role-check">‚úì</span>
                  </div>
                </label>
                <label class="role-card-select">
                  <input type="checkbox" id="editRoleMerch" name="roles" value="merch">
                  <div class="role-card-content">
                    <span class="role-icon">üëï</span>
                    <div class="role-info">
                      <strong>Merch Supplier</strong>
                      <span>Manage merchandise, track stock & sales</span>
                    </div>
                    <span class="role-check">‚úì</span>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Account Status</label>
              <div class="status-options">
                <label class="status-option">
                  <input type="radio" name="editStatus" value="approved" id="statusApproved">
                  <div class="status-card approved">
                    <span class="status-icon">‚úì</span>
                    <div>
                      <strong>Approved</strong>
                      <span>Full access to Pro Dashboard</span>
                    </div>
                  </div>
                </label>
                <label class="status-option">
                  <input type="radio" name="editStatus" value="pending" id="statusPending">
                  <div class="status-card pending">
                    <span class="status-icon">‚è≥</span>
                    <div>
                      <strong>Pending</strong>
                      <span>Awaiting approval</span>
                    </div>
                  </div>
                </label>
                <label class="status-option">
                  <input type="radio" name="editStatus" value="suspended" id="statusSuspended">
                  <div class="status-card suspended">
                    <span class="status-icon">üö´</span>
                    <div>
                      <strong>Suspended</strong>
                      <span>Access revoked</span>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Admin Notes</label>
              <textarea id="editNotes" class="form-input" rows="3" placeholder="Internal notes about this partner..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="savePartner()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Quick Approve Modal -->
    <div id="approveModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2>Approve Partner</h2>
          <button class="modal-close" onclick="closeModal('approveModal')">√ó</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to approve <strong id="approvePartnerName"></strong>?</p>
          <p class="text-muted mt-1">They will gain access to the Pro Dashboard and can start uploading content.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Cancel</button>
          <button type="button" class="btn btn-success" onclick="confirmApprove()">Approve Partner</button>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2>Delete Partner</h2>
          <button class="modal-close" onclick="closeModal('deleteModal')">√ó</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong id="deletePartnerName"></strong>?</p>
          <p class="text-danger mt-1">This action cannot be undone. Their releases and content will remain but they won't be able to access the Pro Dashboard.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete Partner</button>
        </div>
      </div>
    </div>
  </Fragment>

  <Fragment slot="scripts">
    <script is:inline type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      
      const firebaseConfig = {
        apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      let allPartners = [];
      let currentFilter = 'all';
      let currentPartnerId = null;
      
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = '/admin/login';
          return;
        }
        loadPartners();
      });
      
      async function loadPartners() {
        try {
          const snapshot = await getDocs(query(collection(db, 'artists'), orderBy('registeredAt', 'desc')));
          allPartners = [];
          
          snapshot.forEach(doc => {
            const data = doc.data();
            allPartners.push({
              id: doc.id,
              name: data.artistName || data.name || 'Unknown',
              fullName: data.name || data.fullName || '',
              email: data.email || '',
              phone: data.phone || data.whatsapp || '',
              isArtist: data.isArtist === true,
              isMerchSupplier: data.isMerchSupplier === true,
              approved: data.approved === true,
              suspended: data.suspended === true,
              notes: data.adminNotes || '',
              registeredAt: data.registeredAt?.toDate?.() || new Date(data.registeredAt) || null
            });
          });
          
          updateStats();
          renderPartners();
          
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('partnersTable').style.display = 'block';
          
        } catch (error) {
          console.error('Error loading partners:', error);
          document.getElementById('loadingState').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ùå</div>
              <h3>Error loading partners</h3>
              <p>${error.message}</p>
            </div>
          `;
        }
      }
      
      function updateStats() {
        const approved = allPartners.filter(p => p.approved && !p.suspended);
        const pending = allPartners.filter(p => !p.approved && !p.suspended);
        const artists = allPartners.filter(p => p.isArtist);
        const merch = allPartners.filter(p => p.isMerchSupplier);
        
        document.getElementById('totalCount').textContent = allPartners.length;
        document.getElementById('approvedCount').textContent = approved.length;
        document.getElementById('pendingCount').textContent = pending.length;
        document.getElementById('artistCount').textContent = artists.length;
        document.getElementById('merchCount').textContent = merch.length;
      }
      
      function renderPartners() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = allPartners.filter(p => {
          const matchesSearch = !searchTerm || 
            p.name.toLowerCase().includes(searchTerm) ||
            p.email.toLowerCase().includes(searchTerm);
          
          if (!matchesSearch) return false;
          
          switch (currentFilter) {
            case 'approved': return p.approved && !p.suspended;
            case 'pending': return !p.approved && !p.suspended;
            case 'artist': return p.isArtist;
            case 'merch': return p.isMerchSupplier;
            default: return true;
          }
        });
        
        const tbody = document.getElementById('partnersTableBody');
        const emptyState = document.getElementById('emptyState');
        const table = document.getElementById('partnersTable');
        
        if (filtered.length === 0) {
          tbody.innerHTML = '';
          table.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }
        
        table.style.display = 'block';
        emptyState.style.display = 'none';
        
        tbody.innerHTML = filtered.map(p => {
          const roles = [];
          if (p.isArtist) roles.push('<span class="badge badge-info">üéµ Artist</span>');
          if (p.isMerchSupplier) roles.push('<span class="badge badge-purple">üëï Merch</span>');
          
          let statusBadge;
          if (p.suspended) {
            statusBadge = '<span class="badge badge-danger">Suspended</span>';
          } else if (p.approved) {
            statusBadge = '<span class="badge badge-success">Approved</span>';
          } else {
            statusBadge = '<span class="badge badge-warning">Pending</span>';
          }
          
          const dateStr = p.registeredAt ? 
            new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).format(p.registeredAt) :
            'Unknown';
          
          return `
            <tr>
              <td>
                <div class="item-cell">
                  <div class="avatar">${p.name.charAt(0).toUpperCase()}</div>
                  <div class="item-info">
                    <h4>${p.name}</h4>
                    ${p.fullName && p.fullName !== p.name ? `<p>${p.fullName}</p>` : ''}
                  </div>
                </div>
              </td>
              <td>
                <div>${p.email}</div>
                ${p.phone ? `<div class="text-muted text-sm">${p.phone}</div>` : ''}
              </td>
              <td>${roles.join(' ') || '<span class="text-muted">None</span>'}</td>
              <td>${statusBadge}</td>
              <td class="text-muted">${dateStr}</td>
              <td class="text-right">
                <div class="btn-group">
                  ${!p.approved && !p.suspended ? `
                    <button class="btn btn-sm btn-success" onclick="quickApprove('${p.id}', '${p.name.replace(/'/g, "\\'")}')">Approve</button>
                  ` : ''}
                  <button class="btn btn-sm btn-secondary" onclick="editPartner('${p.id}')">Edit</button>
                  <button class="btn btn-sm btn-outline" onclick="deletePartner('${p.id}', '${p.name.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderPartners();
        });
      });
      
      document.getElementById('searchInput').addEventListener('input', () => renderPartners());
      
      window.editPartner = function(id) {
        const partner = allPartners.find(p => p.id === id);
        if (!partner) return;
        
        currentPartnerId = id;
        document.getElementById('editPartnerId').value = id;
        document.getElementById('editName').value = partner.name;
        document.getElementById('editFullName').value = partner.fullName;
        document.getElementById('editEmail').value = partner.email;
        document.getElementById('editPhone').value = partner.phone;
        document.getElementById('editNotes').value = partner.notes;
        document.getElementById('editRoleArtist').checked = partner.isArtist;
        document.getElementById('editRoleMerch').checked = partner.isMerchSupplier;
        
        if (partner.suspended) document.getElementById('statusSuspended').checked = true;
        else if (partner.approved) document.getElementById('statusApproved').checked = true;
        else document.getElementById('statusPending').checked = true;
        
        openModal('editModal');
      };
      
      window.savePartner = async function() {
        if (!currentPartnerId) return;
        
        const status = document.querySelector('input[name="editStatus"]:checked')?.value;
        const updates = {
          artistName: document.getElementById('editName').value,
          name: document.getElementById('editFullName').value || document.getElementById('editName').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          isArtist: document.getElementById('editRoleArtist').checked,
          isMerchSupplier: document.getElementById('editRoleMerch').checked,
          approved: status === 'approved',
          suspended: status === 'suspended',
          adminNotes: document.getElementById('editNotes').value,
          updatedAt: new Date().toISOString()
        };
        
        try {
          await updateDoc(doc(db, 'artists', currentPartnerId), updates);
          try {
            await updateDoc(doc(db, 'users', currentPartnerId), {
              displayName: updates.artistName,
              approved: updates.approved,
              'roles.artist': updates.isArtist,
              'roles.merchSupplier': updates.isMerchSupplier
            });
          } catch (e) {}
          
          closeModal('editModal');
          showToast('Partner updated successfully');
          loadPartners();
        } catch (error) {
          showToast('Error updating partner: ' + error.message, 'error');
        }
      };
      
      window.quickApprove = function(id, name) {
        currentPartnerId = id;
        document.getElementById('approvePartnerName').textContent = name;
        openModal('approveModal');
      };
      
      window.confirmApprove = async function() {
        if (!currentPartnerId) return;
        try {
          await updateDoc(doc(db, 'artists', currentPartnerId), { approved: true, approvedAt: new Date().toISOString() });
          try { await updateDoc(doc(db, 'users', currentPartnerId), { approved: true }); } catch (e) {}
          closeModal('approveModal');
          showToast('Partner approved!', 'success');
          loadPartners();
        } catch (error) {
          showToast('Error approving partner: ' + error.message, 'error');
        }
      };
      
      window.deletePartner = function(id, name) {
        currentPartnerId = id;
        document.getElementById('deletePartnerName').textContent = name;
        openModal('deleteModal');
      };
      
      window.confirmDelete = async function() {
        if (!currentPartnerId) return;
        try {
          await deleteDoc(doc(db, 'artists', currentPartnerId));
          closeModal('deleteModal');
          showToast('Partner deleted');
          loadPartners();
        } catch (error) {
          showToast('Error deleting partner: ' + error.message, 'error');
        }
      };
    </script>
  </Fragment>
</AdminLayout>

<style>
  .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; }
  .stat-card { background: #fff; border: 2px solid #e5e5e5; padding: 1.25rem; text-align: center; }
  .stat-card.success { border-color: #16a34a; }
  .stat-card.warning { border-color: #d97706; }
  .stat-value { font-size: 2rem; font-weight: 800; color: #000; line-height: 1; }
  .stat-card.success .stat-value { color: #16a34a; }
  .stat-card.warning .stat-value { color: #d97706; }
  .stat-label { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
  
  .role-cards { display: flex; flex-direction: column; gap: 0.75rem; }
  .role-card-select { cursor: pointer; }
  .role-card-select input { display: none; }
  .role-card-content { display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid #e5e5e5; background: #fafafa; transition: all 0.2s; }
  .role-card-select:hover .role-card-content { border-color: #ccc; }
  .role-card-select input:checked + .role-card-content { border-color: #000; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .role-card-content .role-icon { font-size: 1.5rem; }
  .role-card-content .role-info { flex: 1; }
  .role-card-content .role-info strong { display: block; font-size: 0.95rem; }
  .role-card-content .role-info span { font-size: 0.8rem; color: #666; }
  .role-card-content .role-check { width: 24px; height: 24px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: transparent; transition: all 0.2s; }
  .role-card-select input:checked + .role-card-content .role-check { background: #000; border-color: #000; color: #fff; }
  
  .status-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
  .status-option { cursor: pointer; }
  .status-option input { display: none; }
  .status-card { padding: 1rem; border: 2px solid #e5e5e5; text-align: center; transition: all 0.2s; }
  .status-card .status-icon { font-size: 1.5rem; display: block; margin-bottom: 0.5rem; }
  .status-card strong { display: block; font-size: 0.9rem; }
  .status-card span { font-size: 0.75rem; color: #666; }
  .status-option input:checked + .status-card.approved { border-color: #16a34a; background: #f0fdf4; }
  .status-option input:checked + .status-card.pending { border-color: #d97706; background: #fffbeb; }
  .status-option input:checked + .status-card.suspended { border-color: #dc2626; background: #fef2f2; }
  
  .avatar { width: 40px; height: 40px; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; }
  .loading-spinner { text-align: center; padding: 3rem; }
  .spinner { width: 40px; height: 40px; border: 3px solid #e5e5e5; border-top-color: #dc2626; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .badge-purple { background: #7c3aed; color: #fff; }
  .btn-group { display: flex; gap: 0.5rem; justify-content: flex-end; }
  .btn-outline { background: transparent; border: 1px solid #ccc; color: #666; }
  .btn-outline:hover { background: #f5f5f5; }
  .text-sm { font-size: 0.8rem; }
  .modal-lg { max-width: 600px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  
  @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .status-options { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }
  @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
</style>
