---
// src/pages/admin/index.astro
import Layout from '../../layouts/Layout.astro';
import { v2 as cloudinary } from 'cloudinary';

cloudinary.config({
  cloud_name: 'dscqbze0d',
  api_key: '555922422486159',
  api_secret: '1OV_96Pd_x7MSdt7Bph5aNELYho',
});

// Get merch count server-side (same as manage page)
let merchProductCount = 0;
try {
  const info = await cloudinary.api.resource('merch/products.json', {
    resource_type: 'raw'
  });
  
  const version = info.version;
  const productsUrl = `https://res.cloudinary.com/dscqbze0d/raw/upload/v${version}/merch/products.json`;
  
  const response = await fetch(productsUrl, { cache: 'no-store' });
  
  if (response.ok) {
    const data = await response.json();
    if (Array.isArray(data)) {
      merchProductCount = data.length;
    }
  }
} catch (error) {
  console.error('Error loading merch count:', error);
}
---

<Layout title="Fresh Wax Admin Dashboard">
	<style>
		body {
			background: #ffffff;
		}

		.admin-container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 20px;
			background: #ffffff;
		}

		.admin-loading-container {
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			background: #ffffff;
		}

		.admin-loading-content {
			text-align: center;
		}

		.admin-spinner {
			width: 50px;
			height: 50px;
			border: 3px solid #e0e0e0;
			border-top: 3px solid #000;
			border-radius: 50%;
			animation: admin-spin 1s linear infinite;
			margin: 0 auto 20px;
		}

		@keyframes admin-spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.admin-loading-text {
			color: #000;
			font-size: 16px;
			font-weight: 600;
		}

		.admin-logo-container {
			background: #ffffff;
			padding: 30px 20px;
			margin-bottom: 30px;
			display: flex;
			justify-content: center;
			align-items: center;
			border: 3px solid #000;
		}

		.admin-logo {
			height: 80px;
			width: auto;
			max-width: 90%;
			display: block;
		}

		.admin-header-card {
			background: #fff;
			padding: 30px;
			margin-bottom: 30px;
			border: 3px solid #000;
			position: relative;
		}

		.admin-header-card::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 5px;
			background: #000;
		}

		.admin-header-card h1 {
			font-size: 32px;
			color: #000;
			margin-bottom: 10px;
			font-weight: 900;
			letter-spacing: -0.5px;
		}

		.admin-logout-btn {
			position: absolute;
			top: 20px;
			right: 20px;
			padding: 10px 20px;
			background: #000;
			color: #ffffff;
			border: 3px solid #000;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.2s;
			font-size: 14px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.admin-logout-btn:hover {
			background: #ffffff;
			color: #000;
			transform: translate(-2px, -2px);
			box-shadow: 4px 4px 0 #000;
		}

		.admin-stats-row {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 15px;
			margin-bottom: 30px;
		}

		.admin-stat-card {
			background: #fff;
			border: 3px solid #000;
			padding: 15px;
			transition: all 0.2s;
			min-height: 90px;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}

		.admin-stat-card:hover {
			transform: translate(-2px, -2px);
			box-shadow: 4px 4px 0 #000;
		}

		.admin-stat-label {
			font-size: 10px;
			font-weight: 700;
			color: #666;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 8px;
			line-height: 1.2;
		}

		.admin-stat-value {
			font-size: 24px;
			font-weight: 900;
			color: #000;
			line-height: 1;
			word-break: break-word;
		}

		.section-header {
			background: #fff;
			border: 3px solid #000;
			padding: 15px 20px;
			margin-bottom: 20px;
			margin-top: 30px;
		}

		.section-header h2 {
			font-size: 20px;
			font-weight: 900;
			color: #000;
			margin: 0;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.admin-modules-grid {
			display: grid;
			grid-template-columns: repeat(5, 1fr);
			gap: 15px;
			margin-bottom: 30px;
		}

		.admin-module-card {
			background: #fff;
			border: 3px solid #000;
			padding: 20px;
			cursor: pointer;
			transition: all 0.2s;
			text-align: center;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			min-height: 120px;
		}

		.admin-module-card:hover {
			transform: translate(-2px, -2px);
			box-shadow: 4px 4px 0 #000;
		}

		.admin-module-icon {
			font-size: 36px;
			margin-bottom: 10px;
		}

		.admin-module-title {
			font-size: 13px;
			font-weight: 900;
			color: #000;
			text-transform: uppercase;
			letter-spacing: 0.3px;
			line-height: 1.3;
		}

		.success-message {
			position: fixed;
			top: 20px;
			right: 20px;
			background: #000;
			color: #ffffff;
			padding: 15px 20px;
			border: 3px solid #000;
			font-weight: 700;
			box-shadow: 8px 8px 0 #000;
			z-index: 10000;
			animation: slideIn 0.3s ease-out;
		}

		@keyframes slideIn {
			from {
				transform: translateX(400px);
				opacity: 0;
			}
			to {
				transform: translateX(0);
				opacity: 1;
			}
		}

		/* Tablet */
		@media (max-width: 1024px) {
			.admin-stats-row {
				grid-template-columns: repeat(3, 1fr);
			}

			.admin-modules-grid {
				grid-template-columns: repeat(4, 1fr);
			}
		}

		/* Mobile Large */
		@media (max-width: 768px) {
			.admin-container {
				padding: 15px;
			}

			.admin-header-card {
				padding: 20px;
			}

			.admin-header-card h1 {
				font-size: 24px;
				padding-right: 90px;
			}

			.admin-logout-btn {
				padding: 8px 12px;
				font-size: 12px;
			}

			.admin-stats-row {
				grid-template-columns: repeat(2, 1fr);
				gap: 12px;
			}

			.admin-stat-card {
				padding: 12px;
				min-height: 80px;
			}

			.admin-stat-value {
				font-size: 20px;
			}

			.admin-modules-grid {
				grid-template-columns: repeat(3, 1fr);
				gap: 12px;
			}

			.admin-module-card {
				padding: 15px;
				min-height: 100px;
			}

			.admin-module-icon {
				font-size: 28px;
			}

			.admin-module-title {
				font-size: 11px;
			}
		}

		/* Mobile Small */
		@media (max-width: 480px) {
			.admin-stats-row {
				grid-template-columns: repeat(2, 1fr);
			}

			.admin-modules-grid {
				grid-template-columns: repeat(2, 1fr);
			}

			.admin-module-title {
				font-size: 10px;
			}
		}

		/* Mobile Extra Small */
		@media (max-width: 360px) {
			.admin-stats-row {
				grid-template-columns: 1fr;
			}

			.admin-modules-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>

	<div class="admin-container">
		<div id="loadingScreen" class="admin-loading-container">
			<div class="admin-loading-content">
				<div class="admin-spinner"></div>
				<p class="admin-loading-text">Loading dashboard...</p>
			</div>
		</div>

		<div id="dashboardContent" style="display: none;">
			<!-- Logo Header -->
			<div class="admin-logo-container">
				<img 
					src="/logo.webp" 
					alt="Fresh Wax" 
					class="admin-logo"
					onerror="this.style.display='none'"
				>
			</div>

			<!-- Main Header -->
			<div class="admin-header-card">
				<button class="admin-logout-btn" id="logoutBtn">
					🚪 Logout
				</button>
				<h1>Welcome back Dave!</h1>
			</div>

			<!-- Stats Row -->
			<div class="admin-stats-row">
				<div class="admin-stat-card">
					<div class="admin-stat-label">Total Sales</div>
					<div class="admin-stat-value" id="totalSales">£0.00</div>
				</div>
				<div class="admin-stat-card">
					<div class="admin-stat-label">Platform Fees</div>
					<div class="admin-stat-value" id="platformFees">£0.00</div>
				</div>
				<div class="admin-stat-card">
					<div class="admin-stat-label">Pending Artists</div>
					<div class="admin-stat-value" id="pendingArtistsCount">0</div>
				</div>
				<div class="admin-stat-card">
					<div class="admin-stat-label">Store Releases</div>
					<div class="admin-stat-value" id="activeReleases">0</div>
				</div>
				<div class="admin-stat-card">
					<div class="admin-stat-label">Merch Products</div>
					<div class="admin-stat-value" id="merchCount">{merchProductCount}</div>
				</div>
				<div class="admin-stat-card">
					<div class="admin-stat-label">DJ Mixes</div>
					<div class="admin-stat-value" id="djMixesCount">0</div>
				</div>
			</div>

			<!-- WORKFLOW SECTION -->
			<div class="section-header">
				<h2>⚡ Store Management</h2>
			</div>

			<div class="admin-modules-grid">
				<div class="admin-module-card" data-link="/admin/artists/pending">
					<div class="admin-module-icon">✅</div>
					<div class="admin-module-title">Artist Approvals</div>
				</div>

				<div class="admin-module-card" data-link="/admin/upload-release-zip">
					<div class="admin-module-icon">📤</div>
					<div class="admin-module-title">Upload Release</div>
				</div>

				<div class="admin-module-card" data-link="/admin/publish-release">
					<div class="admin-module-icon">🚀</div>
					<div class="admin-module-title">Publish to Store</div>
				</div>

				<div class="admin-module-card" data-link="/admin/releases/manage">
					<div class="admin-module-icon">🎵</div>
					<div class="admin-module-title">Manage Releases</div>
				</div>

				<div class="admin-module-card" data-link="/admin/merch-upload-tool">
					<div class="admin-module-icon">📤</div>
					<div class="admin-module-title">Upload Merch</div>
				</div>

				<div class="admin-module-card" data-link="/admin/merch/manage">
					<div class="admin-module-icon">👕</div>
					<div class="admin-module-title">Manage Merch</div>
				</div>

				<div class="admin-module-card" data-link="/admin/account/manage">
					<div class="admin-module-icon">👥</div>
					<div class="admin-module-title">Customers</div>
				</div>

				<div class="admin-module-card" data-link="/admin/artists/manage">
					<div class="admin-module-icon">🎤</div>
					<div class="admin-module-title">Artists</div>
				</div>

				<div class="admin-module-card" data-link="/admin/orders">
					<div class="admin-module-icon">📦</div>
					<div class="admin-module-title">Orders</div>
				</div>

				<div class="admin-module-card" data-link="/admin/analytics">
					<div class="admin-module-icon">📊</div>
					<div class="admin-module-title">Analytics</div>
				</div>
			</div>

			<!-- DJ MIXES SECTION -->
			<div class="section-header">
				<h2>🎧 DJ Mixes</h2>
			</div>

			<div class="admin-modules-grid">
				<div class="admin-module-card" data-link="/admin/dj-mixes/manage">
					<div class="admin-module-icon">🗑️</div>
					<div class="admin-module-title">Manage & Delete</div>
				</div>

				<div class="admin-module-card" data-link="/dj-mixes">
					<div class="admin-module-icon">🎛️</div>
					<div class="admin-module-title">Public Page</div>
				</div>

				<div class="admin-module-card" data-link="/upload-mix">
					<div class="admin-module-icon">📤</div>
					<div class="admin-module-title">Upload Test</div>
				</div>

				<div class="admin-module-card" onclick="window.open('https://cloudinary.com/console/media_library/folders/dj-mixes', '_blank')">
					<div class="admin-module-icon">☁️</div>
					<div class="admin-module-title">Storage</div>
				</div>
			</div>
		</div>
	</div>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
		import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
		import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

		const firebaseConfig = {
			apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
			authDomain: "freshwax-store.firebaseapp.com",
			projectId: "freshwax-store",
			storageBucket: "freshwax-store.firebasestorage.app",
			messagingSenderId: "675435782973",
			appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
		};

		const app = initializeApp(firebaseConfig);
		const auth = getAuth(app);
		const db = getFirestore(app);

		// Auth check
		onAuthStateChanged(auth, async (user) => {
			if (user) {
				await loadDashboard();
			} else {
				window.location.href = '/login';
			}
		});

		async function loadDashboard() {
			try {
				await loadStats();
				document.getElementById('loadingScreen').style.display = 'none';
				document.getElementById('dashboardContent').style.display = 'block';
			} catch (error) {
				console.error('Error loading dashboard:', error);
			}
		}

		async function loadStats() {
			try {
				// FIXED: Get pending artists by checking approved field
				const artistsSnapshot = await getDocs(collection(db, 'artists'));
				let pendingCount = 0;
				
				artistsSnapshot.forEach(doc => {
					const artist = doc.data();
					// Count as pending if approved is false or undefined
					if (artist.approved === false || artist.approved === undefined) {
						pendingCount++;
					}
				});
				
				document.getElementById('pendingArtistsCount').textContent = pendingCount;
				console.log('Pending artists count:', pendingCount); // Debug log

				// Store releases
				const releasesSnapshot = await getDocs(collection(db, 'releases'));
				document.getElementById('activeReleases').textContent = releasesSnapshot.size;

				// Merch count is set server-side, no need to fetch here

				// Sales and fees
				const ordersSnapshot = await getDocs(collection(db, 'orders'));
				let totalSales = 0;
				let totalFees = 0;

				ordersSnapshot.forEach(doc => {
					const order = doc.data();
					totalSales += order.amount || 0;
					totalFees += order.platformFee || 0;
				});

				document.getElementById('totalSales').textContent = `£${totalSales.toFixed(2)}`;
				document.getElementById('platformFees').textContent = `£${totalFees.toFixed(2)}`;

				// DJ Mixes count
				try {
					const mixesResponse = await fetch('https://res.cloudinary.com/dscqbze0d/raw/upload/dj-mixes/mixes.json?cache=' + Date.now());
					if (mixesResponse.ok) {
						const mixes = await mixesResponse.json();
						document.getElementById('djMixesCount').textContent = Array.isArray(mixes) ? mixes.length : 0;
					}
				} catch (e) {
					console.log('No DJ mixes yet');
				}
			} catch (error) {
				console.error('Error loading stats:', error);
			}
		}

		// Logout
		document.getElementById('logoutBtn').addEventListener('click', async () => {
			try {
				await signOut(auth);
				window.location.href = '/login';
			} catch (error) {
				console.error('Logout error:', error);
			}
		});

		// Module navigation
		document.querySelectorAll('.admin-module-card[data-link]').forEach(card => {
			card.addEventListener('click', () => {
				window.location.href = card.getAttribute('data-link');
			});
		});
	</script>
</Layout>