---
// src/pages/admin/index.astro
// Fresh Wax Admin Dashboard - Unified Design
// Central hub for all admin operations - Uses Firebase REST API

import AdminLayout from '../../layouts/AdminLayout.astro';
import { queryCollection } from '../../lib/firebase-rest';
import '../../styles/admin/index.css';

// Fetch all data using REST API with error handling
let ordersData: any[] = [];
let releasesData: any[] = [];
let artistsData: any[] = [];
let merchData: any[] = [];
let mixesData: any[] = [];
let livestreamsData: any[] = [];
let bypassRequestsData: any[] = [];

try {
  const results = await Promise.allSettled([
    queryCollection('orders', { limit: 50 }),
    queryCollection('releases'),
    queryCollection('artists'),
    queryCollection('merch'),
    queryCollection('dj-mixes'),
    queryCollection('livestreams', { limit: 10 }),
    queryCollection('bypassRequests', { limit: 20 })
  ]);

  ordersData = results[0].status === 'fulfilled' ? results[0].value : [];
  releasesData = results[1].status === 'fulfilled' ? results[1].value : [];
  artistsData = results[2].status === 'fulfilled' ? results[2].value : [];
  merchData = results[3].status === 'fulfilled' ? results[3].value : [];
  mixesData = results[4].status === 'fulfilled' ? results[4].value : [];
  livestreamsData = results[5].status === 'fulfilled' ? results[5].value : [];
  bypassRequestsData = results[6].status === 'fulfilled' ? results[6].value.filter((r: any) => r.status === 'pending') : [];
} catch (error) {
  console.error('[Admin Dashboard] Error fetching data:', error);
}

// Process orders - sort by createdAt desc
const orders = ordersData
  .map(order => ({
    ...order,
    createdAt: order.createdAt ? new Date(order.createdAt) : new Date()
  }))
  .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

// Calculate stats
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

const todayOrders = orders.filter(o => o.createdAt >= startOfToday);
const monthOrders = orders.filter(o => o.createdAt >= startOfMonth);
const pendingOrders = orders.filter(o => o.status === 'pending');

const todayRevenue = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
const monthRevenue = monthOrders.reduce((sum, o) => sum + (o.total || 0), 0);

// Partner stats (data already in array format from REST API)
const artists = artistsData;
const pendingPartners = artists.filter(a => a.approved === false);
const approvedPartners = artists.filter(a => a.approved === true);

// Release stats
const releases = releasesData;
const liveReleases = releases.filter(r => r.status === 'live');
const pendingReleases = releases.filter(r => r.status === 'pending');

// Merch stats
const merch = merchData;
const lowStockMerch = merch.filter(m => {
  if (m.variants) {
    return m.variants.some(v => (v.stock || 0) <= 5 && (v.stock || 0) > 0);
  }
  return (m.stock || 0) <= 5 && (m.stock || 0) > 0;
});
const outOfStockMerch = merch.filter(m => {
  if (m.variants) {
    return m.variants.every(v => (v.stock || 0) === 0);
  }
  return (m.stock || 0) === 0;
});

// DJ Mixes stats
const mixes = mixesData;
const publishedMixes = mixes.filter(m => m.published);
const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);

// Livestream stats - sort by startedAt desc
const livestreams = livestreamsData
  .map(ls => ({
    ...ls,
    startedAt: ls.startedAt ? new Date(ls.startedAt) : null,
    endedAt: ls.endedAt ? new Date(ls.endedAt) : null
  }))
  .sort((a, b) => (b.startedAt?.getTime() || 0) - (a.startedAt?.getTime() || 0));
const activeLivestream = livestreams.find(ls => ls.status === 'live');
const recentLivestreams = livestreams.slice(0, 5);

// Bypass requests - filter out expired ones (15 minutes)
const fifteenMinsAgo = new Date(Date.now() - 15 * 60 * 1000);
const bypassRequests = bypassRequestsData
  .filter(req => {
    // Filter out requests older than 15 minutes
    if (!req.createdAt) return true;
    const createdDate = new Date(req.createdAt);
    return createdDate > fifteenMinsAgo;
  });

// Recent orders (last 5)
const recentOrders = orders.slice(0, 5);

// Format helpers
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

const formatDate = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'short',
    hour: '2-digit',
    minute: '2-digit'
  });
};

const formatNumber = (num) => {
  return new Intl.NumberFormat('en-GB').format(num);
};

// Alerts
const alerts = [];
if (pendingPartners.length > 0) {
  alerts.push({ type: 'warning', icon: 'üë•', text: `${pendingPartners.length} partner${pendingPartners.length !== 1 ? 's' : ''} awaiting approval`, link: '/admin/artists/pending' });
}
if (pendingOrders.length > 0) {
  alerts.push({ type: 'info', icon: 'üì¶', text: `${pendingOrders.length} order${pendingOrders.length !== 1 ? 's' : ''} need processing`, link: '/admin/orders' });
}
if (lowStockMerch.length > 0) {
  alerts.push({ type: 'warning', icon: '‚ö†Ô∏è', text: `${lowStockMerch.length} product${lowStockMerch.length !== 1 ? 's' : ''} running low on stock`, link: '/admin/inventory' });
}
if (outOfStockMerch.length > 0) {
  alerts.push({ type: 'danger', icon: 'üö´', text: `${outOfStockMerch.length} product${outOfStockMerch.length !== 1 ? 's' : ''} out of stock`, link: '/admin/inventory' });
}

export const prerender = false;
---

<AdminLayout title="Dashboard" activeNav="dashboard">
  <Fragment slot="breadcrumb">
    <div class="header-breadcrumb">
      <span>Admin Dashboard</span>
    </div>
  </Fragment>

  <Fragment slot="actions">
    <button class="btn btn-ghost" onclick="window.location.reload()">
      ‚Üª Refresh
    </button>
  </Fragment>

  <!-- Alerts Section -->
  {alerts.length > 0 && (
    <div class="alerts-section mb-4">
      {alerts.map(alert => (
        <a href={alert.link} class={`alert-item alert-${alert.type}`}>
          <span class="alert-icon">{alert.icon}</span>
          <span class="alert-text">{alert.text}</span>
          <span class="alert-arrow">‚Üí</span>
        </a>
      ))}
    </div>
  )}

  <!-- Main Stats Grid -->
  <div class="stats-grid cols-6 mb-4">
    <div class="stat-card highlight">
      <div class="stat-label">Today's Revenue</div>
      <div class="stat-value">{formatCurrency(todayRevenue)}</div>
      <div class="stat-detail">{todayOrders.length} order{todayOrders.length !== 1 ? 's' : ''}</div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">This Month</div>
      <div class="stat-value">{formatCurrency(monthRevenue)}</div>
      <div class="stat-detail">{monthOrders.length} orders</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Pending Orders</div>
      <div class="stat-value">{pendingOrders.length}</div>
      <div class="stat-detail">Need attention</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Live Releases</div>
      <div class="stat-value">{liveReleases.length}</div>
      <div class="stat-detail">{pendingReleases.length} pending</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Partners</div>
      <div class="stat-value">{approvedPartners.length}</div>
      <div class="stat-detail">{pendingPartners.length} pending</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Mix Plays</div>
      <div class="stat-value">{formatNumber(totalPlays)}</div>
      <div class="stat-detail">{publishedMixes.length} mixes</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="actions-grid mb-4">
    <a href="/admin/merch/upload" class="action-card primary">
      <span class="card-icon">üëï</span>
      <span class="card-title">Add Merch</span>
    </a>
    <a href="/admin/streaming" class="action-card" style="position: relative;">
      <span class="card-icon">üî¥</span>
      <span class="card-title">Live Stream</span>
      {activeLivestream && (
        <span class="card-badge live-pulse">LIVE</span>
      )}
    </a>
    <a href="/admin/orders" class="action-card" style="position: relative;">
      <span class="card-icon">üìã</span>
      <span class="card-title">Orders</span>
      {pendingOrders.length > 0 && (
        <span class="card-badge">{pendingOrders.length}</span>
      )}
    </a>
    <a href="/admin/artists/pending" class="action-card" style="position: relative;">
      <span class="card-icon">‚úÖ</span>
      <span class="card-title">Approvals</span>
      {pendingPartners.length > 0 && (
        <span class="card-badge">{pendingPartners.length}</span>
      )}
    </a>
    <a href="/admin/analytics" class="action-card">
      <span class="card-icon">üìà</span>
      <span class="card-title">Analytics</span>
    </a>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-2 gap-2">
    <!-- Recent Orders -->
    <div class="card">
      <div class="card-header">
        <h2>üìã Recent Orders</h2>
        <a href="/admin/orders" class="btn btn-ghost btn-sm">View All ‚Üí</a>
      </div>
      {recentOrders.length === 0 ? (
        <div class="card-body">
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-title">No orders yet</div>
            <p class="empty-state-text">Orders will appear here as they come in.</p>
          </div>
        </div>
      ) : (
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {recentOrders.map(order => (
                <tr>
                  <td class="cell-mono">#{order.id?.slice(-6).toUpperCase()}</td>
                  <td class="font-bold">{formatCurrency(order.total)}</td>
                  <td><span class={`badge badge-${order.status}`}>{order.status}</span></td>
                  <td class="cell-secondary">{formatDate(order.createdAt)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>

    <!-- Quick Links & Status -->
    <div class="card">
      <div class="card-header">
        <h2>‚ö° Quick Access</h2>
      </div>
      <div class="card-body">
        <div class="quick-links">
          <a href="/admin/releases/manage" class="quick-link">
            <span class="quick-icon">üíø</span>
            <span class="quick-text">Manage Releases</span>
            <span class="quick-count">{releases.length}</span>
          </a>
          <a href="/admin/artists/manage" class="quick-link">
            <span class="quick-icon">üé§</span>
            <span class="quick-text">Manage Partners</span>
            <span class="quick-count">{approvedPartners.length}</span>
          </a>
          <a href="/admin/inventory" class="quick-link">
            <span class="quick-icon">üëï</span>
            <span class="quick-text">Stock & Inventory</span>
            <span class="quick-count">{merch.length}</span>
          </a>
          <a href="/admin/dj-mixes/manage" class="quick-link">
            <span class="quick-icon">üéß</span>
            <span class="quick-text">Manage DJ Mixes</span>
            <span class="quick-count">{mixes.length}</span>
          </a>
          <a href="/admin/streaming" class="quick-link">
            <span class="quick-icon">üî¥</span>
            <span class="quick-text">Manage Live Stream</span>
            <span class="quick-count">{activeLivestream ? 'LIVE' : 'Off'}</span>
          </a>
          <a href="/admin/users" class="quick-link">
            <span class="quick-icon">üë•</span>
            <span class="quick-text">User Management</span>
            <span class="quick-count">-</span>
          </a>
          <a href="/admin/merch/suppliers" class="quick-link">
            <span class="quick-icon">üè≠</span>
            <span class="quick-text">Merch Suppliers</span>
            <span class="quick-count">-</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Stream Management -->
  <div class="card mt-4 livestream-card">
    <div class="card-header">
      <h2>üî¥ Live Stream Control</h2>
      <a href="/admin/streaming" class="btn btn-primary btn-sm">Manage Live ‚Üí</a>
    </div>
    <div class="card-body">
      <div class="livestream-status-grid">
        <!-- Current Status -->
        <div class="livestream-status-panel">
          <div class="status-indicator {activeLivestream ? 'live' : 'offline'}">
            <span class="status-dot-large"></span>
            <span class="status-text">{activeLivestream ? 'ON AIR' : 'OFFLINE'}</span>
          </div>
          {activeLivestream ? (
            <div class="live-info">
              <div class="live-detail">
                <span class="detail-label">DJ</span>
                <span class="detail-value">{activeLivestream.djName || 'Unknown'}</span>
              </div>
              <div class="live-detail">
                <span class="detail-label">Title</span>
                <span class="detail-value">{activeLivestream.title || 'Live Session'}</span>
              </div>
              <div class="live-detail">
                <span class="detail-label">Started</span>
                <span class="detail-value">{activeLivestream.startedAt ? formatDate(activeLivestream.startedAt) : '-'}</span>
              </div>
              <div class="live-detail">
                <span class="detail-label">Viewers</span>
                <span class="detail-value" id="viewerCount">{activeLivestream.viewerCount || 0}</span>
              </div>
            </div>
          ) : (
            <div class="offline-message">
              <p>No active stream. DJs can go live from the DJ Lobby.</p>
              <a href="/live" class="btn btn-ghost btn-sm">View Live Page ‚Üí</a>
            </div>
          )}
        </div>

        <!-- Quick Actions -->
        <div class="livestream-actions">
          <a href="/admin/streaming" class="livestream-action-btn">
            <span class="action-icon">‚öôÔ∏è</span>
            <span class="action-label">Stream Settings</span>
          </a>
          <a href="/admin/streaming/schedule" class="livestream-action-btn">
            <span class="action-icon">üìÖ</span>
            <span class="action-label">Schedule</span>
          </a>
          <a href="/live" class="livestream-action-btn" target="_blank">
            <span class="action-icon">üì∫</span>
            <span class="action-label">Watch Live</span>
          </a>
          <a href="/admin/streaming/history" class="livestream-action-btn">
            <span class="action-icon">üìú</span>
            <span class="action-label">History</span>
          </a>
        </div>
      </div>

      {recentLivestreams.length > 0 && (
        <div class="recent-streams">
          <h4>Recent Streams</h4>
          <div class="streams-list">
            {recentLivestreams.slice(0, 3).map(stream => (
              <div class="stream-item">
                <span class="stream-dj">{stream.djName || 'Unknown DJ'}</span>
                <span class="stream-title">{stream.title || 'Live Session'}</span>
                <span class="stream-date">{stream.startedAt ? formatDate(stream.startedAt) : '-'}</span>
                <span class={`stream-status status-${stream.status}`}>{stream.status}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Bypass Requests Section -->
      <div class="bypass-requests-section" id="bypassRequestsSection">
        <h4>üé´ Go Live Bypass Requests</h4>
        <div id="bypassRequestsList" class="bypass-requests-list">
          {bypassRequests.length === 0 ? (
            <div class="no-requests">
              <span class="no-requests-icon">‚úì</span>
              <span>No pending requests</span>
            </div>
          ) : (
            bypassRequests.map(req => (
              <div class="bypass-request-item" data-request-id={req.id} data-created-at={req.createdAt}>
                <div class="request-info">
                  <span class="request-user">{req.userName || req.userEmail || 'Unknown User'}</span>
                  <span class="request-email">{req.userEmail || ''}</span>
                  {req.reason && <span class="request-reason">"{req.reason}"</span>}
                </div>
                <div class="request-meta">
                  <span class="request-time" data-time={req.createdAt}></span>
                  <span class="request-status pending">Pending</span>
                </div>
                <div class="request-actions">
                  <button class="btn-approve" data-id={req.id} data-user={req.userId}>
                    ‚úì Approve
                  </button>
                  <button class="btn-reject" data-id={req.id}>
                    ‚úï Reject
                  </button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- System Monitor -->
  <div class="card mt-4 monitor-card">
    <div class="card-header">
      <h2>üìä System Monitor</h2>
      <div class="monitor-header-actions">
        <span id="monitorLastUpdate" class="monitor-timestamp">Checking...</span>
        <button id="refreshMonitor" class="btn btn-ghost btn-sm">‚Üª Refresh</button>
      </div>
    </div>
    <div class="card-body">
      <div class="monitor-grid">
        <!-- Live Stream Preview -->
        <div class="monitor-section monitor-preview">
          <h3 class="monitor-section-title">Live Stream</h3>
          <div id="streamPreview" class="stream-preview">
            <div class="preview-placeholder">
              <span class="preview-icon">üì∫</span>
              <span class="preview-text">No active stream</span>
            </div>
          </div>
          <div id="streamInfo" class="stream-info hidden">
            <div class="stream-info-row">
              <span class="info-label">DJ:</span>
              <span id="streamDJ" class="info-value">-</span>
            </div>
            <div class="stream-info-row">
              <span class="info-label">Title:</span>
              <span id="streamTitle" class="info-value">-</span>
            </div>
            <div class="stream-info-row">
              <span class="info-label">Viewers:</span>
              <span id="streamViewers" class="info-value">0</span>
            </div>
            <div class="stream-info-row">
              <span class="info-label">Duration:</span>
              <span id="streamDuration" class="info-value">00:00:00</span>
            </div>
          </div>
        </div>

        <!-- Service Health -->
        <div class="monitor-section monitor-health">
          <h3 class="monitor-section-title">Service Health</h3>
          <div id="serviceHealth" class="health-grid">
            <div class="health-item" data-service="Firebase">
              <span class="health-dot checking"></span>
              <span class="health-name">Firebase</span>
              <span class="health-latency">-</span>
            </div>
            <div class="health-item" data-service="R2 Storage">
              <span class="health-dot checking"></span>
              <span class="health-name">R2 Storage</span>
              <span class="health-latency">-</span>
            </div>
            <div class="health-item" data-service="Stripe">
              <span class="health-dot checking"></span>
              <span class="health-name">Stripe</span>
              <span class="health-latency">-</span>
            </div>
            <div class="health-item" data-service="Stream Server">
              <span class="health-dot checking"></span>
              <span class="health-name">Stream Server</span>
              <span class="health-latency">-</span>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="monitor-section monitor-stats">
          <h3 class="monitor-section-title">Today's Activity</h3>
          <div class="quick-stats-grid">
            <div class="quick-stat">
              <span class="quick-stat-value" id="statOrdersToday">-</span>
              <span class="quick-stat-label">Orders</span>
            </div>
            <div class="quick-stat">
              <span class="quick-stat-value" id="statRevenueToday">-</span>
              <span class="quick-stat-label">Revenue</span>
            </div>
            <div class="quick-stat">
              <span class="quick-stat-value" id="statServicesOk">-</span>
              <span class="quick-stat-label">Services OK</span>
            </div>
            <div class="quick-stat">
              <span class="quick-stat-value" id="statStreamStatus">-</span>
              <span class="quick-stat-label">Stream</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feature Toggles -->
  <div class="card mt-4">
    <div class="card-header">
      <h2>‚öôÔ∏è Feature Settings</h2>
    </div>
    <div class="card-body">
      <div class="toggle-list">
        <div class="toggle-item">
          <div class="toggle-info">
            <span class="toggle-label">DJ Mix Charts</span>
            <span class="toggle-desc">Show floating all-time chart on DJ Mixes page</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleMixCharts" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card mt-4 danger-zone">
    <div class="card-header danger-header">
      <h2>‚ö†Ô∏è Danger Zone</h2>
    </div>
    <div class="card-body">
      <div class="danger-item">
        <div class="danger-info">
          <h3>Reset Store</h3>
          <p>This will permanently delete all data from Firebase and R2 storage, except your admin account. This action cannot be undone.</p>
        </div>
        <button id="resetStoreBtn" class="btn-danger">Reset Store</button>
      </div>
    </div>
  </div>

  <!-- Reset Confirmation Modal -->
  <div id="resetModal" class="modal-overlay hidden">
    <div class="modal-content danger-modal">
      <h2>‚ö†Ô∏è Confirm Store Reset</h2>
      <p>This will permanently delete:</p>
      <ul>
        <li>All customers (except admin account)</li>
        <li>All orders and order history</li>
        <li>All releases and tracks</li>
        <li>All DJ mixes</li>
        <li>All merchandise</li>
        <li>All partners/artists</li>
        <li>All files in R2 storage</li>
      </ul>
      <p class="danger-warning">Type <strong>RESET</strong> to confirm:</p>
      <input type="text" id="resetConfirmInput" class="reset-confirm-input" placeholder="Type RESET" />
      <div class="modal-actions">
        <button id="cancelResetBtn" class="btn-secondary">Cancel</button>
        <button id="confirmResetBtn" class="btn-danger" disabled>Reset Everything</button>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // Feature toggle handling
  document.addEventListener('DOMContentLoaded', async function() {
    const toggleMixCharts = document.getElementById('toggleMixCharts');
    const resetStoreBtn = document.getElementById('resetStoreBtn');
    const resetModal = document.getElementById('resetModal');
    const resetConfirmInput = document.getElementById('resetConfirmInput');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    const cancelResetBtn = document.getElementById('cancelResetBtn');

    // Load current settings
    try {
      const response = await fetch('/api/admin/get-settings');
      const data = await response.json();
      if (data.success && data.settings) {
        toggleMixCharts.checked = data.settings.showMixCharts || false;
      }
    } catch (error) {
      console.error('Failed to load settings:', error);
    }

    // Save toggle changes
    toggleMixCharts?.addEventListener('change', async function() {
      try {
        await fetch('/api/admin/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ showMixCharts: this.checked })
        });
      } catch (error) {
        console.error('Failed to save setting:', error);
      }
    });

    // Reset store modal
    resetStoreBtn?.addEventListener('click', function() {
      resetModal.classList.remove('hidden');
      resetConfirmInput.value = '';
      confirmResetBtn.disabled = true;
    });

    cancelResetBtn?.addEventListener('click', function() {
      resetModal.classList.add('hidden');
    });

    resetConfirmInput?.addEventListener('input', function() {
      confirmResetBtn.disabled = this.value !== 'RESET';
    });

    confirmResetBtn?.addEventListener('click', async function() {
      if (resetConfirmInput.value !== 'RESET') return;
      
      this.disabled = true;
      this.textContent = 'Resetting...';
      
      try {
        const response = await fetch('/api/admin/reset-store', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
          alert('Store has been reset successfully. The page will now reload.');
          window.location.reload();
        } else {
          alert('Reset failed: ' + (data.error || 'Unknown error'));
          this.disabled = false;
          this.textContent = 'Reset Everything';
        }
      } catch (error) {
        alert('Reset failed: ' + error.message);
        this.disabled = false;
        this.textContent = 'Reset Everything';
      }
    });

    // Close modal on overlay click
    resetModal?.addEventListener('click', function(e) {
      if (e.target === resetModal) {
        resetModal.classList.add('hidden');
      }
    });
  });
</script>


<script>
  // Bypass Request Management
  const EXPIRY_TIME = 15 * 60 * 1000; // 15 minutes
  
  // Update time displays and check for expired requests
  function updateRequestTimes() {
    document.querySelectorAll('.bypass-request-item').forEach(item => {
      const createdAt = item.dataset.createdAt;
      if (!createdAt) return;
      
      const createdDate = new Date(createdAt);
      const now = Date.now();
      const elapsed = now - createdDate.getTime();
      const remaining = EXPIRY_TIME - elapsed;
      
      const timeEl = item.querySelector('.request-time');
      const statusEl = item.querySelector('.request-status');
      
      if (remaining <= 0) {
        // Request expired
        item.classList.add('expired');
        if (statusEl) {
          statusEl.textContent = 'Expired';
          statusEl.className = 'request-status expired';
        }
        if (timeEl) timeEl.textContent = 'Expired';
        
        // Disable buttons
        item.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        // Auto-expire on server
        autoExpireRequest(item.dataset.requestId);
      } else {
        // Show countdown
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        if (timeEl) timeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')} left`;
      }
    });
  }
  
  // Auto-expire request on server
  async function autoExpireRequest(requestId) {
    try {
      await fetch('/api/admin/bypass-requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'expire', requestId })
      });
    } catch (e) {
      console.error('Failed to expire request:', e);
    }
  }
  
  // Handle approve button click
  document.querySelectorAll('.btn-approve').forEach(btn => {
    btn.addEventListener('click', async () => {
      const requestId = btn.dataset.id;
      const userId = btn.dataset.user;
      const item = btn.closest('.bypass-request-item');
      
      btn.disabled = true;
      btn.textContent = 'Approving...';
      
      try {
        const response = await fetch('/api/admin/bypass-requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'approve', requestId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          item.classList.remove('expired');
          item.classList.add('approved');
          const statusEl = item.querySelector('.request-status');
          if (statusEl) {
            statusEl.textContent = 'Approved';
            statusEl.className = 'request-status approved';
          }
          item.querySelectorAll('button').forEach(b => b.style.display = 'none');
          
          // Show success message
          const timeEl = item.querySelector('.request-time');
          if (timeEl) timeEl.textContent = '‚úì User can now go live';
        } else {
          btn.disabled = false;
          btn.textContent = '‚úì Approve';
          alert('Failed to approve: ' + result.error);
        }
      } catch (e) {
        btn.disabled = false;
        btn.textContent = '‚úì Approve';
        alert('Error approving request');
      }
    });
  });
  
  // Handle reject button click
  document.querySelectorAll('.btn-reject').forEach(btn => {
    btn.addEventListener('click', async () => {
      const requestId = btn.dataset.id;
      const item = btn.closest('.bypass-request-item');
      
      if (!confirm('Reject this bypass request?')) return;
      
      btn.disabled = true;
      btn.textContent = 'Rejecting...';
      
      try {
        const response = await fetch('/api/admin/bypass-requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'deny', requestId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          item.classList.remove('expired');
          item.classList.add('rejected');
          const statusEl = item.querySelector('.request-status');
          if (statusEl) {
            statusEl.textContent = 'Rejected';
            statusEl.className = 'request-status rejected';
          }
          item.querySelectorAll('button').forEach(b => b.style.display = 'none');
          
          const timeEl = item.querySelector('.request-time');
          if (timeEl) timeEl.textContent = '‚úï Request denied';
        } else {
          btn.disabled = false;
          btn.textContent = '‚úï Reject';
          alert('Failed to reject: ' + result.error);
        }
      } catch (e) {
        btn.disabled = false;
        btn.textContent = '‚úï Reject';
        alert('Error rejecting request');
      }
    });
  });
  
  // Initial update and set interval
  updateRequestTimes();
  setInterval(updateRequestTimes, 1000); // Update every second
</script>

<script>
  // System Monitor - Real-time health checks
  let monitorInterval = null;
  let streamDurationInterval = null;
  let currentStreamStartTime = null;

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
  };

  const formatDuration = (seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  async function fetchHealthData() {
    try {
      const response = await fetch('/api/admin/health-check');
      const data = await response.json();

      if (!data.success) return;

      // Update timestamp
      const lastUpdate = document.getElementById('monitorLastUpdate');
      if (lastUpdate) {
        const time = new Date(data.timestamp).toLocaleTimeString('en-GB');
        lastUpdate.textContent = `Updated: ${time}`;
      }

      // Update service health
      let servicesOk = 0;
      data.services.forEach(service => {
        const item = document.querySelector(`[data-service="${service.name}"]`);
        if (item) {
          const dot = item.querySelector('.health-dot');
          const latency = item.querySelector('.health-latency');

          dot.className = `health-dot ${service.status}`;

          if (service.latency) {
            latency.textContent = `${service.latency}ms`;
          } else if (service.message) {
            latency.textContent = service.message;
          } else {
            latency.textContent = '-';
          }

          if (service.status === 'ok') servicesOk++;
        }
      });

      // Update stats
      document.getElementById('statServicesOk').textContent = `${servicesOk}/${data.services.length}`;

      if (data.stats) {
        document.getElementById('statOrdersToday').textContent = data.stats.ordersToday || 0;
        document.getElementById('statRevenueToday').textContent = formatCurrency(data.stats.revenueToday || 0);
      }

      // Update livestream info
      const streamPreview = document.getElementById('streamPreview');
      const streamInfo = document.getElementById('streamInfo');
      const streamStatus = document.getElementById('statStreamStatus');

      if (data.livestream && data.livestream.isLive) {
        // Show live stream preview
        streamPreview.innerHTML = `
          <div class="preview-live">
            <div class="live-indicator">
              <span class="live-dot"></span>
              <span>LIVE</span>
            </div>
            <video id="streamVideo" class="stream-video" muted autoplay playsinline>
              <source src="${data.livestream.hlsUrl}" type="application/x-mpegURL">
            </video>
          </div>
        `;

        // Initialize HLS player
        initHLSPlayer(data.livestream.hlsUrl);

        // Show stream info
        streamInfo.classList.remove('hidden');
        document.getElementById('streamDJ').textContent = data.livestream.djName || 'Unknown';
        document.getElementById('streamTitle').textContent = data.livestream.title || 'Live Session';
        document.getElementById('streamViewers').textContent = data.livestream.viewers || 0;

        // Track duration
        currentStreamStartTime = data.livestream.duration || 0;
        updateStreamDuration();

        streamStatus.textContent = 'LIVE';
        streamStatus.style.color = '#ef4444';
      } else {
        // Show offline state
        streamPreview.innerHTML = `
          <div class="preview-placeholder">
            <span class="preview-icon">üì∫</span>
            <span class="preview-text">No active stream</span>
          </div>
        `;
        streamInfo.classList.add('hidden');
        streamStatus.textContent = 'Offline';
        streamStatus.style.color = '#6b7280';
        currentStreamStartTime = null;
      }

    } catch (error) {
      console.error('Health check failed:', error);
      document.getElementById('monitorLastUpdate').textContent = 'Error fetching data';
    }
  }

  function initHLSPlayer(hlsUrl) {
    const video = document.getElementById('streamVideo');
    if (!video) return;

    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Native HLS support (Safari)
      video.src = hlsUrl;
    } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
      // HLS.js for other browsers
      const hls = new Hls({ enableWorker: false });
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
    }
  }

  function updateStreamDuration() {
    if (currentStreamStartTime === null) return;

    const durationEl = document.getElementById('streamDuration');
    if (durationEl) {
      durationEl.textContent = formatDuration(currentStreamStartTime);
      currentStreamStartTime++;
    }
  }

  // Initialize monitor
  document.addEventListener('DOMContentLoaded', () => {
    // Initial fetch
    fetchHealthData();

    // Refresh every 30 seconds
    monitorInterval = setInterval(fetchHealthData, 30000);

    // Update duration every second
    streamDurationInterval = setInterval(updateStreamDuration, 1000);

    // Manual refresh button
    document.getElementById('refreshMonitor')?.addEventListener('click', () => {
      document.getElementById('monitorLastUpdate').textContent = 'Checking...';
      fetchHealthData();
    });
  });

  // Load HLS.js for non-Safari browsers
  if (!document.querySelector('script[src*="hls.js"]')) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
    document.head.appendChild(script);
  }
</script>
