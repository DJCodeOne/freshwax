---
// src/pages/admin/index.astro
// Fresh Wax Admin Dashboard - Unified Design
// Central hub for all admin operations - Uses Firebase REST API

import AdminLayout from '../../layouts/AdminLayout.astro';
import { queryCollection } from '../../lib/firebase-rest';
import '../../styles/admin/index.css';

// Get admin key from Cloudflare runtime env (production) or import.meta.env (dev)
const runtimeEnv = (Astro.locals as any)?.runtime?.env;
const adminKey = runtimeEnv?.ADMIN_KEY || import.meta.env.ADMIN_KEY || '';

// Fetch all data using REST API with error handling
let ordersData: any[] = [];
let releasesData: any[] = [];
let artistsData: any[] = [];
let merchData: any[] = [];
let mixesData: any[] = [];
let livestreamsData: any[] = [];
let bypassRequestsData: any[] = [];
let payoutsData: any[] = [];
let pendingPayoutsData: any[] = [];
let disputesData: any[] = [];
let refundsData: any[] = [];

try {
  const results = await Promise.allSettled([
    queryCollection('orders', { limit: 50 }),
    queryCollection('releases', { limit: 500 }),
    queryCollection('artists', { limit: 500 }),
    queryCollection('merch', { limit: 500 }),
    queryCollection('dj-mixes', { limit: 500 }),
    queryCollection('livestreams', { limit: 10 }),
    queryCollection('bypassRequests', { limit: 20 }),
    queryCollection('payouts', { limit: 200 }),
    queryCollection('pendingPayouts', { limit: 100 }),
    queryCollection('disputes', { limit: 50 }),
    queryCollection('refunds', { limit: 50 })
  ]);

  ordersData = results[0].status === 'fulfilled' ? results[0].value : [];
  releasesData = results[1].status === 'fulfilled' ? results[1].value : [];
  artistsData = results[2].status === 'fulfilled' ? results[2].value : [];
  merchData = results[3].status === 'fulfilled' ? results[3].value : [];
  mixesData = results[4].status === 'fulfilled' ? results[4].value : [];
  livestreamsData = results[5].status === 'fulfilled' ? results[5].value : [];
  bypassRequestsData = results[6].status === 'fulfilled' ? results[6].value.filter((r: any) => r.status === 'pending') : [];
  payoutsData = results[7].status === 'fulfilled' ? results[7].value : [];
  pendingPayoutsData = results[8].status === 'fulfilled' ? results[8].value : [];
  disputesData = results[9].status === 'fulfilled' ? results[9].value : [];
  refundsData = results[10].status === 'fulfilled' ? results[10].value : [];
} catch (error) {
  console.error('[Admin Dashboard] Error fetching data:', error);
}

// Process orders - sort by createdAt desc
const orders = ordersData
  .map(order => ({
    ...order,
    createdAt: order.createdAt ? new Date(order.createdAt) : new Date()
  }))
  .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

// Calculate stats
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

const todayOrders = orders.filter(o => o.createdAt >= startOfToday);
const monthOrders = orders.filter(o => o.createdAt >= startOfMonth);
const pendingOrders = orders.filter(o => o.status === 'pending');

const todayRevenue = todayOrders.reduce((sum, o) => sum + (o.totals?.total || o.total || 0), 0);
const monthRevenue = monthOrders.reduce((sum, o) => sum + (o.totals?.total || o.total || 0), 0);

// Filter out test orders and free downloads for financial calculations (from sorted orders)
const realOrders = orders.filter(o =>
  o.paymentMethod !== 'test_mode' &&
  o.paymentMethod !== 'free_download' &&
  (o.totals?.total > 0 || o.total > 0) &&
  (o.paymentStatus === 'completed' || o.orderStatus === 'completed' || o.status === 'completed')
);

// Partner stats (data already in array format from REST API)
const artists = artistsData;
const pendingPartners = artists.filter(a => a.approved === false);
const approvedPartners = artists.filter(a => a.approved === true);

// Release stats
const releases = releasesData;
const liveReleases = releases.filter(r => r.status === 'live');
const pendingReleases = releases.filter(r => r.status === 'pending');

// Merch stats
const merch = merchData;
const lowStockMerch = merch.filter(m => {
  if (m.variants) {
    return m.variants.some(v => (v.stock || 0) <= 5 && (v.stock || 0) > 0);
  }
  return (m.stock || 0) <= 5 && (m.stock || 0) > 0;
});
const outOfStockMerch = merch.filter(m => {
  if (m.variants) {
    return m.variants.every(v => (v.stock || 0) === 0);
  }
  return (m.stock || 0) === 0;
});

// DJ Mixes stats
const mixes = mixesData;
const publishedMixes = mixes.filter(m => m.published);
const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);

// Livestream stats - sort by startedAt desc
const livestreams = livestreamsData
  .map(ls => ({
    ...ls,
    startedAt: ls.startedAt ? new Date(ls.startedAt) : null,
    endedAt: ls.endedAt ? new Date(ls.endedAt) : null
  }))
  .sort((a, b) => (b.startedAt?.getTime() || 0) - (a.startedAt?.getTime() || 0));
const activeLivestream = livestreams.find(ls => ls.status === 'live');
const recentLivestreams = livestreams.slice(0, 5);

// Bypass requests - filter out expired ones (15 minutes)
const fifteenMinsAgo = new Date(Date.now() - 15 * 60 * 1000);
const bypassRequests = bypassRequestsData
  .filter(req => {
    // Filter out requests older than 15 minutes
    if (!req.createdAt) return true;
    const createdDate = new Date(req.createdAt);
    return createdDate > fifteenMinsAgo;
  });

// Recent orders (last 5 real orders - excludes test mode and free downloads)
const recentOrders = realOrders.slice(0, 5);

// Platform earnings calculations
const PLATFORM_FEE_RATE = 0.01; // 1% platform fee

// Calculate total payouts to artists
const totalArtistPayouts = payoutsData
  .filter(p => p.status === 'completed')
  .reduce((sum, p) => sum + (p.amount || 0), 0);

// Calculate pending payouts (awaiting artist onboarding)
const totalPendingPayouts = pendingPayoutsData
  .filter(p => p.status !== 'completed' && p.status !== 'cancelled')
  .reduce((sum, p) => sum + (p.amount || 0), 0);

// Calculate refunds issued
const totalRefunded = refundsData.reduce((sum, r) => sum + (r.amount || 0), 0);

// Calculate disputes impact
const openDisputes = disputesData.filter(d => d.status === 'warning_under_review' || d.status === 'warning_needs_response' || d.status === 'needs_response' || d.status === 'under_review');
const disputesUnderReview = openDisputes.reduce((sum, d) => sum + (d.amount || 0), 0);
const disputesLost = disputesData.filter(d => d.status === 'lost').reduce((sum, d) => sum + (d.amount || 0), 0);
const disputesWon = disputesData.filter(d => d.status === 'won').reduce((sum, d) => sum + (d.amount || 0), 0);

// Calculate gross revenue (only real orders, not test mode)
const grossRevenue = realOrders.reduce((sum, o) => sum + (o.totals?.total || o.total || 0), 0);

// Platform fees earned (actual fees from orders, not calculated %)
const platformFeesEarned = realOrders.reduce((sum, o) => sum + (o.totals?.freshWaxFee || 0), 0);

// Net to artists (what artists actually receive after all fees)
// If artistEarnings is stored, use it. Otherwise calculate: subtotal - freshWaxFee - processingFee
const netToArtists = realOrders.reduce((sum, o) => {
  if (o.totals?.artistEarnings) return sum + o.totals.artistEarnings;
  // Calculate if not stored
  const subtotal = o.totals?.subtotal || 0;
  const freshWaxFee = o.totals?.freshWaxFee || (subtotal * 0.01);
  const processingFee = o.totals?.paymentProcessingFee || o.totals?.stripeFee || ((subtotal * 0.014) + 0.20);
  return sum + (subtotal - freshWaxFee - processingFee);
}, 0);

// Month-over-month calculations
const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);

const lastMonthPayouts = payoutsData
  .filter(p => {
    if (!p.completedAt) return false;
    const d = new Date(p.completedAt);
    return d >= lastMonth && d <= endOfLastMonth;
  })
  .reduce((sum, p) => sum + (p.amount || 0), 0);

const thisMonthPayouts = payoutsData
  .filter(p => {
    if (!p.completedAt) return false;
    const d = new Date(p.completedAt);
    return d >= startOfMonth;
  })
  .reduce((sum, p) => sum + (p.amount || 0), 0);

// Format helpers
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

const formatDate = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'short',
    hour: '2-digit',
    minute: '2-digit'
  });
};

const formatNumber = (num) => {
  return new Intl.NumberFormat('en-GB').format(num);
};

// Alerts
const alerts = [];
if (pendingPartners.length > 0) {
  alerts.push({ type: 'warning', icon: 'üë•', text: `${pendingPartners.length} partner${pendingPartners.length !== 1 ? 's' : ''} awaiting approval`, link: '/admin/artists/pending' });
}
if (pendingOrders.length > 0) {
  alerts.push({ type: 'info', icon: 'üì¶', text: `${pendingOrders.length} order${pendingOrders.length !== 1 ? 's' : ''} need processing`, link: '/admin/orders' });
}
if (lowStockMerch.length > 0) {
  alerts.push({ type: 'warning', icon: '‚ö†Ô∏è', text: `${lowStockMerch.length} product${lowStockMerch.length !== 1 ? 's' : ''} running low on stock`, link: '/admin/inventory' });
}
if (outOfStockMerch.length > 0) {
  alerts.push({ type: 'danger', icon: 'üö´', text: `${outOfStockMerch.length} product${outOfStockMerch.length !== 1 ? 's' : ''} out of stock`, link: '/admin/inventory' });
}
if (openDisputes.length > 0) {
  alerts.push({ type: 'danger', icon: '‚ö†Ô∏è', text: `${openDisputes.length} dispute${openDisputes.length !== 1 ? 's' : ''} need attention`, link: '/admin/payments' });
}
if (totalPendingPayouts > 0) {
  const pendingCount = pendingPayoutsData.filter(p => p.status !== 'completed' && p.status !== 'cancelled').length;
  alerts.push({ type: 'warning', icon: 'üí≥', text: `${formatCurrency(totalPendingPayouts)} in pending payouts (${pendingCount} artists)`, link: '/admin/payments' });
}

export const prerender = false;
---

<AdminLayout title="Dashboard" activeNav="dashboard">
  <Fragment slot="breadcrumb">
    <div class="header-breadcrumb">
      <span>Admin Dashboard</span>
    </div>
  </Fragment>

  <Fragment slot="actions">
    <button class="btn btn-ghost" onclick="window.location.reload()">
      ‚Üª Refresh
    </button>
  </Fragment>

  <!-- Alerts Section -->
  {alerts.length > 0 && (
    <div class="alerts-section mb-4">
      {alerts.map(alert => (
        <a href={alert.link} class={`alert-item alert-${alert.type}`}>
          <span class="alert-icon">{alert.icon}</span>
          <span class="alert-text">{alert.text}</span>
          <span class="alert-arrow">‚Üí</span>
        </a>
      ))}
    </div>
  )}

  <!-- Main Stats Grid -->
  <div class="stats-grid cols-6 mb-4">
    <div class="stat-card highlight">
      <div class="stat-label">Today's Revenue</div>
      <div class="stat-value">{formatCurrency(todayRevenue)}</div>
      <div class="stat-detail">{todayOrders.length} order{todayOrders.length !== 1 ? 's' : ''}</div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">This Month</div>
      <div class="stat-value">{formatCurrency(monthRevenue)}</div>
      <div class="stat-detail">{monthOrders.length} orders</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Pending Orders</div>
      <div class="stat-value">{pendingOrders.length}</div>
      <div class="stat-detail">Need attention</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Live Releases</div>
      <div class="stat-value">{liveReleases.length}</div>
      <div class="stat-detail">{pendingReleases.length} pending</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Partners</div>
      <div class="stat-value">{approvedPartners.length}</div>
      <div class="stat-detail">{pendingPartners.length} pending</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Mix Plays</div>
      <div class="stat-value">{formatNumber(totalPlays)}</div>
      <div class="stat-detail">{publishedMixes.length} mixes</div>
    </div>
  </div>

  <!-- Platform Earnings Section -->
  <div class="card mb-4 earnings-card">
    <div class="card-header">
      <h2>üí∞ Platform Earnings</h2>
      <a href="/admin/payments" class="btn btn-ghost btn-sm">View Payments ‚Üí</a>
    </div>
    <div class="card-body">
      <div class="earnings-grid">
        <div class="earning-stat primary">
          <div class="earning-icon">üìä</div>
          <div class="earning-info">
            <span class="earning-label">Gross Revenue</span>
            <span class="earning-value">{formatCurrency(grossRevenue)}</span>
            <span class="earning-detail">{realOrders.length} real order{realOrders.length !== 1 ? 's' : ''} (excl. test)</span>
          </div>
        </div>

        <div class="earning-stat success">
          <div class="earning-icon">üè¶</div>
          <div class="earning-info">
            <span class="earning-label">Platform Fees (1%)</span>
            <span class="earning-value">{formatCurrency(platformFeesEarned)}</span>
            <span class="earning-detail">Net after refunds</span>
          </div>
        </div>

        <div class="earning-stat info">
          <div class="earning-icon">üé§</div>
          <div class="earning-info">
            <span class="earning-label">Artist Earnings</span>
            <span class="earning-value">{formatCurrency(netToArtists)}</span>
            <span class="earning-detail">{realOrders.length} real order{realOrders.length !== 1 ? 's' : ''}</span>
          </div>
        </div>

        <div class="earning-stat warning">
          <div class="earning-icon">‚è≥</div>
          <div class="earning-info">
            <span class="earning-label">Pending Payouts</span>
            <span class="earning-value">{formatCurrency(totalPendingPayouts)}</span>
            <span class="earning-detail">{pendingPayoutsData.filter(p => p.status !== 'completed' && p.status !== 'cancelled').length} awaiting setup</span>
          </div>
        </div>

        <div class="earning-stat danger">
          <div class="earning-icon">‚Ü©Ô∏è</div>
          <div class="earning-info">
            <span class="earning-label">Total Refunded</span>
            <span class="earning-value">{formatCurrency(totalRefunded)}</span>
            <span class="earning-detail">{refundsData.length} refunds issued</span>
          </div>
        </div>

        <div class="earning-stat {openDisputes.length > 0 ? 'danger' : 'muted'}">
          <div class="earning-icon">‚öñÔ∏è</div>
          <div class="earning-info">
            <span class="earning-label">Disputes</span>
            <span class="earning-value">{formatCurrency(disputesUnderReview)}</span>
            <span class="earning-detail">
              {openDisputes.length} open ‚Ä¢ Won: {formatCurrency(disputesWon)} ‚Ä¢ Lost: {formatCurrency(disputesLost)}
            </span>
          </div>
        </div>
      </div>

      <!-- Month Comparison -->
      <div class="month-comparison">
        <div class="month-stat">
          <span class="month-label">This Month Payouts</span>
          <span class="month-value">{formatCurrency(thisMonthPayouts)}</span>
        </div>
        <div class="month-stat">
          <span class="month-label">Last Month Payouts</span>
          <span class="month-value">{formatCurrency(lastMonthPayouts)}</span>
        </div>
        <div class="month-stat">
          <span class="month-label">This Month Revenue</span>
          <span class="month-value">{formatCurrency(monthRevenue)}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="actions-grid mb-4">
    <a href="/admin/merch/upload" class="action-card primary">
      <span class="card-icon">üëï</span>
      <span class="card-title">Add Merch</span>
    </a>
    <a href="/admin/streaming" class="action-card" style="position: relative;">
      <span class="card-icon">üî¥</span>
      <span class="card-title">Live Stream</span>
      {activeLivestream && (
        <span class="card-badge live-pulse">LIVE</span>
      )}
    </a>
    <a href="/admin/orders" class="action-card" style="position: relative;">
      <span class="card-icon">üìã</span>
      <span class="card-title">Orders</span>
      {pendingOrders.length > 0 && (
        <span class="card-badge">{pendingOrders.length}</span>
      )}
    </a>
    <a href="/admin/artists/pending" class="action-card" style="position: relative;">
      <span class="card-icon">‚úÖ</span>
      <span class="card-title">Approvals</span>
      {pendingPartners.length > 0 && (
        <span class="card-badge">{pendingPartners.length}</span>
      )}
    </a>
    <a href="/admin/analytics" class="action-card">
      <span class="card-icon">üìà</span>
      <span class="card-title">Analytics</span>
    </a>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-2 gap-2">
    <!-- Recent Orders -->
    <div class="card">
      <div class="card-header">
        <h2>üìã Recent Orders</h2>
        <a href="/admin/orders" class="btn btn-ghost btn-sm">View All ‚Üí</a>
      </div>
      {recentOrders.length === 0 ? (
        <div class="card-body">
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-title">No orders yet</div>
            <p class="empty-state-text">Orders will appear here as they come in.</p>
          </div>
        </div>
      ) : (
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {recentOrders.map(order => (
                <tr>
                  <td class="cell-mono">#{order.id?.slice(-6).toUpperCase()}</td>
                  <td class="font-bold">{formatCurrency(order.totals?.total || order.total)}</td>
                  <td><span class={`badge badge-${order.status}`}>{order.status}</span></td>
                  <td class="cell-secondary">{formatDate(order.createdAt)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>

    <!-- Quick Links & Status -->
    <div class="card">
      <div class="card-header">
        <h2>‚ö° Quick Access</h2>
      </div>
      <div class="card-body">
        <div class="quick-links">
          <a href="/admin/releases/manage" class="quick-link">
            <span class="quick-icon">üíø</span>
            <span class="quick-text">Manage Releases</span>
            <span class="quick-count">{releases.length}</span>
          </a>
          <a href="/admin/artists/manage" class="quick-link">
            <span class="quick-icon">üé§</span>
            <span class="quick-text">Manage Partners</span>
            <span class="quick-count">{approvedPartners.length}</span>
          </a>
          <a href="/admin/inventory" class="quick-link">
            <span class="quick-icon">üëï</span>
            <span class="quick-text">Stock & Inventory</span>
            <span class="quick-count">{merch.length}</span>
          </a>
          <a href="/admin/dj-mixes/manage" class="quick-link">
            <span class="quick-icon">üéß</span>
            <span class="quick-text">Manage DJ Mixes</span>
            <span class="quick-count">{mixes.length}</span>
          </a>
          <a href="/admin/streaming" class="quick-link">
            <span class="quick-icon">üî¥</span>
            <span class="quick-text">Manage Live Stream</span>
            <span class="quick-count">{activeLivestream ? 'LIVE' : 'Off'}</span>
          </a>
          <a href="/admin/users" class="quick-link">
            <span class="quick-icon">üë•</span>
            <span class="quick-text">User Management</span>
            <span class="quick-count">-</span>
          </a>
          <a href="/admin/merch/suppliers" class="quick-link">
            <span class="quick-icon">üè≠</span>
            <span class="quick-text">Merch Suppliers</span>
            <span class="quick-count">-</span>
          </a>
          <a href="/admin/vinyl" class="quick-link">
            <span class="quick-icon">üìÄ</span>
            <span class="quick-text">Vinyl Sellers</span>
            <span class="quick-count">-</span>
          </a>
          <a href="/admin/plus-accounts" class="quick-link plus-link">
            <span class="quick-icon">üëë</span>
            <span class="quick-text">Plus Accounts</span>
            <span class="quick-count">-</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Stream Management -->
  <div class="card mt-4 livestream-card">
    <div class="card-header">
      <h2>üî¥ Live Stream Control</h2>
      <a href="/admin/streaming" class="btn btn-primary btn-sm">Manage Live ‚Üí</a>
    </div>
    <div class="card-body">
      <div class="livestream-status-grid">
        <!-- Current Status -->
        <div class="livestream-status-panel">
          <div class="status-indicator {activeLivestream ? 'live' : 'offline'}">
            <span class="status-dot-large"></span>
            <span class="status-text">{activeLivestream ? 'ON AIR' : 'OFFLINE'}</span>
          </div>
          {activeLivestream ? (
            <div class="live-info">
              <div class="live-detail">
                <span class="detail-label">DJ</span>
                <span class="detail-value">{activeLivestream.djName || 'Unknown'}</span>
              </div>
              <div class="live-detail">
                <span class="detail-label">Title</span>
                <span class="detail-value">{activeLivestream.title || 'Live Session'}</span>
              </div>
              <div class="live-detail">
                <span class="detail-label">Started</span>
                <span class="detail-value">{activeLivestream.startedAt ? formatDate(activeLivestream.startedAt) : '-'}</span>
              </div>
              <div class="live-detail">
                <span class="detail-label">Viewers</span>
                <span class="detail-value" id="viewerCount">{activeLivestream.viewerCount || 0}</span>
              </div>
            </div>
          ) : (
            <div class="offline-message">
              <p>No active stream. DJs can go live from the DJ Lobby.</p>
              <a href="/live" class="btn btn-ghost btn-sm">View Live Page ‚Üí</a>
            </div>
          )}
        </div>

        <!-- Quick Actions -->
        <div class="livestream-actions">
          <a href="/admin/streaming" class="livestream-action-btn">
            <span class="action-icon">‚öôÔ∏è</span>
            <span class="action-label">Stream Settings</span>
          </a>
          <a href="/admin/streaming/schedule" class="livestream-action-btn">
            <span class="action-icon">üìÖ</span>
            <span class="action-label">Schedule</span>
          </a>
          <a href="/live" class="livestream-action-btn" target="_blank">
            <span class="action-icon">üì∫</span>
            <span class="action-label">Watch Live</span>
          </a>
          <a href="/admin/streaming/history" class="livestream-action-btn">
            <span class="action-icon">üìú</span>
            <span class="action-label">History</span>
          </a>
        </div>
      </div>

      {recentLivestreams.length > 0 && (
        <div class="recent-streams">
          <h4>Recent Streams</h4>
          <div class="streams-list">
            {recentLivestreams.slice(0, 3).map(stream => (
              <div class="stream-item">
                <span class="stream-dj">{stream.djName || 'Unknown DJ'}</span>
                <span class="stream-title">{stream.title || 'Live Session'}</span>
                <span class="stream-date">{stream.startedAt ? formatDate(stream.startedAt) : '-'}</span>
                <span class={`stream-status status-${stream.status}`}>{stream.status}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Bypass Requests Section -->
      <div class="bypass-requests-section" id="bypassRequestsSection">
        <h4>üé´ Go Live Bypass Requests</h4>
        <div id="bypassRequestsList" class="bypass-requests-list">
          {bypassRequests.length === 0 ? (
            <div class="no-requests">
              <span class="no-requests-icon">‚úì</span>
              <span>No pending requests</span>
            </div>
          ) : (
            bypassRequests.map(req => (
              <div class="bypass-request-item" data-request-id={req.id} data-created-at={req.createdAt}>
                <div class="request-info">
                  <span class="request-user">{req.userName || req.userEmail || 'Unknown User'}</span>
                  <span class="request-email">{req.userEmail || ''}</span>
                  {req.reason && <span class="request-reason">"{req.reason}"</span>}
                </div>
                <div class="request-meta">
                  <span class="request-time" data-time={req.createdAt}></span>
                  <span class="request-status pending">Pending</span>
                </div>
                <div class="request-actions">
                  <button class="btn-approve" data-id={req.id} data-user={req.userId}>
                    ‚úì Approve
                  </button>
                  <button class="btn-reject" data-id={req.id}>
                    ‚úï Reject
                  </button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- System Monitor -->
  <div class="card mt-4 monitor-card">
    <div class="card-header">
      <h2>üìä System Monitor</h2>
      <div class="monitor-header-actions">
        <span id="monitorLastUpdate" class="monitor-timestamp">Checking...</span>
        <button id="refreshMonitor" class="btn btn-ghost btn-sm">‚Üª Refresh</button>
      </div>
    </div>
    <div class="card-body">
      <div class="monitor-grid">
        <!-- Live Stream Preview -->
        <div class="monitor-section monitor-preview">
          <h3 class="monitor-section-title">Live Stream</h3>
          <div id="streamPreview" class="stream-preview">
            <div class="preview-placeholder">
              <span class="preview-icon">üì∫</span>
              <span class="preview-text">No active stream</span>
            </div>
          </div>
          <div id="streamInfo" class="stream-info hidden">
            <div class="stream-info-row">
              <span class="info-label">DJ:</span>
              <span id="streamDJ" class="info-value">-</span>
            </div>
            <div class="stream-info-row">
              <span class="info-label">Title:</span>
              <span id="streamTitle" class="info-value">-</span>
            </div>
            <div class="stream-info-row">
              <span class="info-label">Viewers:</span>
              <span id="streamViewers" class="info-value">0</span>
            </div>
            <div class="stream-info-row">
              <span class="info-label">Duration:</span>
              <span id="streamDuration" class="info-value">00:00:00</span>
            </div>
          </div>
        </div>

        <!-- Service Health -->
        <div class="monitor-section monitor-health">
          <h3 class="monitor-section-title">Service Health</h3>
          <div id="serviceHealth" class="health-grid">
            <div class="health-item" data-service="Firebase">
              <span class="health-dot checking"></span>
              <span class="health-name">Firebase</span>
              <span class="health-latency">-</span>
            </div>
            <div class="health-item" data-service="R2 Storage">
              <span class="health-dot checking"></span>
              <span class="health-name">R2 Storage</span>
              <span class="health-latency">-</span>
            </div>
            <div class="health-item" data-service="Stripe">
              <span class="health-dot checking"></span>
              <span class="health-name">Stripe</span>
              <span class="health-latency">-</span>
            </div>
            <div class="health-item" data-service="Stream Server">
              <span class="health-dot checking"></span>
              <span class="health-name">Stream Server</span>
              <span class="health-latency">-</span>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="monitor-section monitor-stats">
          <h3 class="monitor-section-title">Today's Activity</h3>
          <div class="quick-stats-grid">
            <div class="quick-stat">
              <span class="quick-stat-value" id="statOrdersToday">-</span>
              <span class="quick-stat-label">Orders</span>
            </div>
            <div class="quick-stat">
              <span class="quick-stat-value" id="statRevenueToday">-</span>
              <span class="quick-stat-label">Revenue</span>
            </div>
            <div class="quick-stat">
              <span class="quick-stat-value" id="statServicesOk">-</span>
              <span class="quick-stat-label">Services OK</span>
            </div>
            <div class="quick-stat">
              <span class="quick-stat-value" id="statStreamStatus">-</span>
              <span class="quick-stat-label">Stream</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Server Control Panel -->
  <div class="card mt-4 server-control-card">
    <div class="card-header">
      <h2>üñ•Ô∏è Server Control</h2>
      <span id="serverStatus" class="server-status checking">Checking...</span>
    </div>
    <div class="card-body">
      <div class="server-controls-grid">
        <!-- Stream Server Controls -->
        <div class="control-section">
          <h4>Stream Server (MediaMTX)</h4>
          <div class="control-buttons">
            <button id="serverStartBtn" class="control-btn start" title="Start MediaMTX server">
              <span class="btn-icon">‚ñ∂</span>
              <span class="btn-label">Start</span>
            </button>
            <button id="serverStopBtn" class="control-btn stop" title="Stop MediaMTX server">
              <span class="btn-icon">‚ñ†</span>
              <span class="btn-label">Stop</span>
            </button>
            <button id="serverRestartBtn" class="control-btn restart" title="Restart MediaMTX server">
              <span class="btn-icon">‚Üª</span>
              <span class="btn-label">Restart</span>
            </button>
          </div>
        </div>

        <!-- Stream Management -->
        <div class="control-section">
          <h4>Stream Management</h4>
          <div class="control-buttons">
            <button id="forceEndStreamBtn" class="control-btn danger" title="Force end all active streams">
              <span class="btn-icon">‚èπ</span>
              <span class="btn-label">End All Streams</span>
            </button>
            <button id="clearChatBtn" class="control-btn warning" title="Clear all chat messages">
              <span class="btn-icon">üóë</span>
              <span class="btn-label">Clear Chat</span>
            </button>
            <button id="kickAllViewersBtn" class="control-btn warning" title="Disconnect all viewers">
              <span class="btn-icon">üë•</span>
              <span class="btn-label">Kick Viewers</span>
            </button>
          </div>
        </div>

        <!-- Maintenance Actions -->
        <div class="control-section">
          <h4>Maintenance</h4>
          <div class="control-buttons">
            <button id="clearCacheBtn" class="control-btn" title="Clear CDN and R2 cache">
              <span class="btn-icon">üßπ</span>
              <span class="btn-label">Clear Cache</span>
            </button>
            <button id="syncDataBtn" class="control-btn" title="Sync data between services">
              <span class="btn-icon">üîÑ</span>
              <span class="btn-label">Sync Data</span>
            </button>
            <button id="cleanupDbBtn" class="control-btn" title="Clean expired sessions and stale data">
              <span class="btn-icon">üóÉ</span>
              <span class="btn-label">DB Cleanup</span>
            </button>
          </div>
        </div>

        <!-- Quick Diagnostics -->
        <div class="control-section">
          <h4>Diagnostics</h4>
          <div class="control-buttons">
            <button id="testStreamBtn" class="control-btn" title="Send test stream signal">
              <span class="btn-icon">üì°</span>
              <span class="btn-label">Test Stream</span>
            </button>
            <button id="viewLogsBtn" class="control-btn" title="View server logs">
              <span class="btn-icon">üìú</span>
              <span class="btn-label">View Logs</span>
            </button>
            <button id="checkHealthBtn" class="control-btn" title="Run full health check">
              <span class="btn-icon">üíì</span>
              <span class="btn-label">Health Check</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Server Logs Panel -->
      <div id="serverLogsPanel" class="server-logs-panel hidden">
        <div class="logs-header">
          <h4>Server Logs</h4>
          <button id="closeLogsBtn" class="btn btn-ghost btn-sm">‚úï Close</button>
        </div>
        <pre id="serverLogsContent" class="logs-content">Loading logs...</pre>
      </div>

      <!-- Action Result -->
      <div id="actionResult" class="action-result hidden">
        <span id="actionResultIcon"></span>
        <span id="actionResultText"></span>
      </div>
    </div>
  </div>

  <!-- Feature Toggles -->
  <div class="card mt-4">
    <div class="card-header">
      <h2>‚öôÔ∏è Feature Settings</h2>
    </div>
    <div class="card-body">
      <div class="toggle-list">
        <div class="toggle-item">
          <div class="toggle-info">
            <span class="toggle-label">DJ Mix Charts</span>
            <span class="toggle-desc">Show floating all-time chart on DJ Mixes page</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleMixCharts" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Playlist History -->
  <div class="card mt-4">
    <div class="card-header">
      <h2>üéµ Playlist History</h2>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">View and download the master playlist history file (stored in browser localStorage)</p>
      <div class="btn-group">
        <button id="viewHistoryBtn" class="btn btn-secondary">View History</button>
        <button id="downloadHistoryBtn" class="btn btn-primary">Download JSON</button>
        <button id="clearHistoryBtn" class="btn btn-danger">Clear History</button>
      </div>
      <div id="historyCount" class="mt-2 text-muted"></div>
      <div id="historyPreview" class="history-preview mt-3 hidden">
        <h4>History Entries (<span id="historyTotal">0</span>)</h4>
        <div id="historyList" class="history-list"></div>
      </div>
    </div>
  </div>

</AdminLayout>

<style>
  /* Platform Earnings Styles */
  .earnings-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .earnings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .earning-stat {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
    border: 1px solid #374151;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .earning-stat:hover {
    border-color: #4b5563;
    transform: translateY(-2px);
  }

  .earning-stat.primary { border-left: 3px solid #3b82f6; }
  .earning-stat.success { border-left: 3px solid #22c55e; }
  .earning-stat.info { border-left: 3px solid #06b6d4; }
  .earning-stat.warning { border-left: 3px solid #f59e0b; }
  .earning-stat.danger { border-left: 3px solid #ef4444; }
  .earning-stat.muted { border-left: 3px solid #6b7280; }

  .earning-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .earning-info {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .earning-label {
    font-size: 0.75rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .earning-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #f3f4f6;
  }

  .earning-detail {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .month-comparison {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #374151;
    flex-wrap: wrap;
  }

  .month-stat {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .month-label {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .month-value {
    font-size: 1rem;
    font-weight: 600;
    color: #e5e7eb;
  }

  /* Server Control Panel Styles */
  .server-control-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .server-status {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .server-status.checking { background: #374151; color: #9ca3af; }
  .server-status.online { background: #065f46; color: #34d399; }
  .server-status.offline { background: #7f1d1d; color: #fca5a5; }
  .server-status.error { background: #78350f; color: #fcd34d; }

  .server-controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .control-section h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .control-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .control-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid #374151;
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
    border-radius: 6px;
    color: #e5e7eb;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .control-btn:hover {
    border-color: #4b5563;
    background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
  }

  .control-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .control-btn.start:hover { border-color: #22c55e; color: #22c55e; }
  .control-btn.stop:hover { border-color: #ef4444; color: #ef4444; }
  .control-btn.restart:hover { border-color: #3b82f6; color: #3b82f6; }
  .control-btn.danger { border-color: #dc2626; color: #fca5a5; }
  .control-btn.danger:hover { background: #7f1d1d; border-color: #ef4444; }
  .control-btn.warning { border-color: #d97706; color: #fcd34d; }
  .control-btn.warning:hover { background: #78350f; border-color: #f59e0b; }

  .btn-icon {
    font-size: 1rem;
  }

  .server-logs-panel {
    margin-top: 1.5rem;
    border: 1px solid #374151;
    border-radius: 8px;
    background: #0a0a0a;
  }

  .logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #374151;
  }

  .logs-header h4 {
    margin: 0;
    font-size: 0.875rem;
  }

  .logs-content {
    padding: 1rem;
    margin: 0;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Fira Code', monospace;
    font-size: 0.75rem;
    line-height: 1.5;
    color: #9ca3af;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .action-result {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .action-result.success {
    background: #065f46;
    color: #34d399;
  }

  .action-result.error {
    background: #7f1d1d;
    color: #fca5a5;
  }

  .action-result.info {
    background: #1e3a5f;
    color: #93c5fd;
  }

  .history-preview {
    background: #1a1a2e;
    border-radius: 8px;
    padding: 1rem;
    max-height: 400px;
    overflow-y: auto;
  }
  .history-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .history-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    background: #252540;
    border-radius: 6px;
  }
  .history-item img {
    width: 60px;
    height: 45px;
    object-fit: cover;
    border-radius: 4px;
  }
  .history-item-info {
    flex: 1;
    min-width: 0;
  }
  .history-item-title {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .history-item-meta {
    font-size: 0.75rem;
    color: #888;
  }
  .btn-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
</style>

<script>
  // Feature toggle handling
  document.addEventListener('DOMContentLoaded', async function() {
    const toggleMixCharts = document.getElementById('toggleMixCharts');

    // Load current settings
    try {
      const response = await fetch('/api/admin/get-settings');
      const data = await response.json();
      if (data.success && data.settings) {
        toggleMixCharts.checked = data.settings.showMixCharts || false;
      }
    } catch (error) {
      console.error('Failed to load settings:', error);
    }

    // Save toggle changes
    toggleMixCharts?.addEventListener('change', async function() {
      try {
        await fetch('/api/admin/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ showMixCharts: this.checked })
        });
      } catch (error) {
        console.error('Failed to save setting:', error);
      }
    });

    // Playlist History handling
    const HISTORY_KEY = 'freshwax_playlist_history';
    const viewHistoryBtn = document.getElementById('viewHistoryBtn');
    const downloadHistoryBtn = document.getElementById('downloadHistoryBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const historyPreview = document.getElementById('historyPreview');
    const historyList = document.getElementById('historyList');
    const historyTotal = document.getElementById('historyTotal');
    const historyCount = document.getElementById('historyCount');

    function getHistory() {
      try {
        const data = localStorage.getItem(HISTORY_KEY);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        return [];
      }
    }

    function updateHistoryCount() {
      const history = getHistory();
      historyCount.textContent = `${history.length} tracks in history`;
    }

    updateHistoryCount();

    viewHistoryBtn?.addEventListener('click', () => {
      const history = getHistory();
      historyTotal.textContent = history.length.toString();

      if (history.length === 0) {
        historyList.innerHTML = '<p class="text-muted">No history entries yet</p>';
      } else {
        historyList.innerHTML = history.map((item, i) => `
          <div class="history-item">
            <img src="${item.thumbnail || '/place-holder.webp'}" alt="" />
            <div class="history-item-info">
              <div class="history-item-title">${item.title || item.url}</div>
              <div class="history-item-meta">
                ${item.platform} ‚Ä¢ ${item.playedAt ? new Date(item.playedAt).toLocaleString() : 'Unknown date'}
              </div>
            </div>
          </div>
        `).join('');
      }

      historyPreview.classList.toggle('hidden');
    });

    downloadHistoryBtn?.addEventListener('click', () => {
      const history = getHistory();
      const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `playlist-history-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    clearHistoryBtn?.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear the playlist history? This cannot be undone.')) {
        localStorage.removeItem(HISTORY_KEY);
        updateHistoryCount();
        historyList.innerHTML = '<p class="text-muted">No history entries yet</p>';
        historyTotal.textContent = '0';
        alert('History cleared');
      }
    });
  });
</script>


<script>
  // Bypass Request Management
  const EXPIRY_TIME = 15 * 60 * 1000; // 15 minutes
  
  // Update time displays and check for expired requests
  function updateRequestTimes() {
    document.querySelectorAll('.bypass-request-item').forEach(item => {
      const createdAt = item.dataset.createdAt;
      if (!createdAt) return;
      
      const createdDate = new Date(createdAt);
      const now = Date.now();
      const elapsed = now - createdDate.getTime();
      const remaining = EXPIRY_TIME - elapsed;
      
      const timeEl = item.querySelector('.request-time');
      const statusEl = item.querySelector('.request-status');
      
      if (remaining <= 0) {
        // Request expired
        item.classList.add('expired');
        if (statusEl) {
          statusEl.textContent = 'Expired';
          statusEl.className = 'request-status expired';
        }
        if (timeEl) timeEl.textContent = 'Expired';
        
        // Disable buttons
        item.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        // Auto-expire on server
        autoExpireRequest(item.dataset.requestId);
      } else {
        // Show countdown
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        if (timeEl) timeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')} left`;
      }
    });
  }
  
  // Auto-expire request on server
  async function autoExpireRequest(requestId) {
    try {
      await fetch('/api/admin/bypass-requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'expire', requestId })
      });
    } catch (e) {
      console.error('Failed to expire request:', e);
    }
  }
  
  // Handle approve button click
  document.querySelectorAll('.btn-approve').forEach(btn => {
    btn.addEventListener('click', async () => {
      const requestId = btn.dataset.id;
      const userId = btn.dataset.user;
      const item = btn.closest('.bypass-request-item');
      
      btn.disabled = true;
      btn.textContent = 'Approving...';
      
      try {
        const response = await fetch('/api/admin/bypass-requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'approve', requestId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          item.classList.remove('expired');
          item.classList.add('approved');
          const statusEl = item.querySelector('.request-status');
          if (statusEl) {
            statusEl.textContent = 'Approved';
            statusEl.className = 'request-status approved';
          }
          item.querySelectorAll('button').forEach(b => b.style.display = 'none');
          
          // Show success message
          const timeEl = item.querySelector('.request-time');
          if (timeEl) timeEl.textContent = '‚úì User can now go live';
        } else {
          btn.disabled = false;
          btn.textContent = '‚úì Approve';
          alert('Failed to approve: ' + result.error);
        }
      } catch (e) {
        btn.disabled = false;
        btn.textContent = '‚úì Approve';
        alert('Error approving request');
      }
    });
  });
  
  // Handle reject button click
  document.querySelectorAll('.btn-reject').forEach(btn => {
    btn.addEventListener('click', async () => {
      const requestId = btn.dataset.id;
      const item = btn.closest('.bypass-request-item');
      
      if (!confirm('Reject this bypass request?')) return;
      
      btn.disabled = true;
      btn.textContent = 'Rejecting...';
      
      try {
        const response = await fetch('/api/admin/bypass-requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'deny', requestId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          item.classList.remove('expired');
          item.classList.add('rejected');
          const statusEl = item.querySelector('.request-status');
          if (statusEl) {
            statusEl.textContent = 'Rejected';
            statusEl.className = 'request-status rejected';
          }
          item.querySelectorAll('button').forEach(b => b.style.display = 'none');
          
          const timeEl = item.querySelector('.request-time');
          if (timeEl) timeEl.textContent = '‚úï Request denied';
        } else {
          btn.disabled = false;
          btn.textContent = '‚úï Reject';
          alert('Failed to reject: ' + result.error);
        }
      } catch (e) {
        btn.disabled = false;
        btn.textContent = '‚úï Reject';
        alert('Error rejecting request');
      }
    });
  });
  
  // Initial update and set interval
  updateRequestTimes();
  setInterval(updateRequestTimes, 1000); // Update every second
</script>

<script define:vars={{ adminKey }}>
  // System Monitor - Real-time health checks
  const ADMIN_KEY = adminKey;
  let monitorInterval = null;
  let streamDurationInterval = null;
  let currentStreamStartTime = null;

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
  };

  const formatDuration = (seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  async function fetchHealthData() {
    try {
      const response = await fetch('/api/admin/health-check', {
        headers: { 'X-Admin-Key': ADMIN_KEY }
      });
      const data = await response.json();

      if (!data.success) return;

      // Update timestamp
      const lastUpdate = document.getElementById('monitorLastUpdate');
      if (lastUpdate) {
        const time = new Date(data.timestamp).toLocaleTimeString('en-GB');
        lastUpdate.textContent = `Updated: ${time}`;
      }

      // Update service health
      let servicesOk = 0;
      data.services.forEach(service => {
        const item = document.querySelector(`[data-service="${service.name}"]`);
        if (item) {
          const dot = item.querySelector('.health-dot');
          const latency = item.querySelector('.health-latency');

          dot.className = `health-dot ${service.status}`;

          if (service.latency) {
            latency.textContent = `${service.latency}ms`;
          } else if (service.message) {
            latency.textContent = service.message;
          } else {
            latency.textContent = '-';
          }

          if (service.status === 'ok') servicesOk++;
        }
      });

      // Update stats
      document.getElementById('statServicesOk').textContent = `${servicesOk}/${data.services.length}`;

      if (data.stats) {
        document.getElementById('statOrdersToday').textContent = data.stats.ordersToday || 0;
        document.getElementById('statRevenueToday').textContent = formatCurrency(data.stats.revenueToday || 0);
      }

      // Update livestream info
      const streamPreview = document.getElementById('streamPreview');
      const streamInfo = document.getElementById('streamInfo');
      const streamStatus = document.getElementById('statStreamStatus');

      if (data.livestream && data.livestream.isLive) {
        // Show live stream preview
        streamPreview.innerHTML = `
          <div class="preview-live">
            <div class="live-indicator">
              <span class="live-dot"></span>
              <span>LIVE</span>
            </div>
            <video id="streamVideo" class="stream-video" muted autoplay playsinline>
              <source src="${data.livestream.hlsUrl}" type="application/x-mpegURL">
            </video>
          </div>
        `;

        // Initialize HLS player
        initHLSPlayer(data.livestream.hlsUrl);

        // Show stream info
        streamInfo.classList.remove('hidden');
        document.getElementById('streamDJ').textContent = data.livestream.djName || 'Unknown';
        document.getElementById('streamTitle').textContent = data.livestream.title || 'Live Session';
        document.getElementById('streamViewers').textContent = data.livestream.viewers || 0;

        // Track duration
        currentStreamStartTime = data.livestream.duration || 0;
        updateStreamDuration();

        streamStatus.textContent = 'LIVE';
        streamStatus.style.color = '#ef4444';
      } else {
        // Show offline state
        streamPreview.innerHTML = `
          <div class="preview-placeholder">
            <span class="preview-icon">üì∫</span>
            <span class="preview-text">No active stream</span>
          </div>
        `;
        streamInfo.classList.add('hidden');
        streamStatus.textContent = 'Offline';
        streamStatus.style.color = '#6b7280';
        currentStreamStartTime = null;
      }

    } catch (error) {
      console.error('Health check failed:', error);
      document.getElementById('monitorLastUpdate').textContent = 'Error fetching data';
    }
  }

  function initHLSPlayer(hlsUrl) {
    const video = document.getElementById('streamVideo');
    if (!video) return;

    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Native HLS support (Safari)
      video.src = hlsUrl;
    } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
      // HLS.js for other browsers
      const hls = new Hls({ enableWorker: false });
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
    }
  }

  function updateStreamDuration() {
    if (currentStreamStartTime === null) return;

    const durationEl = document.getElementById('streamDuration');
    if (durationEl) {
      durationEl.textContent = formatDuration(currentStreamStartTime);
      currentStreamStartTime++;
    }
  }

  // Initialize monitor
  document.addEventListener('DOMContentLoaded', () => {
    // Initial fetch
    fetchHealthData();

    // Refresh every 30 seconds
    monitorInterval = setInterval(fetchHealthData, 30000);

    // Update duration every second
    streamDurationInterval = setInterval(updateStreamDuration, 1000);

    // Manual refresh button
    document.getElementById('refreshMonitor')?.addEventListener('click', () => {
      document.getElementById('monitorLastUpdate').textContent = 'Checking...';
      fetchHealthData();
    });
  });

  // Load HLS.js for non-Safari browsers
  if (!document.querySelector('script[src*="hls.js"]')) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
    document.head.appendChild(script);
  }
</script>

<script>
  // Server Control Panel
  document.addEventListener('DOMContentLoaded', () => {
    const serverStatus = document.getElementById('serverStatus');
    const actionResult = document.getElementById('actionResult');
    const actionResultIcon = document.getElementById('actionResultIcon');
    const actionResultText = document.getElementById('actionResultText');
    const logsPanel = document.getElementById('serverLogsPanel');
    const logsContent = document.getElementById('serverLogsContent');

    // Show action result
    function showResult(type, message) {
      actionResult.className = `action-result ${type}`;
      actionResultIcon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
      actionResultText.textContent = message;
      actionResult.classList.remove('hidden');

      // Auto-hide after 5 seconds
      setTimeout(() => {
        actionResult.classList.add('hidden');
      }, 5000);
    }

    // Generic action handler
    async function executeAction(action, confirmMessage) {
      if (confirmMessage && !confirm(confirmMessage)) return;

      try {
        const response = await fetch('/api/admin/server-control', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });

        const result = await response.json();

        if (result.success) {
          showResult('success', result.message || `${action} completed successfully`);
          // Refresh server status
          checkServerStatus();
        } else {
          showResult('error', result.error || `${action} failed`);
        }
      } catch (error) {
        showResult('error', `Failed to execute ${action}: ${error.message}`);
      }
    }

    // Check server status
    async function checkServerStatus() {
      serverStatus.className = 'server-status checking';
      serverStatus.textContent = 'Checking...';

      try {
        const response = await fetch('/api/admin/server-status');
        const data = await response.json();

        if (data.online) {
          serverStatus.className = 'server-status online';
          serverStatus.textContent = 'Online';
        } else {
          serverStatus.className = 'server-status offline';
          serverStatus.textContent = 'Offline';
        }
      } catch (error) {
        serverStatus.className = 'server-status error';
        serverStatus.textContent = 'Unknown';
      }
    }

    // Stream Server Controls
    document.getElementById('serverStartBtn')?.addEventListener('click', () => {
      executeAction('start-server', 'Start the MediaMTX stream server?');
    });

    document.getElementById('serverStopBtn')?.addEventListener('click', () => {
      executeAction('stop-server', 'Stop the MediaMTX stream server? This will disconnect all active streams.');
    });

    document.getElementById('serverRestartBtn')?.addEventListener('click', () => {
      executeAction('restart-server', 'Restart the MediaMTX stream server? Active streams will be briefly interrupted.');
    });

    // Stream Management
    document.getElementById('forceEndStreamBtn')?.addEventListener('click', () => {
      executeAction('force-end-streams', 'Force end ALL active streams? This cannot be undone.');
    });

    document.getElementById('clearChatBtn')?.addEventListener('click', () => {
      executeAction('clear-chat', 'Clear all chat messages from the livestream? This cannot be undone.');
    });

    document.getElementById('kickAllViewersBtn')?.addEventListener('click', () => {
      executeAction('kick-viewers', 'Disconnect all viewers from the stream?');
    });

    // Maintenance
    document.getElementById('clearCacheBtn')?.addEventListener('click', () => {
      executeAction('clear-cache', 'Clear CDN and storage cache?');
    });

    document.getElementById('syncDataBtn')?.addEventListener('click', () => {
      executeAction('sync-data');
    });

    document.getElementById('cleanupDbBtn')?.addEventListener('click', () => {
      executeAction('cleanup-db', 'Clean up expired sessions and stale data?');
    });

    // Diagnostics
    document.getElementById('testStreamBtn')?.addEventListener('click', () => {
      executeAction('test-stream');
    });

    document.getElementById('checkHealthBtn')?.addEventListener('click', async () => {
      showResult('info', 'Running full health check...');
      await executeAction('health-check');
    });

    // View Logs
    document.getElementById('viewLogsBtn')?.addEventListener('click', async () => {
      logsPanel.classList.toggle('hidden');

      if (!logsPanel.classList.contains('hidden')) {
        logsContent.textContent = 'Loading logs...';

        try {
          const response = await fetch('/api/admin/server-logs');
          const data = await response.json();

          if (data.logs) {
            logsContent.textContent = data.logs;
          } else {
            logsContent.textContent = 'No logs available';
          }
        } catch (error) {
          logsContent.textContent = 'Failed to load logs: ' + error.message;
        }
      }
    });

    document.getElementById('closeLogsBtn')?.addEventListener('click', () => {
      logsPanel.classList.add('hidden');
    });

    // Initial status check
    checkServerStatus();

    // Refresh status every 30 seconds
    setInterval(checkServerStatus, 30000);
  });
</script>
