---
// src/pages/admin/dj-mixes/manage.astro
// UPDATED: Now uses Firebase + R2 storage
import Layout from '../../../layouts/Layout.astro';
import { initializeApp, getApps, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

let mixes = [];
let errorMessage = '';

try {
  // Get mixes from Firebase dj-mixes collection
  const mixesSnapshot = await db.collection('dj-mixes').orderBy('upload_date', 'desc').get();
  
  mixesSnapshot.forEach(doc => {
    const data = doc.data();
    mixes.push({
      id: doc.id,
      ...data
    });
  });
  
  console.log(`[ADMIN] Loaded ${mixes.length} mixes from Firebase`);
} catch (error) {
  console.error('Error loading mixes:', error);
  errorMessage = error instanceof Error ? error.message : 'Unknown error';
}

const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);
const totalDownloads = mixes.reduce((sum, m) => sum + (m.downloads || 0), 0);
const totalLikes = mixes.reduce((sum, m) => sum + (m.likes || 0), 0);
const totalComments = mixes.reduce((sum, m) => sum + (m.commentCount || 0), 0);

// Helper function to format duration
function formatDuration(seconds) {
  if (!seconds) return '--:--';
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  if (hrs > 0) {
    return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}
---

<Layout title="Manage DJ Mixes - Admin">
  <style>
    * { box-sizing: border-box; }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #ffffff;
    }

    .header-bar {
      background: #ffffff;
      padding: 30px 20px;
      margin-bottom: 30px;
      border: 3px solid #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo { height: 80px; width: auto; max-width: 200px; }

    .header-actions { display: flex; gap: 10px; }

    .back-btn, .upload-btn {
      padding: 10px 20px;
      background: #000;
      color: #fff;
      border: 3px solid #000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      text-decoration: none;
      font-size: 13px;
    }

    .back-btn:hover, .upload-btn:hover {
      background: #fff;
      color: #000;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #000;
    }

    .upload-btn {
      background: #dc2626;
      border-color: #dc2626;
    }

    .upload-btn:hover {
      background: #fff;
      color: #dc2626;
    }

    .page-header {
      background: #fff;
      border: 3px solid #000;
      border-top: 8px solid #000;
      padding: 30px;
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 32px;
      font-weight: 900;
      margin: 0 0 10px 0;
      text-transform: uppercase;
    }

    .page-header p { color: #666; font-size: 16px; margin: 0; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #fff;
      border: 3px solid #000;
      padding: 20px;
      transition: all 0.2s;
    }

    .stat-card:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #000;
    }

    .stat-label {
      font-size: 11px;
      font-weight: 700;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value { font-size: 28px; font-weight: 900; line-height: 1; }

    .table-wrapper {
      background: #fff;
      border: 3px solid #000;
      overflow-x: auto;
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #000;
      color: #fff;
    }

    th {
      text-align: left;
      padding: 15px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 2px solid #000;
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #f9f9f9; }

    td {
      padding: 15px;
      vertical-align: middle;
    }

    .artwork {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border: 2px solid #000;
    }

    .mix-info h3 {
      font-size: 16px;
      font-weight: 900;
      margin: 0 0 5px 0;
    }

    .mix-info p {
      font-size: 14px;
      color: #666;
      margin: 2px 0;
    }

    .mix-info .genre {
      display: inline-block;
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      color: #374151;
      text-transform: uppercase;
      margin-top: 5px;
    }

    .mix-info .duration {
      font-size: 12px;
      color: #dc2626;
      font-weight: 700;
    }

    .stats-cell { display: flex; gap: 12px; font-size: 12px; font-weight: 600; }
    .stats-cell span { display: flex; align-items: center; gap: 4px; }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .btn {
      padding: 8px 14px;
      border: 2px solid #000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      text-transform: uppercase;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      white-space: nowrap;
    }

    .btn-view { background: #fff; color: #000; }
    .btn-view:hover { background: #000; color: #fff; }

    .btn-listen { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .btn-listen:hover { background: #fff; color: #3b82f6; }

    .btn-page { background: #10b981; color: #fff; border-color: #10b981; }
    .btn-page:hover { background: #fff; color: #10b981; }

    .btn-delete { background: #ff0000; color: #fff; border-color: #ff0000; }
    .btn-delete:hover { background: #fff; color: #ff0000; }

    .empty {
      text-align: center;
      padding: 60px 20px;
      background: #fff;
      border: 3px solid #000;
    }

    .empty h2 { font-size: 24px; font-weight: 900; margin: 0 0 10px 0; }
    .empty p { color: #666; margin-bottom: 20px; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #fff;
      border: 5px solid #000;
      max-width: 500px;
      width: 90%;
      padding: 30px;
      box-shadow: 12px 12px 0 #000;
    }

    .modal h2 {
      font-size: 24px;
      font-weight: 900;
      margin: 0 0 20px 0;
      text-transform: uppercase;
    }

    .modal p { margin-bottom: 15px; line-height: 1.6; }

    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

    .modal-btn {
      flex: 1;
      padding: 15px;
      border: 3px solid #000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      background: #fff;
    }

    .modal-btn-confirm { background: #ff0000; color: #fff; border-color: #ff0000; }
    .modal-btn-confirm:hover { background: #fff; color: #ff0000; }
    .modal-btn-cancel { background: #fff; color: #000; }
    .modal-btn-cancel:hover { background: #000; color: #fff; }

    .success {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: #fff;
      padding: 15px 20px;
      border: 3px solid #000;
      font-weight: 700;
      box-shadow: 8px 8px 0 #000;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .error {
      background: #ff0000;
      color: #fff;
      padding: 15px;
      border: 3px solid #ff0000;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .storage-badge {
      display: inline-block;
      background: #000;
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      margin-left: 8px;
    }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header-bar { padding: 20px 15px; flex-direction: column; gap: 15px; }
      .header-actions { width: 100%; justify-content: center; }
      .logo { height: 60px; }
      .back-btn, .upload-btn { padding: 8px 12px; font-size: 11px; }
      .page-header { padding: 20px; }
      .page-header h1 { font-size: 24px; }
      .page-header p { font-size: 14px; }
      .stat-card { padding: 15px; }
      .stat-value { font-size: 24px; }
      th, td { padding: 10px; }
      .artwork { width: 50px; height: 50px; }
      .actions { flex-direction: column; gap: 5px; }
      .btn { padding: 6px 10px; font-size: 10px; width: 100%; }
      .mix-info h3 { font-size: 14px; }
      .mix-info p { font-size: 12px; }
    }
  </style>

  <div class="container">
    <!-- Header -->
    <div class="header-bar">
      <img src="/logo.webp" alt="Fresh Wax" class="logo" onerror="this.style.display='none'">
      <div class="header-actions">
        <a href="/upload-mix" class="upload-btn">+ Upload Mix</a>
        <a href="/admin" class="back-btn">‚Üê Dashboard</a>
      </div>
    </div>

    <div class="page-header">
      <h1>üéß Manage DJ Mixes</h1>
      <p>Review and manage all uploaded DJ mixes <span class="storage-badge">Firebase + R2</span></p>
    </div>

    {errorMessage && (
      <div class="error">‚ö†Ô∏è Error loading mixes: {errorMessage}</div>
    )}

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Mixes</div>
        <div class="stat-value">{mixes.length}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Plays</div>
        <div class="stat-value">{totalPlays.toLocaleString()}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Downloads</div>
        <div class="stat-value">{totalDownloads.toLocaleString()}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Likes</div>
        <div class="stat-value">{totalLikes.toLocaleString()}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Comments</div>
        <div class="stat-value">{totalComments.toLocaleString()}</div>
      </div>
    </div>

    {mixes.length === 0 ? (
      <div class="empty">
        <h2>No DJ Mixes Found</h2>
        <p>There are currently no mixes in the Firebase database.</p>
        <a href="/upload-mix" class="btn btn-listen">Upload First Mix</a>
      </div>
    ) : (
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Artwork</th>
              <th>Mix Info</th>
              <th>Stats</th>
              <th>Uploaded</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {mixes.map((mix) => (
              <tr data-mix-id={mix.id}>
                <td>
                  <img 
                    src={mix.artwork_url || mix.artworkUrl || '/logo.webp'} 
                    alt={mix.title}
                    class="artwork"
                    onerror="this.src='/logo.webp'"
                  />
                </td>
                <td>
                  <div class="mix-info">
                    <h3>{mix.title || mix.mixTitle}</h3>
                    <p>by {mix.dj_name || mix.djName}</p>
                    <span class="duration">‚è± {formatDuration(mix.durationSeconds)}</span>
                    <br/>
                    <span class="genre">{mix.genre || 'Jungle & D&B'}</span>
                  </div>
                </td>
                <td>
                  <div class="stats-cell">
                    <span title="Plays">‚ñ∂ {mix.plays || 0}</span>
                    <span title="Downloads">‚¨á {mix.downloads || 0}</span>
                    <span title="Likes">‚ù§ {mix.likes || 0}</span>
                    <span title="Comments">üí¨ {mix.commentCount || 0}</span>
                  </div>
                </td>
                <td>
                  {mix.upload_date || mix.uploadedAt ? 
                    new Date(mix.upload_date || mix.uploadedAt).toLocaleDateString('en-GB', {
                      day: 'numeric',
                      month: 'short',
                      year: 'numeric'
                    }) : 'N/A'}
                </td>
                <td>
                  <div class="actions">
                    <a href={mix.audio_url || mix.audioUrl} target="_blank" class="btn btn-listen">üéß Listen</a>
                    <a href={`/dj-mix/${mix.id}`} target="_blank" class="btn btn-page">üëÅ View</a>
                    <button 
                      class="btn btn-delete" 
                      data-mix-id={mix.id} 
                      data-mix-title={mix.title || mix.mixTitle}
                      data-folder-path={mix.folder_path || ''}
                    >
                      üóë Delete
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </div>

  <!-- Delete Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>‚ö†Ô∏è Confirm Deletion</h2>
      <p>Are you sure you want to delete "<strong id="mixTitle"></strong>"?</p>
      <p style="color: #666; font-size: 14px;">
        This will permanently remove:
      </p>
      <ul style="color: #666; font-size: 14px; margin: 10px 0 10px 20px;">
        <li>Audio file from R2 storage</li>
        <li>Artwork from R2 storage</li>
        <li>All stats (plays, downloads, likes)</li>
        <li>All comments</li>
        <li>Firebase database entry</li>
      </ul>
      <p style="color: #ff0000; font-weight: 700;">
        This action cannot be undone.
      </p>
      <div class="modal-actions">
        <button id="confirmBtn" class="modal-btn modal-btn-confirm">üóë Delete Mix</button>
        <button id="cancelBtn" class="modal-btn modal-btn-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let mixToDelete = null;
    let folderPath = null;
    const modal = document.getElementById('modal');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // Open modal
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => {
        mixToDelete = btn.getAttribute('data-mix-id');
        folderPath = btn.getAttribute('data-folder-path');
        document.getElementById('mixTitle').textContent = btn.getAttribute('data-mix-title');
        modal.classList.add('active');
      });
    });

    // Close modal
    cancelBtn.addEventListener('click', () => {
      modal.classList.remove('active');
      mixToDelete = null;
      folderPath = null;
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        mixToDelete = null;
        folderPath = null;
      }
    });

    // Escape key closes modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        modal.classList.remove('active');
        mixToDelete = null;
        folderPath = null;
      }
    });

    // Delete mix
    confirmBtn.addEventListener('click', async () => {
      if (!mixToDelete) return;

      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Deleting...';

      try {
        const response = await fetch('/api/delete-mix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            mixId: mixToDelete,
            folderPath: folderPath
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showSuccess('‚úÖ Mix deleted successfully');
          document.querySelector(`tr[data-mix-id="${mixToDelete}"]`)?.remove();
          modal.classList.remove('active');
          mixToDelete = null;
          folderPath = null;
          
          // Update stats display
          setTimeout(() => location.reload(), 1500);
        } else {
          alert('Failed to delete mix: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete mix: ' + error.message);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'üóë Delete Mix';
      }
    });

    function showSuccess(message) {
      const el = document.createElement('div');
      el.className = 'success';
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }
  </script>
</Layout>