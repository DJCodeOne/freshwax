---
// src/pages/admin/dj-mixes/manage.astro
// Fresh Wax DJ Mixes Management - Unified Admin Design

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { d1GetAllMixes } from '../../../lib/d1-catalog';
import { queryCollection } from '../../../lib/firebase-rest';

// Get admin key for API calls
const runtime = (Astro.locals as any)?.runtime;
const ADMIN_KEY = runtime?.env?.ADMIN_KEY || import.meta.env.ADMIN_KEY || '';
const db = runtime?.env?.DB;

// Fetch all DJ mixes - prefer D1, fallback to Firebase
let allMixes: any[] = [];
if (db) {
  allMixes = await d1GetAllMixes(db);
}
if (allMixes.length === 0) {
  allMixes = await queryCollection('dj-mixes', {
    orderBy: { field: 'uploadedAt', direction: 'DESCENDING' }
  });
}

const mixes = allMixes.map((data: any) => ({
  ...data,
  uploadedAt: data.uploadedAt instanceof Date ? data.uploadedAt : new Date(data.uploadedAt || Date.now())
}));

// Stats
const totalMixes = mixes.length;
const publishedMixes = mixes.filter(m => m.published).length;
const unpublishedMixes = mixes.filter(m => !m.published).length;
const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);
const totalDownloads = mixes.reduce((sum, m) => sum + (m.downloads || 0), 0);
const totalLikes = mixes.reduce((sum, m) => sum + (m.likes || 0), 0);

const stats = [
  { label: 'Total Mixes', value: totalMixes },
  { label: 'Published', value: publishedMixes, type: 'success' },
  { label: 'Unpublished', value: unpublishedMixes, type: unpublishedMixes > 0 ? 'warning' : 'default' },
  { label: 'Total Plays', value: totalPlays.toLocaleString(), type: 'info' },
  { label: 'Downloads', value: totalDownloads.toLocaleString() },
  { label: 'Likes', value: totalLikes.toLocaleString() },
];

// Format date
const formatDate = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'short', 
    year: 'numeric' 
  });
};

// Get duration in seconds from mix object
const getDurationSeconds = (mix: any): number => {
  // Check durationSeconds first (number)
  if (mix.durationSeconds && typeof mix.durationSeconds === 'number') {
    return Math.floor(mix.durationSeconds);
  }

  // Check durationSeconds as string (e.g., "3600")
  if (mix.durationSeconds && typeof mix.durationSeconds === 'string') {
    const parsed = parseInt(mix.durationSeconds, 10);
    if (!isNaN(parsed) && parsed > 0) return parsed;
  }

  // Check if duration is a string in format "H:MM:SS" or "MM:SS"
  if (mix.duration && typeof mix.duration === 'string') {
    if (mix.duration.includes(':')) {
      const parts = mix.duration.split(':').map(Number);
      if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2]; // H:MM:SS
      } else if (parts.length === 2) {
        return parts[0] * 60 + parts[1]; // MM:SS
      }
    } else {
      // Try parsing as seconds string
      const parsed = parseInt(mix.duration, 10);
      if (!isNaN(parsed) && parsed > 0) return parsed;
    }
  }

  // Check duration as number
  if (mix.duration && typeof mix.duration === 'number') {
    return Math.floor(mix.duration);
  }

  // Check duration_seconds (snake_case from D1)
  if (mix.duration_seconds && typeof mix.duration_seconds === 'number') {
    return Math.floor(mix.duration_seconds);
  }
  if (mix.duration_seconds && typeof mix.duration_seconds === 'string') {
    const parsed = parseInt(mix.duration_seconds, 10);
    if (!isNaN(parsed) && parsed > 0) return parsed;
  }

  // Check other possible field names
  return Math.floor(mix.mixDuration || mix.length || (mix.durationMs ? mix.durationMs / 1000 : 0) || 0);
};

// Format duration for display
const formatDuration = (mix: any) => {
  const seconds = getDurationSeconds(mix);
  if (!seconds) return '-';
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  if (hrs > 0) {
    return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  return `${mins}:${secs.toString().padStart(2, '0')}`;
};

export const prerender = false;
---

<AdminLayout title="DJ Mixes" activeNav="mixes" showStats={true} stats={stats}>
  <Fragment slot="actions">
    <a href="/dj-mixes/upload" class="btn btn-primary">+ Upload Mix</a>
  </Fragment>

  <!-- Filters -->
  <div class="toolbar">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All</button>
      <button class="filter-tab" data-filter="published">Published</button>
      <button class="filter-tab" data-filter="unpublished">Unpublished</button>
    </div>
    
    <div class="search-wrapper" style="flex: 1; max-width: 300px; margin-left: auto;">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        id="searchInput" 
        class="form-input" 
        placeholder="Search mixes..."
      >
    </div>
  </div>

  <!-- Mixes Table -->
  {mixes.length === 0 ? (
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <div class="empty-state-icon">üéß</div>
          <div class="empty-state-title">No mixes yet</div>
          <p class="empty-state-text">Upload your first DJ mix to get started.</p>
          <a href="/dj-mixes/upload" class="btn btn-primary">+ Upload Mix</a>
        </div>
      </div>
    </div>
  ) : (
    <div class="card">
      <div class="card-header">
        <h2>All Mixes</h2>
        <span class="text-muted">{mixes.length} mixes</span>
      </div>
      <div class="table-wrapper">
        <table class="data-table" id="mixesTable">
          <thead>
            <tr>
              <th style="font-size: 0.9rem;">Mix</th>
              <th style="font-size: 0.9rem;">DJ</th>
              <th style="font-size: 0.9rem;">Duration</th>
              <th style="font-size: 0.9rem;">Stats</th>
              <th style="font-size: 0.9rem;">Status</th>
              <th style="font-size: 0.9rem;">Uploaded</th>
              <th class="text-right" style="font-size: 0.9rem;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {mixes.map(mix => (
              <tr 
                data-filter={mix.published ? 'published' : 'unpublished'}
                data-search={`${mix.title || ''} ${mix.djName || ''}`.toLowerCase()}
              >
                <td>
                  <div class="item-cell">
                    {mix.artworkUrl || mix.imageUrl ? (
                      <img src={mix.artworkUrl || mix.imageUrl} alt="" style="width: 56px; height: 56px;">
                    ) : (
                      <div style="width: 56px; height: 56px; background: #e5e5e5; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üéß</div>
                    )}
                    <div class="item-info">
                      <h4 style="font-size: 1rem; font-weight: 700;">{mix.title || 'Untitled Mix'}</h4>
                      <p class="cell-mono" style="font-size: 0.85rem;">{mix.genre || '-'}</p>
                    </div>
                  </div>
                </td>
                <td class="cell-primary" style="font-size: 0.95rem; font-weight: 600;">{mix.djName || 'Unknown DJ'}</td>
                <td class="cell-secondary" style="font-size: 0.9rem;">{formatDuration(mix)}</td>
                <td>
                  <div class="mix-stats">
                    <span title="Plays">‚ñ∂Ô∏è {(mix.plays || 0).toLocaleString()}</span>
                    <span title="Downloads">‚¨áÔ∏è {(mix.downloads || 0).toLocaleString()}</span>
                    <span title="Likes">‚ù§Ô∏è {(mix.likes || 0).toLocaleString()}</span>
                  </div>
                </td>
                <td>
                  <span class={`badge badge-${mix.published ? 'live' : 'draft'}`} style="font-size: 0.8rem; padding: 0.4rem 0.75rem;">
                    {mix.published ? 'Published' : 'Unpublished'}
                  </span>
                </td>
                <td class="cell-secondary" style="font-size: 0.9rem;">{formatDate(mix.uploadedAt)}</td>
                <td class="text-right">
                  <div class="flex gap-1 justify-end">
                    <a
                      href={`/dj-mix/${mix.id}`}
                      target="_blank"
                      class="btn btn-ghost btn-sm"
                      title="View"
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      üëÅÔ∏è
                    </a>
                    <a
                      href={`/admin/dj-mixes/edit/${mix.id}`}
                      class="btn btn-outline btn-sm"
                      title="Edit"
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      ‚úèÔ∏è
                    </a>
                    <button
                      class="btn btn-outline btn-sm toggle-btn"
                      data-id={mix.id}
                      data-published={mix.published ? 'true' : 'false'}
                      title={mix.published ? 'Unpublish' : 'Publish'}
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      {mix.published ? '‚è∏Ô∏è' : 'üöÄ'}
                    </button>
                    <button 
                      class="btn btn-danger btn-sm delete-btn"
                      data-id={mix.id}
                      data-title={mix.title}
                      title="Delete"
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="delete-modal hidden">
    <div class="delete-modal-overlay"></div>
    <div class="delete-modal-content">
      <div class="delete-modal-icon">‚ö†Ô∏è</div>
      <h3>Delete Mix?</h3>
      <p id="deleteModalText">Are you sure you want to delete this mix?</p>
      <p class="delete-warning">This will also delete the audio file and cannot be undone.</p>
      <div class="delete-modal-actions">
        <button id="cancelDeleteBtn" class="btn btn-outline">Cancel</button>
        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <Fragment slot="scripts">
    <script define:vars={{ ADMIN_KEY }}>
      // Filter functionality
      const filterTabs = document.querySelectorAll('.filter-tab');
      const searchInput = document.getElementById('searchInput');
      const tableRows = document.querySelectorAll('#mixesTable tbody tr');
      
      let currentFilter = 'all';

      function filterMixes() {
        const search = searchInput?.value?.toLowerCase() || '';

        tableRows.forEach(row => {
          const rowFilter = row.dataset.filter;
          const rowSearch = row.dataset.search || '';

          const matchFilter = currentFilter === 'all' || rowFilter === currentFilter;
          const matchSearch = !search || rowSearch.includes(search);

          row.style.display = (matchFilter && matchSearch) ? '' : 'none';
        });
      }

      filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          filterTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          filterMixes();
        });
      });

      searchInput?.addEventListener('input', filterMixes);

      // Toggle publish status
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const isPublished = btn.dataset.published === 'true';
          const newStatus = !isPublished;
          
          btn.disabled = true;
          
          try {
            const response = await fetch('/api/admin/toggle-mix-publish', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mixId: id, published: newStatus, adminKey: ADMIN_KEY })
            });
            
            if (!response.ok) throw new Error('Failed to update');
            
            showToast(newStatus ? 'Mix published' : 'Mix unpublished');
            setTimeout(() => location.reload(), 1000);
            
          } catch (error) {
            console.error(error);
            showToast('Failed to update mix', 'error');
            btn.disabled = false;
          }
        });
      });

      // Delete mix - with custom confirmation modal
      let pendingDeleteId = null;
      let pendingDeleteBtn = null;
      const deleteModal = document.getElementById('deleteModal');
      const deleteModalText = document.getElementById('deleteModalText');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const title = btn.dataset.title || 'this mix';

          // Store pending delete info
          pendingDeleteId = id;
          pendingDeleteBtn = btn;

          // Update modal text and show
          deleteModalText.textContent = `Are you sure you want to delete "${title}"?`;
          deleteModal.classList.remove('hidden');
        });
      });

      // Cancel delete
      cancelDeleteBtn?.addEventListener('click', () => {
        deleteModal.classList.add('hidden');
        pendingDeleteId = null;
        pendingDeleteBtn = null;
      });

      // Click overlay to cancel
      deleteModal?.querySelector('.delete-modal-overlay')?.addEventListener('click', () => {
        deleteModal.classList.add('hidden');
        pendingDeleteId = null;
        pendingDeleteBtn = null;
      });

      // Confirm delete
      confirmDeleteBtn?.addEventListener('click', async () => {
        if (!pendingDeleteId || !pendingDeleteBtn) return;

        const btn = pendingDeleteBtn;
        const id = pendingDeleteId;

        // Hide modal and disable button
        deleteModal.classList.add('hidden');
        btn.disabled = true;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = 'Deleting...';

        try {
          const response = await fetch('/api/admin/delete-mix', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mixId: id, adminKey: ADMIN_KEY })
          });

          const result = await response.json();
          console.log('[delete-mix] Response:', response.status, result);

          if (!response.ok) throw new Error(result.details || result.error || 'Failed to delete');

          const row = btn.closest('tr');
          row.style.opacity = '0';
          row.style.transition = 'opacity 0.3s';
          setTimeout(() => row.remove(), 300);

          showToast('Mix deleted');

        } catch (error) {
          console.error(error);
          showToast('Failed to delete mix', 'error');
          btn.disabled = false;
        } finally {
          // Reset modal state
          pendingDeleteId = null;
          pendingDeleteBtn = null;
          confirmDeleteBtn.disabled = false;
          confirmDeleteBtn.textContent = 'Delete';
        }
      });
    </script>
  </Fragment>
</AdminLayout>

<style>
  .mix-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .mix-stats span {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 600;
  }

  /* Delete Confirmation Modal */
  .delete-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .delete-modal.hidden {
    display: none;
  }

  .delete-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .delete-modal-content {
    position: relative;
    background: #1a1a2e;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }

  .delete-modal-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .delete-modal-content h3 {
    font-family: 'Inter', sans-serif; font-weight: 700;
    font-size: 1.75rem;
    color: #fff;
    margin: 0 0 0.5rem;
  }

  .delete-modal-content p {
    color: #9ca3af;
    margin: 0 0 0.5rem;
    font-size: 1rem;
  }

  .delete-warning {
    color: #ef4444 !important;
    font-size: 0.9rem !important;
    margin-bottom: 1.5rem !important;
  }

  .delete-modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .delete-modal-actions .btn {
    min-width: 100px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
  }

  .delete-modal-actions .btn-danger {
    background: #dc2626;
    color: #fff;
    border: none;
  }

  .delete-modal-actions .btn-danger:hover {
    background: #b91c1c;
  }

  .delete-modal-actions .btn-outline {
    background: transparent;
    border: 1px solid #555;
    color: #fff;
  }

  .delete-modal-actions .btn-outline:hover {
    background: #333;
  }
</style>
