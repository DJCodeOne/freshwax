---
// src/pages/admin/dj-mixes/manage.astro
// Fresh Wax DJ Mixes Management - Unified Admin Design

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { queryCollection } from '../../../lib/firebase-rest';

// Fetch all DJ mixes via REST API
const allMixes = await queryCollection('dj-mixes', {
  orderBy: { field: 'uploadedAt', direction: 'DESCENDING' }
});

const mixes = allMixes.map((data: any) => ({
  ...data,
  uploadedAt: data.uploadedAt instanceof Date ? data.uploadedAt : new Date(data.uploadedAt || Date.now())
}));

// Stats
const totalMixes = mixes.length;
const publishedMixes = mixes.filter(m => m.published).length;
const unpublishedMixes = mixes.filter(m => !m.published).length;
const totalPlays = mixes.reduce((sum, m) => sum + (m.plays || 0), 0);
const totalDownloads = mixes.reduce((sum, m) => sum + (m.downloads || 0), 0);
const totalLikes = mixes.reduce((sum, m) => sum + (m.likes || 0), 0);

const stats = [
  { label: 'Total Mixes', value: totalMixes },
  { label: 'Published', value: publishedMixes, type: 'success' },
  { label: 'Unpublished', value: unpublishedMixes, type: unpublishedMixes > 0 ? 'warning' : 'default' },
  { label: 'Total Plays', value: totalPlays.toLocaleString(), type: 'info' },
  { label: 'Downloads', value: totalDownloads.toLocaleString() },
  { label: 'Likes', value: totalLikes.toLocaleString() },
];

// Format date
const formatDate = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'short', 
    year: 'numeric' 
  });
};

// Format duration
const formatDuration = (seconds) => {
  if (!seconds) return '-';
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  if (hrs > 0) {
    return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  return `${mins}:${secs.toString().padStart(2, '0')}`;
};

export const prerender = false;
---

<AdminLayout title="DJ Mixes" activeNav="mixes" showStats={true} stats={stats}>
  <Fragment slot="actions">
    <a href="/dj-mixes/upload" class="btn btn-primary">+ Upload Mix</a>
  </Fragment>

  <!-- Filters -->
  <div class="toolbar">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All</button>
      <button class="filter-tab" data-filter="published">Published</button>
      <button class="filter-tab" data-filter="unpublished">Unpublished</button>
    </div>
    
    <div class="search-wrapper" style="flex: 1; max-width: 300px; margin-left: auto;">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        id="searchInput" 
        class="form-input" 
        placeholder="Search mixes..."
      >
    </div>
  </div>

  <!-- Mixes Table -->
  {mixes.length === 0 ? (
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <div class="empty-state-icon">üéß</div>
          <div class="empty-state-title">No mixes yet</div>
          <p class="empty-state-text">Upload your first DJ mix to get started.</p>
          <a href="/dj-mixes/upload" class="btn btn-primary">+ Upload Mix</a>
        </div>
      </div>
    </div>
  ) : (
    <div class="card">
      <div class="card-header">
        <h2>All Mixes</h2>
        <span class="text-muted">{mixes.length} mixes</span>
      </div>
      <div class="table-wrapper">
        <table class="data-table" id="mixesTable">
          <thead>
            <tr>
              <th style="font-size: 0.9rem;">Mix</th>
              <th style="font-size: 0.9rem;">DJ</th>
              <th style="font-size: 0.9rem;">Duration</th>
              <th style="font-size: 0.9rem;">Stats</th>
              <th style="font-size: 0.9rem;">Status</th>
              <th style="font-size: 0.9rem;">Uploaded</th>
              <th class="text-right" style="font-size: 0.9rem;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {mixes.map(mix => (
              <tr 
                data-filter={mix.published ? 'published' : 'unpublished'}
                data-search={`${mix.title || ''} ${mix.djName || ''}`.toLowerCase()}
              >
                <td>
                  <div class="item-cell">
                    {mix.artworkUrl || mix.imageUrl ? (
                      <img src={mix.artworkUrl || mix.imageUrl} alt="" style="width: 56px; height: 56px;">
                    ) : (
                      <div style="width: 56px; height: 56px; background: #e5e5e5; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üéß</div>
                    )}
                    <div class="item-info">
                      <h4 style="font-size: 1rem; font-weight: 700;">{mix.title || 'Untitled Mix'}</h4>
                      <p class="cell-mono" style="font-size: 0.85rem;">{mix.genre || '-'}</p>
                    </div>
                  </div>
                </td>
                <td class="cell-primary" style="font-size: 0.95rem; font-weight: 600;">{mix.djName || 'Unknown DJ'}</td>
                <td class="cell-secondary" style="font-size: 0.9rem;">{formatDuration(mix.duration)}</td>
                <td>
                  <div class="mix-stats">
                    <span title="Plays">‚ñ∂Ô∏è {(mix.plays || 0).toLocaleString()}</span>
                    <span title="Downloads">‚¨áÔ∏è {(mix.downloads || 0).toLocaleString()}</span>
                    <span title="Likes">‚ù§Ô∏è {(mix.likes || 0).toLocaleString()}</span>
                  </div>
                </td>
                <td>
                  <span class={`badge badge-${mix.published ? 'live' : 'draft'}`} style="font-size: 0.8rem; padding: 0.4rem 0.75rem;">
                    {mix.published ? 'Published' : 'Unpublished'}
                  </span>
                </td>
                <td class="cell-secondary" style="font-size: 0.9rem;">{formatDate(mix.uploadedAt)}</td>
                <td class="text-right">
                  <div class="flex gap-1 justify-end">
                    <a
                      href={`/dj-mix/${mix.id}`}
                      target="_blank"
                      class="btn btn-ghost btn-sm"
                      title="View"
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      üëÅÔ∏è
                    </a>
                    <a
                      href={`/admin/dj-mixes/edit/${mix.id}`}
                      class="btn btn-outline btn-sm"
                      title="Edit"
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      ‚úèÔ∏è
                    </a>
                    <button
                      class="btn btn-outline btn-sm toggle-btn"
                      data-id={mix.id}
                      data-published={mix.published ? 'true' : 'false'}
                      title={mix.published ? 'Unpublish' : 'Publish'}
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      {mix.published ? '‚è∏Ô∏è' : 'üöÄ'}
                    </button>
                    <button 
                      class="btn btn-danger btn-sm delete-btn"
                      data-id={mix.id}
                      data-title={mix.title}
                      title="Delete"
                      style="font-size: 1.25rem; padding: 0.5rem;"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}

  <Fragment slot="scripts">
    <script is:inline>
      // Filter functionality
      const filterTabs = document.querySelectorAll('.filter-tab');
      const searchInput = document.getElementById('searchInput');
      const tableRows = document.querySelectorAll('#mixesTable tbody tr');
      
      let currentFilter = 'all';

      function filterMixes() {
        const search = searchInput?.value?.toLowerCase() || '';

        tableRows.forEach(row => {
          const rowFilter = row.dataset.filter;
          const rowSearch = row.dataset.search || '';

          const matchFilter = currentFilter === 'all' || rowFilter === currentFilter;
          const matchSearch = !search || rowSearch.includes(search);

          row.style.display = (matchFilter && matchSearch) ? '' : 'none';
        });
      }

      filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          filterTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          filterMixes();
        });
      });

      searchInput?.addEventListener('input', filterMixes);

      // Toggle publish status
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const isPublished = btn.dataset.published === 'true';
          const newStatus = !isPublished;
          
          btn.disabled = true;
          
          try {
            const response = await fetch('/api/admin/toggle-mix-publish', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mixId: id, published: newStatus })
            });
            
            if (!response.ok) throw new Error('Failed to update');
            
            showToast(newStatus ? 'Mix published' : 'Mix unpublished');
            setTimeout(() => location.reload(), 1000);
            
          } catch (error) {
            console.error(error);
            showToast('Failed to update mix', 'error');
            btn.disabled = false;
          }
        });
      });

      // Delete mix
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const title = btn.dataset.title || 'this mix';
          
          if (!confirm(`Delete "${title}"? This will also delete the audio file and cannot be undone.`)) return;
          
          btn.disabled = true;
          
          try {
            const response = await fetch('/api/admin/delete-mix', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mixId: id })
            });
            
            if (!response.ok) throw new Error('Failed to delete');
            
            const row = btn.closest('tr');
            row.style.opacity = '0';
            row.style.transition = 'opacity 0.3s';
            setTimeout(() => row.remove(), 300);
            
            showToast('Mix deleted');
            
          } catch (error) {
            console.error(error);
            showToast('Failed to delete mix', 'error');
            btn.disabled = false;
          }
        });
      });
    </script>
  </Fragment>
</AdminLayout>

<style>
  .mix-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }
  
  .mix-stats span {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 600;
  }
</style>
