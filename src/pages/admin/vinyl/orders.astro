---
// src/pages/admin/vinyl/orders.astro
// Admin Vinyl Orders Management
import AdminLayout from '../../../layouts/AdminLayout.astro';
export const prerender = false;
---

<AdminLayout title="Vinyl Orders" activeNav="vinyl">
  <Fragment slot="actions">
    <a href="/admin/vinyl" class="btn btn-secondary">
      <span>‚Üê</span> Back to Vinyl
    </a>
  </Fragment>

  <!-- Stats Bar -->
  <div class="stats-grid mb-3">
    <div class="stat-card">
      <div class="stat-value" id="totalCount">0</div>
      <div class="stat-label">Total Orders</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-value" id="pendingCount">0</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card info">
      <div class="stat-value" id="shippedCount">0</div>
      <div class="stat-label">Shipped</div>
    </div>
    <div class="stat-card success">
      <div class="stat-value" id="deliveredCount">0</div>
      <div class="stat-label">Delivered</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="revenueTotal">¬£0</div>
      <div class="stat-label">Total Revenue</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="card mb-3">
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Search orders..." class="search-input">
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">All</button>
        <button class="filter-tab" data-filter="pending">Pending</button>
        <button class="filter-tab" data-filter="paid">Paid</button>
        <button class="filter-tab" data-filter="shipped">Shipped</button>
        <button class="filter-tab" data-filter="delivered">Delivered</button>
        <button class="filter-tab" data-filter="cancelled">Cancelled</button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="card">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading orders...</p>
    </div>
  </div>

  <!-- Orders Table -->
  <div id="ordersTable" class="card" style="display: none;">
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Buyer</th>
            <th>Seller</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="ordersTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="card" style="display: none;">
    <div class="empty-state">
      <div class="empty-icon">üì¶</div>
      <h3>No orders found</h3>
      <p>Try adjusting your search or filter criteria</p>
    </div>
  </div>

  <!-- View Order Modal -->
  <Fragment slot="modals">
    <div id="viewModal" class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h2>Order Details</h2>
          <button class="modal-close" onclick="closeModal('viewModal')">√ó</button>
        </div>
        <div class="modal-body">
          <div class="order-details">
            <div class="order-header">
              <div class="order-id">
                <span class="label">Order ID:</span>
                <strong id="viewOrderId"></strong>
              </div>
              <div class="order-status">
                <span id="viewStatusBadge" class="badge"></span>
              </div>
            </div>

            <div class="order-parties">
              <div class="party-card">
                <h4>Buyer</h4>
                <p id="viewBuyerName"></p>
                <p id="viewBuyerEmail" class="text-muted"></p>
              </div>
              <div class="party-card">
                <h4>Seller</h4>
                <p id="viewSellerName"></p>
                <p id="viewSellerEmail" class="text-muted"></p>
              </div>
            </div>

            <div class="order-items">
              <h4>Items</h4>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Condition</th>
                    <th class="text-right">Price</th>
                  </tr>
                </thead>
                <tbody id="viewItemsBody">
                </tbody>
              </table>
            </div>

            <div class="order-summary">
              <div class="summary-row">
                <span>Subtotal:</span>
                <span id="viewSubtotal"></span>
              </div>
              <div class="summary-row">
                <span>Shipping:</span>
                <span id="viewShipping"></span>
              </div>
              <div class="summary-row">
                <span>Processing Fee:</span>
                <span id="viewProcessingFee"></span>
              </div>
              <div class="summary-row">
                <span>Fresh Wax Fee:</span>
                <span id="viewPlatformFee"></span>
              </div>
              <div class="summary-row total">
                <span>Total:</span>
                <span id="viewTotal"></span>
              </div>
              <div class="summary-row seller-payout">
                <span>Seller Payout:</span>
                <span id="viewSellerPayout"></span>
              </div>
            </div>

            <div class="order-shipping" id="shippingSection">
              <h4>Shipping Address</h4>
              <p id="viewShippingAddress"></p>
            </div>

            <div class="order-tracking" id="trackingSection">
              <h4>Tracking</h4>
              <p>
                <span class="label">Carrier:</span>
                <span id="viewCarrier"></span>
              </p>
              <p>
                <span class="label">Tracking Number:</span>
                <span id="viewTrackingNumber"></span>
              </p>
            </div>

            <div class="order-timeline">
              <h4>Timeline</h4>
              <div id="viewTimeline" class="timeline"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('viewModal')">Close</button>
          <button type="button" class="btn btn-warning" id="refundBtn" onclick="initiateRefund()">Issue Refund</button>
        </div>
      </div>
    </div>
  </Fragment>

  <Fragment slot="scripts">
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g',
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      let allOrders = [];
      let currentFilter = 'all';
      let currentOrderId = null;

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = '/admin/login';
          return;
        }
        loadOrders();
      });

      async function loadOrders() {
        try {
          const response = await fetch(`https://firestore.googleapis.com/v1/projects/freshwax-store/databases/(default)/documents/vinylOrders?key=AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g&pageSize=500`);
          const data = await response.json();

          if (!data.documents) {
            allOrders = [];
          } else {
            allOrders = data.documents.map(doc => {
              const fields = doc.fields || {};
              const id = doc.name.split('/').pop();
              return {
                id,
                buyerId: fields.buyerId?.stringValue || '',
                buyerName: fields.buyerName?.stringValue || 'Unknown',
                buyerEmail: fields.buyerEmail?.stringValue || '',
                sellerId: fields.sellerId?.stringValue || '',
                sellerName: fields.sellerName?.stringValue || 'Unknown',
                sellerEmail: fields.sellerEmail?.stringValue || '',
                items: fields.items?.arrayValue?.values?.map(v => ({
                  title: v.mapValue?.fields?.title?.stringValue || '',
                  artist: v.mapValue?.fields?.artist?.stringValue || '',
                  condition: v.mapValue?.fields?.condition?.stringValue || '',
                  price: parseFloat(v.mapValue?.fields?.price?.doubleValue || v.mapValue?.fields?.price?.integerValue || 0)
                })) || [],
                subtotal: parseFloat(fields.subtotal?.doubleValue || fields.subtotal?.integerValue || 0),
                shipping: parseFloat(fields.shipping?.doubleValue || fields.shipping?.integerValue || 0),
                processingFee: parseFloat(fields.processingFee?.doubleValue || fields.processingFee?.integerValue || 0),
                platformFee: parseFloat(fields.platformFee?.doubleValue || fields.platformFee?.integerValue || 0),
                total: parseFloat(fields.total?.doubleValue || fields.total?.integerValue || 0),
                sellerPayout: parseFloat(fields.sellerPayout?.doubleValue || fields.sellerPayout?.integerValue || 0),
                status: fields.status?.stringValue || 'pending',
                shippingAddress: fields.shippingAddress?.mapValue?.fields || null,
                carrier: fields.carrier?.stringValue || '',
                trackingNumber: fields.trackingNumber?.stringValue || '',
                createdAt: fields.createdAt?.timestampValue || fields.createdAt?.stringValue || null,
                paidAt: fields.paidAt?.timestampValue || fields.paidAt?.stringValue || null,
                shippedAt: fields.shippedAt?.timestampValue || fields.shippedAt?.stringValue || null,
                deliveredAt: fields.deliveredAt?.timestampValue || fields.deliveredAt?.stringValue || null,
                cancelledAt: fields.cancelledAt?.timestampValue || fields.cancelledAt?.stringValue || null,
                refundedAt: fields.refundedAt?.timestampValue || fields.refundedAt?.stringValue || null
              };
            });
          }

          // Sort by date descending
          allOrders.sort((a, b) => {
            const dateA = new Date(a.createdAt || 0).getTime();
            const dateB = new Date(b.createdAt || 0).getTime();
            return dateB - dateA;
          });

          updateStats();
          renderOrders();

          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('ordersTable').style.display = 'block';

        } catch (error) {
          console.error('Error loading orders:', error);
          document.getElementById('loadingState').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ùå</div>
              <h3>Error loading orders</h3>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      function updateStats() {
        const pending = allOrders.filter(o => o.status === 'pending' || o.status === 'paid');
        const shipped = allOrders.filter(o => o.status === 'shipped');
        const delivered = allOrders.filter(o => o.status === 'delivered');
        const revenue = allOrders.filter(o => o.status !== 'cancelled' && o.status !== 'refunded')
          .reduce((sum, o) => sum + (o.totals?.total || o.total || 0), 0);

        document.getElementById('totalCount').textContent = allOrders.length;
        document.getElementById('pendingCount').textContent = pending.length;
        document.getElementById('shippedCount').textContent = shipped.length;
        document.getElementById('deliveredCount').textContent = delivered.length;
        document.getElementById('revenueTotal').textContent = '¬£' + revenue.toFixed(2);
      }

      function renderOrders() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        let filtered = allOrders.filter(o => {
          const matchesSearch = !searchTerm ||
            o.id.toLowerCase().includes(searchTerm) ||
            o.buyerName.toLowerCase().includes(searchTerm) ||
            o.sellerName.toLowerCase().includes(searchTerm);

          if (!matchesSearch) return false;

          switch (currentFilter) {
            case 'pending': return o.status === 'pending';
            case 'paid': return o.status === 'paid';
            case 'shipped': return o.status === 'shipped';
            case 'delivered': return o.status === 'delivered';
            case 'cancelled': return o.status === 'cancelled' || o.status === 'refunded';
            default: return true;
          }
        });

        const tbody = document.getElementById('ordersTableBody');
        const emptyState = document.getElementById('emptyState');
        const table = document.getElementById('ordersTable');

        if (filtered.length === 0) {
          tbody.innerHTML = '';
          table.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }

        table.style.display = 'block';
        emptyState.style.display = 'none';

        tbody.innerHTML = filtered.map(o => {
          let statusBadge;
          switch (o.status) {
            case 'pending':
              statusBadge = '<span class="badge badge-warning">Pending</span>';
              break;
            case 'paid':
              statusBadge = '<span class="badge badge-info">Paid</span>';
              break;
            case 'shipped':
              statusBadge = '<span class="badge badge-purple">Shipped</span>';
              break;
            case 'delivered':
              statusBadge = '<span class="badge badge-success">Delivered</span>';
              break;
            case 'cancelled':
              statusBadge = '<span class="badge badge-danger">Cancelled</span>';
              break;
            case 'refunded':
              statusBadge = '<span class="badge badge-danger">Refunded</span>';
              break;
            default:
              statusBadge = '<span class="badge">' + o.status + '</span>';
          }

          const dateStr = o.createdAt ?
            new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).format(new Date(o.createdAt)) :
            'Unknown';

          const itemCount = o.items?.length || 0;

          return `
            <tr>
              <td><code>${o.id.substring(0, 12)}...</code></td>
              <td class="text-muted">${dateStr}</td>
              <td>${o.buyerName}</td>
              <td>${o.sellerName}</td>
              <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
              <td><strong>¬£${(o.totals?.total || o.total || 0).toFixed(2)}</strong></td>
              <td>${statusBadge}</td>
              <td class="text-right">
                <button class="btn btn-sm btn-secondary" onclick="viewOrder('${o.id}')">View</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderOrders();
        });
      });

      document.getElementById('searchInput').addEventListener('input', () => renderOrders());

      window.viewOrder = function(id) {
        const order = allOrders.find(o => o.id === id);
        if (!order) return;

        currentOrderId = id;

        document.getElementById('viewOrderId').textContent = id;
        document.getElementById('viewBuyerName').textContent = order.buyerName;
        document.getElementById('viewBuyerEmail').textContent = order.buyerEmail;
        document.getElementById('viewSellerName').textContent = order.sellerName;
        document.getElementById('viewSellerEmail').textContent = order.sellerEmail;

        // Status badge
        const statusBadge = document.getElementById('viewStatusBadge');
        statusBadge.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        statusBadge.className = 'badge badge-' + getStatusClass(order.status);

        // Items
        const itemsBody = document.getElementById('viewItemsBody');
        itemsBody.innerHTML = (order.items || []).map(item => `
          <tr>
            <td>
              <strong>${item.artist}</strong> - ${item.title}
            </td>
            <td>${item.condition || 'N/A'}</td>
            <td class="text-right">¬£${(item.price || 0).toFixed(2)}</td>
          </tr>
        `).join('') || '<tr><td colspan="3" class="text-muted">No items</td></tr>';

        // Summary
        document.getElementById('viewSubtotal').textContent = '¬£' + (order.subtotal || 0).toFixed(2);
        document.getElementById('viewShipping').textContent = '¬£' + (order.shipping || 0).toFixed(2);
        document.getElementById('viewProcessingFee').textContent = '¬£' + (order.processingFee || 0).toFixed(2);
        document.getElementById('viewPlatformFee').textContent = '¬£' + (order.platformFee || 0).toFixed(2);
        document.getElementById('viewTotal').textContent = '¬£' + (order.totals?.total || order.total || 0).toFixed(2);
        document.getElementById('viewSellerPayout').textContent = '¬£' + (order.sellerPayout || 0).toFixed(2);

        // Shipping address
        const shippingSection = document.getElementById('shippingSection');
        if (order.shippingAddress) {
          const addr = order.shippingAddress;
          document.getElementById('viewShippingAddress').innerHTML = `
            ${addr.name?.stringValue || ''}<br>
            ${addr.line1?.stringValue || ''}<br>
            ${addr.line2?.stringValue ? addr.line2.stringValue + '<br>' : ''}
            ${addr.city?.stringValue || ''}, ${addr.postcode?.stringValue || ''}<br>
            ${addr.country?.stringValue || 'United Kingdom'}
          `;
          shippingSection.style.display = 'block';
        } else {
          shippingSection.style.display = 'none';
        }

        // Tracking
        const trackingSection = document.getElementById('trackingSection');
        if (order.carrier || order.trackingNumber) {
          document.getElementById('viewCarrier').textContent = order.carrier || 'Not specified';
          document.getElementById('viewTrackingNumber').textContent = order.trackingNumber || 'Not provided';
          trackingSection.style.display = 'block';
        } else {
          trackingSection.style.display = 'none';
        }

        // Timeline
        const timeline = document.getElementById('viewTimeline');
        const events = [];
        if (order.createdAt) events.push({ date: new Date(order.createdAt), label: 'Order placed' });
        if (order.paidAt) events.push({ date: new Date(order.paidAt), label: 'Payment received' });
        if (order.shippedAt) events.push({ date: new Date(order.shippedAt), label: 'Shipped' });
        if (order.deliveredAt) events.push({ date: new Date(order.deliveredAt), label: 'Delivered' });
        if (order.cancelledAt) events.push({ date: new Date(order.cancelledAt), label: 'Cancelled' });
        if (order.refundedAt) events.push({ date: new Date(order.refundedAt), label: 'Refunded' });

        events.sort((a, b) => a.date - b.date);

        timeline.innerHTML = events.map(e => `
          <div class="timeline-event">
            <span class="timeline-date">${new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }).format(e.date)}</span>
            <span class="timeline-label">${e.label}</span>
          </div>
        `).join('') || '<p class="text-muted">No events</p>';

        // Refund button
        const refundBtn = document.getElementById('refundBtn');
        if (order.status === 'refunded' || order.status === 'cancelled') {
          refundBtn.style.display = 'none';
        } else {
          refundBtn.style.display = 'inline-block';
        }

        openModal('viewModal');
      };

      function getStatusClass(status) {
        switch (status) {
          case 'pending': return 'warning';
          case 'paid': return 'info';
          case 'shipped': return 'purple';
          case 'delivered': return 'success';
          case 'cancelled':
          case 'refunded': return 'danger';
          default: return '';
        }
      }

      window.initiateRefund = async function() {
        if (!currentOrderId) return;
        if (!confirm('Are you sure you want to issue a refund for this order?')) return;

        try {
          const response = await fetch(`/api/admin/vinyl/order`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'refund',
              orderId: currentOrderId
            })
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || 'Failed to process refund');
          }

          showToast('Refund processed successfully', 'success');
          closeModal('viewModal');
          loadOrders();

        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      };
    </script>
  </Fragment>
</AdminLayout>

<style is:global>
  .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; }
  .stat-card { background: #fff; border: 2px solid #e5e5e5; padding: 1.25rem; text-align: center; }
  .stat-card.success { border-color: #16a34a; }
  .stat-card.warning { border-color: #d97706; }
  .stat-card.info { border-color: #0284c7; }
  .stat-value { font-size: 2rem; font-weight: 800; color: #000; line-height: 1; }
  .stat-card.success .stat-value { color: #16a34a; }
  .stat-card.warning .stat-value { color: #d97706; }
  .stat-card.info .stat-value { color: #0284c7; }
  .stat-label { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }

  .loading-spinner { text-align: center; padding: 3rem; }
  .spinner { width: 40px; height: 40px; border: 3px solid #e5e5e5; border-top-color: #dc2626; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .badge-purple { background: #7c3aed; color: #fff; }
  .modal-lg { max-width: 700px; }

  .order-details h4 { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin: 1.5rem 0 0.75rem; color: #333; }
  .order-details h4:first-child { margin-top: 0; }

  .order-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #e5e5e5; margin-bottom: 1rem; }
  .order-id .label { color: #666; font-size: 0.85rem; }
  .order-id strong { font-size: 1rem; font-family: monospace; }

  .order-parties { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .party-card { background: #f9f9f9; padding: 1rem; border: 1px solid #e5e5e5; }
  .party-card h4 { margin: 0 0 0.5rem; font-size: 0.75rem; }
  .party-card p { margin: 0; }

  .items-table { width: 100%; border-collapse: collapse; }
  .items-table th, .items-table td { padding: 0.75rem; border-bottom: 1px solid #e5e5e5; text-align: left; }
  .items-table th { font-size: 0.75rem; text-transform: uppercase; color: #666; }

  .order-summary { background: #f9f9f9; padding: 1rem; border: 1px solid #e5e5e5; }
  .summary-row { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem; }
  .summary-row.total { border-top: 2px solid #000; margin-top: 0.5rem; padding-top: 0.75rem; font-weight: 700; font-size: 1rem; }
  .summary-row.seller-payout { border-top: 1px dashed #ccc; margin-top: 0.5rem; padding-top: 0.75rem; color: #16a34a; }

  .order-shipping p, .order-tracking p { margin: 0.25rem 0; }
  .order-shipping .label, .order-tracking .label { color: #666; font-size: 0.85rem; }

  .timeline { display: flex; flex-direction: column; gap: 0.5rem; }
  .timeline-event { display: flex; align-items: center; gap: 1rem; padding: 0.5rem; background: #f9f9f9; }
  .timeline-date { font-size: 0.8rem; color: #666; min-width: 120px; }
  .timeline-label { font-weight: 500; }

  @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .order-parties { grid-template-columns: 1fr; } }
  @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
</style>
