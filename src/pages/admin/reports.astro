---
// src/pages/admin/reports.astro
import AdminLayout from '../../layouts/AdminLayout.astro';
export const prerender = false;
---

<AdminLayout title="Reports" currentPage="reports">
  <div class="reports-page">
    <div class="page-header">
      <div class="header-left">
        <h1>ðŸš© User Reports</h1>
        <p class="subtitle">Review and manage reported content and users</p>
      </div>
      <div class="header-stats">
        <div class="stat-badge pending" id="pending-count">
          <span class="count">0</span>
          <span class="label">Pending</span>
        </div>
        <div class="stat-badge reviewing" id="reviewing-count">
          <span class="count">0</span>
          <span class="label">Reviewing</span>
        </div>
      </div>
    </div>

    <div class="filters-bar">
      <div class="filter-group">
        <label>Status:</label>
        <select id="filter-status">
          <option value="pending">Pending</option>
          <option value="reviewing">Reviewing</option>
          <option value="resolved">Resolved</option>
          <option value="dismissed">Dismissed</option>
          <option value="all">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Type:</label>
        <select id="filter-type">
          <option value="">All Types</option>
          <option value="stream">Stream</option>
          <option value="artist">Artist</option>
          <option value="dj">DJ</option>
          <option value="user">User</option>
          <option value="release">Release</option>
          <option value="mix">Mix</option>
          <option value="comment">Comment</option>
          <option value="chat">Chat</option>
          <option value="other">Other</option>
        </select>
      </div>
      <button class="refresh-btn" onclick="loadReports()">
        <span class="icon">â†»</span> Refresh
      </button>
    </div>

    <div class="reports-list" id="reports-list">
      <div class="loading">Loading reports...</div>
    </div>
  </div>

  <!-- Report Detail Modal -->
  <div class="modal-overlay" id="report-detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Report Details</h3>
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="modal-body" id="report-detail-body">
        <!-- Populated dynamically -->
      </div>
      <div class="modal-footer" id="report-detail-footer">
        <!-- Action buttons -->
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .reports-page {
    padding: 2rem;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .page-header h1 {
    margin: 0;
    font-size: 1.75rem;
  }

  .subtitle {
    color: #888;
    margin: 0.25rem 0 0;
  }

  .header-stats {
    display: flex;
    gap: 1rem;
  }

  .stat-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    min-width: 80px;
  }

  .stat-badge.pending {
    background: rgba(255, 107, 53, 0.15);
    border: 1px solid rgba(255, 107, 53, 0.3);
  }

  .stat-badge.pending .count {
    color: #ff6b35;
  }

  .stat-badge.reviewing {
    background: rgba(78, 205, 196, 0.15);
    border: 1px solid rgba(78, 205, 196, 0.3);
  }

  .stat-badge.reviewing .count {
    color: #4ecdc4;
  }

  .stat-badge .count {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .stat-badge .label {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
  }

  .filters-bar {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-group label {
    color: #888;
    font-size: 0.9rem;
  }

  .filter-group select {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    color: #fff;
    font-size: 0.9rem;
  }

  .refresh-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
  }

  .refresh-btn:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .reports-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .loading, .empty-state {
    text-align: center;
    padding: 3rem;
    color: #888;
  }

  .report-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 1.25rem;
    transition: all 0.2s;
  }

  .report-card:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  .report-card.priority-urgent {
    border-left: 3px solid #ff5252;
  }

  .report-card.priority-high {
    border-left: 3px solid #ff6b35;
  }

  .report-card.priority-medium {
    border-left: 3px solid #f7931e;
  }

  .report-card.priority-low {
    border-left: 3px solid #4ecdc4;
  }

  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .report-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .report-type {
    background: rgba(255, 107, 53, 0.2);
    color: #ff6b35;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .report-category {
    background: rgba(255, 255, 255, 0.1);
    color: #ccc;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.75rem;
  }

  .priority-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .priority-badge.urgent {
    background: rgba(255, 82, 82, 0.2);
    color: #ff5252;
  }

  .priority-badge.high {
    background: rgba(255, 107, 53, 0.2);
    color: #ff6b35;
  }

  .priority-badge.medium {
    background: rgba(247, 147, 30, 0.2);
    color: #f7931e;
  }

  .priority-badge.low {
    background: rgba(78, 205, 196, 0.2);
    color: #4ecdc4;
  }

  .report-time {
    color: #666;
    font-size: 0.8rem;
  }

  .report-target {
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.5rem;
  }

  .report-description {
    color: #aaa;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 0.75rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .report-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .report-reporter {
    color: #666;
    font-size: 0.8rem;
  }

  .report-actions {
    display: flex;
    gap: 0.5rem;
  }

  .report-actions button {
    padding: 0.4rem 0.75rem;
    border-radius: 5px;
    font-size: 0.8rem;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-view {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
  }

  .btn-view:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .btn-resolve {
    background: rgba(78, 205, 196, 0.2);
    color: #4ecdc4;
  }

  .btn-resolve:hover {
    background: rgba(78, 205, 196, 0.3);
  }

  .btn-dismiss {
    background: rgba(255, 82, 82, 0.15);
    color: #ff5252;
  }

  .btn-dismiss:hover {
    background: rgba(255, 82, 82, 0.25);
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(255, 107, 53, 0.3);
    border-radius: 12px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .modal-header h3 {
    margin: 0;
    color: #fff;
  }

  .modal-close {
    background: none;
    border: none;
    color: #888;
    font-size: 1.5rem;
    cursor: pointer;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    display: flex;
    gap: 1rem;
    padding: 1rem 1.5rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .detail-row {
    margin-bottom: 1rem;
  }

  .detail-label {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }

  .detail-value {
    color: #fff;
  }

  .detail-value a {
    color: #4ecdc4;
  }

  .admin-notes-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    padding: 0.75rem;
    color: #fff;
    min-height: 80px;
    resize: vertical;
  }

  .modal-footer button {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .status-resolved {
    opacity: 0.6;
  }
</style>

<script>
  const CATEGORIES = {
    inappropriate_content: 'Inappropriate Content',
    harassment: 'Harassment',
    spam: 'Spam',
    copyright: 'Copyright',
    hate_speech: 'Hate Speech',
    impersonation: 'Impersonation',
    other: 'Other'
  };

  const TYPES = {
    stream: 'Stream',
    artist: 'Artist',
    dj: 'DJ',
    user: 'User',
    release: 'Release',
    mix: 'Mix',
    comment: 'Comment',
    chat: 'Chat',
    other: 'Other'
  };

  let reports = [];
  let currentReportId = null;

  async function loadReports() {
    const status = document.getElementById('filter-status').value;
    const type = document.getElementById('filter-type').value;
    const listEl = document.getElementById('reports-list');
    
    listEl.innerHTML = '<div class="loading">Loading reports...</div>';

    try {
      const params = new URLSearchParams({ status });
      if (type) params.append('type', type);
      
      const res = await fetch(`/api/reports?${params}`);
      const data = await res.json();

      if (data.success) {
        reports = data.reports;
        document.querySelector('#pending-count .count').textContent = data.counts.pending;
        document.querySelector('#reviewing-count .count').textContent = data.counts.reviewing;
        renderReports();
      } else {
        listEl.innerHTML = `<div class="empty-state">Error: ${data.error}</div>`;
      }
    } catch (error) {
      console.error('Error loading reports:', error);
      listEl.innerHTML = '<div class="empty-state">Failed to load reports</div>';
    }
  }

  function renderReports() {
    const listEl = document.getElementById('reports-list');

    if (reports.length === 0) {
      listEl.innerHTML = '<div class="empty-state">No reports found</div>';
      return;
    }

    listEl.innerHTML = reports.map(r => `
      <div class="report-card priority-${r.priority} ${r.status === 'resolved' || r.status === 'dismissed' ? 'status-resolved' : ''}">
        <div class="report-header">
          <div class="report-meta">
            <span class="report-type">${TYPES[r.type] || r.type}</span>
            <span class="report-category">${CATEGORIES[r.category] || r.category}</span>
            <span class="priority-badge ${r.priority}">${r.priority}</span>
          </div>
          <span class="report-time">${formatTime(r.createdAt)}</span>
        </div>
        <div class="report-target">${escapeHtml(r.targetName)}</div>
        <div class="report-description">${escapeHtml(r.description)}</div>
        <div class="report-footer">
          <span class="report-reporter">Reported by: ${escapeHtml(r.reporterName)}</span>
          <div class="report-actions">
            <button class="btn-view" onclick="viewReport('${r.id}')">View</button>
            ${r.status === 'pending' || r.status === 'reviewing' ? `
              <button class="btn-resolve" onclick="updateStatus('${r.id}', 'resolved')">Resolve</button>
              <button class="btn-dismiss" onclick="updateStatus('${r.id}', 'dismissed')">Dismiss</button>
            ` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  function viewReport(id) {
    const report = reports.find(r => r.id === id);
    if (!report) return;

    currentReportId = id;
    const modal = document.getElementById('report-detail-modal');
    const body = document.getElementById('report-detail-body');
    const footer = document.getElementById('report-detail-footer');

    body.innerHTML = `
      <div class="detail-row">
        <div class="detail-label">Type / Category</div>
        <div class="detail-value">${TYPES[report.type] || report.type} â†’ ${CATEGORIES[report.category] || report.category}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Priority</div>
        <div class="detail-value"><span class="priority-badge ${report.priority}">${report.priority}</span></div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Target</div>
        <div class="detail-value">${escapeHtml(report.targetName)}${report.targetUrl ? ` <a href="${report.targetUrl}" target="_blank">View â†’</a>` : ''}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Description</div>
        <div class="detail-value">${escapeHtml(report.description)}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Reported By</div>
        <div class="detail-value">${escapeHtml(report.reporterName)}${report.reporterEmail ? ` (${report.reporterEmail})` : ''}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Reported At</div>
        <div class="detail-value">${formatTime(report.createdAt, true)}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Status</div>
        <div class="detail-value">${report.status}${report.resolvedAt ? ` (${formatTime(report.resolvedAt)})` : ''}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Admin Notes</div>
        <textarea class="admin-notes-input" id="admin-notes" placeholder="Add notes...">${report.adminNotes || ''}</textarea>
      </div>
    `;

    footer.innerHTML = `
      <button style="background: rgba(255,255,255,0.1); color: #fff;" onclick="closeDetailModal()">Close</button>
      <button style="background: rgba(255,255,255,0.15); color: #4ecdc4;" onclick="saveNotes()">Save Notes</button>
      ${report.status === 'pending' ? `<button style="background: rgba(78,205,196,0.2); color: #4ecdc4;" onclick="updateStatus('${id}', 'reviewing'); closeDetailModal();">Mark Reviewing</button>` : ''}
      ${report.status !== 'resolved' ? `<button style="background: rgba(78,205,196,0.3); color: #fff;" onclick="updateStatus('${id}', 'resolved'); closeDetailModal();">Resolve</button>` : ''}
      ${report.status !== 'dismissed' ? `<button style="background: rgba(255,82,82,0.2); color: #ff5252;" onclick="updateStatus('${id}', 'dismissed'); closeDetailModal();">Dismiss</button>` : ''}
    `;

    modal.classList.add('active');
  }

  function closeDetailModal() {
    document.getElementById('report-detail-modal').classList.remove('active');
    currentReportId = null;
  }

  async function saveNotes() {
    if (!currentReportId) return;
    const notes = document.getElementById('admin-notes').value;

    try {
      await fetch('/api/reports', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reportId: currentReportId, adminNotes: notes })
      });
      
      const report = reports.find(r => r.id === currentReportId);
      if (report) report.adminNotes = notes;
      
      alert('Notes saved');
    } catch (error) {
      alert('Failed to save notes');
    }
  }

  async function updateStatus(id, status) {
    try {
      const res = await fetch('/api/reports', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reportId: id, status })
      });

      if ((await res.json()).success) {
        loadReports();
      }
    } catch (error) {
      alert('Failed to update status');
    }
  }

  function formatTime(dateStr, full = false) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    if (full) {
      return d.toLocaleString();
    }
    const now = new Date();
    const diff = now - d;
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
    return d.toLocaleDateString();
  }

  function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // Event listeners
  document.getElementById('filter-status').addEventListener('change', loadReports);
  document.getElementById('filter-type').addEventListener('change', loadReports);

  // Close modal on overlay click
  document.getElementById('report-detail-modal').addEventListener('click', (e) => {
    if (e.target.id === 'report-detail-modal') closeDetailModal();
  });

  // Initial load
  loadReports();
</script>
