---
// src/pages/admin/blog/index.astro
// Blog management page for admin

import AdminLayout from '../../../layouts/AdminLayout.astro';

export const prerender = false;
---

<AdminLayout title="Blog Management">
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h1>Blog Posts</h1>
        <p class="text-gray-400">Create and manage blog content</p>
      </div>
      <a href="/admin/blog/edit" class="btn btn-primary">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Post
      </a>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
      <div class="card-body">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex gap-2">
            <button class="filter-btn active" data-status="all">All</button>
            <button class="filter-btn" data-status="published">Published</button>
            <button class="filter-btn" data-status="draft">Drafts</button>
          </div>
          <div class="flex-1"></div>
          <div class="text-sm text-gray-400">
            <span id="post-count">0</span> posts
          </div>
        </div>
      </div>
    </div>

    <!-- Posts List -->
    <div class="card">
      <div class="card-body p-0">
        <div id="posts-loading" class="p-8 text-center text-gray-400">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-500 mb-4"></div>
          <p>Loading posts...</p>
        </div>

        <div id="posts-empty" class="hidden p-8 text-center">
          <svg class="w-16 h-16 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
          </svg>
          <h3 class="text-lg font-bold text-white mb-2">No blog posts yet</h3>
          <p class="text-gray-400 mb-4">Create your first blog post to get started</p>
          <a href="/admin/blog/edit" class="btn btn-primary">Create First Post</a>
        </div>

        <table id="posts-table" class="hidden w-full">
          <thead>
            <tr class="border-b border-white/10">
              <th class="text-left p-4 font-bold text-gray-400 uppercase text-xs">Post</th>
              <th class="text-left p-4 font-bold text-gray-400 uppercase text-xs hidden md:table-cell">Category</th>
              <th class="text-left p-4 font-bold text-gray-400 uppercase text-xs hidden lg:table-cell">Views</th>
              <th class="text-left p-4 font-bold text-gray-400 uppercase text-xs">Status</th>
              <th class="text-left p-4 font-bold text-gray-400 uppercase text-xs hidden sm:table-cell">Date</th>
              <th class="text-right p-4 font-bold text-gray-400 uppercase text-xs">Actions</th>
            </tr>
          </thead>
          <tbody id="posts-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/80" id="delete-modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="bg-gray-900 border border-white/10 rounded-xl max-w-md w-full p-6">
        <h3 class="text-lg font-bold text-white mb-2">Delete Post</h3>
        <p class="text-gray-400 mb-6">Are you sure you want to delete "<span id="delete-post-title" class="text-white"></span>"? This action cannot be undone.</p>
        <div class="flex gap-3 justify-end">
          <button id="delete-cancel" class="btn btn-ghost">Cancel</button>
          <button id="delete-confirm" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .filter-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #9ca3af;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-btn:hover {
    color: white;
    border-color: rgba(255,255,255,0.2);
  }

  .filter-btn.active {
    color: white;
    background: #dc2626;
    border-color: #dc2626;
  }

  .btn-danger {
    background: #dc2626;
    color: white;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
    text-transform: uppercase;
  }

  .status-published {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .status-draft {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
    border: 1px solid rgba(234, 179, 8, 0.3);
  }

  tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background 0.2s;
  }

  tbody tr:hover {
    background: rgba(255,255,255,0.02);
  }

  .action-btn {
    padding: 0.5rem;
    color: #9ca3af;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }

  .action-btn:hover {
    color: white;
    background: rgba(255,255,255,0.1);
  }

  .action-btn.delete:hover {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }
</style>

<script>
  let currentFilter = 'all';
  let allPosts: any[] = [];
  let deletePostId: string | null = null;

  async function loadPosts() {
    const loading = document.getElementById('posts-loading');
    const empty = document.getElementById('posts-empty');
    const table = document.getElementById('posts-table');
    const tbody = document.getElementById('posts-tbody');
    const countEl = document.getElementById('post-count');

    try {
      const response = await fetch('/api/admin/blog');
      const data = await response.json();

      if (!data.success) throw new Error(data.error);

      allPosts = data.posts || [];
      loading?.classList.add('hidden');

      filterAndRenderPosts();
    } catch (error) {
      console.error('Failed to load posts:', error);
      if (loading) loading.innerHTML = '<p class="text-red-400">Failed to load posts</p>';
    }
  }

  function filterAndRenderPosts() {
    const empty = document.getElementById('posts-empty');
    const table = document.getElementById('posts-table');
    const tbody = document.getElementById('posts-tbody');
    const countEl = document.getElementById('post-count');

    let filtered = allPosts;
    if (currentFilter !== 'all') {
      filtered = allPosts.filter(p => p.status === currentFilter);
    }

    if (countEl) countEl.textContent = String(filtered.length);

    if (filtered.length === 0) {
      empty?.classList.remove('hidden');
      table?.classList.add('hidden');
      return;
    }

    empty?.classList.add('hidden');
    table?.classList.remove('hidden');

    if (tbody) {
      tbody.innerHTML = filtered.map(post => {
        const date = post.publishedAt || post.createdAt;
        const formattedDate = date ? new Date(date).toLocaleDateString('en-GB', {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        }) : '-';

        return `
          <tr data-id="${post.id}">
            <td class="p-4">
              <div class="flex items-center gap-3">
                ${post.featuredImage ? `
                  <img src="${post.featuredImage}" alt="" class="w-12 h-12 rounded-lg object-cover hidden sm:block" />
                ` : `
                  <div class="w-12 h-12 rounded-lg bg-white/5 hidden sm:flex items-center justify-center">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                `}
                <div class="min-w-0">
                  <a href="/admin/blog/edit/${post.id}" class="font-bold text-white hover:text-red-400 transition-colors block truncate">${post.title}</a>
                  <p class="text-sm text-gray-500 truncate">${post.excerpt || 'No excerpt'}</p>
                </div>
              </div>
            </td>
            <td class="p-4 hidden md:table-cell">
              <span class="text-sm text-gray-400">${post.category || 'General'}</span>
            </td>
            <td class="p-4 hidden lg:table-cell">
              <span class="text-sm text-gray-400">${post.views || 0}</span>
            </td>
            <td class="p-4">
              <span class="status-badge status-${post.status}">${post.status}</span>
            </td>
            <td class="p-4 hidden sm:table-cell">
              <span class="text-sm text-gray-400">${formattedDate}</span>
            </td>
            <td class="p-4 text-right">
              <div class="flex gap-1 justify-end">
                <a href="/blog/${post.slug}" target="_blank" class="action-btn" title="View">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </a>
                <a href="/admin/blog/edit/${post.id}" class="action-btn" title="Edit">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </a>
                <button class="action-btn delete" title="Delete" onclick="showDeleteModal('${post.id}', '${post.title.replace(/'/g, "\\'")}')">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentFilter = this.dataset.status || 'all';
      filterAndRenderPosts();
    });
  });

  // Delete modal
  function showDeleteModal(id: string, title: string) {
    deletePostId = id;
    const modal = document.getElementById('delete-modal');
    const titleEl = document.getElementById('delete-post-title');
    if (titleEl) titleEl.textContent = title;
    modal?.classList.remove('hidden');
  }

  // Make it globally available
  (window as any).showDeleteModal = showDeleteModal;

  document.getElementById('delete-cancel')?.addEventListener('click', () => {
    document.getElementById('delete-modal')?.classList.add('hidden');
    deletePostId = null;
  });

  document.getElementById('delete-modal-backdrop')?.addEventListener('click', () => {
    document.getElementById('delete-modal')?.classList.add('hidden');
    deletePostId = null;
  });

  document.getElementById('delete-confirm')?.addEventListener('click', async () => {
    if (!deletePostId) return;

    const btn = document.getElementById('delete-confirm') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
      const response = await fetch(`/api/admin/blog?id=${deletePostId}`, {
        method: 'DELETE'
      });
      const data = await response.json();

      if (!data.success) throw new Error(data.error);

      // Remove from local array
      allPosts = allPosts.filter(p => p.id !== deletePostId);
      filterAndRenderPosts();

      document.getElementById('delete-modal')?.classList.add('hidden');
    } catch (error) {
      console.error('Delete failed:', error);
      alert('Failed to delete post');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Delete';
      deletePostId = null;
    }
  });

  // Load posts on page load
  loadPosts();
</script>
