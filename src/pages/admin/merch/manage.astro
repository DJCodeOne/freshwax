---
// src/pages/admin/merch/manage.astro
// Fresh Wax Merch Management - Unified Admin Design

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { queryCollection } from '../../../lib/firebase-rest';

// Get admin key from Cloudflare runtime env (production) or import.meta.env (dev)
const runtimeEnv = (Astro.locals as any)?.runtime?.env;
const adminKey = runtimeEnv?.ADMIN_KEY || import.meta.env.ADMIN_KEY || '';

let products = [];
let errorMessage = '';

try {
  const items = await queryCollection('merch', { limit: 100 });
  
  products = (items || []).map(item => ({
    id: item.id,
    name: item.name || item.title || 'Untitled Item',
    description: item.description || '',
    price: item.price || item.retailPrice || 0,
    salePrice: item.salePrice || null,
    onSale: item.onSale || false,
    costPrice: item.costPrice || null,
    currency: item.currency || 'GBP',
    images: item.images || (item.imageUrl ? [item.imageUrl] : []),
    primaryImage: item.images?.[0]?.url || item.primaryImage || item.images?.[0] || item.imageUrl || null,
    category: item.category || item.categoryName || 'general',
    productType: item.productType || item.productTypeName || 'other',
    inStock: (item.totalStock ?? item.stock ?? 0) > 0,
    stock: item.totalStock ?? item.stock ?? 0,
    sku: item.sku || item.id,
    supplier: item.supplierName || item.supplier || 'Fresh Wax',
    supplierCut: item.supplierCut || null,
    featured: item.featured || false,
    published: item.published ?? item.status === 'published' ?? true,
    isLowStock: item.isLowStock || false,
    isOutOfStock: item.isOutOfStock || false,
    ...item
  }));
  
  // Sort by name
  products.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  
} catch (error) {
  console.error('[MERCH MANAGE] Error loading products:', error);
  errorMessage = error instanceof Error ? error.message : 'Unknown error';
}

// Stats
const totalProducts = products.length;
const inStockProducts = products.filter(p => p.stock > 0).length; // All items with stock > 0
const lowStockProducts = products.filter(p => p.stock > 0 && p.stock <= 5).length;
const outOfStockProducts = products.filter(p => p.stock === 0).length;
const featuredProducts = products.filter(p => p.featured).length;
const onSaleProducts = products.filter(p => p.onSale).length;

const stats = [
  { label: 'Total', value: totalProducts },
  { label: 'In Stock', value: inStockProducts, type: 'success' },
  { label: 'Low Stock', value: lowStockProducts, type: lowStockProducts > 0 ? 'warning' : 'default' },
  { label: 'Out of Stock', value: outOfStockProducts, type: outOfStockProducts > 0 ? 'danger' : 'default' },
  { label: 'Featured', value: featuredProducts },
  { label: 'On Sale', value: onSaleProducts, type: onSaleProducts > 0 ? 'info' : 'default' },
];

// Format currency
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

// Get stock badge class
const getStockClass = (stock) => {
  if (stock === 0) return 'danger';
  if (stock <= 5) return 'warning';
  return 'success';
};

// Get stock status text
const getStockStatus = (stock) => {
  if (stock === 0) return 'Out of Stock';
  if (stock <= 5) return 'Low Stock';
  return 'In Stock';
};

// Get stock data attribute
const getStockDataAttr = (stock) => {
  if (stock === 0) return 'out';
  if (stock <= 5) return 'low';
  return 'instock';
};

// Category/type labels
const categoryLabels = {
  'clothing': 'Clothing',
  'accessories': 'Accessories',
  'vinyl': 'Vinyl',
  'prints': 'Prints',
  'general': 'General',
};

const typeLabels = {
  'tshirt': 'T-Shirt',
  't-shirt': 'T-Shirt',
  'hoodie': 'Hoodie',
  'cap': 'Cap',
  'hat': 'Hat',
  'poster': 'Poster',
  'sticker': 'Sticker',
  'other': 'Other',
};

export const prerender = false;
---

<AdminLayout title="Merch" activeNav="merch" showStats={true} stats={stats}>
  <Fragment slot="actions">
    <a href="/admin/merch/upload" class="btn btn-primary">+ Add Product</a>
    <a href="/admin/merch/suppliers" class="btn btn-secondary">Suppliers</a>
    <a href="/merch" class="btn btn-ghost" target="_blank">View Store</a>
  </Fragment>

  <!-- Filters -->
  <div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-body" style="padding: 1rem 1.5rem;">
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <div class="filter-tabs" id="statusFilters">
          <button class="filter-tab active" data-filter="all">All</button>
          <button class="filter-tab" data-filter="instock">In Stock</button>
          <button class="filter-tab" data-filter="low">Low Stock</button>
          <button class="filter-tab" data-filter="out">Out of Stock</button>
        </div>
        <div style="margin-left: auto; display: flex; gap: 1rem; align-items: center;">
          <select id="filterCategory" class="form-select" style="min-width: 150px;">
            <option value="">All Categories</option>
            <option value="clothing">Clothing</option>
            <option value="accessories">Accessories</option>
            <option value="vinyl">Vinyl</option>
            <option value="prints">Prints</option>
          </select>
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search products..." class="form-input" style="min-width: 200px;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div class="card">
    <div class="card-header">
      <h2>All Products</h2>
      <span class="text-muted">{products.length} products</span>
    </div>
    <div class="table-wrapper">
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th style="width: 35%;">Product</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Supplier</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {products.length === 0 ? (
            <tr>
              <td colspan="5" class="text-center text-muted" style="padding: 3rem;">
                {errorMessage ? `Error: ${errorMessage}` : 'No products found. Add your first product!'}
              </td>
            </tr>
          ) : (
            products.map(product => (
              <tr 
                data-stock={getStockDataAttr(product.stock)}
                data-category={product.category}
                data-search={`${product.name} ${product.sku}`.toLowerCase()}
              >
                <td>
                  <div class="item-cell">
                    {product.primaryImage ? (
                      <img src={product.primaryImage} alt="" loading="lazy" style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #000;">
                    ) : (
                      <div style="width: 48px; height: 48px; background: #e5e5e5; display: flex; align-items: center; justify-content: center; border: 2px solid #000;">üëï</div>
                    )}
                    <div class="item-info">
                      <h4>{product.name}</h4>
                      <p class="cell-mono">{product.sku}</p>
                      <p class="cell-secondary">{categoryLabels[product.category] || product.category} ‚Ä¢ {typeLabels[product.productType] || product.productType}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="font-bold">
                    {product.onSale && (
                      <span style="color: #dc2626;">{formatCurrency(product.salePrice)}</span>
                    )}
                    {product.onSale && (
                      <div class="cell-secondary" style="text-decoration: line-through;">{formatCurrency(product.price)}</div>
                    )}
                    {!product.onSale && formatCurrency(product.price)}
                    {product.costPrice && (
                      <div class="cell-secondary">Cost: {formatCurrency(product.costPrice)}</div>
                    )}
                  </div>
                </td>
                <td>
                  <span class={`badge badge-${getStockClass(product.stock)}`}>
                    {product.stock} units
                  </span>
                  <div class="cell-secondary" style="margin-top: 0.25rem;">
                    {getStockStatus(product.stock)}
                  </div>
                </td>
                <td class="cell-primary">
                  {product.supplier || 'Fresh Wax'}
                  {product.supplierCut && (
                    <div class="cell-secondary">{product.supplierCut}% cut</div>
                  )}
                </td>
                <td class="text-right">
                  <div class="flex gap-1 justify-end">
                    <a 
                      href={`/merch/${product.id}`}
                      target="_blank"
                      class="btn btn-ghost btn-sm"
                      title="View on Store"
                    >
                      üëÅÔ∏è
                    </a>
                    <a 
                      href={`/admin/merch/edit/${product.id}`}
                      class="btn btn-secondary btn-sm"
                      title="Edit"
                    >
                      ‚úèÔ∏è
                    </a>
                    <button 
                      class="btn btn-danger btn-sm"
                      title="Delete"
                      onclick={`deleteProduct('${product.id}')`}
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>

<style is:global>
  .item-cell {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .item-cell img {
    flex-shrink: 0;
  }
  
  .item-info h4 {
    font-size: 0.9rem;
    font-weight: 700;
    margin-bottom: 0.2rem;
  }
  
  .item-info p {
    margin: 0;
    font-size: 0.75rem;
  }
  
  .cell-mono {
    font-family: monospace;
    color: #666;
  }
  
  .cell-secondary {
    color: #888;
    font-size: 0.75rem;
  }
  
  .cell-primary {
    font-weight: 600;
  }
</style>

<script define:vars={{ adminKey }}>
  const ADMIN_KEY = adminKey;

  // Filter functionality
  document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('productsTable');
    const rows = table?.querySelectorAll('tbody tr');
    const statusButtons = document.querySelectorAll('[data-filter]');
    const categorySelect = document.getElementById('filterCategory');
    const searchInput = document.getElementById('searchInput');
    
    let activeStatus = 'all';
    let activeCategory = '';
    let searchTerm = '';
    
    function filterRows() {
      rows?.forEach(row => {
        const rowStock = row.getAttribute('data-stock');
        const rowCategory = row.getAttribute('data-category');
        const rowSearch = row.getAttribute('data-search') || '';
        
        let show = true;
        
        // Status filter
        if (activeStatus === 'instock') {
          // In Stock should show both 'instock' and 'low' (anything with stock > 0)
          if (rowStock !== 'instock' && rowStock !== 'low') {
            show = false;
          }
        } else if (activeStatus === 'low') {
          // Low Stock only shows low stock items
          if (rowStock !== 'low') {
            show = false;
          }
        } else if (activeStatus === 'out') {
          // Out of Stock only shows out of stock items
          if (rowStock !== 'out') {
            show = false;
          }
        }
        // 'all' shows everything
        
        // Category filter
        if (activeCategory && rowCategory !== activeCategory) {
          show = false;
        }
        
        // Search filter
        if (searchTerm && !rowSearch.includes(searchTerm.toLowerCase())) {
          show = false;
        }
        
        (row as HTMLElement).style.display = show ? '' : 'none';
      });
    }
    
    // Status filter buttons
    statusButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        statusButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeStatus = btn.getAttribute('data-filter') || 'all';
        filterRows();
      });
    });
    
    // Category filter
    categorySelect?.addEventListener('change', (e) => {
      activeCategory = (e.target as HTMLSelectElement).value;
      filterRows();
    });
    
    // Search filter
    searchInput?.addEventListener('input', (e) => {
      searchTerm = (e.target as HTMLInputElement).value;
      filterRows();
    });
  });
  
  // Delete function
  function deleteProduct(id: string) {
    if (!confirm('Are you sure you want to delete this product?')) return;

    fetch('/api/delete-merch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Admin-Key': ADMIN_KEY },
      body: JSON.stringify({ productId: id })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert('Error: ' + (data.error || 'Failed to delete'));
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
  }
  
  // Make delete function global
  (window as any).deleteProduct = deleteProduct;
</script>
