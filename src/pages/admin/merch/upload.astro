---
// src/pages/admin/merch/upload.astro
// Comprehensive merch upload tool with variant-level stock tracking
---

<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Merch - Fresh Wax Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #000; }
    
    .header { background: #000; color: #fff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 20px; font-weight: 900; text-transform: uppercase; }
    .header-nav { display: flex; gap: 15px; }
    .header-nav a { color: #fff; text-decoration: none; padding: 8px 16px; border: 2px solid #fff; font-weight: 700; font-size: 12px; text-transform: uppercase; }
    .header-nav a:hover { background: #fff; color: #000; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
    
    .form-layout { display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
    
    .form-card { background: #fff; border: 3px solid #000; padding: 25px; margin-bottom: 20px; }
    .form-card h2 { font-size: 16px; font-weight: 900; text-transform: uppercase; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #000; }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; }
    .form-label .required { color: #ff0000; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #000; font-size: 14px; font-family: inherit; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; box-shadow: 4px 4px 0 #000; }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-hint { font-size: 11px; color: #666; margin-top: 5px; }
    
    /* Product Type Grid */
    .type-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .type-option { position: relative; }
    .type-option input { position: absolute; opacity: 0; }
    .type-option label { display: block; padding: 15px 10px; border: 2px solid #000; text-align: center; cursor: pointer; font-weight: 700; font-size: 12px; text-transform: uppercase; transition: all 0.2s; }
    .type-option input:checked + label { background: #000; color: #fff; }
    .type-option label:hover { background: #f0f0f0; }
    
    /* Image Upload */
    .image-upload-area { border: 3px dashed #000; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .image-upload-area:hover { background: #f0f0f0; }
    .image-upload-area.dragover { background: #e0e0e0; border-style: solid; }
    .image-preview-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 20px; }
    .image-preview-item { position: relative; border: 2px solid #000; aspect-ratio: 1; }
    .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .image-preview-item .badge { position: absolute; top: 5px; left: 5px; background: #000; color: #fff; padding: 2px 8px; font-size: 10px; font-weight: 900; }
    .image-preview-item .remove-btn { position: absolute; top: 5px; right: 5px; background: #ff0000; color: #fff; border: none; width: 24px; height: 24px; cursor: pointer; font-weight: 900; font-size: 16px; }
    
    /* Colors */
    .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .color-option { display: flex; align-items: center; gap: 8px; padding: 10px; border: 2px solid #ccc; cursor: pointer; }
    .color-option:hover { border-color: #000; }
    .color-option.selected { border-color: #000; background: #f5f5f5; }
    .color-option input { display: none; }
    .color-swatch { width: 24px; height: 24px; border: 2px solid #000; flex-shrink: 0; }
    .color-option span { font-size: 12px; font-weight: 600; }
    
    .custom-color-row { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
    .custom-color-row input[type="color"] { width: 50px; height: 40px; border: 2px solid #000; cursor: pointer; padding: 0; }
    
    /* Sizes */
    .size-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .size-option { position: relative; }
    .size-option input { position: absolute; opacity: 0; }
    .size-option label { display: block; padding: 12px; border: 2px solid #ccc; text-align: center; cursor: pointer; font-weight: 700; font-size: 14px; }
    .size-option input:checked + label { background: #000; color: #fff; border-color: #000; }
    .size-option label:hover { border-color: #000; }
    
    /* Variant Stock Table */
    .variant-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .variant-table th, .variant-table td { padding: 10px; border: 2px solid #000; text-align: left; }
    .variant-table th { background: #000; color: #fff; font-size: 12px; text-transform: uppercase; }
    .variant-table input { width: 80px; padding: 8px; border: 2px solid #000; text-align: center; font-weight: 700; }
    .variant-sku { font-family: monospace; font-size: 11px; color: #666; }
    
    /* Supplier Section */
    .supplier-toggle { display: flex; gap: 20px; margin-bottom: 20px; }
    .supplier-toggle label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 700; }
    .supplier-toggle input[type="radio"] { width: 20px; height: 20px; }
    .supplier-fields { display: none; }
    .supplier-fields.active { display: block; }
    
    /* Preview Panel */
    .preview-panel { position: sticky; top: 80px; }
    .preview-card { background: #fff; border: 3px solid #000; }
    .preview-image { width: 100%; aspect-ratio: 1; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999; border-bottom: 3px solid #000; overflow: hidden; }
    .preview-image img { width: 100%; height: 100%; object-fit: cover; }
    .preview-details { padding: 20px; }
    .preview-details h3 { font-size: 18px; font-weight: 900; margin-bottom: 5px; }
    .preview-details .category { font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 10px; }
    .preview-details .price { font-size: 28px; font-weight: 900; margin-bottom: 15px; }
    .preview-details .price .original { text-decoration: line-through; color: #999; font-size: 18px; margin-left: 10px; }
    .preview-colors { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .preview-color { width: 30px; height: 30px; border: 2px solid #000; }
    .preview-sizes { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .preview-size { padding: 8px 12px; border: 2px solid #000; font-weight: 700; font-size: 12px; }
    .preview-stock { font-size: 14px; font-weight: 700; padding: 8px 12px; display: inline-block; }
    .preview-stock.in-stock { background: #00aa00; color: #fff; }
    .preview-stock.low-stock { background: #ff9900; color: #fff; }
    .preview-stock.out-of-stock { background: #ff0000; color: #fff; }
    
    /* Buttons */
    .btn { padding: 15px 30px; border: 3px solid #000; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #000; color: #fff; }
    .btn-primary:hover { background: #fff; color: #000; }
    .btn-primary:disabled { background: #ccc; border-color: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #fff; color: #000; }
    .btn-secondary:hover { background: #000; color: #fff; }
    
    .submit-row { display: flex; gap: 15px; margin-top: 20px; }
    .submit-row .btn { flex: 1; }
    
    /* Toast */
    .toast { position: fixed; bottom: 30px; right: 30px; padding: 20px 30px; background: #000; color: #fff; border: 3px solid #000; font-weight: 700; box-shadow: 8px 8px 0 rgba(0,0,0,0.2); z-index: 9999; transform: translateY(200px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: #00aa00; }
    .toast.error { border-color: #ff0000; }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .form-layout { grid-template-columns: 1fr; }
      .preview-panel { position: static; }
      .type-grid { grid-template-columns: repeat(3, 1fr); }
    }
    
    @media (max-width: 768px) {
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .type-grid { grid-template-columns: repeat(2, 1fr); }
      .color-grid { grid-template-columns: repeat(2, 1fr); }
      .size-grid { grid-template-columns: repeat(4, 1fr); }
      .image-preview-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>üì¶ Upload Merch</h1>
    <nav class="header-nav">
      <a href="/admin/merch/manage">Manage Stock</a>
      <a href="/admin/merch/suppliers">Suppliers</a>
      <a href="/admin">Admin Home</a>
    </nav>
  </header>

  <div class="container">
    <form id="upload-form" class="form-layout">
      <div class="form-main">
        <!-- Product Type -->
        <div class="form-card">
          <h2>Product Type</h2>
          <div class="type-grid">
            <div class="type-option">
              <input type="radio" name="productType" id="type-tshirt" value="tshirt" checked />
              <label for="type-tshirt">üëï T-Shirt</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-hoodie" value="hoodie" />
              <label for="type-hoodie">üß• Hoodie</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-cap" value="cap" />
              <label for="type-cap">üß¢ Cap</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-mug" value="mug" />
              <label for="type-mug">‚òï Mug</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-ashtray" value="ashtray" />
              <label for="type-ashtray">üö¨ Ashtray</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-grinder" value="grinder" />
              <label for="type-grinder">üåø Grinder</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-keyring" value="keyring" />
              <label for="type-keyring">üîë Keyring</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-sticker" value="sticker" />
              <label for="type-sticker">üè∑Ô∏è Sticker</label>
            </div>
            <div class="type-option">
              <input type="radio" name="productType" id="type-other" value="other" />
              <label for="type-other">üì¶ Other</label>
            </div>
          </div>
        </div>

        <!-- Basic Info -->
        <div class="form-card">
          <h2>Product Details</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Product Name <span class="required">*</span></label>
              <input type="text" class="form-input" id="productName" placeholder="Classic Logo Tee" required />
            </div>
            <div class="form-group">
              <label class="form-label">SKU / Stock Code</label>
              <input type="text" class="form-input" id="sku" placeholder="Auto-generated if empty" />
              <div class="form-hint">Leave blank to auto-generate</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Category <span class="required">*</span></label>
              <select class="form-select" id="category" required>
                <option value="freshwax">Fresh Wax</option>
                <option value="label">Label</option>
                <option value="soundsystem">Sound System</option>
                <option value="dj">DJ</option>
                <option value="crew">Crew</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Category Name <span class="required">*</span></label>
              <input type="text" class="form-input" id="categoryName" placeholder="e.g., Runnin' Records, Amen4Tekno" required />
              <div class="form-hint">The label/DJ/crew name</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="description" placeholder="Product description, materials, care instructions..."></textarea>
          </div>
        </div>

        <!-- Pricing -->
        <div class="form-card">
          <h2>Pricing</h2>
          <div class="form-row-3">
            <div class="form-group">
              <label class="form-label">Cost Price (¬£)</label>
              <input type="number" class="form-input" id="costPrice" step="0.01" min="0" placeholder="10.00" />
              <div class="form-hint">Your cost per unit</div>
            </div>
            <div class="form-group">
              <label class="form-label">Retail Price (¬£) <span class="required">*</span></label>
              <input type="number" class="form-input" id="retailPrice" step="0.01" min="0" placeholder="25.00" required />
            </div>
            <div class="form-group">
              <label class="form-label">Sale Price (¬£)</label>
              <input type="number" class="form-input" id="salePrice" step="0.01" min="0" placeholder="20.00" />
              <div class="form-hint">Leave empty if not on sale</div>
            </div>
          </div>
        </div>

        <!-- Images -->
        <div class="form-card">
          <h2>Product Images</h2>
          <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
          <div class="image-upload-area" id="imageDropZone">
            <p style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">üì∑ Drop images here or click to upload</p>
            <p style="color: #666; font-size: 14px;">First image will be the primary. Max 5 images.</p>
          </div>
          <div class="image-preview-grid" id="imagePreviewGrid"></div>
        </div>

        <!-- Colors -->
        <div class="form-card" id="colorsSection">
          <h2>Available Colors</h2>
          <div class="color-grid" id="colorGrid">
            <label class="color-option">
              <input type="checkbox" value="Black" data-hex="#000000" />
              <div class="color-swatch" style="background: #000000;"></div>
              <span>Black</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="White" data-hex="#FFFFFF" />
              <div class="color-swatch" style="background: #FFFFFF;"></div>
              <span>White</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Red" data-hex="#FF0000" />
              <div class="color-swatch" style="background: #FF0000;"></div>
              <span>Red</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Navy" data-hex="#000080" />
              <div class="color-swatch" style="background: #000080;"></div>
              <span>Navy</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Grey" data-hex="#808080" />
              <div class="color-swatch" style="background: #808080;"></div>
              <span>Grey</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Forest Green" data-hex="#228B22" />
              <div class="color-swatch" style="background: #228B22;"></div>
              <span>Forest Green</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Gold" data-hex="#FFD700" />
              <div class="color-swatch" style="background: #FFD700;"></div>
              <span>Gold</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Purple" data-hex="#800080" />
              <div class="color-swatch" style="background: #800080;"></div>
              <span>Purple</span>
            </label>
          </div>
          <div class="custom-color-row">
            <input type="color" id="customColorPicker" value="#000000" />
            <input type="text" class="form-input" id="customColorName" placeholder="Custom color name" style="flex: 1;" />
            <button type="button" class="btn btn-secondary" id="addCustomColorBtn">Add Color</button>
          </div>
        </div>

        <!-- Sizes (for clothing) -->
        <div class="form-card" id="sizesSection">
          <h2>Available Sizes</h2>
          <div class="size-grid">
            <div class="size-option">
              <input type="checkbox" id="size-xs" value="XS" />
              <label for="size-xs">XS</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-s" value="S" />
              <label for="size-s">S</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-m" value="M" checked />
              <label for="size-m">M</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-l" value="L" checked />
              <label for="size-l">L</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-xl" value="XL" checked />
              <label for="size-xl">XL</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-xxl" value="XXL" />
              <label for="size-xxl">XXL</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-3xl" value="3XL" />
              <label for="size-3xl">3XL</label>
            </div>
          </div>
        </div>

        <!-- Variant Stock -->
        <div class="form-card" id="variantStockSection">
          <h2>Stock by Variant</h2>
          <p style="color: #666; margin-bottom: 15px;">Enter stock quantities for each size/color combination</p>
          <div id="variantTableContainer">
            <p style="color: #999;">Select sizes and/or colors above to see variants</p>
          </div>
          <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Low Stock Alert Threshold</label>
            <input type="number" class="form-input" id="lowStockThreshold" value="5" min="1" style="max-width: 150px;" />
            <div class="form-hint">Alert when total stock falls to this level</div>
          </div>
        </div>

        <!-- Supplier / Consignment -->
        <div class="form-card">
          <h2>Supplier / Consignment</h2>
          <div class="supplier-toggle">
            <label>
              <input type="radio" name="supplierType" value="own" checked />
              Fresh Wax Stock
            </label>
            <label>
              <input type="radio" name="supplierType" value="consignment" />
              Consignment (External Supplier)
            </label>
          </div>
          
          <div class="supplier-fields" id="supplierFields">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Supplier</label>
                <select class="form-select" id="supplierId">
                  <option value="">Select supplier...</option>
                </select>
                <div class="form-hint">Or <a href="/admin/merch/suppliers" target="_blank">add new supplier</a></div>
              </div>
              <div class="form-group">
                <label class="form-label">Supplier Cut (%)</label>
                <input type="number" class="form-input" id="supplierCut" value="50" min="0" max="100" />
                <div class="form-hint">Percentage they receive per sale</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="submit-row">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/merch/manage'">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Upload Product</button>
        </div>
      </div>

      <!-- Preview Panel -->
      <div class="preview-panel">
        <div class="preview-card">
          <div class="preview-image" id="previewImage">
            <span>No image</span>
          </div>
          <div class="preview-details">
            <div class="category" id="previewCategory">Fresh Wax</div>
            <h3 id="previewName">Product Name</h3>
            <div class="price" id="previewPrice">¬£0.00</div>
            <div class="preview-colors" id="previewColors"></div>
            <div class="preview-sizes" id="previewSizes"></div>
            <div id="previewStock" class="preview-stock out-of-stock">0 in stock</div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // State
    let uploadedImages = [];
    let suppliers = [];
    
    // Product type configuration
    const productTypes = {
      'tshirt': { hasSizes: true, hasColors: true },
      'hoodie': { hasSizes: true, hasColors: true },
      'cap': { hasSizes: false, hasColors: true },
      'mug': { hasSizes: false, hasColors: true },
      'ashtray': { hasSizes: false, hasColors: true },
      'grinder': { hasSizes: false, hasColors: true },
      'keyring': { hasSizes: false, hasColors: true },
      'sticker': { hasSizes: false, hasColors: false },
      'other': { hasSizes: false, hasColors: true }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSuppliers();
      setupEventListeners();
      updateTypeVisibility();
      updatePreview();
    });

    function setupEventListeners() {
      // Product type change
      document.querySelectorAll('input[name="productType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          updateTypeVisibility();
          updateVariantTable();
          updatePreview();
        });
      });

      // Image upload
      const imageInput = document.getElementById('imageInput');
      const dropZone = document.getElementById('imageDropZone');
      
      dropZone.addEventListener('click', () => imageInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleImageFiles(e.dataTransfer.files);
      });
      imageInput.addEventListener('change', (e) => handleImageFiles(e.target.files));

      // Color selection
      document.querySelectorAll('#colorGrid input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', (e) => {
          e.target.closest('.color-option').classList.toggle('selected', e.target.checked);
          updateVariantTable();
          updatePreview();
        });
      });

      // Custom color
      document.getElementById('addCustomColorBtn').addEventListener('click', addCustomColor);

      // Size selection
      document.querySelectorAll('#sizesSection input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          updateVariantTable();
          updatePreview();
        });
      });

      // Supplier toggle
      document.querySelectorAll('input[name="supplierType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const isConsignment = document.querySelector('input[name="supplierType"]:checked').value === 'consignment';
          document.getElementById('supplierFields').classList.toggle('active', isConsignment);
        });
      });

      // Form inputs for preview
      ['productName', 'category', 'categoryName', 'retailPrice', 'salePrice', 'lowStockThreshold'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
      });

      // Form submit
      document.getElementById('upload-form').addEventListener('submit', handleSubmit);
    }

    function updateTypeVisibility() {
      const productType = document.querySelector('input[name="productType"]:checked').value;
      const config = productTypes[productType];
      
      document.getElementById('sizesSection').style.display = config.hasSizes ? 'block' : 'none';
      document.getElementById('colorsSection').style.display = config.hasColors ? 'block' : 'none';
      
      // If no sizes, uncheck all
      if (!config.hasSizes) {
        document.querySelectorAll('#sizesSection input').forEach(cb => cb.checked = false);
      }
    }

    function handleImageFiles(files) {
      Array.from(files).forEach(file => {
        if (uploadedImages.length >= 5) {
          showToast('Maximum 5 images allowed', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages.push({
            file: file,
            dataUrl: e.target.result
          });
          renderImagePreviews();
          updatePreview();
        };
        reader.readAsDataURL(file);
      });
    }

    function renderImagePreviews() {
      const grid = document.getElementById('imagePreviewGrid');
      grid.innerHTML = uploadedImages.map((img, idx) => `
        <div class="image-preview-item">
          <img src="${img.dataUrl}" alt="Product image ${idx + 1}" />
          ${idx === 0 ? '<div class="badge">PRIMARY</div>' : ''}
          <button type="button" class="remove-btn" onclick="removeImage(${idx})">√ó</button>
        </div>
      `).join('');
    }

    window.removeImage = function(idx) {
      uploadedImages.splice(idx, 1);
      renderImagePreviews();
      updatePreview();
    };

    function addCustomColor() {
      const hex = document.getElementById('customColorPicker').value;
      const name = document.getElementById('customColorName').value.trim();
      
      if (!name) {
        showToast('Please enter a color name', 'error');
        return;
      }
      
      const colorGrid = document.getElementById('colorGrid');
      const newOption = document.createElement('label');
      newOption.className = 'color-option selected';
      newOption.innerHTML = `
        <input type="checkbox" value="${name}" data-hex="${hex}" checked />
        <div class="color-swatch" style="background: ${hex};"></div>
        <span>${name}</span>
      `;
      
      newOption.querySelector('input').addEventListener('change', (e) => {
        e.target.closest('.color-option').classList.toggle('selected', e.target.checked);
        updateVariantTable();
        updatePreview();
      });
      
      colorGrid.appendChild(newOption);
      document.getElementById('customColorName').value = '';
      
      updateVariantTable();
      updatePreview();
    }

    function getSelectedColors() {
      return Array.from(document.querySelectorAll('#colorGrid input:checked')).map(cb => ({
        name: cb.value,
        hex: cb.dataset.hex
      }));
    }

    function getSelectedSizes() {
      return Array.from(document.querySelectorAll('#sizesSection input:checked')).map(cb => cb.value);
    }

    function updateVariantTable() {
      const container = document.getElementById('variantTableContainer');
      const productType = document.querySelector('input[name="productType"]:checked').value;
      const config = productTypes[productType];
      
      const sizes = config.hasSizes ? getSelectedSizes() : [];
      const colors = config.hasColors ? getSelectedColors() : [];
      
      // No variants needed
      if (sizes.length === 0 && colors.length === 0) {
        container.innerHTML = `
          <table class="variant-table">
            <thead>
              <tr>
                <th>Variant</th>
                <th>Stock</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Default<div class="variant-sku">Single variant</div></td>
                <td><input type="number" class="variant-stock-input" data-key="default" value="0" min="0" /></td>
              </tr>
            </tbody>
          </table>
        `;
        return;
      }
      
      let rows = '';
      
      if (sizes.length > 0 && colors.length > 0) {
        // Size √ó Color matrix
        sizes.forEach(size => {
          colors.forEach(color => {
            const key = `${size}_${color.name}`.toLowerCase().replace(/\s/g, '-');
            rows += `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; background: ${color.hex}; border: 2px solid #000;"></div>
                    <span><strong>${size}</strong> - ${color.name}</span>
                  </div>
                  <div class="variant-sku">${key}</div>
                </td>
                <td><input type="number" class="variant-stock-input" data-key="${key}" data-size="${size}" data-color="${color.name}" data-hex="${color.hex}" value="0" min="0" /></td>
              </tr>
            `;
          });
        });
      } else if (sizes.length > 0) {
        // Sizes only
        sizes.forEach(size => {
          const key = `${size}_default`.toLowerCase();
          rows += `
            <tr>
              <td><strong>${size}</strong><div class="variant-sku">${key}</div></td>
              <td><input type="number" class="variant-stock-input" data-key="${key}" data-size="${size}" value="0" min="0" /></td>
            </tr>
          `;
        });
      } else if (colors.length > 0) {
        // Colors only
        colors.forEach(color => {
          const key = `onesize_${color.name}`.toLowerCase().replace(/\s/g, '-');
          rows += `
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 20px; height: 20px; background: ${color.hex}; border: 2px solid #000;"></div>
                  <span>${color.name}</span>
                </div>
                <div class="variant-sku">${key}</div>
              </td>
              <td><input type="number" class="variant-stock-input" data-key="${key}" data-color="${color.name}" data-hex="${color.hex}" value="0" min="0" /></td>
            </tr>
          `;
        });
      }
      
      container.innerHTML = `
        <table class="variant-table">
          <thead>
            <tr>
              <th>Variant</th>
              <th>Stock Qty</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <button type="button" class="btn btn-secondary" style="margin-top: 15px;" onclick="setAllStock()">Set All to...</button>
      `;
      
      // Add listeners
      container.querySelectorAll('.variant-stock-input').forEach(input => {
        input.addEventListener('input', updatePreview);
      });
    }

    window.setAllStock = function() {
      const qty = prompt('Set all variants to quantity:', '10');
      if (qty !== null) {
        document.querySelectorAll('.variant-stock-input').forEach(input => {
          input.value = qty;
        });
        updatePreview();
      }
    };

    function getVariantsData() {
      const variants = [];
      document.querySelectorAll('.variant-stock-input').forEach(input => {
        variants.push({
          key: input.dataset.key,
          size: input.dataset.size || null,
          color: input.dataset.color || null,
          colorHex: input.dataset.hex || null,
          stock: parseInt(input.value) || 0
        });
      });
      return variants;
    }

    function getTotalStock() {
      return getVariantsData().reduce((sum, v) => sum + v.stock, 0);
    }

    function updatePreview() {
      // Image
      const imgContainer = document.getElementById('previewImage');
      if (uploadedImages.length > 0) {
        imgContainer.innerHTML = `<img src="${uploadedImages[0].dataUrl}" alt="Preview" />`;
      } else {
        imgContainer.innerHTML = '<span>No image</span>';
      }
      
      // Name
      document.getElementById('previewName').textContent = 
        document.getElementById('productName').value || 'Product Name';
      
      // Category
      document.getElementById('previewCategory').textContent = 
        document.getElementById('categoryName').value || 'Fresh Wax';
      
      // Price
      const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
      const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
      
      if (salePrice > 0 && salePrice < retailPrice) {
        document.getElementById('previewPrice').innerHTML = 
          `¬£${salePrice.toFixed(2)}<span class="original">¬£${retailPrice.toFixed(2)}</span>`;
      } else {
        document.getElementById('previewPrice').textContent = `¬£${retailPrice.toFixed(2)}`;
      }
      
      // Colors
      const colors = getSelectedColors();
      document.getElementById('previewColors').innerHTML = colors.map(c => 
        `<div class="preview-color" style="background: ${c.hex};" title="${c.name}"></div>`
      ).join('');
      
      // Sizes
      const productType = document.querySelector('input[name="productType"]:checked').value;
      const sizes = productTypes[productType].hasSizes ? getSelectedSizes() : [];
      document.getElementById('previewSizes').innerHTML = sizes.map(s => 
        `<div class="preview-size">${s}</div>`
      ).join('');
      
      // Stock
      const totalStock = getTotalStock();
      const threshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
      const stockEl = document.getElementById('previewStock');
      
      stockEl.textContent = `${totalStock} in stock`;
      stockEl.className = 'preview-stock';
      
      if (totalStock === 0) {
        stockEl.classList.add('out-of-stock');
      } else if (totalStock <= threshold) {
        stockEl.classList.add('low-stock');
      } else {
        stockEl.classList.add('in-stock');
      }
    }

    async function loadSuppliers() {
      try {
        const response = await fetch('/api/suppliers');
        const data = await response.json();
        
        if (data.success && data.suppliers) {
          suppliers = data.suppliers.filter(s => s.active !== false);
          
          const select = document.getElementById('supplierId');
          select.innerHTML = '<option value="">Select supplier...</option>' +
            suppliers.map(s => `<option value="${s.id}" data-code="${s.code}" data-cut="${s.defaultCut}">${s.name}</option>`).join('');
          
          select.addEventListener('change', () => {
            const selected = select.selectedOptions[0];
            if (selected && selected.dataset.cut) {
              document.getElementById('supplierCut').value = selected.dataset.cut;
            }
          });
        }
      } catch (e) {
        console.error('Failed to load suppliers:', e);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';
      
      try {
        // Validation
        if (uploadedImages.length === 0) {
          throw new Error('Please upload at least one product image');
        }
        
        const productName = document.getElementById('productName').value.trim();
        const retailPrice = parseFloat(document.getElementById('retailPrice').value);
        
        if (!productName) throw new Error('Product name is required');
        if (!retailPrice || retailPrice <= 0) throw new Error('Retail price must be greater than 0');
        
        // Build form data
        const formData = new FormData();
        
        // Images
        uploadedImages.forEach((img, idx) => {
          formData.append(`image_${idx}`, img.file);
        });
        formData.append('imageCount', uploadedImages.length.toString());
        
        // Basic info
        formData.append('productName', productName);
        formData.append('productType', document.querySelector('input[name="productType"]:checked').value);
        formData.append('sku', document.getElementById('sku').value.trim());
        formData.append('description', document.getElementById('description').value.trim());
        formData.append('category', document.getElementById('category').value);
        formData.append('categoryName', document.getElementById('categoryName').value.trim());
        
        // Pricing
        formData.append('costPrice', document.getElementById('costPrice').value || '0');
        formData.append('retailPrice', retailPrice.toString());
        formData.append('salePrice', document.getElementById('salePrice').value || '0');
        
        // Variants
        formData.append('sizes', JSON.stringify(getSelectedSizes()));
        formData.append('colors', JSON.stringify(getSelectedColors()));
        formData.append('variants', JSON.stringify(getVariantsData()));
        formData.append('lowStockThreshold', document.getElementById('lowStockThreshold').value);
        
        // Supplier
        const isConsignment = document.querySelector('input[name="supplierType"]:checked').value === 'consignment';
        if (isConsignment) {
          const supplierSelect = document.getElementById('supplierId');
          const selectedSupplier = supplierSelect.selectedOptions[0];
          
          if (supplierSelect.value) {
            formData.append('supplierId', supplierSelect.value);
            formData.append('supplierName', selectedSupplier.textContent);
            formData.append('supplierCode', selectedSupplier.dataset.code || 'EXT');
            formData.append('supplierCut', document.getElementById('supplierCut').value);
          }
        } else {
          formData.append('supplierCode', 'FW');
          formData.append('supplierName', 'Fresh Wax');
        }
        
        // Submit
        const response = await fetch('/api/upload-merch', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Upload failed');
        }
        
        showToast('Product uploaded successfully!', 'success');
        
        setTimeout(() => {
          window.location.href = '/admin/merch/manage';
        }, 1500);
        
      } catch (error) {
        console.error('Upload error:', error);
        showToast(error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Upload Product';
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>