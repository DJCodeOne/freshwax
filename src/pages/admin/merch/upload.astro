---
// src/pages/admin/merch/upload.astro
// Merch upload - log new products as they arrive
import '../../../styles/admin/merch/upload.css';
export const prerender = false;

// Get admin key from Cloudflare runtime env (production) or import.meta.env (dev)
const runtimeEnv = (Astro.locals as any)?.runtime?.env;
const adminKey = runtimeEnv?.ADMIN_KEY || import.meta.env.ADMIN_KEY || '';
---

<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Merch - Fresh Wax Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <header class="header">
    <h1>Fresh <span>Wax</span> Upload Merch</h1>
    <nav class="header-nav">
      <a href="/admin/inventory">Stock & Inventory</a>
      <a href="/admin/merch/suppliers">Suppliers</a>
      <a href="/admin">Dashboard</a>
    </nav>
  </header>

  <div class="container">
    <h1 class="page-title">Log New Product</h1>
    <p class="page-subtitle">Add products as they arrive. Images auto-convert to 800√ó800 WebP.</p>
    
    <form id="upload-form" class="form-layout">
      <div class="form-main">
        <!-- Product Type -->
        <div class="form-card">
          <div class="form-card-header">
            <h2>Product Type</h2>
          </div>
          <div class="form-card-body">
            <div class="type-grid">
              <div class="type-option">
                <input type="radio" name="productType" id="type-tshirt" value="tshirt" checked />
                <label for="type-tshirt"><span class="type-emoji">üëï</span>T-Shirt</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-hoodie" value="hoodie" />
                <label for="type-hoodie"><span class="type-emoji">üß•</span>Hoodie</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-cap" value="cap" />
                <label for="type-cap"><span class="type-emoji">üß¢</span>Cap</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-mug" value="mug" />
                <label for="type-mug"><span class="type-emoji">‚òï</span>Mug</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-ashtray" value="ashtray" />
                <label for="type-ashtray"><span class="type-emoji">üö¨</span>Ashtray</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-grinder" value="grinder" />
                <label for="type-grinder"><span class="type-emoji">üåø</span>Grinder</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-keyring" value="keyring" />
                <label for="type-keyring"><span class="type-emoji">üîë</span>Keyring</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-sticker" value="sticker" />
                <label for="type-sticker"><span class="type-emoji">üè∑Ô∏è</span>Sticker</label>
              </div>
              <div class="type-option">
                <input type="radio" name="productType" id="type-other" value="other" />
                <label for="type-other"><span class="type-emoji">üì¶</span>Other</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Basic Info -->
        <div class="form-card">
          <div class="form-card-header">
            <h2>Product Details</h2>
          </div>
          <div class="form-card-body">
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Product Name <span class="required">*</span></label>
              <input type="text" class="form-input" id="productName" placeholder="Classic Logo Tee" required maxlength="30" />
            </div>
            <div class="form-group">
              <label class="form-label">SKU / Stock Code</label>
              <input type="text" class="form-input" id="sku" placeholder="Auto-generated if empty" maxlength="20" />
              <div class="form-hint">Leave blank to auto-generate</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Category <span class="required">*</span></label>
              <select class="form-select" id="category" required>
                <option value="freshwax">Fresh Wax</option>
                <option value="label">Label</option>
                <option value="soundsystem">Sound System</option>
                <option value="dj">DJ</option>
                <option value="crew">Crew</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Category Name <span class="required">*</span></label>
              <input type="text" class="form-input" id="categoryName" placeholder="e.g., Runnin' Records, Amen4Tekno" required maxlength="30" />
              <div class="form-hint">The label/DJ/crew name</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="description" placeholder="Product description, materials, care instructions..."></textarea>
          </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="form-card">
          <div class="form-card-header">
            <h2>Pricing</h2>
          </div>
          <div class="form-card-body">
          <div class="form-row-3">
            <div class="form-group">
              <label class="form-label">Cost Price (¬£)</label>
              <input type="number" class="form-input" id="costPrice" step="0.01" min="0" placeholder="10.00" />
              <div class="form-hint">Your cost per unit</div>
            </div>
            <div class="form-group">
              <label class="form-label">Retail Price (¬£) <span class="required">*</span></label>
              <input type="number" class="form-input" id="retailPrice" step="0.01" min="0" placeholder="25.00" required />
            </div>
            <div class="form-group">
              <label class="form-label">Sale Price (¬£)</label>
              <input type="number" class="form-input" id="salePrice" step="0.01" min="0" placeholder="20.00" />
              <div class="form-hint">Leave empty if not on sale</div>
            </div>
          </div>
          </div>
        </div>

        <!-- Images -->
        <div class="form-card">
          <div class="form-card-header">
            <h2>Product Images</h2>
          </div>
          <div class="form-card-body">
          <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;">
            <strong>Tip:</strong> Select colours below first, then upload images and match each image to its colour variant.
          </p>
          <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
          <div class="image-upload-area" id="imageDropZone">
            <p style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem;">üì∑ Drop images here or click to upload</p>
            <p style="color: #666; font-size: 0.875rem;">Max 10 images. Auto-converted to 800√ó800 WebP.</p>
          </div>
          <div class="image-preview-grid" id="imagePreviewGrid"></div>
          </div>
        </div>

        <!-- Colours -->
        <div class="form-card" id="colorsSection">
          <div class="form-card-header">
            <h2>Available Colours</h2>
          </div>
          <div class="form-card-body">
          <div class="color-grid" id="colorGrid">
            <label class="color-option">
              <input type="checkbox" value="Black" data-hex="#000000" />
              <div class="color-swatch" style="background: #000000;"></div>
              <span>Black</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="White" data-hex="#FFFFFF" />
              <div class="color-swatch" style="background: #FFFFFF;"></div>
              <span>White</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Red" data-hex="#FF0000" />
              <div class="color-swatch" style="background: #FF0000;"></div>
              <span>Red</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Navy" data-hex="#000080" />
              <div class="color-swatch" style="background: #000080;"></div>
              <span>Navy</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Grey" data-hex="#808080" />
              <div class="color-swatch" style="background: #808080;"></div>
              <span>Grey</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Forest Green" data-hex="#228B22" />
              <div class="color-swatch" style="background: #228B22;"></div>
              <span>Forest Green</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Gold" data-hex="#FFD700" />
              <div class="color-swatch" style="background: #FFD700;"></div>
              <span>Gold</span>
            </label>
            <label class="color-option">
              <input type="checkbox" value="Purple" data-hex="#800080" />
              <div class="color-swatch" style="background: #800080;"></div>
              <span>Purple</span>
            </label>
          </div>
          <div class="custom-color-row">
            <input type="color" id="customColorPicker" value="#000000" />
            <input type="text" class="form-input" id="customColorName" placeholder="Custom colour name" style="flex: 1;" />
            <button type="button" class="btn btn-secondary btn-sm" id="addCustomColorBtn">Add</button>
          </div>
          </div>
        </div>

        <!-- Sizes (for clothing) -->
        <div class="form-card" id="sizesSection">
          <div class="form-card-header">
            <h2>Available Sizes</h2>
          </div>
          <div class="form-card-body">
          <div class="size-grid">
            <div class="size-option">
              <input type="checkbox" id="size-xs" value="XS" />
              <label for="size-xs">XS</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-s" value="S" />
              <label for="size-s">S</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-m" value="M" checked />
              <label for="size-m">M</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-l" value="L" checked />
              <label for="size-l">L</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-xl" value="XL" checked />
              <label for="size-xl">XL</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-xxl" value="XXL" />
              <label for="size-xxl">XXL</label>
            </div>
            <div class="size-option">
              <input type="checkbox" id="size-3xl" value="3XL" />
              <label for="size-3xl">3XL</label>
            </div>
          </div>
          </div>
        </div>

        <!-- Variant Stock -->
        <div class="form-card" id="variantStockSection">
          <div class="form-card-header">
            <h2>Stock by Variant</h2>
          </div>
          <div class="form-card-body">
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.875rem;">Enter stock quantities for each size/color combination</p>
            <div id="variantTableContainer">
              <p style="color: #999; font-style: italic;">Select sizes and/or colours above to see variants</p>
            </div>
            <div class="set-all-row">
              <span>Set All to...</span>
              <input type="number" class="form-input" id="setAllStock" value="0" min="0" style="width: 80px;" />
              <button type="button" class="btn btn-secondary btn-sm" onclick="setAllVariantStock()">Apply</button>
            </div>
            <div class="form-group" style="margin-top: 1.5rem; margin-bottom: 0;">
              <label class="form-label">Low Stock Alert Threshold</label>
              <input type="number" class="form-input" id="lowStockThreshold" value="5" min="1" style="max-width: 150px;" />
              <div class="form-hint">Alert when total stock falls to this level</div>
            </div>
          </div>
        </div>

        <!-- Supplier / Consignment -->
        <div class="form-card">
          <div class="form-card-header">
            <h2>Supplier / Source</h2>
          </div>
          <div class="form-card-body">
          <div class="supplier-toggle">
            <label>
              <input type="radio" name="supplierType" value="own" checked />
              Fresh Wax Stock
            </label>
            <label>
              <input type="radio" name="supplierType" value="consignment" />
              Consignment (External Supplier)
            </label>
          </div>
          
          <div class="supplier-fields" id="supplierFields">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Supplier</label>
                <select class="form-select" id="supplierId">
                  <option value="">Select supplier...</option>
                </select>
                <div class="form-hint">Or <a href="/admin/merch/suppliers" target="_blank">add new supplier</a></div>
              </div>
              <div class="form-group">
                <label class="form-label">Supplier Cut (%)</label>
                <input type="number" class="form-input" id="supplierCut" value="50" min="0" max="100" />
                <div class="form-hint">Percentage they receive per sale</div>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="submit-row">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/inventory'">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Upload Product</button>
        </div>
      </div>

      <!-- Preview Panel -->
      <div class="preview-panel">
        <div class="preview-card">
          <div class="preview-image" id="previewImage">
            üì¶
          </div>
          <div class="preview-details">
            <div class="category" id="previewCategory">Fresh Wax</div>
            <h3 id="previewName">Product Name</h3>
            <div class="sku" id="previewSKU">SKU: ‚Äî</div>
            <div class="price" id="previewPrice">¬£0.00</div>
            <div class="preview-colors" id="previewColors"></div>
            <div class="preview-sizes" id="previewSizes"></div>
            <div id="previewStock" class="preview-stock out-of-stock">0 in stock</div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Image Editor Modal -->
  <div class="image-editor-overlay hidden" id="imageEditorOverlay">
    <div class="image-editor-modal">
      <div class="image-editor-header">
        <h3>Resize & Position Image</h3>
        <button type="button" class="image-editor-close" onclick="closeImageEditor()">&times;</button>
      </div>
      <div class="image-editor-body">
        <div class="crop-container" id="cropContainer">
          <img id="cropImage" src="" alt="Crop preview" />
          <div class="crop-grid"></div>
        </div>
        <div class="editor-controls">
          <div class="editor-control-row">
            <label>Zoom</label>
            <input type="range" id="zoomSlider" min="25" max="300" value="100" />
            <span class="value" id="zoomValue">100%</span>
          </div>
        </div>
        <p class="editor-hint">Drag the image to position it within the square frame</p>
        <div class="editor-actions">
          <button type="button" class="btn btn-secondary" onclick="closeImageEditor()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveImageCrop()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ adminKey }}>
    const ADMIN_KEY = adminKey;

    // State
    let uploadedImages = [];
    let suppliers = [];

    // Image editor state
    let editorState = {
      active: false,
      imageIndex: -1, // -1 means new image, >= 0 means editing existing
      originalDataUrl: null,
      zoom: 100,
      panX: 0,
      panY: 0,
      isDragging: false,
      dragStartX: 0,
      dragStartY: 0,
      imgNaturalWidth: 0,
      imgNaturalHeight: 0,
      pendingFiles: [] // Queue for multiple file drops
    };
    
    // Product type configuration
    const productTypes = {
      'tshirt': { hasSizes: true, hasColors: true },
      'hoodie': { hasSizes: true, hasColors: true },
      'cap': { hasSizes: false, hasColors: true },
      'mug': { hasSizes: false, hasColors: true },
      'ashtray': { hasSizes: false, hasColors: true },
      'grinder': { hasSizes: false, hasColors: true },
      'keyring': { hasSizes: false, hasColors: true },
      'sticker': { hasSizes: false, hasColors: false },
      'other': { hasSizes: false, hasColors: true }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSuppliers();
      setupEventListeners();
      updateTypeVisibility();
      updatePreview();
    });

    function setupEventListeners() {
      // Product type change
      document.querySelectorAll('input[name="productType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          updateTypeVisibility();
          updateVariantTable();
          updatePreview();
        });
      });

      // Image upload
      const imageInput = document.getElementById('imageInput');
      const dropZone = document.getElementById('imageDropZone');
      
      dropZone.addEventListener('click', () => imageInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleImageFiles(e.dataTransfer.files);
      });
      imageInput.addEventListener('change', (e) => handleImageFiles(e.target.files));

      // Color selection
      document.querySelectorAll('#colorGrid input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', (e) => {
          e.target.closest('.color-option').classList.toggle('selected', e.target.checked);
          updateVariantTable();
          updatePreview();
          renderImagePreviews(); // Refresh image color dropdowns
        });
      });

      // Custom color
      document.getElementById('addCustomColorBtn').addEventListener('click', addCustomColor);

      // Size selection
      document.querySelectorAll('#sizesSection input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          updateVariantTable();
          updatePreview();
        });
      });

      // Text inputs
      document.getElementById('productName').addEventListener('input', updatePreview);
      document.getElementById('sku').addEventListener('input', updatePreview);
      document.getElementById('categoryName').addEventListener('input', updatePreview);
      document.getElementById('retailPrice').addEventListener('input', updatePreview);
      document.getElementById('salePrice').addEventListener('input', updatePreview);
      document.getElementById('lowStockThreshold').addEventListener('input', updatePreview);

      // Supplier toggle
      document.querySelectorAll('input[name="supplierType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const isConsignment = document.querySelector('input[name="supplierType"]:checked').value === 'consignment';
          document.getElementById('supplierFields').classList.toggle('active', isConsignment);
        });
      });

      // Form inputs for preview
      ['productName', 'category', 'categoryName', 'retailPrice', 'salePrice', 'lowStockThreshold'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
      });

      // Form submit
      document.getElementById('upload-form').addEventListener('submit', handleSubmit);
    }

    function updateTypeVisibility() {
      const productType = document.querySelector('input[name="productType"]:checked').value;
      const config = productTypes[productType];
      
      document.getElementById('sizesSection').style.display = config.hasSizes ? 'block' : 'none';
      document.getElementById('colorsSection').style.display = config.hasColors ? 'block' : 'none';
      
      // If no sizes, uncheck all
      if (!config.hasSizes) {
        document.querySelectorAll('#sizesSection input').forEach(cb => cb.checked = false);
      }
    }

    function handleImageFiles(files) {
      const fileArray = Array.from(files);

      // Queue all files
      fileArray.forEach(file => {
        if (uploadedImages.length + editorState.pendingFiles.length >= 10) {
          showToast('Maximum 10 images allowed', 'error');
          return;
        }
        editorState.pendingFiles.push(file);
      });

      // Start processing queue
      processNextPendingFile();
    }

    function processNextPendingFile() {
      if (editorState.pendingFiles.length === 0) return;

      const file = editorState.pendingFiles.shift();
      const reader = new FileReader();
      reader.onload = (e) => {
        openImageEditor(e.target.result, -1, file);
      };
      reader.readAsDataURL(file);
    }

    function openImageEditor(dataUrl, index = -1, file = null) {
      editorState.active = true;
      editorState.imageIndex = index;
      editorState.originalDataUrl = dataUrl;
      editorState.originalFile = file;
      editorState.zoom = 100;
      editorState.panX = 0;
      editorState.panY = 0;

      const overlay = document.getElementById('imageEditorOverlay');
      const cropImage = document.getElementById('cropImage');
      const zoomSlider = document.getElementById('zoomSlider');

      overlay.classList.remove('hidden');
      cropImage.src = dataUrl;
      zoomSlider.value = 100;
      document.getElementById('zoomValue').textContent = '100%';

      // Wait for image to load to get natural dimensions
      cropImage.onload = () => {
        editorState.imgNaturalWidth = cropImage.naturalWidth;
        editorState.imgNaturalHeight = cropImage.naturalHeight;

        // Calculate initial zoom to fit image within container
        const container = document.getElementById('cropContainer');
        const containerSize = container.offsetWidth;
        const minDim = Math.min(editorState.imgNaturalWidth, editorState.imgNaturalHeight);
        const maxDim = Math.max(editorState.imgNaturalWidth, editorState.imgNaturalHeight);

        // Start with zoom that makes the smallest dimension fill the container
        const initialZoom = Math.ceil((containerSize / minDim) * 100);
        editorState.zoom = Math.max(100, Math.min(300, initialZoom));
        zoomSlider.value = editorState.zoom;
        document.getElementById('zoomValue').textContent = editorState.zoom + '%';

        updateCropPreview();
        setupEditorListeners();
      };
    }

    function setupEditorListeners() {
      const container = document.getElementById('cropContainer');
      const zoomSlider = document.getElementById('zoomSlider');

      // Remove old listeners
      container.onmousedown = null;
      container.ontouchstart = null;

      // Zoom slider
      zoomSlider.oninput = (e) => {
        editorState.zoom = parseInt(e.target.value);
        document.getElementById('zoomValue').textContent = editorState.zoom + '%';
        updateCropPreview();
      };

      // Pan with mouse
      container.onmousedown = (e) => {
        e.preventDefault();
        editorState.isDragging = true;
        editorState.dragStartX = e.clientX - editorState.panX;
        editorState.dragStartY = e.clientY - editorState.panY;
      };

      document.onmousemove = (e) => {
        if (!editorState.isDragging) return;
        editorState.panX = e.clientX - editorState.dragStartX;
        editorState.panY = e.clientY - editorState.dragStartY;
        updateCropPreview();
      };

      document.onmouseup = () => {
        editorState.isDragging = false;
      };

      // Pan with touch
      container.ontouchstart = (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        editorState.isDragging = true;
        editorState.dragStartX = touch.clientX - editorState.panX;
        editorState.dragStartY = touch.clientY - editorState.panY;
      };

      document.ontouchmove = (e) => {
        if (!editorState.isDragging) return;
        const touch = e.touches[0];
        editorState.panX = touch.clientX - editorState.dragStartX;
        editorState.panY = touch.clientY - editorState.dragStartY;
        updateCropPreview();
      };

      document.ontouchend = () => {
        editorState.isDragging = false;
      };
    }

    function updateCropPreview() {
      const cropImage = document.getElementById('cropImage');
      const container = document.getElementById('cropContainer');
      const containerSize = container.offsetWidth;

      const scale = editorState.zoom / 100;
      const displayWidth = editorState.imgNaturalWidth * scale;
      const displayHeight = editorState.imgNaturalHeight * scale;

      // Center the image, then apply pan offset
      const centerX = (containerSize - displayWidth) / 2 + editorState.panX;
      const centerY = (containerSize - displayHeight) / 2 + editorState.panY;

      cropImage.style.width = displayWidth + 'px';
      cropImage.style.height = displayHeight + 'px';
      cropImage.style.left = centerX + 'px';
      cropImage.style.top = centerY + 'px';
    }

    window.closeImageEditor = function() {
      document.getElementById('imageEditorOverlay').classList.add('hidden');
      editorState.active = false;
      editorState.isDragging = false;

      // Process next file in queue
      if (editorState.pendingFiles.length > 0) {
        setTimeout(processNextPendingFile, 100);
      }
    };

    window.saveImageCrop = function() {
      const container = document.getElementById('cropContainer');
      const cropImage = document.getElementById('cropImage');
      const containerSize = container.offsetWidth;

      // Create canvas for the crop (800x800 output)
      const outputSize = 800;
      const canvas = document.createElement('canvas');
      canvas.width = outputSize;
      canvas.height = outputSize;
      const ctx = canvas.getContext('2d');

      // Fill with white background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, outputSize, outputSize);

      // Calculate the visible portion of the image
      const scale = editorState.zoom / 100;
      const displayWidth = editorState.imgNaturalWidth * scale;
      const displayHeight = editorState.imgNaturalHeight * scale;
      const centerX = (containerSize - displayWidth) / 2 + editorState.panX;
      const centerY = (containerSize - displayHeight) / 2 + editorState.panY;

      // Scale factor from container to output
      const outputScale = outputSize / containerSize;

      // Draw the image onto canvas with correct position and scale
      ctx.drawImage(
        cropImage,
        centerX * outputScale,
        centerY * outputScale,
        displayWidth * outputScale,
        displayHeight * outputScale
      );

      // Use canvas.toBlob to avoid CSP issues with data: URLs
      canvas.toBlob(blob => {
        const croppedFile = new File([blob], editorState.originalFile?.name || 'image.jpg', { type: 'image/jpeg' });
        const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);

        if (editorState.imageIndex === -1) {
          // New image
          uploadedImages.push({
            file: croppedFile,
            dataUrl: croppedDataUrl,
            color: null,
            colorHex: null
          });
        } else {
          // Editing existing image
          uploadedImages[editorState.imageIndex].file = croppedFile;
          uploadedImages[editorState.imageIndex].dataUrl = croppedDataUrl;
        }

        renderImagePreviews();
        updatePreview();
        closeImageEditor();
      }, 'image/jpeg', 0.9);
    };

    window.editImage = function(idx) {
      openImageEditor(uploadedImages[idx].dataUrl, idx, uploadedImages[idx].file);
    };

    function getSelectedColors() {
      const colors = [];
      document.querySelectorAll('#colorGrid input:checked').forEach(input => {
        colors.push({
          name: input.value,
          hex: input.dataset.hex
        });
      });
      return colors;
    }

    function renderImagePreviews() {
      const grid = document.getElementById('imagePreviewGrid');
      const selectedColors = getSelectedColors();

      grid.innerHTML = uploadedImages.map((img, idx) => {
        const colorOptions = selectedColors.map(c =>
          `<option value="${c.name}" data-hex="${c.hex}" ${img.color === c.name ? 'selected' : ''}>${c.name}</option>`
        ).join('');

        const hasColors = selectedColors.length > 0;
        const colorDisplay = img.color ?
          `<div class="image-color-badge">
            <span class="color-dot" style="background: ${img.colorHex || '#ccc'}"></span>
            <span>${img.color}</span>
          </div>` : '';

        return `
          <div class="image-preview-item">
            <div class="image-wrapper">
              <img src="${img.dataUrl}" alt="Product image ${idx + 1}" />
              ${idx === 0 ? '<div class="badge">PRIMARY</div>' : ''}
              <button type="button" class="edit-btn" onclick="editImage(${idx})">Edit</button>
              <button type="button" class="remove-btn" onclick="removeImage(${idx})">√ó</button>
            </div>
            ${hasColors ? `
              <div class="image-color-select">
                <label>Match to colour</label>
                <select onchange="setImageColor(${idx}, this)">
                  <option value="">-- Select colour --</option>
                  ${colorOptions}
                </select>
              </div>
            ` : `
              <div class="image-color-select">
                <label style="color: #999;">No colours selected</label>
              </div>
            `}
          </div>
        `;
      }).join('');
    }

    window.setImageColor = function(idx, selectEl) {
      const selectedOption = selectEl.options[selectEl.selectedIndex];
      uploadedImages[idx].color = selectEl.value || null;
      uploadedImages[idx].colorHex = selectedOption.dataset?.hex || null;
      updatePreview();
    };

    window.removeImage = function(idx) {
      uploadedImages.splice(idx, 1);
      renderImagePreviews();
      updatePreview();
    };

    function addCustomColor() {
      const hex = document.getElementById('customColorPicker').value;
      const name = document.getElementById('customColorName').value.trim();
      
      if (!name) {
        showToast('Please enter a colour name', 'error');
        return;
      }
      
      const colorGrid = document.getElementById('colorGrid');
      const newOption = document.createElement('label');
      newOption.className = 'color-option selected';
      newOption.innerHTML = `
        <input type="checkbox" value="${name}" data-hex="${hex}" checked />
        <div class="color-swatch" style="background: ${hex};"></div>
        <span>${name}</span>
      `;
      
      newOption.querySelector('input').addEventListener('change', (e) => {
        e.target.closest('.color-option').classList.toggle('selected', e.target.checked);
        updateVariantTable();
        updatePreview();
        renderImagePreviews(); // Refresh image color dropdowns
      });
      
      colorGrid.appendChild(newOption);
      document.getElementById('customColorName').value = '';
      
      updateVariantTable();
      updatePreview();
      renderImagePreviews(); // Refresh image color dropdowns
    }

    function getSelectedSizes() {
      return Array.from(document.querySelectorAll('#sizesSection input:checked')).map(cb => cb.value);
    }

    function updateVariantTable() {
      const container = document.getElementById('variantTableContainer');
      const productType = document.querySelector('input[name="productType"]:checked').value;
      const config = productTypes[productType];
      
      const sizes = config.hasSizes ? getSelectedSizes() : [];
      const colors = config.hasColors ? getSelectedColors() : [];
      
      const cardStyle = 'border: 2px solid #ddd; padding: 1rem; text-align: center;';
      const swatchStyle = 'width: 24px; height: 24px; border: 2px solid #000; margin: 0 auto 0.5rem;';
      const labelStyle = 'font-weight: 700; font-size: 0.875rem; margin-bottom: 0.25rem;';
      const skuStyle = 'font-family: monospace; font-size: 0.65rem; color: #666; margin-bottom: 0.5rem;';
      const inputStyle = 'width: 70px; padding: 0.5rem; border: 2px solid #000; text-align: center; font-weight: 700; font-size: 1rem;';
      const gridStyle = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem;';
      
      // No variants needed
      if (sizes.length === 0 && colors.length === 0) {
        container.innerHTML = `
          <div style="${gridStyle}">
            <div style="${cardStyle}">
              <div style="${labelStyle}">Default</div>
              <div style="${skuStyle}">default</div>
              <input type="number" class="variant-stock-input" style="${inputStyle}" data-key="default" value="0" min="0" />
            </div>
          </div>
        `;
        container.querySelectorAll('.variant-stock-input').forEach(input => {
          input.addEventListener('input', updatePreview);
        });
        return;
      }
      
      let cards = '';
      
      if (sizes.length > 0 && colors.length > 0) {
        // Size √ó Color matrix
        sizes.forEach(size => {
          colors.forEach(color => {
            const key = `${size}_${color.name}`.toLowerCase().replace(/\s/g, '-');
            cards += `
              <div style="${cardStyle}">
                <div style="${swatchStyle} background: ${color.hex};"></div>
                <div style="${labelStyle}">${size} - ${color.name}</div>
                <div style="${skuStyle}">${key}</div>
                <input type="number" class="variant-stock-input" style="${inputStyle}" data-key="${key}" data-size="${size}" data-color="${color.name}" data-hex="${color.hex}" value="0" min="0" />
              </div>
            `;
          });
        });
      } else if (sizes.length > 0) {
        // Sizes only
        sizes.forEach(size => {
          const key = `${size}_default`.toLowerCase();
          cards += `
            <div style="${cardStyle}">
              <div style="${labelStyle}">${size}</div>
              <div style="${skuStyle}">${key}</div>
              <input type="number" class="variant-stock-input" style="${inputStyle}" data-key="${key}" data-size="${size}" value="0" min="0" />
            </div>
          `;
        });
      } else if (colors.length > 0) {
        // Colors only
        colors.forEach(color => {
          const key = `onesize_${color.name}`.toLowerCase().replace(/\s/g, '-');
          cards += `
            <div style="${cardStyle}">
              <div style="${swatchStyle} background: ${color.hex};"></div>
              <div style="${labelStyle}">${color.name}</div>
              <div style="${skuStyle}">${key}</div>
              <input type="number" class="variant-stock-input" style="${inputStyle}" data-key="${key}" data-color="${color.name}" data-hex="${color.hex}" value="0" min="0" />
            </div>
          `;
        });
      }
      
      container.innerHTML = `<div style="${gridStyle}">${cards}</div>`;
      
      // Add listeners
      container.querySelectorAll('.variant-stock-input').forEach(input => {
        input.addEventListener('input', updatePreview);
      });
    }

    // Set all variant stock to a value
    window.setAllVariantStock = function() {
      const qty = parseInt(document.getElementById('setAllStock').value) || 0;
      document.querySelectorAll('.variant-stock-input').forEach(input => {
        input.value = qty;
      });
      updatePreview();
    };

    window.setAllStock = function() {
      // Legacy - now handled by setAllVariantStock
      const qty = prompt('Set all variants to quantity:', '10');
      if (qty !== null) {
        document.querySelectorAll('.variant-stock-input').forEach(input => {
          input.value = qty;
        });
        updatePreview();
      }
    };

    function getVariantsData() {
      const variants = [];
      document.querySelectorAll('.variant-stock-input').forEach(input => {
        variants.push({
          key: input.dataset.key,
          size: input.dataset.size || null,
          color: input.dataset.color || null,
          colorHex: input.dataset.hex || null,
          stock: parseInt(input.value) || 0
        });
      });
      return variants;
    }

    function getTotalStock() {
      return getVariantsData().reduce((sum, v) => sum + v.stock, 0);
    }

    function updatePreview() {
      // Image
      const imgContainer = document.getElementById('previewImage');
      if (uploadedImages.length > 0) {
        imgContainer.innerHTML = `<img src="${uploadedImages[0].dataUrl}" alt="Preview" />`;
      } else {
        imgContainer.innerHTML = 'üì¶';
      }
      
      // Name
      document.getElementById('previewName').textContent = 
        document.getElementById('productName').value || 'Product Name';
      
      // Category
      document.getElementById('previewCategory').textContent = 
        document.getElementById('categoryName').value || 'Fresh Wax';
      
      // SKU
      const sku = document.getElementById('sku').value.trim();
      document.getElementById('previewSKU').textContent = 
        sku ? `SKU: ${sku}` : 'SKU: Auto-generated';
      
      // Price
      const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
      const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
      
      if (salePrice > 0 && salePrice < retailPrice) {
        document.getElementById('previewPrice').innerHTML = 
          `¬£${salePrice.toFixed(2)}<span class="original">¬£${retailPrice.toFixed(2)}</span>`;
      } else {
        document.getElementById('previewPrice').textContent = `¬£${retailPrice.toFixed(2)}`;
      }
      
      // Colors
      const colors = getSelectedColors();
      document.getElementById('previewColors').innerHTML = colors.map(c => 
        `<div class="preview-color" style="background: ${c.hex};" title="${c.name}"></div>`
      ).join('');
      
      // Sizes
      const productType = document.querySelector('input[name="productType"]:checked').value;
      const sizes = productTypes[productType].hasSizes ? getSelectedSizes() : [];
      document.getElementById('previewSizes').innerHTML = sizes.map(s => 
        `<div class="preview-size">${s}</div>`
      ).join('');
      
      // Stock
      const totalStock = getTotalStock();
      const threshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
      const stockEl = document.getElementById('previewStock');
      
      stockEl.textContent = `${totalStock} in stock`;
      stockEl.className = 'preview-stock';
      
      if (totalStock === 0) {
        stockEl.classList.add('out-of-stock');
      } else if (totalStock <= threshold) {
        stockEl.classList.add('low-stock');
      } else {
        stockEl.classList.add('in-stock');
      }
    }

    async function loadSuppliers() {
      try {
        const response = await fetch('/api/suppliers');
        const data = await response.json();
        
        if (data.success && data.suppliers) {
          suppliers = data.suppliers.filter(s => s.active !== false);
          
          const select = document.getElementById('supplierId');
          select.innerHTML = '<option value="">Select supplier...</option>' +
            suppliers.map(s => `<option value="${s.id}" data-code="${s.code}" data-cut="${s.defaultCut}">${s.name}</option>`).join('');
          
          select.addEventListener('change', () => {
            const selected = select.selectedOptions[0];
            if (selected && selected.dataset.cut) {
              document.getElementById('supplierCut').value = selected.dataset.cut;
            }
          });
        }
      } catch (e) {
        console.error('Failed to load suppliers:', e);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';
      
      try {
        // Validation
        if (uploadedImages.length === 0) {
          throw new Error('Please upload at least one product image');
        }
        
        const productName = document.getElementById('productName').value.trim();
        const retailPrice = parseFloat(document.getElementById('retailPrice').value);
        
        if (!productName) throw new Error('Product name is required');
        if (!retailPrice || retailPrice <= 0) throw new Error('Retail price must be greater than 0');
        
        // Build form data
        const formData = new FormData();
        
        // Images with color associations
        const imageColorMap = [];
        uploadedImages.forEach((img, idx) => {
          formData.append(`image_${idx}`, img.file);
          imageColorMap.push({
            index: idx,
            color: img.color || null,
            colorHex: img.colorHex || null
          });
        });
        formData.append('imageCount', uploadedImages.length.toString());
        formData.append('imageColorMap', JSON.stringify(imageColorMap));
        
        // Basic info
        formData.append('productName', productName);
        formData.append('productType', document.querySelector('input[name="productType"]:checked').value);
        formData.append('sku', document.getElementById('sku').value.trim());
        formData.append('description', document.getElementById('description').value.trim());
        formData.append('category', document.getElementById('category').value);
        formData.append('categoryName', document.getElementById('categoryName').value.trim());
        
        // Pricing
        formData.append('costPrice', document.getElementById('costPrice').value || '0');
        formData.append('retailPrice', retailPrice.toString());
        formData.append('salePrice', document.getElementById('salePrice').value || '0');
        
        // Variants
        formData.append('sizes', JSON.stringify(getSelectedSizes()));
        formData.append('colors', JSON.stringify(getSelectedColors()));
        formData.append('variants', JSON.stringify(getVariantsData()));
        formData.append('lowStockThreshold', document.getElementById('lowStockThreshold').value);
        
        // Supplier
        const isConsignment = document.querySelector('input[name="supplierType"]:checked').value === 'consignment';
        if (isConsignment) {
          const supplierSelect = document.getElementById('supplierId');
          const selectedSupplier = supplierSelect.selectedOptions[0];
          
          if (supplierSelect.value) {
            formData.append('supplierId', supplierSelect.value);
            formData.append('supplierName', selectedSupplier.textContent);
            formData.append('supplierCode', selectedSupplier.dataset.code || 'EXT');
            formData.append('supplierCut', document.getElementById('supplierCut').value);
          }
        } else {
          formData.append('supplierCode', 'FW');
          formData.append('supplierName', 'Fresh Wax');
        }
        
        // Submit
        const response = await fetch('/api/upload-merch', {
          method: 'POST',
          headers: { 'X-Admin-Key': ADMIN_KEY },
          body: formData
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Upload failed');
        }
        
        showToast('Product uploaded successfully!', 'success');
        
        setTimeout(() => {
          window.location.href = '/admin/inventory';
        }, 1500);
        
      } catch (error) {
        console.error('Upload error:', error);
        showToast(error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Upload Product';
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>