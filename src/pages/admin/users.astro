---
// src/pages/admin/users.astro
// Fresh Wax User Management - Customers and DJs only
// Artists and Merch Suppliers are managed in Partner Management
import AdminLayout from '../../layouts/AdminLayout.astro';
import '../../styles/admin/users.css';
export const prerender = false;
---

<AdminLayout title="User Management" activeNav="users">
  <Fragment slot="actions">
    <button class="btn btn-outline" onclick="exportUsers()">
      <span>üì•</span> Export CSV
    </button>
  </Fragment>

  <!-- Stats Bar -->
  <div class="stats-grid mb-3">
    <div class="stat-card">
      <div class="stat-value" id="totalCount">0</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card info">
      <div class="stat-value" id="customerCount">0</div>
      <div class="stat-label">Customers</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="djCount">0</div>
      <div class="stat-label">DJs</div>
    </div>
    <div class="stat-card revenue">
      <div class="stat-value" id="totalRevenue">¬£0</div>
      <div class="stat-label">Total Revenue</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Search by name, email..." class="search-input">
    </div>
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All Users</button>
      <button class="filter-tab" data-filter="customer">Customers</button>
      <button class="filter-tab" data-filter="dj">DJs</button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="card">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading users...</p>
    </div>
  </div>

  <!-- Users Table -->
  <div id="usersTable" class="card" style="display: none;">
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Contact</th>
            <th>Roles</th>
            <th>Orders</th>
            <th>Spent</th>
            <th>Status</th>
            <th>Registered</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="card" style="display: none;">
    <div class="empty-state">
      <div class="empty-icon">üë•</div>
      <h3>No users found</h3>
      <p>Try adjusting your search or filter criteria</p>
    </div>
  </div>

  <!-- Edit User Modal -->
  <Fragment slot="modals">
    <div id="editModal" class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h2>Edit User</h2>
          <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editUserId">
            <input type="hidden" id="editUserCollection">
            
            <!-- Basic Info -->
            <div class="form-section">
              <h3 class="form-section-title">Basic Information</h3>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Display Name <span class="required">*</span></label>
                  <input type="text" id="editDisplayName" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Full Name</label>
                  <input type="text" id="editFullName" class="form-input">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Email <span class="required">*</span></label>
                  <input type="email" id="editEmail" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" id="editPhone" class="form-input" placeholder="+44...">
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="form-section">
              <h3 class="form-section-title">Address</h3>
              <div class="form-group">
                <label class="form-label">Address Line 1</label>
                <input type="text" id="editAddressLine1" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Address Line 2</label>
                <input type="text" id="editAddressLine2" class="form-input">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">City</label>
                  <input type="text" id="editCity" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Postcode</label>
                  <input type="text" id="editPostcode" class="form-input">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Country</label>
                <input type="text" id="editCountry" class="form-input" value="United Kingdom">
              </div>
            </div>

            <!-- Roles -->
            <div class="form-section">
              <h3 class="form-section-title">Account Roles</h3>
              <p class="form-hint mb-2">All users are Customers and DJs by default</p>
              <div class="role-cards">
                <label class="role-card-select always-on">
                  <input type="checkbox" id="editRoleCustomer" name="roles" value="customer" checked disabled>
                  <div class="role-card-content">
                    <span class="role-icon">üõí</span>
                    <div class="role-info">
                      <strong>Customer</strong>
                      <span>Can browse and purchase from the store</span>
                    </div>
                    <span class="role-check">‚úì</span>
                  </div>
                </label>
                <label class="role-card-select always-on">
                  <input type="checkbox" id="editRoleDJ" name="roles" value="dj" checked disabled>
                  <div class="role-card-content">
                    <span class="role-icon">üéß</span>
                    <div class="role-info">
                      <strong>DJ</strong>
                      <span>Can upload DJ mixes and go live</span>
                    </div>
                    <span class="role-check">‚úì</span>
                  </div>
                </label>
              </div>
              
              <h4 style="margin: 1.5rem 0 0.5rem; font-size: 0.85rem; color: #666;">Upgrade Options</h4>
              <p class="form-hint mb-2">Enable additional roles for this user</p>
              <div class="role-cards">
                <label class="role-card-select">
                  <input type="checkbox" id="editRoleArtist" name="roles" value="artist">
                  <div class="role-card-content">
                    <span class="role-icon">üéµ</span>
                    <div class="role-info">
                      <strong>Artist</strong>
                      <span>Can upload and sell music releases</span>
                    </div>
                    <span class="role-check">‚úì</span>
                  </div>
                </label>
                <label class="role-card-select">
                  <input type="checkbox" id="editRoleMerch" name="roles" value="merch">
                  <div class="role-card-content">
                    <span class="role-icon">üëï</span>
                    <div class="role-info">
                      <strong>Merch Supplier</strong>
                      <span>Can sell merchandise on the store</span>
                    </div>
                    <span class="role-check">‚úì</span>
                  </div>
                </label>
              </div>
              <p class="form-hint mt-2 text-sm">Note: Users with Artist or Merch roles will also appear in Partner Management for approval settings.</p>
            </div>

            <!-- Account Status -->
            <div class="form-section">
              <h3 class="form-section-title">Account Status</h3>
              <div class="status-options" style="grid-template-columns: repeat(2, 1fr);">
                <label class="status-option">
                  <input type="radio" name="editStatus" value="approved" id="statusApproved">
                  <div class="status-card approved">
                    <span class="status-icon">‚úì</span>
                    <div>
                      <strong>Active</strong>
                      <span>Full access to store and features</span>
                    </div>
                  </div>
                </label>
                <label class="status-option">
                  <input type="radio" name="editStatus" value="suspended" id="statusSuspended">
                  <div class="status-card suspended">
                    <span class="status-icon">üö´</span>
                    <div>
                      <strong>Suspended</strong>
                      <span>Account access revoked</span>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Permissions -->
            <div class="form-section">
              <h3 class="form-section-title">Permissions</h3>
              <p class="form-hint mb-2">Control what this user can do</p>
              <div class="permissions-grid">
                <label class="permission-toggle">
                  <input type="checkbox" id="editPermBuy" checked>
                  <span class="permission-label">üõí Can Purchase</span>
                </label>
                <label class="permission-toggle">
                  <input type="checkbox" id="editPermComment" checked>
                  <span class="permission-label">üí¨ Can Comment</span>
                </label>
                <label class="permission-toggle">
                  <input type="checkbox" id="editPermRate" checked>
                  <span class="permission-label">‚≠ê Can Rate</span>
                </label>
                <label class="permission-toggle">
                  <input type="checkbox" id="editPermAdmin">
                  <span class="permission-label">üëë Admin Access</span>
                </label>
              </div>
            </div>

            <!-- Admin Notes -->
            <div class="form-section">
              <h3 class="form-section-title">Admin Notes</h3>
              <textarea id="editNotes" class="form-input" rows="3" placeholder="Internal notes about this user..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveUser()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Quick Approve Modal -->
    <div id="approveModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2>Approve User</h2>
          <button class="modal-close" onclick="closeModal('approveModal')">√ó</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to approve <strong id="approveUserName"></strong>?</p>
          <p class="text-muted mt-1">They will gain access to the Pro Dashboard and can upload content.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Cancel</button>
          <button type="button" class="btn btn-success" onclick="confirmApprove()">Approve User</button>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2>Delete User</h2>
          <button class="modal-close" onclick="closeModal('deleteModal')">√ó</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
          <p class="text-danger mt-1">‚ö†Ô∏è This action cannot be undone. The user will lose access to their account.</p>
          <div class="form-group mt-2">
            <label class="checkbox-label">
              <input type="checkbox" id="deleteConfirmCheck">
              <span>I understand this will permanently delete this user</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="confirmDelete()">Delete User</button>
        </div>
      </div>
    </div>
  </Fragment>

  <Fragment slot="scripts">
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
        authDomain: "freshwax-store.firebaseapp.com",
        projectId: "freshwax-store",
        storageBucket: "freshwax-store.firebasestorage.app",
        messagingSenderId: "675435782973",
        appId: "1:675435782973:web:e8459c2ec4a5f6d683db54"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      let allUsers = [];
      let currentFilter = 'all';
      let currentUserId = null;
      let currentUserCollection = null;
      let currentAdminUid = null;
      let currentUserData = null;

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = '/admin/login';
          return;
        }
        currentAdminUid = user.uid;
        loadUsers();
      });

      async function loadUsers() {
        try {
          const response = await fetch('/api/admin/list-users', {
            headers: { 'x-admin-uid': currentAdminUid }
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to load users');
          }

          allUsers = data.users.map(u => ({
            ...u,
            registeredAt: u.registeredAt ? new Date(u.registeredAt) : null
          }));

          document.getElementById('totalCount').textContent = data.stats.totalCount;
          document.getElementById('customerCount').textContent = data.stats.customerCount;
          document.getElementById('djCount').textContent = data.stats.djCount;
          document.getElementById('totalRevenue').textContent = '¬£' + data.stats.totalRevenue.toFixed(0);

          renderUsers();

          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('usersTable').style.display = 'block';

        } catch (error) {
          console.error('Error loading users:', error);
          document.getElementById('loadingState').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ùå</div>
              <h3>Error loading users</h3>
              <p>${error.message}</p>
              <button class="btn btn-primary mt-2" onclick="location.reload()">Try Again</button>
            </div>
          `;
        }
      }

      function renderUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        let filtered = allUsers.filter(u => {
          if (u.roles.artist || u.roles.merch) return false;

          const matchesSearch = !searchTerm ||
            u.displayName.toLowerCase().includes(searchTerm) ||
            u.email.toLowerCase().includes(searchTerm) ||
            u.fullName.toLowerCase().includes(searchTerm);

          if (!matchesSearch) return false;

          switch (currentFilter) {
            case 'customer': return u.roles.customer && !u.roles.dj;
            case 'dj': return u.roles.dj;
            default: return u.roles.customer || u.roles.dj;
          }
        });

        const tbody = document.getElementById('usersTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableWrapper = document.getElementById('usersTable');

        if (filtered.length === 0) {
          tableWrapper.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }

        tableWrapper.style.display = 'block';
        emptyState.style.display = 'none';

        tbody.innerHTML = filtered.map(u => {
          const roles = [];
          if (u.roles.customer) roles.push('<span class="badge badge-secondary">Customer</span>');
          if (u.roles.dj) roles.push('<span class="badge badge-info">üéß DJ</span>');

          let statusBadge = '<span class="badge badge-secondary">Basic</span>';
          if (u.suspended) {
            statusBadge = '<span class="badge badge-danger">Suspended</span>';
          } else if (u.approved && (u.roles.artist || u.roles.merch)) {
            statusBadge = '<span class="badge badge-success">Pro Approved</span>';
          } else if (u.roles.artist || u.roles.merch) {
            statusBadge = '<span class="badge badge-pending">Pending Approval</span>';
          }

          const dateStr = u.registeredAt ? u.registeredAt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
          const needsApproval = !u.approved && !u.suspended && (u.roles.artist || u.roles.merch);
          const orderCount = u.orderCount || 0;
          const totalSpent = u.totalSpent || 0;

          return `
            <tr data-id="${u.id}">
              <td>
                <div class="user-cell">
                  <div class="avatar">${u.avatarUrl ? `<img src="${u.avatarUrl}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" /><span style="display:none;">${u.displayName.charAt(0).toUpperCase()}</span>` : u.displayName.charAt(0).toUpperCase()}</div>
                  <div>
                    <div class="user-name">${u.displayName}</div>
                    ${u.fullName && u.fullName !== u.displayName ? `<div class="text-muted text-sm">${u.fullName}</div>` : ''}
                  </div>
                </div>
              </td>
              <td>
                <div>${u.email}</div>
                ${u.phone ? `<div class="text-muted text-sm">${u.phone}</div>` : ''}
              </td>
              <td>${roles.join(' ') || '<span class="text-muted">None</span>'}</td>
              <td class="text-center">${orderCount > 0 ? `<span class="badge badge-secondary">${orderCount}</span>` : '<span class="text-muted">0</span>'}</td>
              <td>${totalSpent > 0 ? `<strong>¬£${totalSpent.toFixed(2)}</strong>` : '<span class="text-muted">¬£0</span>'}</td>
              <td>${statusBadge}</td>
              <td class="text-muted">${dateStr}</td>
              <td class="text-right">
                <div class="btn-group">
                  ${needsApproval ? `<button class="btn btn-sm btn-success" onclick="quickApprove('${u.id}', '${u.displayName.replace(/'/g, "\\'")}', '${u.collection}')">Approve</button>` : ''}
                  <button class="btn btn-sm btn-secondary" onclick="editUser('${u.id}')">Edit</button>
                  <button class="btn btn-sm btn-outline" onclick="deleteUser('${u.id}', '${u.displayName.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Filter tabs
      document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderUsers();
        });
      });

      document.getElementById('searchInput').addEventListener('input', () => renderUsers());

      // Delete confirmation checkbox
      document.getElementById('deleteConfirmCheck')?.addEventListener('change', (e) => {
        document.getElementById('confirmDeleteBtn').disabled = !e.target.checked;
      });

      // Edit user - populate modal with user data
      window.editUser = function(id) {
        const user = allUsers.find(u => u.id === id);
        if (!user) {
          showToast('User not found', 'error');
          return;
        }

        currentUserId = id;
        currentUserCollection = user.collection;
        currentUserData = user;

        // Populate form fields
        document.getElementById('editUserId').value = id;
        document.getElementById('editUserCollection').value = user.collection;
        document.getElementById('editDisplayName').value = user.displayName || '';
        document.getElementById('editFullName').value = user.fullName || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editPhone').value = user.phone || '';

        // Address
        const addr = user.address || {};
        document.getElementById('editAddressLine1').value = addr.line1 || addr.address1 || '';
        document.getElementById('editAddressLine2').value = addr.line2 || addr.address2 || '';
        document.getElementById('editCity').value = addr.city || '';
        document.getElementById('editPostcode').value = addr.postcode || addr.postalCode || '';
        document.getElementById('editCountry').value = addr.country || 'United Kingdom';

        // Roles
        document.getElementById('editRoleCustomer').checked = true;
        document.getElementById('editRoleDJ').checked = true;
        document.getElementById('editRoleArtist').checked = user.roles?.artist || false;
        document.getElementById('editRoleMerch').checked = user.roles?.merch || false;

        // Status
        if (user.suspended) {
          document.getElementById('statusSuspended').checked = true;
        } else {
          document.getElementById('statusApproved').checked = true;
        }

        // Permissions
        document.getElementById('editPermBuy').checked = user.permissions?.canBuy !== false;
        document.getElementById('editPermComment').checked = user.permissions?.canComment !== false;
        document.getElementById('editPermRate').checked = user.permissions?.canRate !== false;
        document.getElementById('editPermAdmin').checked = user.isAdmin === true;

        // Notes
        document.getElementById('editNotes').value = user.notes || '';

        openModal('editModal');
      };

      // Save user - uses server-side API
      window.saveUser = async function() {
        if (!currentUserId) {
          showToast('No user selected', 'error');
          return;
        }

        const saveBtn = document.querySelector('#editModal .btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        try {
          const status = document.querySelector('input[name="editStatus"]:checked')?.value;
          const displayName = document.getElementById('editDisplayName').value.trim();
          const fullName = document.getElementById('editFullName').value.trim();

          if (!displayName) {
            showToast('Display name is required', 'error');
            return;
          }

          const updates = {
            displayName: displayName,
            fullName: fullName,
            email: document.getElementById('editEmail').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            address: {
              line1: document.getElementById('editAddressLine1').value.trim(),
              line2: document.getElementById('editAddressLine2').value.trim(),
              city: document.getElementById('editCity').value.trim(),
              postcode: document.getElementById('editPostcode').value.trim(),
              country: document.getElementById('editCountry').value.trim()
            },
            roles: {
              customer: true,
              dj: true,
              artist: document.getElementById('editRoleArtist').checked,
              merchSupplier: document.getElementById('editRoleMerch').checked,
              admin: document.getElementById('editPermAdmin').checked
            },
            permissions: {
              canBuy: document.getElementById('editPermBuy').checked,
              canComment: document.getElementById('editPermComment').checked,
              canRate: document.getElementById('editPermRate').checked
            },
            isAdmin: document.getElementById('editPermAdmin').checked,
            approved: status === 'approved',
            suspended: status === 'suspended',
            adminNotes: document.getElementById('editNotes').value.trim()
          };

          // Call server-side API
          const response = await fetch('/api/admin/update-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-admin-uid': currentAdminUid
            },
            body: JSON.stringify({
              userId: currentUserId,
              sourceCollection: currentUserCollection,
              updates: updates
            })
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || 'Failed to update user');
          }

          closeModal('editModal');

          const isBeingUpgraded = updates.roles.artist || updates.roles.merchSupplier;
          if (isBeingUpgraded) {
            showToast('User upgraded to Partner!', 'success');
          } else {
            showToast('User updated successfully', 'success');
          }

          // Reload users to show updated data
          await loadUsers();

        } catch (error) {
          console.error('Save error:', error);
          showToast('Error: ' + error.message, 'error');
        } finally {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      };

      // Quick approve
      window.quickApprove = function(id, name, collection) {
        currentUserId = id;
        currentUserCollection = collection;
        document.getElementById('approveUserName').textContent = name;
        openModal('approveModal');
      };

      window.confirmApprove = async function() {
        if (!currentUserId) return;

        try {
          const response = await fetch('/api/admin/update-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-admin-uid': currentAdminUid
            },
            body: JSON.stringify({
              userId: currentUserId,
              sourceCollection: currentUserCollection,
              updates: { approved: true }
            })
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || 'Failed to approve user');
          }

          closeModal('approveModal');
          showToast('User approved!', 'success');
          await loadUsers();

        } catch (error) {
          console.error('Approve error:', error);
          showToast('Error: ' + error.message, 'error');
        }
      };

      // Delete user
      window.deleteUser = function(id, name) {
        currentUserId = id;
        document.getElementById('deleteUserName').textContent = name;
        document.getElementById('deleteConfirmCheck').checked = false;
        document.getElementById('confirmDeleteBtn').disabled = true;
        openModal('deleteModal');
      };

      window.confirmDelete = async function() {
        if (!currentUserId) return;

        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.textContent;
        deleteBtn.textContent = 'Deleting...';
        deleteBtn.disabled = true;

        try {
          // Use server-side API to delete user
          const response = await fetch('/api/admin/delete-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-admin-uid': currentAdminUid
            },
            body: JSON.stringify({ userId: currentUserId })
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || 'Failed to delete user');
          }

          closeModal('deleteModal');
          showToast('User deleted successfully', 'success');
          await loadUsers();

        } catch (error) {
          console.error('Delete error:', error);
          showToast('Error: ' + error.message, 'error');
        } finally {
          deleteBtn.textContent = originalText;
          deleteBtn.disabled = false;
        }
      };

      // Export users
      window.exportUsers = function() {
        const headers = ['Display Name', 'Full Name', 'Email', 'Phone', 'Roles', 'Status', 'Registered'];
        const rows = allUsers.map(u => {
          const roles = [];
          if (u.roles.customer) roles.push('Customer');
          if (u.roles.dj) roles.push('DJ');
          if (u.roles.artist) roles.push('Artist');
          if (u.roles.merch) roles.push('Merch');

          let status = 'Basic';
          if (u.suspended) status = 'Suspended';
          else if (u.approved) status = 'Approved';
          else if (u.roles.artist || u.roles.merch) status = 'Pending';

          return [
            u.displayName,
            u.fullName,
            u.email,
            u.phone,
            roles.join(', '),
            status,
            u.registeredAt?.toISOString() || ''
          ];
        });

        const csv = [headers, ...rows].map(row => row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `freshwax-users-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Users exported', 'success');
      };
    </script>
  </Fragment>
</AdminLayout>

