---
// /src/pages/admin/orders.astro
// Fresh Wax Orders Management - Unified Admin Design
// Status flow: Digital = instant completed | Physical = pending â†’ processing â†’ shipped â†’ delivered

import AdminLayout from '../../layouts/AdminLayout.astro';
import { queryCollection, getDocument } from '../../lib/firebase-rest';

// Fetch orders via REST API
const allOrders = await queryCollection('orders', {
  orderBy: { field: 'createdAt', direction: 'DESCENDING' },
  limit: 100
});

const orders = await Promise.all(allOrders.map(async (data: any) => {
  // Get customer info if available
  let customerName = 'Guest';
  let customerEmail = data.email || '';
  let customerPhone = data.phone || '';
  let customerAddress = data.shippingAddress || data.address || null;
  let billingAddress = data.billingAddress || null;

  if (data.customerId || data.userId) {
    try {
      const customer = await getDocument('customers', data.customerId || data.userId);
      if (customer) {
        customerName = customer.fullName || customer.name || customer.displayName || 'Customer';
        customerEmail = customer.email || customerEmail;
        customerPhone = customer.phone || customerPhone;
        if (!customerAddress && customer.address) {
          customerAddress = customer.address;
        }
        if (!customerAddress && customer.shippingAddress) {
          customerAddress = customer.shippingAddress;
        }
      }
    } catch (e) {}
  }

  // Auto-deliver check: if shipped more than 14 days ago
  let status = data.status || 'pending';
  if (status === 'shipped' && data.shippedAt) {
    const shippedDate = data.shippedAt instanceof Date ? data.shippedAt : new Date(data.shippedAt);
    const daysSinceShipped = (Date.now() - shippedDate.getTime()) / (1000 * 60 * 60 * 24);
    if (daysSinceShipped >= 14) {
      status = 'delivered';
      // Note: Auto-update disabled in REST mode - use API endpoint instead
    }
  }

  return {
    id: data.id,
    ...data,
    status,
    customerName,
    customerEmail,
    customerPhone,
    customerAddress,
    billingAddress,
    paymentMethod: data.paymentMethod || data.payment?.method || 'Unknown',
    paymentStatus: data.paymentStatus || data.payment?.status || 'Unknown',
    notes: data.notes || data.customerNotes || '',
    trackingNumber: data.trackingNumber || '',
    total: data.total || data.totals?.total || 0,
    createdAt: data.createdAt instanceof Date ? data.createdAt : new Date(data.createdAt || Date.now()),
    shippedAt: data.shippedAt ? (data.shippedAt instanceof Date ? data.shippedAt : new Date(data.shippedAt)) : null,
    deliveredAt: data.deliveredAt ? (data.deliveredAt instanceof Date ? data.deliveredAt : new Date(data.deliveredAt)) : null
  };
}));

// Order type detection
function getOrderType(order) {
  const hasPhysical = order.items?.some(item => 
    item.type === 'vinyl' || item.type === 'merch' || item.isPhysical
  );
  const hasDigital = order.items?.some(item => 
    item.type === 'digital' || item.type === 'release' || !item.isPhysical
  );
  
  if (hasPhysical && hasDigital) return 'mixed';
  if (hasPhysical) return 'physical';
  return 'digital';
}

// Stats
const stats = [
  { label: 'Total Orders', value: orders.length },
  { label: 'Pending', value: orders.filter(o => o.status === 'pending').length, type: orders.filter(o => o.status === 'pending').length > 0 ? 'warning' : 'default' },
  { label: 'Processing', value: orders.filter(o => o.status === 'processing').length, type: 'info' },
  { label: 'Shipped', value: orders.filter(o => o.status === 'shipped').length, type: 'info' },
  { label: 'Delivered', value: orders.filter(o => o.status === 'delivered' || o.status === 'completed').length, type: 'success' },
];

// Format currency
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

// Format date
const formatDate = (date) => {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'short',
    hour: '2-digit',
    minute: '2-digit'
  });
};

export const prerender = false;
---

<AdminLayout title="Orders" activeNav="orders" showStats={true} stats={stats}>
  <Fragment slot="actions">
    <button class="btn btn-outline" onclick="window.location.reload()">
      â†» Refresh
    </button>
  </Fragment>

  <!-- Filters -->
  <div class="toolbar">
    <div class="filter-group">
      <label class="filter-label">Status</label>
      <select id="statusFilter" class="form-select" style="width: auto; padding: 0.5rem 1rem;">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label class="filter-label">Type</label>
      <select id="typeFilter" class="form-select" style="width: auto; padding: 0.5rem 1rem;">
        <option value="">All</option>
        <option value="digital">Digital Only</option>
        <option value="physical">Physical</option>
        <option value="mixed">Mixed</option>
      </select>
    </div>
    
    <div class="search-wrapper" style="flex: 1; max-width: 300px;">
      <span class="search-icon">ğŸ”</span>
      <input 
        type="text" 
        id="searchInput" 
        class="form-input" 
        placeholder="Search orders..."
      >
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <div class="card-header">
      <h2>All Orders</h2>
      <span class="text-muted">{orders.length} orders</span>
    </div>
    <div class="table-wrapper">
      <table class="data-table" id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Type</th>
            <th>Total</th>
            <th>Status</th>
            <th>Date</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {orders.length === 0 ? (
            <tr>
              <td colspan="8" class="text-center text-muted" style="padding: 3rem;">
                No orders found
              </td>
            </tr>
          ) : (
            orders.map(order => {
              const orderType = getOrderType(order);
              return (
                <tr 
                  data-status={order.status}
                  data-type={orderType}
                  data-search={`${order.id} ${order.customerName} ${order.customerEmail}`.toLowerCase()}
                >
                  <td>
                    <span class="cell-mono">#{order.id?.slice(-8).toUpperCase()}</span>
                  </td>
                  <td>
                    <div class="item-info">
                      <h4 style="font-size: 0.875rem;">{order.customerName}</h4>
                      <p style="font-size: 0.75rem;">{order.customerEmail}</p>
                    </div>
                  </td>
                  <td class="cell-secondary">
                    {order.items?.length || 0} item{(order.items?.length || 0) !== 1 ? 's' : ''}
                  </td>
                  <td>
                    <span class={`badge badge-${orderType === 'digital' ? 'info' : orderType === 'physical' ? 'pending' : 'shipped'}`}>
                      {orderType === 'digital' ? 'ğŸ’¿' : orderType === 'physical' ? 'ğŸ“¦' : 'ğŸ“¦ğŸ’¿'} {orderType}
                    </span>
                  </td>
                  <td class="font-bold">
                    {formatCurrency(order.totals?.total || order.total)}
                  </td>
                  <td>
                    <span class={`badge badge-${order.status}`}>
                      {order.status}
                    </span>
                  </td>
                  <td class="cell-secondary">
                    {formatDate(order.createdAt)}
                  </td>
                  <td class="text-right">
                    <div class="flex gap-1 justify-end">
                      <button 
                        class="btn btn-ghost btn-sm view-btn"
                        data-order={JSON.stringify(order)}
                        title="View Details"
                      >
                        ğŸ‘ï¸
                      </button>
                      {(order.status === 'pending' || order.status === 'processing' || order.status === 'shipped') && (
                        <button 
                          class="btn btn-primary btn-sm status-btn"
                          data-id={order.id}
                          data-status={order.status}
                          title="Update Status"
                        >
                          â†’
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="orderModal" class="modal-overlay" slot="modals">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Order Details</h2>
        <button class="modal-close" onclick="closeModal('orderModal')">&times;</button>
      </div>
      <div class="modal-body" id="orderModalContent">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('orderModal')">Close</button>
      </div>
    </div>
  </div>

  <Fragment slot="scripts">
    <script is:inline>
      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
      };

      // Filter functionality
      const statusFilter = document.getElementById('statusFilter');
      const typeFilter = document.getElementById('typeFilter');
      const searchInput = document.getElementById('searchInput');
      const tableRows = document.querySelectorAll('#ordersTable tbody tr');

      function filterOrders() {
        const status = statusFilter?.value || '';
        const type = typeFilter?.value || '';
        const search = searchInput?.value?.toLowerCase() || '';

        tableRows.forEach(row => {
          const rowStatus = row.dataset.status || '';
          const rowType = row.dataset.type || '';
          const rowSearch = row.dataset.search || '';

          const matchStatus = !status || rowStatus === status;
          const matchType = !type || rowType === type;
          const matchSearch = !search || rowSearch.includes(search);

          row.style.display = (matchStatus && matchType && matchSearch) ? '' : 'none';
        });
      }

      statusFilter?.addEventListener('change', filterOrders);
      typeFilter?.addEventListener('change', filterOrders);
      searchInput?.addEventListener('input', filterOrders);

      // View order details
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const order = JSON.parse(btn.dataset.order);
          showOrderDetails(order);
        });
      });

      function showOrderDetails(order) {
        const content = document.getElementById('orderModalContent');
        
        const itemsHtml = (order.items || []).map(item => `
          <div style="display: flex; gap: 1rem; padding: 0.75rem; background: #f5f5f5; margin-bottom: 0.5rem;">
            ${item.artwork || item.image ? `<img src="${item.artwork || item.image}" style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #000;">` : ''}
            <div style="flex: 1;">
              <div style="font-weight: 600;">${item.title || item.name || 'Unknown Item'}</div>
              <div style="font-size: 0.75rem; color: #666;">${item.artist || ''} ${item.type ? 'â€¢ ' + item.type : ''}</div>
              ${item.quantity > 1 ? `<div style="font-size: 0.75rem; color: #666;">Qty: ${item.quantity}</div>` : ''}
              ${item.size ? `<div style="font-size: 0.75rem; color: #666;">Size: ${item.size}</div>` : ''}
            </div>
            <div style="font-weight: 700;">${formatCurrency(item.price)}</div>
          </div>
        `).join('');

        // Format address
        const formatAddress = (addr) => {
          if (!addr) return '<span style="color: #888;">No address provided</span>';
          const parts = [];
          if (addr.name) parts.push(`<strong>${addr.name}</strong>`);
          if (addr.line1 || addr.address1) parts.push(addr.line1 || addr.address1);
          if (addr.line2 || addr.address2) parts.push(addr.line2 || addr.address2);
          const cityLine = [addr.city, addr.postcode || addr.postalCode].filter(Boolean).join(', ');
          if (cityLine) parts.push(cityLine);
          if (addr.country) parts.push(addr.country);
          return parts.join('<br>') || '<span style="color: #888;">No address</span>';
        };

        // Format date nicely
        const formatDateTime = (date) => {
          if (!date) return '-';
          return new Date(date).toLocaleString('en-GB', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        };

        content.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div>
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem;">Order ID</div>
              <div style="font-weight: 700; font-family: monospace;">#${order.id?.slice(-8).toUpperCase()}</div>
            </div>
            <div>
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem;">Status</div>
              <span class="badge badge-${order.status}">${order.status}</span>
            </div>
            <div>
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem;">Order Date</div>
              <div>${formatDateTime(order.createdAt)}</div>
            </div>
            <div>
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem;">Total</div>
              <div style="font-weight: 700; font-size: 1.25rem;">${formatCurrency(order.totals?.total || order.total)}</div>
            </div>
          </div>
          
          <!-- Customer Info -->
          <div style="background: #f9f9f9; border: 1px solid #e5e5e5; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.75rem; font-weight: 600;">Customer Details</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <div style="font-weight: 600; margin-bottom: 0.25rem;">${order.customerName}</div>
                <div style="font-size: 0.875rem; color: #666;">${order.customerEmail}</div>
                ${order.customerPhone ? `<div style="font-size: 0.875rem; color: #666;">ğŸ“ ${order.customerPhone}</div>` : ''}
              </div>
              <div>
                <div style="font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem;">Payment</div>
                <div style="font-size: 0.875rem;">${order.paymentMethod || 'Not specified'}</div>
              </div>
            </div>
          </div>
          
          <!-- Shipping Address -->
          <div style="background: #fff8e6; border: 1px solid #f0d78c; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“¦ Shipping Address</div>
            <div style="line-height: 1.6;">
              ${formatAddress(order.customerAddress)}
            </div>
          </div>
          
          ${order.trackingNumber ? `
            <div style="background: #e8f5e9; border: 1px solid #a5d6a7; padding: 1rem; margin-bottom: 1.5rem;">
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem;">Tracking Number</div>
              <div style="font-weight: 600; font-family: monospace;">${order.trackingNumber}</div>
            </div>
          ` : ''}
          
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Items (${order.items?.length || 0})</div>
            ${itemsHtml || '<div style="color: #888;">No items</div>'}
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #000; color: #fff; font-weight: 700; margin-top: 0.5rem;">
              <span>Total</span>
              <span>${formatCurrency(order.totals?.total || order.total)}</span>
            </div>
          </div>
          
          ${order.notes ? `
            <div style="margin-bottom: 1.5rem;">
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Customer Notes</div>
              <div style="padding: 0.75rem; background: #f5f5f5; font-style: italic;">${order.notes}</div>
            </div>
          ` : ''}
          
          <!-- Timeline -->
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem;">Order Timeline</div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="width: 24px; height: 24px; background: #16a34a; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">âœ“</span>
                <div>
                  <div style="font-weight: 600;">Order Placed</div>
                  <div style="font-size: 0.75rem; color: #666;">${formatDateTime(order.createdAt)}</div>
                </div>
              </div>
              ${order.shippedAt ? `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  <span style="width: 24px; height: 24px; background: #16a34a; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">âœ“</span>
                  <div>
                    <div style="font-weight: 600;">Shipped</div>
                    <div style="font-size: 0.75rem; color: #666;">${formatDateTime(order.shippedAt)}</div>
                  </div>
                </div>
              ` : ''}
              ${order.deliveredAt ? `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  <span style="width: 24px; height: 24px; background: #16a34a; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">âœ“</span>
                  <div>
                    <div style="font-weight: 600;">Delivered</div>
                    <div style="font-size: 0.75rem; color: #666;">${formatDateTime(order.deliveredAt)}</div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          ${(order.status === 'pending' || order.status === 'processing' || order.status === 'shipped') ? `
            <div style="padding-top: 1rem; border-top: 1px solid #e5e5e5;">
              <button class="btn btn-primary" onclick="updateOrderStatus('${order.id}', '${order.status}')">
                ${order.status === 'pending' ? 'â†’ Mark as Processing' : order.status === 'processing' ? 'ğŸ“¦ Mark as Shipped' : 'âœ“ Mark as Delivered'}
              </button>
            </div>
          ` : ''}
        `;

        openModal('orderModal');
      }

      // Update order status
      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const currentStatus = btn.dataset.status;
          updateOrderStatus(id, currentStatus);
        });
      });

      async function updateOrderStatus(id, currentStatus) {
        const nextStatus = {
          'pending': 'processing',
          'processing': 'shipped',
          'shipped': 'delivered'
        }[currentStatus];

        if (!nextStatus) return;

        if (!confirm(`Update order to "${nextStatus}"?`)) return;

        try {
          const response = await fetch('/api/admin/update-order-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: id, status: nextStatus })
          });

          if (!response.ok) throw new Error('Failed to update');

          showToast(`Order updated to ${nextStatus}`);
          setTimeout(() => location.reload(), 1000);

        } catch (error) {
          console.error(error);
          showToast('Failed to update order', 'error');
        }
      }

      window.updateOrderStatus = updateOrderStatus;
    </script>
  </Fragment>
</AdminLayout>
