---
// src/pages/admin/inventory/index.astro
// Stock inventory management - receive, adjust, and track merch stock
import '../../../styles/admin/inventory.css';
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Management | Fresh Wax Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
</head>
<body>
  <header class="header">
    <h1>Fresh <span style="color: #dc2626;">Wax</span> Inventory</h1>
    <nav class="header-nav">
      <a href="/admin">Dashboard</a>
      <a href="/admin/merch/upload">Add Product</a>
    </nav>
  </header>

  <div class="container">
    <h1 class="page-title">Inventory Management</h1>
    <p class="page-subtitle">Receive stock, adjust quantities, and track inventory movements</p>
    
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-value" id="totalProducts">-</div>
        <div class="stat-label">Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalStock">-</div>
        <div class="stat-label">Total Units</div>
      </div>
      <div class="stat-card">
        <div class="stat-value warning" id="lowStockCount">-</div>
        <div class="stat-label">Low Stock</div>
      </div>
      <div class="stat-card">
        <div class="stat-value danger" id="outOfStockCount">-</div>
        <div class="stat-label">Out of Stock</div>
      </div>
    </div>
    
    <div class="section">
      <div class="tabs">
        <button class="tab active" data-tab="receive">Receive Stock</button>
        <button class="tab" data-tab="stock">Stock Levels</button>
        <button class="tab" data-tab="stocktake">Stock Take</button>
        <button class="tab" data-tab="movements">Movement Log</button>
      </div>
      
      <!-- Receive Stock Tab -->
      <div class="tab-content active" id="tab-receive">
        <div class="receive-form">
          <div class="form-group product-search">
            <label class="form-label">Search Product</label>
            <input type="text" class="form-input" id="productSearch" placeholder="Type product name or SKU...">
            <div class="product-search-results" id="searchResults"></div>
          </div>
          
          <div class="selected-product" id="selectedProduct">
            <img src="" alt="" id="selectedProductImage">
            <div class="selected-product-info">
              <div class="selected-product-name" id="selectedProductName"></div>
              <div class="selected-product-sku" id="selectedProductSku"></div>
            </div>
            <button class="selected-product-clear" onclick="clearSelectedProduct()">Clear</button>
          </div>
          
          <div class="form-group" id="variantSelectorGroup" style="display: none;">
            <label class="form-label">Select Variant</label>
            <div class="variant-selector" id="variantSelector"></div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Quantity to Receive</label>
              <input type="number" class="form-input" id="receiveQty" min="1" value="1">
            </div>
            <div class="form-group">
              <label class="form-label">Operation</label>
              <select class="form-select" id="operationType">
                <option value="receive">Receive New Stock</option>
                <option value="adjust">Adjust (+ or -)</option>
                <option value="return">Customer Return</option>
                <option value="damaged">Mark as Damaged</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes (Optional)</label>
            <input type="text" class="form-input" id="receiveNotes" placeholder="e.g., Supplier delivery #12345">
          </div>
          
          <button class="btn btn-success" id="submitReceive" disabled>
            <span id="submitText">Receive Stock</span>
          </button>
        </div>
      </div>
      
      <!-- Stock Levels Tab -->
      <div class="tab-content" id="tab-stock">
        <div class="filters">
          <div class="filter-group">
            <span class="filter-label">Filter:</span>
            <select class="filter-select" id="stockFilter">
              <option value="all">All Products</option>
              <option value="low">Low Stock Only</option>
              <option value="out">Out of Stock Only</option>
              <option value="in">In Stock Only</option>
            </select>
          </div>
          <div class="filter-group">
            <input type="text" class="filter-input" id="stockSearch" placeholder="Search products...">
          </div>
        </div>
        
        <table class="stock-table">
          <thead>
            <tr>
              <th style="width:30px;"></th>
              <th>Product</th>
              <th style="text-align: center;">Category</th>
              <th style="text-align: center;">Stock</th>
              <th style="text-align: center;">Reserved</th>
              <th style="text-align: center;">Sold</th>
              <th style="text-align: center;">Status</th>
              <th style="text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="stockTableBody">
            <tr>
              <td colspan="8" class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <p>Loading inventory...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Stock Take Tab -->
      <div class="tab-content" id="tab-stocktake">
        <div class="print-date" id="printDate"></div>
        
        <div class="stocktake-header no-print">
          <div class="stocktake-filters">
            <div class="filter-group">
              <span class="filter-label">Supplier:</span>
              <select class="filter-select" id="supplierFilter">
                <option value="all">All Suppliers</option>
              </select>
            </div>
            <div class="filter-group">
              <span class="filter-label">Category:</span>
              <select class="filter-select" id="categoryFilter">
                <option value="all">All Categories</option>
                <option value="clothing">Clothing</option>
                <option value="accessories">Accessories</option>
                <option value="vinyl">Vinyl</option>
                <option value="prints">Prints</option>
              </select>
            </div>
          </div>
          <div class="stocktake-actions">
            <button class="print-btn" onclick="printStockTake()">
              üñ®Ô∏è Print Report
            </button>
            <button class="btn btn-primary" onclick="saveStockTake()">
              üíæ Save Changes
            </button>
          </div>
        </div>
        
        <div id="stocktakeContent">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>Loading stock take data...</p>
          </div>
        </div>
        
        <div class="stocktake-summary no-print" id="stocktakeSummary" style="display: none;">
          <h3 style="margin-bottom: 1rem; font-family: 'Bebas Neue', sans-serif;">Stock Take Summary</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-value" id="summaryProducts">0</div>
              <div class="summary-label">Products</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="summaryVariants">0</div>
              <div class="summary-label">Size Variants</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="summaryTotalStock">0</div>
              <div class="summary-label">Total Units</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="summaryChanges">0</div>
              <div class="summary-label">Pending Changes</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Movement Log Tab -->
      <div class="tab-content" id="tab-movements">
        <div class="filters">
          <div class="filter-group">
            <span class="filter-label">Type:</span>
            <select class="filter-select" id="movementFilter">
              <option value="all">All Movements</option>
              <option value="receive">Received</option>
              <option value="sell">Sold</option>
              <option value="adjust">Adjusted</option>
              <option value="damaged">Damaged</option>
              <option value="return">Returns</option>
            </select>
          </div>
        </div>
        
        <div class="movement-log" id="movementLog">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>Loading movement history...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Quick Receive Modal -->
  <div class="modal-overlay" id="quickReceiveModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Quick Stock Update</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalProductInfo" style="margin-bottom: 1rem;"></div>
        <div class="form-group" id="modalVariants" style="margin-bottom: 1rem;"></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-input" id="modalQty" value="1" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Operation</label>
            <select class="form-select" id="modalOperation">
              <option value="receive">Receive</option>
              <option value="adjust">Adjust</option>
              <option value="damaged">Damaged</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input type="text" class="form-input" id="modalNotes" placeholder="Optional notes...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="submitModalUpdate()">Update Stock</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <script>
    let allProducts = [];
    let selectedProduct = null;
    let selectedVariant = null;
    let modalProduct = null;
    let modalVariant = null;
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });
    
    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // Check URL params for supplier filter
    const urlParams = new URLSearchParams(window.location.search);
    const supplierFromUrl = urlParams.get('supplier');
    
    // Load all data
    async function loadData() {
      try {
        const response = await fetch('/api/update-stock');
        const data = await response.json();
        
        if (data.success) {
          allProducts = data.products || [];
          
          // If supplier filter from URL, filter products
          if (supplierFromUrl) {
            allProducts = allProducts.filter(p => 
              (p.supplier || p.supplierName || 'Fresh Wax').toLowerCase() === supplierFromUrl.toLowerCase()
            );
            // Update page title to show filtered view
            document.querySelector('h1').textContent = `üì¶ ${supplierFromUrl} - Inventory`;
          }
          
          document.getElementById('totalProducts').textContent = allProducts.length || 0;
          document.getElementById('totalStock').textContent = allProducts.reduce((sum, p) => sum + (p.totalStock || 0), 0).toLocaleString();
          document.getElementById('lowStockCount').textContent = allProducts.filter(p => p.isLowStock).length || 0;
          document.getElementById('outOfStockCount').textContent = allProducts.filter(p => p.isOutOfStock).length || 0;
          
          renderStockTable();
        }
      } catch (err) {
        console.error('Failed to load data:', err);
      }
      
      loadMovements();
    }
    
    // Load movement history
    async function loadMovements() {
      try {
        const response = await fetch('/api/get-stock-movements');
        const data = await response.json();
        
        if (data.success && data.movements) {
          renderMovements(data.movements);
        }
      } catch (err) {
        console.error('Failed to load movements');
      }
    }
    
    // Render stock table with expandable sizes
    function renderStockTable(filter = 'all', search = '') {
      const tbody = document.getElementById('stockTableBody');
      
      let filtered = allProducts;
      
      if (filter === 'low') filtered = filtered.filter(p => p.isLowStock);
      else if (filter === 'out') filtered = filtered.filter(p => p.isOutOfStock);
      else if (filter === 'in') filtered = filtered.filter(p => p.totalStock > 0);
      
      if (search) {
        const s = search.toLowerCase();
        filtered = filtered.filter(p => 
          (p.name || '').toLowerCase().includes(s) || 
          (p.sku || '').toLowerCase().includes(s)
        );
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 3rem; color: #666;"><div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div><p>No products found</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(product => {
        let statusClass = 'in-stock';
        let statusText = 'In Stock';
        if (product.isOutOfStock) { statusClass = 'out-of-stock'; statusText = 'Out of Stock'; }
        else if (product.isLowStock) { statusClass = 'low-stock'; statusText = 'Low Stock'; }
        
        const variantStock = product.variantStock || {};
        const variantKeys = Object.keys(variantStock);
        const hasVariants = variantKeys.length > 1 || (variantKeys.length === 1 && variantKeys[0] !== 'default');
        
        // Build sizes grid HTML
        let sizesHtml = '';
        if (hasVariants) {
          const gridStyle = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; padding: 1rem; margin-left: 60px; background: #f5f5f5; border-left: 3px solid #000;';
          const itemBaseStyle = 'background: #fff; border: 2px solid #ddd; padding: 0.5rem; text-align: center;';
          const labelStyle = 'font-weight: 700; font-size: 0.875rem;';
          const stockStyle = 'font-size: 1.25rem; font-weight: 800;';
          const actionsStyle = 'display: flex; gap: 0.25rem; margin-top: 0.5rem; justify-content: center;';
          const btnBaseStyle = 'width: 28px; height: 28px; border: 1px solid #000; background: #fff; cursor: pointer; font-weight: 700; font-size: 0.875rem;';
          
          sizesHtml = `
            <tr id="sizes-${product.productId}" style="display: none;">
              <td colspan="8" style="padding: 0 !important; background: #f9f9f9;">
                <div style="${gridStyle}">
                  ${variantKeys.map(key => {
                    const v = variantStock[key];
                    const stock = v.stock || 0;
                    let itemStyle = itemBaseStyle;
                    if (stock === 0) itemStyle += ' border-color: #dc2626; background: #fef2f2;';
                    else if (stock <= 3) itemStyle += ' border-color: #f59e0b; background: #fffbeb;';
                    const label = v.size || v.color || key;
                    return `
                      <div style="${itemStyle}">
                        <div style="${labelStyle}">${label}</div>
                        <div style="${stockStyle}">${stock}</div>
                        <div style="${actionsStyle}">
                          <button style="${btnBaseStyle} color: #dc2626; border-color: #dc2626;" onclick="quickAdjust('${product.productId}', '${key}', -1)">‚àí</button>
                          <button style="${btnBaseStyle} color: #22c55e; border-color: #22c55e;" onclick="quickAdjust('${product.productId}', '${key}', 1)">+</button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </td>
            </tr>
          `;
        }
        
        return `
          <tr>
            <td style="width:30px; text-align: center;">
              ${hasVariants ? `<button id="expand-btn-${product.productId}" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0.25rem;" onclick="toggleSizes('${product.productId}')">‚ñ∂</button>` : ''}
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <img src="${product.images?.[0]?.url || product.primaryImage || '/place-holder.webp'}" alt="" style="width: 50px; height: 50px; object-fit: cover; border: 1px solid #ddd;">
                <div>
                  <div style="font-weight: 600;">${product.name || 'Unknown'}</div>
                  <div style="font-size: 0.75rem; color: #666;">${product.sku || '-'}</div>
                </div>
              </div>
            </td>
            <td style="text-align: center;">${product.category || '-'}</td>
            <td style="text-align: center;"><strong>${product.totalStock || 0}</strong></td>
            <td style="text-align: center;">${product.reservedStock || 0}</td>
            <td style="text-align: center;">${product.soldStock || 0}</td>
            <td style="text-align: center;"><span style="padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 700; border-radius: 4px; ${statusClass === 'in-stock' ? 'background: #dcfce7; color: #166534;' : statusClass === 'low-stock' ? 'background: #fef3c7; color: #92400e;' : 'background: #fee2e2; color: #991b1b;'}">${statusText}</span></td>
            <td style="text-align: center;">
              <div style="display: flex; gap: 0.5rem; justify-content: center;">
                <button style="padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 700; border: 2px solid #22c55e; color: #22c55e; background: #fff; cursor: pointer;" onclick="openQuickReceive('${product.productId}')">+ Receive</button>
                <button style="padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 700; border: 2px solid #f59e0b; color: #f59e0b; background: #fff; cursor: pointer;" onclick="openQuickReceive('${product.productId}', 'adjust')">Adjust</button>
              </div>
            </td>
          </tr>
          ${sizesHtml}
        `;
      }).join('');
    }
    
    // Toggle sizes visibility
    function toggleSizes(productId) {
      const row = document.getElementById(`sizes-${productId}`);
      const btn = document.getElementById(`expand-btn-${productId}`);
      if (row) {
        const isHidden = row.style.display === 'none';
        row.style.display = isHidden ? 'table-row' : 'none';
        if (btn) btn.textContent = isHidden ? '‚ñº' : '‚ñ∂';
      }
    }
    
    // Quick adjust stock by +/- 1
    async function quickAdjust(productId, variantKey, delta) {
      try {
        const response = await fetch('/api/update-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId,
            variantKey,
            operation: 'adjust',
            quantity: delta,
            notes: 'Quick adjustment'
          })
        });
        
        const data = await response.json();
        if (data.success) {
          showToast(`Stock: ${data.previousStock} ‚Üí ${data.newStock}`, 'success');
          loadData();
        } else {
          showToast(data.error || 'Failed to adjust', 'error');
        }
      } catch (err) {
        showToast('Error adjusting stock', 'error');
      }
    }
    
    // Render movements
    function renderMovements(movements) {
      const container = document.getElementById('movementLog');
      
      if (!movements || movements.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #666;"><div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div><p>No movements recorded yet</p></div>';
        return;
      }
      
      const icons = {
        receive: 'üì•',
        sell: 'üí∞',
        adjust: 'üìù',
        damaged: '‚ö†Ô∏è',
        return: '‚Ü©Ô∏è',
        reserve: 'üîí',
        unreserve: 'üîì',
        set: 'üìù'
      };
      
      const iconBgColors = {
        receive: '#dcfce7',
        sell: '#fee2e2',
        adjust: '#fef3c7',
        damaged: '#fecaca',
        return: '#dbeafe',
        reserve: '#f3e8ff',
        unreserve: '#f3e8ff',
        set: '#fef3c7'
      };
      
      const itemStyle = 'display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid #eee;';
      const iconStyle = 'width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;';
      const titleStyle = 'font-weight: 600;';
      const metaStyle = 'font-size: 0.75rem; color: #666;';
      
      container.innerHTML = movements.slice(0, 50).map(m => {
        const isPositive = m.stockDelta > 0;
        const date = new Date(m.createdAt).toLocaleDateString('en-GB', { 
          day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
        const qtyColor = isPositive ? '#22c55e' : '#dc2626';
        const bgColor = iconBgColors[m.type] || '#f5f5f5';
        
        return `
          <div style="${itemStyle}">
            <div style="${iconStyle} background: ${bgColor};">${icons[m.type] || 'üì¶'}</div>
            <div style="flex: 1;">
              <div style="${titleStyle}">${m.productName || 'Unknown Product'}</div>
              <div style="${metaStyle}">${m.type.toUpperCase()} ‚Ä¢ ${m.variantKey || 'default'} ‚Ä¢ ${date}</div>
              ${m.notes ? `<div style="${metaStyle}">${m.notes}</div>` : ''}
            </div>
            <div style="font-weight: 700; font-size: 1.125rem; color: ${qtyColor};">
              ${isPositive ? '+' : ''}${m.stockDelta}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Product search
    let searchTimeout;
    document.getElementById('productSearch').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim().toLowerCase();
      
      if (query.length < 2) {
        document.getElementById('searchResults').classList.remove('show');
        return;
      }
      
      searchTimeout = setTimeout(() => {
        const results = allProducts.filter(p => 
          (p.name || '').toLowerCase().includes(query) || 
          (p.sku || '').toLowerCase().includes(query)
        ).slice(0, 10);
        
        const container = document.getElementById('searchResults');
        
        const resultStyle = 'padding: 0.75rem 1rem; cursor: pointer; display: flex; gap: 1rem; align-items: center; border-bottom: 1px solid #eee;';
        const imgStyle = 'width: 40px; height: 40px; object-fit: cover; border: 1px solid #ddd;';
        const nameStyle = 'font-weight: 600;';
        const skuStyle = 'font-size: 0.75rem; color: #666;';
        const stockStyle = 'font-size: 0.875rem; font-weight: 700;';
        
        if (results.length === 0) {
          container.innerHTML = `<div style="${resultStyle}"><div>No products found</div></div>`;
        } else {
          container.innerHTML = results.map(p => `
            <div style="${resultStyle}" data-product-id="${p.productId}" class="search-result-item" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
              <img src="${p.images?.[0]?.url || p.primaryImage || '/place-holder.webp'}" alt="" style="${imgStyle}">
              <div style="flex: 1;">
                <div style="${nameStyle}">${p.name}</div>
                <div style="${skuStyle}">${p.sku || '-'}</div>
              </div>
              <div style="${stockStyle}">${p.totalStock || 0} units</div>
            </div>
          `).join('');
          
          // Add click handlers using event delegation
          container.querySelectorAll('.search-result-item').forEach(el => {
            el.addEventListener('click', (e) => {
              e.stopPropagation();
              const productId = el.dataset.productId;
              selectProduct(productId);
            });
          });
        }
        
        container.classList.add('show');
      }, 200);
    });
    
    // Close search on click outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.product-search')) {
        document.getElementById('searchResults').classList.remove('show');
      }
    });
    
    // Select product
    function selectProduct(productId) {
      const product = allProducts.find(p => p.productId === productId);
      if (!product) return;
      
      selectedProduct = product;
      selectedVariant = null;
      
      document.getElementById('searchResults').classList.remove('show');
      document.getElementById('productSearch').value = '';
      
      document.getElementById('selectedProductImage').src = product.images?.[0]?.url || product.primaryImage || '/place-holder.webp';
      document.getElementById('selectedProductName').textContent = product.name;
      document.getElementById('selectedProductSku').textContent = product.sku || '-';
      document.getElementById('selectedProduct').classList.add('show');
      
      // Show variants
      const variantStock = product.variantStock || {};
      const variantKeys = Object.keys(variantStock);
      
      if (variantKeys.length > 1) {
        const optionStyle = 'padding: 0.75rem; border: 2px solid #ddd; cursor: pointer; text-align: center; transition: all 0.2s;';
        const labelStyle = 'font-weight: 600; font-size: 0.875rem;';
        const stockLabelStyle = 'font-size: 0.75rem; color: #666;';
        
        document.getElementById('variantSelectorGroup').style.display = 'block';
        const variantContainer = document.getElementById('variantSelector');
        variantContainer.innerHTML = variantKeys.map(key => {
          const v = variantStock[key];
          return `
            <div style="${optionStyle}" class="variant-option" data-variant-key="${key}">
              <div style="${labelStyle}">${v.size || ''} ${v.color || ''}</div>
              <div style="${stockLabelStyle}">${v.stock || 0} in stock</div>
            </div>
          `;
        }).join('');
        
        // Add click handlers
        variantContainer.querySelectorAll('.variant-option').forEach(el => {
          el.addEventListener('click', () => {
            const key = el.dataset.variantKey;
            selectedVariant = key;
            variantContainer.querySelectorAll('.variant-option').forEach(opt => {
              opt.style.borderColor = '#ddd';
              opt.style.background = '#fff';
            });
            el.style.borderColor = '#22c55e';
            el.style.background = '#f0fdf4';
            updateSubmitButton();
          });
        });
      } else if (variantKeys.length === 1) {
        selectedVariant = variantKeys[0];
        document.getElementById('variantSelectorGroup').style.display = 'none';
      } else {
        // No variants - use 'default'
        selectedVariant = 'default';
        document.getElementById('variantSelectorGroup').style.display = 'none';
      }
      
      updateSubmitButton();
    }
    
    // Select variant
    function selectVariant(key) {
      selectedVariant = key;
      document.querySelectorAll('.variant-option').forEach(el => el.classList.remove('selected'));
      event.target.closest('.variant-option').classList.add('selected');
      updateSubmitButton();
    }
    
    // Clear selected product
    function clearSelectedProduct() {
      selectedProduct = null;
      selectedVariant = null;
      document.getElementById('selectedProduct').classList.remove('show');
      document.getElementById('variantSelectorGroup').style.display = 'none';
      updateSubmitButton();
    }
    
    // Update submit button state
    function updateSubmitButton() {
      const btn = document.getElementById('submitReceive');
      const hasProduct = selectedProduct !== null;
      const hasVariant = selectedVariant !== null || Object.keys(selectedProduct?.variantStock || {}).length <= 1;
      btn.disabled = !(hasProduct && hasVariant);
    }
    
    // Submit receive
    document.getElementById('submitReceive').addEventListener('click', async () => {
      if (!selectedProduct || !selectedVariant) {
        showToast('Please select a product and variant', 'error');
        return;
      }
      
      const qty = parseInt(document.getElementById('receiveQty').value) || 0;
      const operation = document.getElementById('operationType').value;
      const notes = document.getElementById('receiveNotes').value.trim();
      
      if (qty <= 0 && operation !== 'adjust') {
        showToast('Please enter a valid quantity', 'error');
        return;
      }
      
      const btn = document.getElementById('submitReceive');
      btn.disabled = true;
      document.getElementById('submitText').textContent = 'Processing...';
      
      try {
        const response = await fetch('/api/update-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId: selectedProduct.productId,
            variantKey: selectedVariant,
            operation: operation,
            quantity: qty,
            notes: notes
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showToast(`Stock updated: ${data.previousStock} ‚Üí ${data.newStock}`, 'success');
          clearSelectedProduct();
          document.getElementById('receiveQty').value = 1;
          document.getElementById('receiveNotes').value = '';
          loadData();
        } else {
          showToast(data.error || 'Failed to update stock', 'error');
        }
      } catch (err) {
        showToast('Error updating stock', 'error');
      }
      
      btn.disabled = false;
      document.getElementById('submitText').textContent = 'Receive Stock';
    });
    
    // Stock filter
    document.getElementById('stockFilter').addEventListener('change', (e) => {
      renderStockTable(e.target.value, document.getElementById('stockSearch').value);
    });
    
    document.getElementById('stockSearch').addEventListener('input', (e) => {
      renderStockTable(document.getElementById('stockFilter').value, e.target.value);
    });
    
    // Movement filter
    document.getElementById('movementFilter').addEventListener('change', async (e) => {
      // Would need to implement filtered API call
    });
    
    // Quick receive modal
    function openQuickReceive(productId, operation = 'receive') {
      modalProduct = allProducts.find(p => p.productId === productId);
      if (!modalProduct) return;
      
      document.getElementById('modalProductInfo').innerHTML = `
        <strong>${modalProduct.name}</strong><br>
        <span style="color: #666; font-size: 0.875rem;">${modalProduct.sku || '-'}</span>
      `;
      
      const variantStock = modalProduct.variantStock || {};
      const variantKeys = Object.keys(variantStock);
      
      if (variantKeys.length > 1) {
        document.getElementById('modalVariants').innerHTML = `
          <label class="form-label">Variant</label>
          <select class="form-select" id="modalVariantSelect">
            ${variantKeys.map(k => {
              const v = variantStock[k];
              return `<option value="${k}">${v.size || ''} ${v.color || ''} (${v.stock || 0})</option>`;
            }).join('')}
          </select>
        `;
        modalVariant = variantKeys[0];
        document.getElementById('modalVariantSelect').addEventListener('change', (e) => {
          modalVariant = e.target.value;
        });
      } else {
        document.getElementById('modalVariants').innerHTML = '';
        modalVariant = variantKeys[0] || 'default';
      }
      
      document.getElementById('modalOperation').value = operation;
      document.getElementById('modalQty').value = 1;
      document.getElementById('modalNotes').value = '';
      
      document.getElementById('quickReceiveModal').classList.add('show');
    }
    
    function closeModal() {
      document.getElementById('quickReceiveModal').classList.remove('show');
      modalProduct = null;
      modalVariant = null;
    }
    
    async function submitModalUpdate() {
      if (!modalProduct || !modalVariant) return;
      
      const qty = parseInt(document.getElementById('modalQty').value) || 0;
      const operation = document.getElementById('modalOperation').value;
      const notes = document.getElementById('modalNotes').value.trim();
      
      try {
        const response = await fetch('/api/update-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId: modalProduct.productId,
            variantKey: modalVariant,
            operation: operation,
            quantity: qty,
            notes: notes
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showToast(`Stock updated: ${data.previousStock} ‚Üí ${data.newStock}`, 'success');
          closeModal();
          loadData();
        } else {
          showToast(data.error || 'Failed to update stock', 'error');
        }
      } catch (err) {
        showToast('Error updating stock', 'error');
      }
    }
    
    // ===== STOCK TAKE FUNCTIONS =====
    let stockTakeChanges = {}; // Track pending changes: { productId_variantKey: { counted: X, reason: '' } }
    let allSuppliers = new Set();
    
    // Render stock take view
    function renderStockTake(supplierFilter = 'all', categoryFilter = 'all') {
      const container = document.getElementById('stocktakeContent');
      
      // Define inline styles - must include display properties for table elements
      const sectionStyle = 'margin-bottom: 2rem; page-break-inside: avoid;';
      const supplierHeaderStyle = 'background: #dc2626; color: #fff; padding: 0.75rem 1rem; font-weight: 700; font-size: 1rem;';
      const tableStyle = 'width: 100%; border-collapse: collapse; font-size: 0.875rem; display: table;';
      const theadStyle = 'display: table-header-group;';
      const tbodyStyle = 'display: table-row-group;';
      const trStyle = 'display: table-row;';
      const thStyle = 'display: table-cell; background: #000; color: #fff; padding: 0.75rem; text-align: left; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; white-space: nowrap;';
      const tdStyle = 'display: table-cell; padding: 0.5rem 0.75rem; border-bottom: 1px solid #ddd; vertical-align: middle;';
      const productRowBg = 'background: #e5e5e5;';
      const sizeIndent = 'padding-left: 2rem;';
      const inputStyle = 'width: 70px; padding: 0.25rem; border: 2px solid #ddd; text-align: center; font-weight: 700;';
      const reasonInputStyle = 'width: 120px; padding: 0.25rem; border: 1px solid #ddd; font-size: 0.75rem;';
      const emptyStyle = 'text-align: center; padding: 3rem; color: #666;';
      const skuStyle = 'font-family: monospace; font-size: 0.7rem;';
      
      // Filter products
      let filtered = allProducts;
      if (supplierFilter !== 'all') {
        filtered = filtered.filter(p => (p.supplier || 'Fresh Wax') === supplierFilter);
      }
      if (categoryFilter !== 'all') {
        filtered = filtered.filter(p => (p.category || '').toLowerCase() === categoryFilter.toLowerCase());
      }
      
      if (filtered.length === 0) {
        container.innerHTML = `<div style="${emptyStyle}"><div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div><p>No products found</p></div>`;
        document.getElementById('stocktakeSummary').style.display = 'none';
        return;
      }
      
      // Group by supplier
      const bySupplier = {};
      filtered.forEach(p => {
        const supplier = p.supplier || 'Fresh Wax';
        if (!bySupplier[supplier]) bySupplier[supplier] = [];
        bySupplier[supplier].push(p);
      });
      
      let html = '';
      let totalProducts = 0;
      let totalVariants = 0;
      let totalStock = 0;
      
      Object.keys(bySupplier).sort().forEach(supplier => {
        const products = bySupplier[supplier];
        
        html += `
          <div style="${sectionStyle}">
            <div style="${supplierHeaderStyle}">üì¶ ${supplier} (${products.length} products)</div>
            <table style="${tableStyle}">
              <thead style="${theadStyle}">
                <tr style="${trStyle}">
                  <th style="${thStyle} width: 200px;">Product / Size</th>
                  <th style="${thStyle} width: 120px;">SKU</th>
                  <th style="${thStyle} width: 70px; text-align: center;">System</th>
                  <th style="${thStyle} width: 90px; text-align: center;">Counted</th>
                  <th style="${thStyle} width: 70px; text-align: center;">Variance</th>
                  <th style="${thStyle} width: 140px;">Reason</th>
                </tr>
              </thead>
              <tbody style="${tbodyStyle}">
        `;
        
        products.forEach(product => {
          totalProducts++;
          const variantStock = product.variantStock || {};
          const variantKeys = Object.keys(variantStock);
          
          // Product header row
          html += `
            <tr style="${trStyle} ${productRowBg}">
              <td style="${tdStyle} font-weight: 700;">${product.name || 'Unknown'}</td>
              <td style="${tdStyle} ${skuStyle}">${product.sku || '-'}</td>
              <td style="${tdStyle} text-align: center; font-weight: 700;">${product.totalStock || 0}</td>
              <td style="${tdStyle}"></td>
              <td style="${tdStyle}"></td>
              <td style="${tdStyle}"></td>
            </tr>
          `;
          
          // Size/variant rows
          if (variantKeys.length === 0 || (variantKeys.length === 1 && variantKeys[0] === 'default')) {
            // Single variant product
            totalVariants++;
            const stock = product.totalStock || 0;
            totalStock += stock;
            const key = `${product.productId}_default`;
            const change = stockTakeChanges[key];
            const counted = change?.counted ?? '';
            const reason = change?.reason ?? '';
            const variance = counted !== '' ? (parseInt(counted) - stock) : '';
            const varianceColor = variance > 0 ? '#22c55e' : (variance < 0 ? '#dc2626' : '#000');
            
            html += `
              <tr style="${trStyle}">
                <td style="${tdStyle} ${sizeIndent}">Default</td>
                <td style="${tdStyle} ${skuStyle}">${product.sku || '-'}</td>
                <td style="${tdStyle} text-align: center;">${stock}</td>
                <td style="${tdStyle} text-align: center;">
                  <input type="number" style="${inputStyle}" 
                    data-product="${product.productId}" 
                    data-variant="default" 
                    data-system="${stock}"
                    value="${counted}"
                    onchange="updateStockTakeChange(this)"
                    placeholder="‚Äî">
                </td>
                <td style="${tdStyle} text-align: center; font-weight: 700; color: ${varianceColor};" class="variance">${variance !== '' ? (variance > 0 ? '+' : '') + variance : ''}</td>
                <td style="${tdStyle}">
                  <input type="text" style="${reasonInputStyle}" 
                    data-product="${product.productId}" 
                    data-variant="default"
                    value="${reason}"
                    onchange="updateStockTakeReason(this)"
                    placeholder="Reason...">
                </td>
              </tr>
            `;
          } else {
            // Multi-variant product
            variantKeys.forEach(vKey => {
              totalVariants++;
              const v = variantStock[vKey];
              const stock = v.stock || 0;
              totalStock += stock;
              const label = v.size || v.color || vKey;
              const key = `${product.productId}_${vKey}`;
              const change = stockTakeChanges[key];
              const counted = change?.counted ?? '';
              const reason = change?.reason ?? '';
              const variance = counted !== '' ? (parseInt(counted) - stock) : '';
              const varianceColor = variance > 0 ? '#22c55e' : (variance < 0 ? '#dc2626' : '#000');
              
              html += `
                <tr style="${trStyle}">
                  <td style="${tdStyle} ${sizeIndent}">${label}</td>
                  <td style="${tdStyle} ${skuStyle}">${v.sku || '-'}</td>
                  <td style="${tdStyle} text-align: center;">${stock}</td>
                  <td style="${tdStyle} text-align: center;">
                    <input type="number" style="${inputStyle}" 
                      data-product="${product.productId}" 
                      data-variant="${vKey}" 
                      data-system="${stock}"
                      value="${counted}"
                      onchange="updateStockTakeChange(this)"
                      placeholder="‚Äî">
                  </td>
                  <td style="${tdStyle} text-align: center; font-weight: 700; color: ${varianceColor};" class="variance">${variance !== '' ? (variance > 0 ? '+' : '') + variance : ''}</td>
                  <td style="${tdStyle}">
                    <input type="text" style="${reasonInputStyle}" 
                      data-product="${product.productId}" 
                      data-variant="${vKey}"
                      value="${reason}"
                      onchange="updateStockTakeReason(this)"
                      placeholder="Reason...">
                  </td>
                </tr>
              `;
            });
          }
        });
        
        html += '</tbody></table></div>';
      });
      
      container.innerHTML = html;
      
      // Update summary
      document.getElementById('summaryProducts').textContent = totalProducts;
      document.getElementById('summaryVariants').textContent = totalVariants;
      document.getElementById('summaryTotalStock').textContent = totalStock;
      document.getElementById('summaryChanges').textContent = Object.keys(stockTakeChanges).filter(k => stockTakeChanges[k].counted !== '').length;
      document.getElementById('stocktakeSummary').style.display = 'block';
    }
    
    // Track counted value changes
    function updateStockTakeChange(input) {
      const productId = input.dataset.product;
      const variant = input.dataset.variant;
      const system = parseInt(input.dataset.system) || 0;
      const key = `${productId}_${variant}`;
      
      if (!stockTakeChanges[key]) {
        stockTakeChanges[key] = { counted: '', reason: '', productId, variant, system };
      }
      
      stockTakeChanges[key].counted = input.value;
      
      // Update variance display
      const row = input.closest('tr');
      const varianceCell = row.querySelector('.variance');
      if (input.value !== '') {
        const variance = parseInt(input.value) - system;
        varianceCell.textContent = (variance > 0 ? '+' : '') + variance;
        varianceCell.style.color = variance > 0 ? '#22c55e' : (variance < 0 ? '#dc2626' : '#000');
      } else {
        varianceCell.textContent = '';
        varianceCell.style.color = '#000';
      }
      
      // Update pending changes count
      document.getElementById('summaryChanges').textContent = Object.keys(stockTakeChanges).filter(k => stockTakeChanges[k].counted !== '').length;
    }
    
    // Track reason changes
    function updateStockTakeReason(input) {
      const productId = input.dataset.product;
      const variant = input.dataset.variant;
      const key = `${productId}_${variant}`;
      
      if (!stockTakeChanges[key]) {
        stockTakeChanges[key] = { counted: '', reason: '', productId, variant };
      }
      
      stockTakeChanges[key].reason = input.value;
    }
    
    // Save all stock take changes
    async function saveStockTake() {
      const changes = Object.values(stockTakeChanges).filter(c => c.counted !== '');
      
      if (changes.length === 0) {
        showToast('No changes to save', 'error');
        return;
      }
      
      if (!confirm(`Save ${changes.length} stock adjustments?`)) return;
      
      let success = 0;
      let failed = 0;
      
      for (const change of changes) {
        const newStock = parseInt(change.counted);
        const adjustment = newStock - change.system;
        
        if (adjustment === 0) continue;
        
        try {
          const response = await fetch('/api/update-stock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: change.productId,
              variantKey: change.variant,
              operation: 'set',
              quantity: newStock,
              notes: `Stock take: ${change.reason || 'No reason provided'}`
            })
          });
          
          const data = await response.json();
          if (data.success) success++;
          else failed++;
        } catch (err) {
          failed++;
        }
      }
      
      showToast(`Saved ${success} changes${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'success' : 'error');
      
      if (success > 0) {
        stockTakeChanges = {};
        loadData();
      }
    }
    
    // Print stock take report
    function printStockTake() {
      // Set print date
      const now = new Date();
      document.getElementById('printDate').textContent = `Stock Take Report - Printed: ${now.toLocaleDateString('en-GB')} ${now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
      
      // Show only the stock take tab for printing
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      document.getElementById('tab-stocktake').style.display = 'block';
      
      window.print();
    }
    
    // Populate supplier filter
    function populateSupplierFilter() {
      const select = document.getElementById('supplierFilter');
      allSuppliers.clear();
      
      allProducts.forEach(p => {
        allSuppliers.add(p.supplier || 'Fresh Wax');
      });
      
      select.innerHTML = '<option value="all">All Suppliers</option>' + 
        Array.from(allSuppliers).sort().map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    // Supplier filter change
    document.getElementById('supplierFilter')?.addEventListener('change', (e) => {
      renderStockTake(e.target.value, document.getElementById('categoryFilter').value);
    });
    
    // Category filter change
    document.getElementById('categoryFilter')?.addEventListener('change', (e) => {
      renderStockTake(document.getElementById('supplierFilter').value, e.target.value);
    });
    
    // Tab switching - render stock take when switching to that tab
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (tab.dataset.tab === 'stocktake') {
          populateSupplierFilter();
          renderStockTake();
        }
      });
    });
    
    // Initialize
    loadData();
    
    // Expose functions to window for onclick handlers in dynamic HTML
    window.toggleSizes = toggleSizes;
    window.quickAdjust = quickAdjust;
    window.openQuickReceive = openQuickReceive;
    window.closeModal = closeModal;
    window.submitModalUpdate = submitModalUpdate;
    window.updateStockTakeChange = updateStockTakeChange;
    window.updateStockTakeReason = updateStockTakeReason;
    window.saveStockTakeChanges = saveStockTakeChanges;
    window.printStockTake = printStockTake;
    window.selectProduct = selectProduct;
    window.selectVariant = selectVariant;
    window.clearSelectedProduct = clearSelectedProduct;
    window.saveStockTake = saveStockTake;
  </script>
</body>
</html>
