---
// src/pages/admin/streaming/history.astro
// View past stream history - completed and cancelled slots
import AdminLayout from '../../../layouts/AdminLayout.astro';

export const prerender = false;
---

<AdminLayout title="Stream History">
  <Fragment slot="actions">
    <a href="/admin/streaming/schedule" class="btn btn-outline">← Schedule</a>
    <a href="/admin" class="btn btn-outline">Admin Home</a>
  </Fragment>

  <div class="history-page">
    <!-- Stats Row -->
    <div class="stats-grid cols-4 mb-4">
      <div class="stat-card">
        <div class="stat-label">Total Streams</div>
        <div class="stat-value" id="totalStreams">-</div>
        <div class="stat-detail">all time</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">This Month</div>
        <div class="stat-value" id="monthStreams">-</div>
        <div class="stat-detail" id="monthHours">0 hours streamed</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Unique DJs</div>
        <div class="stat-value" id="uniqueDJs">-</div>
        <div class="stat-detail">have streamed</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">Avg Duration</div>
        <div class="stat-value" id="avgDuration">-</div>
        <div class="stat-detail">minutes</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-header">
        <h2>Stream History</h2>
        <div class="header-actions">
          <select id="djFilter" class="form-select" style="width: 200px;">
            <option value="">All DJs</option>
          </select>
          <select id="monthFilter" class="form-select" style="width: 150px;">
            <option value="">All Time</option>
          </select>
          <button id="refreshBtn" class="btn btn-outline btn-sm">↻ Refresh</button>
        </div>
      </div>

      <!-- History Table -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>DJ</th>
              <th>Title</th>
              <th>Genre</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr>
              <td colspan="6" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer">
        <div class="pagination">
          <button id="prevPage" class="btn btn-outline btn-sm" disabled>← Previous</button>
          <span id="pageInfo">Page 1</span>
          <button id="nextPage" class="btn btn-outline btn-sm">Next →</button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .history-page {
    padding: 0;
  }

  .stats-grid {
    display: grid;
    gap: 1rem;
  }

  .stats-grid.cols-4 {
    grid-template-columns: repeat(4, 1fr);
  }

  .stat-card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 1.25rem;
  }

  .stat-card.success {
    border-color: #22c55e;
  }

  .stat-label {
    font-size: 0.8rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    line-height: 1;
  }

  .stat-card.success .stat-value {
    color: #22c55e;
  }

  .stat-detail {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.25rem;
  }

  .card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    overflow: hidden;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #333;
  }

  .card-header h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .form-select {
    background: #222;
    border: 1px solid #444;
    color: #fff;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    font-size: 0.875rem;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid #444;
    color: #ccc;
  }

  .btn-outline:hover {
    background: rgba(255,255,255,0.05);
    border-color: #666;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #333;
  }

  .data-table th {
    background: #111;
    color: #888;
    font-weight: 500;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .data-table td {
    color: #ccc;
    font-size: 0.875rem;
  }

  .data-table tr:hover td {
    background: rgba(255,255,255,0.02);
  }

  .status-completed {
    color: #22c55e;
  }

  .status-cancelled {
    color: #888;
  }

  .text-center {
    text-align: center;
  }

  .card-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid #333;
    display: flex;
    justify-content: center;
  }

  .pagination {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  #pageInfo {
    color: #888;
    font-size: 0.875rem;
  }

  .mb-4 {
    margin-bottom: 1.5rem;
  }

  @media (max-width: 768px) {
    .stats-grid.cols-4 {
      grid-template-columns: repeat(2, 1fr);
    }

    .header-actions {
      flex-wrap: wrap;
    }
  }
</style>

<script>
  const PAGE_SIZE = 20;
  let currentPage = 1;
  let allStreams: any[] = [];
  let filteredStreams: any[] = [];

  async function loadHistory() {
    try {
      const response = await fetch('/api/livestream/slots?action=history');
      const data = await response.json();

      if (data.success && data.slots) {
        allStreams = data.slots
          .filter((s: any) => s.status === 'completed' || s.status === 'cancelled')
          .sort((a: any, b: any) => new Date(b.startTime || b.createdAt).getTime() - new Date(a.startTime || a.createdAt).getTime());

        populateDJFilter();
        populateMonthFilter();
        applyFilters();
        updateStats();
      }
    } catch (error) {
      console.error('Failed to load history:', error);
      document.getElementById('historyBody')!.innerHTML =
        '<tr><td colspan="6" class="text-center" style="color: #ef4444;">Failed to load history</td></tr>';
    }
  }

  function populateDJFilter() {
    const djFilter = document.getElementById('djFilter') as HTMLSelectElement;
    const uniqueDJs = [...new Set(allStreams.map(s => s.djName).filter(Boolean))].sort();

    uniqueDJs.forEach(dj => {
      const option = document.createElement('option');
      option.value = dj;
      option.textContent = dj;
      djFilter.appendChild(option);
    });
  }

  function populateMonthFilter() {
    const monthFilter = document.getElementById('monthFilter') as HTMLSelectElement;
    const months = new Set<string>();

    allStreams.forEach(s => {
      const date = new Date(s.startTime || s.createdAt);
      if (!isNaN(date.getTime())) {
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        months.add(monthKey);
      }
    });

    [...months].sort().reverse().forEach(month => {
      const [year, m] = month.split('-');
      const date = new Date(parseInt(year), parseInt(m) - 1);
      const option = document.createElement('option');
      option.value = month;
      option.textContent = date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
      monthFilter.appendChild(option);
    });
  }

  function applyFilters() {
    const djFilter = (document.getElementById('djFilter') as HTMLSelectElement).value;
    const monthFilter = (document.getElementById('monthFilter') as HTMLSelectElement).value;

    filteredStreams = allStreams.filter(s => {
      if (djFilter && s.djName !== djFilter) return false;
      if (monthFilter) {
        const date = new Date(s.startTime || s.createdAt);
        const streamMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (streamMonth !== monthFilter) return false;
      }
      return true;
    });

    currentPage = 1;
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById('historyBody')!;
    const start = (currentPage - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageData = filteredStreams.slice(start, end);

    if (pageData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">No streams found</td></tr>';
      updatePagination();
      return;
    }

    tbody.innerHTML = pageData.map(s => {
      const startDate = new Date(s.startTime || s.createdAt);
      const endDate = s.endTime ? new Date(s.endTime) : null;
      const duration = endDate ? Math.round((endDate.getTime() - startDate.getTime()) / 60000) : '-';

      return `
        <tr>
          <td>${startDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })} ${startDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</td>
          <td>${s.djName || 'Unknown'}</td>
          <td>${s.title || 'Live Session'}</td>
          <td>${s.genre || '-'}</td>
          <td>${duration !== '-' ? duration + ' min' : '-'}</td>
          <td class="status-${s.status}">${s.status}</td>
        </tr>
      `;
    }).join('');

    updatePagination();
  }

  function updatePagination() {
    const totalPages = Math.ceil(filteredStreams.length / PAGE_SIZE);
    document.getElementById('pageInfo')!.textContent = `Page ${currentPage} of ${totalPages || 1}`;

    (document.getElementById('prevPage') as HTMLButtonElement).disabled = currentPage <= 1;
    (document.getElementById('nextPage') as HTMLButtonElement).disabled = currentPage >= totalPages;
  }

  function updateStats() {
    const completed = allStreams.filter(s => s.status === 'completed');

    document.getElementById('totalStreams')!.textContent = completed.length.toString();

    // This month
    const now = new Date();
    const thisMonth = completed.filter(s => {
      const date = new Date(s.startTime || s.createdAt);
      return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
    });
    document.getElementById('monthStreams')!.textContent = thisMonth.length.toString();

    // Total hours this month
    let totalMinutes = 0;
    thisMonth.forEach(s => {
      if (s.startTime && s.endTime) {
        const start = new Date(s.startTime);
        const end = new Date(s.endTime);
        totalMinutes += (end.getTime() - start.getTime()) / 60000;
      }
    });
    document.getElementById('monthHours')!.textContent = Math.round(totalMinutes / 60) + ' hours streamed';

    // Unique DJs
    const uniqueDJs = new Set(completed.map(s => s.djId).filter(Boolean));
    document.getElementById('uniqueDJs')!.textContent = uniqueDJs.size.toString();

    // Average duration
    let totalDuration = 0;
    let countWithDuration = 0;
    completed.forEach(s => {
      if (s.startTime && s.endTime) {
        const start = new Date(s.startTime);
        const end = new Date(s.endTime);
        totalDuration += (end.getTime() - start.getTime()) / 60000;
        countWithDuration++;
      }
    });
    const avgDuration = countWithDuration > 0 ? Math.round(totalDuration / countWithDuration) : 0;
    document.getElementById('avgDuration')!.textContent = avgDuration.toString();
  }

  // Event listeners
  document.getElementById('djFilter')?.addEventListener('change', applyFilters);
  document.getElementById('monthFilter')?.addEventListener('change', applyFilters);
  document.getElementById('refreshBtn')?.addEventListener('click', loadHistory);
  document.getElementById('prevPage')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  });
  document.getElementById('nextPage')?.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredStreams.length / PAGE_SIZE);
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  });

  // Initial load
  loadHistory();
</script>
