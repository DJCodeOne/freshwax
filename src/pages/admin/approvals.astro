---
// src/pages/admin/approvals.astro
import AdminLayout from '../../layouts/AdminLayout.astro';

export const prerender = false;
---

<AdminLayout title="Approvals">
  <div class="approvals-page">
    <div class="page-header">
      <h1>üîê Pending Approvals</h1>
    </div>

    <!-- Bypass Requests Section -->
    <div class="section">
      <div class="section-header">
        <h2>DJ Bypass Requests</h2>
        <button class="refresh-btn" id="refresh-bypass">‚Üª Refresh</button>
      </div>
      <div id="bypass-requests" class="requests-list">
        <div class="loading">Loading requests...</div>
      </div>
    </div>

    <!-- Partner Applications Section -->
    <div class="section">
      <div class="section-header">
        <h2>Partner Applications</h2>
        <button class="refresh-btn" id="refresh-partners">‚Üª Refresh</button>
      </div>
      <div id="partner-applications" class="requests-list">
        <div class="loading">Loading applications...</div>
      </div>
    </div>
  </div>
</AdminLayout>

<style is:global>
  .approvals-page {
    padding: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header h1 {
    font-size: 1.5rem;
    color: #fff;
    margin-bottom: 1.5rem;
  }

  .section {
    background: rgba(30, 30, 45, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .section-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    margin: 0;
  }

  .refresh-btn {
    padding: 0.375rem 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 0.375rem;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .refresh-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }

  .requests-list {
    padding: 1rem;
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: rgba(255, 255, 255, 0.4);
  }

  .empty-state span {
    font-size: 2.5rem;
    display: block;
    margin-bottom: 0.5rem;
  }

  .request-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .request-card:last-child {
    margin-bottom: 0;
  }

  .request-info {
    flex: 1;
  }

  .request-name {
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.25rem;
  }

  .request-email {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.25rem;
  }

  .request-type {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    background: rgba(99, 102, 241, 0.2);
    border-radius: 0.25rem;
    font-size: 0.7rem;
    color: #818cf8;
    text-transform: uppercase;
  }

  .request-reason {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 0.5rem;
    font-style: italic;
  }

  .request-date {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    margin-top: 0.25rem;
  }

  .request-actions {
    display: flex;
    gap: 0.5rem;
    margin-left: 1rem;
  }

  .btn-approve {
    padding: 0.5rem 1rem;
    background: #22c55e;
    border: none;
    border-radius: 0.375rem;
    color: #fff;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-approve:hover {
    background: #16a34a;
  }

  .btn-deny {
    padding: 0.5rem 1rem;
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 0.375rem;
    color: #ef4444;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-deny:hover {
    background: rgba(239, 68, 68, 0.3);
  }

  .error-state {
    text-align: center;
    padding: 2rem;
    color: #ef4444;
  }
</style>

<script>
  async function loadBypassRequests() {
    const container = document.getElementById('bypass-requests');
    
    try {
      const res = await fetch('/api/admin/bypass-requests');
      const data = await res.json();
      
      if (!data.success) {
        container.innerHTML = '<div class="error-state">Failed to load requests</div>';
        return;
      }
      
      const requests = data.requests || [];
      
      if (requests.length === 0) {
        container.innerHTML = '<div class="empty-state"><span>‚úÖ</span><p>No pending requests</p></div>';
        return;
      }
      
      container.innerHTML = requests.map(req => `
        <div class="request-card" data-id="${req.id}">
          <div class="request-info">
            <div class="request-name">${req.userName || 'Unknown User'}</div>
            <div class="request-email">${req.userEmail || ''}</div>
            <span class="request-type">${req.requestType || 'go-live'}</span>
            ${req.reason ? `<div class="request-reason">"${req.reason}"</div>` : ''}
            <div class="request-date">${new Date(req.createdAt).toLocaleString()}</div>
          </div>
          <div class="request-actions">
            <button class="btn-approve" onclick="handleBypass('approve', '${req.id}')">Approve</button>
            <button class="btn-deny" onclick="handleBypass('deny', '${req.id}')">Deny</button>
          </div>
        </div>
      `).join('');
      
    } catch (err) {
      console.error('Error loading bypass requests:', err);
      container.innerHTML = '<div class="error-state">Error loading requests</div>';
    }
  }

  async function handleBypass(action, requestId) {
    const card = document.querySelector(`[data-id="${requestId}"]`);
    if (card) card.style.opacity = '0.5';
    
    try {
      const res = await fetch('/api/admin/bypass-requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, requestId })
      });
      
      const data = await res.json();
      
      if (data.success) {
        if (card) card.remove();
        // Check if empty
        const container = document.getElementById('bypass-requests');
        if (!container.querySelector('.request-card')) {
          container.innerHTML = '<div class="empty-state"><span>‚úÖ</span><p>No pending requests</p></div>';
        }
      } else {
        alert('Action failed: ' + (data.error || 'Unknown error'));
        if (card) card.style.opacity = '1';
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Action failed');
      if (card) card.style.opacity = '1';
    }
  }

  async function loadPartnerApplications() {
    const container = document.getElementById('partner-applications');
    
    try {
      const res = await fetch('/api/admin/partner-applications');
      const data = await res.json();
      
      if (!data.success) {
        container.innerHTML = '<div class="empty-state"><span>üìã</span><p>No pending applications</p></div>';
        return;
      }
      
      const applications = data.applications || [];
      
      if (applications.length === 0) {
        container.innerHTML = '<div class="empty-state"><span>‚úÖ</span><p>No pending applications</p></div>';
        return;
      }
      
      container.innerHTML = applications.map(app => `
        <div class="request-card" data-app-id="${app.id}">
          <div class="request-info">
            <div class="request-name">${app.name || app.artistName || 'Unknown'}</div>
            <div class="request-email">${app.email || ''}</div>
            <span class="request-type">${app.type || app.partnerType || 'partner'}</span>
            <div class="request-date">${new Date(app.createdAt).toLocaleString()}</div>
          </div>
          <div class="request-actions">
            <button class="btn-approve" onclick="handlePartner('approve', '${app.id}')">Approve</button>
            <button class="btn-deny" onclick="handlePartner('deny', '${app.id}')">Deny</button>
          </div>
        </div>
      `).join('');
      
    } catch (err) {
      console.error('Error loading partner applications:', err);
      container.innerHTML = '<div class="empty-state"><span>üìã</span><p>No pending applications</p></div>';
    }
  }

  async function handlePartner(action, appId) {
    const card = document.querySelector(`[data-app-id="${appId}"]`);
    if (card) card.style.opacity = '0.5';
    
    try {
      const res = await fetch('/api/admin/partner-applications', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, applicationId: appId })
      });
      
      const data = await res.json();
      
      if (data.success) {
        if (card) card.remove();
        const container = document.getElementById('partner-applications');
        if (!container.querySelector('.request-card')) {
          container.innerHTML = '<div class="empty-state"><span>‚úÖ</span><p>No pending applications</p></div>';
        }
      } else {
        alert('Action failed: ' + (data.error || 'Unknown error'));
        if (card) card.style.opacity = '1';
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Action failed');
      if (card) card.style.opacity = '1';
    }
  }

  // Load on page load
  loadBypassRequests();
  loadPartnerApplications();

  // Refresh buttons
  document.getElementById('refresh-bypass')?.addEventListener('click', loadBypassRequests);
  document.getElementById('refresh-partners')?.addEventListener('click', loadPartnerApplications);

  // Make functions global
  window.handleBypass = handleBypass;
  window.handlePartner = handlePartner;
</script>
