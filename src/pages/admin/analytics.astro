---
// /src/pages/admin/analytics.astro
// Fresh Wax Analytics Dashboard - Unified Admin Design
// Revenue/fees data from salesLedger (source of truth)

import AdminLayout from '../../layouts/AdminLayout.astro';
import { queryCollection } from '../../lib/firebase-rest';
import { saQueryCollection } from '../../lib/firebase-service-account';

// Get environment for service account
const env = Astro.locals?.runtime?.env;
const projectId = env?.FIREBASE_PROJECT_ID || import.meta.env.FIREBASE_PROJECT_ID || 'freshwax-store';
const clientEmail = env?.FIREBASE_CLIENT_EMAIL || import.meta.env.FIREBASE_CLIENT_EMAIL;
const privateKey = env?.FIREBASE_PRIVATE_KEY || import.meta.env.FIREBASE_PRIVATE_KEY;

const serviceAccountKey = clientEmail && privateKey ? JSON.stringify({
  type: 'service_account',
  project_id: projectId,
  private_key_id: 'auto',
  private_key: privateKey.replace(/\\n/g, '\n'),
  client_email: clientEmail,
  client_id: '',
  auth_uri: 'https://accounts.google.com/o/oauth2/auth',
  token_uri: 'https://oauth2.googleapis.com/token'
}) : null;

// Get date ranges
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
const startOfYear = new Date(now.getFullYear(), 0, 1);

// Fetch ledger entries (source of truth for revenue)
let ledgerEntries: any[] = [];
try {
  if (serviceAccountKey) {
    ledgerEntries = await saQueryCollection(serviceAccountKey, projectId, 'salesLedger', {
      orderBy: { field: 'timestamp', direction: 'DESCENDING' },
      limit: 2000
    });
  }
  console.log(`[analytics] Fetched ${ledgerEntries.length} ledger entries`);
} catch (e) {
  console.error('Error fetching ledger:', e);
}

// Also fetch orders for top sellers (uses items data)
let orders: any[] = [];
try {
  const allOrders = await queryCollection('orders', {
    orderBy: { field: 'createdAt', direction: 'DESCENDING' },
    limit: 500
  });
  orders = allOrders.filter((o: any) =>
    o.status !== 'cancelled' &&
    o.paymentMethod !== 'test_mode'
  );
} catch (e) {
  console.error('Error fetching orders:', e);
}

// Fetch releases to get actual prices (for free download detection)
const releasesPriceMap: Record<string, number> = {};
try {
  const releases = await queryCollection('releases', { limit: 500 });
  releases.forEach((r: any) => {
    if (r.id) {
      releasesPriceMap[r.id] = r.price ?? 0;
    }
  });
} catch (e) {
  console.error('Error fetching releases:', e);
}

// Helper to correct item prices (some might be stored in pence)
function correctItemPrice(price: number): number {
  if (price === null || price === undefined) return 0;
  // If price looks like it's in pence (> 100 for items that should be < ¬£100), convert
  if (price > 100) return price / 100;
  return price;
}

// Calculate metrics from LEDGER (source of truth)
function calculateMetricsFromLedger(entries: any[]) {
  let revenue = 0;
  let stripeFees = 0;
  let paypalFees = 0;
  let freshWaxFees = 0;

  entries.forEach(entry => {
    // Use actual values from ledger
    revenue += entry.grossTotal ?? 0;
    stripeFees += entry.stripeFee ?? 0;
    paypalFees += entry.actualPaypalFee ?? entry.paypalFee ?? 0;
    freshWaxFees += entry.freshWaxFee ?? 0;
  });

  const totalFees = stripeFees + paypalFees + freshWaxFees;
  const avgOrder = entries.length > 0 ? revenue / entries.length : 0;

  return {
    revenue,
    fees: totalFees,
    stripeFees,
    paypalFees,
    freshWaxFees,
    orders: entries.length,
    avgOrder
  };
}

// Filter ledger entries by date range
const thisMonthLedger = ledgerEntries.filter(e => new Date(e.timestamp) >= startOfMonth);
const lastMonthLedger = ledgerEntries.filter(e => {
  const ts = new Date(e.timestamp);
  return ts >= startOfLastMonth && ts <= endOfLastMonth;
});
const thisYearLedger = ledgerEntries.filter(e => new Date(e.timestamp) >= startOfYear);

const thisMonth = calculateMetricsFromLedger(thisMonthLedger);
const lastMonth = calculateMetricsFromLedger(lastMonthLedger);
const thisYear = calculateMetricsFromLedger(thisYearLedger);
const allTime = calculateMetricsFromLedger(ledgerEntries);

// Calculate growth percentages
function calcGrowth(current, previous) {
  if (previous === 0) return current > 0 ? 100 : 0;
  return ((current - previous) / previous * 100).toFixed(1);
}

const revenueGrowth = calcGrowth(thisMonth.revenue, lastMonth.revenue);
const ordersGrowth = calcGrowth(thisMonth.orders, lastMonth.orders);

// Top selling releases (exclude merch, exclude free downloads from list)
const releaseSales = {};
orders.forEach(order => {
  (order.items || []).forEach(item => {
    // Only include actual releases, not merch
    const isRelease = (item.type === 'release' || item.type === 'digital' || item.releaseId) &&
                      item.type !== 'merch' && !item.isPhysical && !item.isMerch;

    // Get actual release price from releases collection
    const releaseId = item.releaseId;
    const actualReleasePrice = releaseId ? (releasesPriceMap[releaseId] ?? null) : null;

    // If release is currently free (price = 0), exclude from top selling
    const isFreeRelease = actualReleasePrice === 0 || item.isFree === true;

    if (isRelease && !isFreeRelease) {
      const key = item.releaseId || item.title || 'Unknown';
      if (!releaseSales[key]) {
        releaseSales[key] = {
          title: item.title || 'Unknown',
          artist: item.artist || '',
          artwork: item.artwork || item.image || '',
          sales: 0,
          revenue: 0
        };
      }
      const qty = item.quantity || 1;
      // Use actual release price (what the release is worth)
      let lineTotal = 0;
      if (actualReleasePrice !== null) {
        lineTotal = correctItemPrice(actualReleasePrice) * qty;
      } else if (item.price !== undefined && item.price !== null) {
        lineTotal = correctItemPrice(item.price) * qty;
      } else if (item.total !== undefined && item.total !== null) {
        lineTotal = correctItemPrice(item.total);
      }
      releaseSales[key].sales += qty;
      releaseSales[key].revenue += lineTotal;
    }
  });
});

const topReleases = Object.values(releaseSales)
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 5);

// Top selling merch (physical products only)
const merchSales = {};
orders.forEach(order => {
  (order.items || []).forEach(item => {
    // Include merch and physical items, exclude releases
    const isMerch = item.type === 'merch' || item.isPhysical || item.isMerch ||
                    (item.productId && item.type !== 'release' && item.type !== 'digital' && !item.releaseId);
    if (isMerch) {
      const key = item.productId || item.title || 'Unknown';
      if (!merchSales[key]) {
        merchSales[key] = {
          title: item.title || 'Unknown',
          image: item.image || '',
          sales: 0,
          revenue: 0
        };
      }
      const qty = item.quantity || 1;
      // item.price = unit price, item.total = line total (already includes quantity)
      let lineTotal = 0;
      if (item.price !== undefined && item.price !== null) {
        lineTotal = item.price * qty;
      } else if (item.total !== undefined && item.total !== null) {
        lineTotal = item.total;
      }
      merchSales[key].sales += qty;
      merchSales[key].revenue += lineTotal;
    }
  });
});

const topMerch = Object.values(merchSales)
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 5);

// DJ Mixes stats
let totalPlays = 0;
let totalDownloads = 0;
let totalLikes = 0;
let totalMixes = 0;

try {
  const mixes = await queryCollection('dj-mixes', { limit: 500 });
  totalMixes = mixes.length;

  mixes.forEach(mix => {
    totalPlays += mix.plays || 0;
    totalDownloads += mix.downloads || 0;
    totalLikes += mix.likes || 0;
  });
} catch (e) {
  console.error('Error fetching mixes:', e);
}

// Format currency
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

// Format number
const formatNumber = (num) => {
  return new Intl.NumberFormat('en-GB').format(num);
};

export const prerender = false;
---

<AdminLayout title="Analytics" activeNav="analytics">
  <Fragment slot="actions">
    <a href="/admin/ledger" class="btn btn-primary">
      üìí Sales Ledger
    </a>
    <button class="btn btn-outline" onclick="window.print()">
      üñ®Ô∏è Print Report
    </button>
  </Fragment>

  <!-- Revenue Stats -->
  <div class="stats-grid cols-6 mb-4">
    <div class="stat-card">
      <div class="stat-label">This Month Revenue</div>
      <div class="stat-value">{formatCurrency(thisMonth.revenue)}</div>
      <div class="stat-detail" style="color: {parseFloat(revenueGrowth) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
        {parseFloat(revenueGrowth) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(revenueGrowth))}% vs last month
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">This Month Orders</div>
      <div class="stat-value">{thisMonth.orders}</div>
      <div class="stat-detail" style="color: {parseFloat(ordersGrowth) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
        {parseFloat(ordersGrowth) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(ordersGrowth))}% vs last month
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Avg Order Value</div>
      <div class="stat-value">{formatCurrency(thisMonth.avgOrder)}</div>
      <div class="stat-detail">This month</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Platform Fees</div>
      <div class="stat-value">{formatCurrency(thisMonth.fees)}</div>
      <div class="stat-detail" style="font-size: 0.65rem; line-height: 1.4;">
        Stripe: {formatCurrency(thisMonth.stripeFees)} ‚Ä¢ PayPal: {formatCurrency(thisMonth.paypalFees)}<br>
        <span style="color: var(--accent-red);">Fresh Wax</span>: {formatCurrency(thisMonth.freshWaxFees)}
      </div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">Year to Date</div>
      <div class="stat-value">{formatCurrency(thisYear.revenue)}</div>
      <div class="stat-detail">{thisYear.orders} orders</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">All Time</div>
      <div class="stat-value">{formatCurrency(allTime.revenue)}</div>
      <div class="stat-detail">{allTime.orders} orders</div>
    </div>
  </div>

  <!-- DJ Mixes Stats -->
  <div class="card mb-4">
    <div class="card-header">
      <h2>üéß DJ Mixes Performance</h2>
    </div>
    <div class="card-body">
      <div class="stats-grid cols-4" style="margin-bottom: 0;">
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Plays</div>
          <div class="stat-value">{formatNumber(totalPlays)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Downloads</div>
          <div class="stat-value">{formatNumber(totalDownloads)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Likes</div>
          <div class="stat-value">{formatNumber(totalLikes)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Mixes</div>
          <div class="stat-value">{totalMixes}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Sellers Grid -->
  <div class="grid grid-2 gap-2">
    <!-- Top Releases -->
    <div class="card">
      <div class="card-header">
        <h2>üíø Top Selling Releases</h2>
      </div>
      <div class="card-body">
        {topReleases.length === 0 ? (
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No data yet</div>
            <p class="empty-state-text">Sales data will appear here once orders come in.</p>
          </div>
        ) : (
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Release</th>
                  <th class="text-center" style="width: 100px;">Sales</th>
                  <th class="text-center" style="width: 120px;">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {topReleases.map((release, i) => (
                  <tr>
                    <td>
                      <div class="item-cell">
                        {release.artwork && (
                          <img src={release.artwork} alt="" style="width: 40px; height: 40px;">
                        )}
                        <div class="item-info">
                          <h4 style="font-size: 0.85rem;">{release.title}</h4>
                          <p style="font-size: 0.7rem;">{release.artist}</p>
                        </div>
                      </div>
                    </td>
                    <td class="text-center font-bold">{release.sales}</td>
                    <td class="text-center font-bold">{formatCurrency(release.revenue)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>

    <!-- Top Merch -->
    <div class="card">
      <div class="card-header">
        <h2>üëï Top Selling Merch</h2>
      </div>
      <div class="card-body">
        {topMerch.length === 0 ? (
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No data yet</div>
            <p class="empty-state-text">Merch sales data will appear here.</p>
          </div>
        ) : (
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-center" style="width: 100px;">Sales</th>
                  <th class="text-center" style="width: 120px;">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {topMerch.map((item, i) => (
                  <tr>
                    <td>
                      <div class="item-cell">
                        {item.image && (
                          <img src={item.image} alt="" style="width: 40px; height: 40px;">
                        )}
                        <div class="item-info">
                          <h4 style="font-size: 0.85rem;">{item.title}</h4>
                        </div>
                      </div>
                    </td>
                    <td class="text-center font-bold">{item.sales}</td>
                    <td class="text-center font-bold">{formatCurrency(item.revenue)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Period Comparison -->
  <div class="card mt-4">
    <div class="card-header">
      <h2>üìà Period Comparison</h2>
    </div>
    <div class="card-body">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Period</th>
              <th class="text-center">Orders</th>
              <th class="text-center">Revenue</th>
              <th class="text-center">Stripe</th>
              <th class="text-center">PayPal</th>
              <th class="text-center" style="color: var(--accent-red);">FW Tax</th>
              <th class="text-center">Avg Order</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="font-bold">This Month</td>
              <td class="text-center">{thisMonth.orders}</td>
              <td class="text-center font-bold">{formatCurrency(thisMonth.revenue)}</td>
              <td class="text-center">{formatCurrency(thisMonth.stripeFees)}</td>
              <td class="text-center">{formatCurrency(thisMonth.paypalFees)}</td>
              <td class="text-center" style="color: var(--accent-red);">{formatCurrency(thisMonth.freshWaxFees)}</td>
              <td class="text-center">{formatCurrency(thisMonth.avgOrder)}</td>
            </tr>
            <tr>
              <td class="font-bold">Last Month</td>
              <td class="text-center">{lastMonth.orders}</td>
              <td class="text-center font-bold">{formatCurrency(lastMonth.revenue)}</td>
              <td class="text-center">{formatCurrency(lastMonth.stripeFees)}</td>
              <td class="text-center">{formatCurrency(lastMonth.paypalFees)}</td>
              <td class="text-center" style="color: var(--accent-red);">{formatCurrency(lastMonth.freshWaxFees)}</td>
              <td class="text-center">{formatCurrency(lastMonth.avgOrder)}</td>
            </tr>
            <tr>
              <td class="font-bold">Year to Date</td>
              <td class="text-center">{thisYear.orders}</td>
              <td class="text-center font-bold">{formatCurrency(thisYear.revenue)}</td>
              <td class="text-center">{formatCurrency(thisYear.stripeFees)}</td>
              <td class="text-center">{formatCurrency(thisYear.paypalFees)}</td>
              <td class="text-center" style="color: var(--accent-red);">{formatCurrency(thisYear.freshWaxFees)}</td>
              <td class="text-center">{formatCurrency(thisYear.avgOrder)}</td>
            </tr>
            <tr style="background: var(--bg-hover);">
              <td class="font-bold">All Time</td>
              <td class="text-center">{allTime.orders}</td>
              <td class="text-center font-bold">{formatCurrency(allTime.revenue)}</td>
              <td class="text-center">{formatCurrency(allTime.stripeFees)}</td>
              <td class="text-center">{formatCurrency(allTime.paypalFees)}</td>
              <td class="text-center" style="color: var(--accent-red);">{formatCurrency(allTime.freshWaxFees)}</td>
              <td class="text-center">{formatCurrency(allTime.avgOrder)}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  /* Item cell layout */
  .item-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .item-cell img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
  }
  
  .item-info {
    min-width: 0;
    overflow: hidden;
  }
  
  .item-info h4 {
    margin: 0;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .item-info p {
    margin: 0;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  @media print {
    /* Page setup */
    @page {
      size: A4;
      margin: 15mm 10mm;
    }
    
    /* Hide non-essential elements */
    .admin-header,
    .admin-sidebar,
    .admin-nav,
    .btn,
    button,
    nav,
    .tab-nav,
    footer {
      display: none !important;
    }
    
    /* Reset backgrounds for printing */
    body,
    .admin-layout,
    .admin-main,
    .admin-content {
      background: white !important;
      color: black !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    /* Print header */
    .admin-content::before {
      content: "Fresh Wax Analytics Report - Printed: " attr(data-print-date);
      display: block;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #000;
    }
    
    /* Card styling for print */
    .card,
    .stat-card {
      break-inside: avoid;
      page-break-inside: avoid;
      border: 1px solid #ccc !important;
      background: white !important;
      margin-bottom: 10px !important;
      box-shadow: none !important;
    }
    
    .card-header {
      background: #f5f5f5 !important;
      color: black !important;
      border-bottom: 1px solid #ccc !important;
    }
    
    .card-header h2 {
      color: black !important;
      font-size: 14pt !important;
    }
    
    /* Stats grid for print */
    .stats-grid {
      display: grid !important;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 10px !important;
    }
    
    .stats-grid.cols-6 {
      grid-template-columns: repeat(3, 1fr) !important;
    }
    
    .stats-grid.cols-4 {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .stat-card {
      padding: 10px !important;
      min-height: auto !important;
    }
    
    .stat-label {
      font-size: 9pt !important;
      color: #666 !important;
    }
    
    .stat-value {
      font-size: 14pt !important;
      color: black !important;
    }
    
    .stat-detail {
      font-size: 8pt !important;
    }
    
    /* Table styling for print */
    table {
      width: 100% !important;
      border-collapse: collapse !important;
      font-size: 10pt !important;
    }
    
    th, td {
      border: 1px solid #ccc !important;
      padding: 6px 8px !important;
      text-align: left !important;
      color: black !important;
      background: white !important;
    }
    
    th {
      background: #f5f5f5 !important;
      font-weight: bold !important;
    }
    
    tr {
      page-break-inside: avoid !important;
    }
    
    /* Ensure sections don't break awkwardly */
    .mb-4,
    .card {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Force page break before major sections if needed */
    .card:nth-child(4) {
      page-break-before: auto;
    }
  }
</style>
