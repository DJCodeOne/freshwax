---
// /src/pages/admin/analytics.astro
// Fresh Wax Analytics Dashboard - Unified Admin Design

import AdminLayout from '../../layouts/AdminLayout.astro';
import { initializeApp, cert, getApps } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

// Get date ranges
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
const startOfYear = new Date(now.getFullYear(), 0, 1);

// Fetch all orders for analytics - simple query to avoid index requirements
let orders = [];
try {
  const ordersSnapshot = await db.collection('orders')
    .orderBy('createdAt', 'desc')
    .limit(500)
    .get();

  orders = ordersSnapshot.docs.map(doc => {
    const data = doc.data();
    return {
      id: doc.id,
      ...data,
      createdAt: data.createdAt?.toDate?.() || new Date()
    };
  }).filter(o => o.status !== 'cancelled');
} catch (e) {
  console.error('Error fetching orders:', e);
}

// Calculate metrics
function calculateMetrics(ordersSubset) {
  const revenue = ordersSubset.reduce((sum, o) => sum + (o.total || 0), 0);
  const fees = ordersSubset.reduce((sum, o) => sum + (o.platformFee || 0), 0);
  const avgOrder = ordersSubset.length > 0 ? revenue / ordersSubset.length : 0;
  return { revenue, fees, orders: ordersSubset.length, avgOrder };
}

// Filter orders by date range
const thisMonthOrders = orders.filter(o => o.createdAt >= startOfMonth);
const lastMonthOrders = orders.filter(o => o.createdAt >= startOfLastMonth && o.createdAt <= endOfLastMonth);
const thisYearOrders = orders.filter(o => o.createdAt >= startOfYear);

const thisMonth = calculateMetrics(thisMonthOrders);
const lastMonth = calculateMetrics(lastMonthOrders);
const thisYear = calculateMetrics(thisYearOrders);
const allTime = calculateMetrics(orders);

// Calculate growth percentages
function calcGrowth(current, previous) {
  if (previous === 0) return current > 0 ? 100 : 0;
  return ((current - previous) / previous * 100).toFixed(1);
}

const revenueGrowth = calcGrowth(thisMonth.revenue, lastMonth.revenue);
const ordersGrowth = calcGrowth(thisMonth.orders, lastMonth.orders);

// Top selling releases
const releaseSales = {};
orders.forEach(order => {
  (order.items || []).forEach(item => {
    if (item.type === 'release' || item.type === 'digital' || item.releaseId) {
      const key = item.releaseId || item.title || 'Unknown';
      if (!releaseSales[key]) {
        releaseSales[key] = {
          title: item.title || 'Unknown',
          artist: item.artist || '',
          artwork: item.artwork || item.image || '',
          sales: 0,
          revenue: 0
        };
      }
      releaseSales[key].sales += item.quantity || 1;
      releaseSales[key].revenue += item.price || 0;
    }
  });
});

const topReleases = Object.values(releaseSales)
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 5);

// Top selling merch
const merchSales = {};
orders.forEach(order => {
  (order.items || []).forEach(item => {
    if (item.type === 'merch' || item.isPhysical) {
      const key = item.productId || item.title || 'Unknown';
      if (!merchSales[key]) {
        merchSales[key] = {
          title: item.title || 'Unknown',
          image: item.image || '',
          sales: 0,
          revenue: 0
        };
      }
      merchSales[key].sales += item.quantity || 1;
      merchSales[key].revenue += item.price || 0;
    }
  });
});

const topMerch = Object.values(merchSales)
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 5);

// DJ Mixes stats
let totalPlays = 0;
let totalDownloads = 0;
let totalLikes = 0;
let totalMixes = 0;

try {
  const mixesSnapshot = await db.collection('dj-mixes').get();
  totalMixes = mixesSnapshot.size;
  
  mixesSnapshot.forEach(doc => {
    const data = doc.data();
    totalPlays += data.plays || 0;
    totalDownloads += data.downloads || 0;
    totalLikes += data.likes || 0;
  });
} catch (e) {
  console.error('Error fetching mixes:', e);
}

// Format currency
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

// Format number
const formatNumber = (num) => {
  return new Intl.NumberFormat('en-GB').format(num);
};

export const prerender = false;
---

<AdminLayout title="Analytics" activeNav="analytics">
  <Fragment slot="actions">
    <button class="btn btn-outline" onclick="window.print()">
      üñ®Ô∏è Print Report
    </button>
  </Fragment>

  <!-- Revenue Stats -->
  <div class="stats-grid mb-4">
    <div class="stat-card">
      <div class="stat-label">This Month Revenue</div>
      <div class="stat-value">{formatCurrency(thisMonth.revenue)}</div>
      <div class="stat-detail" style="color: {parseFloat(revenueGrowth) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
        {parseFloat(revenueGrowth) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(revenueGrowth))}% vs last month
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">This Month Orders</div>
      <div class="stat-value">{thisMonth.orders}</div>
      <div class="stat-detail" style="color: {parseFloat(ordersGrowth) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
        {parseFloat(ordersGrowth) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(ordersGrowth))}% vs last month
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Avg Order Value</div>
      <div class="stat-value">{formatCurrency(thisMonth.avgOrder)}</div>
      <div class="stat-detail">This month</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Platform Fees</div>
      <div class="stat-value">{formatCurrency(thisMonth.fees)}</div>
      <div class="stat-detail">This month</div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">Year to Date</div>
      <div class="stat-value">{formatCurrency(thisYear.revenue)}</div>
      <div class="stat-detail">{thisYear.orders} orders</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">All Time</div>
      <div class="stat-value">{formatCurrency(allTime.revenue)}</div>
      <div class="stat-detail">{allTime.orders} orders</div>
    </div>
  </div>

  <!-- DJ Mixes Stats -->
  <div class="card mb-4">
    <div class="card-header">
      <h2>üéß DJ Mixes Performance</h2>
    </div>
    <div class="card-body">
      <div class="grid grid-4 gap-2">
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Plays</div>
          <div class="stat-value">{formatNumber(totalPlays)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Downloads</div>
          <div class="stat-value">{formatNumber(totalDownloads)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Likes</div>
          <div class="stat-value">{formatNumber(totalLikes)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Mixes</div>
          <div class="stat-value">{totalMixes}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Sellers Grid -->
  <div class="grid grid-2 gap-2">
    <!-- Top Releases -->
    <div class="card">
      <div class="card-header">
        <h2>üíø Top Selling Releases</h2>
      </div>
      <div class="card-body">
        {topReleases.length === 0 ? (
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No data yet</div>
            <p class="empty-state-text">Sales data will appear here once orders come in.</p>
          </div>
        ) : (
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Release</th>
                  <th class="text-right">Sales</th>
                  <th class="text-right">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {topReleases.map((release, i) => (
                  <tr>
                    <td>
                      <div class="item-cell">
                        {release.artwork && (
                          <img src={release.artwork} alt="" style="width: 40px; height: 40px;">
                        )}
                        <div class="item-info">
                          <h4 style="font-size: 0.85rem;">{release.title}</h4>
                          <p style="font-size: 0.7rem;">{release.artist}</p>
                        </div>
                      </div>
                    </td>
                    <td class="text-right font-bold">{release.sales}</td>
                    <td class="text-right font-bold">{formatCurrency(release.revenue)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>

    <!-- Top Merch -->
    <div class="card">
      <div class="card-header">
        <h2>üëï Top Selling Merch</h2>
      </div>
      <div class="card-body">
        {topMerch.length === 0 ? (
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No data yet</div>
            <p class="empty-state-text">Merch sales data will appear here.</p>
          </div>
        ) : (
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-right">Sales</th>
                  <th class="text-right">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {topMerch.map((item, i) => (
                  <tr>
                    <td>
                      <div class="item-cell">
                        {item.image && (
                          <img src={item.image} alt="" style="width: 40px; height: 40px;">
                        )}
                        <div class="item-info">
                          <h4 style="font-size: 0.85rem;">{item.title}</h4>
                        </div>
                      </div>
                    </td>
                    <td class="text-right font-bold">{item.sales}</td>
                    <td class="text-right font-bold">{formatCurrency(item.revenue)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Period Comparison -->
  <div class="card mt-4">
    <div class="card-header">
      <h2>üìà Period Comparison</h2>
    </div>
    <div class="card-body">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Period</th>
              <th class="text-right">Orders</th>
              <th class="text-right">Revenue</th>
              <th class="text-right">Platform Fees</th>
              <th class="text-right">Avg Order</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="font-bold">This Month</td>
              <td class="text-right">{thisMonth.orders}</td>
              <td class="text-right font-bold">{formatCurrency(thisMonth.revenue)}</td>
              <td class="text-right">{formatCurrency(thisMonth.fees)}</td>
              <td class="text-right">{formatCurrency(thisMonth.avgOrder)}</td>
            </tr>
            <tr>
              <td class="font-bold">Last Month</td>
              <td class="text-right">{lastMonth.orders}</td>
              <td class="text-right font-bold">{formatCurrency(lastMonth.revenue)}</td>
              <td class="text-right">{formatCurrency(lastMonth.fees)}</td>
              <td class="text-right">{formatCurrency(lastMonth.avgOrder)}</td>
            </tr>
            <tr>
              <td class="font-bold">Year to Date</td>
              <td class="text-right">{thisYear.orders}</td>
              <td class="text-right font-bold">{formatCurrency(thisYear.revenue)}</td>
              <td class="text-right">{formatCurrency(thisYear.fees)}</td>
              <td class="text-right">{formatCurrency(thisYear.avgOrder)}</td>
            </tr>
            <tr style="background: var(--bg-hover);">
              <td class="font-bold">All Time</td>
              <td class="text-right">{allTime.orders}</td>
              <td class="text-right font-bold">{formatCurrency(allTime.revenue)}</td>
              <td class="text-right">{formatCurrency(allTime.fees)}</td>
              <td class="text-right">{formatCurrency(allTime.avgOrder)}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  @media print {
    .stat-card {
      break-inside: avoid;
    }
  }
</style>
