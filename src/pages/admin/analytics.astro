---
// /src/pages/admin/analytics.astro
// Fresh Wax Analytics Dashboard - Unified Admin Design

import AdminLayout from '../../layouts/AdminLayout.astro';
import { queryCollection } from '../../lib/firebase-rest';

// Get date ranges
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
const startOfYear = new Date(now.getFullYear(), 0, 1);

// Fetch all orders for analytics via REST API
let orders: any[] = [];
try {
  const allOrders = await queryCollection('orders', {
    orderBy: { field: 'createdAt', direction: 'DESCENDING' },
    limit: 500
  });

  orders = allOrders.map((data: any) => ({
    ...data,
    createdAt: data.createdAt instanceof Date ? data.createdAt : new Date(data.createdAt || Date.now())
  })).filter((o: any) => o.status !== 'cancelled');
} catch (e) {
  console.error('Error fetching orders:', e);
}

// Calculate metrics
function calculateMetrics(ordersSubset) {
  const revenue = ordersSubset.reduce((sum, o) => {
    // Check nested totals object first (as used in create-order)
    let orderTotal = o.totals?.total || o.total || o.orderTotal || o.grandTotal || o.amount || 0;
    
    // If still no total, try summing items
    if (orderTotal === 0 && o.items && Array.isArray(o.items)) {
      orderTotal = o.items.reduce((itemSum, item) => {
        const itemPrice = (item.price || item.total || 0) * (item.quantity || 1);
        return itemSum + itemPrice;
      }, 0);
    }
    
    return sum + orderTotal;
  }, 0);
  
  const fees = ordersSubset.reduce((sum, o) => {
    // Platform fee could be in different places
    const fee = o.platformFee || o.fees || o.serviceFee || o.totals?.platformFee || 0;
    return sum + fee;
  }, 0);
  
  const avgOrder = ordersSubset.length > 0 ? revenue / ordersSubset.length : 0;
  return { revenue, fees, orders: ordersSubset.length, avgOrder };
}

// Filter orders by date range
const thisMonthOrders = orders.filter(o => o.createdAt >= startOfMonth);
const lastMonthOrders = orders.filter(o => o.createdAt >= startOfLastMonth && o.createdAt <= endOfLastMonth);
const thisYearOrders = orders.filter(o => o.createdAt >= startOfYear);

const thisMonth = calculateMetrics(thisMonthOrders);
const lastMonth = calculateMetrics(lastMonthOrders);
const thisYear = calculateMetrics(thisYearOrders);
const allTime = calculateMetrics(orders);

// Calculate growth percentages
function calcGrowth(current, previous) {
  if (previous === 0) return current > 0 ? 100 : 0;
  return ((current - previous) / previous * 100).toFixed(1);
}

const revenueGrowth = calcGrowth(thisMonth.revenue, lastMonth.revenue);
const ordersGrowth = calcGrowth(thisMonth.orders, lastMonth.orders);

// Top selling releases (exclude merch)
const releaseSales = {};
orders.forEach(order => {
  (order.items || []).forEach(item => {
    // Only include actual releases, not merch
    const isRelease = (item.type === 'release' || item.type === 'digital' || item.releaseId) && 
                      item.type !== 'merch' && !item.isPhysical && !item.isMerch;
    if (isRelease) {
      const key = item.releaseId || item.title || 'Unknown';
      if (!releaseSales[key]) {
        releaseSales[key] = {
          title: item.title || 'Unknown',
          artist: item.artist || '',
          artwork: item.artwork || item.image || '',
          sales: 0,
          revenue: 0
        };
      }
      const qty = item.quantity || 1;
      const price = item.price || item.total || 0;
      releaseSales[key].sales += qty;
      releaseSales[key].revenue += price * qty;
    }
  });
});

const topReleases = Object.values(releaseSales)
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 5);

// Top selling merch (physical products only)
const merchSales = {};
orders.forEach(order => {
  (order.items || []).forEach(item => {
    // Include merch and physical items, exclude releases
    const isMerch = item.type === 'merch' || item.isPhysical || item.isMerch || 
                    (item.productId && item.type !== 'release' && item.type !== 'digital' && !item.releaseId);
    if (isMerch) {
      const key = item.productId || item.title || 'Unknown';
      if (!merchSales[key]) {
        merchSales[key] = {
          title: item.title || 'Unknown',
          image: item.image || '',
          sales: 0,
          revenue: 0
        };
      }
      const qty = item.quantity || 1;
      const price = item.price || item.total || 0;
      merchSales[key].sales += qty;
      merchSales[key].revenue += price * qty;
    }
  });
});

const topMerch = Object.values(merchSales)
  .sort((a, b) => b.revenue - a.revenue)
  .slice(0, 5);

// DJ Mixes stats
let totalPlays = 0;
let totalDownloads = 0;
let totalLikes = 0;
let totalMixes = 0;

try {
  const mixes = await queryCollection('dj-mixes', { limit: 500 });
  totalMixes = mixes.length;

  mixes.forEach(mix => {
    totalPlays += mix.plays || 0;
    totalDownloads += mix.downloads || 0;
    totalLikes += mix.likes || 0;
  });
} catch (e) {
  console.error('Error fetching mixes:', e);
}

// Format currency
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

// Format number
const formatNumber = (num) => {
  return new Intl.NumberFormat('en-GB').format(num);
};

export const prerender = false;
---

<AdminLayout title="Analytics" activeNav="analytics">
  <Fragment slot="actions">
    <button class="btn btn-outline" onclick="window.print()">
      üñ®Ô∏è Print Report
    </button>
  </Fragment>

  <!-- Revenue Stats -->
  <div class="stats-grid cols-6 mb-4">
    <div class="stat-card">
      <div class="stat-label">This Month Revenue</div>
      <div class="stat-value">{formatCurrency(thisMonth.revenue)}</div>
      <div class="stat-detail" style="color: {parseFloat(revenueGrowth) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
        {parseFloat(revenueGrowth) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(revenueGrowth))}% vs last month
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">This Month Orders</div>
      <div class="stat-value">{thisMonth.orders}</div>
      <div class="stat-detail" style="color: {parseFloat(ordersGrowth) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
        {parseFloat(ordersGrowth) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(ordersGrowth))}% vs last month
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Avg Order Value</div>
      <div class="stat-value">{formatCurrency(thisMonth.avgOrder)}</div>
      <div class="stat-detail">This month</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">Platform Fees</div>
      <div class="stat-value">{formatCurrency(thisMonth.fees)}</div>
      <div class="stat-detail">This month</div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">Year to Date</div>
      <div class="stat-value">{formatCurrency(thisYear.revenue)}</div>
      <div class="stat-detail">{thisYear.orders} orders</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">All Time</div>
      <div class="stat-value">{formatCurrency(allTime.revenue)}</div>
      <div class="stat-detail">{allTime.orders} orders</div>
    </div>
  </div>

  <!-- DJ Mixes Stats -->
  <div class="card mb-4">
    <div class="card-header">
      <h2>üéß DJ Mixes Performance</h2>
    </div>
    <div class="card-body">
      <div class="stats-grid cols-4" style="margin-bottom: 0;">
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Plays</div>
          <div class="stat-value">{formatNumber(totalPlays)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Downloads</div>
          <div class="stat-value">{formatNumber(totalDownloads)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Likes</div>
          <div class="stat-value">{formatNumber(totalLikes)}</div>
        </div>
        <div class="stat-card" style="border-color: var(--border-light);">
          <div class="stat-label">Total Mixes</div>
          <div class="stat-value">{totalMixes}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Sellers Grid -->
  <div class="grid grid-2 gap-2">
    <!-- Top Releases -->
    <div class="card">
      <div class="card-header">
        <h2>üíø Top Selling Releases</h2>
      </div>
      <div class="card-body">
        {topReleases.length === 0 ? (
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No data yet</div>
            <p class="empty-state-text">Sales data will appear here once orders come in.</p>
          </div>
        ) : (
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Release</th>
                  <th class="text-center" style="width: 100px;">Sales</th>
                  <th class="text-center" style="width: 120px;">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {topReleases.map((release, i) => (
                  <tr>
                    <td>
                      <div class="item-cell">
                        {release.artwork && (
                          <img src={release.artwork} alt="" style="width: 40px; height: 40px;">
                        )}
                        <div class="item-info">
                          <h4 style="font-size: 0.85rem;">{release.title}</h4>
                          <p style="font-size: 0.7rem;">{release.artist}</p>
                        </div>
                      </div>
                    </td>
                    <td class="text-center font-bold">{release.sales}</td>
                    <td class="text-center font-bold">{formatCurrency(release.revenue)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>

    <!-- Top Merch -->
    <div class="card">
      <div class="card-header">
        <h2>üëï Top Selling Merch</h2>
      </div>
      <div class="card-body">
        {topMerch.length === 0 ? (
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">No data yet</div>
            <p class="empty-state-text">Merch sales data will appear here.</p>
          </div>
        ) : (
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-center" style="width: 100px;">Sales</th>
                  <th class="text-center" style="width: 120px;">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {topMerch.map((item, i) => (
                  <tr>
                    <td>
                      <div class="item-cell">
                        {item.image && (
                          <img src={item.image} alt="" style="width: 40px; height: 40px;">
                        )}
                        <div class="item-info">
                          <h4 style="font-size: 0.85rem;">{item.title}</h4>
                        </div>
                      </div>
                    </td>
                    <td class="text-center font-bold">{item.sales}</td>
                    <td class="text-center font-bold">{formatCurrency(item.revenue)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Period Comparison -->
  <div class="card mt-4">
    <div class="card-header">
      <h2>üìà Period Comparison</h2>
    </div>
    <div class="card-body">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Period</th>
              <th class="text-center">Orders</th>
              <th class="text-center">Revenue</th>
              <th class="text-center">Platform Fees</th>
              <th class="text-center">Avg Order</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="font-bold">This Month</td>
              <td class="text-center">{thisMonth.orders}</td>
              <td class="text-center font-bold">{formatCurrency(thisMonth.revenue)}</td>
              <td class="text-center">{formatCurrency(thisMonth.fees)}</td>
              <td class="text-center">{formatCurrency(thisMonth.avgOrder)}</td>
            </tr>
            <tr>
              <td class="font-bold">Last Month</td>
              <td class="text-center">{lastMonth.orders}</td>
              <td class="text-center font-bold">{formatCurrency(lastMonth.revenue)}</td>
              <td class="text-center">{formatCurrency(lastMonth.fees)}</td>
              <td class="text-center">{formatCurrency(lastMonth.avgOrder)}</td>
            </tr>
            <tr>
              <td class="font-bold">Year to Date</td>
              <td class="text-center">{thisYear.orders}</td>
              <td class="text-center font-bold">{formatCurrency(thisYear.revenue)}</td>
              <td class="text-center">{formatCurrency(thisYear.fees)}</td>
              <td class="text-center">{formatCurrency(thisYear.avgOrder)}</td>
            </tr>
            <tr style="background: var(--bg-hover);">
              <td class="font-bold">All Time</td>
              <td class="text-center">{allTime.orders}</td>
              <td class="text-center font-bold">{formatCurrency(allTime.revenue)}</td>
              <td class="text-center">{formatCurrency(allTime.fees)}</td>
              <td class="text-center">{formatCurrency(allTime.avgOrder)}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  /* Item cell layout */
  .item-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .item-cell img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
  }
  
  .item-info {
    min-width: 0;
    overflow: hidden;
  }
  
  .item-info h4 {
    margin: 0;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .item-info p {
    margin: 0;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  @media print {
    /* Page setup */
    @page {
      size: A4;
      margin: 15mm 10mm;
    }
    
    /* Hide non-essential elements */
    .admin-header,
    .admin-sidebar,
    .admin-nav,
    .btn,
    button,
    nav,
    .tab-nav,
    footer {
      display: none !important;
    }
    
    /* Reset backgrounds for printing */
    body,
    .admin-layout,
    .admin-main,
    .admin-content {
      background: white !important;
      color: black !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    /* Print header */
    .admin-content::before {
      content: "Fresh Wax Analytics Report - Printed: " attr(data-print-date);
      display: block;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #000;
    }
    
    /* Card styling for print */
    .card,
    .stat-card {
      break-inside: avoid;
      page-break-inside: avoid;
      border: 1px solid #ccc !important;
      background: white !important;
      margin-bottom: 10px !important;
      box-shadow: none !important;
    }
    
    .card-header {
      background: #f5f5f5 !important;
      color: black !important;
      border-bottom: 1px solid #ccc !important;
    }
    
    .card-header h2 {
      color: black !important;
      font-size: 14pt !important;
    }
    
    /* Stats grid for print */
    .stats-grid {
      display: grid !important;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 10px !important;
    }
    
    .stats-grid.cols-6 {
      grid-template-columns: repeat(3, 1fr) !important;
    }
    
    .stats-grid.cols-4 {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .stat-card {
      padding: 10px !important;
      min-height: auto !important;
    }
    
    .stat-label {
      font-size: 9pt !important;
      color: #666 !important;
    }
    
    .stat-value {
      font-size: 14pt !important;
      color: black !important;
    }
    
    .stat-detail {
      font-size: 8pt !important;
    }
    
    /* Table styling for print */
    table {
      width: 100% !important;
      border-collapse: collapse !important;
      font-size: 10pt !important;
    }
    
    th, td {
      border: 1px solid #ccc !important;
      padding: 6px 8px !important;
      text-align: left !important;
      color: black !important;
      background: white !important;
    }
    
    th {
      background: #f5f5f5 !important;
      font-weight: bold !important;
    }
    
    tr {
      page-break-inside: avoid !important;
    }
    
    /* Ensure sections don't break awkwardly */
    .mb-4,
    .card {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Force page break before major sections if needed */
    .card:nth-child(4) {
      page-break-before: auto;
    }
  }
</style>
