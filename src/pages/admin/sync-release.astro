---
// src/pages/admin/sync-release.astro
import '../../styles/global.css';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync Release to Store - Fresh Wax Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #000000;
      min-height: 100vh;
      color: #ffffff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header-bar {
      background: #ffffff;
      border: 2px solid #ffffff;
      padding: 20px 30px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo { height: 60px; width: auto; }

    .back-btn {
      padding: 10px 20px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      text-decoration: none;
      font-size: 12px;
      letter-spacing: 1px;
    }

    .back-btn:hover {
      background: #dc2626;
      border-color: #dc2626;
    }

    /* Page Header */
    .page-header {
      background: #ffffff;
      border: 2px solid #ffffff;
      padding: 30px;
      margin-bottom: 30px;
      color: #000000;
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 900;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .page-header p {
      color: #666666;
      font-size: 14px;
      font-weight: 600;
    }

    /* Instructions Box */
    .instructions-box {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      padding: 25px;
      margin-bottom: 30px;
    }

    .instructions-box h2 {
      font-size: 16px;
      font-weight: 900;
      color: #ffffff;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .instructions-box ol {
      margin-left: 20px;
      color: #999999;
    }

    .instructions-box li {
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    /* Upload Section */
    .upload-section {
      background: #ffffff;
      border: 2px solid #ffffff;
      padding: 30px;
      margin-bottom: 30px;
      color: #000000;
    }

    .section-title {
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #000000;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-label .required {
      color: #dc2626;
    }

    .file-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #000000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #ffffff;
      transition: all 0.2s;
    }

    .file-input:hover {
      border-color: #dc2626;
    }

    .file-input:focus {
      outline: none;
      border-color: #dc2626;
    }

    .form-hint {
      margin-top: 6px;
      font-size: 12px;
      color: #666666;
      font-weight: 500;
    }

    .submit-btn {
      width: 100%;
      padding: 18px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
      font-weight: 900;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
      transition: all 0.2s;
    }

    .submit-btn:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #000000;
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ZIP Preview Section */
    .zip-preview-section {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      padding: 0;
      margin-bottom: 30px;
      display: none;
    }

    .zip-preview-section.show {
      display: block;
    }

    .zip-preview-header {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px 25px;
      border-bottom: 2px solid #ffffff;
    }

    .zip-preview-title {
      font-size: 16px;
      font-weight: 900;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .zip-preview-subtitle {
      font-size: 12px;
      color: #666666;
      font-weight: 600;
    }

    .zip-preview-content {
      padding: 25px;
    }

    .zip-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .zip-stat-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid #ffffff;
      padding: 15px;
      text-align: center;
    }

    .zip-stat-value {
      font-size: 32px;
      font-weight: 900;
      color: #dc2626;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .zip-stat-label {
      font-size: 10px;
      font-weight: 700;
      color: #666666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }

    .zip-file-categories {
      display: grid;
      gap: 15px;
    }

    .zip-category {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      overflow: hidden;
    }

    .zip-category-header {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .zip-category-header:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .zip-category-title {
      font-size: 13px;
      font-weight: 700;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .zip-category-count {
      background: rgba(220, 38, 38, 0.2);
      color: #dc2626;
      padding: 4px 10px;
      border-radius: 0;
      font-size: 11px;
      font-weight: 700;
    }

    .zip-category-files {
      padding: 15px;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }

    .zip-category.expanded .zip-category-files {
      display: block;
    }

    .zip-file-item {
      padding: 8px 12px;
      border-left: 3px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 6px;
      font-family: monospace;
      font-size: 11px;
      color: #999999;
      font-weight: 600;
      transition: all 0.2s;
    }

    .zip-file-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-left-color: #dc2626;
      color: #ffffff;
    }

    /* Checklist Section */
    .checklist-section {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      padding: 0;
      margin-bottom: 30px;
      display: none;
    }

    .checklist-section.show {
      display: block;
    }

    .checklist-header {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px 25px;
      border-bottom: 2px solid #ffffff;
    }

    .checklist-title {
      font-size: 16px;
      font-weight: 900;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .checklist-content {
      padding: 25px;
    }

    .checklist-item {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      padding: 15px 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: start;
      gap: 15px;
    }

    .checklist-icon {
      font-size: 24px;
      line-height: 1;
    }

    .checklist-info {
      flex: 1;
    }

    .checklist-step {
      font-size: 13px;
      font-weight: 900;
      color: #ffffff;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .checklist-description {
      font-size: 12px;
      color: #666666;
      font-weight: 600;
      line-height: 1.5;
    }

    .checklist-destination {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.3);
      padding: 8px 12px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 11px;
      color: #dc2626;
      font-weight: 700;
    }

    /* Progress Section */
    .progress-section {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      padding: 0;
      margin-top: 30px;
      overflow: hidden;
      display: none;
    }

    .progress-section.show {
      display: block;
    }

    .progress-header {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px 25px;
      border-bottom: 2px solid #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .progress-title {
      font-size: 16px;
      font-weight: 900;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .progress-stats {
      display: flex;
      gap: 30px;
      align-items: center;
    }

    .stat-item {
      text-align: right;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 900;
      color: #dc2626;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      color: #666666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    .progress-bar-container {
      height: 8px;
      background: rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-content {
      padding: 25px;
    }

    .current-file {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid #ffffff;
      padding: 20px;
      margin-bottom: 20px;
    }

    .current-file-label {
      font-size: 10px;
      font-weight: 700;
      color: #666666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .current-file-name {
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
      word-break: break-all;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-icon {
      font-size: 24px;
    }

    .upload-log {
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.8;
    }

    .log-item {
      padding: 8px 12px;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }

    .log-item.processing {
      background: rgba(220, 38, 38, 0.1);
      border-left-color: #dc2626;
      color: #ffffff;
      font-weight: 700;
    }

    .log-item.complete {
      color: #999999;
      font-weight: 600;
    }

    .log-item.success {
      color: #10b981;
      font-weight: 700;
    }

    .log-item.error {
      background: rgba(220, 38, 38, 0.2);
      border-left-color: #dc2626;
      color: #dc2626;
      font-weight: 700;
    }

    /* Status Messages */
    .status-message {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid #ffffff;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.success {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .status-message.error {
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
    }

    .status-message-title {
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-message.success .status-message-title {
      color: #10b981;
    }

    .status-message.error .status-message-title {
      color: #dc2626;
    }

    .status-message-text {
      font-size: 14px;
      color: #999999;
      font-weight: 600;
      line-height: 1.6;
    }

    /* Scrollbar */
    .upload-log::-webkit-scrollbar,
    .zip-category-files::-webkit-scrollbar {
      width: 8px;
    }

    .upload-log::-webkit-scrollbar-track,
    .zip-category-files::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .upload-log::-webkit-scrollbar-thumb,
    .zip-category-files::-webkit-scrollbar-thumb {
      background: #ffffff;
      border-radius: 0;
    }

    .upload-log::-webkit-scrollbar-thumb:hover,
    .zip-category-files::-webkit-scrollbar-thumb:hover {
      background: #dc2626;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header-bar { flex-direction: column; gap: 15px; }
      .progress-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .progress-stats { width: 100%; justify-content: space-between; }
      .zip-stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header-bar">
      <img src="/logo.webp" alt="Fresh Wax" class="logo" onerror="this.style.display='none'">
      <a href="/admin" class="back-btn">‚Üê Back to Dashboard</a>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1>üöÄ Sync Release to Store</h1>
      <p>Upload packaged ZIP files to R2 storage and Firebase</p>
    </div>

    <!-- Instructions -->
    <div class="instructions-box">
      <h2>üìã How It Works</h2>
      <ol>
        <li>Select the ZIP package created by the Release Packager tool</li>
        <li>Preview contents and verify file structure</li>
        <li>Review upload destinations checklist</li>
        <li>Upload - system extracts and syncs everything automatically</li>
      </ol>
    </div>

    <!-- Upload Form -->
    <div class="upload-section">
      <h2 class="section-title">üì§ Upload Package</h2>
      
      <form id="syncForm">
        <div class="form-group">
          <label class="form-label">
            Package ZIP File <span class="required">*</span>
          </label>
          <input
            type="file"
            id="zipFile"
            accept=".zip"
            required
            class="file-input"
          />
          <p class="form-hint">
            Select the complete release package ZIP from the packager tool
          </p>
        </div>

        <button type="submit" id="submitBtn" class="submit-btn" disabled>
          üöÄ Upload & Sync Release
        </button>
      </form>
    </div>

    <!-- ZIP Preview Section -->
    <div id="zipPreviewSection" class="zip-preview-section">
      <div class="zip-preview-header">
        <div class="zip-preview-title">üì¶ Package Contents</div>
        <div class="zip-preview-subtitle" id="zipFileName">No file selected</div>
      </div>
      <div class="zip-preview-content">
        <div class="zip-stats-grid">
          <div class="zip-stat-card">
            <div class="zip-stat-value" id="totalFiles">0</div>
            <div class="zip-stat-label">Total Files</div>
          </div>
          <div class="zip-stat-card">
            <div class="zip-stat-value" id="totalSize">0 MB</div>
            <div class="zip-stat-label">Total Size</div>
          </div>
          <div class="zip-stat-card">
            <div class="zip-stat-value" id="artworkCount">0</div>
            <div class="zip-stat-label">Artwork</div>
          </div>
          <div class="zip-stat-card">
            <div class="zip-stat-value" id="previewsCount">0</div>
            <div class="zip-stat-label">Previews</div>
          </div>
          <div class="zip-stat-card">
            <div class="zip-stat-value" id="tracksCount">0</div>
            <div class="zip-stat-label">Full Tracks</div>
          </div>
          <div class="zip-stat-card">
            <div class="zip-stat-value" id="metadataCount">0</div>
            <div class="zip-stat-label">Metadata</div>
          </div>
        </div>

        <div class="zip-file-categories" id="zipFileCategories"></div>
      </div>
    </div>

    <!-- Checklist Section -->
<div id="checklistSection" class="checklist-section">
  <div class="checklist-header">
    <div class="checklist-title">‚úì Upload Checklist</div>
  </div>
  <div class="checklist-content">
    <div class="checklist-item">
      <div class="checklist-icon">üñºÔ∏è</div>
      <div class="checklist-info">
        <div class="checklist-step">Step 1: Artwork Files</div>
        <div class="checklist-description">
          All image files will be uploaded to R2 storage and URLs saved to Firebase
        </div>
        <div class="checklist-destination">
          ‚Üí R2: releases/[artist]_[release]_[catalog]/artwork/<br>
          ‚Üí Firebase: coverArtUrl, artwork.cover, artwork.additional[]
        </div>
      </div>
    </div>

    <div class="checklist-item">
      <div class="checklist-icon">üéµ</div>
      <div class="checklist-info">
        <div class="checklist-step">Step 2: Preview Clips</div>
        <div class="checklist-description">
          60-second preview clips (128kbps MP3) for storefront playback
        </div>
        <div class="checklist-destination">
          ‚Üí R2: releases/[artist]_[release]_[catalog]/previews/<br>
          ‚Üí Firebase: tracks[].previewUrl, tracks[].preview_url
        </div>
      </div>
    </div>

    <div class="checklist-item">
      <div class="checklist-icon">üíø</div>
      <div class="checklist-info">
        <div class="checklist-step">Step 3: Full Audio Tracks</div>
        <div class="checklist-description">
          High-quality WAV + 320kbps MP3 files for customer downloads
        </div>
        <div class="checklist-destination">
          ‚Üí R2: releases/[artist]_[release]_[catalog]/tracks/<br>
          ‚Üí Firebase: tracks[].wavUrl, tracks[].mp3Url, tracks[].url
        </div>
      </div>
    </div>

    <div class="checklist-item">
      <div class="checklist-icon">üìÑ</div>
      <div class="checklist-info">
        <div class="checklist-step">Step 4: Metadata JSON</div>
        <div class="checklist-description">
          Release metadata synced to Firebase with all field mappings
        </div>
        <div class="checklist-destination">
          ‚Üí R2: releases/[artist]_[release]_[catalog]/firebase-metadata.json<br>
          ‚Üí Firebase: Complete release document with all fields
        </div>
      </div>
    </div>

    <div class="checklist-item">
      <div class="checklist-icon">‚öôÔ∏è</div>
      <div class="checklist-info">
        <div class="checklist-step">Step 5: Status Configuration</div>
        <div class="checklist-description">
          Release will be set to "pending" status for admin review
        </div>
        <div class="checklist-destination">
          ‚Üí Firebase: status='pending', published=false, approved=false<br>
          ‚Üí Admin must approve before release goes live on store
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- Progress Section -->
    <div id="progressSection" class="progress-section">
      <div class="progress-header">
        <div class="progress-title">‚ö° Processing Upload</div>
        <div class="progress-stats">
          <div class="stat-item">
            <div class="stat-value" id="filesProcessed">0</div>
            <div class="stat-label">Files Uploaded</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="uploadPercent">0%</div>
            <div class="stat-label">Progress</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="uploadSpeed">0 KB/s</div>
            <div class="stat-label">Upload Speed</div>
          </div>
        </div>
      </div>
      <div class="progress-bar-container">
        <div id="progressBarFill" class="progress-bar-fill"></div>
      </div>
      <div class="progress-content">
        <div class="current-file">
          <div class="current-file-label">Currently Processing</div>
          <div class="current-file-name">
            <span class="file-icon" id="currentFileIcon">üì¶</span>
            <span id="currentFileName">Initializing...</span>
          </div>
        </div>
        <div class="upload-log" id="uploadLog"></div>
      </div>
    </div>

    <!-- Status Message -->
    <div id="statusMessage" class="status-message">
      <div class="status-message-title" id="statusTitle"></div>
      <div class="status-message-text" id="statusText"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('syncForm');
    const submitBtn = document.getElementById('submitBtn');
    const zipFileInput = document.getElementById('zipFile');
    const zipPreviewSection = document.getElementById('zipPreviewSection');
    const checklistSection = document.getElementById('checklistSection');
    const progressSection = document.getElementById('progressSection');
    const statusMessage = document.getElementById('statusMessage');
    const uploadLog = document.getElementById('uploadLog');
    const currentFileName = document.getElementById('currentFileName');
    const currentFileIcon = document.getElementById('currentFileIcon');
    const filesProcessed = document.getElementById('filesProcessed');
    const uploadPercent = document.getElementById('uploadPercent');
    const uploadSpeed = document.getElementById('uploadSpeed');
    const progressBarFill = document.getElementById('progressBarFill');

    let uploadStartTime = null;
    let processedCount = 0;
    let totalBytes = 0;
    let uploadedBytes = 0;
    let zipFileData = null;

    // File input change handler
    zipFileInput?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      if (!file.name.endsWith('.zip')) {
        alert('Please select a valid ZIP file');
        return;
      }

      await analyzeZip(file);
    });

    async function analyzeZip(file) {
      try {
        document.getElementById('zipFileName').textContent = file.name;
        
        const zip = await JSZip.loadAsync(file);
        const files = Object.keys(zip.files).filter(name => !zip.files[name].dir);
        
        // Categorize files
        const categories = {
          artwork: [],
          previews: [],
          tracks: [],
          metadata: []
        };

        let totalSize = 0;
        
        files.forEach(path => {
          const file = zip.files[path];
          totalSize += file._data.uncompressedSize || 0;
          
          if (path.includes('/artwork/')) {
            categories.artwork.push(path);
          } else if (path.includes('/previews/')) {
            categories.previews.push(path);
          } else if (path.includes('/tracks/')) {
            categories.tracks.push(path);
          } else if (path.endsWith('.json')) {
            categories.metadata.push(path);
          }
        });

        // Update stats
        document.getElementById('totalFiles').textContent = files.length;
        document.getElementById('totalSize').textContent = (totalSize / (1024 * 1024)).toFixed(2) + ' MB';
        document.getElementById('artworkCount').textContent = categories.artwork.length;
        document.getElementById('previewsCount').textContent = categories.previews.length;
        document.getElementById('tracksCount').textContent = categories.tracks.length;
        document.getElementById('metadataCount').textContent = categories.metadata.length;

        // Display file categories
        const categoriesContainer = document.getElementById('zipFileCategories');
        categoriesContainer.innerHTML = '';

        Object.entries(categories).forEach(([name, files]) => {
          if (files.length === 0) return;

          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'zip-category';
          categoryDiv.innerHTML = `
            <div class="zip-category-header" onclick="this.parentElement.classList.toggle('expanded')">
              <div class="zip-category-title">${getIcon(name)} ${name.toUpperCase()}</div>
              <div class="zip-category-count">${files.length} files</div>
            </div>
            <div class="zip-category-files">
              ${files.map(f => `<div class="zip-file-item">${f}</div>`).join('')}
            </div>
          `;
          categoriesContainer.appendChild(categoryDiv);
        });

        // Show preview and checklist
        zipPreviewSection.classList.add('show');
        checklistSection.classList.add('show');
        
        // Enable submit button
        submitBtn.disabled = false;
        
        // Store for upload
        zipFileData = file;

      } catch (error) {
        console.error('Error analyzing ZIP:', error);
        alert('Error reading ZIP file: ' + error.message);
      }
    }

    function getIcon(category) {
      const icons = {
        artwork: 'üñºÔ∏è',
        previews: 'üéµ',
        tracks: 'üíø',
        metadata: 'üìÑ'
      };
      return icons[category] || 'üìé';
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!zipFileData) {
        showStatusMessage('error', 'No File Selected', 'Please select a ZIP file to upload.');
        return;
      }

      // Reset and show progress
      resetProgress();
      progressSection.classList.add('show');
      statusMessage.classList.remove('show');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Uploading...';

      uploadStartTime = Date.now();
      totalBytes = zipFileData.size;

      try {
        // Create FormData
        const formData = new FormData();
        formData.append('package', zipFileData);
        formData.append('releaseId', 'temp-' + Date.now());

        // Simulate progress tracking
        const progressInterval = setInterval(() => {
          if (uploadedBytes < totalBytes * 0.9) {
            uploadedBytes += totalBytes * 0.05;
            updateProgress();
          }
        }, 500);

        addLog('üì¶ Starting upload process...', 'processing');
        updateCurrentFile('üì¶', 'Preparing upload...');

        addLog('üîç Extracting ZIP contents...', 'processing');
        updateCurrentFile('üîç', 'Extracting files...');

        // Upload to server
        const response = await fetch('/api/upload-final', {
          method: 'POST',
          body: formData,
        });

        clearInterval(progressInterval);
        uploadedBytes = totalBytes;
        updateProgress();

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Upload failed');
        }

        // Success logs
        addLog(`‚úÖ Successfully uploaded ${result.filesUploaded} files`, 'success');
        addLog(`üìÅ Release ID: ${result.releaseId}`, 'complete');
        addLog(`üéµ Artist: ${result.artistName}`, 'complete');
        addLog(`üíø Release: ${result.releaseName}`, 'complete');
        addLog(`üìÇ R2 Folder: ${result.folderName}`, 'complete');
        addLog(`üìä Status: Pending (awaiting approval)`, 'complete');
        addLog(`üî• Synced to Firebase successfully`, 'success');

        updateCurrentFile('‚úÖ', 'Upload Complete!');
        
        showStatusMessage(
          'success', 
          '‚úÖ Upload Complete!', 
          `Release "${result.releaseName}" by ${result.artistName} has been uploaded successfully. ${result.filesUploaded} files synced to R2 folder "${result.folderName}" and Firebase. Status: Pending approval.`
        );

        // Reset form
        form.reset();
        zipPreviewSection.classList.remove('show');
        checklistSection.classList.remove('show');
        zipFileData = null;
        
        // Hide progress after delay
        setTimeout(() => {
          progressSection.classList.remove('show');
        }, 3000);

      } catch (error) {
        console.error('Upload error:', error);
        addLog(`‚ùå Error: ${error.message}`, 'error');
        updateCurrentFile('‚ùå', 'Upload Failed');
        
        showStatusMessage(
          'error',
          '‚ùå Upload Failed',
          `Error: ${error.message}. Please check the console for details and try again.`
        );
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üöÄ Upload & Sync Release';
      }
    });

    function resetProgress() {
      uploadLog.innerHTML = '';
      processedCount = 0;
      uploadedBytes = 0;
      filesProcessed.textContent = '0';
      uploadPercent.textContent = '0%';
      uploadSpeed.textContent = '0 KB/s';
      progressBarFill.style.width = '0%';
    }

    function updateProgress() {
      const percent = Math.min(100, Math.round((uploadedBytes / totalBytes) * 100));
      const elapsed = (Date.now() - uploadStartTime) / 1000;
      const bytesPerSecond = uploadedBytes / elapsed;
      
      let speedText;
      if (bytesPerSecond > 1024 * 1024) {
        speedText = (bytesPerSecond / (1024 * 1024)).toFixed(2) + ' MB/s';
      } else if (bytesPerSecond > 1024) {
        speedText = (bytesPerSecond / 1024).toFixed(2) + ' KB/s';
      } else {
        speedText = bytesPerSecond.toFixed(0) + ' B/s';
      }
      
      uploadPercent.textContent = percent + '%';
      uploadSpeed.textContent = speedText;
      progressBarFill.style.width = percent + '%';
    }

    function updateCurrentFile(icon, name) {
      currentFileIcon.textContent = icon;
      currentFileName.textContent = name;
    }

    function addLog(message, type = 'complete') {
      const logItem = document.createElement('div');
      logItem.className = `log-item ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      logItem.textContent = `[${timestamp}] ${message}`;
      uploadLog.appendChild(logItem);
      uploadLog.scrollTop = uploadLog.scrollHeight;

      if (type === 'complete' || type === 'success') {
        processedCount++;
        filesProcessed.textContent = processedCount;
      }
    }

    function showStatusMessage(type, title, text) {
      statusMessage.className = `status-message ${type} show`;
      document.getElementById('statusTitle').textContent = title;
      document.getElementById('statusText').textContent = text;
    }
  </script>
</body>
</html>