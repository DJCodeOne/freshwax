---
// src/pages/admin/sync-release.astro
// Fresh Wax Release Upload - Unified Admin Design

import AdminLayout from '../../layouts/AdminLayout.astro';

export const prerender = false;
---

<AdminLayout title="Upload Release" activeNav="releases">
  <Fragment slot="actions">
    <a href="/admin/releases/manage" class="btn btn-outline">‚Üê Back to Releases</a>
  </Fragment>

  <div class="grid grid-2 gap-3">
    <!-- Upload Section -->
    <div class="card">
      <div class="card-header">
        <h2>üì¶ Upload Release Package</h2>
      </div>
      <div class="card-body">
        <div 
          id="dropZone" 
          class="drop-zone"
        >
          <div class="drop-zone-icon">üìÅ</div>
          <div class="drop-zone-text">
            <strong>Drop ZIP file here</strong>
            <span>or click to browse</span>
          </div>
          <input type="file" id="fileInput" accept=".zip" hidden>
        </div>
        
        <div id="uploadProgress" class="upload-progress hidden">
          <div class="progress-info">
            <span id="fileName">release.zip</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div id="uploadStatus" class="upload-status">Uploading...</div>
        </div>

        <div class="form-hint mt-2">
          <strong>ZIP Structure:</strong> Artist Name - Release Name.zip containing cover.jpg/png and audio files (MP3/WAV/FLAC)
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="card card-soft">
      <div class="card-header">
        <h2>üìã Instructions</h2>
      </div>
      <div class="card-body">
        <div class="instruction-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Prepare ZIP File</strong>
            <p>Name format: <code>Artist Name - Release Name.zip</code></p>
          </div>
        </div>
        
        <div class="instruction-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <strong>Include Cover Art</strong>
            <p>File named <code>cover.jpg</code> or <code>cover.png</code> (min 1000x1000px)</p>
          </div>
        </div>
        
        <div class="instruction-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <strong>Include Tracks</strong>
            <p>Audio files in MP3, WAV, FLAC, or AIFF format</p>
          </div>
        </div>
        
        <div class="instruction-step">
          <div class="step-number">4</div>
          <div class="step-content">
            <strong>Upload & Process</strong>
            <p>System extracts metadata and creates release</p>
          </div>
        </div>

        <div class="example-box mt-3">
          <strong>Example Structure:</strong>
          <pre>DJ Producer - Jungle EP.zip
‚îú‚îÄ‚îÄ cover.jpg
‚îú‚îÄ‚îÄ 01 - Track One.mp3
‚îú‚îÄ‚îÄ 02 - Track Two.mp3
‚îî‚îÄ‚îÄ 03 - Track Three.mp3</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Results -->
  <div id="resultsSection" class="card mt-3 hidden">
    <div class="card-header">
      <h2>‚úÖ Processing Complete</h2>
    </div>
    <div class="card-body">
      <div id="resultsContent"></div>
    </div>
    <div class="card-footer">
      <a href="/admin/releases/manage" class="btn btn-primary">View All Releases</a>
      <button class="btn btn-outline" onclick="location.reload()">Upload Another</button>
    </div>
  </div>

  <Fragment slot="scripts">
    <script is:inline>
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      const progressPercent = document.getElementById('progressPercent');
      const fileName = document.getElementById('fileName');
      const uploadStatus = document.getElementById('uploadStatus');
      const resultsSection = document.getElementById('resultsSection');
      const resultsContent = document.getElementById('resultsContent');

      // Click to browse
      dropZone.addEventListener('click', () => fileInput.click());

      // Drag and drop events
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.zip')) {
          handleFile(files[0]);
        } else {
          showToast('Please upload a ZIP file', 'error');
        }
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      async function handleFile(file) {
        if (!file.name.endsWith('.zip')) {
          showToast('Please upload a ZIP file', 'error');
          return;
        }

        fileName.textContent = file.name;
        dropZone.classList.add('hidden');
        uploadProgress.classList.remove('hidden');
        resultsSection.classList.add('hidden');

        try {
          // Upload with progress tracking
          const formData = new FormData();
          formData.append('zipFile', file);

          const xhr = new XMLHttpRequest();
          
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              progressFill.style.width = percent + '%';
              progressPercent.textContent = percent + '%';
              
              if (percent === 100) {
                uploadStatus.textContent = 'Processing ZIP file...';
              }
            }
          });

          xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
              try {
                const result = JSON.parse(xhr.responseText);
                showResults(result);
              } catch (e) {
                showError('Invalid response from server');
              }
            } else {
              try {
                const errorResponse = JSON.parse(xhr.responseText);
                showError(errorResponse.error || errorResponse.message || 'Upload failed');
              } catch (e) {
                showError('Upload failed: ' + xhr.statusText);
              }
            }
          });

          xhr.addEventListener('error', () => {
            showError('Network error during upload');
          });

          xhr.open('POST', '/api/sync-release');
          xhr.send(formData);

        } catch (error) {
          showError(error.message || 'Upload failed');
        }
      }

      function showResults(result) {
        uploadProgress.classList.add('hidden');
        resultsSection.classList.remove('hidden');

        if (result.success) {
          const release = result.release || {};
          resultsContent.innerHTML = `
            <div class="result-success">
              <div class="result-header">
                ${release.coverArtUrl ? `<img src="${release.coverArtUrl}" alt="Cover" class="result-cover">` : ''}
                <div class="result-info">
                  <h3>${release.releaseName || 'Unknown Release'}</h3>
                  <p>by ${release.artistName || 'Unknown Artist'}</p>
                  <span class="badge badge-pending">Pending Review</span>
                </div>
              </div>
              
              <div class="result-details mt-3">
                <div class="detail-row">
                  <span class="detail-label">Catalogue #</span>
                  <span class="detail-value">${release.catalogNumber || 'Not set'}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Tracks</span>
                  <span class="detail-value">${release.tracks?.length || release.trackCount || 0} tracks</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Release ID</span>
                  <span class="detail-value font-mono">${release.id || result.releaseId || '-'}</span>
                </div>
              </div>
              
              ${release.tracks?.length > 0 ? `
                <div class="tracks-list mt-3">
                  <strong>Tracks:</strong>
                  <ol>
                    ${release.tracks.map(t => `<li>${t.title || t.name || 'Untitled'}</li>`).join('')}
                  </ol>
                </div>
              ` : ''}
              
              <div class="result-note mt-3">
                <strong>‚ö†Ô∏è Note:</strong> This release is pending review. Go to <a href="/admin/releases/manage">Manage Releases</a> to review, edit details, and publish it live.
              </div>
            </div>
          `;
          showToast('Release uploaded successfully! Awaiting review.');
        } else {
          showError(result.message || 'Processing failed');
        }
      }

      function showError(message) {
        uploadProgress.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        
        resultsContent.innerHTML = `
          <div class="result-error">
            <div class="error-icon">‚ùå</div>
            <h3>Upload Failed</h3>
            <p>${message}</p>
            <button class="btn btn-primary mt-2" onclick="location.reload()">Try Again</button>
          </div>
        `;
        
        showToast(message, 'error');
      }
    </script>
  </Fragment>
</AdminLayout>

<style is:global>
  .drop-zone {
    border: 3px dashed var(--border-medium);
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .drop-zone:hover,
  .drop-zone.drag-over {
    border-color: var(--accent-red);
    background: #fef2f2;
  }
  
  .drop-zone-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .drop-zone-text {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .drop-zone-text strong {
    font-size: 1.1rem;
  }
  
  .drop-zone-text span {
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  
  .upload-progress {
    padding: 1.5rem;
    background: var(--bg-primary);
    border: 2px solid var(--border-light);
  }
  
  .progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  
  .progress-bar {
    height: 8px;
    background: var(--border-light);
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: var(--accent-red);
    width: 0%;
    transition: width 0.3s;
  }
  
  .upload-status {
    margin-top: 0.75rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }
  
  .instruction-step {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }
  
  .step-number {
    width: 28px;
    height: 28px;
    background: var(--bg-dark);
    color: var(--text-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
    flex-shrink: 0;
  }
  
  .step-content p {
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }
  
  .step-content code {
    background: var(--bg-primary);
    padding: 0.1rem 0.3rem;
    font-size: 0.8rem;
  }
  
  .example-box {
    background: var(--bg-primary);
    padding: 1rem;
    border: 1px solid var(--border-light);
  }
  
  .example-box pre {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    font-family: 'SF Mono', Monaco, monospace;
    white-space: pre;
    overflow-x: auto;
  }
  
  .result-success,
  .result-error {
    padding: 1rem;
  }
  
  .result-error {
    text-align: center;
    padding: 2rem;
  }
  
  .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .result-header {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
  }
  
  .result-cover {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border: 2px solid var(--border-dark);
  }
  
  .result-info h3 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }
  
  .result-info p {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }
  
  .result-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-primary);
  }
  
  .detail-row {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .detail-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  
  .detail-value {
    font-weight: 600;
  }
  
  .tracks-list {
    padding: 1rem;
    background: var(--bg-primary);
  }
  
  .tracks-list ol {
    margin-top: 0.5rem;
    padding-left: 1.5rem;
  }
  
  .tracks-list li {
    padding: 0.25rem 0;
    font-size: 0.9rem;
  }
  
  .badge-pending {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #fef3c7;
    color: #92400e;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: 4px;
  }
  
  .badge-live {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #dcfce7;
    color: #166534;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: 4px;
  }
  
  .result-note {
    padding: 1rem;
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    font-size: 0.875rem;
    color: #92400e;
  }
  
  .result-note a {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
  }
  
  .hidden {
    display: none !important;
  }
  
  @media (max-width: 768px) {
    .result-header {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .result-details {
      grid-template-columns: 1fr;
    }
  }
</style>
