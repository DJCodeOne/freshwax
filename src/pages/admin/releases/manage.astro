---
// src/pages/admin/releases/manage.astro
// Fresh Wax Releases Management - Unified Admin Design

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { initializeApp, getApps, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

let releases = [];
let errorMessage = '';

try {
  const releasesSnapshot = await db.collection('releases').get();
  
  releasesSnapshot.forEach(doc => {
    const data = doc.data();
    releases.push({
      id: doc.id,
      ...data
    });
  });
  
  // Sort by processedAt or createdAt (newest first)
  releases.sort((a, b) => {
    const dateA = new Date(a.processedAt || a.createdAt || 0);
    const dateB = new Date(b.processedAt || b.createdAt || 0);
    return dateB.getTime() - dateA.getTime();
  });
  
} catch (error) {
  console.error('[MANAGE] Error loading releases:', error);
  errorMessage = error instanceof Error ? error.message : 'Unknown error';
}

// Stats
const totalReleases = releases.length;
const liveReleases = releases.filter(r => r.status === 'live').length;
const pendingReleases = releases.filter(r => r.status === 'pending').length;
const draftReleases = releases.filter(r => r.status === 'draft').length;
const vinylReleases = releases.filter(r => r.vinylRelease === true).length;

const stats = [
  { label: 'Total', value: totalReleases },
  { label: 'Live', value: liveReleases, type: 'success' },
  { label: 'Pending', value: pendingReleases, type: pendingReleases > 0 ? 'warning' : 'default' },
  { label: 'Draft', value: draftReleases },
  { label: 'Vinyl', value: vinylReleases, type: 'info' },
];

// Format date
const formatDate = (dateStr) => {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
};

// Format currency
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount || 0);
};

export const prerender = false;
---

<AdminLayout title="Releases" activeNav="releases" showStats={true} stats={stats}>
  <Fragment slot="actions">
    <a href="/admin/sync-release" class="btn btn-primary">+ Upload New Release</a>
  </Fragment>

  <!-- Filters -->
  <div class="toolbar">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All</button>
      <button class="filter-tab" data-filter="live">Live</button>
      <button class="filter-tab" data-filter="pending">Pending</button>
      <button class="filter-tab" data-filter="draft">Draft</button>
    </div>
    
    <div class="filter-group" style="margin-left: auto;">
      <label class="filter-label">Format</label>
      <select id="formatFilter" class="form-select" style="width: auto; padding: 0.5rem 1rem;">
        <option value="">All</option>
        <option value="vinyl">Vinyl Only</option>
        <option value="digital">Digital Only</option>
      </select>
    </div>
    
    <div class="search-wrapper" style="max-width: 250px;">
      <span class="search-icon">ğŸ”</span>
      <input 
        type="text" 
        id="searchInput" 
        class="form-input" 
        placeholder="Search releases..."
      >
    </div>
  </div>

  <!-- Error State -->
  {errorMessage && (
    <div class="card mb-3" style="border-color: var(--accent-red);">
      <div class="card-body" style="background: #fef2f2; color: var(--accent-red);">
        <strong>Error loading releases:</strong> {errorMessage}
      </div>
    </div>
  )}

  <!-- Releases Table -->
  <div class="card">
    <div class="card-header">
      <h2>All Releases</h2>
      <span class="text-muted">{releases.length} releases</span>
    </div>
    <div class="table-wrapper">
      <table class="data-table" id="releasesTable">
        <thead>
          <tr>
            <th>Release</th>
            <th>Artist</th>
            <th>Format</th>
            <th>Price</th>
            <th>Status</th>
            <th>Added</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {releases.length === 0 ? (
            <tr>
              <td colspan="7" class="text-center text-muted" style="padding: 3rem;">
                {errorMessage ? 'Error loading releases' : 'No releases found'}
              </td>
            </tr>
          ) : (
            releases.map(release => (
              <tr 
                data-status={release.status || 'draft'}
                data-format={release.vinylRelease ? 'vinyl' : 'digital'}
                data-search={`${release.releaseName || ''} ${release.artistName || ''}`.toLowerCase()}
              >
                <td>
                  <div class="item-cell">
                    {release.coverArtUrl ? (
                      <img src={release.coverArtUrl} alt="" loading="lazy">
                    ) : (
                      <div style="width: 48px; height: 48px; background: #e5e5e5; display: flex; align-items: center; justify-content: center;">ğŸ’¿</div>
                    )}
                    <div class="item-info">
                      <h4>{release.releaseName || 'Untitled'}</h4>
                      <p class="cell-mono">{release.catalogNumber || release.r2FolderName || '-'}</p>
                    </div>
                  </div>
                </td>
                <td class="cell-primary">
                  {release.artistName || 'Unknown'}
                </td>
                <td>
                  <div class="flex gap-1">
                    <span class="badge badge-info">ğŸ’¿ Digital</span>
                    {release.vinylRelease && (
                      <span class="badge badge-pending">ğŸ“€ Vinyl</span>
                    )}
                  </div>
                </td>
                <td class="font-bold">
                  {formatCurrency(release.pricePerSale || release.pricing?.digital || release.digitalPrice || release.price || 0)}
                  {release.vinylRelease && (release.vinylPrice || release.pricing?.vinyl) && (
                    <div class="cell-secondary">Vinyl: {formatCurrency(release.vinylPrice || release.pricing?.vinyl)}</div>
                  )}
                </td>
                <td>
                  <span class={`badge badge-${release.status || 'draft'}`}>
                    {release.status || 'draft'}
                  </span>
                </td>
                <td class="cell-secondary">
                  {formatDate(release.processedAt || release.createdAt)}
                </td>
                <td class="text-right">
                  <div class="flex gap-1 justify-end">
                    <a 
                      href={`/item/${release.id}`}
                      target="_blank"
                      class="btn btn-ghost btn-sm"
                      title="View on Store"
                    >
                      ğŸ‘ï¸
                    </a>
                    <a 
                      href={`/admin/releases/edit/${release.id}`}
                      class="btn btn-outline btn-sm"
                      title="Edit"
                    >
                      âœï¸
                    </a>
                    {release.status !== 'live' && (
                      <button 
                        class="btn btn-success btn-sm publish-btn"
                        data-id={release.id}
                        title="Publish"
                      >
                        ğŸš€
                      </button>
                    )}
                    <button 
                      class="btn btn-danger btn-sm delete-btn"
                      data-id={release.id}
                      data-name={release.releaseName}
                      title="Delete"
                    >
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>

  <Fragment slot="scripts">
    <script is:inline>
      // Filter functionality
      const filterTabs = document.querySelectorAll('.filter-tab');
      const formatFilter = document.getElementById('formatFilter');
      const searchInput = document.getElementById('searchInput');
      const tableRows = document.querySelectorAll('#releasesTable tbody tr');
      
      let currentStatusFilter = 'all';

      function filterReleases() {
        const format = formatFilter?.value || '';
        const search = searchInput?.value?.toLowerCase() || '';

        tableRows.forEach(row => {
          const rowStatus = row.dataset.status || '';
          const rowFormat = row.dataset.format || '';
          const rowSearch = row.dataset.search || '';

          const matchStatus = currentStatusFilter === 'all' || rowStatus === currentStatusFilter;
          const matchFormat = !format || rowFormat === format;
          const matchSearch = !search || rowSearch.includes(search);

          row.style.display = (matchStatus && matchFormat && matchSearch) ? '' : 'none';
        });
      }

      filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          filterTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentStatusFilter = tab.dataset.filter;
          filterReleases();
        });
      });

      formatFilter?.addEventListener('change', filterReleases);
      searchInput?.addEventListener('input', filterReleases);

      // Publish release
      document.querySelectorAll('.publish-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          
          if (!confirm('Publish this release and make it live on the store?')) return;
          
          btn.disabled = true;
          btn.textContent = '...';
          
          try {
            const response = await fetch('/api/approve-release', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ releaseId: id })
            });
            
            if (!response.ok) throw new Error('Failed to publish');
            
            showToast('Release published successfully!');
            setTimeout(() => location.reload(), 1000);
            
          } catch (error) {
            console.error(error);
            showToast('Failed to publish release', 'error');
            btn.disabled = false;
            btn.textContent = 'ğŸš€';
          }
        });
      });

      // Delete release
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const name = btn.dataset.name || 'this release';
          
          if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
          
          btn.disabled = true;
          btn.textContent = '...';
          
          try {
            const response = await fetch('/api/delete-release', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ releaseId: id })
            });
            
            if (!response.ok) throw new Error('Failed to delete');
            
            const row = btn.closest('tr');
            row.style.opacity = '0';
            row.style.transition = 'opacity 0.3s';
            setTimeout(() => row.remove(), 300);
            
            showToast('Release deleted');
            
          } catch (error) {
            console.error(error);
            showToast('Failed to delete release', 'error');
            btn.disabled = false;
            btn.textContent = 'ğŸ—‘ï¸';
          }
        });
      });
    </script>
  </Fragment>
</AdminLayout>
