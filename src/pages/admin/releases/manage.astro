---
// src/pages/admin/releases/manage.astro
// FIXED: Reads correct Firebase schema field names (coverArtUrl instead of artwork.cover)
import { initializeApp, getApps, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

// Initialize Firebase Admin
if (!getApps().length) {
  initializeApp({
    credential: cert({
      projectId: import.meta.env.FIREBASE_PROJECT_ID,
      clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
      privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const db = getFirestore();

let releases = [];
let errorMessage = '';

try {
  console.log('[MANAGE] Starting Firebase query...');
  console.log('[MANAGE] Firebase initialized:', getApps().length > 0);
  
  const releasesSnapshot = await db.collection('releases').get();
  console.log('[MANAGE] Query complete. Documents found:', releasesSnapshot.size);
  
  if (releasesSnapshot.empty) {
    console.log('[MANAGE] ‚ö†Ô∏è No documents in releases collection!');
  }
  
  releasesSnapshot.forEach(doc => {
    const data = doc.data();
    console.log('[MANAGE] Document ID:', doc.id);
    console.log('[MANAGE] Document data:', {
      artistName: data.artistName,
      releaseName: data.releaseName,
      status: data.status,
      coverArtUrl: data.coverArtUrl,
      r2FolderName: data.r2FolderName
    });
    
    releases.push({
      id: doc.id,
      ...data
    });
  });
  
  // Sort by processedAt or createdAt (newest first)
  releases.sort((a, b) => {
    const dateA = new Date(a.processedAt || a.createdAt || 0);
    const dateB = new Date(b.processedAt || b.createdAt || 0);
    return dateB.getTime() - dateA.getTime();
  });
  
  console.log('[MANAGE] ‚úÖ Successfully loaded', releases.length, 'releases');
  if (releases.length > 0) {
    console.log('[MANAGE] First release:', releases[0].artistName, '-', releases[0].releaseName);
  }
} catch (error) {
  console.error('[MANAGE] ‚ùå Error loading releases:', error);
  errorMessage = error instanceof Error ? error.message : 'Unknown error';
}

const totalReleases = releases.length;
const liveReleases = releases.filter(r => r.status === 'live').length;
const pendingReleases = releases.filter(r => r.status === 'pending').length;
const vinylReleases = releases.filter(r => r.vinylRelease === true).length;
const digitalOnly = totalReleases - vinylReleases;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Releases Management - Fresh Wax Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #000000;
      min-height: 100vh;
      color: #ffffff;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .header-bar {
      background: #ffffff;
      border: 2px solid #ffffff;
      padding: 20px 30px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo { height: 60px; width: auto; }

    .back-btn {
      padding: 10px 20px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      text-decoration: none;
      font-size: 12px;
      letter-spacing: 1px;
    }

    .back-btn:hover {
      background: #dc2626;
      border-color: #dc2626;
    }

    .page-header {
      background: #ffffff;
      border: 2px solid #ffffff;
      padding: 30px;
      margin-bottom: 30px;
      color: #000000;
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 900;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #ffffff;
      border: 2px solid #ffffff;
      padding: 20px;
      transition: all 0.2s;
      color: #000000;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .stat-label {
      font-size: 11px;
      font-weight: 700;
      color: #666666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value { 
      font-size: 32px; 
      font-weight: 900; 
      line-height: 1;
      color: #000000;
    }

    .toolbar {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #ffffff;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 12px;
      border: 2px solid #000000;
      font-size: 14px;
      font-weight: 600;
      background: #ffffff;
      color: #000000;
    }

    .search-input:focus {
      outline: none;
      border-color: #dc2626;
    }

    .releases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .release-card {
      background: #ffffff;
      border: 2px solid #ffffff;
      overflow: hidden;
      transition: all 0.2s;
      cursor: pointer;
      color: #000000;
    }

    .release-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(255, 255, 255, 0.2);
    }

    .release-artwork-container {
      width: 100%;
      height: 300px;
      border-bottom: 2px solid #000000;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .release-artwork {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .release-artwork-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
      font-size: 48px;
      color: #999;
    }

    .release-content {
      padding: 20px;
    }

    .release-title {
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 5px;
      text-transform: uppercase;
      color: #000000;
    }

    .release-artist {
      font-size: 14px;
      color: #666666;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .release-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #000000;
    }

    .release-price {
      font-size: 20px;
      font-weight: 900;
      color: #000000;
    }

    .release-status {
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      border-radius: 3px;
    }

    .release-status.live {
      background: #16a34a;
      color: white;
    }

    .release-status.pending {
      background: #f59e0b;
      color: white;
    }

    .release-status.hidden {
      background: #ef4444;
      color: white;
    }

    .release-info {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .info-badge {
      padding: 2px 6px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      color: #000000;
    }

    .release-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    .btn-edit, .btn-delete {
      flex: 1;
      padding: 10px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      cursor: pointer;
      border: 2px solid #000000;
      transition: all 0.2s;
    }

    .btn-edit {
      background: #000;
      color: #fff;
    }

    .btn-edit:hover {
      background: #16a34a;
      border-color: #16a34a;
    }

    .btn-delete {
      background: #fff;
      color: #000;
    }

    .btn-delete:hover {
      background: #dc2626;
      color: #ffffff;
      border-color: #dc2626;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: #fff;
      border: 2px solid #fff;
      color: #000000;
    }

    .empty-state h3 {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 10px;
    }

    .error {
      background: #dc2626;
      color: #fff;
      padding: 15px;
      border: 2px solid #dc2626;
      margin-bottom: 20px;
      font-weight: 700;
    }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header-bar { flex-direction: column; gap: 15px; }
      .logo { height: 60px; }
      .page-header h1 { font-size: 24px; }
      .releases-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header-bar">
      <img src="/logo.webp" alt="Fresh Wax" class="logo" onerror="this.style.display='none'">
      <a href="/admin" class="back-btn">‚Üê Dashboard</a>
    </div>

    <div class="page-header">
      <h1>üéµ Releases Management</h1>
      <p>Review and manage all music releases</p>
    </div>

    {errorMessage && (
      <div class="error">‚ö†Ô∏è Error loading releases: {errorMessage}</div>
    )}

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Releases</div>
        <div class="stat-value">{totalReleases}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Live</div>
        <div class="stat-value">{liveReleases}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{pendingReleases}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Digital Only</div>
        <div class="stat-value">{digitalOnly}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Vinyl Available</div>
        <div class="stat-value">{vinylReleases}</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <input 
        type="text" 
        id="searchInput" 
        class="search-input" 
        placeholder="Search releases by title or artist..."
      />
    </div>

    {releases.length === 0 ? (
      <div class="empty-state">
        <h3>No Releases Found</h3>
        <p>Use the upload tool to add your first release!</p>
      </div>
    ) : (
      <div class="releases-grid" id="releasesGrid">
        {releases.map((release) => {
          // FIXED: Use correct Firebase schema field names
          const artworkUrl = release.coverArtUrl || release.artwork?.cover || '';
          const title = release.releaseName || 'Untitled';
          const artist = release.artistName || 'Unknown Artist';
          const price = release.pricePerSale || release.pricing?.digital || 0;
          const status = release.status || 'pending';
          const trackCount = release.stats?.totalTracks || release.tracks?.length || 0;
          const genre = release.genre || '';
          const labelCode = release.labelCode || '';
          
          return (
            <div class="release-card" data-release-id={release.id}>
              <div class="release-artwork-container">
                {artworkUrl ? (
                  <>
                    <img 
                      src={artworkUrl} 
                      alt={title} 
                      class="release-artwork" 
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <div class="release-artwork-placeholder" style="display: none;">üéµ</div>
                  </>
                ) : (
                  <div class="release-artwork-placeholder">üéµ</div>
                )}
              </div>
              <div class="release-content">
                <div class="release-title">{title}</div>
                <div class="release-artist">{artist}</div>
                
                <div class="release-info">
                  {trackCount > 0 && <span class="info-badge">üéµ {trackCount} tracks</span>}
                  {genre && <span class="info-badge">{genre}</span>}
                  {labelCode && <span class="info-badge">{labelCode}</span>}
                  {release.vinylRelease && <span class="info-badge">üíø Vinyl</span>}
                </div>

                <div class="release-meta">
                  <div class="release-price">¬£{price.toFixed(2)}</div>
                  <div class={`release-status ${status}`}>
                    {status === 'live' ? '‚úì Live' : status === 'pending' ? '‚è≥ Pending' : 'üîí Hidden'}
                  </div>
                </div>

                <div class="release-actions">
                  <button 
                    class="btn-edit" 
                    onclick={`window.location.href='/admin/releases/edit/${release.id}'`}
                  >
                    ‚úèÔ∏è Edit
                  </button>
                  <button 
                    class="btn-delete" 
                    data-release-id={release.id}
                    data-release-title={title}
                  >
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>

  <script define:vars={{ releases: JSON.stringify(releases) }}>
    let allReleases = JSON.parse(releases);

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const cards = document.querySelectorAll('.release-card');
      
      cards.forEach(card => {
        const title = card.querySelector('.release-title')?.textContent.toLowerCase() || '';
        const artist = card.querySelector('.release-artist')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm) || artist.includes(searchTerm)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    });

    // Delete release
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async () => {
        const releaseId = btn.getAttribute('data-release-id');
        const releaseTitle = btn.getAttribute('data-release-title');

        if (!confirm(`Are you sure you want to delete "${releaseTitle}"?\n\nThis will remove it from Firebase.\nThis cannot be undone.`)) {
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Deleting...';

        try {
          const response = await fetch('/api/delete-release', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ releaseId })
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert('‚úÖ Release deleted successfully!');
            window.location.reload();
          } else {
            alert('‚ùå Failed to delete release: ' + (result.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'üóëÔ∏è Delete';
          }
        } catch (error) {
          console.error('Error deleting release:', error);
          alert('‚ùå Failed to delete release: ' + error.message);
          btn.disabled = false;
          btn.textContent = 'üóëÔ∏è Delete';
        }
      });
    });
  </script>
</body>
</html>