---
// src/pages/admin/releases/edit/[id].astro
// FINAL VERSION - Exact Firebase field mapping based on actual collection data
import { getDocument } from '../../../../lib/firebase-rest';
import '../../../../styles/admin/releases/edit.css';

export const prerender = false;

const { id } = Astro.params;

// Get admin key for API calls
const runtimeEnv = Astro.locals.runtime?.env;
const adminKey = runtimeEnv?.ADMIN_KEY || import.meta.env.ADMIN_KEY || '';

// Fetch release from Firebase REST API
let release = null;
let errorMessage = '';

try {
  const releaseDoc = await getDocument('releases', id as string);

  if (releaseDoc) {
    release = { id, ...releaseDoc };
  } else {
    errorMessage = 'Release not found';
  }
} catch (error) {
  console.error('[EDIT] Error loading release:', error);
  errorMessage = error instanceof Error ? error.message : 'Unknown error';
}

if (!release) {
  return Astro.redirect('/admin/releases/manage');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Release - {release.releaseName} - Fresh Wax Admin</title>
</head>
<body>
  <div class="container">
    <div class="header-bar">
      <img src="/logo.webp" alt="Fresh Wax" class="logo" onerror="this.style.display='none'">
      <div style="display: flex; gap: 10px;">
        <button type="button" id="refreshBtn" class="back-btn" style="background: #16a34a; border-color: #16a34a;">
          üîÑ Refresh
        </button>
        <a href="/admin/releases/manage" class="back-btn">‚Üê Back to Releases</a>
      </div>
    </div>

    <div class="page-header">
      <h1>‚úèÔ∏è Edit Release</h1>
      <div class="release-meta">
        <span><span class="label">ID:</span> <span class="value">{release.id}</span></span>
        <span><span class="label">Status:</span> <span class="value">{release.status}</span></span>
        {release.r2FolderName && (
          <span><span class="label">R2:</span> <span class="value">{release.r2FolderName}</span></span>
        )}
      </div>
    </div>

    <form id="editForm">
      
      <div class="grid-2">
        <!-- LEFT COLUMN -->
        <div>
          
          <!-- BASIC INFORMATION -->
          <div class="edit-section">
            <h2 class="section-title">üìù Basic Information</h2>
            
            <div class="form-group">
              <label class="form-label">Release Title <span class="required">*</span></label>
              <input type="text" name="releaseName" class="form-input" value={release.releaseName || ''} required maxlength="30" />
            </div>

            <div class="form-group">
              <label class="form-label">Artist Name <span class="required">*</span></label>
              <input type="text" name="artistName" class="form-input" value={release.artistName || ''} required maxlength="30" />
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">
                  Label Name
                  <button type="button" class="copy-holder-btn" id="copyFromCopyrightBtn">‚Üê Copy from Copyright Holder</button>
                </label>
                <input type="text" name="labelName" class="form-input" id="labelNameInput" value={release.labelName || release.copyrightHolder || ''} maxlength="30" />
              </div>

              <div class="form-group">
                <label class="form-label">Catalogue Number</label>
                <input type="text" name="labelCode" class="form-input" value={release.labelCode || ''} maxlength="20" />
              </div>
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Genre</label>
                <input type="text" name="genre" class="form-input" value={release.genre || ''} maxlength="30" />
              </div>

              <div class="form-group">
                <label class="form-label">Release Type</label>
                <select name="releaseType" class="form-select">
                  <option value="EP" selected={release.releaseType === 'EP' || !release.releaseType}>EP</option>
                  <option value="Album" selected={release.releaseType === 'Album'}>Album</option>
                  <option value="Single" selected={release.releaseType === 'Single'}>Single</option>
                  <option value="Compilation" selected={release.releaseType === 'Compilation'}>Compilation</option>
                </select>
              </div>
            </div>

            <div class="field-group-title">Dates</div>

            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Store Release Date <span class="hint">(When it goes live on Fresh Wax)</span></label>
                <input type="date" name="releaseDate" class="form-input" id="releaseDateInput" value={release.createdAt?.split('T')[0] || ''} />
              </div>

              <div class="form-group">
                <label class="form-label">Original Release Date <span class="hint">(When music was originally released)</span></label>
                <input type="date" name="originalReleaseDate" class="form-input" value={release.originalReleaseDate?.split('T')[0] || release.releaseDate?.split('T')[0] || ''} />
              </div>
            </div>

            <div class="field-group-title">Credits</div>

            <div class="form-group">
              <label class="form-label">Mastered By</label>
              <input type="text" name="masteredBy" class="form-input" value={release.masteredBy || ''} />
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Primary Language</label>
                <input type="text" name="primaryLanguage" class="form-input" value={release.primaryLanguage || 'English'} />
              </div>

              <div class="form-group">
                <label class="checkbox-group">
                  <input type="checkbox" name="hasExplicitContent" checked={release.hasExplicitContent || false} />
                  <span class="checkbox-label">‚ö†Ô∏è Explicit Content</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Release Description</label>
              <textarea name="releaseDescription" class="form-textarea" placeholder="Description...">{release.releaseDescription || ''}</textarea>
            </div>

            <div class="field-group-title">Admin Notes <span style="font-weight: 400; text-transform: none;">(metadata.notes - internal)</span></div>

            <div class="form-group">
              <label class="form-label">Artist Social Links <span class="hint">(SoundCloud, Facebook, Instagram, etc.)</span></label>
              <textarea name="artistSocialLinks" class="form-textarea" style="min-height: 80px;" placeholder="One link per line..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Other Notes <span class="hint">(General internal notes)</span></label>
              <textarea name="otherNotes" class="form-textarea" style="min-height: 60px;" placeholder="Any other internal notes..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Track Listing <span class="hint">(Plain text backup)</span></label>
              <textarea name="trackListing" class="form-textarea" style="min-height: 60px;" placeholder="Track names separated by newlines...">{release.trackListing || ''}</textarea>
            </div>
          </div>

          <!-- PRICING -->
          <div class="edit-section">
            <h2 class="section-title">üí∞ Pricing</h2>
            
            <div class="form-row-3">
              <div class="form-group">
                <label class="form-label">Digital Album (¬£) <span class="hint">pricePerSale</span></label>
                <input type="number" name="pricePerSale" id="pricePerSale" class="form-input" step="0.01" min="0" value={Number(release.pricePerSale ?? release.pricing?.digital ?? 0).toFixed(2)} />
              </div>

              <div class="form-group">
                <label class="form-label">Per Track (¬£) <span class="hint">trackPrice</span></label>
                <input type="number" name="trackPrice" class="form-input" step="0.01" min="0" value={Number(release.trackPrice ?? release.pricing?.track ?? 1.00).toFixed(2)} />
              </div>

              <div class="form-group">
                <label class="form-label">Vinyl (¬£) <span class="hint">vinylPrice</span></label>
                <input type="number" name="vinylPrice" class="form-input" step="0.01" min="0" value={Number(release.vinylPrice ?? release.pricing?.vinyl ?? release.vinyl?.price ?? 0).toFixed(2)} />
              </div>
            </div>

            <!-- Special Pricing Options -->
            <div class="form-row-2" style="margin-top: 1rem;">
              <div class="form-group">
                <label class="checkbox-group">
                  <input type="checkbox" name="freeDownload" id="freeDownload" checked={release.freeDownload || false} />
                  <span class="checkbox-label">Free Download</span>
                </label>
                <p class="field-hint">Enable to offer this release for free (digital price set to ¬£0)</p>
              </div>

              <div class="form-group">
                <label class="checkbox-group">
                  <input type="checkbox" name="specialOffer" id="specialOffer" checked={release.specialOffer || false} />
                  <span class="checkbox-label">Special Offer</span>
                </label>
                <div id="specialOfferPrice" style={release.specialOffer ? '' : 'display: none'}>
                  <label class="form-label" style="margin-top: 0.5rem;">Offer Price (¬£)</label>
                  <input type="number" name="offerPrice" class="form-input" step="0.01" min="0" value={Number(release.offerPrice ?? 0).toFixed(2)} />
                </div>
              </div>
            </div>

            <!-- Name Your Own Price (NYOP) Section -->
            <div class="form-group" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
              <label class="checkbox-group">
                <input type="checkbox" name="nyopEnabled" id="nyopEnabled" checked={release.nyopEnabled || false} />
                <span class="checkbox-label">üéØ Name Your Own Price (Digital)</span>
              </label>
              <p class="field-hint">Let customers choose their price for digital downloads (like Bandcamp)</p>
            </div>

            <div id="nyopOptions" style={release.nyopEnabled ? '' : 'display: none'}>
              <div class="form-row-2">
                <div class="form-group">
                  <label class="form-label">Minimum Price (¬£) <span class="hint">nyopMinPrice</span></label>
                  <input type="number" name="nyopMinPrice" class="form-input" step="0.01" min="0" value={Number(release.nyopMinPrice ?? 0).toFixed(2)} placeholder="0.00" />
                  <p class="field-hint">Set to ¬£0 for free downloads</p>
                </div>

                <div class="form-group">
                  <label class="form-label">Suggested Price (¬£) <span class="hint">nyopSuggestedPrice</span></label>
                  <input type="number" name="nyopSuggestedPrice" class="form-input" step="0.01" min="0" value={release.nyopSuggestedPrice ? Number(release.nyopSuggestedPrice).toFixed(2) : ''} placeholder="Optional" />
                  <p class="field-hint">Pre-filled in price input (optional)</p>
                </div>
              </div>
            </div>
          </div>

          <!-- VINYL OPTIONS -->
          <div class="edit-section">
            <h2 class="section-title">üíø Vinyl Release</h2>

            <div class="form-group">
              <label class="checkbox-group">
                <input type="checkbox" name="vinylRelease" id="vinylRelease" checked={release.vinylRelease || release.vinyl?.available || false} />
                <span class="checkbox-label">Vinyl Available</span>
              </label>
            </div>

            <div id="vinylOptions" style={release.vinylRelease || release.vinyl?.available ? '' : 'display: none'}>
              <div class="form-row-2">
                <div class="form-group">
                  <label class="form-label">Stock Count <span class="hint">vinylRecordCount</span></label>
                  <input type="text" name="vinylRecordCount" class="form-input" value={release.vinylRecordCount || release.vinyl?.recordCount || ''} placeholder="e.g., 100" />
                </div>

                <div class="form-group">
                  <label class="form-label">Pressing Plant</label>
                  <input type="text" name="pressingPlant" class="form-input" value={release.pressingPlant || release.vinyl?.pressingPlant || ''} />
                </div>
              </div>

              <div class="form-row-3">
                <div class="form-group">
                  <label class="form-label">RPM <span class="hint">vinylRPM</span></label>
                  <select name="vinylRPM" class="form-select">
                    <option value="">-</option>
                    <option value="33 RPM" selected={release.vinylRPM === '33 RPM' || release.vinyl?.rpm === '33'}>33 RPM</option>
                    <option value="45 RPM" selected={release.vinylRPM === '45 RPM' || release.vinyl?.rpm === '45'}>45 RPM</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Size <span class="hint">vinylSize</span></label>
                  <select name="vinylSize" class="form-select">
                    <option value="">-</option>
                    <option value='7"' selected={release.vinylSize === '7' || release.vinylSize === '7"' || release.vinyl?.size === '7"'}>7"</option>
                    <option value='10"' selected={release.vinylSize === '10' || release.vinylSize === '10"' || release.vinyl?.size === '10"'}>10"</option>
                    <option value='12"' selected={release.vinylSize === '12' || release.vinylSize === '12"' || release.vinyl?.size === '12"'}>12"</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Weight <span class="hint">vinylWeight</span></label>
                  <select name="vinylWeight" class="form-select">
                    <option value="">-</option>
                    <option value="140g" selected={release.vinylWeight === '140g' || release.vinyl?.weight === '140g'}>140g</option>
                    <option value="180g" selected={release.vinylWeight === '180g' || release.vinyl?.weight === '180g'}>180g</option>
                    <option value="200g" selected={release.vinylWeight === '200g' || release.vinyl?.weight === '200g'}>200g</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Expected Shipping Date</label>
                <input type="date" name="expectedShippingDate" class="form-input" value={release.expectedShippingDate?.split('T')[0] || release.vinyl?.expectedShippingDate?.split('T')[0] || ''} />
              </div>

              <div class="field-group-title">Shipping Rates (¬£) <span style="font-weight: 400; text-transform: none;">(Leave blank to use artist defaults)</span></div>

              <div class="form-row-3">
                <div class="form-group">
                  <label class="form-label">UK Shipping</label>
                  <input type="number" name="vinylShippingUK" class="form-input" step="0.01" min="0" value={release.vinylShippingUK ?? ''} placeholder="4.99" />
                </div>
                <div class="form-group">
                  <label class="form-label">EU Shipping</label>
                  <input type="number" name="vinylShippingEU" class="form-input" step="0.01" min="0" value={release.vinylShippingEU ?? ''} placeholder="9.99" />
                </div>
                <div class="form-group">
                  <label class="form-label">Intl Shipping</label>
                  <input type="number" name="vinylShippingIntl" class="form-input" step="0.01" min="0" value={release.vinylShippingIntl ?? ''} placeholder="14.99" />
                </div>
              </div>

              <div class="form-group">
                <label class="checkbox-group">
                  <input type="checkbox" name="hasLimitedEdition" id="hasLimitedEdition" checked={release.hasLimitedEdition || release.vinyl?.limitedEdition !== null || false} />
                  <span class="checkbox-label">‚≠ê Limited Edition</span>
                </label>
              </div>

              <div id="limitedEditionOptions" style={release.hasLimitedEdition || release.vinyl?.limitedEdition ? '' : 'display: none'}>
                <div class="form-group">
                  <label class="form-label">Limited Edition Type</label>
                  <select name="limitedEditionType" class="form-select">
                    <option value="">Select Type</option>
                    <option value="Numbered" selected={release.limitedEditionType === 'Numbered' || release.vinyl?.limitedEdition?.type === 'Numbered'}>Numbered</option>
                    <option value="Colored Vinyl" selected={release.limitedEditionType === 'Colored Vinyl' || release.vinyl?.limitedEdition?.type === 'Colored Vinyl'}>Colored Vinyl</option>
                    <option value="Test Pressing" selected={release.limitedEditionType === 'Test Pressing' || release.vinyl?.limitedEdition?.type === 'Test Pressing'}>Test Pressing</option>
                    <option value="Other" selected={release.limitedEditionType === 'Other' || release.vinyl?.limitedEdition?.type === 'Other'}>Other</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Details</label>
                  <textarea name="limitedEditionDetails" class="form-textarea" style="min-height: 60px;">{release.limitedEditionDetails || release.vinyl?.limitedEdition?.details || ''}</textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- CONTACT INFO -->
          <div class="edit-section">
            <h2 class="section-title">üìß Contact Information</h2>
            
            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Submitted By</label>
                <input type="text" name="submittedBy" class="form-input" value={release.submittedBy || release.metadata?.submittedBy || ''} />
              </div>

              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-input" value={release.email || release.metadata?.email || ''} />
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div>
          
          <!-- COPYRIGHT & PUBLISHING -->
          <div class="edit-section">
            <h2 class="section-title">¬©Ô∏è Copyright & Publishing</h2>
            
            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Copyright Year</label>
                <input type="number" name="copyrightYear" class="form-input" value={release.copyrightYear || new Date().getFullYear()} min="1900" max={new Date().getFullYear() + 1} />
              </div>

              <div class="form-group">
                <label class="form-label">
                  Copyright Holder
                  <button type="button" class="copy-holder-btn" id="copyLabelBtn">‚Üê Copy Label Name</button>
                </label>
                <input type="text" name="copyrightHolder" class="form-input" id="copyrightHolderInput" value={release.copyrightHolder || ''} />
              </div>
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Publishing Rights</label>
                <input type="text" name="publishingRights" class="form-input" value={release.publishingRights || 'All Rights Reserved'} />
              </div>

              <div class="form-group">
                <label class="form-label">Publishing Company</label>
                <input type="text" name="publishingCompany" class="form-input" value={release.publishingCompany || ''} />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">UPC/EAN Code <span class="hint">(12-13 digits)</span></label>
              <input type="text" name="upcEanCode" class="form-input" value={release.upcEanCode || ''} placeholder="e.g., 123456789012" />
            </div>
          </div>

          <!-- RECORDING INFO -->
          <div class="edit-section">
            <h2 class="section-title">üéôÔ∏è Recording Information</h2>
            
            <div class="form-row-2">
              <div class="form-group">
                <label class="form-label">Recording Location</label>
                <input type="text" name="recordingLocation" class="form-input" value={release.recordingLocation || ''} />
              </div>

              <div class="form-group">
                <label class="form-label">Recording Year</label>
                <input type="text" name="recordingYear" class="form-input" value={release.recordingYear || ''} />
              </div>
            </div>

            <div class="form-group">
              <label class="checkbox-group">
                <input type="checkbox" name="isPreviouslyReleased" id="isPreviouslyReleased" checked={release.isPreviouslyReleased || false} />
                <span class="checkbox-label">Previously Released</span>
              </label>
            </div>
          </div>

          <!-- PRE-ORDER -->
          <div class="edit-section">
            <h2 class="section-title">üìÖ Pre-Order Options</h2>
            
            <div class="form-group">
              <label class="checkbox-group">
                <input type="checkbox" name="hasPreOrder" id="hasPreOrder" checked={release.hasPreOrder || false} />
                <span class="checkbox-label">Enable Pre-Order</span>
              </label>
            </div>

            <div id="preOrderOptions" style={release.hasPreOrder ? '' : 'display: none'}>
              <div class="form-group">
                <label class="form-label">Pre-Order Date</label>
                <input type="date" name="preOrderDate" class="form-input" value={release.preOrderDate?.split('T')[0] || ''} />
              </div>
            </div>
          </div>

          <!-- STATUS -->
          <div class="edit-section">
            <h2 class="section-title">üëÅÔ∏è Status & Visibility</h2>
            
            <div class="form-group">
              <label class="form-label">Release Status <span class="hint">(Controls store visibility)</span></label>
              <select name="status" class="form-select" id="statusSelect">
                <option value="pending" selected={release.status === 'pending'}>‚è≥ Pending - Awaiting review</option>
                <option value="live" selected={release.status === 'live'}>‚úÖ Live - Visible on store</option>
                <option value="hidden" selected={release.status === 'hidden'}>üëÅÔ∏è Hidden - Not visible</option>
                <option value="rejected" selected={release.status === 'rejected'}>‚ùå Rejected - Declined</option>
              </select>
            </div>

            <div class="info-box" style="margin-top: 15px; margin-bottom: 0;">
              <div class="info-box-title">üí° Quick Actions</div>
              <div class="info-box-content">
                <button type="button" class="quick-action-btn" id="goLiveBtn">üöÄ Go Live</button>
                <button type="button" class="quick-action-btn" id="takeDownBtn">üîí Take Down</button>
              </div>
            </div>
          </div>

          <!-- ARTWORK -->
          <div class="edit-section">
            <h2 class="section-title">üñºÔ∏è Artwork</h2>
            
            <div class="info-box info-blue">
              <div class="info-box-title">‚ÑπÔ∏è Read-Only</div>
              <div class="info-box-content">Artwork URLs stored in R2. Re-upload to change.</div>
            </div>

            {release.coverArtUrl && (
              <div class="form-group">
                <img src={release.coverArtUrl} alt="Cover Art" style="max-width: 100%; border: 2px solid #000000;" />
                <div class="url-display" style="margin-top: 10px;">{release.coverArtUrl}</div>
              </div>
            )}

            {release.artwork?.additional && release.artwork.additional.length > 0 && (
              <div class="form-group" style="margin-top: 15px;">
                <label class="form-label">Additional Artwork ({release.artwork.additional.length})</label>
                {release.artwork.additional.map((url: string) => (
                  <div class="url-display" style="margin-top: 5px;">{url}</div>
                ))}
              </div>
            )}
          </div>

        </div>
      </div>

      <!-- TRACKS (Full Width) -->
      <div class="edit-section">
        <h2 class="section-title">üéµ Tracks ({release.tracks?.length || 0})</h2>
        
        <div class="info-box">
          <div class="info-box-title">üí° Drag & Drop to Reorder</div>
          <div class="info-box-content">Audio URLs are read-only. Edit metadata below.</div>
        </div>

        <div class="track-list" id="trackList">
          {release.tracks && release.tracks.map((track: any, index: number) => (
            <div class="track-item" data-track-index={index} draggable="true">
              <div class="track-header">
                <span class="track-drag-handle">‚ãÆ‚ãÆ</span>
                <span class="track-number">#{track.displayTrackNumber || track.trackNumber + 1 || index + 1}</span>
                <input type="text" name={'track_' + index + '_trackName'} class="form-input" value={track.trackName || ''} placeholder="Track Name" style="flex: 1; margin: 0;" />
              </div>

              <div class="form-row-4">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">BPM</label>
                  <input type="number" name={'track_' + index + '_bpm'} class="form-input" value={track.bpm || ''} placeholder="170" min="60" max="300" />
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Key</label>
                  <select name={'track_' + index + '_key'} class="form-select">
                    <option value="" selected={!track.key || track.key === '--'}>--</option>
                    <option value="A min" selected={track.key === 'A min'}>A min</option>
                    <option value="A maj" selected={track.key === 'A maj'}>A maj</option>
                    <option value="A# min" selected={track.key === 'A# min'}>A# min</option>
                    <option value="A# maj" selected={track.key === 'A# maj'}>A# maj</option>
                    <option value="B min" selected={track.key === 'B min'}>B min</option>
                    <option value="B maj" selected={track.key === 'B maj'}>B maj</option>
                    <option value="C min" selected={track.key === 'C min'}>C min</option>
                    <option value="C maj" selected={track.key === 'C maj'}>C maj</option>
                    <option value="C# min" selected={track.key === 'C# min'}>C# min</option>
                    <option value="C# maj" selected={track.key === 'C# maj'}>C# maj</option>
                    <option value="D min" selected={track.key === 'D min'}>D min</option>
                    <option value="D maj" selected={track.key === 'D maj'}>D maj</option>
                    <option value="D# min" selected={track.key === 'D# min'}>D# min</option>
                    <option value="D# maj" selected={track.key === 'D# maj'}>D# maj</option>
                    <option value="E min" selected={track.key === 'E min'}>E min</option>
                    <option value="E maj" selected={track.key === 'E maj'}>E maj</option>
                    <option value="F min" selected={track.key === 'F min'}>F min</option>
                    <option value="F maj" selected={track.key === 'F maj'}>F maj</option>
                    <option value="F# min" selected={track.key === 'F# min'}>F# min</option>
                    <option value="F# maj" selected={track.key === 'F# maj'}>F# maj</option>
                    <option value="G min" selected={track.key === 'G min'}>G min</option>
                    <option value="G maj" selected={track.key === 'G maj'}>G maj</option>
                    <option value="G# min" selected={track.key === 'G# min'}>G# min</option>
                    <option value="G# maj" selected={track.key === 'G# maj'}>G# maj</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Duration</label>
                  <input type="text" name={'track_' + index + '_duration'} class="form-input" value={track.duration || ''} placeholder="5:12" />
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">ISRC Code</label>
                  <input type="text" name={'track_' + index + '_trackISRC'} class="form-input" value={track.trackISRC || ''} placeholder="GBxxx0000000" />
                </div>
              </div>

              <div class="form-row-2" style="margin-top: 15px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Featured Artist</label>
                  <input type="text" name={'track_' + index + '_featured'} class="form-input" value={track.featured || ''} placeholder="ft. Artist Name" />
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Remixer</label>
                  <input type="text" name={'track_' + index + '_remixer'} class="form-input" value={track.remixer || ''} placeholder="Remixer Name" />
                </div>
              </div>

              <div class="track-urls">
                <div class="track-url-item">
                  <span class="track-url-label">Preview:</span>
                  <span class="track-url-status">{track.previewUrl ? '‚úÖ' : '‚ùå'}</span>
                  <span class="track-url-value">{track.previewUrl || 'N/A'}</span>
                </div>
                <div class="track-url-item">
                  <span class="track-url-label">MP3:</span>
                  <span class="track-url-status">{track.mp3Url ? '‚úÖ' : '‚ùå'}</span>
                  <span class="track-url-value">{track.mp3Url || 'N/A'}</span>
                </div>
                <div class="track-url-item">
                  <span class="track-url-label">WAV:</span>
                  <span class="track-url-status">{track.wavUrl ? '‚úÖ' : '‚ùå'}</span>
                  <span class="track-url-value">{track.wavUrl || 'N/A'}</span>
                </div>
              </div>

              <input type="hidden" name={'track_' + index + '_trackNumber'} value={track.trackNumber ?? index} />
              <input type="hidden" name={'track_' + index + '_displayTrackNumber'} value={track.displayTrackNumber || index + 1} />
              <input type="hidden" name={'track_' + index + '_previewUrl'} value={track.previewUrl || ''} />
              <input type="hidden" name={'track_' + index + '_mp3Url'} value={track.mp3Url || ''} />
              <input type="hidden" name={'track_' + index + '_wavUrl'} value={track.wavUrl || ''} />
            </div>
          ))}
        </div>
      </div>

      <!-- RATINGS & STATS -->
      <div class="edit-section">
        <h2 class="section-title">üìä Ratings & Statistics (Read-Only)</h2>
        
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Avg Rating</div>
            <div class="stat-value">{(release.ratings?.average || 0).toFixed(1)} ‚≠ê</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Ratings</div>
            <div class="stat-value">{release.ratings?.count || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">5-Star</div>
            <div class="stat-value">{release.ratings?.fiveStarCount || release.fiveStarCount || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Comments</div>
            <div class="stat-value">{release.comments?.length || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Tracks</div>
            <div class="stat-value">{release.stats?.totalTracks || release.tracks?.length || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Previews</div>
            <div class="stat-value">{release.stats?.totalPreviews || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Plays</div>
            <div class="stat-value">{release.stats?.plays || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Downloads</div>
            <div class="stat-value">{release.stats?.downloads || 0}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Views</div>
            <div class="stat-value">{release.stats?.views || 0}</div>
          </div>
        </div>
      </div>

      <!-- TIMESTAMPS -->
      <div class="edit-section">
        <h2 class="section-title">üïê Timestamps (Read-Only)</h2>
        <div class="form-row-4">
          <div class="form-group">
            <label class="form-label">Uploaded At</label>
            <input type="text" class="form-input" id="uploadedAtDisplay" value="" readonly />
          </div>
          <div class="form-group">
            <label class="form-label">Created At</label>
            <input type="text" class="form-input" id="createdAtDisplay" value="" readonly />
          </div>
          <div class="form-group">
            <label class="form-label">Processed At</label>
            <input type="text" class="form-input" id="processedAtDisplay" value="" readonly />
          </div>
          <div class="form-group">
            <label class="form-label">Last Updated</label>
            <input type="text" class="form-input" id="updatedAtDisplay" value="" readonly />
          </div>
        </div>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="button-row">
        <button type="button" class="btn btn-secondary" onclick="window.history.back()">‚Üê Cancel</button>
        <button type="submit" class="btn btn-primary" id="saveBtn">‚úì Save All Changes</button>
      </div>
    </form>
  </div>

  <div class="success-message" id="successMessage">‚úÖ Release Updated Successfully!</div>

  <script define:vars={{ releaseId: release.id, existingSocialLinks: JSON.stringify(release.socialLinks || {}), trackCount: release.tracks?.length || 0, existingNotes: release.metadata?.notes || '', timestamps: JSON.stringify({ uploadedAt: release.uploadedAt || null, createdAt: release.createdAt || null, processedAt: release.processedAt || null, updatedAt: release.updatedAt || null }), adminKey }}>
    var currentIdToken = null;
    var ADMIN_KEY = adminKey;

    // Initialize Firebase for auth using dynamic import
    (async function() {
      try {
        var firebaseApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        var firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

        var firebaseConfig = {
          apiKey: "AIzaSyBiZGsWdvA9ESm3OsUpZ-VQpwqMjMpBY6g",
          authDomain: "freshwax-store.firebaseapp.com",
          projectId: "freshwax-store"
        };

        var app = firebaseApp.initializeApp(firebaseConfig);
        var auth = firebaseAuth.getAuth(app);

        firebaseAuth.onAuthStateChanged(auth, async function(user) {
          if (user) {
            currentIdToken = await user.getIdToken();
            console.log('[Admin] Auth ready');
          }
        });
      } catch (err) {
        console.error('[Admin] Firebase init error:', err);
      }
    })();

    var socialLinks = JSON.parse(existingSocialLinks);
    var timestampData = JSON.parse(timestamps);
    
    // Format timestamp to human readable
    function formatTimestamp(isoString) {
      if (!isoString) return 'Unknown';
      try {
        var date = new Date(isoString);
        if (isNaN(date.getTime())) return 'Invalid date';
        
        var day = date.getDate();
        var month = date.toLocaleString('en-GB', { month: 'short' });
        var year = date.getFullYear();
        var hours = date.getHours().toString().padStart(2, '0');
        var mins = date.getMinutes().toString().padStart(2, '0');
        
        return day + ' ' + month + ' ' + year + ' at ' + hours + ':' + mins;
      } catch (e) {
        return 'Unknown';
      }
    }
    
    // Initialize timestamp displays
    document.getElementById('uploadedAtDisplay').value = formatTimestamp(timestampData.uploadedAt);
    document.getElementById('createdAtDisplay').value = formatTimestamp(timestampData.createdAt);
    document.getElementById('processedAtDisplay').value = formatTimestamp(timestampData.processedAt);
    document.getElementById('updatedAtDisplay').value = formatTimestamp(timestampData.updatedAt);
    
    // Parse existing notes into social links and other notes
    function parseExistingNotes(notes) {
      if (!notes) return { socialLinks: '', otherNotes: '' };
      
      var lines = notes.split('\n');
      var socialLinks = [];
      var otherNotes = [];
      
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        
        // Check if line contains a URL (social link)
        if (line.indexOf('http://') !== -1 || line.indexOf('https://') !== -1) {
          // Extract just the URL if there's a label
          var urlMatch = line.match(/(https?:\/\/[^\s]+)/);
          if (urlMatch) {
            socialLinks.push(urlMatch[1]);
          }
        } else if (line.indexOf('SoundCloud:') !== -1 || line.indexOf('Facebook:') !== -1 || 
                   line.indexOf('Instagram:') !== -1 || line.indexOf('Twitter:') !== -1 ||
                   line.indexOf('Bandcamp:') !== -1 || line.indexOf('Spotify:') !== -1) {
          // Line has label but URL might be on same line or missing
          var parts = line.split(/:\s*/);
          if (parts.length > 1 && parts[1]) {
            socialLinks.push(parts[1]);
          }
        } else {
          otherNotes.push(line);
        }
      }
      
      return {
        socialLinks: socialLinks.join('\n'),
        otherNotes: otherNotes.join('\n')
      };
    }
    
    // Initialize notes fields
    var parsedNotes = parseExistingNotes(existingNotes);
    document.querySelector('textarea[name="artistSocialLinks"]').value = parsedNotes.socialLinks;
    document.querySelector('textarea[name="otherNotes"]').value = parsedNotes.otherNotes;
    
    // Copy Label Name to Copyright Holder
    document.getElementById('copyLabelBtn').addEventListener('click', function() {
      var labelName = document.getElementById('labelNameInput').value;
      if (labelName) {
        document.getElementById('copyrightHolderInput').value = labelName;
      }
    });
    
    // Copy Copyright Holder to Label Name
    document.getElementById('copyFromCopyrightBtn').addEventListener('click', function() {
      var copyrightHolder = document.getElementById('copyrightHolderInput').value;
      if (copyrightHolder) {
        document.getElementById('labelNameInput').value = copyrightHolder;
      }
    });
    
    // Quick action buttons for status
    document.getElementById('goLiveBtn').addEventListener('click', function() {
      document.getElementById('statusSelect').value = 'live';
    });
    
    document.getElementById('takeDownBtn').addEventListener('click', function() {
      document.getElementById('statusSelect').value = 'hidden';
    });
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
      if (!confirm('Reload from Firebase? Unsaved changes will be lost.')) return;
      var btn = this;
      btn.disabled = true;
      btn.textContent = 'üîÑ Refreshing...';
      
      fetch('/api/get-release?id=' + releaseId + '&admin=true')
        .then(function(response) { return response.json(); })
        .then(function(result) {
          if (result.success) {
            alert('‚úÖ Refreshed! Reloading...');
            window.location.reload();
          } else {
            alert('‚ùå Failed: ' + (result.error || 'Unknown'));
            btn.disabled = false;
            btn.textContent = 'üîÑ Refresh';
          }
        })
        .catch(function(error) {
          alert('‚ùå Error: ' + error.message);
          btn.disabled = false;
          btn.textContent = 'üîÑ Refresh';
        });
    });
    
    // Social links now handled via Artist Social Links textarea
    // The socialLinks object is kept for backward compatibility in form submission
    
    // Toggle sections
    var toggles = [
      { checkbox: 'vinylRelease', target: 'vinylOptions' },
      { checkbox: 'hasLimitedEdition', target: 'limitedEditionOptions' },
      { checkbox: 'hasPreOrder', target: 'preOrderOptions' },
      { checkbox: 'specialOffer', target: 'specialOfferPrice' },
      { checkbox: 'nyopEnabled', target: 'nyopOptions' }
    ];

    toggles.forEach(function(config) {
      var el = document.getElementById(config.checkbox);
      var targetEl = document.getElementById(config.target);
      if (el && targetEl) {
        el.addEventListener('change', function(e) {
          targetEl.style.display = e.target.checked ? '' : 'none';
        });
      }
    });

    // Free Download toggles price to 0
    var freeDownloadCheckbox = document.getElementById('freeDownload');
    var priceInput = document.getElementById('pricePerSale');
    if (freeDownloadCheckbox && priceInput) {
      freeDownloadCheckbox.addEventListener('change', function(e) {
        if (e.target.checked) {
          priceInput.value = '0.00';
          priceInput.disabled = true;
        } else {
          priceInput.disabled = false;
        }
      });
      // Initialize state
      if (freeDownloadCheckbox.checked) {
        priceInput.value = '0.00';
        priceInput.disabled = true;
      }
    }

    // Track drag and drop
    var draggedTrack = null;
    
    function initTrackDragDrop() {
      var items = document.querySelectorAll('.track-item');
      for (var i = 0; i < items.length; i++) {
        (function(item) {
          item.addEventListener('dragstart', function() {
            draggedTrack = item;
            item.style.opacity = '0.5';
          });
          
          item.addEventListener('dragend', function() {
            item.style.opacity = '1';
          });
          
          item.addEventListener('dragover', function(e) {
            e.preventDefault();
            var trackList = document.getElementById('trackList');
            var afterElement = getDragAfterElement(trackList, e.clientY);
            if (afterElement == null) {
              trackList.appendChild(draggedTrack);
            } else {
              trackList.insertBefore(draggedTrack, afterElement);
            }
          });
        })(items[i]);
      }
    }

    function getDragAfterElement(container, y) {
      var elements = container.querySelectorAll('.track-item:not(.dragging)');
      var closest = { offset: Number.NEGATIVE_INFINITY, element: null };
      
      for (var i = 0; i < elements.length; i++) {
        var child = elements[i];
        var box = child.getBoundingClientRect();
        var offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset: offset, element: child };
        }
      }
      
      return closest.element;
    }
    
    initTrackDragDrop();

    // Form submission
    var editForm = document.getElementById('editForm');
    var saveBtn = document.getElementById('saveBtn');
    var successMessage = document.getElementById('successMessage');

    editForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      var formData = new FormData(editForm);
      
      // Build tracks array
      var tracks = [];
      var trackItems = document.querySelectorAll('.track-item');
      
      for (var i = 0; i < trackItems.length; i++) {
        var item = trackItems[i];
        var oldIndex = parseInt(item.getAttribute('data-track-index'));
        
        var track = {
          trackNumber: i,
          displayTrackNumber: i + 1,
          trackName: formData.get('track_' + oldIndex + '_trackName') || '',
          bpm: parseInt(formData.get('track_' + oldIndex + '_bpm')) || 0,
          key: formData.get('track_' + oldIndex + '_key') || '',
          duration: formData.get('track_' + oldIndex + '_duration') || '',
          trackISRC: formData.get('track_' + oldIndex + '_trackISRC') || '',
          featured: formData.get('track_' + oldIndex + '_featured') || '',
          remixer: formData.get('track_' + oldIndex + '_remixer') || '',
          previewUrl: formData.get('track_' + oldIndex + '_previewUrl') || '',
          mp3Url: formData.get('track_' + oldIndex + '_mp3Url') || '',
          wavUrl: formData.get('track_' + oldIndex + '_wavUrl') || '',
          ratings: { average: 0, count: 0, total: 0 },
          comments: []
        };
        
        tracks.push(track);
      }
      
      // Build social links - preserve existing socialLinks object
      // Social links are now managed via metadata.notes (Artist Social Links field)
      var socialLinksData = socialLinks || {};
      
      // Build vinyl nested object
      var vinylEnabled = formData.get('vinylRelease') === 'on';
      var vinylObj = null;
      
      if (vinylEnabled) {
        var limitedEdObj = null;
        if (formData.get('hasLimitedEdition') === 'on') {
          limitedEdObj = {
            type: formData.get('limitedEditionType') || null,
            details: formData.get('limitedEditionDetails') || null
          };
        }
        
        vinylObj = {
          available: true,
          recordCount: parseInt(formData.get('vinylRecordCount')) || 1,
          price: parseFloat(formData.get('vinylPrice')) || 0,
          rpm: (formData.get('vinylRPM') || '').replace(' RPM', ''),
          size: formData.get('vinylSize') || null,
          weight: formData.get('vinylWeight') || null,
          pressingPlant: formData.get('pressingPlant') || null,
          expectedShippingDate: formData.get('expectedShippingDate') || null,
          limitedEdition: limitedEdObj
        };
      }
      
      // Complete update object matching exact Firebase structure
      var updates = {
        id: releaseId,
        
        // Basic info
        releaseName: formData.get('releaseName') || '',
        artistName: formData.get('artistName') || '',
        labelName: formData.get('labelName') || '',
        labelCode: formData.get('labelCode') || '',
        genre: formData.get('genre') || '',
        releaseType: formData.get('releaseType') || 'EP',
        releaseDate: formData.get('releaseDate') || '',
        originalReleaseDate: formData.get('originalReleaseDate') || '',
        officialReleaseDate: formData.get('originalReleaseDate') || null,
        masteredBy: formData.get('masteredBy') || '',
        primaryLanguage: formData.get('primaryLanguage') || 'English',
        hasExplicitContent: formData.get('hasExplicitContent') === 'on',
        releaseDescription: formData.get('releaseDescription') || '',
        trackListing: formData.get('trackListing') || '',
        
        // Pricing (both flat and nested)
        pricePerSale: parseFloat(formData.get('pricePerSale')) || 0,
        trackPrice: parseFloat(formData.get('trackPrice')) || 1.00,
        vinylPrice: parseFloat(formData.get('vinylPrice')) || 0,
        freeDownload: formData.get('freeDownload') === 'on',
        specialOffer: formData.get('specialOffer') === 'on',
        offerPrice: parseFloat(formData.get('offerPrice')) || 0,
        // Name Your Own Price (NYOP)
        nyopEnabled: formData.get('nyopEnabled') === 'on',
        nyopMinPrice: parseFloat(formData.get('nyopMinPrice')) || 0,
        nyopSuggestedPrice: formData.get('nyopSuggestedPrice') ? parseFloat(formData.get('nyopSuggestedPrice')) : null,
        pricing: {
          digital: parseFloat(formData.get('pricePerSale')) || 0,
          track: parseFloat(formData.get('trackPrice')) || 1.00,
          vinyl: parseFloat(formData.get('vinylPrice')) || null,
          freeDownload: formData.get('freeDownload') === 'on',
          specialOffer: formData.get('specialOffer') === 'on',
          offerPrice: parseFloat(formData.get('offerPrice')) || 0
        },
        
        // Vinyl (both flat and nested)
        vinylRelease: vinylEnabled,
        vinylRecordCount: formData.get('vinylRecordCount') || '',
        vinylRPM: formData.get('vinylRPM') || '',
        vinylSize: (formData.get('vinylSize') || '').replace('"', ''),
        vinylWeight: formData.get('vinylWeight') || '',
        pressingPlant: formData.get('pressingPlant') || '',
        expectedShippingDate: formData.get('expectedShippingDate') || '',
        // Per-release vinyl shipping (overrides artist defaults if set)
        vinylShippingUK: formData.get('vinylShippingUK') ? parseFloat(formData.get('vinylShippingUK')) : null,
        vinylShippingEU: formData.get('vinylShippingEU') ? parseFloat(formData.get('vinylShippingEU')) : null,
        vinylShippingIntl: formData.get('vinylShippingIntl') ? parseFloat(formData.get('vinylShippingIntl')) : null,
        hasLimitedEdition: formData.get('hasLimitedEdition') === 'on',
        limitedEditionType: formData.get('limitedEditionType') || '',
        limitedEditionDetails: formData.get('limitedEditionDetails') || '',
        vinyl: vinylObj,
        
        // Copyright
        copyrightYear: parseInt(formData.get('copyrightYear')) || new Date().getFullYear(),
        copyrightHolder: formData.get('copyrightHolder') || '',
        publishingRights: formData.get('publishingRights') || '',
        publishingCompany: formData.get('publishingCompany') || '',
        upcEanCode: formData.get('upcEanCode') || '',
        
        // Recording
        recordingLocation: formData.get('recordingLocation') || '',
        recordingYear: formData.get('recordingYear') || '',
        isPreviouslyReleased: formData.get('isPreviouslyReleased') === 'on',
        originalReleaseDate: formData.get('originalReleaseDate') || '',
        
        // Pre-order
        hasPreOrder: formData.get('hasPreOrder') === 'on',
        preOrderDate: formData.get('preOrderDate') || '',
        
        // Status
        // Status
        status: formData.get('status') || 'pending',
        approved: formData.get('status') === 'live',
        published: formData.get('status') === 'live',
        featured: false,
        
        // Contact
        submittedBy: formData.get('submittedBy') || '',
        email: formData.get('email') || '',
        
        // Social & tracks
        socialLinks: socialLinksData,
        tracks: tracks,
        
        // Timestamp
        updatedAt: new Date().toISOString()
      };
      
      // Combine artist social links and other notes back into metadata.notes
      var artistSocialLinks = formData.get('artistSocialLinks') || '';
      var otherNotes = formData.get('otherNotes') || '';
      var combinedNotes = '';
      
      if (artistSocialLinks.trim()) {
        combinedNotes += artistSocialLinks.trim();
      }
      if (otherNotes.trim()) {
        if (combinedNotes) combinedNotes += '\n\n';
        combinedNotes += otherNotes.trim();
      }
      
      // Add metadata object
      updates.metadata = {
        submittedBy: formData.get('submittedBy') || '',
        email: formData.get('email') || '',
        notes: combinedNotes,
        officialReleaseDate: formData.get('originalReleaseDate') || null
      };

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      // Add admin key for authentication
      updates.adminKey = ADMIN_KEY;

      // Add idToken for authenticated writes
      if (currentIdToken) {
        updates.idToken = currentIdToken;
      }

      fetch('/api/update-release', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
      })
      .then(function(response) { return response.json().then(function(data) { return { ok: response.ok, data: data }; }); })
      .then(function(result) {
        if (result.ok && result.data.success) {
          successMessage.classList.add('show');
          setTimeout(function() { successMessage.classList.remove('show'); }, 3000);
          saveBtn.textContent = '‚úì Save All Changes';
          saveBtn.disabled = false;
        } else {
          alert('‚ùå Failed: ' + (result.data.error || 'Unknown error'));
          saveBtn.textContent = '‚úì Save All Changes';
          saveBtn.disabled = false;
        }
      })
      .catch(function(error) {
        alert('‚ùå Error: ' + error.message);
        saveBtn.textContent = '‚úì Save All Changes';
        saveBtn.disabled = false;
      });
    });
  </script>
</body>
</html>