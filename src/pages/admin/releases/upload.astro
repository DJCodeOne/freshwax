---
import AdminLayout from "../../../layouts/AdminLayout.astro";
export const prerender = false;
---
<AdminLayout title="Upload Release" activeNav="releases">
<div class="card"><div class="card-body">
<h2>Direct R2 Upload</h2>
<p style="color:#666;margin-bottom:1rem">Upload cover art and audio tracks directly to storage.</p>

<div style="margin-bottom:1rem">
  <label style="display:block;margin-bottom:0.25rem;font-weight:500">Artist Name</label>
  <input id="artist" placeholder="Artist" class="input-field" style="width:100%">
</div>

<div style="margin-bottom:1rem">
  <label style="display:block;margin-bottom:0.25rem;font-weight:500">Release Name</label>
  <input id="release" placeholder="Release" class="input-field" style="width:100%">
</div>

<div style="margin-bottom:1rem">
  <label style="display:block;margin-bottom:0.25rem;font-weight:500">Cover Art</label>
  <input type="file" id="cover" accept="image/jpeg,image/png,image/webp" style="display:block">
</div>

<div style="margin-bottom:1rem">
  <label style="display:block;margin-bottom:0.25rem;font-weight:500">Audio Tracks</label>
  <input type="file" id="tracks" accept="audio/mpeg,audio/wav,audio/flac,audio/aiff,audio/mp4,.mp3,.wav,.flac,.aiff,.m4a" multiple style="display:block">
  <small style="color:#666">Select multiple audio files (MP3, WAV, FLAC, AIFF, M4A)</small>
</div>

<button id="btn" class="btn btn-primary" disabled>Upload Release</button>

<div id="progress" style="margin-top:1rem;display:none">
  <div style="background:#e0e0e0;border-radius:4px;overflow:hidden;height:20px">
    <div id="progressBar" style="background:#4CAF50;height:100%;width:0%;transition:width 0.3s"></div>
  </div>
  <div id="progressText" style="margin-top:0.5rem;font-size:0.9rem"></div>
</div>

<div id="status" style="margin-top:1rem"></div>
</div></div>

<script is:inline>
const btn = document.getElementById("btn");
const status = document.getElementById("status");
const progress = document.getElementById("progress");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const coverInput = document.getElementById("cover");
const tracksInput = document.getElementById("tracks");
const artistInput = document.getElementById("artist");
const releaseInput = document.getElementById("release");

function checkReady() {
  btn.disabled = !coverInput.files.length || !tracksInput.files.length ||
                 !artistInput.value.trim() || !releaseInput.value.trim();
}

artistInput.oninput = checkReady;
releaseInput.oninput = checkReady;
coverInput.onchange = checkReady;
tracksInput.onchange = checkReady;

function setProgress(percent, text) {
  progress.style.display = "block";
  progressBar.style.width = percent + "%";
  progressText.textContent = text;
}

function setStatus(msg, isError = false) {
  status.innerHTML = `<div style="padding:0.75rem;border-radius:4px;background:${isError ? '#ffebee' : '#e8f5e9'};color:${isError ? '#c62828' : '#2e7d32'}">${msg}</div>`;
}

async function uploadFileWithProgress(url, file, contentType) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        setProgress(percent, `Uploading ${file.name}: ${percent}%`);
      }
    };

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve();
      } else {
        reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}`));
      }
    };

    xhr.onerror = () => {
      reject(new Error(`Network error uploading ${file.name}. This may be a CORS issue - check R2 bucket CORS settings.`));
    };

    xhr.ontimeout = () => {
      reject(new Error(`Upload timed out for ${file.name}`));
    };

    xhr.open("PUT", url);
    xhr.setRequestHeader("Content-Type", contentType);
    xhr.timeout = 600000; // 10 minute timeout
    xhr.send(file);
  });
}

btn.onclick = async () => {
  const artistName = artistInput.value.trim();
  const releaseName = releaseInput.value.trim();

  btn.disabled = true;
  status.innerHTML = "";
  setProgress(0, "Preparing upload...");

  try {
    // Build file list
    const files = [
      { filename: coverInput.files[0].name, contentType: coverInput.files[0].type, size: coverInput.files[0].size },
      ...Array.from(tracksInput.files).map(f => ({ filename: f.name, contentType: f.type, size: f.size }))
    ];

    console.log("Requesting presigned URLs for files:", files);

    // Get presigned URLs
    setProgress(5, "Getting upload URLs...");
    const presignRes = await fetch("/api/releases/presigned-upload", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ artistName, releaseName, files })
    });

    const presignData = await presignRes.json();
    console.log("Presign response:", presignData);

    if (!presignData.success) {
      throw new Error(presignData.error || "Failed to get upload URLs");
    }

    // Upload files
    const allFiles = [coverInput.files[0], ...Array.from(tracksInput.files)];
    let coverArtUrl = "";
    const tracks = [];

    for (let i = 0; i < allFiles.length; i++) {
      const file = allFiles[i];
      const upload = presignData.uploads[i];

      console.log(`Uploading file ${i + 1}/${allFiles.length}: ${file.name} to ${upload.uploadUrl}`);
      setProgress(10 + (i / allFiles.length) * 80, `Uploading ${file.name}...`);

      try {
        await uploadFileWithProgress(upload.uploadUrl, file, upload.contentType);
      } catch (uploadErr) {
        console.error("Upload error:", uploadErr);
        throw uploadErr;
      }

      if (i === 0) {
        coverArtUrl = upload.publicUrl;
      } else {
        tracks.push({
          trackNumber: i,
          title: file.name.replace(/\.[^.]+$/, ""),
          url: upload.publicUrl
        });
      }
    }

    // Create release document
    setProgress(95, "Creating release record...");

    const completeRes = await fetch("/api/releases/complete-upload", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        releaseId: presignData.releaseId,
        artistName,
        releaseName,
        tracks,
        coverArtUrl
      })
    });

    const completeData = await completeRes.json();
    console.log("Complete response:", completeData);

    if (!completeData.success) {
      throw new Error(completeData.error || "Failed to create release");
    }

    setProgress(100, "Complete!");
    setStatus(`Release uploaded successfully! <a href="/admin/releases/manage">View Releases</a>`);

    // Reset form
    artistInput.value = "";
    releaseInput.value = "";
    coverInput.value = "";
    tracksInput.value = "";

  } catch (err) {
    console.error("Upload error:", err);
    setStatus(`Error: ${err.message}`, true);
    btn.disabled = false;
  }
};
</script>
</AdminLayout>
